{
  "version": 3,
  "sources": ["../src/shared/item.js", "../src/module.js", "../src/shared/libwrapper.js", "../src/shared/localize.js", "../src/shared/notification.js", "../src/shared/settings.js", "../src/features/arp.js", "../src/shared/hook.js", "../src/features/debug.js", "../src/features/effects.js", "../src/apps/giveth/popup.js", "../src/shared/misc.js", "../src/shared/path.js", "../src/shared/actor.js", "../src/shared/flags.js", "../src/shared/chat.js", "../src/shared/socket.js", "../src/shared/user.js", "../src/features/giveth.js", "../src/apps/hero/trade.js", "../src/features/hero.js", "../src/shared/draggable.js", "../src/features/inventory.js", "../src/apps/knowledges/lores.js", "../src/features/knowledges.js", "../src/apps/merge/multi.js", "../src/shared/pf2e/classes.js", "../src/features/merge.js", "../src/features/nobulk.js", "../src/features/share.js", "../src/features/stances.js", "../src/shared/pf2e/misc.js", "../src/features/summary.js", "../src/shared/dicesonice.js", "../src/shared/pf2e/actor.js", "../src/shared/pf2e/dom.js", "../src/shared/pf2e/rules.js", "../src/shared/pf2e/chat.js", "../src/shared/pf2e/success.js", "../src/shared/template.js", "../src/features/target.js", "../src/features/unided.js", "../src/features/untarget.js", "../src/macros/condition.js", "../src/main.js"],
  "sourcesContent": ["export const HANDWRAPS_SLUG = \"handwraps-of-mighty-blows\";\r\n\r\nfunction getSourceId(doc) {\r\n\treturn doc.getFlag(\"core\", \"sourceId\");\r\n}\r\n\r\nfunction includesSourceId(doc, list) {\r\n\tconst sourceId = getSourceId(doc);\r\n\treturn sourceId ? list.includes(sourceId) : false;\r\n}\r\n\r\nfunction getItemSourceIdCondition(sourceId) {\r\n\treturn Array.isArray(sourceId)\r\n\t\t? (item) => includesSourceId(item, sourceId)\r\n\t\t: (item) => getSourceId(item) === sourceId;\r\n}\r\n\r\nexport function getItems(actor, itemTypes = []) {\r\n\tconst types = typeof itemTypes === \"string\" ? [itemTypes] : itemTypes;\r\n\treturn types.length\r\n\t\t? types.flatMap((type) => actor.itemTypes[type])\r\n\t\t: actor.items;\r\n}\r\n\r\nexport function hasItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).some(getItemSourceIdCondition(sourceId));\r\n}\r\n\r\nexport function getItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).find(getItemSourceIdCondition(sourceId));\r\n}\r\n\r\nexport function canBeInvested(item) {\r\n\treturn item.traits.has(\"invested\");\r\n}\r\n\r\nexport function hasWornSlot(item) {\r\n\treturn item.system.equipped.inSlot != null;\r\n}\r\n\r\nfunction isWornAs(item) {\r\n\treturn item.system.usage.type === \"worn\" && item.system.equipped.inSlot;\r\n}\r\n\r\nexport function isInvestedOrWornAs(item) {\r\n\treturn item.isInvested || isWornAs(item);\r\n}\r\n\r\nexport function isHandwrapsOfMightyBlows(item) {\r\n\treturn (\r\n\t\titem.isOfType(\"weapon\") &&\r\n\t\titem.slug === HANDWRAPS_SLUG &&\r\n\t\titem.category === \"unarmed\"\r\n\t);\r\n}\r\n\r\nexport function isHeld(item) {\r\n\treturn item.system.usage.type === \"held\";\r\n}\r\n\r\nexport function isTwoHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-two-hands\";\r\n}\r\n\r\nexport function isOneHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-one-hand\";\r\n}\r\n\r\nfunction inSlotValue(item, value) {\r\n\tconst usage = item.system.usage;\r\n\treturn usage.type === \"worn\" && usage.where ? value : undefined;\r\n}\r\n\r\nfunction toggleInvestedValue(item, invest) {\r\n\tconst value = invest ?? !item.system.equipped.invested;\r\n\treturn item.traits.has(\"invested\") ? value : undefined;\r\n}\r\n\r\nexport function itemCarryUpdate(\r\n\titem,\r\n\t{ carryType = \"worn\", handsHeld = 0, inSlot, invested, containerId },\r\n) {\r\n\tconst update = {\r\n\t\t_id: item.id,\r\n\t\tsystem: {\r\n\t\t\tequipped: {\r\n\t\t\t\tcarryType: carryType,\r\n\t\t\t\thandsHeld: handsHeld,\r\n\t\t\t\tinSlot: inSlotValue(item, inSlot),\r\n\t\t\t\tinvested: toggleInvestedValue(item, invested),\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\r\n\tif (containerId !== undefined) {\r\n\t\tupdate.system.containerId = containerId;\r\n\t}\r\n\r\n\treturn update;\r\n}\r\n", "export const MODULE_ID = \"pf2e-toolbelt\";\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function registerWrapper(path, callback, type = \"WRAPPER\") {\r\n\treturn libWrapper.register(MODULE_ID, path, callback, type);\r\n}\r\n\r\nexport function unregisterWrapper(id) {\r\n\tlibWrapper.unregister(MODULE_ID, id);\r\n}\r\n\r\nexport function wrapperError(feature, path) {\r\n\tconsole.error(\r\n\t\t`an error occured in the feature '${feature}' of the module '${MODULE_ID}' with the wrapper: '${path}'`,\r\n\t);\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\nimport { error, info, warn } from \"./notification\";\r\n\r\nexport function localize(...args) {\r\n\tlet [key, data] = args;\r\n\tkey = `${MODULE_ID}.${key}`;\r\n\tif (data) return game.i18n.format(key, data);\r\n\treturn game.i18n.localize(key);\r\n}\r\n\r\nexport function hasLocalization(key) {\r\n\treturn game.i18n.has(`${MODULE_ID}.${key}`, false);\r\n}\r\n\r\nexport function localizePath(key) {\r\n\treturn `${MODULE_ID}.${key}`;\r\n}\r\n\r\nexport function subLocalize(subKey) {\r\n\tconst fn = (...args) => localize(`${subKey}.${args[0]}`, args[1]);\r\n\r\n\tObject.defineProperties(fn, {\r\n\t\twarn: {\r\n\t\t\tvalue: (...args) => warn(`${subKey}.${args[0]}`, args[1], args[2]),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tinfo: {\r\n\t\t\tvalue: (...args) => info(`${subKey}.${args[0]}`, args[1], args[2]),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\terror: {\r\n\t\t\tvalue: (...args) => error(`${subKey}.${args[0]}`, args[1], args[2]),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\thas: {\r\n\t\t\tvalue: (key) => hasLocalization(`${subKey}.${key}`),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tpath: {\r\n\t\t\tvalue: (key) => localizePath(`${subKey}.${key}`),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ttemplate: {\r\n\t\t\tvalue: (key, { hash }) => fn(key, hash),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t});\r\n\r\n\treturn fn;\r\n}\r\n", "import { localize } from \"./localize\";\r\n\r\nfunction notify(str, arg1, arg2, arg3) {\r\n\tconst type = typeof arg1 === \"string\" ? arg1 : \"info\";\r\n\tconst data =\r\n\t\ttypeof arg1 === \"object\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"object\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : undefined;\r\n\tconst permanent =\r\n\t\ttypeof arg1 === \"boolean\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"boolean\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : arg3 ?? false;\r\n\r\n\tui.notifications.notify(localize(str, data), type, { permanent });\r\n}\r\n\r\nexport function warn(...args) {\r\n\tconst [str, arg1, arg2] = args;\r\n\tnotify(str, \"warning\", arg1, arg2);\r\n}\r\n\r\nexport function info(...args) {\r\n\tconst [str, arg1, arg2] = args;\r\n\tnotify(str, \"info\", arg1, arg2);\r\n}\r\n\r\nexport function error(...args) {\r\n\tconst [str, arg1, arg2] = args;\r\n\tnotify(str, \"error\", arg1, arg2);\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function getSetting(setting) {\r\n\treturn game.settings.get(MODULE_ID, setting);\r\n}\r\n\r\nexport function setSetting(key, value) {\r\n\treturn game.settings.set(MODULE_ID, key, value);\r\n}\r\n\r\nexport function choiceSettingIsEnabled(setting) {\r\n\treturn getSetting(setting) !== \"disabled\";\r\n}\r\n", "import { HANDWRAPS_SLUG } from \"../shared/item\";\r\nimport { registerWrapper, wrapperError } from \"../shared/libwrapper\";\r\nimport { info } from \"../shared/notification\";\r\nimport { choiceSettingIsEnabled, getSetting } from \"../shared/settings\";\r\n\r\nconst PREPARE_WEAPON_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData\";\r\nconst PREPARE_WEAPON_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData\";\r\n\r\nconst PREPARE_ARMOR_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData\";\r\nconst PREPARE_ARMOR_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData\";\r\n\r\nexport function registerArp() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"auto-runes\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"force\", \"lower\"],\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-arp\"],\r\n\t\tinit: () => {\r\n\t\t\tconst setting = getSetting(\"auto-runes\");\r\n\t\t\tif (setting === \"disabled\") return;\r\n\r\n\t\t\tregisterWrapper(PREPARE_WEAPON_DATA, onPrepareWeaponData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tPREPARE_WEAPON_DERIVED_DATA,\r\n\t\t\t\tonPrepareWeaponDerivedData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tregisterWrapper(PREPARE_ARMOR_DATA, onPrepareArmorData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tPREPARE_ARMOR_DERIVED_DATA,\r\n\t\t\t\tonPrepareArmorDerivedData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tif (setting === \"force\") {\r\n\t\t\t\tHooks.on(\"renderPhysicalItemSheetPF2e\", renderPhysicalItemSheetPF2e);\r\n\t\t\t}\r\n\t\t},\r\n\t\tready: (isGM) => {\r\n\t\t\tif (\r\n\t\t\t\tisGM &&\r\n\t\t\t\tchoiceSettingIsEnabled(\"auto-runes\") &&\r\n\t\t\t\tgame.settings.get(\"pf2e\", \"automaticBonusVariant\") !== \"noABP\"\r\n\t\t\t) {\r\n\t\t\t\tgame.settings.set(\"pf2e\", \"automaticBonusVariant\", \"noABP\");\r\n\t\t\t\tinfo(\"arp.forceVariant\");\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction isValidActor(actor, isCharacter = false) {\r\n\treturn (\r\n\t\tactor &&\r\n\t\t!actor.getFlag(\"pf2e\", \"disableABP\") &&\r\n\t\t(!isCharacter || actor.isOfType(\"character\"))\r\n\t);\r\n}\r\n\r\n/**\r\n * weapon\r\n */\r\n\r\nconst WEAPON_POTENCY_PRICE = {\r\n\t1: 35,\r\n\t2: 935,\r\n\t3: 8935,\r\n\t4: 8935,\r\n};\r\n\r\nconst WEAPON_STRIKING_PRICE = {\r\n\t1: 65,\r\n\t2: 1065,\r\n\t3: 31065,\r\n};\r\n\r\nfunction isShieldWeapon(weapon) {\r\n\treturn [\"shield-boss\", \"shield-spikes\"].includes(\r\n\t\tweapon._source.system.baseItem,\r\n\t);\r\n}\r\n\r\nfunction isValidWeapon(weapon) {\r\n\tconst traits = weapon._source.system.traits.value;\r\n\tconst { group, category, slug } = weapon._source.system;\r\n\r\n\tif (category === \"unarmed\" && slug !== HANDWRAPS_SLUG) {\r\n\t\treturn !!weapon.actor.itemTypes.weapon.find(\r\n\t\t\t(weapon) =>\r\n\t\t\t\tweapon.slug === HANDWRAPS_SLUG &&\r\n\t\t\t\tweapon.category === \"unarmed\" &&\r\n\t\t\t\tweapon.isEquipped &&\r\n\t\t\t\tweapon.isInvested,\r\n\t\t);\r\n\t}\r\n\r\n\treturn (\r\n\t\t(group !== \"shield\" || isShieldWeapon(weapon)) &&\r\n\t\t!traits.includes(\"alchemical\") &&\r\n\t\t!traits.includes(\"bomb\")\r\n\t);\r\n}\r\n\r\nfunction onPrepareWeaponData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidWeapon(this)) return wrapped();\r\n\r\n\t\tconst traits = this._source.system.traits.value;\r\n\t\tif (traits.includes(\"alchemical\") && traits.includes(\"bomb\"))\r\n\t\t\treturn wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 2 ? null : level < 10 ? 1 : level < 16 ? 2 : 3;\r\n\t\tconst expectedStriking =\r\n\t\t\tlevel < 4 ? null : level < 12 ? 1 : level < 19 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.striking <= expectedStriking || forceUpdate) {\r\n\t\t\tthis.system.runes.striking = expectedStriking;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareWeaponDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidWeapon(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= WEAPON_POTENCY_PRICE[potency];\r\n\r\n\t\tconst striking = this.system.runes.striking;\r\n\t\tif (striking) coins.gp -= WEAPON_STRIKING_PRICE[striking];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || striking) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * amor\r\n */\r\n\r\nconst ARMOR_POTENCY_PRICE = {\r\n\t1: 160,\r\n\t2: 1060,\r\n\t3: 20560,\r\n\t4: 20560,\r\n};\r\n\r\nconst ARMOR_RESILIENCY_PRICE = {\r\n\t1: 340,\r\n\t2: 3440,\r\n\t3: 49440,\r\n};\r\n\r\nfunction isValidArmor(armor) {\r\n\treturn true;\r\n}\r\n\r\nfunction onPrepareArmorData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidArmor(this)) return wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 5 ? null : level < 11 ? 1 : level < 18 ? 2 : 3;\r\n\t\tconst expectedResilient =\r\n\t\t\tlevel < 8 ? null : level < 14 ? 1 : level < 20 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.resilient <= expectedResilient || forceUpdate) {\r\n\t\t\tthis.system.runes.resilient = expectedResilient;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareArmorDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidArmor(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= ARMOR_POTENCY_PRICE[potency];\r\n\r\n\t\tconst resiliency = this.system.runes.resilient;\r\n\t\tif (resiliency) coins.gp -= ARMOR_RESILIENCY_PRICE[resiliency];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || resiliency) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * item sheet\r\n */\r\n\r\nfunction renderPhysicalItemSheetPF2e(sheet, html) {\r\n\tconst item = sheet.item;\r\n\tif (\r\n\t\t!item ||\r\n\t\t!item.isOfType(\"weapon\", \"armor\") ||\r\n\t\t!isValidActor(item.actor, true)\r\n\t)\r\n\t\treturn;\r\n\r\n\tconst lookups = [\"potency\", \"striking\", \"resilient\"]\r\n\t\t.map((x) => `[name=\"system.runes.${x}\"]`)\r\n\t\t.join(\", \");\r\n\thtml.find(`[data-tab=details] fieldset .form-group:has(${lookups})`).hide();\r\n}\r\n", "import { getSetting } from \"./settings\";\r\n\r\nexport function createHook(event, listener, callback = () => {}) {\r\n\tlet HOOK = null;\r\n\r\n\treturn (value, otherSettings = [], skipCallback = false) => {\r\n\t\tconst others =\r\n\t\t\ttypeof otherSettings === \"string\" ? [otherSettings] : otherSettings;\r\n\t\tconst settingValue = value || others.some((s) => getSetting(s));\r\n\r\n\t\tif (settingValue && !HOOK) {\r\n\t\t\tHOOK = Hooks.on(event, listener);\r\n\t\t} else if (!settingValue && HOOK) {\r\n\t\t\tHooks.off(event, HOOK);\r\n\t\t\tHOOK = null;\r\n\t\t}\r\n\r\n\t\tif (!skipCallback) callback(settingValue);\r\n\t};\r\n}\r\n\r\nexport function createChoicesHook(event, listener, callback = () => {}) {\r\n\tlet HOOK = null;\r\n\r\n\treturn (value, skipCallback = false) => {\r\n\t\tif (value === \"disabled\" && HOOK) {\r\n\t\t\tHooks.off(event, HOOK);\r\n\t\t\tHOOK = null;\r\n\t\t} else if (value !== \"disabled\" && !HOOK) {\r\n\t\t\tHOOK = Hooks.on(event, listener);\r\n\t\t}\r\n\r\n\t\tif (!skipCallback) callback(value);\r\n\t};\r\n}\r\n\r\nexport function registerUpstreamHook(hook, fn) {\r\n\tconst id = Hooks.on(hook, fn);\r\n\tconst index = Hooks.events[hook].findIndex((x) => x.id === id);\r\n\r\n\tif (index !== 0) {\r\n\t\tconst [hooked] = Hooks.events[hook].splice(index, 1);\r\n\t\tHooks.events[hook].unshift(hooked);\r\n\t}\r\n\r\n\treturn id;\r\n}\r\n", "import { createHook } from \"../shared/hook\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst appHook = createHook(\"renderApplication\", onRender);\r\nconst actorHook = createHook(\"renderActorSheet\", onRender);\r\nconst itemHook = createHook(\"renderItemSheet\", onRender);\r\n\r\nexport function registerDebug() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"debug\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tconfig: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst enabled = value ?? getSetting(\"debug\");\r\n\tappHook(enabled);\r\n\tactorHook(enabled);\r\n\titemHook(enabled);\r\n}\r\n\r\nfunction onRender(app, html) {\r\n\tconst link = html.find(\".document-id-link\")[0];\r\n\tif (!link) return;\r\n\r\n\tlink.addEventListener(\r\n\t\t\"click\",\r\n\t\t(event) => {\r\n\t\t\tif (!event.shiftKey) return;\r\n\r\n\t\t\tconst obj = app.object;\r\n\t\t\tif (!obj) return;\r\n\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tconst type = obj.type;\r\n\r\n\t\t\tlet i = 2;\r\n\t\t\tlet variable = type;\r\n\t\t\twhile (window[variable]) {\r\n\t\t\t\tvariable = `${type}${i++}`;\r\n\t\t\t}\r\n\r\n\t\t\twindow[variable] = obj;\r\n\t\t\tconsole.log(variable, obj);\r\n\t\t},\r\n\t\ttrue,\r\n\t);\r\n}\r\n", "import { createHook } from \"../shared/hook\";\r\nimport { localize } from \"../shared/localize\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderEffectsPanel\",\r\n\trenderEffectsPanel,\r\n\trefreshEffectsPanel,\r\n);\r\n\r\nexport function registerEffectsPanelHelper() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"effect-remove\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"condition-sheet\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"condition-sheet\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"effect-remove\"),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-effect-description\"],\r\n\t\tinit: () => {\r\n\t\t\tsetHook(false, [\"effect-remove\", \"condition-sheet\"]);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction refreshEffectsPanel() {\r\n\tgame.pf2e.effectPanel?.render();\r\n}\r\n\r\nfunction renderEffectsPanel(panel, html) {\r\n\tconst removeRow = `<div>${localize(\"effects.remove\")}</div>`;\r\n\tconst editIcon = `<a data-action=\"edit\" data-tooltip=\"Edit Item\"><i class=\"fa-solid fa-fw fa-pencil\"></i></a>`;\r\n\r\n\tconst effectPanels = html.find(\".effect-item[data-item-id]\").toArray();\r\n\tfor (const effectPanel of effectPanels) {\r\n\t\tconst id = effectPanel.dataset.itemId;\r\n\t\tconst effect = panel.actor?.items.get(id);\r\n\t\tif (!effect) continue;\r\n\r\n\t\tif (\r\n\t\t\tgetSetting(\"effect-remove\") &&\r\n\t\t\t!effect.isLocked &&\r\n\t\t\teffect.badge &&\r\n\t\t\teffect.badge.type === \"counter\"\r\n\t\t) {\r\n\t\t\teffectPanel\r\n\t\t\t\t.querySelector(\".effect-info .instructions\")\r\n\t\t\t\t.insertAdjacentHTML(\"beforeend\", removeRow);\r\n\t\t\teffectPanel\r\n\t\t\t\t.querySelector(\".icon\")\r\n\t\t\t\t.addEventListener(\r\n\t\t\t\t\t\"contextmenu\",\r\n\t\t\t\t\t(event) => onRemoveEffect(event, panel),\r\n\t\t\t\t\ttrue,\r\n\t\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (getSetting(\"condition-sheet\") && effect.isOfType(\"condition\")) {\r\n\t\t\tconst h1 = effectPanel.querySelector(\".effect-info > h1\");\r\n\t\t\th1.insertAdjacentHTML(\"beforeend\", editIcon);\r\n\t\t\th1.querySelector('[data-action=\"edit\"]').addEventListener(\r\n\t\t\t\t\"click\",\r\n\t\t\t\t(event) => onConditionSheet(event, panel),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onConditionSheet(event, panel) {\r\n\tconst effect = getEffect(event, panel);\r\n\tif (!effect?.isOfType(\"condition\")) return;\r\n\tevent.preventDefault();\r\n\teffect.sheet.render(true);\r\n}\r\n\r\nfunction onRemoveEffect(event, panel) {\r\n\tif (!event.shiftKey) return;\r\n\r\n\tconst effect = getEffect(event, panel);\r\n\tif (\r\n\t\t!effect ||\r\n\t\teffect.isLocked ||\r\n\t\t!effect.badge ||\r\n\t\teffect.badge.type !== \"counter\"\r\n\t)\r\n\t\treturn;\r\n\r\n\tevent.preventDefault();\r\n\tevent.stopPropagation();\r\n\tevent.stopImmediatePropagation();\r\n\r\n\teffect.delete();\r\n}\r\n\r\nfunction getEffect(event, panel) {\r\n\tconst target = event.currentTarget;\r\n\tconst effect = target.closest(\".effect-item[data-item-id]\");\r\n\tconst id = effect.dataset.itemId;\r\n\treturn panel.actor?.items.get(id);\r\n}\r\n", "export class MoveLootPopup extends FormApplication {\r\n\tconstructor(object, options, callback) {\r\n\t\tsuper(object, options);\r\n\t\tthis.onSubmitCallback = callback;\r\n\t}\r\n\r\n\tasync getData() {\r\n\t\tconst [prompt, buttonLabel] = this.options.isPurchase\r\n\t\t\t? [\"PF2E.loot.PurchaseLootMessage\", \"PF2E.loot.PurchaseLoot\"]\r\n\t\t\t: [\"PF2E.loot.MoveLootMessage\", \"PF2E.loot.MoveLoot\"];\r\n\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tmaxQuantity: this.options.maxQuantity,\r\n\t\t\tnewStack: this.options.newStack,\r\n\t\t\tlockStack: this.options.lockStack,\r\n\t\t\tprompt,\r\n\t\t\tbuttonLabel,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"MoveLootPopup\",\r\n\t\t\tclasses: [],\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.loot.MoveLootPopupTitle\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/popups/loot/move-loot-popup.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tmaxQuantity: 1,\r\n\t\t\tnewStack: false,\r\n\t\t\tlockStack: false,\r\n\t\t\tisPurchase: false,\r\n\t\t};\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tthis.onSubmitCallback(formData.quantity, formData.newStack);\r\n\t}\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function localeCompare(a, b) {\r\n\treturn a.localeCompare(b, game.i18n.lang);\r\n}\r\n\r\nexport function refreshCharacterSheets(actor) {\r\n\tfor (const win of Object.values(ui.windows)) {\r\n\t\tconst winActor = win.actor;\r\n\t\tif (!(win instanceof ActorSheet) || !winActor.isOfType(\"character\"))\r\n\t\t\tcontinue;\r\n\t\tif (!actor || actor === winActor) win.render();\r\n\t}\r\n}\r\n\r\nexport function compareArrays(arr1, arr2) {\r\n\tif (arr1.length !== arr2.length) return false;\r\n\r\n\tconst clonedArr2 = arr2.slice();\r\n\r\n\tfor (const arr1Value of arr1) {\r\n\t\tconst index = clonedArr2.findIndex((arr2Value) => arr1Value === arr2Value);\r\n\t\tif (index === -1) return false;\r\n\t\tclonedArr2.splice(index, 1);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nexport function ordinalString(value) {\r\n\tconst pluralRules = new Intl.PluralRules(game.i18n.lang, { type: \"ordinal\" });\r\n\tconst suffix = game.i18n.localize(\r\n\t\t`PF2E.OrdinalSuffixes.${pluralRules.select(value)}`,\r\n\t);\r\n\treturn game.i18n.format(\"PF2E.OrdinalNumber\", { value, suffix });\r\n}\r\n\r\nexport function isInstanceOf(obj, name) {\r\n\tif (typeof obj !== \"object\") return false;\r\n\r\n\tlet cursor = Reflect.getPrototypeOf(obj);\r\n\twhile (cursor) {\r\n\t\tif (cursor.constructor.name === name) return true;\r\n\t\tcursor = Reflect.getPrototypeOf(cursor);\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n\r\nexport function setInMemory(doc, key, value) {\r\n\treturn setProperty(doc, `modules.${MODULE_ID}.${key}`, value);\r\n}\r\n\r\nexport function getInMemory(doc, key) {\r\n\treturn getProperty(doc, `modules.${MODULE_ID}.${key}`);\r\n}\r\n\r\nexport function deleteInMemory(doc, key) {\r\n\tconst split = `modules.${MODULE_ID}.${key}`.split(\".\");\r\n\tconst last = split.pop();\r\n\tlet cursor = doc;\r\n\tfor (const key of split) {\r\n\t\tcursor = cursor[key];\r\n\t\tif (!cursor) return true;\r\n\t}\r\n\treturn delete cursor[last];\r\n}\r\n\r\nexport function calculateDistanceBetweenPoints(x1, y1, x2, y2) {\r\n\tconst x = x2 - x1;\r\n\tconst y = y2 - y1;\r\n\treturn Math.sqrt(x * x + y * y);\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} el\r\n * @returns {number | undefined}\r\n */\r\nexport function getElementIndex(el) {\r\n\treturn Array.from(el.parentElement.children).indexOf(el);\r\n}\r\n\r\nexport function indexIsValid(index) {\r\n\treturn index !== undefined && index !== -1;\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function templatePath(...path) {\r\n\tconst pathStr = path.filter((x) => typeof x === \"string\").join(\"/\");\r\n\treturn `modules/${MODULE_ID}/templates/${pathStr}.hbs`;\r\n}\r\n", "import { registerWrapper, unregisterWrapper } from \"./libwrapper\";\r\nimport { getInMemory, setInMemory } from \"./misc\";\r\nimport { templatePath } from \"./path\";\r\n\r\nconst registered = {\r\n\twrapperIds: [],\r\n\ttabs: new Collection(),\r\n};\r\n\r\nconst CHARACTER_SHEET_INNER_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner\";\r\nconst CHARACTER_SHEET_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render\";\r\nconst CHARACTER_SHEET_ACTIVE_LISTENERS =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners\";\r\n\r\nexport function isPlayedActor(actor) {\r\n\treturn actor && !actor.pack && actor.id && game.actors.has(actor.id);\r\n}\r\n\r\nexport function registerCharacterSheetExtraTab(options) {\r\n\tif (!registered.wrapperIds.length) {\r\n\t\tregistered.wrapperIds = [\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_RENDER, characterSheetRender),\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_INNER_RENDER, characterSheetInnerRender),\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tCHARACTER_SHEET_ACTIVE_LISTENERS,\r\n\t\t\t\tcharacterSheetActiveListeners,\r\n\t\t\t),\r\n\t\t];\r\n\t}\r\n\tregistered.tabs.set(options.tabName, options);\r\n}\r\n\r\nexport function unregisterCharacterSheetExtraTab(tabName) {\r\n\tregistered.tabs.delete(tabName);\r\n\tif (registered.wrapperIds.length && !registered.tabs.size) {\r\n\t\tfor (const wrapperId of registered.wrapperIds) {\r\n\t\t\tunregisterWrapper(wrapperId);\r\n\t\t}\r\n\t\tregistered.wrapperIds = [];\r\n\t}\r\n}\r\n\r\nasync function characterSheetRender(wrapped, ...args) {\r\n\tconst positions = {};\r\n\r\n\tfor (const { tabName } of registered.tabs) {\r\n\t\tconst existingTab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst existingAlternate = existingTab.find(\".alternate\")[0];\r\n\t\tif (!existingAlternate) continue;\r\n\t\tpositions[tabName] = existingAlternate.scrollTop;\r\n\t}\r\n\r\n\tawait wrapped(...args);\r\n\r\n\tfor (const { tabName } of registered.tabs) {\r\n\t\tconst oldPosition = positions[tabName];\r\n\t\tif (!oldPosition) continue;\r\n\r\n\t\tconst tab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst alternate = tab.find(\".alternate\")[0];\r\n\t\talternate.scrollTop = positions[tabName];\r\n\t}\r\n}\r\n\r\nasync function characterSheetInnerRender(wrapped, data) {\r\n\tconst inner = await wrapped(data);\r\n\tconst actor = this.actor;\r\n\r\n\tif (!registered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn inner;\r\n\t}\r\n\r\n\tconst element = this.element;\r\n\r\n\tfor (const {\r\n\t\ttabName,\r\n\t\tgetData,\r\n\t\ttemplateFolder,\r\n\t\tonRender,\r\n\t} of registered.tabs) {\r\n\t\tconst innerTab = getCharacterSheetTab(inner, tabName);\r\n\r\n\t\tconst tabData = await getData(\r\n\t\t\tactor,\r\n\t\t\tthis,\r\n\t\t\tgetCharacterSheetTab(element, tabName),\r\n\t\t);\r\n\r\n\t\tconst template = await renderTemplate(\r\n\t\t\ttemplatePath(templateFolder),\r\n\t\t\ttabData,\r\n\t\t);\r\n\r\n\t\tif (onRender) {\r\n\t\t\tawait onRender(actor, this, inner);\r\n\t\t}\r\n\r\n\t\tif (getInMemory(this, `${tabName}.toggled`)) {\r\n\t\t\tinnerTab.addClass(\"toggled\");\r\n\t\t}\r\n\r\n\t\tinnerTab.children(\":last\").before(template);\r\n\t}\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction characterSheetActiveListeners(wrapped, inner) {\r\n\twrapped(inner);\r\n\r\n\tconst actor = this.actor;\r\n\r\n\tif (!registered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const { tabName, addEvents } of registered.tabs) {\r\n\t\tinner\r\n\t\t\t.find(`nav.sheet-navigation .item[data-tab=${tabName}]`)\r\n\t\t\t.on(\"click\", (event) =>\r\n\t\t\t\tonCharacterSheetTabBtnToggle(event, inner, this, tabName),\r\n\t\t\t);\r\n\r\n\t\tconst tab = getCharacterSheetTab(inner, tabName);\r\n\t\taddEvents(tab.find(\"> .alternate\"), this, actor, inner);\r\n\t}\r\n}\r\n\r\nexport function getCharacterSheetTab(html, tabName) {\r\n\treturn html.find(\r\n\t\t`section.sheet-body .sheet-content > .tab[data-tab=${tabName}]`,\r\n\t);\r\n}\r\n\r\nfunction onCharacterSheetTabBtnToggle(event, html, sheet, tabName) {\r\n\tevent.preventDefault();\r\n\r\n\tconst tab = getCharacterSheetTab(html, tabName);\r\n\r\n\tif (tab.hasClass(\"active\")) {\r\n\t\ttab.toggleClass(\"toggled\");\r\n\t\ttab.scrollTop(0);\r\n\t\tsetInMemory(sheet, `${tabName}.toggled`, tab.hasClass(\"toggled\"));\r\n\t}\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function getFlag(doc, key, fallback) {\r\n\treturn doc.getFlag(MODULE_ID, key) ?? fallback;\r\n}\r\n\r\nexport function setFlag(doc, key, value) {\r\n\treturn doc.setFlag(MODULE_ID, key, value);\r\n}\r\n\r\nexport function unsetFlag(doc, key) {\r\n\treturn doc.unsetFlag(MODULE_ID, key);\r\n}\r\n\r\nexport function containsFlag(doc, key) {\r\n\treturn getProperty(doc, `flags.${MODULE_ID}.${key}`) !== undefined;\r\n}\r\n\r\nexport function updateSourceFlag(doc, key, value) {\r\n\treturn doc.updateSource({\r\n\t\t[`flags.${MODULE_ID}.${key}`]: value,\r\n\t});\r\n}\r\n\r\nexport function moduleFlagUpdate(update, key, value) {\r\n\tupdate[`flags.${MODULE_ID}.${key}`] = value;\r\n}\r\n", "import { getFlag, updateSourceFlag } from \"./flags\";\r\n\r\nexport function getChatMessageClass() {\r\n\treturn CONFIG.ChatMessage.documentClass;\r\n}\r\n\r\nexport function* latestChatMessages(nb, fromMessage) {\r\n\tconst chat = ui.chat?.element;\r\n\tif (!chat) return;\r\n\r\n\tconst messages = game.messages.contents;\r\n\tconst start =\r\n\t\t(fromMessage\r\n\t\t\t? messages.findLastIndex((m) => m === fromMessage)\r\n\t\t\t: messages.length) - 1;\r\n\r\n\tfor (let i = start; i >= start - nb; i--) {\r\n\t\tconst message = messages[i];\r\n\t\tif (!message) return;\r\n\r\n\t\tconst html = chat.find(`[data-message-id=${message.id}]`);\r\n\t\tif (!html.length) continue;\r\n\r\n\t\tyield { message, html };\r\n\t}\r\n}\r\n\r\nexport function chatUUID(uuid, label, fake = false) {\r\n\tif (fake) {\r\n\t\treturn `<span style=\"background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);\r\nborder-radius: 2px; white-space: nowrap; word-break: break-all;\">${label}</span>`;\r\n\t}\r\n\r\n\tif (label) return `@UUID[${uuid}]{${label}}`;\r\n\r\n\treturn `@UUID[${uuid}]`;\r\n}\r\n\r\nexport function bindOnPreCreateSpellDamageChatMessage(originalMessage) {\r\n\tconst messageId = originalMessage.id;\r\n\tconst save = getFlag(originalMessage, \"target.save\");\r\n\tif (!save) return;\r\n\r\n\tHooks.once(\"preCreateChatMessage\", (message) => {\r\n\t\tupdateSourceFlag(message, \"target.messageId\", messageId);\r\n\t\tupdateSourceFlag(message, \"target.save\", save);\r\n\t});\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function socketOn(callback) {\r\n\tgame.socket.on(`module.${MODULE_ID}`, callback);\r\n}\r\n\r\nexport function socketOff(callback) {\r\n\tgame.socket.off(`module.${MODULE_ID}`, callback);\r\n}\r\n\r\nexport function socketEmit(packet) {\r\n\tgame.socket.emit(`module.${MODULE_ID}`, packet);\r\n}\r\n", "export function isActiveGM() {\r\n\treturn game.user === game.users.activeGM;\r\n}\r\n\r\nexport function isUserGM() {\r\n\tconst user = game.data.users.find((x) => x._id === game.data.userId);\r\n\treturn user && user.role >= CONST.USER_ROLES.GAMEMASTER;\r\n}\r\n\r\nexport function isGMOnline() {\r\n\treturn game.users.some((user) => user.active && user.isGM);\r\n}\r\n\r\nexport function getCharacterOwner(actor, connected = false) {\r\n\tif (connected)\r\n\t\treturn game.users.find((x) => x.active && x.character === actor);\r\n\treturn game.users.find((x) => x.character === actor);\r\n}\r\n\r\nexport function getActiveOwner(doc) {\r\n\tconst activeOwners = game.users.filter(\r\n\t\t(user) =>\r\n\t\t\tuser.active && !user.isGM && doc.testUserPermission(user, \"OWNER\"),\r\n\t);\r\n\tactiveOwners.sort((a, b) => (a.id > b.id ? 1 : -1));\r\n\treturn activeOwners[0] || null;\r\n}\r\n\r\nexport function isActiveOwner(doc) {\r\n\treturn getActiveOwner(doc) === game.user;\r\n}\r\n\r\nexport function getOwner(doc, connected = false) {\r\n\tif (connected)\r\n\t\treturn game.users.find(\r\n\t\t\t(x) => x.active && doc.testUserPermission(x, \"OWNER\"),\r\n\t\t);\r\n\treturn game.users.find((x) => doc.testUserPermission(x, \"OWNER\"));\r\n}\r\n", "import { MoveLootPopup } from \"../apps/giveth/popup\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { chatUUID } from \"../shared/chat\";\r\nimport { registerUpstreamHook } from \"../shared/hook\";\r\nimport { localize } from \"../shared/localize\";\r\nimport { warn } from \"../shared/notification\";\r\nimport { getSetting } from \"../shared/settings\";\r\nimport { socketOff, socketOn, socketEmit } from \"../shared/socket\";\r\nimport { isActiveGM, isGMOnline } from \"../shared/user\";\r\n\r\nlet enabled = false;\r\nlet CANVAS_HOOK = null;\r\n\r\nexport function registerGiveth() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"giveth\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"no-message\"],\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-giveth\"],\r\n\t\tready: (isGM) => {\r\n\t\t\tif (getSetting(\"giveth\") !== \"disabled\") setup(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst isGM = game.user.isGM;\r\n\r\n\tif (value === \"disabled\" && enabled) {\r\n\t\tif (isGM) socketOff(onSocket);\r\n\t\telse if (CANVAS_HOOK) {\r\n\t\t\tHooks.off(\"dropCanvasData\", CANVAS_HOOK);\r\n\t\t\tCANVAS_HOOK = null;\r\n\t\t}\r\n\t\tenabled = false;\r\n\t} else if (value !== \"disabled\" && !enabled) {\r\n\t\tif (isGM) socketOn(onSocket);\r\n\t\telse if (!CANVAS_HOOK)\r\n\t\t\tCANVAS_HOOK = registerUpstreamHook(\"dropCanvasData\", onDropCanvasData);\r\n\t\tenabled = true;\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tif (!isActiveGM()) return;\r\n\tif (packet.type === \"giveth-condition\") takethCondition(packet);\r\n\telse if (packet.type === \"giveth-effect\") takethEffect(packet);\r\n\telse takethPhysical(packet);\r\n}\r\n\r\nfunction onDropCanvasData(canvas, data) {\r\n\tif (!isGMOnline()) return true;\r\n\r\n\tconst details = getDetailsFromData(data);\r\n\tif (!details) return true;\r\n\r\n\tconst target = canvas.tokens.placeables\r\n\t\t.slice()\r\n\t\t.filter((token) => {\r\n\t\t\tif (!token.document.actorLink) return false;\r\n\t\t\tconst target = token.actor;\r\n\t\t\tif (!isValidActor(target, data.actorId) || target.isOwner) return false;\r\n\t\t\tconst maximumX = token.x + (token.hitArea?.right ?? 0);\r\n\t\t\tconst maximumY = token.y + (token.hitArea?.bottom ?? 0);\r\n\t\t\treturn (\r\n\t\t\t\tdata.x >= token.x &&\r\n\t\t\t\tdata.y >= token.y &&\r\n\t\t\t\tdata.x <= maximumX &&\r\n\t\t\t\tdata.y <= maximumY\r\n\t\t\t);\r\n\t\t})\r\n\t\t.sort((a, b) => b.document.sort - a.document.sort)\r\n\t\t.at(0)?.actor;\r\n\r\n\tif (!target) return true;\r\n\r\n\tgiveth(details.actor, target, details.item, details.value);\r\n\treturn false;\r\n}\r\n\r\nfunction giveth(origin, target, item, value) {\r\n\tconst ownerId = origin.id;\r\n\tconst targetId = target.id;\r\n\tconst isIndex = !(item instanceof Item);\r\n\r\n\tif (!isIndex && item.isOfType(\"physical\")) {\r\n\t\tconst qty = item.quantity;\r\n\t\tif (qty < 1) return warn(\"giveth.notification.zero\");\r\n\r\n\t\tif (qty === 1)\r\n\t\t\treturn sendPhysicalRequest(ownerId, targetId, item.id, 1, false);\r\n\r\n\t\tnew MoveLootPopup(\r\n\t\t\torigin,\r\n\t\t\t{ maxQuantity: qty, lockStack: false, isPurchase: false },\r\n\t\t\t(qty, stack) => {\r\n\t\t\t\tsendPhysicalRequest(ownerId, targetId, item.id, qty, stack);\r\n\t\t\t},\r\n\t\t).render(true);\r\n\t} else {\r\n\t\tconst uuid = isIndex ? `Compendium.${item.pack}.${item._id}` : item.uuid;\r\n\t\tif (item.type === \"condition\") {\r\n\t\t\tsocketEmit({\r\n\t\t\t\ttype: \"giveth-condition\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tvalue: value ?? 1,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tsocketEmit({\r\n\t\t\t\ttype: \"giveth-effect\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction sendPhysicalRequest(ownerId, targetId, itemId, qty, stack) {\r\n\tsocketEmit({\r\n\t\ttype: \"giveth-physical\",\r\n\t\townerId,\r\n\t\ttargetId,\r\n\t\titemId,\r\n\t\tqty,\r\n\t\tstack,\r\n\t});\r\n}\r\n\r\nfunction isValidActor(actor, id) {\r\n\tif (!isPlayedActor(actor) || (id && actor.id === id)) return false;\r\n\treturn (\r\n\t\tactor.hasPlayerOwner &&\r\n\t\t!actor.isToken &&\r\n\t\tactor.isOfType(\"character\", \"npc\", \"vehicle\")\r\n\t);\r\n}\r\n\r\nfunction getDetailsFromData(data) {\r\n\tif (data.tokenId || data.type !== \"Item\" || !data.uuid) return;\r\n\r\n\tconst item = fromUuidSync(data.uuid);\r\n\tif (!item) return;\r\n\r\n\tlet actor = item.actor;\r\n\tif (!actor) {\r\n\t\tconst actorUUID = data.context?.origin.actor;\r\n\t\tactor = actorUUID ? fromUuidSync(actorUUID) : null;\r\n\t}\r\n\r\n\tif (!isValidActor(actor) || !actor.isOwner) return;\r\n\r\n\tconst isIndex = !(item instanceof Item);\r\n\tif (isIndex && item.pack && [\"effect\", \"condition\"].includes(item.type))\r\n\t\treturn { actor, item, value: data.value };\r\n\tif (!isIndex && item.isOfType(\"physical\", \"effect\"))\r\n\t\treturn { actor, item, value: data.value };\r\n}\r\n\r\nasync function takethCondition({ targetId, uuid, value }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\ttarget.increaseCondition(item.slug, { min: value });\r\n}\r\n\r\nasync function takethEffect({ targetId, uuid }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\tconst source = item\r\n\t\t.clone({ \"system.tokenIcon.show\": true, \"system.unidentified\": false })\r\n\t\t.toObject();\r\n\ttarget.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n\r\nasync function takethPhysical({ itemId, ownerId, qty, stack, targetId }) {\r\n\tconst owner = game.actors.get(ownerId);\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!owner || !target) return;\r\n\r\n\tconst item = owner.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tqty = Math.min(qty, item.quantity);\r\n\tconst newQty = item.quantity - qty;\r\n\r\n\tconst source = item.toObject();\r\n\tsource.system.quantity = qty;\r\n\tsource.system.equipped.carryType = \"worn\";\r\n\tif (item.isOfType(\"physical\") && \"invested\" in source.system.equipped) {\r\n\t\tsource.system.equipped.invested = item.traits.has(\"invested\")\r\n\t\t\t? false\r\n\t\t\t: null;\r\n\t}\r\n\r\n\tconst newItem = await target.addToInventory(source, undefined, stack);\r\n\tif (!newItem) return;\r\n\r\n\tif (newQty < 1) item.delete();\r\n\telse item.update({ \"system.quantity\": newQty });\r\n\r\n\tif (getSetting(\"giveth\") === \"no-message\") return;\r\n\r\n\tlet content = chatUUID(newItem.uuid, newItem.name, !newItem.isIdentified);\r\n\tif (qty > 1) content += ` x${qty}`;\r\n\r\n\tconst giveth = localize(\"giveth.giveth\", {\r\n\t\ttarget: target.name,\r\n\t});\r\n\r\n\tChatMessage.create({\r\n\t\tflavor: `<h4 class=\"action\">${giveth}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: owner }),\r\n\t});\r\n}\r\n", "import { getHeroActions, sendTradeRequest } from \"../../features/hero\";\r\nimport { subLocalize } from \"../../shared/localize\";\r\nimport { templatePath } from \"../../shared/path\";\r\nimport { getCharacterOwner, getOwner } from \"../../shared/user\";\r\n\r\nconst localize = subLocalize(\"hero.templates.trade\");\r\n\r\nexport class Trade extends Application {\r\n\tconstructor(actor) {\r\n\t\tsuper({ id: `pf2e-hero-actions-trade-${actor.id}` });\r\n\t\tthis._actor = actor;\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn mergeObject(Application.defaultOptions, {\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\ttemplate: templatePath(\"hero/trade\"),\r\n\t\t\twidth: 600,\r\n\t\t\theight: \"auto\",\r\n\t\t});\r\n\t}\r\n\r\n\tget actor() {\r\n\t\treturn this._actor;\r\n\t}\r\n\r\n\tget target() {\r\n\t\treturn this._target;\r\n\t}\r\n\r\n\tset target(value) {\r\n\t\tif (!value) {\r\n\t\t\tlocalize.error(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (value === this._target) return;\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t\tthis._target = value;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(), {\r\n\t\t\tactor: this.actor,\r\n\t\t\ttarget: this.target,\r\n\t\t\ttargets: game.actors.filter(\r\n\t\t\t\t(x) =>\r\n\t\t\t\t\tx.type === \"character\" && x.id !== this.actor.id && x.hasPlayerOwner,\r\n\t\t\t),\r\n\t\t\tactions: getHeroActions(this.actor),\r\n\t\t\ttargetActions: this.target ? getHeroActions(this.target) : [],\r\n\t\t\ti18n: localize,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\t\thtml\r\n\t\t\t.find('select[name=\"target\"]')\r\n\t\t\t.on(\"change\", this.#onChangeTarget.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"description\"]')\r\n\t\t\t.on(\"click\", this.#onDescription.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"trade\"]')\r\n\t\t\t.on(\"click\", this.#onSendTrade.bind(this));\r\n\t\thtml.find('[data-action=\"cancel\"]').on(\"click\", () => this.close());\r\n\t}\r\n\r\n\trender(force, options) {\r\n\t\tthis.actor.apps[this.appId] = this;\r\n\t\tif (this.target) this.target.apps[this.appId] = this;\r\n\t\treturn super.render(force, options);\r\n\t}\r\n\r\n\tasync close(options) {\r\n\t\tawait super.close(options);\r\n\t\tdelete this.actor.apps?.[this.appId];\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t}\r\n\r\n\t#onSendTrade() {\r\n\t\tif (!this.target) {\r\n\t\t\tlocalize.warn(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst action = this.element.find('[name=\"action\"]:checked').val();\r\n\t\tconst target = this.element.find('[name=\"targetAction\"]:checked').val();\r\n\r\n\t\tif (typeof action !== \"string\" || typeof target !== \"string\") {\r\n\t\t\tlocalize.warn(\"no-select\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst user =\r\n\t\t\tgetCharacterOwner(this.target, true) ??\r\n\t\t\tgetOwner(this.target, true) ??\r\n\t\t\tgame.users.activeGM;\r\n\r\n\t\tif (!user) {\r\n\t\t\tlocalize.warn(\"no-user\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsendTradeRequest({\r\n\t\t\tsender: {\r\n\t\t\t\tid: game.user.id,\r\n\t\t\t\tcid: this.actor.id,\r\n\t\t\t\tuuid: action,\r\n\t\t\t},\r\n\t\t\treceiver: {\r\n\t\t\t\tid: user.id,\r\n\t\t\t\tcid: this.target.id,\r\n\t\t\t\tuuid: target,\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\tasync #onDescription(event) {\r\n\t\tconst uuid = $(event.currentTarget).siblings(\"input\").val();\r\n\t\tconst entry = await fromUuid(uuid);\r\n\t\tentry?.sheet.render(true);\r\n\t}\r\n\r\n\t#onChangeTarget(event) {\r\n\t\tconst id = event.currentTarget.value;\r\n\t\tthis.target = game.actors.get(id);\r\n\t}\r\n}\r\n", "import { Trade } from \"../apps/hero/trade\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { chatUUID } from \"../shared/chat\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { localize, subLocalize } from \"../shared/localize\";\r\nimport { refreshCharacterSheets } from \"../shared/misc\";\r\nimport { error, warn } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting, setSetting } from \"../shared/settings\";\r\nimport { socketEmit, socketOff, socketOn } from \"../shared/socket\";\r\nimport { isActiveGM } from \"../shared/user\";\r\n\r\nconst MODULE_ID = \"pf2e-hero-actions\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderCharacterSheetPF2e\",\r\n\trenderCharacterSheetPF2e,\r\n\tsetupSocket,\r\n);\r\n\r\nconst JOURNAL_UUID = \"Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko\";\r\nconst TABLE_UUID = \"Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK\";\r\n\r\nconst TABLE_ICON = \"systems/pf2e/icons/features/feats/heroic-recovery.webp\";\r\n\r\nlet SOCKET = false;\r\n\r\nexport function registerHeroActions() {\r\n\treturn {\r\n\t\tname: \"heroActions\",\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"hero\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: (value) => setHook(value),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"hero-table\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"\",\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"hero-trade\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: () => refreshCharacterSheets(),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"hero-private\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [MODULE_ID],\r\n\t\tapi: {\r\n\t\t\tcreateTable,\r\n\t\t\tremoveHeroActions,\r\n\t\t\tgetHeroActions,\r\n\t\t\tuseHeroAction,\r\n\t\t\tgetHeroActionDetails,\r\n\t\t\tdrawHeroAction,\r\n\t\t\tdrawHeroActions,\r\n\t\t\tsendActionToChat,\r\n\t\t\tdiscardHeroActions,\r\n\t\t\ttradeHeroAction,\r\n\t\t\tgetDeckTable,\r\n\t\t\tgiveHeroActions,\r\n\t\t\tcreateChatMessage,\r\n\t\t},\r\n\t\tready: () => {\r\n\t\t\tsetHook(false, \"hero\");\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setupSocket(value) {\r\n\tif (value && !SOCKET) {\r\n\t\tsocketOn(onSocket);\r\n\t\tSOCKET = true;\r\n\t} else if (!value && SOCKET) {\r\n\t\tsocketOff(onSocket);\r\n\t\tSOCKET = false;\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tswitch (packet.type) {\r\n\t\tcase \"hero.trade-reject\":\r\n\t\t\tif (packet.sender.id !== game.user.id) return;\r\n\t\t\tonTradeRejected(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-accept\":\r\n\t\t\tif (!isActiveGM()) return;\r\n\t\t\tonTradeAccepted(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-request\":\r\n\t\t\tif (packet.receiver.id !== game.user.id) return;\r\n\t\t\tonTradeRequest(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-error\":\r\n\t\t\tif (!packet.users.includes(game.user.id)) return;\r\n\t\t\tonTradeError(packet.error);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tawait addActionsToSheet(html, actor);\r\n\taddSheetEvents(html, actor);\r\n}\r\n\r\nasync function addActionsToSheet(html, actor) {\r\n\tconst actions = getHeroActions(actor);\r\n\tconst diff = actor.heroPoints.value - actions.length;\r\n\tconst isOwner = actor.isOwner;\r\n\tconst localize = subLocalize(\"hero.templates.heroActions\");\r\n\r\n\tconst template = await renderTemplate(templatePath(\"hero/sheet\"), {\r\n\t\towner: isOwner,\r\n\t\tlist: actions,\r\n\t\tcanUse: diff >= 0 && isOwner,\r\n\t\tcanDraw: diff > 0 && isOwner,\r\n\t\tcanTrade: getSetting(\"hero-trade\"),\r\n\t\tmustDiscard: diff < 0,\r\n\t\tdiff: Math.abs(diff),\r\n\t\ti18n: (key, { hash }) => localize(key, hash),\r\n\t});\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)\",\r\n\t\t)\r\n\t\t.first()\r\n\t\t.after(template);\r\n}\r\n\r\nfunction addSheetEvents(html, actor) {\r\n\tconst list = html.find(\".tab.actions .heroActions-list\");\r\n\tlist\r\n\t\t.find(\"[data-action=draw]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionsDraw(actor, event));\r\n\tlist.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\tlist\r\n\t\t.find(\"[data-action=use]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionUse(actor, event));\r\n\tlist\r\n\t\t.find(\"[data-action=display]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionDisplay(actor, event));\r\n\tlist.find(\"[data-action=discard]\").on(\"click\", onClickHeroActionDiscard);\r\n\tlist\r\n\t\t.find(\"[data-action=discard-selected]\")\r\n\t\t.on(\"click\", () => onClickHeroActionsDiscard(actor, html));\r\n\thtml\r\n\t\t.find(\"[data-action=hero-actions-trade]\")\r\n\t\t.on(\"click\", () => tradeHeroAction(actor));\r\n}\r\n\r\nasync function onClickHeroActionsDiscard(actor, html) {\r\n\tconst discarded = html.find(\r\n\t\t\".tab.actions .heroActions-list .action.discarded\",\r\n\t);\r\n\tconst uuids = discarded.toArray().map((x) => x.dataset.uuid);\r\n\tdiscardHeroActions(actor, uuids);\r\n}\r\n\r\nfunction onClickHeroActionDiscard(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst list = action.closest(\".heroActions-list\");\r\n\r\n\taction.toggleClass(\"discarded\");\r\n\r\n\tconst toDiscard = Number(list.attr(\"data-discard\") ?? \"0\");\r\n\tconst $discarded = list.find(\".action.discarded\");\r\n\r\n\tlist.toggleClass(\"discardable\", $discarded.length === toDiscard);\r\n}\r\n\r\nasync function onClickHeroActionDisplay(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tsendActionToChat(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionUse(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tuseHeroAction(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionsDraw(actor, event) {\r\n\tevent.preventDefault();\r\n\tdrawHeroActions(actor);\r\n}\r\n\r\nexport function getHeroActions(actor) {\r\n\treturn getProperty(actor, `flags.${MODULE_ID}.heroActions`) ?? [];\r\n}\r\n\r\nasync function setHeroActions(actor, actions) {\r\n\treturn actor.update({ [`flags.${MODULE_ID}.heroActions`]: actions });\r\n}\r\n\r\nasync function onClickHeroActionExpand(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst summary = action.find(\".item-summary\");\r\n\r\n\tif (!summary.hasClass(\"loaded\")) {\r\n\t\tconst uuid = action.attr(\"data-uuid\");\r\n\t\tconst details = await getHeroActionDetails(uuid);\r\n\t\tif (!details) return;\r\n\r\n\t\tconst text = await TextEditor.enrichHTML(details.description, {\r\n\t\t\tasync: true,\r\n\t\t});\r\n\r\n\t\tsummary.find(\".item-description\").html(text);\r\n\t\tsummary.addClass(\"loaded\");\r\n\t}\r\n\r\n\taction.toggleClass(\"expanded\");\r\n}\r\n\r\nasync function getHeroActionDetails(uuid) {\r\n\tconst document = await fromUuid(uuid);\r\n\tif (!document) return undefined;\r\n\r\n\tconst parent = document instanceof JournalEntry ? document : document.parent;\r\n\tconst page =\r\n\t\tdocument instanceof JournalEntry ? document.pages.contents[0] : document;\r\n\r\n\tlet text = page?.text.content;\r\n\tif (!text) return undefined;\r\n\r\n\tif (parent.uuid === JOURNAL_UUID)\r\n\t\ttext = text.replace(/^<p>/, \"<p><strong>Trigger</strong> \");\r\n\treturn { name: page.name, description: text };\r\n}\r\n\r\nexport async function drawHeroActions(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst nb = actor.heroPoints.value - actions.length;\r\n\r\n\tconst drawn = [];\r\n\tfor (let i = 0; i < nb; i++) {\r\n\t\tconst action = await drawHeroAction();\r\n\r\n\t\tif (action === undefined) continue;\r\n\t\tif (action === null) return;\r\n\r\n\t\tactions.push(action);\r\n\t\tdrawn.push(action);\r\n\t}\r\n\r\n\tif (!drawn.length) return;\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: drawn,\r\n\t\tlabel: (nb) => localize(\"hero.actions-draw.header\", { nb }),\r\n\t\tsecret: true,\r\n\t});\r\n}\r\n\r\nfunction createChatMessage({ actor, actions, label, secret = false }) {\r\n\tconst { content, size } = chatActions(actions);\r\n\r\n\tlabel = typeof label === \"function\" ? label(size) : label;\r\n\r\n\tconst data = {\r\n\t\tflavor: `<h4 class=\"action\">${label}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t};\r\n\r\n\tif (secret && getSetting(\"hero-private\")) {\r\n\t\tdata.type = CONST.CHAT_MESSAGE_TYPES.ROLL;\r\n\t\tdata.rollMode = CONST.DICE_ROLL_MODES.PRIVATE;\r\n\t}\r\n\r\n\tChatMessage.create(data);\r\n}\r\n\r\nfunction chatActions(actions) {\r\n\tconst links = actions.map(({ uuid, name }) => chatUUID(uuid, name));\r\n\treturn {\r\n\t\tcontent: links\r\n\t\t\t.map((x) => `<div style=\"line-height: 1.6;\">${x}</div>`)\r\n\t\t\t.join(\"\"),\r\n\t\tsize: links.length,\r\n\t};\r\n}\r\n\r\nfunction tradeHeroAction(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tif (!actions || !actions.length) {\r\n\t\twarn(\"hero.no-action\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst diff = actions.length - actor.heroPoints.value;\r\n\tif (diff > 0) {\r\n\t\twarn(\"hero.no-points\", { nb: diff.toString() });\r\n\t\treturn;\r\n\t}\r\n\r\n\tnew Trade(actor).render(true);\r\n}\r\n\r\nasync function drawHeroAction() {\r\n\tconst table = await getDeckTable();\r\n\tconst localize = subLocalize(\"hero.table\");\r\n\r\n\tif (!table) {\r\n\t\tlocalize.error(\"drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (!table.formula) {\r\n\t\tif (game.user.isGM) {\r\n\t\t\tif (table.compendium) {\r\n\t\t\t\tlocalize.error(\"noFormulaCompendium\", true);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\tawait table.normalize();\r\n\t\t} else {\r\n\t\t\tlocalize.error(\"noFormula\", true);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tif (table.replacement === false) {\r\n\t\tconst notDrawn = table.results.some((r) => !r.drawn);\r\n\t\tif (!notDrawn) await table.resetResults();\r\n\t}\r\n\r\n\tconst draw = (await table.draw({ displayChat: false })).results[0];\r\n\tif (!draw) return;\r\n\r\n\tconst uuid = documentUuidFromTableResult(draw);\r\n\tif (uuid) return { uuid, name: await getLabelfromTableResult(draw, uuid) };\r\n}\r\n\r\nasync function useHeroAction(actor, uuid) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst points = actor.heroPoints.value;\r\n\tif (points < 1) return warn(\"hero.use.noPoints\");\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\r\n\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\tif (index === -1) return;\r\n\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) error(\"hero.use.noDetails\");\r\n\r\n\tactions.splice(index, 1);\r\n\r\n\tif (details) {\r\n\t\tactor.update({\r\n\t\t\t\"system.resources.heroPoints.value\": points - 1,\r\n\t\t\t[`flags.${MODULE_ID}.heroActions`]: actions,\r\n\t\t});\r\n\r\n\t\tChatMessage.create({\r\n\t\t\tflavor: `<h4 class=\"action\">${localize(\"hero.actions-use.header\")}</h4>`,\r\n\t\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\t\tspeaker: ChatMessage.getSpeaker({ actor }),\r\n\t\t});\r\n\t} else {\r\n\t\tsetHeroActions(actor, actions);\r\n\t}\r\n}\r\n\r\nasync function discardHeroActions(actor, actionsUUIDS) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst uuids =\r\n\t\ttypeof actionsUUIDS === \"string\" ? [actionsUUIDS] : actionsUUIDS;\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst removed = [];\r\n\r\n\tfor (const uuid of uuids) {\r\n\t\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\t\tif (index === -1) continue;\r\n\t\tremoved.push(actions[index]);\r\n\t\tactions.splice(index, 1);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: removed,\r\n\t\tlabel: (nb) => localize(\"hero.actions-discard.header\", { nb }),\r\n\t});\r\n}\r\n\r\nasync function getLabelfromTableResult(result, uuid) {\r\n\tif (result.type !== CONST.TABLE_RESULT_TYPES.TEXT) return result.text;\r\n\tconst label = /@UUID\\[[\\w\\.]+\\]{([\\w -]+)}/.exec(result.text)?.[1];\r\n\treturn label ?? (uuid && (await fromUuid(uuid))?.name);\r\n}\r\n\r\nasync function getTableFromUuid(uuid) {\r\n\tif (!uuid) return undefined;\r\n\tconst table = await fromUuid(uuid);\r\n\treturn table && table instanceof RollTable ? table : undefined;\r\n}\r\n\r\nasync function getDefaultCompendiumTable() {\r\n\treturn getTableFromUuid(TABLE_UUID);\r\n}\r\n\r\nfunction getDefaultWorldTable() {\r\n\treturn game.tables.find((x) => x.getFlag(\"core\", \"sourceId\") === TABLE_UUID);\r\n}\r\n\r\nasync function getCustomTable() {\r\n\treturn getTableFromUuid(getSetting(\"hero-table\"));\r\n}\r\n\r\nasync function getDeckTable() {\r\n\treturn (\r\n\t\t(await getCustomTable()) ??\r\n\t\tgetDefaultWorldTable() ??\r\n\t\t(await getDefaultCompendiumTable())\r\n\t);\r\n}\r\n\r\nasync function sendActionToChat(actor, uuid) {\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) return error(\"hero.details.missing\");\r\n\r\n\tChatMessage.create({\r\n\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t});\r\n}\r\n\r\nexport function sendTradeRequest(trade) {\r\n\tif (trade.receiver.id === game.user.id) {\r\n\t\tacceptRequest(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocketEmit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-request\",\r\n\t});\r\n}\r\n\r\nfunction acceptRequest(trade) {\r\n\tif (game.user.isGM) {\r\n\t\tonTradeAccepted(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocketEmit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-accept\",\r\n\t});\r\n}\r\n\r\nasync function onTradeAccepted(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderActions = getHeroActions(senderActor);\r\n\tconst receiverActions = getHeroActions(receiverActor);\r\n\r\n\tconst senderActionIndex = senderActions.findIndex(\r\n\t\t(x) => x.uuid === sender.uuid,\r\n\t);\r\n\tconst receiverActionIndex = receiverActions.findIndex(\r\n\t\t(x) => x.uuid === receiver.uuid,\r\n\t);\r\n\r\n\tif (senderActionIndex === -1 || receiverActionIndex === -1) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderAction = senderActions.splice(senderActionIndex, 1)[0];\r\n\tconst receiverAction = receiverActions.splice(receiverActionIndex, 1)[0];\r\n\r\n\tsenderActions.push(receiverAction);\r\n\treceiverActions.push(senderAction);\r\n\r\n\tsetHeroActions(senderActor, senderActions);\r\n\tsetHeroActions(receiverActor, receiverActions);\r\n\r\n\tconst sentLink = chatUUID(senderAction.uuid);\r\n\tconst receivedLink = chatUUID(receiverAction.uuid);\r\n\r\n\tconst localize = subLocalize(\"hero.trade-success\");\r\n\r\n\tlet content = `<div style=\"line-height: 1.6\">${localize(\"offer\", {\r\n\t\toffer: sentLink,\r\n\t})}</div>`;\r\n\tcontent += `<div style=\"line-height: 1.6\">${localize(\"receive\", {\r\n\t\treceive: receivedLink,\r\n\t})}</div>`;\r\n\r\n\tChatMessage.create({\r\n\t\tflavor: `<h4 class=\"action\">${localize(\"header\", {\r\n\t\t\tname: receiverActor.name,\r\n\t\t})}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: senderActor }),\r\n\t});\r\n}\r\n\r\nfunction sendTradeError({ sender, receiver }, error = \"trade-error\") {\r\n\tconst users = new Set([sender.id, receiver.id]);\r\n\r\n\tif (users.has(game.user.id)) {\r\n\t\tusers.delete(game.user.id);\r\n\t\tonTradeError(error);\r\n\t}\r\n\r\n\tif (!users.size) return;\r\n\r\n\tsocketEmit({\r\n\t\ttype: \"hero.trade-error\",\r\n\t\tusers: Array.from(users),\r\n\t\terror,\r\n\t});\r\n}\r\n\r\nfunction onTradeError(err) {\r\n\terror(\"hero.trade-error\");\r\n}\r\n\r\nasync function onTradeRequest(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.trade-request\");\r\n\r\n\tlet content = `<p>${localize(\"header\", {\r\n\t\tsender: senderActor.name,\r\n\t\treceiver: receiverActor.name,\r\n\t})}</p>`;\r\n\tcontent += `<p>${localize(\"give\", { give: chatUUID(sender.uuid) })}</p>`;\r\n\tcontent += `<p>${localize(\"want\", { want: chatUUID(receiver.uuid) })}</p>`;\r\n\tcontent += `<p style=\"margin-bottom: 1em;\">${localize(\"accept\")}</p>`;\r\n\r\n\tconst accept = await Dialog.confirm({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await TextEditor.enrichHTML(content, { async: true }),\r\n\t});\r\n\r\n\tif (accept) acceptRequest(trade);\r\n\telse rejectRequest(trade);\r\n}\r\n\r\nfunction rejectRequest(trade) {\r\n\tif (trade.sender.id === game.user.id) {\r\n\t\tonTradeRejected(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocketEmit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-reject\",\r\n\t});\r\n}\r\n\r\nasync function onTradeRejected({ receiver }) {\r\n\tconst actor = game.actors.get(receiver.cid);\r\n\twarn(\"hero.trade-rejected\", { name: actor.name }, true);\r\n}\r\n\r\nasync function createTable() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.createTable.choice\");\r\n\tconst template = templatePath(\"hero/dialogs/create-table\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"create\"),\r\n\t\t\ticon: '<i class=\"fas fa-border-all\"></i>',\r\n\t\t\tcallback: (html) => {\r\n\t\t\t\tconst type = html\r\n\t\t\t\t\t.find('.window-content input[name=\"type\"]:checked')\r\n\t\t\t\t\t.val();\r\n\t\t\t\tconst unique =\r\n\t\t\t\t\thtml.find('.window-content input[name=\"draw\"]:checked').val() ===\r\n\t\t\t\t\t\"unique\";\r\n\t\t\t\treturn { type, unique };\r\n\t\t\t},\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, { i18n: localize }),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-create-table\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tif (result.type === \"default\") createDefaultTable(result.unique);\r\n\telse createCustomTable(result.unique);\r\n}\r\n\r\nasync function createCustomTable(unique) {\r\n\tconst table = await createCustomActionsTable(unique);\r\n\tawait setTable(table);\r\n\ttable.sheet?.render(true);\r\n}\r\n\r\nfunction createCustomActionsTable(unique = true) {\r\n\tconst source = getTableSource(unique);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function createDefaultTable(unique) {\r\n\tconst localize = subLocalize(\"templates.createTable.default.confirm\");\r\n\tlet table = await getDefaultWorldTable();\r\n\r\n\tif (table) {\r\n\t\tconst override = await Dialog.confirm({\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tcontent: localize(\"content\"),\r\n\t\t});\r\n\r\n\t\tif (override) {\r\n\t\t\tconst update = getTableSource(unique);\r\n\t\t\tawait table.update(update);\r\n\t\t\treturn setTable(table, true);\r\n\t\t}\r\n\t}\r\n\r\n\ttable = await createDefautActionsTable(unique);\r\n\tawait setTable(table);\r\n}\r\n\r\nasync function createDefautActionsTable(unique = true) {\r\n\tconst table = await fromUuid(TABLE_UUID);\r\n\tconst source = getTableSource(unique, table);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function setTable(table, normalize = false) {\r\n\tif (normalize) await table.normalize();\r\n\tawait setSetting(\"hero-table\", table.uuid);\r\n}\r\n\r\nfunction getTableSource(unique, table) {\r\n\tconst source = {\r\n\t\tname: localize(\"hero.table.name\"),\r\n\t\treplacement: !(unique ?? true),\r\n\t\timg: TABLE_ICON,\r\n\t\tdescription: localize(\"hero.table.description\"),\r\n\t\tflags: {\r\n\t\t\tcore: {\r\n\t\t\t\tsourceId: TABLE_UUID,\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\tif (!table) return source;\r\n\treturn mergeObject(deepClone(table._source), source);\r\n}\r\n\r\nasync function removeHeroActions() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.removeActions\");\r\n\tconst template = templatePath(\"hero/dialogs/remove-actions\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"remove\"),\r\n\t\t\ticon: '<i class=\"fas fa-trash\"></i>',\r\n\t\t\tcallback: (html) =>\r\n\t\t\t\thtml\r\n\t\t\t\t\t.find('input[name=\"actor\"]:checked')\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((x) => game.actors.get(x.value))\r\n\t\t\t\t\t.filter((x) => x),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, {\r\n\t\t\tactors: game.actors.filter((x) => x.type === \"character\"),\r\n\t\t\ti18n: localize,\r\n\t\t}),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\trender: (html) => {\r\n\t\t\thtml.on(\"change\", 'input[name=\"all\"]', () =>\r\n\t\t\t\tremoveActionsToggleAll(html),\r\n\t\t\t);\r\n\t\t\thtml.on(\"change\", 'input[name=\"actor\"]', () =>\r\n\t\t\t\tremoveActionsToggleActor(html),\r\n\t\t\t);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst actors = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-remove-actions\",\r\n\t});\r\n\r\n\tif (!actors) return;\r\n\r\n\tif (!actors.length) {\r\n\t\tlocalize.warn(\"noSelection\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const actor of actors) {\r\n\t\tsetHeroActions(actor, []);\r\n\t}\r\n\r\n\tlocalize.info(\"removed\");\r\n}\r\n\r\nfunction removeActionsToggleAll(html) {\r\n\tconst state = html.find('input[name=\"all\"]')[0].checked;\r\n\thtml.find('input[name=\"actor\"]').prop(\"checked\", state);\r\n}\r\n\r\nfunction removeActionsToggleActor(html) {\r\n\tconst actors = html.find('input[name=\"actor\"]');\r\n\tconst checked = actors.filter(\":checked\");\r\n\tconst all = html.find('input[name=\"all\"]');\r\n\r\n\tif (actors.length === checked.length) {\r\n\t\tall.prop(\"checked\", true).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", true);\r\n\t} else if (!checked.length) {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", false);\r\n\t} else {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", true);\r\n\t}\r\n}\r\n\r\nfunction documentUuidFromTableResult(result) {\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.TEXT)\r\n\t\treturn /@UUID\\[([\\w\\.]+)\\]/.exec(result.text)?.[1];\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.DOCUMENT)\r\n\t\treturn `${result.documentCollection}.${result.documentId}`;\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.COMPENDIUM)\r\n\t\treturn `Compendium.${result.documentCollection}.${result.documentId}`;\r\n\treturn undefined;\r\n}\r\n\r\nasync function giveHeroActions(actor) {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst templateLocalize = subLocalize(\"hero.templates.giveAction\");\r\n\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\ttemplateLocalize.warn(\"noCharacter\");\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst table = await getDeckTable();\r\n\tif (!table) {\r\n\t\terror(\"hero.table.drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst isUnique = table.replacement === false;\r\n\r\n\tconst actionsList = (\r\n\t\tawait Promise.all(\r\n\t\t\ttable.results.map(async (result) => {\r\n\t\t\t\tconst uuid = documentUuidFromTableResult(result);\r\n\t\t\t\tif (!uuid) return;\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tkey: result.id,\r\n\t\t\t\t\tuuid,\r\n\t\t\t\t\tname: await getLabelfromTableResult(result, uuid),\r\n\t\t\t\t\tdrawn: result.drawn,\r\n\t\t\t\t};\r\n\t\t\t}),\r\n\t\t)\r\n\t).filter(Boolean);\r\n\r\n\tconst template = templatePath(\"hero/dialogs/give-action\");\r\n\tconst content = await renderTemplate(template, {\r\n\t\tactions: actionsList,\r\n\t\tisUnique,\r\n\t\ti18n: templateLocalize,\r\n\t});\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: templateLocalize(\"give\"),\r\n\t\t\ticon: '<i class=\"fa-solid fa-gift\"></i>',\r\n\t\t\tcallback: (html) => ({\r\n\t\t\t\tselected: html\r\n\t\t\t\t\t.find(\"[name=action]:checked\")\r\n\t\t\t\t\t.closest(\".action\")\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((el) => el.dataset),\r\n\t\t\t\tasDrawn: html.find(\"[name=drawn]\").prop(\"checked\") ?? false,\r\n\t\t\t\twithMessage: html.find(\"[name=message]\").prop(\"checked\"),\r\n\t\t\t}),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: templateLocalize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\ttitle: templateLocalize(\"title\"),\r\n\t\tcontent,\r\n\t\tbuttons,\r\n\t\trender: (html) => {\r\n\t\t\thtml.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-give-action\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst { selected, asDrawn, withMessage } = result;\r\n\tconst actions = getHeroActions(actor);\r\n\tconst tableUpdates = [];\r\n\r\n\tfor (const { uuid, name, key } of selected) {\r\n\t\tactions.push({ uuid, name });\r\n\t\tif (!asDrawn) continue;\r\n\r\n\t\tconst result = table.results.get(key);\r\n\t\tif (result && !result.drawn) tableUpdates.push(key);\r\n\t}\r\n\r\n\tif (tableUpdates.length) {\r\n\t\tawait table.updateEmbeddedDocuments(\r\n\t\t\t\"TableResult\",\r\n\t\t\ttableUpdates.map((key) => ({ _id: key, drawn: true })),\r\n\t\t);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\r\n\tif (withMessage) {\r\n\t\tcreateChatMessage({\r\n\t\t\tactor,\r\n\t\t\tactions: selected,\r\n\t\t\tlabel: (nb) => localize(\"hero.actions-give.header\", { nb }),\r\n\t\t\tsecret: true,\r\n\t\t});\r\n\t}\r\n}\r\n", "import { calculateDistanceBetweenPoints, getElementIndex } from \"./misc\";\r\n\r\n/** @type {DraggableData | null} */\r\nlet dragData = null;\r\n\r\nlet DRAG_ID = 0;\r\n\r\n/**\r\n * @template {DraggableOptions | DroppableOptions} T\r\n * @param {T} options\r\n * @param {OptionsFilter<T>} filters\r\n */\r\nfunction cleanOptions(options, filters) {\r\n\tfor (const [type, keys] of Object.entries(filters)) {\r\n\t\tfor (const key of keys) {\r\n\t\t\tconst option = options[key];\r\n\t\t\t// biome-ignore lint/suspicious/useValidTypeof: <explanation>\r\n\t\t\tif (!option || typeof option === type) continue;\r\n\t\t\toptions[option] = undefined;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {DraggableOptions} options\r\n */\r\nexport function makeDraggable(options) {\r\n\tif (!(options.element instanceof HTMLElement)) return;\r\n\r\n\tcleanOptions(options, {\r\n\t\tstring: [\"draggedClass\", \"group\", \"selector\", \"filter\", \"identifier\"],\r\n\t\tnumber: [\"triggerDistance\"],\r\n\t\tboolean: [\"cancelOnRightClick\"],\r\n\t\tfunction: [\"onCancel\", \"onDragEnd\", \"onDragStart\"],\r\n\t});\r\n\r\n\toptions.triggerDistance ??= 6;\r\n\r\n\toptions.cancelOnRightClick ??= true;\r\n\r\n\toptions.cursorImage ??= {};\r\n\toptions.cursorImage.id =\r\n\t\ttypeof options.cursorImage.id === \"string\" ? options.cursorImage.id : \"\";\r\n\toptions.cursorImage.img =\r\n\t\ttypeof options.cursorImage.img === \"function\"\r\n\t\t\t? options.cursorImage.img\r\n\t\t\t: undefined;\r\n\r\n\toptions.droppables ??= [];\r\n\r\n\tfor (let i = options.droppables.length - 1; i >= 0; i--) {\r\n\t\tconst droppable = options.droppables[i];\r\n\r\n\t\tif (!(droppable.element instanceof HTMLElement)) {\r\n\t\t\toptions.droppables.splice(i, 1);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tcleanOptions(droppable, {\r\n\t\t\tstring: [\"selector\", \"overClass\", \"filter\"],\r\n\t\t\tboolean: [\"purgeOnLeave\"],\r\n\t\t\tfunction: [\"onDragEnter\", \"onDragLeave\", \"onDragOver\", \"onDrop\"],\r\n\t\t});\r\n\t}\r\n\r\n\toptions.element.addEventListener(\"mousedown\", (event) =>\r\n\t\tonMouseDown(event, options),\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragCancel(event) {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.canceled = true;\r\n\r\n\tif (dragData.dragging && dragData.draggable.ghost) {\r\n\t\tdragData.draggable.ghost.reset();\r\n\t}\r\n\r\n\tif (dragData.dragging && dragData.options.onCancel) {\r\n\t\tawait dragData.options.onCancel(event, dragData.draggable);\r\n\t}\r\n\r\n\tcleanUp();\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragEnd(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging && dragData.options.onDragEnd) {\r\n\t\tawait dragData.options.onDragEnd(event, dragData.draggable, {\r\n\t\t\tcanceled: dragData.canceled,\r\n\t\t\tdropped: dragData.dropped,\r\n\t\t});\r\n\t}\r\n\r\n\twindow.removeEventListener(\"mousemove\", onMouseMove);\r\n\twindow.removeEventListener(\"mouseup\", onMouseUp);\r\n\r\n\tdragData = null;\r\n}\r\n\r\nfunction cleanUp() {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.draggable.classList.purge();\r\n\tdragData.draggable.ghost?.classList.purge();\r\n\tdragData.cursorElement?.remove();\r\n\r\n\tfor (const { classList } of Object.values(dragData.hovered)) {\r\n\t\tclassList.purge();\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n * @param {DraggableOptions} options\r\n */\r\nfunction onMouseDown(event, options) {\r\n\tif (\r\n\t\tevent.button === 2 &&\r\n\t\tdragData?.dragging &&\r\n\t\tdragData.options.cancelOnRightClick\r\n\t) {\r\n\t\tonDragCancel(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (event.button) return;\r\n\r\n\tconst target = closestInside(event.target, options.element, options);\r\n\tif (!target) return;\r\n\r\n\t/** @type {DraggableGhost | undefined} */\r\n\tlet _ghost;\r\n\r\n\tconst targetIndex = getElementIndex(target);\r\n\tconst targetParent = target.parentElement;\r\n\tconst targetClassList = newClassList(target);\r\n\r\n\t/** @type {DraggableData} */\r\n\tdragData = {\r\n\t\tcanceled: false,\r\n\t\tdragging: false,\r\n\t\tdropped: false,\r\n\t\toptions,\r\n\t\tgroup: options.group,\r\n\t\tdraggable: {\r\n\t\t\tidentifier: options.identifier,\r\n\t\t\telement: target,\r\n\t\t\ttriggeringElement: event.target,\r\n\t\t\tx: event.clientX,\r\n\t\t\ty: event.clientY,\r\n\t\t\tparent: targetParent,\r\n\t\t\tindex: targetIndex,\r\n\t\t\tclassList: targetClassList,\r\n\t\t\tget ghost() {\r\n\t\t\t\tif (_ghost) {\r\n\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t_ghost.classList.add(options.ghostClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn _ghost;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst { element = target.cloneNode(true), index = Infinity } =\r\n\t\t\t\t\toptions.createGhost?.(target, targetIndex) ?? {};\r\n\r\n\t\t\t\tconst classList = newClassList(element);\r\n\r\n\t\t\t\tif (options.draggedClass && element !== target) {\r\n\t\t\t\t\telement.classList.remove(options.draggedClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\tclassList.add(options.ghostClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t_ghost = {\r\n\t\t\t\t\telement,\r\n\t\t\t\t\tclassList,\r\n\t\t\t\t\tindex,\r\n\t\t\t\t\treset: () => {\r\n\t\t\t\t\t\telement.remove();\r\n\t\t\t\t\t\tif (element === target) {\r\n\t\t\t\t\t\t\tconst child = targetParent.children[targetIndex];\r\n\t\t\t\t\t\t\ttargetParent.insertBefore(target, child);\r\n\t\t\t\t\t\t\t_ghost.index = targetIndex;\r\n\t\t\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t\t\tclassList.remove(options.ghostClass);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t_ghost.index = Infinity;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t};\r\n\r\n\t\t\t\treturn _ghost;\r\n\t\t\t},\r\n\t\t\tresetPosition: () => {\r\n\t\t\t\ttarget.remove();\r\n\t\t\t\ttargetParent.children[targetIndex].before(target);\r\n\t\t\t},\r\n\t\t},\r\n\t\tdroppables: options.droppables.map((droppable) => ({\r\n\t\t\t...droppable,\r\n\t\t\tid: DRAG_ID++,\r\n\t\t})),\r\n\t\thovered: {},\r\n\t};\r\n\r\n\twindow.addEventListener(\"mousemove\", onMouseMove);\r\n\twindow.addEventListener(\"mouseup\", onMouseUp);\r\n}\r\n\r\nasync function onMouseMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tonDragMove(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst { draggable } = dragData;\r\n\tconst distance = calculateDistanceBetweenPoints(\r\n\t\tdraggable.x,\r\n\t\tdraggable.y,\r\n\t\tclientX,\r\n\t\tclientY,\r\n\t);\r\n\r\n\tif (distance > dragData.options.triggerDistance) {\r\n\t\tawait onDragStart(event);\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onMouseUp(event) {\r\n\tif (event.button || !dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tlet dropped = false;\r\n\r\n\t\tcleanUp();\r\n\r\n\t\tawait Promise.all(\r\n\t\t\tObject.values(dragData.hovered).map(async (hovered) => {\r\n\t\t\t\tif (!hovered.droppable.onDrop) return;\r\n\r\n\t\t\t\tconst hasDropped = await hovered.droppable.onDrop(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\t\ttriggeringElement: hovered.triggeringElement,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (hasDropped) dropped = true;\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\tdragData.dropped = dropped;\r\n\t}\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragStart(event) {\r\n\tif (dragData.dragging) return;\r\n\r\n\tdragData.dragging = true;\r\n\r\n\tif (dragData.options.cursorImage.img) {\r\n\t\tconst img = dragData.options.cursorImage.img(dragData.draggable.element);\r\n\t\tif (img instanceof HTMLElement) {\r\n\t\t\tdragData.cursorElement = img;\r\n\t\t} else {\r\n\t\t\tdragData.cursorElement = new Image();\r\n\t\t\tdragData.cursorElement.src = typeof img === \"string\" ? img : \"\";\r\n\t\t}\r\n\t} else {\r\n\t\tdragData.cursorElement = dragData.draggable.element.cloneNode(true);\r\n\t}\r\n\r\n\tdragData.cursorElement.id = dragData.options.cursorImage.id;\r\n\r\n\tif (dragData.options.draggedClass) {\r\n\t\tdragData.draggable.classList.add(dragData.options.draggedClass);\r\n\t}\r\n\r\n\tdocument.body.appendChild(dragData.cursorElement);\r\n\r\n\tawait dragData.options.onDragStart?.(event, dragData.draggable);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst cursorElement = dragData.cursorElement;\r\n\r\n\tconst offsetX = cursorElement.offsetWidth / 2;\r\n\tconst offsetY = cursorElement.offsetHeight / 2;\r\n\r\n\tcursorElement.style.left = `${clientX - offsetX}px`;\r\n\tcursorElement.style.top = `${clientY - offsetY}px`;\r\n\r\n\tawait Promise.all(\r\n\t\tdragData.droppables.map(async (droppable) => {\r\n\t\t\tconst target = closestInside(event.target, droppable.element, {\r\n\t\t\t\tselector: droppable.selector,\r\n\t\t\t\tfilter: droppable.filter,\r\n\t\t\t});\r\n\t\t\tconst hovered = dragData.hovered[droppable.id];\r\n\r\n\t\t\tif (hovered && (!target || hovered.element !== target)) {\r\n\t\t\t\tconst left = await droppable.onDragLeave?.(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (left !== false) {\r\n\t\t\t\t\tdelete dragData.hovered[droppable.id];\r\n\t\t\t\t\tif (droppable.purgeOnLeave) {\r\n\t\t\t\t\t\thovered.classList.purge();\r\n\t\t\t\t\t} else if (droppable.overClass) {\r\n\t\t\t\t\t\thovered.classList.remove(droppable.overClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!target) return;\r\n\r\n\t\t\tif (!hovered) {\r\n\t\t\t\tconst classList = newClassList(target);\r\n\r\n\t\t\t\tconst entered = await droppable.onDragEnter?.(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (entered !== false) {\r\n\t\t\t\t\tif (droppable.overClass) classList.add(droppable.overClass);\r\n\r\n\t\t\t\t\tdragData.hovered[droppable.id] = {\r\n\t\t\t\t\t\tid: droppable.id,\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\tdroppable,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t} else if (droppable.onDragOver) {\r\n\t\t\t\tawait droppable.onDragOver(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}),\r\n\t);\r\n}\r\n\r\n/**\r\n *\r\n * @param {HTMLElement} target\r\n * @returns {DraggableClassList}\r\n */\r\nexport function newClassList(target) {\r\n\treturn new (class extends Set {\r\n\t\tadd(value) {\r\n\t\t\ttarget.classList.add(value);\r\n\t\t\tsuper.add(value);\r\n\t\t}\r\n\t\tremove(value) {\r\n\t\t\ttarget.classList.remove(value);\r\n\t\t\tsuper.delete(value);\r\n\t\t}\r\n\t\ttoggle(value, enabled) {\r\n\t\t\tconst toggled = enabled ?? !target.classList.contains(value);\r\n\t\t\tif (toggled) this.add(value);\r\n\t\t\telse this.remove(value);\r\n\t\t}\r\n\t\tcontains(value) {\r\n\t\t\treturn this.has(value);\r\n\t\t}\r\n\t\tpurge() {\r\n\t\t\ttarget.classList.remove(...this);\r\n\t\t}\r\n\t})();\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {HTMLElement} parent\r\n * @param {Object} [options]\r\n * @param {string} [options.selector]\r\n * @param {string} [options.filter]\r\n * @returns {HTMLElement | undefined}\r\n */\r\nexport function closestInside(target, parent, { selector, filter } = {}) {\r\n\tif (!parent.contains(target)) return;\r\n\r\n\tif (!selector && !filter) return parent;\r\n\r\n\tlet element;\r\n\tlet cursor = target;\r\n\r\n\twhile (true) {\r\n\t\tif (filter && cursor.matches(filter)) return;\r\n\r\n\t\tif (!element && selector && cursor.matches(selector)) {\r\n\t\t\telement = cursor;\r\n\t\t}\r\n\r\n\t\tif (cursor === parent) break;\r\n\r\n\t\tcursor = cursor.parentElement;\r\n\t}\r\n\r\n\treturn !selector ? parent : element;\r\n}\r\n", "import {\r\n\tgetCharacterSheetTab,\r\n\tisPlayedActor,\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../shared/actor\";\r\nimport { closestInside, makeDraggable } from \"../shared/draggable\";\r\nimport { getFlag, setFlag } from \"../shared/flags\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport {\r\n\tcanBeInvested,\r\n\thasWornSlot,\r\n\tisHandwrapsOfMightyBlows,\r\n\tisHeld,\r\n\tisInvestedOrWornAs,\r\n\tisOneHanded,\r\n\tisTwoHanded,\r\n\titemCarryUpdate,\r\n} from \"../shared/item\";\r\nimport {\r\n\tgetElementIndex,\r\n\tgetInMemory,\r\n\tindexIsValid,\r\n\tsetInMemory,\r\n} from \"../shared/misc\";\r\nimport { error } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst closeHook = createHook(\r\n\t\"closeCharacterSheetPF2e\",\r\n\tcloseCharacterSheetPF2e,\r\n);\r\n\r\nlet dragging = false;\r\n\r\nexport function registerInventory() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"inventory\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tready: (isGm) => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nlet dragIdentifier;\r\n\r\nconst COINS = [\r\n\t\"platinum-pieces\",\r\n\t\"gold-pieces\",\r\n\t\"silver-pieces\",\r\n\t\"copper-pieces\",\r\n];\r\n\r\nfunction setup(value) {\r\n\tconst enabled = value ?? getSetting(\"inventory\");\r\n\tif (enabled) {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"inventory\",\r\n\t\t\ttemplateFolder: \"inventory/sheet\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t\tonRender,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"inventory\");\r\n\t}\r\n\tcloseHook(enabled);\r\n}\r\n\r\nfunction closeCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\tif (!getInMemory(sheet, \"inventory.requireSave\")) return;\r\n\r\n\tconst tab = getCharacterSheetTab(html, \"inventory\")[0];\r\n\tconst data = getCurrentData(tab);\r\n\tif (!data) return;\r\n\r\n\tsetFlag(actor, \"inventory\", data);\r\n}\r\n\r\nfunction onRender(actor, sheet, inner) {\r\n\tconst sidebar = inner.find(\"> aside\");\r\n\tsidebar.css(\"position\", \"relative\");\r\n\tsidebar.append(\r\n\t\t\"<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>\",\r\n\t);\r\n}\r\n\r\nfunction getCurrentData(tabElement) {\r\n\tif (!tabElement) return;\r\n\r\n\tconst alternate = tabElement.querySelector(\":scope > .alternate\");\r\n\tconst equipped = alternate.querySelector(\"[data-area='equipped']\");\r\n\r\n\tconst equippedItemId = (slot) => {\r\n\t\tconst el = equipped.querySelector(`[data-equipped-slot='${slot}']`);\r\n\t\tconst item = el.querySelector(\"[data-item-id]\");\r\n\t\treturn item?.dataset.itemId ?? null;\r\n\t};\r\n\r\n\tconst itemIds = (parent) => {\r\n\t\tconst ids = {};\r\n\t\tconst items = parent.querySelectorAll(\":scope > [data-item-id]\");\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tids[item.dataset.itemId] = i;\r\n\t\t}\r\n\t\treturn ids;\r\n\t};\r\n\r\n\tconst tabs = {};\r\n\tfor (const tab of alternate.querySelectorAll(\"[data-area='items-grid']\")) {\r\n\t\tconst tabId = tab.dataset.tabId;\r\n\t\ttabs[tabId] = itemIds(tab);\r\n\t}\r\n\r\n\treturn {\r\n\t\tequipped: {\r\n\t\t\thands: [equippedItemId(\"left-hand\"), equippedItemId(\"right-hand\")],\r\n\t\t\tarmor: [equippedItemId(\"armor\")],\r\n\t\t\tothers: itemIds(equipped),\r\n\t\t},\r\n\t\ttabs,\r\n\t};\r\n}\r\n\r\nasync function getData(actor, sheet, tabElement) {\r\n\tconst flags = getFlag(actor, \"inventory\");\r\n\tconst data = getCurrentData(tabElement[0]) ??\r\n\t\tflags ?? {\r\n\t\t\tequipped: {\r\n\t\t\t\thands: [null, null],\r\n\t\t\t\tarmor: [null],\r\n\t\t\t\tothers: {},\r\n\t\t\t},\r\n\t\t\ttabs: {},\r\n\t\t};\r\n\r\n\tif (!flags) {\r\n\t\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n\t}\r\n\r\n\tconst tabs = new Collection();\r\n\tconst orphans = {};\r\n\tconst containers = new Set();\r\n\tconst equipped = {\r\n\t\thands: [null, null],\r\n\t\tarmor: [null],\r\n\t\tothers: [],\r\n\t};\r\n\r\n\tfunction getTab(item) {\r\n\t\tconst tabId = item?.id;\r\n\r\n\t\tlet tab = tabs.get(tabId);\r\n\t\tif (tab) return tab;\r\n\r\n\t\ttab = {\r\n\t\t\tid: tabId,\r\n\t\t\titem: item,\r\n\t\t\tparent: item?.container,\r\n\t\t\tcontainers: [],\r\n\t\t\tmatrix: [],\r\n\t\t\tparents: [],\r\n\t\t};\r\n\r\n\t\ttabs.set(tabId, tab);\r\n\t\treturn tab;\r\n\t}\r\n\r\n\tfor (const item of actor.inventory) {\r\n\t\tif (\r\n\t\t\titem.isOfType(\"treasure\") &&\r\n\t\t\titem.system.stackGroup === \"coins\" &&\r\n\t\t\tCOINS.includes(item.slug)\r\n\t\t) {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst itemId = item.id;\r\n\t\tconst parent = item.container;\r\n\r\n\t\t// we retrieve the parent tab, undefined === root inventory\r\n\t\tconst tab = getTab(parent);\r\n\r\n\t\tconst addOrphan = (item) => {\r\n\t\t\torphans[tab.id] ??= [];\r\n\t\t\torphans[tab.id].push(item);\r\n\t\t};\r\n\r\n\t\tif (item.isOfType(\"backpack\")) {\r\n\t\t\ttab.containers.push(item);\r\n\t\t\tcontainers.add(item);\r\n\r\n\t\t\t// we create the tab for this container, in case it is empty\r\n\t\t\tgetTab(item);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst handsHeld = item.handsHeld;\r\n\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\tif (handsHeld === 2 && equippedHands === 0) {\r\n\t\t\tif (data.equipped.hands[0] === itemId) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (handsHeld === 1 && equippedHands <= 1) {\r\n\t\t\tconst handIndex = data.equipped.hands.indexOf(itemId);\r\n\t\t\tif (indexIsValid(handIndex)) {\r\n\t\t\t\tequipped.hands[handIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\tif (data.equipped.armor[0] === itemId) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\tisInvestedOrWornAs(item)\r\n\t\t) {\r\n\t\t\tconst equippedIndex = data.equipped.others[itemId];\r\n\t\t\tif (indexIsValid(equippedIndex)) {\r\n\t\t\t\tequipped.others[equippedIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst index = data.tabs[tab.id]?.[itemId];\r\n\t\tif (indexIsValid(index)) {\r\n\t\t\ttab.matrix[index] = item;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\taddOrphan(item);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tconst tabOrphans = orphans[tab.id];\r\n\t\tif (!tabOrphans) continue;\r\n\r\n\t\tfor (const item of tabOrphans) {\r\n\t\t\tconst handsHeld = item.handsHeld;\r\n\t\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\t\tif (equippedHands === 0 && handsHeld === 2) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (equippedHands <= 1 && handsHeld === 1) {\r\n\t\t\t\tconst otherIndex = equipped.hands[0] ? 1 : 0;\r\n\t\t\t\tequipped.hands[otherIndex] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\t\tisInvestedOrWornAs(item)\r\n\t\t\t) {\r\n\t\t\t\tequipped.others.push(item);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\ttab.matrix.push(item);\r\n\t\t}\r\n\r\n\t\ttab.matrix = tab.matrix.filter(Boolean);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tlet parent = tab.parent;\r\n\r\n\t\twhile (parent) {\r\n\t\t\ttab.parents.push(parent);\r\n\t\t\tparent = parent.container;\r\n\t\t}\r\n\r\n\t\ttab.parents.reverse();\r\n\r\n\t\tconst grouped = [tab.containers, tab.parents, tab.item].flat();\r\n\t\ttab.trailings = containers.filter((item) => !grouped.includes(item));\r\n\t}\r\n\r\n\t// if no item exist on the character, we still want one tab\r\n\tif (!tabs.size) getTab(undefined);\r\n\r\n\tequipped.others = equipped.others.filter(Boolean);\r\n\r\n\tconst activeTabId = getInMemory(sheet, \"inventory.activeTab\");\r\n\r\n\treturn {\r\n\t\ttabs: Array.from(tabs.values()),\r\n\t\tequipped,\r\n\t\tactor,\r\n\t\tselectedTab: tabs.get(activeTabId)?.id,\r\n\t\tcontainerBulk: (container) => {\r\n\t\t\tconst capacity = container.capacity;\r\n\t\t\treturn `${capacity.value.toString()} / ${capacity.max.toString()}`;\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction addEvents(tab, sheet, actor, inner) {\r\n\tconst containerTabs = tab.find(\"[data-tab-id]\");\r\n\tfor (const container of tab.find(\"[data-container-id]\")) {\r\n\t\tcontainer.addEventListener(\"click\", (event) => {\r\n\t\t\tconst tabId = container.dataset.containerId;\r\n\r\n\t\t\tcontainerTabs.removeClass(\"active\");\r\n\t\t\tcontainerTabs.filter(`[data-tab-id=${tabId}]`).addClass(\"active\");\r\n\r\n\t\t\tsetInMemory(sheet, \"inventory.activeTab\", tabId);\r\n\t\t});\r\n\t}\r\n\r\n\tconst sidebar = inner.find(\"#pf2e-toobelt-inventory-item-details\")[0];\r\n\tconst itemElements = tab.find(\"[data-item-id], [data-container-id]\");\r\n\tfor (const itemElement of itemElements) {\r\n\t\titemElement.addEventListener(\"mouseenter\", (event) =>\r\n\t\t\tonItemDetails(event, actor, itemElement, sidebar),\r\n\t\t);\r\n\t\titemElement.addEventListener(\"mouseleave\", (event) => {\r\n\t\t\tsidebar.classList.add(\"hidden\");\r\n\t\t});\r\n\t}\r\n\r\n\tif (!actor.isOwner) return;\r\n\r\n\tdragIdentifier = randomID();\r\n\r\n\tmakeDraggable({\r\n\t\telement: tab[0],\r\n\t\tselector: \"[data-item-id]\",\r\n\t\tfilter: \"input\",\r\n\t\tdraggedClass: \"dragged\",\r\n\t\tghostClass: \"ghost\",\r\n\t\tidentifier: dragIdentifier,\r\n\t\tcursorImage: {\r\n\t\t\tid: \"pf2e-toolbelt-inventory-cursor-image\",\r\n\t\t\timg: (target) => target.dataset.itemImg,\r\n\t\t},\r\n\t\tcreateGhost: createGhost,\r\n\t\tonDragStart: () => onDragStart(sidebar),\r\n\t\tonDragEnd: (event, draggable, options) => onDragEnd(sheet, options),\r\n\t\tdroppables: [\r\n\t\t\tcontainersDroppable(tab, sheet),\r\n\t\t\totherEquipmentDroppable(tab, sheet),\r\n\t\t\tlargeEquipmentDroppable(tab, sheet),\r\n\t\t\titemsListDroppable(tab, sheet),\r\n\t\t\titemsGridDroppable(tab, sheet),\r\n\t\t],\r\n\t});\r\n}\r\n\r\nasync function onItemDetails(event, actor, itemElement, sidebar) {\r\n\tif (dragging) return;\r\n\r\n\tlet details = itemElement.dataset.details;\r\n\r\n\tif (!details) {\r\n\t\tconst item = getItemFromElement(actor, itemElement);\r\n\t\tif (!item) return;\r\n\r\n\t\tdetails = await renderTemplate(templatePath(\"inventory/details\"), { item });\r\n\t\titemElement.dataset.details = details;\r\n\t}\r\n\r\n\tsidebar.innerHTML = details;\r\n\tsidebar.classList.remove(\"hidden\");\r\n}\r\n\r\nfunction onDragStart(sidebar) {\r\n\tdragging = true;\r\n\tsidebar.classList.add(\"hidden\");\r\n}\r\n\r\n/**\r\n * @param {*} sheet\r\n * @param {Parameters<DraggableDragEndFunction>[2]} options\r\n */\r\nfunction onDragEnd(sheet, { dropped, canceled }) {\r\n\tdragging = false;\r\n\tif (canceled || !dropped) return;\r\n\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n}\r\n\r\n/** @type {DraggableGhostFunction} */\r\nfunction createGhost(dragged, draggedIndex) {\r\n\treturn dragged.parentElement.dataset.area === \"items-grid\"\r\n\t\t? { element: dragged, index: draggedIndex }\r\n\t\t: undefined;\r\n}\r\n\r\n/** @param {DraggableObj} */\r\nfunction checkIdentifier(draggable) {\r\n\tif (draggable.identifier === dragIdentifier) return true;\r\n\terror(\"inventory.identifier.error\");\r\n\treturn false;\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsGridDroppable(html, sheet) {\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tif (\r\n\t\t\tdroppable.element === draggable.element ||\r\n\t\t\tdroppable.element === draggable.ghost\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst ghost = draggable.ghost;\r\n\t\tconst index = getElementIndex(droppable.element);\r\n\t\tconst target =\r\n\t\t\tghost.index >= index\r\n\t\t\t\t? droppable.element\r\n\t\t\t\t: droppable.element.nextElementSibling;\r\n\r\n\t\tdroppable.element.parentElement.insertBefore(ghost.element, target);\r\n\t\tghost.index = index;\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tconst parentGrid = droppable.element.parentElement;\r\n\t\tif (!parentGrid) return;\r\n\r\n\t\tconst isItem = closestInside(droppable.triggeringElement, parentGrid, {\r\n\t\t\tselector: \"[data-item-id]\",\r\n\t\t});\r\n\t\tif (isItem) return;\r\n\r\n\t\tconst parentList = parentGrid.parentElement;\r\n\t\tif (!parentList.contains(droppable.triggeringElement)) return;\r\n\r\n\t\tparentGrid.appendChild(draggable.ghost.element);\r\n\t\tdraggable.ghost.index = Infinity;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-grid'] [data-item-id]\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsListDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst isItem = closestInside(\r\n\t\t\tdroppable.triggeringElement,\r\n\t\t\tdroppable.element,\r\n\t\t\t{\r\n\t\t\t\tselector: \"[data-item-id]\",\r\n\t\t\t},\r\n\t\t);\r\n\t\tif (isItem) return;\r\n\r\n\t\tdroppable.element\r\n\t\t\t.querySelector(\"[data-area='items-grid']\")\r\n\t\t\t.appendChild(draggable.ghost.element);\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tdraggable.ghost.reset();\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return false;\r\n\r\n\t\tconst updates = [];\r\n\r\n\t\tif (draggable.element === draggable.ghost.element) {\r\n\t\t\tdraggable.ghost.classList.purge();\r\n\t\t\tcleanContainerItem(draggable.element);\r\n\t\t} else {\r\n\t\t\tmoveItemToContainer({\r\n\t\t\t\thtml,\r\n\t\t\t\tupdates,\r\n\t\t\t\titem,\r\n\t\t\t\t...draggable,\r\n\t\t\t\ttarget: draggable.ghost.element,\r\n\t\t\t});\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t\tdraggable.ghost.reset();\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-list']\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction largeEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\tconst rightHand = html.find(\"[data-equipped-slot=right-hand]\")[0];\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst slot = droppable.element.dataset.equippedSlot;\r\n\r\n\t\tif (\r\n\t\t\tslot === draggable.parent.dataset.equippedSlot ||\r\n\t\t\tdroppable.element.querySelector(\"[data-two-hands]\")\r\n\t\t) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canDrop = slot === \"armor\" ? item.isOfType(\"armor\") : true;\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tslot,\r\n\t\t\tcanDrop,\r\n\t\t};\r\n\t}\r\n\r\n\tfunction moveItemToSlot({\r\n\t\tupdates,\r\n\t\titem,\r\n\t\telement,\r\n\t\tdrop,\r\n\t\tnoTwoHand = false,\r\n\t\tnoUpdate = false,\r\n\t}) {\r\n\t\tconst dropSlot = drop instanceof HTMLElement ? drop : drop.element;\r\n\t\tconst slot = dropSlot.dataset.equippedSlot;\r\n\t\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\t\tconst isOneHand = isOneHanded(item);\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\t\tconst canInvest = canBeInvested(item);\r\n\r\n\t\tdropSlot.appendChild(movable);\r\n\r\n\t\tconst move = (carryType, handsHeld, inSlot, invested) => {\r\n\t\t\tif (!noUpdate) {\r\n\t\t\t\tupdates.push(\r\n\t\t\t\t\titemCarryUpdate(item, {\r\n\t\t\t\t\t\tcarryType,\r\n\t\t\t\t\t\thandsHeld,\r\n\t\t\t\t\t\tinSlot,\r\n\t\t\t\t\t\tinvested,\r\n\t\t\t\t\t\tcontainerId: null,\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tmovable.classList.toggle(\"invested\", canInvest && invested);\r\n\t\t};\r\n\r\n\t\tif (slot === \"armor\") {\r\n\t\t\tmove(\"worn\", 0, true, true);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (slot === \"right-hand\") {\r\n\t\t\tmove(\"held\", 1, false, isOneHand);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tmove(\r\n\t\t\t\"held\",\r\n\t\t\tisTwoHand && !noTwoHand ? 2 : 1,\r\n\t\t\tfalse,\r\n\t\t\tisHeld(item) && (!isTwoHand || !noTwoHand),\r\n\t\t);\r\n\t}\r\n\r\n\t/** @param {HTMLElement | {element: HTMLElement}} */\r\n\tfunction getSlottedItem(slot) {\r\n\t\tconst slotElement = slot instanceof HTMLElement ? slot : slot.element;\r\n\t\tconst element = slotElement.querySelector(\"[data-item-id]\");\r\n\t\tconst item = getItemFromElement(actor, element);\r\n\t\treturn { element, item };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\r\n\t\tif (canDrop !== undefined) {\r\n\t\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t\t}\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { item, canDrop, slot } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = [];\r\n\t\tconst slotted = getSlottedItem(droppable);\r\n\t\tconst dragArea = draggable.parent.dataset.area;\r\n\t\tconst dragSlot = draggable.parent.dataset.equippedSlot;\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\r\n\t\tlet noUpdate = false;\r\n\r\n\t\tif (dragArea === \"equipped\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({ html, updates, ...slotted });\r\n\t\t\t}\r\n\t\t} else if (dragArea === \"items-grid\") {\r\n\t\t\tif (slot === \"left-hand\" && isTwoHand) {\r\n\t\t\t\tconst otherSlotted = getSlottedItem(rightHand);\r\n\t\t\t\tif (otherSlotted.item) {\r\n\t\t\t\t\tmoveItemToContainer({ html, updates, ...otherSlotted });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\ttarget: draggable.element,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (dragSlot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tif (slotted.item.isOfType(\"armor\")) {\r\n\t\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\t\thtml,\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (slot === \"right-hand\") {\r\n\t\t\tnoUpdate = true;\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t\tnoTwoHand: true,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slotted.item) {\r\n\t\t\tif (isTwoHand) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t});\r\n\t\t\t\tnoUpdate = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tmoveItemToSlot({\r\n\t\t\tupdates,\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\tdrop: droppable,\r\n\t\t\tnoUpdate,\r\n\t\t});\r\n\r\n\t\tif (slot === \"left-hand\" || dragSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped] .main-items\")[0],\r\n\t\tselector: \"[data-equipped-slot]\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @return {DroppableObj} */\r\nfunction otherEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tif (draggable.parent === droppable.element) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (\r\n\t\t\t!item.isIdentified ||\r\n\t\t\t!(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item))\r\n\t\t) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canInvest = canBeInvested(item);\r\n\t\tconst canEquip = hasWornSlot(item);\r\n\t\tif (!canInvest && !canEquip) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\treturn { canDrop: true, item, canInvest };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop, canInvest } = getData(draggable, droppable);\r\n\t\tif (canDrop === undefined) return;\r\n\r\n\t\tdroppable.classList.add(\"show\");\r\n\t\tdroppable.classList.toggle(\"add-forbidden\", !canDrop);\r\n\t\tdroppable.classList.toggle(\"add-invest\", canDrop && canInvest);\r\n\t\tdroppable.classList.toggle(\"add-equip\", canDrop && !canInvest);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, canInvest, item } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tdroppable.element.appendChild(draggable.element);\r\n\t\tdraggable.element.classList.toggle(\"invested\", canInvest);\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", [\r\n\t\t\titemCarryUpdate(item, {\r\n\t\t\t\tcontainerId: null,\r\n\t\t\t\tinSlot: true,\r\n\t\t\t\tinvested: true,\r\n\t\t\t}),\r\n\t\t]);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped]\")[0],\r\n\t\tfilter: \".main-items\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction containersDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return { canDrop: false };\r\n\r\n\t\tconst containerId = droppable.element.dataset.containerId;\r\n\r\n\t\tif (containerId === \"undefined\") return { item, canDrop: true };\r\n\r\n\t\tconst container = actor.items.get(containerId);\r\n\t\tif (!container) return { canDrop: false };\r\n\r\n\t\tconst capacity = container.capacity;\r\n\t\tconst remaining = capacity.max.minus(capacity.value);\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tcontainer,\r\n\t\t\tcanDrop: remaining.value >= item.bulk.value,\r\n\t\t};\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, item, container } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = moveItemToContainer({\r\n\t\t\thtml,\r\n\t\t\tupdates: [],\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\ttarget: container,\r\n\t\t});\r\n\r\n\t\tif (draggable.parent.dataset.equippedSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-container-id]\",\r\n\t\tfilter: \".back\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\nfunction cleanContainerItem(item) {\r\n\titem.classList.remove(\"invested\");\r\n\titem.querySelector(\".vignette.hands\")?.remove();\r\n}\r\n\r\nfunction moveItemToContainer({ html, updates, item, element, target }) {\r\n\tconst targetIsElement = target instanceof HTMLElement;\r\n\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\r\n\tlet containerId = targetIsElement\r\n\t\t? target.closest(\"[data-tab-id]\").dataset.tabId\r\n\t\t: target instanceof Item\r\n\t\t  ? target.id\r\n\t\t  : target;\r\n\r\n\tcleanContainerItem(movable);\r\n\r\n\tif (targetIsElement) {\r\n\t\ttarget.before(movable);\r\n\t} else {\r\n\t\thtml\r\n\t\t\t.find(`.container-tab[data-tab-id=${containerId}] [data-area=items-grid]`)\r\n\t\t\t.append(movable);\r\n\t}\r\n\r\n\tcontainerId = [undefined, \"undefined\"].includes(containerId)\r\n\t\t? null\r\n\t\t: containerId;\r\n\r\n\tupdates.push(\r\n\t\titemCarryUpdate(item, {\r\n\t\t\tcontainerId: containerId,\r\n\t\t\tinSlot: false,\r\n\t\t\tinvested: false,\r\n\t\t\tcarryType: containerId ? \"stowed\" : \"worn\",\r\n\t\t\thandsHeld: 0,\r\n\t\t}),\r\n\t);\r\n\r\n\treturn updates;\r\n}\r\n\r\nfunction checkForTwoHandedSlots(html, actor) {\r\n\t/** @type {HTMLElement} */\r\n\tconst equipped = html.find(\"[data-area='equipped'] .main-items\")[0];\r\n\tconst leftHand = equipped.querySelector(\"[data-equipped-slot='left-hand']\");\r\n\tconst rightHand = equipped.querySelector(\"[data-equipped-slot='right-hand']\");\r\n\tconst leftSlotted = leftHand.querySelector(\"[data-item-id]\");\r\n\tconst rightSlotted = rightHand.querySelector(\".item:not(.fake)\");\r\n\tconst item = getItemFromElement(actor, leftSlotted);\r\n\tconst isTwoHand = !!item && isTwoHanded(item);\r\n\r\n\tif (!isTwoHand && rightSlotted?.dataset.twoHands) {\r\n\t\trightSlotted.remove();\r\n\t} else if (isTwoHand && !rightSlotted) {\r\n\t\t/** @type {HTMLElement} */\r\n\t\tconst clone = leftSlotted.cloneNode(true);\r\n\t\tclone.dataset.twoHands = \"true\";\r\n\t\trightHand.appendChild(clone);\r\n\t}\r\n}\r\n\r\n/** @param {HTMLElement | {element: HTMLElement}} */\r\nfunction getItemFromElement(actor, element) {\r\n\tif (!element) return;\r\n\r\n\tconst el = element instanceof HTMLElement ? element : element.element;\r\n\tconst { itemId, containerId } = el.dataset;\r\n\tconst id = itemId ?? containerId;\r\n\r\n\tif (id) return actor.items.get(id);\r\n}\r\n", "import { getFlag, setFlag } from \"../../shared/flags\";\r\nimport { subLocalize } from \"../../shared/localize\";\r\nimport { templatePath } from \"../../shared/path\";\r\n\r\nconst localize = subLocalize(\"knowledges.editLore\");\r\n\r\nexport class EditLores extends FormApplication {\r\n\tget actor() {\r\n\t\treturn this.object;\r\n\t}\r\n\r\n\tget id() {\r\n\t\treturn `npc-edit-lores-${this.actor.id}`;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.actor);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"knowledges/lores\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\tconst actor = this.actor;\r\n\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\tunspecified: getFlag(actor, \"knowledges.unspecified\") ?? \"\",\r\n\t\t\tspecific: getFlag(actor, \"knowledges.specific\") ?? \"\",\r\n\t\t\ti18n: localize,\r\n\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(event, { unspecified, specific }) {\r\n\t\tconst actor = this.object;\r\n\t\tsetFlag(actor, \"knowledges.unspecified\", unspecified.trim());\r\n\t\tsetFlag(actor, \"knowledges.specific\", specific.trim());\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"button.cancel\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "import { EditLores } from \"../apps/knowledges/lores\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { getFlag } from \"../shared/flags\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\"renderNPCSheetPF2e\", renderNPCSheetPF2e);\r\n\r\nexport function registerKnowledges() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"knowledges\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: (value) => setHook(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-npc-knowledges\"],\r\n\t\tready: (isGM) => {\r\n\t\t\tif (isGM && getSetting(\"knowledges\")) setHook(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction renderNPCSheetPF2e(sheet, $html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\treplaceLores(actor, $html);\r\n\taddEditButton($html);\r\n\taddEvents(actor, $html);\r\n}\r\n\r\nfunction knowledgeSelector(html, section, selector) {\r\n\treturn html.find(\r\n\t\t`[data-tab=\"main\"] .recall-knowledge ${\r\n\t\t\tsection === \"header\" ? \".section-header\" : \".section-body\"\r\n\t\t} ${selector}`,\r\n\t);\r\n}\r\n\r\nfunction editLores(actor) {\r\n\tnew EditLores(actor).render(true);\r\n}\r\n\r\nfunction replaceLores(actor, html) {\r\n\tconst unspecifics = getFlag(actor, \"knowledges.unspecified\");\r\n\tconst specifics = getFlag(actor, \"knowledges.specific\");\r\n\tif (!unspecifics && !specifics) return;\r\n\r\n\tconst lores = actor.identificationDCs.lore;\r\n\tconst body = knowledgeSelector(html, \"body\", \"\");\r\n\tbody.find(\".identification-skills\").last().remove();\r\n\r\n\tfunction tag(skills, dc, adjustment) {\r\n\t\tconst content = game.i18n.format(\r\n\t\t\t\"PF2E.Actor.NPC.Identification.Skills.Label\",\r\n\t\t\t{ skills, dc, adjustment },\r\n\t\t);\r\n\t\treturn `<div class=\"tag-legacy identification-skills tooltipstered\">${content}</div>`;\r\n\t}\r\n\r\n\tfunction addTags(lores, { dc, start }) {\r\n\t\tconst tags = lores\r\n\t\t\t.split(\",\")\r\n\t\t\t.filter((lore) => lore.trim())\r\n\t\t\t.map((lore) => tag(lore, dc, start))\r\n\t\t\t.join(\"\");\r\n\t\tbody.append(tags);\r\n\t}\r\n\r\n\taddTags(unspecifics || \"Unspecific\", lores[0]);\r\n\taddTags(specifics || \"Specific\", lores[1]);\r\n}\r\n\r\nfunction addEvents(actor, html) {\r\n\tconst edit = knowledgeSelector(html, \"header\", \"button.edit\");\r\n\tedit.on(\"click\", () => editLores(actor));\r\n}\r\n\r\nfunction addEditButton(html) {\r\n\tconst attempts = knowledgeSelector(html, \"header\", \"button\");\r\n\tconst edit = '<button type=\"button\" class=\"breakdown edit\">Edit</button>';\r\n\tattempts.before(edit);\r\n}\r\n", "import { bindOnPreCreateSpellDamageChatMessage } from \"../../shared/chat\";\r\nimport { subLocalize } from \"../../shared/localize\";\r\nimport { templatePath } from \"../../shared/path\";\r\n\r\nconst localize = subLocalize(\"merge.multi\");\r\n\r\nexport class MultiCast extends Application {\r\n\t#message;\r\n\t#event;\r\n\r\n\tconstructor(event, message, options) {\r\n\t\tsuper(options);\r\n\t\tthis.#event = event;\r\n\t\tthis.#message = message;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.spell);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"merge/multi\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\ti18n: localize,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"[data-action=cast]\").on(\"click\", this.#onCast.bind(this));\r\n\t\thtml.find(\"[data-action=cancel]\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\tasync #onCast(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst nb = this.element.find(\"[name=multi]\").val();\r\n\t\tif (nb < 1) {\r\n\t\t\tlocalize.error(\"zero\");\r\n\t\t\tthis.close();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst message = this.#message;\r\n\t\tif (!message) return;\r\n\r\n\t\tconst spell = message.item;\r\n\t\tconst actor = message.actor;\r\n\t\tif (!actor || !spell) return;\r\n\r\n\t\tconst updateSource = (damages, heightening) => {\r\n\t\t\tfor (const [id, damage] of Object.entries(damages)) {\r\n\t\t\t\tfor (let i = 0; i < nb - 1; i++) {\r\n\t\t\t\t\tconst newId = randomID();\r\n\r\n\t\t\t\t\tdamages[newId] = damage;\r\n\r\n\t\t\t\t\tif (heightening.type === \"interval\") {\r\n\t\t\t\t\t\tconst damage = heightening.damage[id];\r\n\t\t\t\t\t\tif (damage) heightening.damage[newId] = damage;\r\n\t\t\t\t\t} else if (heightening.type === \"fixed\") {\r\n\t\t\t\t\t\tfor (const data of Object.values(heightening.levels)) {\r\n\t\t\t\t\t\t\tconst damage = data.damage[id];\r\n\t\t\t\t\t\t\tif (!damage) continue;\r\n\t\t\t\t\t\t\tdata.damage[newId] = damage;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tconst embeddedSource = deepClone(message.flags.pf2e.casting?.embeddedSpell);\r\n\r\n\t\tif (embeddedSource) {\r\n\t\t\tconst damages = embeddedSource.system.damage;\r\n\r\n\t\t\tembeddedSource.system.heightening ??= {};\r\n\t\t\tconst heightening = embeddedSource.system.heightening;\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = new Item.implementation(embeddedSource, {\r\n\t\t\t\tparent: actor,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.trickMagicEntry = spell.trickMagicEntry;\r\n\r\n\t\t\tconst overlayIds = message.getFlag(\"pf2e\", \"origin.variant.overlays\");\r\n\t\t\tconst castRank = message.getFlag(\"pf2e\", \"origin.castRank\") ?? spell.rank;\r\n\t\t\tconst modifiedSpell = newSpell.loadVariant({ overlayIds, castRank });\r\n\t\t\tconst castSpell = modifiedSpell ?? newSpell;\r\n\r\n\t\t\tcastSpell.rollDamage(this.#event);\r\n\t\t} else {\r\n\t\t\tconst spellSource = spell.toObject();\r\n\t\t\tconst damages = spellSource.system.damage;\r\n\t\t\tconst heightening = spellSource.system.heightening ?? {};\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = spell.clone({\r\n\t\t\t\t\"system.damage\": damages,\r\n\t\t\t\t\"system.heightening\": heightening,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.rollDamage(this.#event);\r\n\t\t}\r\n\r\n\t\tif (spell.damageKinds.size) {\r\n\t\t\tbindOnPreCreateSpellDamageChatMessage(message);\r\n\t\t}\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "export function getDamageRollClass() {\r\n\treturn CONFIG.Dice.rolls.find((Roll) => Roll.name === \"DamageRoll\");\r\n}\r\n", "import { MultiCast } from \"../apps/merge/multi\";\r\nimport { MODULE_ID } from \"../module\";\r\nimport { getChatMessageClass, latestChatMessages } from \"../shared/chat\";\r\nimport { getFlag } from \"../shared/flags\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { localize } from \"../shared/localize\";\r\nimport { compareArrays } from \"../shared/misc\";\r\nimport { warn } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getDamageRollClass } from \"../shared/pf2e/classes\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderChatMessage\",\r\n\trenderChatMessage,\r\n\tupdateMessages,\r\n);\r\n\r\nexport function registerMerge() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"merge-damage\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"multi-cast\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"multi-cast\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"merge-damage\"),\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: (isGm) => {\r\n\t\t\tsetHook(false, [\"multi-cast\", \"merge-damage\"], true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction updateMessages() {\r\n\tfor (const { message, html } of latestChatMessages(10)) {\r\n\t\thtml.find(\"[data-action=multi-cast]\").remove();\r\n\t\thtml.find(\"[data-action=merge-damage]\").remove();\r\n\t\trenderChatMessage(message, html);\r\n\t}\r\n}\r\n\r\nfunction renderChatMessage(message, html) {\r\n\tif (!game.user.isGM && !message.isAuthor) return;\r\n\r\n\tif (getSetting(\"merge-damage\") && isDamageRoll(message))\r\n\t\trenderDamage(message, html);\r\n\telse if (\r\n\t\tgetSetting(\"multi-cast\") &&\r\n\t\tmessage.getFlag(\"pf2e\", \"origin.type\") === \"spell\"\r\n\t)\r\n\t\trenderSpell(message, html);\r\n}\r\n\r\nfunction renderSpell(message, html) {\r\n\tconst item = message.item;\r\n\tif (!item) return;\r\n\r\n\tconst spellBtn = html.find(\r\n\t\t\".message-content .chat-card .owner-buttons .spell-button\",\r\n\t);\r\n\r\n\tspellBtn\r\n\t\t.find(\"[data-action=spell-damage]\")\r\n\t\t.after(\r\n\t\t\t`<button data-action=\"multi-cast\">${localize(\r\n\t\t\t\t\"merge.spell.button\",\r\n\t\t\t)}</button>`,\r\n\t\t);\r\n\r\n\tspellBtn.find(\"[data-action=multi-cast]\").on(\"click\", (event) => {\r\n\t\tnew MultiCast(event, message).render(true);\r\n\t});\r\n}\r\n\r\nfunction renderDamage(message, html) {\r\n\tlet buttons = '<span class=\"pf2e-toolbelt-merge\">';\r\n\r\n\tif (getFlag(message, \"merge.merged\")) {\r\n\t\tconst tooltip = localize(\"merge.damage.split-tooltip\");\r\n\t\tbuttons += `<button data-action=\"split-damage\" title=\"${tooltip}\">`;\r\n\t\tbuttons += '<i class=\"fa-duotone fa-split\"></i>';\r\n\t}\r\n\r\n\tconst tooltip = localize(\"merge.damage.tooltip\");\r\n\tbuttons += `<button data-action=\"merge-damage\" title=\"${tooltip}\">`;\r\n\tbuttons += '<i class=\"fa-duotone fa-merge\"></i></button>';\r\n\r\n\tbuttons += \"</span>\";\r\n\r\n\tconst actorUUID = getActorUUID(message);\r\n\tconst targetUUIDs = getTargetUUIDs(message);\r\n\r\n\thtml.find(\".dice-result .dice-total\").append(buttons);\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=merge-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tfor (const { message: otherMessage } of latestChatMessages(5, message)) {\r\n\t\t\t\tconst otherTargetsUUIDS = getTargetUUIDs(otherMessage);\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\t!isDamageRoll(otherMessage) ||\r\n\t\t\t\t\tgetActorUUID(otherMessage) !== actorUUID ||\r\n\t\t\t\t\t!compareArrays(\r\n\t\t\t\t\t\ttargetUUIDs?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t\totherTargetsUUIDS?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\tmergeDamages(event, message, otherMessage, { actorUUID, targetUUIDs });\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\twarn(\"merge.damage.none\");\r\n\t\t});\r\n\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=split-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\t\t\tsplitDamages(event, message);\r\n\t\t});\r\n}\r\n\r\nasync function splitDamages(event, message) {\r\n\tconst sources = getFlag(message, \"merge.data\").flatMap((data) => data.source);\r\n\tawait removeChatMessages(message.id);\r\n\tawait getChatMessageClass().createDocuments(sources);\r\n}\r\n\r\nasync function mergeDamages(event, origin, other, { actorUUID, targetUUIDs }) {\r\n\tconst dataGroups = {};\r\n\r\n\tconst data = getMessageData(other).concat(getMessageData(origin));\r\n\tfor (const { name, notes, outcome, modifiers, tags } of data) {\r\n\t\tdataGroups[name] ??= {\r\n\t\t\tname,\r\n\t\t\ttags,\r\n\t\t\tnotes: new Set(),\r\n\t\t\tresults: [],\r\n\t\t};\r\n\r\n\t\tfor (const note of notes) {\r\n\t\t\tdataGroups[name].notes.add(note);\r\n\t\t}\r\n\r\n\t\tconst exists = dataGroups[name].results.some(\r\n\t\t\t(result) =>\r\n\t\t\t\tresult.outcome === outcome &&\r\n\t\t\t\tcompareArrays(result.modifiers, modifiers),\r\n\t\t);\r\n\r\n\t\tif (!exists) dataGroups[name].results.push({ outcome, modifiers });\r\n\t}\r\n\r\n\tconst groups = Object.values(dataGroups).map((group) => {\r\n\t\tgroup.label = group.name;\r\n\r\n\t\tfor (const result of group.results) {\r\n\t\t\tif (!result.outcome) continue;\r\n\t\t\tresult.label = game.i18n.localize(\r\n\t\t\t\t`PF2E.Check.Result.Degree.Attack.${result.outcome}`,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn group;\r\n\t});\r\n\r\n\tgroups.at(-1).isLastGroup = true;\r\n\r\n\tconst flavor = await renderTemplate(templatePath(\"merge/merged\"), {\r\n\t\tgroups,\r\n\t\thasMultipleGroups: groups.length > 1,\r\n\t});\r\n\r\n\tconst originRolls = getMessageRolls(origin);\r\n\tconst otherRolls = getMessageRolls(other);\r\n\tconst groupedRolls = [];\r\n\r\n\tfor (const roll of [].concat(otherRolls, originRolls)) {\r\n\t\tconst { options, total, terms } = roll;\r\n\t\tconst term = terms[0];\r\n\t\tconst formula = roll.formula\r\n\t\t\t.replaceAll(/(\\[[\\w,-]+\\])/g, \"\")\r\n\t\t\t.replace(/^\\(/, \"\")\r\n\t\t\t.replace(/\\)$/, \"\");\r\n\t\tconst group = groupedRolls.find(\r\n\t\t\t({ options: { flavor, critRule } }) =>\r\n\t\t\t\tflavor === options.flavor && critRule === options.critRule,\r\n\t\t);\r\n\r\n\t\tif (group) {\r\n\t\t\tgroup.terms.push(term);\r\n\t\t\tgroup.total += total;\r\n\t\t\tgroup.formulas.push(formula);\r\n\t\t} else {\r\n\t\t\tgroupedRolls.push({\r\n\t\t\t\toptions,\r\n\t\t\t\tformulas: [formula],\r\n\t\t\t\ttotal,\r\n\t\t\t\tterms: [term],\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tconst DamageRoll = getDamageRollClass();\r\n\tfor (const group of groupedRolls) {\r\n\t\tif (group.options.flavor.includes(\"persistent\")) {\r\n\t\t\tconst { index } = group.formulas.reduce(\r\n\t\t\t\t(prev, curr, index) => {\r\n\t\t\t\t\tconst value = new DamageRoll(curr).expectedValue;\r\n\t\t\t\t\tif (value <= prev.value) return prev;\r\n\t\t\t\t\treturn { value, index };\r\n\t\t\t\t},\r\n\t\t\t\t{ value: 0, index: -1 },\r\n\t\t\t);\r\n\r\n\t\t\tgroup.formulas = [group.formulas[index]];\r\n\t\t\tgroup.terms = [group.terms[index]];\r\n\t\t}\r\n\r\n\t\tgroup.formula = `(${group.formulas.join(\" + \")})[${group.options.flavor}]`;\r\n\t\tgroup.term =\r\n\t\t\tgroup.terms.length < 2 ? group.terms[0] : createTermGroup(group.terms);\r\n\t}\r\n\r\n\tconst roll = {\r\n\t\tclass: \"DamageRoll\",\r\n\t\toptions: {},\r\n\t\tdice: [],\r\n\t\tformula: `{${groupedRolls.map(({ formula }) => formula).join(\", \")}}`,\r\n\t\ttotal: groupedRolls.reduce((acc, { total }) => acc + total, 0),\r\n\t\tevaluated: true,\r\n\t\tterms: [\r\n\t\t\t{\r\n\t\t\t\tclass: \"InstancePool\",\r\n\t\t\t\toptions: {},\r\n\t\t\t\tevaluated: true,\r\n\t\t\t\tterms: groupedRolls.map(({ formula }) => formula),\r\n\t\t\t\tmodifiers: [],\r\n\t\t\t\trolls: groupedRolls.map(({ options, formula, total, term }) => ({\r\n\t\t\t\t\tclass: \"DamageInstance\",\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tdice: [],\r\n\t\t\t\t\tformula,\r\n\t\t\t\t\ttotal,\r\n\t\t\t\t\tterms: [term],\r\n\t\t\t\t\tevaluated: true,\r\n\t\t\t\t})),\r\n\t\t\t\tresults: groupedRolls.map(({ total }) => ({\r\n\t\t\t\t\tresult: total,\r\n\t\t\t\t\tactive: true,\r\n\t\t\t\t})),\r\n\t\t\t},\r\n\t\t],\r\n\t};\r\n\r\n\tif (game.modules.get(\"dice-so-nice\")?.active) {\r\n\t\tconst setHidden = (term) => {\r\n\t\t\tif (\"results\" in term) {\r\n\t\t\t\tfor (const result of term.results) {\r\n\t\t\t\t\tresult.hidden = true;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconst operands = (term.term ?? term).operands ?? [];\r\n\t\t\t\tfor (const operand of operands) {\r\n\t\t\t\t\tsetHidden(operand);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tfor (const r of roll.terms[0].rolls) {\r\n\t\t\tfor (const term of r.terms) {\r\n\t\t\t\tsetHidden(term);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tawait removeChatMessages(origin.id, other.id);\r\n\r\n\tawait getChatMessageClass().create({\r\n\t\tflavor,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.ROLL,\r\n\t\tspeaker: origin.speaker,\r\n\t\tflags: {\r\n\t\t\t[MODULE_ID]: {\r\n\t\t\t\tmerge: {\r\n\t\t\t\t\tactor: actorUUID,\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t\tmerged: true,\r\n\t\t\t\t\ttype: \"damage-roll\",\r\n\t\t\t\t\tdata,\r\n\t\t\t\t},\r\n\t\t\t\ttarget: {\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tpf2e: {\r\n\t\t\t\tcontext: {\r\n\t\t\t\t\toptions: Array.from(\r\n\t\t\t\t\t\tnew Set(data.flatMap((entry) => entry.itemTraits)),\r\n\t\t\t\t\t),\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t},\r\n\t\trolls: [roll],\r\n\t});\r\n}\r\n\r\nfunction getMessageData(message) {\r\n\tconst flags = getFlag(message, \"merge.data\");\r\n\tif (flags) return flags;\r\n\r\n\tconst source = message.toObject();\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source._id;\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source.timestamp;\r\n\r\n\tconst html = $(`<div>${message.flavor}</div>`);\r\n\tconst tags = html.find(\"h4.action + .tags\").prop(\"outerHTML\");\r\n\r\n\tconst modifiers = [];\r\n\thtml.find(\".tag.tag_transparent\").each(function () {\r\n\t\tmodifiers.push(this.innerHTML);\r\n\t});\r\n\r\n\tconst notes = source.flags.pf2e.context.notes.map(\r\n\t\t({ title, text }) =>\r\n\t\t\t`<strong>${game.i18n.localize(title)}</strong> ${game.i18n.localize(\r\n\t\t\t\ttext,\r\n\t\t\t)}`,\r\n\t);\r\n\r\n\treturn [\r\n\t\t{\r\n\t\t\tsource,\r\n\t\t\tname: source.flags.pf2e.strike?.name ?? message.item.name,\r\n\t\t\toutcome: source.flags.pf2e.context.outcome,\r\n\t\t\titemTraits: source.flags.pf2e.context.options.filter((option) =>\r\n\t\t\t\t/^(item|self):/.test(option),\r\n\t\t\t),\r\n\t\t\tmodifiers,\r\n\t\t\ttags,\r\n\t\t\tnotes,\r\n\t\t},\r\n\t];\r\n}\r\n\r\nfunction removeChatMessages(...ids) {\r\n\tconst joinedIds = ids.map((id) => `[data-message-id=${id}]`).join(\", \");\r\n\tui.chat.element.find(joinedIds).remove();\r\n\treturn ChatMessage.deleteDocuments(ids);\r\n}\r\n\r\nfunction createTermGroup(terms) {\r\n\tconst options = deepClone(terms[0].options);\r\n\r\n\tfor (const term of terms) {\r\n\t\tterm.options = {};\r\n\t}\r\n\r\n\treturn {\r\n\t\tclass: \"Grouping\",\r\n\t\toptions,\r\n\t\tevaluated: true,\r\n\t\tterm: {\r\n\t\t\tclass: \"ArithmeticExpression\",\r\n\t\t\toptions: {},\r\n\t\t\tevaluated: true,\r\n\t\t\toperator: \"+\",\r\n\t\t\toperands: [\r\n\t\t\t\tterms.shift(),\r\n\t\t\t\tterms.length > 1 ? createTermGroup(terms) : terms[0],\r\n\t\t\t],\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction getMessageRolls(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.rolls\") ??\r\n\t\tJSON.parse(message._source.rolls[0]).terms[0].rolls\r\n\t);\r\n}\r\n\r\nfunction getActorUUID(message) {\r\n\treturn getFlag(message, \"merge.actor\") ?? message.actor?.uuid;\r\n}\r\n\r\nfunction getTargetUUIDs(message) {\r\n\tconst targetTargets = getFlag(message, \"target.targets\");\r\n\tif (targetTargets) return targetTargets;\r\n\r\n\tconst mergeTargets =\r\n\t\tgetFlag(message, \"merge.targets\") ?? message.getFlag(\"pf2e\", \"target\");\r\n\tif (Array.isArray(mergeTargets)) return mergeTargets;\r\n\treturn mergeTargets ? [mergeTargets] : [];\r\n}\r\n\r\nfunction isDamageRoll(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.type\") === \"damage-roll\" ||\r\n\t\tmessage.getFlag(\"pf2e\", \"context.type\") === \"damage-roll\"\r\n\t);\r\n}\r\n", "import { registerWrapper, wrapperError } from \"../shared/libwrapper\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst ACTOR_PREPARE_EMBEDDED_DOCUMENTS =\r\n\t\"CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments\";\r\nconst TREASURE_PREPARE_BASE_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData\";\r\n\r\nexport function registerNobulk() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"nobulk\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"nobulk-coins\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tif (getSetting(\"nobulk\"))\r\n\t\t\t\tregisterWrapper(\r\n\t\t\t\t\tACTOR_PREPARE_EMBEDDED_DOCUMENTS,\r\n\t\t\t\t\tactorPrepareEmbeddedDocuments,\r\n\t\t\t\t\t\"WRAPPER\",\r\n\t\t\t\t);\r\n\t\t\tif (getSetting(\"nobulk-coins\"))\r\n\t\t\t\tregisterWrapper(\r\n\t\t\t\t\tTREASURE_PREPARE_BASE_DATA,\r\n\t\t\t\t\ttreasurePrepareBaseData,\r\n\t\t\t\t\t\"WRAPPER\",\r\n\t\t\t\t);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction treasurePrepareBaseData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (this.isCoinage) this.system.bulk.value = 0;\r\n\t} catch {\r\n\t\twrapperError(\"nobulk\", TREASURE_PREPARE_BASE_DATA);\r\n\t}\r\n}\r\n\r\nfunction actorPrepareEmbeddedDocuments(wrapped, ...args) {\r\n\twrapped(...args);\r\n\r\n\ttry {\r\n\t\tconst InventoryBulk = this.inventory.bulk.constructor;\r\n\r\n\t\tlet _value = null;\r\n\r\n\t\tObject.defineProperty(this.inventory.bulk, \"value\", {\r\n\t\t\tget() {\r\n\t\t\t\tif (_value) return _value;\r\n\t\t\t\t_value = InventoryBulk.computeTotalBulk(\r\n\t\t\t\t\tthis.actor.inventory.filter(\r\n\t\t\t\t\t\t(item) =>\r\n\t\t\t\t\t\t\t!item.isInContainer &&\r\n\t\t\t\t\t\t\titem.system.equipped.carryType !== \"dropped\",\r\n\t\t\t\t\t),\r\n\t\t\t\t\tthis.actor.size,\r\n\t\t\t\t);\r\n\t\t\t\treturn _value;\r\n\t\t\t},\r\n\t\t});\r\n\t} catch {\r\n\t\twrapperError(\"nobulk\", ACTOR_PREPARE_EMBEDDED_DOCUMENTS);\r\n\t}\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { getFlag, setFlag, unsetFlag } from \"../shared/flags\";\r\nimport { registerWrapper } from \"../shared/libwrapper\";\r\nimport { subLocalize } from \"../shared/localize\";\r\nimport { isInstanceOf } from \"../shared/misc\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst ACTOR_PREPARE_DATA = \"CONFIG.Actor.documentClass.prototype.prepareData\";\r\nconst DOCUMENT_SHEET_RENDER_INNER = \"DocumentSheet.prototype._renderInner\";\r\n\r\nexport function registerShare() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"share\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"force\"],\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tconst share = getSetting(\"share\");\r\n\t\t\tif (share === \"disabled\") return;\r\n\r\n\t\t\tregisterWrapper(ACTOR_PREPARE_DATA, prepareData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tDOCUMENT_SHEET_RENDER_INNER,\r\n\t\t\t\tdocumentSheetRenderInner,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tHooks.on(\"preUpdateActor\", preUpdateActor);\r\n\t\t\tHooks.on(\"deleteActor\", deleteActor);\r\n\t\t\tHooks.on(\"updateActor\", updateActor);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nasync function documentSheetRenderInner(wrapped, ...args) {\r\n\tconst inner = await wrapped(...args);\r\n\tif (!isInstanceOf(this, \"CreatureConfig\")) return inner;\r\n\r\n\tconst actor = this.actor;\r\n\tif (\r\n\t\t!isPlayedActor(actor) ||\r\n\t\t!actor.isOfType(\"character\", \"npc\") ||\r\n\t\tgetSlaves(actor).size\r\n\t)\r\n\t\treturn inner;\r\n\r\n\tconst masters = game.actors\r\n\t\t.filter((a) => a.id !== actor.id && a.isOwner && isValidMaster(a))\r\n\t\t.map((actor) => ({\r\n\t\t\tkey: actor.id,\r\n\t\t\tlabel: actor.name,\r\n\t\t}));\r\n\r\n\tconst group = await renderTemplate(templatePath(\"share/master\"), {\r\n\t\tmasters,\r\n\t\tmaster: getFlag(actor, \"share.master\"),\r\n\t\tselectPath: `flags.${MODULE_ID}.share.master`,\r\n\t\ti18n: subLocalize(\"share.templates.master\"),\r\n\t});\r\n\r\n\tinner.children().last().before(group);\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction deleteActor(actor) {\r\n\tremoveSlaveFromMaster(actor);\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tPromise.all(\r\n\t\tslaves.map(async (slave) => {\r\n\t\t\tunsetMaster(slave);\r\n\t\t\tawait unsetFlag(slave, \"share.master\");\r\n\t\t}),\r\n\t);\r\n}\r\n\r\nfunction preUpdateActor(actor, updates) {\r\n\tconst shareFlag = getProperty(updates, `flags.${MODULE_ID}.share`);\r\n\tif (shareFlag?.master) {\r\n\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\tif (isValidMaster(master)) {\r\n\t\t\tconst hpSource = deepClone(master._source.system.attributes.hp);\r\n\t\t\tsetProperty(updates, \"system.attributes.hp\", hpSource);\r\n\t\t}\r\n\t} else {\r\n\t\tconst master = getMaster(actor);\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (master && hpUpdate) {\r\n\t\t\tmaster.update(\r\n\t\t\t\t{ system: { attributes: { hp: hpUpdate } } },\r\n\t\t\t\t{ noHook: true },\r\n\t\t\t);\r\n\t\t\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\t\t\tdelete updates.system.attributes.hp;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction updateActor(actor, updates, options, userId) {\r\n\tconst isOriginalUser = game.user.id === userId;\r\n\r\n\tconst shareFlag = getShareFlag(updates);\r\n\tif (shareFlag?.master !== undefined) {\r\n\t\tconst slave = actor;\r\n\r\n\t\tremoveSlaveFromMaster(slave);\r\n\r\n\t\tif (shareFlag.master) {\r\n\t\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\t\tif (isValidMaster(master)) {\r\n\t\t\t\tsetMaster(slave, master);\r\n\t\t\t\taddSlaveToMaster(master, slave);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tunsetMaster(slave);\r\n\t\t}\r\n\t}\r\n\r\n\tif (!isOriginalUser) return;\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tif (slaves.size) {\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (hpUpdate) {\r\n\t\t\tconst data = { system: { attributes: { hp: hpUpdate } } };\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await slave.update(data, { noHook: true })),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await refreshActor(slave, updates)),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nasync function refreshActor(actor, data) {\r\n\tconst share = getSetting(\"share\");\r\n\tif (share === \"force\") {\r\n\t\tawait setFlag(actor, \"toggle\", !getFlag(actor, \"toggle\"));\r\n\t} else {\r\n\t\tactor.render(false, { action: \"update\" });\r\n\t\tactor._updateDependentTokens(data);\r\n\t}\r\n}\r\n\r\nfunction prepareData(wrapped) {\r\n\twrapped();\r\n\r\n\tconst masterId = getFlag(this, \"share.master\");\r\n\tconst master = masterId ? game.actors.get(masterId) : undefined;\r\n\r\n\tif (!isValidMaster(master)) return;\r\n\r\n\tif (!getMaster(this)) {\r\n\t\tsetMaster(this, master);\r\n\t\taddSlaveToMaster(master, this);\r\n\t}\r\n\r\n\tconst hp = this.system.attributes.hp;\r\n\tObject.defineProperty(this.system.attributes, \"hp\", {\r\n\t\tget() {\r\n\t\t\tconst masterHp = master.system.attributes.hp;\r\n\t\t\ttransfertHpData(masterHp, hp);\r\n\t\t\treturn hp;\r\n\t\t},\r\n\t\tenumerable: true,\r\n\t});\r\n}\r\n\r\nfunction transfertHpData(from, to) {\r\n\tto.breakdown = from.breakdown;\r\n\tto.max = from.max;\r\n\tto.sp = deepClone(from.sp);\r\n\tto.temp = from.temp;\r\n\tto.totalModifier = from.totalModifier;\r\n\tto.value = from.value;\r\n\tto._modifiers = from._modifiers.slice();\r\n}\r\n\r\nfunction getShareFlag(doc) {\r\n\treturn getProperty(doc, `flags.${MODULE_ID}.share`);\r\n}\r\n\r\nfunction getSlaves(actor) {\r\n\treturn getModuleProperty(actor, \"slaves\") ?? new Collection();\r\n}\r\n\r\nfunction setMaster(actor, master) {\r\n\tsetModuleProperty(actor, \"master\", master);\r\n}\r\n\r\nfunction unsetMaster(actor) {\r\n\tdeleteModuleProperty(actor, \"master\");\r\n}\r\n\r\nfunction getMaster(actor) {\r\n\treturn getModuleProperty(actor, \"master\");\r\n}\r\n\r\nfunction isValidMaster(actor) {\r\n\treturn actor && actor.type === \"character\" && !getMaster(actor);\r\n}\r\n\r\nfunction getModuleProperty(doc, path) {\r\n\treturn getProperty(doc, `modules.${MODULE_ID}.share.${path}`);\r\n}\r\n\r\nfunction setModuleProperty(doc, path, value) {\r\n\tsetProperty(doc, `modules.${MODULE_ID}.share.${path}`, value);\r\n}\r\n\r\nfunction deleteModuleProperty(doc, path) {\r\n\tdelete doc.modules?.[MODULE_ID]?.share?.[path];\r\n}\r\n\r\nfunction addSlaveToMaster(master, slave) {\r\n\tconst slaves = getSlaves(master);\r\n\tsetModuleProperty(master, \"slaves\", slaves.set(slave.id, slave));\r\n}\r\n\r\nfunction removeSlaveFromMaster(slave) {\r\n\tconst master = getMaster(slave);\r\n\tif (!master) return;\r\n\r\n\tconst slaves = getSlaves(master);\r\n\tslaves.delete(slave.id);\r\n}\r\n", "import { isPlayedActor } from \"../shared/actor\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { getItemWithSourceId, hasItemWithSourceId } from \"../shared/item\";\r\nimport { subLocalize } from \"../shared/localize\";\r\nimport { refreshCharacterSheets } from \"../shared/misc\";\r\nimport { info } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting } from \"../shared/settings\";\r\nimport { isActiveOwner } from \"../shared/user\";\r\n\r\nconst setSheetHook = createHook(\r\n\t\"renderCharacterSheetPF2e\",\r\n\trenderCharacterSheetPF2e,\r\n);\r\nconst setDeleteCombatHook = createHook(\"deleteCombat\", deleteCombat);\r\nconst setDeleteCombatantHook = createHook(\"deleteCombatant\", deleteCombatant);\r\nconst setCreateCombatantHook = createHook(\"createCombatant\", createCombatant);\r\n\r\nconst STANCE_SAVANT = [\r\n\t\"Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu\",\r\n\t\"Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8\",\r\n];\r\n\r\nconst REPLACERS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA\", // gorilla pound\r\n\r\n\t\t{\r\n\t\t\treplace: \"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT\", // gorilla stance\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK\",\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nconst EXTRAS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt\", // arcane cascade\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl\",\r\n\t\t\taction: \"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28\", // cobra envenom\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT\", // dread marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv\", // the stance aura\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa\", // inspiring marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ\", // the stance aura\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nexport function registerStances() {\r\n\treturn {\r\n\t\tname: \"stances\",\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"stances\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-stances\"],\r\n\t\tapi: {\r\n\t\t\tgetStances,\r\n\t\t\ttoggleStance,\r\n\t\t\tisValidStance,\r\n\t\t},\r\n\t\tready: (isGm) => {\r\n\t\t\tif (getSetting(\"stances\")) setup(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tsetSheetHook(value);\r\n\tsetDeleteCombatHook(value);\r\n\tsetDeleteCombatantHook(value);\r\n\tsetCreateCombatantHook(value);\r\n}\r\n\r\nfunction isValidStance(stance) {\r\n\treturn (\r\n\t\tstance?.system.traits.value.includes(\"stance\") &&\r\n\t\tstance.system.selfEffect?.uuid\r\n\t);\r\n}\r\n\r\nfunction getStances(actor) {\r\n\tconst stances = [];\r\n\tconst replaced = new Set();\r\n\r\n\tfor (const {\r\n\t\treplace,\r\n\t\tsourceId,\r\n\t\teffectUUID,\r\n\t\teffect,\r\n\t\timg,\r\n\t\tname,\r\n\t\titemName,\r\n\t\taction,\r\n\t} of actorStances(actor)) {\r\n\t\tif (replace) replaced.add(replace);\r\n\r\n\t\tconst foundAction = action\r\n\t\t\t? getItemWithSourceId(actor, action, \"action\")\r\n\t\t\t: getItemWithSourceId(actor, sourceId, \"feat\");\r\n\r\n\t\tstances.push({\r\n\t\t\tname,\r\n\t\t\titemName,\r\n\t\t\tuuid: sourceId,\r\n\t\t\timg,\r\n\t\t\teffectUUID,\r\n\t\t\teffectID: effect?.id,\r\n\t\t\tactionUUID: foundAction.sourceId,\r\n\t\t\tactionID: foundAction.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn stances.filter(({ uuid }) => !replaced.has(uuid));\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst inCombat = actor\r\n\t\t.getActiveTokens(true, true)\r\n\t\t.some((token) => token.inCombat);\r\n\tconst tab = html.find(\r\n\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]\",\r\n\t);\r\n\tconst options = tab.find(\".actions-options\");\r\n\tconst template = await renderTemplate(templatePath(\"stances/sheet\"), {\r\n\t\tstances,\r\n\t\tcanUseStances: inCombat && !actor.isDead,\r\n\t\ti18n: subLocalize(\"stances\"),\r\n\t});\r\n\r\n\tif (options.length) options.after(template);\r\n\telse tab.prepend(template);\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance\",\r\n\t\t)\r\n\t\t.on(\"click\", (event) => onToggleStance(event, actor));\r\n}\r\n\r\nfunction onToggleStance(event, actor) {\r\n\tconst target = event.currentTarget;\r\n\tconst canUseStances = target\r\n\t\t.closest(\".pf2e-stances\")\r\n\t\t?.classList.contains(\"can-use-stances\");\r\n\tif (!event.ctrlKey && !canUseStances) return;\r\n\r\n\tconst effectUUID = target.dataset.effectUuid;\r\n\ttoggleStance(actor, effectUUID);\r\n}\r\n\r\nfunction* actorStances(actor) {\r\n\tfor (const feat of actor.itemTypes.feat) {\r\n\t\tconst sourceId = feat.sourceId;\r\n\r\n\t\tconst replacer = REPLACERS.get(sourceId);\r\n\t\tconst extra = EXTRAS.get(sourceId);\r\n\t\tif (!replacer && !extra && !isValidStance(feat)) continue;\r\n\r\n\t\tconst effectUUID =\r\n\t\t\treplacer?.effect ?? extra?.effect ?? feat.system.selfEffect.uuid;\r\n\t\tconst effect = fromUuidSync(effectUUID);\r\n\t\tif (!effect) continue;\r\n\r\n\t\tyield {\r\n\t\t\tname: (replacer && fromUuidSync(replacer.replace)?.name) ?? feat.name,\r\n\t\t\titemName: feat.name,\r\n\t\t\treplace: replacer?.replace,\r\n\t\t\textra,\r\n\t\t\tsourceId,\r\n\t\t\teffectUUID,\r\n\t\t\teffect: getItemWithSourceId(actor, effectUUID, \"effect\"),\r\n\t\t\taction: extra?.action,\r\n\t\t\timg: effect.img,\r\n\t\t};\r\n\t}\r\n}\r\n\r\nfunction getStancesEffects(actor) {\r\n\tconst effects = [];\r\n\r\n\tfor (const { effect } of actorStances(actor)) {\r\n\t\tif (!effect) continue;\r\n\t\teffects.push({\r\n\t\t\tuuid: effect.sourceId,\r\n\t\t\tid: effect.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn effects;\r\n}\r\n\r\nasync function toggleStance(actor, effectUUID) {\r\n\tconst effects = getStancesEffects(actor);\r\n\tconst already = effects.findIndex((effect) => effect.uuid === effectUUID);\r\n\r\n\tlet create = false;\r\n\r\n\tif (already === -1) {\r\n\t\tcreate = true;\r\n\t} else {\r\n\t\tconst other = effects.filter((effect) => effect.uuid !== effectUUID).length;\r\n\t\tconst more =\r\n\t\t\teffects.filter((effect) => effect.uuid === effectUUID).length > 1;\r\n\t\tif (other || more) effects.splice(already, 1);\r\n\t}\r\n\r\n\tif (effects.length) {\r\n\t\tawait actor.deleteEmbeddedDocuments(\r\n\t\t\t\"Item\",\r\n\t\t\teffects.map((x) => x.id),\r\n\t\t);\r\n\t}\r\n\r\n\tif (create) addStance(actor, effectUUID);\r\n}\r\n\r\nasync function addStance(actor, uuid) {\r\n\tconst effect = await fromUuid(uuid);\r\n\r\n\tif (effect) {\r\n\t\tconst obj = effect.toObject();\r\n\t\tif (!getProperty(obj, \"flags.core.sourceId\"))\r\n\t\t\tsetProperty(obj, \"flags.core.sourceId\", effect.uuid);\r\n\r\n\t\tconst items = await actor.createEmbeddedDocuments(\"Item\", [obj]);\r\n\t\titems[0]?.toMessage();\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n\r\nfunction deleteCombat(combat) {\r\n\tfor (const combatant of combat.combatants) {\r\n\t\tdeleteCombatant(combatant);\r\n\t}\r\n}\r\n\r\nfunction deleteCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isActiveOwner(actor)) {\r\n\t\tconst effects = getStancesEffects(actor).map((effect) => effect.id);\r\n\t\tif (effects.length) actor.deleteEmbeddedDocuments(\"Item\", effects);\r\n\t}\r\n\r\n\trefreshCharacterSheets(actor);\r\n}\r\n\r\nfunction createCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isActiveOwner(actor)) checkForSavant(actor);\r\n\r\n\trefreshCharacterSheets(actor);\r\n}\r\n\r\nfunction getActorFromCombatant(combatant) {\r\n\tconst actor = combatant.actor;\r\n\tif (actor && !actor.isToken && actor.isOfType(\"character\")) return actor;\r\n}\r\n\r\nasync function checkForSavant(actor) {\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst hasStancesEffects = stances.filter(({ effectID }) => effectID).length;\r\n\tif (hasStancesEffects) return;\r\n\r\n\tconst hasSavantFeat = hasItemWithSourceId(actor, STANCE_SAVANT, [\"feat\"]);\r\n\tif (!hasSavantFeat) return;\r\n\r\n\tif (stances.length === 1) {\r\n\t\tconst stance = stances[0];\r\n\t\tif (await addStance(actor, stance.effectUUID))\r\n\t\t\tinfo(\"stances.useStance\", { stance: stance.name });\r\n\t} else {\r\n\t\topenStancesMenu(actor, stances);\r\n\t}\r\n}\r\n\r\nasync function openStancesMenu(actor, stances) {\r\n\tconst localize = subLocalize(\"stances.menu\");\r\n\r\n\tnew Dialog({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await renderTemplate(templatePath(\"stances/menu\"), {\r\n\t\t\tstances,\r\n\t\t\ti18n: localize,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tyes: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-people-arrows\"></i>',\r\n\t\t\t\tlabel: localize(\"accept\"),\r\n\t\t\t\tcallback: (html) =>\r\n\t\t\t\t\taddStance(actor, html.find(\"[name=stance]:checked\").val()),\r\n\t\t\t},\r\n\t\t\tno: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n\t\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\t},\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "export function ErrorPF2e(message) {\r\n\treturn Error(`PF2e System | ${message}`);\r\n}\r\n\r\nlet intlNumberFormat;\r\nexport function signedInteger(\r\n\tvalue,\r\n\t{ emptyStringZero = false, zeroIsNegative = false } = {},\r\n) {\r\n\tif (value === 0 && emptyStringZero) return \"\";\r\n\r\n\tintlNumberFormat ??= new Intl.NumberFormat(game.i18n.lang, {\r\n\t\tmaximumFractionDigits: 0,\r\n\t\tsignDisplay: \"always\",\r\n\t});\r\n\r\n\tconst maybeNegativeZero = zeroIsNegative && value === 0 ? -0 : value;\r\n\r\n\treturn intlNumberFormat.format(maybeNegativeZero);\r\n}\r\n\r\nexport function spellSlotGroupIdToNumber(groupId) {\r\n\tif (groupId === \"cantrips\") return 0;\r\n\tconst numericValue = Number(groupId ?? NaN);\r\n\treturn numericValue.between(0, 10) ? numericValue : null;\r\n}\r\n\r\nexport function coerceToSpellGroupId(value) {\r\n\tif (value === \"cantrips\") return value;\r\n\tconst numericValue = Number(value) || NaN;\r\n\treturn numericValue.between(1, 10) ? numericValue : null;\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\nimport {\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../shared/actor\";\r\nimport { subLocalize } from \"../shared/localize\";\r\nimport { localeCompare, ordinalString } from \"../shared/misc\";\r\nimport { spellSlotGroupIdToNumber } from \"../shared/pf2e/misc\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nexport function registerSpellsSummary() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"summary\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"sort\"],\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-spells-summary\"],\r\n\t\tready: (isGm) => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst enabled = (value ?? getSetting(\"summary\")) !== \"disabled\";\r\n\tif (enabled) {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"spellcasting\",\r\n\t\t\ttemplateFolder: \"summary/sheet\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"spellcasting\");\r\n\t}\r\n}\r\n\r\nfunction addEvents(html, sheet, actor) {\r\n\tconst inputs = html.find(\".spell-type .uses .spell-slots-input input\");\r\n\tinputs.on(\"change\", (event) => onUsesInputChange(event, actor));\r\n\tinputs.on(\"focus\", onUsesInputFocus);\r\n\tinputs.on(\"blur\", onUsesInputBlur);\r\n\r\n\thtml\r\n\t\t.find(\".focus-pips\")\r\n\t\t.on(\"click contextmenu\", (event) => onToggleFocusPool(event, actor));\r\n\r\n\thtml\r\n\t\t.find(\".spell-slots-increment-reset\")\r\n\t\t.on(\"click\", (event) => onSlotsReset(event, sheet, actor));\r\n\r\n\thtml.find(\".item-image\").on(\"click\", (event) => onItemToChat(event, actor));\r\n}\r\n\r\nasync function onUsesInputChange(event, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { inputPath, entryId } = $(event.currentTarget).data();\r\n\tconst value = event.currentTarget.valueAsNumber;\r\n\tactor.updateEmbeddedDocuments(\"Item\", [{ _id: entryId, [inputPath]: value }]);\r\n}\r\n\r\nfunction onUsesInputFocus(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.add(\"hover\");\r\n}\r\n\r\nfunction onUsesInputBlur(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.remove(\"hover\");\r\n}\r\n\r\nfunction onToggleFocusPool(event, actor) {\r\n\tevent.preventDefault();\r\n\tconst change = event.type === \"click\" ? 1 : -1;\r\n\tconst points = (actor.system.resources.focus?.value ?? 0) + change;\r\n\tactor.update({ \"system.resources.focus.value\": points });\r\n}\r\n\r\nfunction onChargesReset(sheet, actor, entryId) {\r\n\tif (game.modules.get(\"pf2e-staves\")?.active) {\r\n\t\tconst original = getSpellcastingTab(sheet.element).find(\r\n\t\t\t\".directory-list.spellcastingEntry-list\",\r\n\t\t);\r\n\t\tconst entry = original.find(\r\n\t\t\t`.item-container.spellcasting-entry[data-item-id=${entryId}]`,\r\n\t\t);\r\n\t\tconst btn = entry.find(\r\n\t\t\t\".spell-ability-data .statistic-values a.pf2e-staves-charge\",\r\n\t\t);\r\n\t\tbtn[0]?.click();\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst dailies = game.modules.get(\"pf2e-dailies\");\r\n\tif (!dailies?.active) return;\r\n\r\n\tconst entry = actor.spellcasting.get(entryId);\r\n\tdailies.api.updateEntryCharges(entry, 9999);\r\n}\r\n\r\nfunction onSlotsReset(event, sheet, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { itemId, rank, isCharge } = $(event.currentTarget).data();\r\n\tif (!itemId) return;\r\n\r\n\tif (isCharge) {\r\n\t\tonChargesReset(sheet, actor, itemId);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst item = actor.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tif (item.isOfType(\"consumable\")) {\r\n\t\tconst max = item.system.uses?.max;\r\n\t\tif (max) item.update({ \"system.uses.value\": max });\r\n\t} else if (item.isOfType(\"spellcastingEntry\")) {\r\n\t\tconst slotLevel = rank >= 0 && rank <= 11 ? `slot${rank}` : \"slot0\";\r\n\t\tconst slot = item.system.slots?.[slotLevel];\r\n\t\tif (slot) item.update({ [`system.slots.${slotLevel}.value`]: slot.max });\r\n\t} else if (item.isOfType(\"spell\")) {\r\n\t\tconst max = item.system.location.uses?.max;\r\n\t\tif (max) item.update({ \"system.location.uses.value\": max });\r\n\t}\r\n}\r\n\r\nasync function onItemToChat(event, actor) {\r\n\tconst { entryId, itemId, castRank } =\r\n\t\tevent.currentTarget.closest(\".item\").dataset;\r\n\r\n\tconst collection = actor.spellcasting.collections.get(entryId);\r\n\tif (!collection) return;\r\n\r\n\tconst spell = collection.get(itemId);\r\n\tspell?.toMessage(event, { data: { castRank: Number(castRank ?? NaN) } });\r\n}\r\n\r\nfunction getSpellcastingTab(html) {\r\n\treturn html.find(\r\n\t\t\"section.sheet-body .sheet-content > .tab[data-tab=spellcasting]\",\r\n\t);\r\n}\r\n\r\nasync function getData(actor) {\r\n\tconst focusPool = actor.system.resources.focus ?? { value: 0, max: 0 };\r\n\tconst pf2eStavesActive = game.modules.get(\"pf2e-staves\")?.active;\r\n\tconst pf2eDailies = game.modules.get(\"pf2e-dailies\");\r\n\tconst pf2eDailiesActive = pf2eDailies?.active;\r\n\tconst stavesActive =\r\n\t\tpf2eStavesActive ||\r\n\t\t(pf2eDailiesActive && isNewerVersion(pf2eDailies.version, \"2.14.0\"));\r\n\tconst chargesPath = pf2eStavesActive\r\n\t\t? \"flags.pf2e-staves.charges\"\r\n\t\t: pf2eDailiesActive\r\n\t\t  ? \"flags.pf2e-dailies.staff.charges\"\r\n\t\t  : \"\";\r\n\r\n\tconst spells = [];\r\n\tconst focuses = [];\r\n\r\n\tlet rituals;\r\n\tlet hasFocusCantrips = false;\r\n\r\n\tconst entries = await Promise.all(\r\n\t\tactor.spellcasting.collections.map(async (spells) => {\r\n\t\t\treturn {\r\n\t\t\t\tentry: spells.entry,\r\n\t\t\t\tdata: await spells.entry.getSheetData({ spells }),\r\n\t\t\t};\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const { entry, data } of entries) {\r\n\t\tif (data.isRitual) {\r\n\t\t\trituals = data.groups.flatMap((slot, slotId) =>\r\n\t\t\t\tslot.active\r\n\t\t\t\t\t.map(({ spell }) => ({\r\n\t\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\t\tslotId,\r\n\t\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\t\trank: spell.rank,\r\n\t\t\t\t\t\ttime: spell.system.time.value,\r\n\t\t\t\t\t}))\r\n\t\t\t\t\t.filter(Boolean),\r\n\t\t\t);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst entryId = data.id;\r\n\t\tconst entryDc = data.statistic.dc.value;\r\n\t\tconst entryName = data.name;\r\n\t\tconst isFocus = data.isFocusPool;\r\n\t\tconst isCharge = entry.system?.prepared?.value === \"charge\";\r\n\t\tconst isInnate = data.isInnate;\r\n\t\tconst isPrepared = data.isPrepared;\r\n\t\tconst isSpontaneous = data.isSpontaneous;\r\n\t\tconst isFlexible = data.isFlexible;\r\n\r\n\t\tconst consumable = (() => {\r\n\t\t\tif (data.category !== \"items\") return;\r\n\t\t\tconst itemId = entry.id.split(\"-\")[0];\r\n\t\t\treturn actor.items.get(itemId);\r\n\t\t})();\r\n\r\n\t\tconst charges = (() => {\r\n\t\t\tif (!isCharge) return;\r\n\r\n\t\t\tconst dailiesData =\r\n\t\t\t\tpf2eDailiesActive &&\r\n\t\t\t\tpf2eDailies.api.getSpellcastingEntryStaffData(entry);\r\n\t\t\tconst { charges, max, canPayCost } = dailiesData ??\r\n\t\t\t\tgetProperty(entry, \"flags.pf2e-staves.charges\") ?? {\r\n\t\t\t\t\tcharges: 0,\r\n\t\t\t\t\tmax: 0,\r\n\t\t\t\t};\r\n\r\n\t\t\treturn {\r\n\t\t\t\tvalue: charges,\r\n\t\t\t\tmax,\r\n\t\t\t\tnoMax: true,\r\n\t\t\t\tcanPayCost: canPayCost ?? (() => true),\r\n\t\t\t};\r\n\t\t})();\r\n\r\n\t\tfor (const group of data.groups) {\r\n\t\t\tif (!group.active.length || group.uses?.max === 0) continue;\r\n\r\n\t\t\tconst slotSpells = [];\r\n\t\t\tconst isCantrip = group.id === \"cantrips\";\r\n\t\t\tconst groupNumber = spellSlotGroupIdToNumber(group.id);\r\n\t\t\tconst isBroken = !isCantrip && isCharge && !stavesActive;\r\n\r\n\t\t\tfor (let slotId = 0; slotId < group.active.length; slotId++) {\r\n\t\t\t\tconst active = group.active[slotId];\r\n\t\t\t\tif (!active || active.uses?.max === 0) continue;\r\n\r\n\t\t\t\tconst { spell, expended, virtual, uses, castRank } = active;\r\n\r\n\t\t\t\tslotSpells.push({\r\n\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\trange: spell.system.range.value || \"-\",\r\n\t\t\t\t\tcastRank: castRank ?? spell.rank,\r\n\t\t\t\t\tslotId,\r\n\t\t\t\t\tentryId,\r\n\t\t\t\t\tentryDc,\r\n\t\t\t\t\tentryName,\r\n\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\tinputId: isInnate ? spell.id : data.id,\r\n\t\t\t\t\tinputPath: consumable\r\n\t\t\t\t\t\t? \"system.uses.value\"\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? chargesPath\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"system.location.uses.value\"\r\n\t\t\t\t\t\t\t  : `system.slots.slot${groupNumber}.value`,\r\n\t\t\t\t\tisCharge,\r\n\t\t\t\t\tisActiveCharge: isCharge && stavesActive,\r\n\t\t\t\t\tisBroken,\r\n\t\t\t\t\tisVirtual: virtual,\r\n\t\t\t\t\tisInnate,\r\n\t\t\t\t\tisCantrip,\r\n\t\t\t\t\tisFocus,\r\n\t\t\t\t\tisPrepared,\r\n\t\t\t\t\tisSpontaneous: isSpontaneous || isFlexible,\r\n\t\t\t\t\tgroupId: group.id,\r\n\t\t\t\t\tconsumable,\r\n\t\t\t\t\tuses: consumable\r\n\t\t\t\t\t\t? consumable.system.uses\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? charges\r\n\t\t\t\t\t\t  : uses ?? group.uses,\r\n\t\t\t\t\texpended:\r\n\t\t\t\t\t\tisCharge && !isCantrip\r\n\t\t\t\t\t\t\t? !charges.canPayCost(groupNumber)\r\n\t\t\t\t\t\t\t: expended ??\r\n\t\t\t\t\t\t\t  (isFocus && !isCantrip ? focusPool.value <= 0 : false),\r\n\t\t\t\t\taction: spell.system.time.value,\r\n\t\t\t\t\ttype: consumable\r\n\t\t\t\t\t\t? `PF2E.Item.Consumable.Category.${consumable.category}`\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? `${MODULE_ID}.summary.staff`\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeInnate\"\r\n\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeSpontaneous\"\r\n\t\t\t\t\t\t\t\t  : isFlexible\r\n\t\t\t\t\t\t\t\t\t  ? \"PF2E.SpellFlexibleLabel\"\r\n\t\t\t\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.TraitFocus\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.SpellPreparedLabel\",\r\n\t\t\t\t\torder: isCharge\r\n\t\t\t\t\t\t? 0\r\n\t\t\t\t\t\t: isPrepared\r\n\t\t\t\t\t\t  ? 1\r\n\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t  ? 2\r\n\t\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t\t  ? 3\r\n\t\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t\t  ? 4\r\n\t\t\t\t\t\t\t\t\t  : 5,\r\n\t\t\t\t\tnoHover: isPrepared || isCantrip || isBroken || isFocus,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (slotSpells.length) {\r\n\t\t\t\tif (isFocus) {\r\n\t\t\t\t\tif (isCantrip) hasFocusCantrips = true;\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfocuses.push(...slotSpells);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tspells[groupNumber] ??= [];\r\n\t\t\t\tspells[groupNumber].push(...slotSpells);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (spells.length) {\r\n\t\tconst sort =\r\n\t\t\tgetSetting(\"summary\") === \"sort\"\r\n\t\t\t\t? (a, b) =>\r\n\t\t\t\t\t\ta.order === b.order\r\n\t\t\t\t\t\t\t? localeCompare(a.name, b.name)\r\n\t\t\t\t\t\t\t: a.order - b.order\r\n\t\t\t\t: (a, b) => localeCompare(a.name, b.name);\r\n\r\n\t\tfor (const entry of spells) {\r\n\t\t\tif (!entry) continue;\r\n\t\t\tentry.sort(sort);\r\n\t\t}\r\n\t}\r\n\r\n\tif (focuses.length) {\r\n\t\tfocuses.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\tspells[12] = focuses;\r\n\t\thasFocusCantrips = false;\r\n\t}\r\n\r\n\treturn {\r\n\t\tspells,\r\n\t\trituals,\r\n\t\tfocusPool,\r\n\t\thasFocusCantrips,\r\n\t\tisOwner: actor.isOwner,\r\n\t\ti18n: subLocalize(\"summary\"),\r\n\t\tentryRank: (rank) =>\r\n\t\t\tgame.i18n.format(\"PF2E.Item.Spell.Rank.Ordinal\", {\r\n\t\t\t\trank: ordinalString(rank),\r\n\t\t\t}),\r\n\t};\r\n}\r\n", "export async function roll3dDice(\r\n\troll,\r\n\t{ user = game.user, synchronize = true } = {},\r\n) {\r\n\tif (!game.modules.get(\"dice-so-nice\")?.active) return;\r\n\treturn game.dice3d.showForRoll(roll, user, synchronize);\r\n}\r\n", "export function applyStackingRules(modifiers) {\r\n\tlet total = 0;\r\n\tconst highestBonus = {};\r\n\tconst lowestPenalty = {};\r\n\r\n\t// There are no ability bonuses or penalties, so always take the highest ability modifier.\r\n\tconst abilityModifiers = modifiers.filter(\r\n\t\t(m) => m.type === \"ability\" && !m.ignored,\r\n\t);\r\n\tconst bestAbility = abilityModifiers.reduce((best, modifier) => {\r\n\t\tif (best === null) {\r\n\t\t\treturn modifier;\r\n\t\t}\r\n\r\n\t\treturn modifier.force\r\n\t\t\t? modifier\r\n\t\t\t: best.force\r\n\t\t\t  ? best\r\n\t\t\t  : modifier.modifier > best.modifier\r\n\t\t\t\t  ? modifier\r\n\t\t\t\t  : best;\r\n\t}, null);\r\n\tfor (const modifier of abilityModifiers) {\r\n\t\tmodifier.ignored = modifier !== bestAbility;\r\n\t}\r\n\r\n\tfor (const modifier of modifiers) {\r\n\t\t// Always disable ignored modifiers and don't do anything further with them.\r\n\t\tif (modifier.ignored) {\r\n\t\t\tmodifier.enabled = false;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Untyped modifiers always stack, so enable them and add their modifier.\r\n\t\tif (modifier.type === \"untyped\") {\r\n\t\t\tmodifier.enabled = true;\r\n\t\t\ttotal += modifier.modifier;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Otherwise, apply stacking rules to positive modifiers and negative modifiers separately.\r\n\t\tif (modifier.modifier < 0) {\r\n\t\t\ttotal += applyStacking(lowestPenalty, modifier, LOWER_PENALTY);\r\n\t\t} else {\r\n\t\t\ttotal += applyStacking(highestBonus, modifier, HIGHER_BONUS);\r\n\t\t}\r\n\t}\r\n\r\n\treturn total;\r\n}\r\n\r\nfunction applyStacking(best, modifier, isBetter) {\r\n\t// If there is no existing bonus of this type, then add ourselves.\r\n\tconst existing = best[modifier.type];\r\n\tif (existing === undefined) {\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier;\r\n\t}\r\n\r\n\tif (isBetter(modifier, existing)) {\r\n\t\t// If we are a better modifier according to the comparison, then we become the new 'best'.\r\n\t\texisting.enabled = false;\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier - existing.modifier;\r\n\t}\r\n\r\n\t// Otherwise, the existing modifier is better, so do nothing.\r\n\tmodifier.enabled = false;\r\n\treturn 0;\r\n}\r\n", "export function htmlQuery(parent, selectors) {\r\n\tif (!(parent instanceof Element || parent instanceof Document)) return null;\r\n\treturn parent.querySelector(selectors);\r\n}\r\n", "export async function extractEphemeralEffects({\r\n\taffects,\r\n\torigin,\r\n\ttarget,\r\n\titem,\r\n\tdomains,\r\n\toptions,\r\n}) {\r\n\tif (!(origin && target)) return [];\r\n\r\n\tconst [effectsFrom, effectsTo] =\r\n\t\taffects === \"target\" ? [origin, target] : [target, origin];\r\n\tconst fullOptions = [\r\n\t\t...options,\r\n\t\teffectsFrom.getRollOptions(domains),\r\n\t\teffectsTo.getSelfRollOptions(affects),\r\n\t].flat();\r\n\tconst resolvables = item\r\n\t\t? item.isOfType(\"spell\")\r\n\t\t\t? { spell: item }\r\n\t\t\t: { weapon: item }\r\n\t\t: {};\r\n\treturn (\r\n\t\tawait Promise.all(\r\n\t\t\tdomains\r\n\t\t\t\t.flatMap(\r\n\t\t\t\t\t(s) => effectsFrom.synthetics.ephemeralEffects[s]?.[affects] ?? [],\r\n\t\t\t\t)\r\n\t\t\t\t.map((d) => d({ test: fullOptions, resolvables })),\r\n\t\t)\r\n\t).flatMap((e) => e ?? []);\r\n}\r\n\r\nexport function extractNotes(rollNotes, selectors) {\r\n\treturn selectors.flatMap((s) => (rollNotes[s] ?? []).map((n) => n.clone()));\r\n}\r\n\r\nexport function extractDamageDice(deferredDice, selectors, options) {\r\n\treturn selectors\r\n\t\t.flatMap((s) => deferredDice[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n}\r\n\r\nexport function extractModifiers(synthetics, selectors, options) {\r\n\tconst { modifierAdjustments, modifiers: syntheticModifiers } = synthetics;\r\n\tconst modifiers = Array.from(new Set(selectors))\r\n\t\t.flatMap((s) => syntheticModifiers[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n\tfor (const modifier of modifiers) {\r\n\t\tmodifier.adjustments = extractModifierAdjustments(\r\n\t\t\tmodifierAdjustments,\r\n\t\t\tselectors,\r\n\t\t\tmodifier.slug,\r\n\t\t);\r\n\t}\r\n\r\n\treturn modifiers;\r\n}\r\n\r\nfunction extractModifierAdjustments(adjustmentsRecord, selectors, slug) {\r\n\tconst adjustments = Array.from(\r\n\t\tnew Set(selectors.flatMap((s) => adjustmentsRecord[s] ?? [])),\r\n\t);\r\n\treturn adjustments.filter((a) => [slug, null].includes(a.slug));\r\n}\r\n", "import { onDamageApplied } from \"../../features/target\";\r\nimport { isInstanceOf } from \"../misc\";\r\nimport { applyStackingRules } from \"./actor\";\r\nimport { htmlQuery } from \"./dom\";\r\nimport { ErrorPF2e, signedInteger } from \"./misc\";\r\nimport {\r\n\textractDamageDice,\r\n\textractEphemeralEffects,\r\n\textractModifiers,\r\n\textractNotes,\r\n} from \"./rules\";\r\n\r\nexport async function applyDamageFromMessage(\r\n\ttoken,\r\n\t{\r\n\t\tmessage,\r\n\t\tmultiplier = 1,\r\n\t\taddend = 0,\r\n\t\tpromptModifier = false,\r\n\t\trollIndex = 0,\r\n\t},\r\n) {\r\n\tif (promptModifier) return shiftAdjustDamage(message, multiplier, rollIndex);\r\n\r\n\tconst tokens = [token];\r\n\tif (tokens.length === 0) {\r\n\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\tlocalize: true,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst shieldBlockRequest = CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\tconst roll = message.rolls.at(rollIndex);\r\n\tif (!isInstanceOf(roll, \"DamageRoll\"))\r\n\t\tthrow ErrorPF2e(\"Unexpected error retrieving damage roll\");\r\n\r\n\tlet damage =\r\n\t\tmultiplier < 0\r\n\t\t\t? multiplier * roll.total + addend\r\n\t\t\t: roll.alter(multiplier, addend);\r\n\r\n\t// Get origin roll options and apply damage to a contextual clone: this may influence condition IWR, for example\r\n\tconst messageRollOptions = [...(message.flags.pf2e.context?.options ?? [])];\r\n\tconst originRollOptions = messageRollOptions\r\n\t\t.filter((o) => o.startsWith(\"self:\"))\r\n\t\t.map((o) => o.replace(/^self/, \"origin\"));\r\n\tconst messageItem = message.item;\r\n\r\n\tfor (const token of tokens) {\r\n\t\tif (!token.actor) continue;\r\n\r\n\t\t// If no target was acquired during a roll, set roll options for it during damage application\r\n\t\tif (!messageRollOptions.some((o) => o.startsWith(\"target\"))) {\r\n\t\t\tmessageRollOptions.push(...token.actor.getSelfRollOptions(\"target\"));\r\n\t\t}\r\n\t\tconst domain = multiplier > 0 ? \"damage-received\" : \"healing-received\";\r\n\t\tconst ephemeralEffects =\r\n\t\t\tmultiplier > 0\r\n\t\t\t\t? await extractEphemeralEffects({\r\n\t\t\t\t\t\taffects: \"target\",\r\n\t\t\t\t\t\torigin: message.actor,\r\n\t\t\t\t\t\ttarget: token.actor,\r\n\t\t\t\t\t\titem: message.item,\r\n\t\t\t\t\t\tdomains: [domain],\r\n\t\t\t\t\t\toptions: messageRollOptions,\r\n\t\t\t\t  })\r\n\t\t\t\t: [];\r\n\t\tconst contextClone = token.actor.getContextualClone(\r\n\t\t\toriginRollOptions,\r\n\t\t\tephemeralEffects,\r\n\t\t);\r\n\t\tconst applicationRollOptions = new Set([\r\n\t\t\t...messageRollOptions.filter((o) => !/^(?:self|target):/.test(o)),\r\n\t\t\t...originRollOptions,\r\n\t\t\t...contextClone.getSelfRollOptions(),\r\n\t\t]);\r\n\r\n\t\t// Target-specific damage/healing adjustments\r\n\t\tconst outcome = message.flags.pf2e.context?.outcome;\r\n\t\tconst breakdown = [];\r\n\t\tconst rolls = [];\r\n\t\tif (typeof damage === \"number\" && damage < 0) {\r\n\t\t\tconst critical = outcome === \"criticalSuccess\";\r\n\r\n\t\t\tconst resolvables = (() => {\r\n\t\t\t\tif (messageItem?.isOfType(\"spell\")) return { spell: messageItem };\r\n\t\t\t\tif (messageItem?.isOfType(\"weapon\")) return { weapon: messageItem };\r\n\t\t\t\treturn {};\r\n\t\t\t})();\r\n\r\n\t\t\tconst damageDice = extractDamageDice(\r\n\t\t\t\tcontextClone.synthetics.damageDice,\r\n\t\t\t\t[domain],\r\n\t\t\t\t{\r\n\t\t\t\t\tresolvables,\r\n\t\t\t\t\ttest: applicationRollOptions,\r\n\t\t\t\t},\r\n\t\t\t).filter(\r\n\t\t\t\t(d) =>\r\n\t\t\t\t\t(d.critical === null || d.critical === critical) &&\r\n\t\t\t\t\td.predicate.test(applicationRollOptions),\r\n\t\t\t);\r\n\r\n\t\t\tfor (const dice of damageDice) {\r\n\t\t\t\tconst formula = `${dice.diceNumber}${dice.dieSize}[${dice.label}]`;\r\n\t\t\t\tconst roll = await new Roll(formula).evaluate({ async: true });\r\n\t\t\t\troll._formula = `${dice.diceNumber}${dice.dieSize}`; // remove the label from the main formula\r\n\t\t\t\tawait roll.toMessage({\r\n\t\t\t\t\tflags: { pf2e: { suppressDamageButtons: true } },\r\n\t\t\t\t\tflavor: dice.label,\r\n\t\t\t\t\tspeaker: ChatMessage.getSpeaker({ token }),\r\n\t\t\t\t});\r\n\t\t\t\tbreakdown.push(`${dice.label} ${dice.diceNumber}${dice.dieSize}`);\r\n\t\t\t\trolls.push(roll);\r\n\t\t\t}\r\n\t\t\tif (rolls.length) {\r\n\t\t\t\tdamage -= rolls\r\n\t\t\t\t\t.map((roll) => roll.total)\r\n\t\t\t\t\t.reduce((previous, current) => previous + current);\r\n\t\t\t}\r\n\r\n\t\t\tconst modifiers = extractModifiers(contextClone.synthetics, [domain], {\r\n\t\t\t\tresolvables,\r\n\t\t\t}).filter(\r\n\t\t\t\t(m) =>\r\n\t\t\t\t\t(m.critical === null || m.critical === critical) &&\r\n\t\t\t\t\tm.predicate.test(applicationRollOptions),\r\n\t\t\t);\r\n\r\n\t\t\t// unlikely to have any typed modifiers, but apply stacking rules just in case even though the context of\r\n\t\t\t// previously applied modifiers has been lost\r\n\t\t\tdamage -= applyStackingRules(modifiers ?? []);\r\n\r\n\t\t\t// target-specific modifiers breakdown\r\n\t\t\tbreakdown.push(\r\n\t\t\t\t...modifiers\r\n\t\t\t\t\t.filter((m) => m.enabled)\r\n\t\t\t\t\t.map((m) => `${m.label} ${signedInteger(m.modifier)}`),\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tconst hasDamageOrHealing =\r\n\t\t\ttypeof damage === \"number\" ? damage !== 0 : damage.total !== 0;\r\n\t\tconst notes = hasDamageOrHealing\r\n\t\t\t? extractNotes(contextClone.synthetics.rollNotes, [domain]).filter(\r\n\t\t\t\t\t(n) =>\r\n\t\t\t\t\t\t(!outcome ||\r\n\t\t\t\t\t\t\tn.outcome.length === 0 ||\r\n\t\t\t\t\t\t\tn.outcome.includes(outcome)) &&\r\n\t\t\t\t\t\tn.predicate.test(applicationRollOptions),\r\n\t\t\t  )\r\n\t\t\t: [];\r\n\r\n\t\tawait contextClone.applyDamage({\r\n\t\t\tdamage,\r\n\t\t\ttoken,\r\n\t\t\titem: message.item,\r\n\t\t\tskipIWR: multiplier <= 0,\r\n\t\t\trollOptions: applicationRollOptions,\r\n\t\t\tshieldBlockRequest,\r\n\t\t\tbreakdown,\r\n\t\t\tnotes,\r\n\t\t});\r\n\t}\r\n\ttoggleOffShieldBlock(message.id);\r\n\r\n\t/**\r\n\t * added stuff HERE\r\n\t */\r\n\tonDamageApplied(message, token.id, rollIndex);\r\n}\r\n\r\nexport function onClickShieldBlock(target, shieldButton, messageEl) {\r\n\tconst getTokens = () => {\r\n\t\treturn [target];\r\n\t};\r\n\r\n\tconst getNonBrokenShields = (tokens) => {\r\n\t\tconst actor = tokens[0]?.actor;\r\n\t\treturn (\r\n\t\t\tactor?.itemTypes.shield.filter(\r\n\t\t\t\t(s) => s.isEquipped && !s.isBroken && !s.isDestroyed,\r\n\t\t\t) ?? []\r\n\t\t);\r\n\t};\r\n\r\n\t// Add a tooltipster instance to the shield button if needed.\r\n\tif (!shieldButton.classList.contains(\"tooltipstered\")) {\r\n\t\t$(shieldButton)\r\n\t\t\t.tooltipster({\r\n\t\t\t\tanimation: \"fade\",\r\n\t\t\t\ttrigger: \"click\",\r\n\t\t\t\tarrow: false,\r\n\t\t\t\tcontent: htmlQuery(messageEl, \"div.hover-content\"),\r\n\t\t\t\tcontentAsHTML: true,\r\n\t\t\t\tcontentCloning: true,\r\n\t\t\t\tdebug: false,\r\n\t\t\t\tinteractive: true,\r\n\t\t\t\tside: [\"top\"],\r\n\t\t\t\ttheme: \"crb-hover\",\r\n\t\t\t\tfunctionBefore: () => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tif (!tokens.length) return false;\r\n\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst hasMultipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// More than one shield and no selection. Show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && !shieldActivated) {\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// More than one shield and one was previously selected. Remove selection and show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && shieldButton.dataset.shieldId) {\r\n\t\t\t\t\t\tshieldButton.attributes.removeNamedItem(\"data-shield-id\");\r\n\t\t\t\t\t\tshieldButton.classList.remove(\"shield-activated\");\r\n\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Normal toggle behaviour. Tooltip is suppressed.\r\n\t\t\t\t\tshieldButton.classList.toggle(\"shield-activated\");\r\n\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle =\r\n\t\t\t\t\t\t!CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\t\t\t\tfunctionFormat: (instance, _helper, contentEl) => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst multipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// If the actor is wielding more than one shield, have the user pick which shield to use for blocking.\r\n\t\t\t\t\tif (multipleShields && !shieldActivated) {\r\n\t\t\t\t\t\t// Populate the list with the shield options\r\n\t\t\t\t\t\tconst listEl = htmlQuery(contentEl, \"ul.shield-options\");\r\n\t\t\t\t\t\tif (!listEl) return $(contentEl);\r\n\r\n\t\t\t\t\t\tconst shieldList = nonBrokenShields.map((shield) => {\r\n\t\t\t\t\t\t\tconst input = document.createElement(\"input\");\r\n\t\t\t\t\t\t\tinput.classList.add(\"data\");\r\n\t\t\t\t\t\t\tinput.type = \"radio\";\r\n\t\t\t\t\t\t\tinput.name = \"shield-id\";\r\n\t\t\t\t\t\t\tinput.value = shield.id;\r\n\t\t\t\t\t\t\tinput.addEventListener(\"click\", () => {\r\n\t\t\t\t\t\t\t\tshieldButton.dataset.shieldId = input.value;\r\n\t\t\t\t\t\t\t\tshieldButton.classList.add(\"shield-activated\");\r\n\t\t\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = true;\r\n\t\t\t\t\t\t\t\tinstance.close();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst shieldName = document.createElement(\"span\");\r\n\t\t\t\t\t\t\tshieldName.classList.add(\"label\");\r\n\t\t\t\t\t\t\tshieldName.innerHTML = shield.name;\r\n\r\n\t\t\t\t\t\t\tconst hardness = document.createElement(\"span\");\r\n\t\t\t\t\t\t\thardness.classList.add(\"tag\");\r\n\t\t\t\t\t\t\tconst hardnessLabel = game.i18n.localize(\"PF2E.HardnessLabel\");\r\n\t\t\t\t\t\t\thardness.innerHTML = `${hardnessLabel}: ${shield.hardness}`;\r\n\r\n\t\t\t\t\t\t\tconst itemLi = document.createElement(\"li\");\r\n\t\t\t\t\t\t\titemLi.classList.add(\"item\");\r\n\t\t\t\t\t\t\titemLi.append(input, shieldName, hardness);\r\n\r\n\t\t\t\t\t\t\treturn itemLi;\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tlistEl.replaceChildren(...shieldList);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn $(contentEl);\r\n\t\t\t\t},\r\n\t\t\t})\r\n\t\t\t.tooltipster(\"open\");\r\n\t}\r\n}\r\n\r\nfunction toggleOffShieldBlock(messageId) {\r\n\tfor (const app of [\"#chat-log\", \"#chat-popout\"]) {\r\n\t\tconst selector = `${app} > li.chat-message[data-message-id=\"${messageId}\"] button[data-action=shield-block]`;\r\n\t\tconst button = htmlQuery(document.body, selector);\r\n\t\tbutton?.classList.remove(\"shield-activated\");\r\n\t}\r\n\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n}\r\n\r\nasync function shiftAdjustDamage(token, { message, multiplier, rollIndex }) {\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/damage/adjustment-dialog.hbs\",\r\n\t);\r\n\tconst AdjustmentDialog = class extends Dialog {\r\n\t\tactivateListeners($html) {\r\n\t\t\tsuper.activateListeners($html);\r\n\t\t\t$html[0].querySelector(\"input\")?.focus();\r\n\t\t}\r\n\t};\r\n\tconst isHealing = multiplier < 0;\r\n\tnew AdjustmentDialog({\r\n\t\ttitle: game.i18n.localize(\r\n\t\t\tisHealing\r\n\t\t\t\t? \"PF2E.UI.shiftModifyHealingTitle\"\r\n\t\t\t\t: \"PF2E.UI.shiftModifyDamageTitle\",\r\n\t\t),\r\n\t\tcontent,\r\n\t\tbuttons: {\r\n\t\t\tok: {\r\n\t\t\t\tlabel: game.i18n.localize(\"PF2E.OK\"),\r\n\t\t\t\tcallback: async ($dialog) => {\r\n\t\t\t\t\t// In case of healing, multipler will have negative sign. The user will expect that positive\r\n\t\t\t\t\t// modifier would increase healing value, while negative would decrease.\r\n\t\t\t\t\tconst adjustment =\r\n\t\t\t\t\t\t(Number($dialog[0].querySelector(\"input\")?.value) || 0) *\r\n\t\t\t\t\t\tMath.sign(multiplier);\r\n\t\t\t\t\tapplyDamageFromMessage(token, {\r\n\t\t\t\t\t\tmessage,\r\n\t\t\t\t\t\tmultiplier,\r\n\t\t\t\t\t\taddend: adjustment,\r\n\t\t\t\t\t\tpromptModifier: false,\r\n\t\t\t\t\t\trollIndex,\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tcancel: {\r\n\t\t\t\tlabel: \"Cancel\",\r\n\t\t\t},\r\n\t\t},\r\n\t\tdefault: \"ok\",\r\n\t\tclose: () => {\r\n\t\t\ttoggleOffShieldBlock(message.id);\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "const DEGREE_ADJUSTMENT_AMOUNTS = {\r\n\tLOWER_BY_TWO: -2,\r\n\tLOWER: -1,\r\n\tINCREASE: 1,\r\n\tINCREASE_BY_TWO: 2,\r\n\tTO_CRITICAL_FAILURE: \"criticalFailure\",\r\n\tTO_FAILURE: \"failure\",\r\n\tTO_SUCCESS: \"success\",\r\n\tTO_CRITICAL_SUCCESS: \"criticalSuccess\",\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS_STRINGS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\nexport class DegreeOfSuccess {\r\n\tconstructor(roll, dc, dosAdjustments = null) {\r\n\t\tif (roll instanceof Roll) {\r\n\t\t\tthis.dieResult =\r\n\t\t\t\t(roll.isDeterministic\r\n\t\t\t\t\t? roll.terms.find((t) => t instanceof NumericTerm)\r\n\t\t\t\t\t: roll.dice.find((d) => d instanceof Die && d.faces === 20)\r\n\t\t\t\t)?.total ?? 1;\r\n\t\t\tthis.rollTotal = roll.total;\r\n\t\t} else {\r\n\t\t\tthis.dieResult = roll.dieValue;\r\n\t\t\tthis.rollTotal = roll.dieValue + roll.modifier;\r\n\t\t}\r\n\r\n\t\tthis.dc = typeof dc === \"number\" ? { value: dc } : dc;\r\n\r\n\t\tthis.unadjusted = this.#calculateDegreeOfSuccess();\r\n\t\tthis.adjustment = this.#getDegreeAdjustment(\r\n\t\t\tthis.unadjusted,\r\n\t\t\tdosAdjustments,\r\n\t\t);\r\n\t\tthis.value = this.adjustment\r\n\t\t\t? this.#adjustDegreeOfSuccess(this.adjustment.amount, this.unadjusted)\r\n\t\t\t: this.unadjusted;\r\n\t}\r\n\r\n\tstatic CRITICAL_FAILURE = 0;\r\n\tstatic FAILURE = 1;\r\n\tstatic SUCCESS = 2;\r\n\tstatic CRITICAL_SUCCESS = 3;\r\n\r\n\t#getDegreeAdjustment(degree, adjustments) {\r\n\t\tif (!adjustments) return null;\r\n\r\n\t\tfor (const outcome of [\"all\", ...DEGREE_OF_SUCCESS_STRINGS]) {\r\n\t\t\tconst { label, amount } = adjustments[outcome] ?? {};\r\n\t\t\tif (\r\n\t\t\t\tamount &&\r\n\t\t\t\tlabel &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_SUCCESS &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.INCREASE\r\n\t\t\t\t) &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_FAILURE &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.LOWER\r\n\t\t\t\t) &&\r\n\t\t\t\t(outcome === \"all\" ||\r\n\t\t\t\t\tDEGREE_OF_SUCCESS_STRINGS.indexOf(outcome) === degree)\r\n\t\t\t) {\r\n\t\t\t\treturn { label, amount };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\t#adjustDegreeOfSuccess(amount, degreeOfSuccess) {\r\n\t\tswitch (amount) {\r\n\t\t\tcase \"criticalFailure\":\r\n\t\t\t\treturn 0;\r\n\t\t\tcase \"failure\":\r\n\t\t\t\treturn 1;\r\n\t\t\tcase \"success\":\r\n\t\t\t\treturn 2;\r\n\t\t\tcase \"criticalSuccess\":\r\n\t\t\t\treturn 3;\r\n\t\t\tdefault:\r\n\t\t\t\treturn Math.clamped(degreeOfSuccess + amount, 0, 3);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * @param degree The current success value\r\n\t * @return The new success value\r\n\t */\r\n\t#adjustDegreeByDieValue(degree) {\r\n\t\tif (this.dieResult === 20) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.INCREASE,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (this.dieResult === 1) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.LOWER,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn degree;\r\n\t}\r\n\r\n\t#calculateDegreeOfSuccess() {\r\n\t\tconst dc = this.dc.value;\r\n\r\n\t\tif (this.rollTotal - dc >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS);\r\n\t\t}\r\n\r\n\t\tif (dc - this.rollTotal >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE);\r\n\t\t}\r\n\r\n\t\tif (this.rollTotal >= dc) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS);\r\n\t\t}\r\n\r\n\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE);\r\n\t}\r\n}\r\n", "export function getTemplateTokens(\r\n\tmeasuredTemplate,\r\n\t{ collisionOrigin, collisionType = \"move\" } = {},\r\n) {\r\n\tconst template =\r\n\t\tmeasuredTemplate instanceof MeasuredTemplateDocument\r\n\t\t\t? measuredTemplate.object\r\n\t\t\t: measuredTemplate;\r\n\r\n\tif (!canvas.scene) return [];\r\n\tconst { grid, dimensions } = canvas;\r\n\tif (!(grid && dimensions)) return [];\r\n\r\n\tif (!template?.highlightId) return [];\r\n\r\n\tconst gridHighlight = grid.getHighlightLayer(template.highlightId);\r\n\tif (!gridHighlight || grid.type !== CONST.GRID_TYPES.SQUARE) return [];\r\n\tconst origin = collisionOrigin ?? template.center;\r\n\r\n\t// Get all the tokens that are inside the highlight bounds\r\n\tconst tokens = canvas.tokens.quadtree.getObjects(\r\n\t\tgridHighlight.getLocalBounds(undefined, true),\r\n\t);\r\n\r\n\tconst gridSize = grid.size;\r\n\r\n\tconst containedTokens = [];\r\n\tfor (const token of tokens) {\r\n\t\tconst tokenDoc = token.document;\r\n\r\n\t\t// Collect the position of all grid squares that this token occupies as \"x.y\"\r\n\t\tconst tokenPositions = [];\r\n\t\tfor (let h = 0; h < tokenDoc.height; h++) {\r\n\t\t\tconst tokenX = Math.floor(token.x / gridSize) * gridSize;\r\n\t\t\tconst tokenY = Math.floor(token.y / gridSize) * gridSize;\r\n\r\n\t\t\tconst y = tokenY + h * gridSize;\r\n\t\t\ttokenPositions.push(`${tokenX}.${y}`);\r\n\t\t\tif (tokenDoc.width > 1) {\r\n\t\t\t\tfor (let w = 1; w < tokenDoc.width; w++) {\r\n\t\t\t\t\ttokenPositions.push(`${tokenX + w * gridSize}.${y}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const position of tokenPositions) {\r\n\t\t\t// Check if a position exists within this GridHiglight\r\n\t\t\tif (!gridHighlight.positions.has(position)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t// Position of cell's top-left corner, in pixels\r\n\t\t\tconst [gx, gy] = position.split(\".\").map((s) => Number(s));\r\n\t\t\t// Position of cell's center in pixels\r\n\t\t\tconst destination = {\r\n\t\t\t\tx: gx + dimensions.size * 0.5,\r\n\t\t\t\ty: gy + dimensions.size * 0.5,\r\n\t\t\t};\r\n\t\t\tif (destination.x < 0 || destination.y < 0) continue;\r\n\r\n\t\t\tconst hasCollision =\r\n\t\t\t\tcanvas.ready &&\r\n\t\t\t\tcollisionType &&\r\n\t\t\t\tCONFIG.Canvas.polygonBackends[collisionType].testCollision(\r\n\t\t\t\t\torigin,\r\n\t\t\t\t\tdestination,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttype: collisionType,\r\n\t\t\t\t\t\tmode: \"any\",\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\tif (!hasCollision) {\r\n\t\t\t\tcontainedTokens.push(token);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn containedTokens;\r\n}\r\n", "import {\r\n\tbindOnPreCreateSpellDamageChatMessage,\r\n\tlatestChatMessages,\r\n} from \"../shared/chat\";\r\nimport { roll3dDice } from \"../shared/dicesonice\";\r\nimport {\r\n\tgetFlag,\r\n\tmoduleFlagUpdate,\r\n\tsetFlag,\r\n\tupdateSourceFlag,\r\n} from \"../shared/flags\";\r\nimport { createChoicesHook, createHook } from \"../shared/hook\";\r\nimport { localize, subLocalize } from \"../shared/localize\";\r\nimport { deleteInMemory, getInMemory, setInMemory } from \"../shared/misc\";\r\nimport { warn } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport {\r\n\tapplyDamageFromMessage,\r\n\tonClickShieldBlock,\r\n} from \"../shared/pf2e/chat\";\r\nimport { DegreeOfSuccess } from \"../shared/pf2e/success\";\r\nimport { choiceSettingIsEnabled, getSetting } from \"../shared/settings\";\r\nimport { socketEmit, socketOff, socketOn } from \"../shared/socket\";\r\nimport { getTemplateTokens } from \"../shared/template\";\r\nimport { isActiveGM, isUserGM } from \"../shared/user\";\r\n\r\nconst SAVES = {\r\n\tfortitude: { icon: \"fa-solid fa-chess-rook\", label: \"PF2E.SavesFortitude\" },\r\n\treflex: { icon: \"fa-solid fa-person-running\", label: \"PF2E.SavesReflex\" },\r\n\twill: { icon: \"fa-solid fa-brain\", label: \"PF2E.SavesWill\" },\r\n};\r\n\r\nconst REROLL = {\r\n\thero: {\r\n\t\ticon: \"fa-solid fa-hospital-symbol\",\r\n\t\treroll: \"PF2E.RerollMenu.HeroPoint\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageHeroPoint\",\r\n\t},\r\n\tnew: {\r\n\t\ticon: \"fa-solid fa-dice\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepNew\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.new\",\r\n\t},\r\n\tlower: {\r\n\t\ticon: \"fa-solid fa-dice-one\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepLower\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.lower\",\r\n\t},\r\n\thigher: {\r\n\t\ticon: \"fa-solid fa-dice-six\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepHigher\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.higher\",\r\n\t},\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\nconst setPrecreateMessageHook = createHook(\r\n\t\"preCreateChatMessage\",\r\n\tpreCreateChatMessage,\r\n);\r\nconst setRenderMessageHook = createChoicesHook(\r\n\t\"renderChatMessage\",\r\n\trenderChatMessage,\r\n);\r\nconst setCreateTemplateHook = createHook(\r\n\t\"createMeasuredTemplate\",\r\n\tcreateMeasuredTemplate,\r\n);\r\n\r\nlet SOCKET = false;\r\n\r\nexport function registerTargetTokenHelper() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"target\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: setHooks,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"target-client\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"small\", \"big\"],\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) =>\r\n\t\t\t\t\tsetRenderMessageHook(value && getSetting(\"target\")),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"target-template\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) =>\r\n\t\t\t\t\tsetCreateTemplateHook(value && getSetting(\"target\")),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [],\r\n\t\tready: () => {\r\n\t\t\tif (getSetting(\"target\")) setHooks(true);\r\n\t\t\tfor (const { message, html } of latestChatMessages(10)) {\r\n\t\t\t\trenderChatMessage(message, html);\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setHooks(value) {\r\n\tsetPrecreateMessageHook(value);\r\n\tsetRenderMessageHook(value);\r\n\tsetCreateTemplateHook(value && getSetting(\"target-template\"));\r\n\r\n\tif (isUserGM()) {\r\n\t\tif (value && !SOCKET) {\r\n\t\t\tsocketOn(onSocket);\r\n\t\t\tSOCKET = true;\r\n\t\t} else if (!value && SOCKET) {\r\n\t\t\tsocketOff(onSocket);\r\n\t\t\tSOCKET = false;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tif (!isActiveGM()) return;\r\n\tswitch (packet.type) {\r\n\t\tcase \"target.update-save\":\r\n\t\t\tupdateMessageSave(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"target.update-applied\":\r\n\t\t\tupdateMessageApplied(packet);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nasync function createMeasuredTemplate(template, _, userId) {\r\n\tconst user = game.user;\r\n\tif (user.id !== userId) return;\r\n\r\n\tconst localize = subLocalize(\"target.menu\");\r\n\tconst item = template.item;\r\n\tconst actor = template.actor;\r\n\tconst self = !actor ? undefined : actor.token ?? actor.getActiveTokens()[0];\r\n\r\n\tconst data = {\r\n\t\ttitle: item?.name || localize(\"title\"),\r\n\t\tcontent: await renderTemplate(templatePath(\"target/template-menu\"), {\r\n\t\t\ti18n: localize,\r\n\t\t\tnoSelf: !self,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tselect: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-bullseye-arrow\"></i>',\r\n\t\t\t\tlabel: localize(\"target\"),\r\n\t\t\t\tcallback: (html) => ({\r\n\t\t\t\t\ttargets: html.find(\"[name=targets]:checked\").val(),\r\n\t\t\t\t\tself: html.find(\"[name=self]\").prop(\"checked\"),\r\n\t\t\t\t\tneutral: html.find(\"[name=neutral]\").prop(\"checked\"),\r\n\t\t\t\t}),\r\n\t\t\t},\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-toolbelt-target-template\",\r\n\t\twidth: 260,\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst alliance = actor ? actor.alliance : user.isGM ? \"opposition\" : \"party\";\r\n\tconst opposition =\r\n\t\talliance === \"party\"\r\n\t\t\t? \"opposition\"\r\n\t\t\t: alliance === \"opposition\"\r\n\t\t\t  ? \"party\"\r\n\t\t\t  : null;\r\n\r\n\tconst tokens = getTemplateTokens(template);\r\n\tconst targets = tokens.filter((token) => {\r\n\t\tconst validActor = token.actor?.isOfType(\"creature\", \"hazard\", \"vehicle\");\r\n\t\tif (!validActor) return false;\r\n\r\n\t\tif (token.document.hidden) return false;\r\n\r\n\t\tif (self && token === self) return result.self;\r\n\r\n\t\tconst targetAlliance = token.actor ? token.actor.alliance : token.alliance;\r\n\r\n\t\tif (targetAlliance === null) return result.neutral;\r\n\r\n\t\treturn (\r\n\t\t\tresult.targets === \"all\" ||\r\n\t\t\t(result.targets === \"allies\" && targetAlliance === alliance) ||\r\n\t\t\t(result.targets === \"enemies\" && targetAlliance === opposition)\r\n\t\t);\r\n\t});\r\n\r\n\tconst targetsIds = targets.map((token) => token.id);\r\n\tuser.updateTokenTargets(targetsIds);\r\n\tuser.broadcastActivity({ targets: targetsIds });\r\n}\r\n\r\nlet HEALINGS_REGEX;\r\nfunction isRegenMessage(message) {\r\n\tHEALINGS_REGEX ??= (() => {\r\n\t\tconst healings = [\r\n\t\t\tgame.i18n.localize(\r\n\t\t\t\t\"PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage\",\r\n\t\t\t),\r\n\t\t\tgame.i18n.localize(\r\n\t\t\t\t\"PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage\",\r\n\t\t\t),\r\n\t\t];\r\n\t\treturn new RegExp(`^<div>(${healings.join(\"|\")})</div>`);\r\n\t})();\r\n\treturn HEALINGS_REGEX.test(message.flavor);\r\n}\r\n\r\nfunction isValidDamageMessage(message) {\r\n\treturn !message.rolls[0].options.evaluatePersistent;\r\n}\r\n\r\nfunction preCreateChatMessage(message) {\r\n\tconst isDamageRoll = message.isDamageRoll;\r\n\tconst updates = [];\r\n\r\n\tif (isDamageRoll && !isValidDamageMessage(message)) return;\r\n\r\n\tif (isDamageRoll && !getFlag(message, \"target\")) {\r\n\t\tconst token = message.token;\r\n\t\tconst actor = token?.actor;\r\n\t\tconst isRegen = isRegenMessage(message);\r\n\r\n\t\tconst targets = isRegen\r\n\t\t\t? actor\r\n\t\t\t\t? [{ token: token.uuid, actor: actor.uuid }]\r\n\t\t\t\t: []\r\n\t\t\t: Array.from(\r\n\t\t\t\t\tgame.user.targets.map((target) => ({\r\n\t\t\t\t\t\ttoken: target.document.uuid,\r\n\t\t\t\t\t\tactor: target.actor.uuid,\r\n\t\t\t\t\t})),\r\n\t\t\t  );\r\n\r\n\t\tupdates.push([\"targets\", targets]);\r\n\t\tif (isRegen) updates.push([\"isRegen\", true]);\r\n\r\n\t\tif (message.rolls.length === 2) {\r\n\t\t\tconst rolls = message.rolls.filter((roll) => roll.options);\r\n\t\t\tconst splashRollIndex = rolls.findIndex(\r\n\t\t\t\t(roll) => roll.options.splashOnly,\r\n\t\t\t);\r\n\t\t\tconst regularRollIndex = rolls.findIndex(\r\n\t\t\t\t(roll) =>\r\n\t\t\t\t\t!roll.options.splashOnly &&\r\n\t\t\t\t\troll.options.damage?.modifiers.some(\r\n\t\t\t\t\t\t(modifier) => modifier.damageCategory === \"splash\",\r\n\t\t\t\t\t),\r\n\t\t\t);\r\n\r\n\t\t\tif (splashRollIndex !== -1 && regularRollIndex !== -1) {\r\n\t\t\t\tupdates.push([\"splashIndex\", splashRollIndex]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (\r\n\t\tisDamageRoll ||\r\n\t\tmessage.getFlag(\"pf2e\", \"context.type\") === \"spell-cast\"\r\n\t) {\r\n\t\tconst item = message.item;\r\n\t\tconst save = item && item.type === \"spell\" && item.system.defense?.save;\r\n\t\tif (save) {\r\n\t\t\tconst dc = (() => {\r\n\t\t\t\tif (!item.trickMagicEntry) return item.spellcasting?.statistic.dc.value;\r\n\t\t\t\treturn $(message.content).find(\"[data-action=spell-save]\").data()?.dc;\r\n\t\t\t})();\r\n\t\t\tif (typeof dc === \"number\") updates.push([\"save\", { ...save, dc }]);\r\n\t\t}\r\n\t}\r\n\r\n\tif (!updates.length) return;\r\n\r\n\tupdateSourceFlag(\r\n\t\tmessage,\r\n\t\t\"target\",\r\n\t\tupdates.reduce((acc, [key, value]) => {\r\n\t\t\tacc[key] = value;\r\n\t\t\treturn acc;\r\n\t\t}, {}),\r\n\t);\r\n}\r\n\r\nasync function renderChatMessage(message, html) {\r\n\tconst clientEnabled = choiceSettingIsEnabled(\"target-client\");\r\n\tdeleteInMemory(message, \"target.save\");\r\n\r\n\tif (clientEnabled && message.isDamageRoll) {\r\n\t\tif (!isValidDamageMessage(message)) return;\r\n\t\tawait renderDamageChatMessage(message, html);\r\n\t\trefreshMessage(message);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst item = message.item;\r\n\tif (!item || item.type !== \"spell\") return;\r\n\r\n\tif (clientEnabled && !item.damageKinds.size) {\r\n\t\tawait renderSpellChatMessage(message, html, item);\r\n\t\trefreshMessage(message);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (item.trickMagicEntry && item.system.defense?.save) {\r\n\t\thtml.find(\"[data-action=spell-damage]\").on(\"click\", () => {\r\n\t\t\tbindOnPreCreateSpellDamageChatMessage(message);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction refreshMessage(message) {\r\n\tPromise.all(\r\n\t\t[ui.chat, ui.chat._popout].map(async (chat) => {\r\n\t\t\tconst el = chat?.element[0]?.querySelector(\"#chat-log\");\r\n\t\t\tif (!el || (!chat.isAtBottom && message.user._id !== game.user._id))\r\n\t\t\t\treturn;\r\n\r\n\t\t\tawait chat._waitForImages();\r\n\t\t\tel.scrollTop = el.scrollHeight;\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const app of Object.values(message.apps)) {\r\n\t\tif (!(app instanceof ChatPopout)) continue;\r\n\t\tif (!app.rendered) continue;\r\n\r\n\t\tapp.setPosition();\r\n\t}\r\n}\r\n\r\nasync function renderSpellChatMessage(message, html, spell) {\r\n\tconst data = await getMessageData(message);\r\n\tif (!data) return;\r\n\r\n\tconst { targets, save } = data;\r\n\tconst msgContent = html.find(\".message-content\");\r\n\tconst cardBtns = msgContent.find(\".card-buttons\");\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tconst saveBtn = cardBtns.find(\"[data-action=spell-save]\");\r\n\t\tconst wrapper = $('<div class=\"pf2e-toolbelt-target-wrapper\"></div>');\r\n\t\tconst targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n\r\n\t\tconst targetsBtn =\r\n\t\t\t$(`<button class=\"pf2e-toolbelt-target-targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n\t\ttargetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n\t\twrapper.append(targetsBtn);\r\n\t\twrapper.append(saveBtn);\r\n\t\tcardBtns.prepend(wrapper);\r\n\t}\r\n\r\n\tif (spell?.area && !spell.traits.has(\"aura\")) {\r\n\t\tconst template = canvas.scene?.templates.some(\r\n\t\t\t(template) => template.message === message && template.isOwner,\r\n\t\t);\r\n\t\tif (template)\r\n\t\t\tcardBtns.find(\".owner-buttons .hidden.small\").removeClass(\"hidden\");\r\n\t}\r\n\r\n\tif (!targets.length) return;\r\n\r\n\tconst rowsTemplate = $('<div class=\"pf2e-toolbelt-target-spell\"></div>');\r\n\r\n\tfor (const { template } of targets) {\r\n\t\trowsTemplate.append(\"<hr>\");\r\n\t\trowsTemplate.append(template);\r\n\t}\r\n\r\n\tmsgContent.after(rowsTemplate);\r\n\r\n\taddHeaderListeners(message, rowsTemplate, save);\r\n}\r\n\r\nfunction addTargets(event, message) {\r\n\tevent.stopPropagation();\r\n\tconst targets = game.user.targets;\r\n\r\n\tsetFlag(\r\n\t\tmessage,\r\n\t\t\"target.targets\",\r\n\t\tArray.from(\r\n\t\t\ttargets.map((target) => ({\r\n\t\t\t\ttoken: target.document.uuid,\r\n\t\t\t\tactor: target.actor.uuid,\r\n\t\t\t})),\r\n\t\t),\r\n\t);\r\n}\r\n\r\nasync function renderDamageChatMessage(message, html) {\r\n\tconst data = await getMessageData(message);\r\n\tconst msgContent = html.find(\".message-content\");\r\n\tconst damageRows = msgContent.find(\".damage-application\");\r\n\r\n\tconst buttons = $('<div class=\"pf2e-toolbelt-target-buttons\"></div>');\r\n\r\n\tif (data?.targets.length && damageRows.length) {\r\n\t\tconst toggleDamageRow = () => {\r\n\t\t\tconst expanded = !!getInMemory(message, \"target.expanded\");\r\n\t\t\ttoggleBtn.toggleClass(\"collapse\", expanded);\r\n\t\t\tdamageRows.toggleClass(\"hidden\", !expanded);\r\n\t\t};\r\n\r\n\t\tconst toggleTooltip = localize(\"target.chat.toggle.tooltip\");\r\n\t\tconst toggleBtn = $(`<button class=\"toggle\" title=\"${toggleTooltip}\">\r\n    <i class=\"fa-solid fa-plus expand\"></i>\r\n    <i class=\"fa-solid fa-minus collapse\"></i>\r\n</button>`);\r\n\r\n\t\ttoggleDamageRow();\r\n\r\n\t\ttoggleBtn.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\t\t\tsetInMemory(\r\n\t\t\t\tmessage,\r\n\t\t\t\t\"target.expanded\",\r\n\t\t\t\t!getInMemory(message, \"target.expanded\"),\r\n\t\t\t);\r\n\t\t\ttoggleDamageRow();\r\n\t\t});\r\n\r\n\t\tbuttons.append(toggleBtn);\r\n\t}\r\n\r\n\tif (data?.isRegen !== true && (game.user.isGM || message.isAuthor)) {\r\n\t\tconst targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n\t\tconst targetsBtn = $(`<button class=\"targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n\t\ttargetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n\t\tbuttons.append(targetsBtn);\r\n\t}\r\n\r\n\thtml.find(\".dice-result .dice-total\").append(buttons);\r\n\r\n\tif (!data?.targets.length) return;\r\n\r\n\tconst clonedRows = damageRows.clone();\r\n\tif (!clonedRows.length) return;\r\n\r\n\tclonedRows\r\n\t\t.removeClass(\"damage-application\")\r\n\t\t.addClass(\"target-damage-application\");\r\n\r\n\tif (getSetting(\"target-client\") !== \"big\")\r\n\t\tclonedRows.find(\"button\").addClass(\"small\");\r\n\r\n\tclonedRows.find(\"[data-action]\").each(function () {\r\n\t\tconst action = this.dataset.action;\r\n\t\tthis.dataset.action = `target-${action}`;\r\n\t});\r\n\r\n\tconst { targets, save } = data;\r\n\tconst rowsTemplate = $('<div class=\"pf2e-toolbelt-target-damage\"></div>');\r\n\r\n\tfor (const { uuid, template, save, isOwner, applied = {} } of targets) {\r\n\t\trowsTemplate.append(\"<hr>\");\r\n\t\trowsTemplate.append(template);\r\n\r\n\t\tif (!isOwner) continue;\r\n\r\n\t\tconst isBasicSave = !!(save?.result && save.basic);\r\n\t\tconst clones = clonedRows.clone();\r\n\r\n\t\tclones.each((index, el) => {\r\n\t\t\tel.dataset.rollIndex = index;\r\n\t\t\tel.dataset.targetUuid = uuid;\r\n\r\n\t\t\tel.classList.toggle(\r\n\t\t\t\t\"applied\",\r\n\t\t\t\t!!applied[index] ||\r\n\t\t\t\t\t(isBasicSave && save.result.success === \"criticalSuccess\"),\r\n\t\t\t);\r\n\t\t\tif (isBasicSave) el.classList.add(save.result.success);\r\n\t\t});\r\n\r\n\t\trowsTemplate.append(clones);\r\n\t}\r\n\r\n\tmsgContent.after(rowsTemplate);\r\n\r\n\taddHeaderListeners(message, rowsTemplate, save);\r\n\trowsTemplate\r\n\t\t.find(\"button[data-action^=target-]\")\r\n\t\t.on(\"click\", (event) => onTargetButton(event, message));\r\n}\r\n\r\nfunction addHeaderListeners(message, html, save) {\r\n\thtml.find(\"[data-action=ping-target]\").on(\"click\", pingTarget);\r\n\thtml.find(\"[data-action=open-target-sheet]\").on(\"click\", openTargetSheet);\r\n\thtml\r\n\t\t.find(\"[data-action=roll-save]\")\r\n\t\t.on(\"click\", (event) => rollSave(event, message, save));\r\n\thtml\r\n\t\t.find(\"[data-action=reroll-save]\")\r\n\t\t.on(\"click\", (event) => rerollSave(event, message, save));\r\n}\r\n\r\nasync function getMessageData(message) {\r\n\tconst isGM = game.user.isGM;\r\n\tconst targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n\tconst showDC = isGM || game.settings.get(\"pf2e\", \"metagame_showDC\");\r\n\tconst showMods = isGM || game.settings.get(\"pf2e\", \"metagame_showBreakdowns\");\r\n\tconst showSuccess = isGM || game.settings.get(\"pf2e\", \"metagame_showResults\");\r\n\r\n\tconst save = (() => {\r\n\t\tconst flag = getFlag(message, \"target.save\");\r\n\t\tif (!flag) return;\r\n\t\treturn {\r\n\t\t\t...flag,\r\n\t\t\t...SAVES[flag.statistic],\r\n\t\t};\r\n\t})();\r\n\r\n\tif (!targetsFlag.length && !save) return;\r\n\r\n\tif (save) {\r\n\t\tconst saveLabel = game.i18n.format(\"PF2E.SavingThrowWithName\", {\r\n\t\t\tsaveName: game.i18n.localize(save.label),\r\n\t\t});\r\n\t\tconst saveDC = showDC\r\n\t\t\t? localize(\"target.chat.save.dcWithValue\", { dc: save.dc })\r\n\t\t\t: \"\";\r\n\t\tsave.tooltipLabel = `${saveLabel} ${saveDC}`;\r\n\t\tsave.tooltip = await renderTemplate(templatePath(\"target/save-tooltip\"), {\r\n\t\t\tcheck: save.tooltipLabel,\r\n\t\t});\r\n\t}\r\n\r\n\tconst targets = (\r\n\t\tawait Promise.all(\r\n\t\t\ttargetsFlag.map(async ({ token }) => {\r\n\t\t\t\tconst target = await fromUuid(token);\r\n\t\t\t\tconst targetId = target.id;\r\n\t\t\t\tconst actor = target.actor;\r\n\t\t\t\tif (!actor) return;\r\n\r\n\t\t\t\tconst isVisible = !actor.hasCondition(\"undetected\");\r\n\t\t\t\tif (!isGM && !isVisible) return;\r\n\r\n\t\t\t\tconst isOwner = actor.isOwner;\r\n\t\t\t\tconst hasPlayerOwner = actor.hasPlayerOwner;\r\n\t\t\t\tconst isFriendly = isOwner || hasPlayerOwner;\r\n\t\t\t\tconst hasSave = save && !!actor?.saves[save.statistic];\r\n\r\n\t\t\t\tconst targetSave = await (async () => {\r\n\t\t\t\t\tif (!hasSave) return;\r\n\r\n\t\t\t\t\tconst flag = getFlag(message, `target.saves.${targetId}`);\r\n\t\t\t\t\tif (!flag) return;\r\n\r\n\t\t\t\t\tconst rerolled = flag.rerolled;\r\n\t\t\t\t\tconst canReroll = hasSave && isOwner && !rerolled;\r\n\t\t\t\t\tconst successLabel = game.i18n.localize(\r\n\t\t\t\t\t\t`PF2E.Check.Result.Degree.Check.${flag.success}`,\r\n\t\t\t\t\t);\r\n\t\t\t\t\tconst offset = flag.value - save.dc;\r\n\t\t\t\t\tconst result =\r\n\t\t\t\t\t\tisFriendly || showSuccess\r\n\t\t\t\t\t\t\t? localize(\r\n\t\t\t\t\t\t\t\t\t`target.chat.save.result.${\r\n\t\t\t\t\t\t\t\t\t\tshowDC\r\n\t\t\t\t\t\t\t\t\t\t\t? \"withOffset\"\r\n\t\t\t\t\t\t\t\t\t\t\t: isFriendly\r\n\t\t\t\t\t\t\t\t\t\t\t  ? \"withoutOffsetWithDie\"\r\n\t\t\t\t\t\t\t\t\t\t\t  : \"withoutOffset\"\r\n\t\t\t\t\t\t\t\t\t}`,\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\tsuccess: successLabel,\r\n\t\t\t\t\t\t\t\t\t\toffset: offset >= 0 ? `+${offset}` : offset,\r\n\t\t\t\t\t\t\t\t\t\tdie: `<i class=\"fa-solid fa-dice-d20\"></i> ${flag.die}`,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t\t\t: undefined;\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\t...flag,\r\n\t\t\t\t\t\tcanReroll,\r\n\t\t\t\t\t\ttooltip: await renderTemplate(templatePath(\"target/save-tooltip\"), {\r\n\t\t\t\t\t\t\ti18n: subLocalize(\"target.chat.save\"),\r\n\t\t\t\t\t\t\tcheck: save.tooltipLabel,\r\n\t\t\t\t\t\t\tresult,\r\n\t\t\t\t\t\t\tmodifiers: isFriendly || showMods ? flag.modifiers : [],\r\n\t\t\t\t\t\t\tcanReroll,\r\n\t\t\t\t\t\t\trerolled: REROLL[rerolled],\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t};\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tconst templateSave = save && {\r\n\t\t\t\t\t...save,\r\n\t\t\t\t\tresult: targetSave,\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst anonymous = game.modules.get(\"anonymous\");\r\n\t\t\t\tconst canSeeName = isGM\r\n\t\t\t\t\t? true\r\n\t\t\t\t\t: anonymous?.active\r\n\t\t\t\t\t  ? anonymous.api.playersSeeName(target.actor)\r\n\t\t\t\t\t  : target.playersCanSeeName;\r\n\t\t\t\tconst name = canSeeName\r\n\t\t\t\t\t? target.name\r\n\t\t\t\t\t: anonymous?.active\r\n\t\t\t\t\t  ? anonymous.api.getName(target.actor)\r\n\t\t\t\t\t  : localize(\"unnamed\");\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tisOwner,\r\n\t\t\t\t\tcanSeeName,\r\n\t\t\t\t\thasPlayerOwner,\r\n\t\t\t\t\tuuid: token,\r\n\t\t\t\t\ttarget: target,\r\n\t\t\t\t\tsave: templateSave,\r\n\t\t\t\t\tapplied: getFlag(message, `target.applied.${targetId}`),\r\n\t\t\t\t\ttemplate: await renderTemplate(templatePath(\"target/row-header\"), {\r\n\t\t\t\t\t\tname,\r\n\t\t\t\t\t\tisGM,\r\n\t\t\t\t\t\tisOwner,\r\n\t\t\t\t\t\thasPlayerOwner,\r\n\t\t\t\t\t\tisHidden: !isVisible,\r\n\t\t\t\t\t\tuuid: token,\r\n\t\t\t\t\t\tshowSuccess: isFriendly || showSuccess,\r\n\t\t\t\t\t\tsave: hasSave && templateSave,\r\n\t\t\t\t\t\tcanReroll: targetSave?.canReroll,\r\n\t\t\t\t\t\trerolled: REROLL[targetSave?.rerolled],\r\n\t\t\t\t\t\ti18n: subLocalize(\"target.chat.row\"),\r\n\t\t\t\t\t}),\r\n\t\t\t\t};\r\n\t\t\t}),\r\n\t\t)\r\n\t).filter(Boolean);\r\n\r\n\tif (isGM) {\r\n\t\ttargets.sort((a, b) => a.hasPlayerOwner - b.hasPlayerOwner);\r\n\t} else {\r\n\t\ttargets.sort((a, b) =>\r\n\t\t\t!a.isOwner && !b.isOwner\r\n\t\t\t\t? b.canSeeName - a.canSeeName\r\n\t\t\t\t: b.isOwner - a.isOwner,\r\n\t\t);\r\n\t}\r\n\r\n\treturn { targets, save, isRegen: getFlag(message, \"target.isRegen\") };\r\n}\r\n\r\nasync function getTargetFromEvent(event) {\r\n\tconst { targetUuid } =\r\n\t\tevent.currentTarget.closest(\"[data-target-uuid]\").dataset;\r\n\treturn fromUuid(targetUuid);\r\n}\r\n\r\nfunction isRollingSave(message, target) {\r\n\treturn getInMemory(message, `target.save.${target.id}`);\r\n}\r\n\r\nfunction setRollingSave(message, target) {\r\n\tsetInMemory(message, `target.save.${target.id}`, true);\r\n}\r\n\r\nasync function rerollSave(event, message, { dc }) {\r\n\tconsole.log(message);\r\n\r\n\tconst target = await getTargetFromEvent(event);\r\n\tconst actor = target?.actor;\r\n\tif (!actor) return;\r\n\r\n\tif (isRollingSave(message, target)) return;\r\n\r\n\tconst flag = getFlag(message, `target.saves.${target.id}`);\r\n\tif (!flag?.roll || flag.rerolled) return;\r\n\r\n\tconst heroPoints = actor.isOfType(\"character\") ? actor.heroPoints.value : 0;\r\n\r\n\tconst template = Object.entries(REROLL)\r\n\t\t.map(([type, { icon, reroll }]) => {\r\n\t\t\tif (type === \"hero\" && !heroPoints) return;\r\n\t\t\tconst label = game.i18n.localize(reroll);\r\n\t\t\treturn `<label><input type=\"radio\" name=\"reroll\" value=\"${type}\"><i class=\"${icon}\"></i> ${label}</label>`;\r\n\t\t})\r\n\t\t.filter(Boolean)\r\n\t\t.join(\"\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-rotate rotate\"></i>',\r\n\t\t\tlabel: \"reroll\",\r\n\t\t\tcallback: (html) => html.find(\"[name=reroll]:checked\").val() ?? null,\r\n\t\t},\r\n\t\tno: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n\t\t\tlabel: \"cancel\",\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst reroll = await Dialog.wait(\r\n\t\t{\r\n\t\t\ttitle: `${target.name} - ${localize(\r\n\t\t\t\t\"target.chat.save.reroll.confirm.title\",\r\n\t\t\t)}`,\r\n\t\t\tcontent: template,\r\n\t\t\tbuttons,\r\n\t\t\tclose: () => null,\r\n\t\t},\r\n\t\t{\r\n\t\t\tid: `pf2e-toolbelt-target-save-reroll-dialog-${target.id}`,\r\n\t\t},\r\n\t);\r\n\r\n\tif (!reroll) return;\r\n\r\n\tconst isHeroReroll = reroll === \"hero\";\r\n\tconst keep = isHeroReroll ? \"new\" : reroll;\r\n\r\n\tif (isHeroReroll) {\r\n\t\tconst { value, max } = actor.heroPoints;\r\n\r\n\t\tif (value < 1) {\r\n\t\t\twarn(\"target.chat.save.reroll.noPoints\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tawait actor.update({\r\n\t\t\t\"system.resources.heroPoints.value\": Math.clamped(value - 1, 0, max),\r\n\t\t});\r\n\t}\r\n\r\n\tsetRollingSave(message, target);\r\n\r\n\tconst oldRoll = Roll.fromJSON(flag.roll);\r\n\tconst unevaluatedNewRoll = oldRoll.clone();\r\n\tunevaluatedNewRoll.options.isReroll = true;\r\n\tHooks.callAll(\r\n\t\t\"pf2e.preReroll\",\r\n\t\tRoll.fromJSON(flag.roll),\r\n\t\tunevaluatedNewRoll,\r\n\t\tisHeroReroll,\r\n\t\tkeep,\r\n\t);\r\n\r\n\tconst newRoll = await unevaluatedNewRoll.evaluate({ async: true });\r\n\tawait roll3dDice(newRoll);\r\n\r\n\tHooks.callAll(\r\n\t\t\"pf2e.reroll\",\r\n\t\tRoll.fromJSON(flag.roll),\r\n\t\tnewRoll,\r\n\t\tisHeroReroll,\r\n\t\tkeep,\r\n\t);\r\n\r\n\tconst keptRoll =\r\n\t\t(keep === \"higher\" && oldRoll.total > newRoll.total) ||\r\n\t\t(keep === \"lower\" && oldRoll.total < newRoll.total)\r\n\t\t\t? oldRoll\r\n\t\t\t: newRoll;\r\n\r\n\tif (keptRoll === newRoll) {\r\n\t\tconst success = new DegreeOfSuccess(newRoll, dc, flag.dosAdjustments);\r\n\t\tkeptRoll.options.degreeOfSuccess = success.value;\r\n\t}\r\n\r\n\tconst packet = {\r\n\t\ttype: \"target.update-save\",\r\n\t\ttarget: target.id,\r\n\t\tdata: {\r\n\t\t\tvalue: keptRoll.total,\r\n\t\t\tdie: keptRoll.dice[0].total,\r\n\t\t\tsuccess: keptRoll.degreeOfSuccess,\r\n\t\t\troll: JSON.stringify(keptRoll.toJSON()),\r\n\t\t\tdosAdjustments: deepClone(flag.dosAdjustments),\r\n\t\t\tmodifiers: deepClone(flag.modifiers),\r\n\t\t\trerolled: reroll,\r\n\t\t},\r\n\t};\r\n\r\n\tif (keptRoll.options.keeleyAdd10) {\r\n\t\tpacket.data.modifiers.push({\r\n\t\t\tlabel: localize(\"target.chat.save.reroll.keeley\"),\r\n\t\t\tmodifier: 10,\r\n\t\t});\r\n\t}\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tpacket.message = message;\r\n\t\tupdateMessageSave(packet);\r\n\t} else {\r\n\t\tpacket.message = message.id;\r\n\t\tsocketEmit(packet);\r\n\t}\r\n}\r\n\r\nasync function rollSave(event, message, { dc, statistic }) {\r\n\tconst target = await getTargetFromEvent(event);\r\n\tconst actor = target?.actor;\r\n\tif (!actor) return;\r\n\r\n\tif (isRollingSave(message, target)) return;\r\n\r\n\tconst save = actor.saves[statistic];\r\n\tif (!save) return;\r\n\r\n\tsetRollingSave(message, target);\r\n\r\n\tconst item = (() => {\r\n\t\tconst item = message.item;\r\n\t\tif (item) return item;\r\n\r\n\t\tconst messageId = getFlag(message, \"target.messageId\");\r\n\t\tif (!messageId) return;\r\n\r\n\t\tconst otherMessage = game.messages.get(messageId);\r\n\t\tif (!otherMessage) return;\r\n\r\n\t\treturn otherMessage.item;\r\n\t})();\r\n\r\n\tconst skipDefault = !game.user.settings.showCheckDialogs;\r\n\r\n\tconst packet = {\r\n\t\ttype: \"target.update-save\",\r\n\t\ttarget: target.id,\r\n\t};\r\n\r\n\tsave.check.roll({\r\n\t\tdc: { value: dc },\r\n\t\titem,\r\n\t\torigin: actor,\r\n\t\tskipDialog: event.shiftKey ? !skipDefault : skipDefault,\r\n\t\tcreateMessage: false,\r\n\t\tcallback: async (roll, __, msg) => {\r\n\t\t\tawait roll3dDice(roll);\r\n\t\t\tpacket.data = {\r\n\t\t\t\tvalue: roll.total,\r\n\t\t\t\tdie: roll.dice[0].total,\r\n\t\t\t\tsuccess: roll.degreeOfSuccess,\r\n\t\t\t\troll: JSON.stringify(roll.toJSON()),\r\n\t\t\t\tdosAdjustments: msg.getFlag(\"pf2e\", \"context.dosAdjustments\"),\r\n\t\t\t\tmodifiers: msg\r\n\t\t\t\t\t.getFlag(\"pf2e\", \"modifiers\")\r\n\t\t\t\t\t.filter((modifier) => modifier.enabled)\r\n\t\t\t\t\t.map(({ label, modifier }) => ({ label, modifier })),\r\n\t\t\t};\r\n\r\n\t\t\tif (game.user.isGM || message.isAuthor) {\r\n\t\t\t\tpacket.message = message;\r\n\t\t\t\tupdateMessageSave(packet);\r\n\t\t\t} else {\r\n\t\t\t\tpacket.message = message.id;\r\n\t\t\t\tsocketEmit(packet);\r\n\t\t\t}\r\n\t\t},\r\n\t});\r\n}\r\n\r\nasync function updateMessageSave({ message, target, data }) {\r\n\tif (typeof message === \"string\") {\r\n\t\tmessage = game.messages.get(message);\r\n\t\tif (!message) return;\r\n\t}\r\n\r\n\tif (typeof data.success === \"number\") {\r\n\t\tdata.success = DEGREE_OF_SUCCESS[data.success];\r\n\t}\r\n\r\n\tawait setFlag(message, `target.saves.${target}`, deepClone(data));\r\n}\r\n\r\nasync function openTargetSheet(event) {\r\n\tconst target = await getTargetFromEvent(event);\r\n\tif (!target) return;\r\n\r\n\ttarget.actor?.sheet.render(true);\r\n}\r\n\r\nasync function pingTarget(event) {\r\n\tif (!canvas.ready) return;\r\n\r\n\tconst target = await getTargetFromEvent(event);\r\n\tif (!target) return;\r\n\r\n\tcanvas.ping(target.center);\r\n}\r\n\r\nasync function onTargetButton(event, message) {\r\n\tconst btn = event.currentTarget;\r\n\tconst { rollIndex, targetUuid } = btn.closest(\"[data-target-uuid]\").dataset;\r\n\tconst target = await fromUuid(targetUuid);\r\n\tif (!target) return;\r\n\r\n\tconst type = btn.dataset.action;\r\n\r\n\tif (type === \"target-shield-block\") {\r\n\t\tonClickShieldBlock(target, btn, message.element);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst multiplier =\r\n\t\ttype === \"target-apply-healing\"\r\n\t\t\t? -1\r\n\t\t\t: type === \"target-half-damage\"\r\n\t\t\t  ? 0.5\r\n\t\t\t  : type === \"target-apply-damage\"\r\n\t\t\t\t  ? 1\r\n\t\t\t\t  : type === \"target-double-damage\"\r\n\t\t\t\t\t  ? 2\r\n\t\t\t\t\t  : 3;\r\n\r\n\tapplyDamageFromMessage(target, {\r\n\t\tmessage,\r\n\t\tmultiplier,\r\n\t\taddend: 0,\r\n\t\tpromptModifier: event.shiftKey,\r\n\t\trollIndex: Number(rollIndex),\r\n\t});\r\n}\r\n\r\nexport function onDamageApplied(message, tokenId, rollIndex) {\r\n\tconst updates = {};\r\n\tmoduleFlagUpdate(updates, `target.applied.${tokenId}.${rollIndex}`, true);\r\n\r\n\tconst splashRollIndex = getFlag(message, \"target.splashIndex\");\r\n\tif (splashRollIndex !== undefined) {\r\n\t\tconst regularRollIndex = splashRollIndex === 0 ? 1 : 0;\r\n\r\n\t\tif (rollIndex === splashRollIndex) {\r\n\t\t\tmoduleFlagUpdate(\r\n\t\t\t\tupdates,\r\n\t\t\t\t`target.applied.${tokenId}.${regularRollIndex}`,\r\n\t\t\t\ttrue,\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tmoduleFlagUpdate(\r\n\t\t\t\tupdates,\r\n\t\t\t\t`target.applied.${tokenId}.${splashRollIndex}`,\r\n\t\t\t\ttrue,\r\n\t\t\t);\r\n\r\n\t\t\tconst targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n\t\t\tfor (const target of targetsFlag) {\r\n\t\t\t\tconst targetId = target.token?.split(\".\").at(-1);\r\n\t\t\t\tif (targetId === tokenId) continue;\r\n\r\n\t\t\t\tmoduleFlagUpdate(\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t`target.applied.${targetId}.${regularRollIndex}`,\r\n\t\t\t\t\ttrue,\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tupdateMessageApplied({ message, updates });\r\n\t} else {\r\n\t\tsocketEmit({\r\n\t\t\ttype: \"target.update-applied\",\r\n\t\t\tmessage: message.id,\r\n\t\t\tupdates,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction updateMessageApplied({ message, updates }) {\r\n\tif (typeof message === \"string\") {\r\n\t\tmessage = game.messages.get(message);\r\n\t\tif (!message) return;\r\n\t}\r\n\tmessage.update(updates);\r\n}\r\n", "import { getSetting } from \"../shared/settings\";\r\n\r\nlet CREATE_HOOK = null;\r\nlet UPDATE_HOOK = null;\r\n\r\nexport function registerUnided() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"unided\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"create\", \"all\"],\r\n\t\t\t\tonChange: setHooks,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-unided\"],\r\n\t\tinit: () => {\r\n\t\t\tsetHooks();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setHooks(value) {\r\n\tconst settingValue = value ?? getSetting(\"unided\");\r\n\r\n\tif (settingValue === \"disabled\") {\r\n\t\tif (CREATE_HOOK) {\r\n\t\t\tHooks.off(\"preCreateItem\", CREATE_HOOK);\r\n\t\t\tCREATE_HOOK = null;\r\n\t\t}\r\n\t\tif (UPDATE_HOOK) {\r\n\t\t\tHooks.off(\"preUpdateItem\", UPDATE_HOOK);\r\n\t\t\tUPDATE_HOOK = null;\r\n\t\t}\r\n\t} else {\r\n\t\tif (!CREATE_HOOK) {\r\n\t\t\tCREATE_HOOK = Hooks.on(\"preCreateItem\", preCreateItem);\r\n\t\t}\r\n\t\tif (settingValue === \"all\" && !UPDATE_HOOK) {\r\n\t\t\tUPDATE_HOOK = Hooks.on(\"preUpdateItem\", preUpdateItem);\r\n\t\t} else if (settingValue !== \"all\" && UPDATE_HOOK) {\r\n\t\t\tHooks.off(\"preUpdateItem\", UPDATE_HOOK);\r\n\t\t\tUPDATE_HOOK = null;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction preCreateItem(item) {\r\n\tif (!item.img || !item.isOfType(\"physical\")) return;\r\n\titem._source.system.identification.unidentified.img = item.img;\r\n}\r\n\r\nfunction preUpdateItem(item, changes) {\r\n\tif (!item.isOfType(\"physical\") || !(\"img\" in changes)) return;\r\n\tsetProperty(changes, \"system.identification.unidentified.img\", changes.img);\r\n}\r\n", "import { createHook } from \"../shared/hook\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\"updateCombat\", updateCombat);\r\n\r\nexport function registerUntarget() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"force-untarget\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"untarget\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup() {\r\n\tsetHook(getSetting(\"force-untarget\") || getSetting(\"untarget\"));\r\n}\r\n\r\nfunction updateCombat(_, data) {\r\n\tif (!(\"turn\" in data) && !(\"round\" in data)) return;\r\n\r\n\tconst user = game.user;\r\n\tuser.updateTokenTargets();\r\n\tuser.broadcastActivity({ targets: [] });\r\n}\r\n", "import { subLocalize } from \"../shared/localize\";\r\nimport { templatePath } from \"../shared/path\";\r\n\r\nconst localize = subLocalize(\"macros.condition\");\r\n\r\nexport async function permaConditionEffect(actor) {\r\n\tconst callback = (html, type) => {\r\n\t\tconst condition = html.find(\"[name=condition]\");\r\n\t\tconst { name, slug, img } = condition.find(\":selected\").data();\r\n\r\n\t\treturn {\r\n\t\t\ttype,\r\n\t\t\tslug,\r\n\t\t\timg,\r\n\t\t\tname:\r\n\t\t\t\thtml.find(\"[name=name]\").val().trim() ||\r\n\t\t\t\tlocalize(\"effect-name\", { condition: name }),\r\n\t\t\tuuid: condition.val(),\r\n\t\t\tbadge: Number(html.find(\"[name=badge]\").val() || 1),\r\n\t\t\tunidentified: html.find(\"[name=unidentified]\").prop(\"checked\"),\r\n\t\t};\r\n\t};\r\n\r\n\tconst buttons = {\r\n\t\tgenerate: {\r\n\t\t\ticon: '<i class=\"fas fa-suitcase\"></i>',\r\n\t\t\tlabel: localize(\"generate\"),\r\n\t\t\tcallback: (html) => callback(html, \"generate\"),\r\n\t\t},\r\n\t\tadd: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-user\"></i>',\r\n\t\t\tlabel: localize(\"add\"),\r\n\t\t\tcallback: (html) => callback(html, \"add\"),\r\n\t\t},\r\n\t};\r\n\r\n\tconst conditions = Array.from(game.pf2e.ConditionManager.conditions.values());\r\n\tconst withBadge = new Set(\r\n\t\tconditions\r\n\t\t\t.filter((condition) => !!condition.badge)\r\n\t\t\t.map((condition) => condition.slug),\r\n\t);\r\n\r\n\tconst content = await renderTemplate(templatePath(\"macros/condition\"), {\r\n\t\ti18n: localize,\r\n\t\tconditions: Array.from(\r\n\t\t\tnew Set(conditions.sort((a, b) => a.name.localeCompare(b.name))),\r\n\t\t),\r\n\t});\r\n\r\n\tconst setInputs = (html) => {\r\n\t\tconst { name, slug } = html.find(\"[name=condition] :selected\").data();\r\n\t\thtml\r\n\t\t\t.find(\"[name=name]\")\r\n\t\t\t.prop(\"placeholder\", localize(\"effect-name\", { condition: name }));\r\n\r\n\t\tconst hasBadge = withBadge.has(slug);\r\n\t\tconst badge = html.find(\"[name=badge]\");\r\n\t\tbadge.prop(\"disabled\", !hasBadge);\r\n\t\tif (!hasBadge) badge.val(1);\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(\r\n\t\t{\r\n\t\t\tbuttons,\r\n\t\t\tcontent,\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tclose: () => null,\r\n\t\t\trender: (html) => {\r\n\t\t\t\tsetInputs(html);\r\n\t\t\t\thtml.find(\"[name=condition]\").on(\"change\", () => setInputs(html));\r\n\t\t\t},\r\n\t\t},\r\n\t\t{\r\n\t\t\tid: \"pf2e-toolbelt-macros-condition\",\r\n\t\t\twidth: 320,\r\n\t\t},\r\n\t);\r\n\r\n\tif (!result) return;\r\n\r\n\tconst rule = {\r\n\t\tinMemoryOnly: true,\r\n\t\tkey: \"GrantItem\",\r\n\t\tuuid: result.uuid,\r\n\t};\r\n\r\n\tif (result.badge > 1 && withBadge.has(result.slug)) {\r\n\t\trule.alterations = [\r\n\t\t\t{\r\n\t\t\t\tmode: \"override\",\r\n\t\t\t\tproperty: \"badge-value\",\r\n\t\t\t\tvalue: result.badge,\r\n\t\t\t},\r\n\t\t];\r\n\t}\r\n\r\n\tconst source = {\r\n\t\tname: result.name,\r\n\t\ttype: \"effect\",\r\n\t\timg: result.img,\r\n\t\tsystem: {\r\n\t\t\trules: [rule],\r\n\t\t\tunidentified: result.unidentified,\r\n\t\t},\r\n\t};\r\n\r\n\tif (result.type === \"generate\" || !actor) await Item.create(source);\r\n\telse await actor.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n", "import { registerArp } from \"./features/arp\";\r\nimport { registerDebug } from \"./features/debug\";\r\nimport { registerEffectsPanelHelper } from \"./features/effects\";\r\nimport { registerGiveth } from \"./features/giveth\";\r\nimport { registerHeroActions } from \"./features/hero\";\r\nimport { registerInventory } from \"./features/inventory\";\r\nimport { registerKnowledges } from \"./features/knowledges\";\r\nimport { registerMerge } from \"./features/merge\";\r\nimport { registerNobulk } from \"./features/nobulk\";\r\nimport { registerShare } from \"./features/share\";\r\nimport { registerStances } from \"./features/stances\";\r\nimport { registerSpellsSummary } from \"./features/summary\";\r\nimport { registerTargetTokenHelper } from \"./features/target\";\r\nimport { registerUnided } from \"./features/unided\";\r\nimport { registerUntarget } from \"./features/untarget\";\r\nimport { permaConditionEffect } from \"./macros/condition\";\r\nimport { MODULE_ID } from \"./module\";\r\nimport { localize } from \"./shared/localize\";\r\nimport { warn } from \"./shared/notification\";\r\nimport { isUserGM } from \"./shared/user\";\r\n\r\nconst FEATURES = [\r\n\tregisterArp(),\r\n\tregisterNobulk(),\r\n\tregisterGiveth(),\r\n\tregisterKnowledges(),\r\n\tregisterUnided(),\r\n\tregisterMerge(),\r\n\tregisterEffectsPanelHelper(),\r\n\tregisterSpellsSummary(),\r\n\tregisterStances(),\r\n\tregisterHeroActions(),\r\n\tregisterShare(),\r\n\tregisterTargetTokenHelper(),\r\n\tregisterUntarget(),\r\n\tregisterInventory(),\r\n\tregisterDebug(),\r\n];\r\n\r\nconst CONFLICTS = new Set();\r\n\r\nlet firstClientSetting = null;\r\n\r\nHooks.once(\"init\", () => {\r\n\tconst isGM = isUserGM();\r\n\r\n\tconst settings = FEATURES.flatMap(({ settings = [] }) =>\r\n\t\tsettings.map((setting) => {\r\n\t\t\tconst key = setting.name;\r\n\r\n\t\t\tif (setting.choices) {\r\n\t\t\t\tsetting.choices = setting.choices.reduce((choices, choice) => {\r\n\t\t\t\t\tchoices[choice] = settingPath(key, `choices.${choice}`);\r\n\t\t\t\t\treturn choices;\r\n\t\t\t\t}, {});\r\n\t\t\t}\r\n\r\n\t\t\tsetting.key = key;\r\n\t\t\tsetting.scope ??= \"world\";\r\n\t\t\tsetting.config ??= true;\r\n\t\t\tsetting.name = settingPath(key, \"name\");\r\n\t\t\tsetting.hint = settingPath(key, \"hint\");\r\n\r\n\t\t\treturn setting;\r\n\t\t}),\r\n\t);\r\n\r\n\tconst [worldSettings, clientSettings] = [\"world\", \"client\"].map((scope) =>\r\n\t\tsettings.filter((settings) => settings.scope === scope),\r\n\t);\r\n\r\n\tfor (const setting of [worldSettings, clientSettings].flat()) {\r\n\t\tgame.settings.register(MODULE_ID, setting.key, setting);\r\n\t}\r\n\r\n\tif (isGM) {\r\n\t\tfirstClientSetting = clientSettings[0].key;\r\n\t\tHooks.on(\"renderSettingsConfig\", renderSettingsConfig);\r\n\t}\r\n\r\n\tconst module = game.modules.get(MODULE_ID);\r\n\tmodule.api = {\r\n\t\tmacros: {\r\n\t\t\tpermaConditionEffect,\r\n\t\t},\r\n\t};\r\n\r\n\tfor (const feature of FEATURES) {\r\n\t\tconst { init, conflicts = [], api, name } = feature;\r\n\r\n\t\tif (isGM) {\r\n\t\t\tfor (const id of conflicts) {\r\n\t\t\t\tconst conflictingModule = game.modules.get(id);\r\n\t\t\t\tif (conflictingModule?.active) {\r\n\t\t\t\t\tfeature.conflicting = true;\r\n\t\t\t\t\tCONFLICTS.add(conflictingModule.title);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (api && name) module.api[name] = api;\r\n\r\n\t\tif (!feature.conflicting && init) init(isGM);\r\n\t}\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n\tconst isGM = game.user.isGM;\r\n\r\n\tfor (const { conflicting, ready } of FEATURES) {\r\n\t\tif (!conflicting && ready) ready(isGM);\r\n\t}\r\n\r\n\tif (isGM) {\r\n\t\tfor (const conflict of CONFLICTS) {\r\n\t\t\twarn(\"module-conflict\", { name: conflict }, true);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nfunction settingPath(setting, key) {\r\n\treturn `${MODULE_ID}.settings.${setting}.${key}`;\r\n}\r\n\r\nfunction renderSettingsConfig(_, html) {\r\n\tif (!firstClientSetting) return;\r\n\r\n\tconst group = html.find(\r\n\t\t`.tab[data-tab=${MODULE_ID}] [data-setting-id=\"${MODULE_ID}.${firstClientSetting}\"]`,\r\n\t);\r\n\tgroup.before(`<h3>${localize(\"settings.client\")}</h3>`);\r\n}\r\n"],
  "mappings": "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",
  "names": ["weapon", "enabled", "key", "getData", "onRender", "addEvents", "setup", "canvas", "target", "isValidActor", "qty", "giveth", "localize", "MODULE_ID", "setHook", "onSocket", "localize", "document", "nb", "error", "result", "enabled", "setup", "enabled", "onRender", "item", "onDragStart", "onDragEnd", "getData", "localize", "setHook", "addEvents", "lores", "localize", "damage", "Roll", "setHook", "tooltip", "roll", "flavor", "index", "actor", "renderCharacterSheetPF2e", "setup", "localize", "setup", "enabled", "getData", "addEvents", "entry", "spells", "charges", "token", "roll", "renderChatMessage", "SOCKET", "onSocket", "localize", "isDamageRoll", "getMessageData", "template", "save", "reroll", "item", "setHooks", "setHook", "setup", "localize", "settings"]
}
