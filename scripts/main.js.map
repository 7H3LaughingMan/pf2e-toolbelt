{
  "version": 3,
  "sources": ["../src/shared/item.js", "../src/module.js", "../src/shared/libwrapper.js", "../src/shared/localize.js", "../src/shared/notification.js", "../src/shared/settings.js", "../src/features/arp.js", "../src/shared/hook.js", "../src/features/debug.js", "../src/features/effects.js", "../src/apps/giveth/popup.js", "../src/shared/misc.js", "../src/shared/path.js", "../src/shared/actor.js", "../src/shared/flags.js", "../src/shared/chat.js", "../src/shared/socket.js", "../src/shared/user.js", "../src/features/giveth.js", "../src/apps/hero/trade.js", "../src/features/hero.js", "../src/shared/draggable.js", "../src/features/inventory.js", "../src/apps/knowledges/lores.js", "../src/features/knowledges.js", "../src/apps/merge/multi.js", "../src/shared/pf2e/classes.js", "../src/features/merge.js", "../src/features/nobulk.js", "../src/features/share.js", "../src/features/stances.js", "../src/shared/pf2e/misc.js", "../src/features/summary.js", "../src/shared/dicesonice.js", "../src/shared/pf2e/actor.js", "../src/shared/pf2e/dom.js", "../src/shared/pf2e/rules.js", "../src/shared/pf2e/chat.js", "../src/shared/pf2e/success.js", "../src/shared/template.js", "../src/features/target.js", "../src/features/unided.js", "../src/features/untarget.js", "../src/macros/condition.js", "../src/main.js"],
  "sourcesContent": ["export const HANDWRAPS_SLUG = \"handwraps-of-mighty-blows\";\r\n\r\nfunction getSourceId(doc) {\r\n\treturn doc.getFlag(\"core\", \"sourceId\");\r\n}\r\n\r\nfunction includesSourceId(doc, list) {\r\n\tconst sourceId = getSourceId(doc);\r\n\treturn sourceId ? list.includes(sourceId) : false;\r\n}\r\n\r\nfunction getItemSourceIdCondition(sourceId) {\r\n\treturn Array.isArray(sourceId)\r\n\t\t? (item) => includesSourceId(item, sourceId)\r\n\t\t: (item) => getSourceId(item) === sourceId;\r\n}\r\n\r\nexport function getItems(actor, itemTypes = []) {\r\n\tconst types = typeof itemTypes === \"string\" ? [itemTypes] : itemTypes;\r\n\treturn types.length\r\n\t\t? types.flatMap((type) => actor.itemTypes[type])\r\n\t\t: actor.items;\r\n}\r\n\r\nexport function hasItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).some(getItemSourceIdCondition(sourceId));\r\n}\r\n\r\nexport function getItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).find(getItemSourceIdCondition(sourceId));\r\n}\r\n\r\nexport function canBeInvested(item) {\r\n\treturn item.traits.has(\"invested\");\r\n}\r\n\r\nexport function hasWornSlot(item) {\r\n\treturn item.system.equipped.inSlot != null;\r\n}\r\n\r\nfunction isWornAs(item) {\r\n\treturn item.system.usage.type === \"worn\" && item.system.equipped.inSlot;\r\n}\r\n\r\nexport function isInvestedOrWornAs(item) {\r\n\treturn item.isInvested || isWornAs(item);\r\n}\r\n\r\nexport function isHandwrapsOfMightyBlows(item) {\r\n\treturn (\r\n\t\titem.isOfType(\"weapon\") &&\r\n\t\titem.slug === HANDWRAPS_SLUG &&\r\n\t\titem.category === \"unarmed\"\r\n\t);\r\n}\r\n\r\nexport function isHeld(item) {\r\n\treturn item.system.usage.type === \"held\";\r\n}\r\n\r\nexport function isTwoHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-two-hands\";\r\n}\r\n\r\nexport function isOneHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-one-hand\";\r\n}\r\n\r\nfunction inSlotValue(item, value) {\r\n\tconst usage = item.system.usage;\r\n\treturn usage.type === \"worn\" && usage.where ? value : undefined;\r\n}\r\n\r\nfunction toggleInvestedValue(item, invest) {\r\n\tconst value = invest ?? !item.system.equipped.invested;\r\n\treturn item.traits.has(\"invested\") ? value : undefined;\r\n}\r\n\r\nexport function itemCarryUpdate(\r\n\titem,\r\n\t{ carryType = \"worn\", handsHeld = 0, inSlot, invested, containerId },\r\n) {\r\n\tconst update = {\r\n\t\t_id: item.id,\r\n\t\tsystem: {\r\n\t\t\tequipped: {\r\n\t\t\t\tcarryType: carryType,\r\n\t\t\t\thandsHeld: handsHeld,\r\n\t\t\t\tinSlot: inSlotValue(item, inSlot),\r\n\t\t\t\tinvested: toggleInvestedValue(item, invested),\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\r\n\tif (containerId !== undefined) {\r\n\t\tupdate.system.containerId = containerId;\r\n\t}\r\n\r\n\treturn update;\r\n}\r\n", "export const MODULE_ID = \"pf2e-toolbelt\";\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function registerWrapper(path, callback, type = \"WRAPPER\") {\r\n\treturn libWrapper.register(MODULE_ID, path, callback, type);\r\n}\r\n\r\nexport function unregisterWrapper(id) {\r\n\tlibWrapper.unregister(MODULE_ID, id);\r\n}\r\n\r\nexport function wrapperError(feature, path) {\r\n\tconsole.error(\r\n\t\t`an error occured in the feature '${feature}' of the module '${MODULE_ID}' with the wrapper: '${path}'`,\r\n\t);\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\nimport { error, info, warn } from \"./notification\";\r\n\r\nexport function localize(...args) {\r\n\tlet [key, data] = args;\r\n\tkey = `${MODULE_ID}.${key}`;\r\n\tif (data) return game.i18n.format(key, data);\r\n\treturn game.i18n.localize(key);\r\n}\r\n\r\nexport function hasLocalization(key) {\r\n\treturn game.i18n.has(`${MODULE_ID}.${key}`, false);\r\n}\r\n\r\nexport function localizePath(key) {\r\n\treturn `${MODULE_ID}.${key}`;\r\n}\r\n\r\nexport function subLocalize(subKey) {\r\n\tconst fn = (...args) => localize(`${subKey}.${args[0]}`, args[1]);\r\n\r\n\tObject.defineProperties(fn, {\r\n\t\twarn: {\r\n\t\t\tvalue: (...args) => warn(`${subKey}.${args[0]}`, args[1], args[2]),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tinfo: {\r\n\t\t\tvalue: (...args) => info(`${subKey}.${args[0]}`, args[1], args[2]),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\terror: {\r\n\t\t\tvalue: (...args) => error(`${subKey}.${args[0]}`, args[1], args[2]),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\thas: {\r\n\t\t\tvalue: (key) => hasLocalization(`${subKey}.${key}`),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tpath: {\r\n\t\t\tvalue: (key) => localizePath(`${subKey}.${key}`),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ttemplate: {\r\n\t\t\tvalue: (key, { hash }) => fn(key, hash),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t});\r\n\r\n\treturn fn;\r\n}\r\n", "import { localize } from \"./localize\";\r\n\r\nfunction notify(str, arg1, arg2, arg3) {\r\n\tconst type = typeof arg1 === \"string\" ? arg1 : \"info\";\r\n\tconst data =\r\n\t\ttypeof arg1 === \"object\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"object\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : undefined;\r\n\tconst permanent =\r\n\t\ttypeof arg1 === \"boolean\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"boolean\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : arg3 ?? false;\r\n\r\n\tui.notifications.notify(localize(str, data), type, { permanent });\r\n}\r\n\r\nexport function warn(...args) {\r\n\tconst [str, arg1, arg2] = args;\r\n\tnotify(str, \"warning\", arg1, arg2);\r\n}\r\n\r\nexport function info(...args) {\r\n\tconst [str, arg1, arg2] = args;\r\n\tnotify(str, \"info\", arg1, arg2);\r\n}\r\n\r\nexport function error(...args) {\r\n\tconst [str, arg1, arg2] = args;\r\n\tnotify(str, \"error\", arg1, arg2);\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function getSetting(setting) {\r\n\treturn game.settings.get(MODULE_ID, setting);\r\n}\r\n\r\nexport function setSetting(key, value) {\r\n\treturn game.settings.set(MODULE_ID, key, value);\r\n}\r\n\r\nexport function choiceSettingIsEnabled(setting) {\r\n\treturn getSetting(setting) !== \"disabled\";\r\n}\r\n", "import { HANDWRAPS_SLUG } from \"../shared/item\";\r\nimport { registerWrapper, wrapperError } from \"../shared/libwrapper\";\r\nimport { info } from \"../shared/notification\";\r\nimport { choiceSettingIsEnabled, getSetting } from \"../shared/settings\";\r\n\r\nconst PREPARE_WEAPON_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData\";\r\nconst PREPARE_WEAPON_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData\";\r\n\r\nconst PREPARE_ARMOR_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData\";\r\nconst PREPARE_ARMOR_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData\";\r\n\r\nexport function registerArp() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"auto-runes\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"force\", \"lower\"],\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-arp\"],\r\n\t\tinit: () => {\r\n\t\t\tconst setting = getSetting(\"auto-runes\");\r\n\t\t\tif (setting === \"disabled\") return;\r\n\r\n\t\t\tregisterWrapper(PREPARE_WEAPON_DATA, onPrepareWeaponData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tPREPARE_WEAPON_DERIVED_DATA,\r\n\t\t\t\tonPrepareWeaponDerivedData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tregisterWrapper(PREPARE_ARMOR_DATA, onPrepareArmorData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tPREPARE_ARMOR_DERIVED_DATA,\r\n\t\t\t\tonPrepareArmorDerivedData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tif (setting === \"force\") {\r\n\t\t\t\tHooks.on(\"renderPhysicalItemSheetPF2e\", renderPhysicalItemSheetPF2e);\r\n\t\t\t}\r\n\t\t},\r\n\t\tready: (isGM) => {\r\n\t\t\tif (\r\n\t\t\t\tisGM &&\r\n\t\t\t\tchoiceSettingIsEnabled(\"auto-runes\") &&\r\n\t\t\t\tgame.settings.get(\"pf2e\", \"automaticBonusVariant\") !== \"noABP\"\r\n\t\t\t) {\r\n\t\t\t\tgame.settings.set(\"pf2e\", \"automaticBonusVariant\", \"noABP\");\r\n\t\t\t\tinfo(\"arp.forceVariant\");\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction isValidActor(actor, isCharacter = false) {\r\n\treturn (\r\n\t\tactor &&\r\n\t\t!actor.getFlag(\"pf2e\", \"disableABP\") &&\r\n\t\t(!isCharacter || actor.isOfType(\"character\"))\r\n\t);\r\n}\r\n\r\n/**\r\n * weapon\r\n */\r\n\r\nconst WEAPON_POTENCY_PRICE = {\r\n\t1: 35,\r\n\t2: 935,\r\n\t3: 8935,\r\n\t4: 8935,\r\n};\r\n\r\nconst WEAPON_STRIKING_PRICE = {\r\n\t1: 65,\r\n\t2: 1065,\r\n\t3: 31065,\r\n};\r\n\r\nfunction isShieldWeapon(weapon) {\r\n\treturn [\"shield-boss\", \"shield-spikes\"].includes(\r\n\t\tweapon._source.system.baseItem,\r\n\t);\r\n}\r\n\r\nfunction isValidWeapon(weapon) {\r\n\tconst traits = weapon._source.system.traits.value;\r\n\tconst { group, category, slug } = weapon._source.system;\r\n\r\n\tif (category === \"unarmed\" && slug !== HANDWRAPS_SLUG) {\r\n\t\treturn !!weapon.actor.itemTypes.weapon.find(\r\n\t\t\t(weapon) =>\r\n\t\t\t\tweapon.slug === HANDWRAPS_SLUG &&\r\n\t\t\t\tweapon.category === \"unarmed\" &&\r\n\t\t\t\tweapon.isEquipped &&\r\n\t\t\t\tweapon.isInvested,\r\n\t\t);\r\n\t}\r\n\r\n\treturn (\r\n\t\t(group !== \"shield\" || isShieldWeapon(weapon)) &&\r\n\t\t!traits.includes(\"alchemical\") &&\r\n\t\t!traits.includes(\"bomb\")\r\n\t);\r\n}\r\n\r\nfunction onPrepareWeaponData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidWeapon(this)) return wrapped();\r\n\r\n\t\tconst traits = this._source.system.traits.value;\r\n\t\tif (traits.includes(\"alchemical\") && traits.includes(\"bomb\"))\r\n\t\t\treturn wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 2 ? null : level < 10 ? 1 : level < 16 ? 2 : 3;\r\n\t\tconst expectedStriking =\r\n\t\t\tlevel < 4 ? null : level < 12 ? 1 : level < 19 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.striking <= expectedStriking || forceUpdate) {\r\n\t\t\tthis.system.runes.striking = expectedStriking;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareWeaponDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidWeapon(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= WEAPON_POTENCY_PRICE[potency];\r\n\r\n\t\tconst striking = this.system.runes.striking;\r\n\t\tif (striking) coins.gp -= WEAPON_STRIKING_PRICE[striking];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || striking) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * amor\r\n */\r\n\r\nconst ARMOR_POTENCY_PRICE = {\r\n\t1: 160,\r\n\t2: 1060,\r\n\t3: 20560,\r\n\t4: 20560,\r\n};\r\n\r\nconst ARMOR_RESILIENCY_PRICE = {\r\n\t1: 340,\r\n\t2: 3440,\r\n\t3: 49440,\r\n};\r\n\r\nfunction isValidArmor(armor) {\r\n\treturn true;\r\n}\r\n\r\nfunction onPrepareArmorData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidArmor(this)) return wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 5 ? null : level < 11 ? 1 : level < 18 ? 2 : 3;\r\n\t\tconst expectedResilient =\r\n\t\t\tlevel < 8 ? null : level < 14 ? 1 : level < 20 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.resilient <= expectedResilient || forceUpdate) {\r\n\t\t\tthis.system.runes.resilient = expectedResilient;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareArmorDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidArmor(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= ARMOR_POTENCY_PRICE[potency];\r\n\r\n\t\tconst resiliency = this.system.runes.resilient;\r\n\t\tif (resiliency) coins.gp -= ARMOR_RESILIENCY_PRICE[resiliency];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || resiliency) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * item sheet\r\n */\r\n\r\nfunction renderPhysicalItemSheetPF2e(sheet, html) {\r\n\tconst item = sheet.item;\r\n\tif (\r\n\t\t!item ||\r\n\t\t!item.isOfType(\"weapon\", \"armor\") ||\r\n\t\t!isValidActor(item.actor, true)\r\n\t)\r\n\t\treturn;\r\n\r\n\tconst lookups = [\"potency\", \"striking\", \"resilient\"]\r\n\t\t.map((x) => `[name=\"system.runes.${x}\"]`)\r\n\t\t.join(\", \");\r\n\thtml.find(`[data-tab=details] fieldset .form-group:has(${lookups})`).hide();\r\n}\r\n", "import { getSetting } from \"./settings\";\r\n\r\nexport function createHook(event, listener, callback = () => {}) {\r\n\tlet HOOK = null;\r\n\r\n\treturn (value, otherSettings = [], skipCallback = false) => {\r\n\t\tconst others =\r\n\t\t\ttypeof otherSettings === \"string\" ? [otherSettings] : otherSettings;\r\n\t\tconst settingValue = value || others.some((s) => getSetting(s));\r\n\r\n\t\tif (settingValue && !HOOK) {\r\n\t\t\tHOOK = Hooks.on(event, listener);\r\n\t\t} else if (!settingValue && HOOK) {\r\n\t\t\tHooks.off(event, HOOK);\r\n\t\t\tHOOK = null;\r\n\t\t}\r\n\r\n\t\tif (!skipCallback) callback(settingValue);\r\n\t};\r\n}\r\n\r\nexport function createChoicesHook(event, listener, callback = () => {}) {\r\n\tlet HOOK = null;\r\n\r\n\treturn (value, skipCallback = false) => {\r\n\t\tif (value === \"disabled\" && HOOK) {\r\n\t\t\tHooks.off(event, HOOK);\r\n\t\t\tHOOK = null;\r\n\t\t} else if (value !== \"disabled\" && !HOOK) {\r\n\t\t\tHOOK = Hooks.on(event, listener);\r\n\t\t}\r\n\r\n\t\tif (!skipCallback) callback(value);\r\n\t};\r\n}\r\n\r\nexport function registerUpstreamHook(hook, fn) {\r\n\tconst id = Hooks.on(hook, fn);\r\n\tconst index = Hooks.events[hook].findIndex((x) => x.id === id);\r\n\r\n\tif (index !== 0) {\r\n\t\tconst [hooked] = Hooks.events[hook].splice(index, 1);\r\n\t\tHooks.events[hook].unshift(hooked);\r\n\t}\r\n\r\n\treturn id;\r\n}\r\n", "import { createHook } from \"../shared/hook\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst appHook = createHook(\"renderApplication\", onRender);\r\nconst actorHook = createHook(\"renderActorSheet\", onRender);\r\nconst itemHook = createHook(\"renderItemSheet\", onRender);\r\n\r\nexport function registerDebug() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"debug\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tconfig: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst enabled = value ?? getSetting(\"debug\");\r\n\tappHook(enabled);\r\n\tactorHook(enabled);\r\n\titemHook(enabled);\r\n}\r\n\r\nfunction onRender(app, html) {\r\n\tconst link = html.find(\".document-id-link\")[0];\r\n\tif (!link) return;\r\n\r\n\tlink.addEventListener(\r\n\t\t\"click\",\r\n\t\t(event) => {\r\n\t\t\tif (!event.shiftKey) return;\r\n\r\n\t\t\tconst obj = app.object;\r\n\t\t\tif (!obj) return;\r\n\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tconst type = obj.type;\r\n\r\n\t\t\tlet i = 2;\r\n\t\t\tlet variable = type;\r\n\t\t\twhile (window[variable]) {\r\n\t\t\t\tvariable = `${type}${i++}`;\r\n\t\t\t}\r\n\r\n\t\t\twindow[variable] = obj;\r\n\t\t\tconsole.log(variable, obj);\r\n\t\t},\r\n\t\ttrue,\r\n\t);\r\n}\r\n", "import { createHook } from \"../shared/hook\";\r\nimport { localize } from \"../shared/localize\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderEffectsPanel\",\r\n\trenderEffectsPanel,\r\n\trefreshEffectsPanel,\r\n);\r\n\r\nexport function registerEffectsPanelHelper() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"effect-remove\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"condition-sheet\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"condition-sheet\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"effect-remove\"),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-effect-description\"],\r\n\t\tinit: () => {\r\n\t\t\tsetHook(false, [\"effect-remove\", \"condition-sheet\"]);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction refreshEffectsPanel() {\r\n\tgame.pf2e.effectPanel?.render();\r\n}\r\n\r\nfunction renderEffectsPanel(panel, html) {\r\n\tconst removeRow = `<div>${localize(\"effects.remove\")}</div>`;\r\n\tconst editIcon = `<a data-action=\"edit\" data-tooltip=\"Edit Item\"><i class=\"fa-solid fa-fw fa-pencil\"></i></a>`;\r\n\r\n\tconst effectPanels = html.find(\".effect-item[data-item-id]\").toArray();\r\n\tfor (const effectPanel of effectPanels) {\r\n\t\tconst id = effectPanel.dataset.itemId;\r\n\t\tconst effect = panel.actor?.items.get(id);\r\n\t\tif (!effect) continue;\r\n\r\n\t\tif (\r\n\t\t\tgetSetting(\"effect-remove\") &&\r\n\t\t\t!effect.isLocked &&\r\n\t\t\teffect.badge &&\r\n\t\t\teffect.badge.type === \"counter\"\r\n\t\t) {\r\n\t\t\teffectPanel\r\n\t\t\t\t.querySelector(\".effect-info .instructions\")\r\n\t\t\t\t.insertAdjacentHTML(\"beforeend\", removeRow);\r\n\t\t\teffectPanel\r\n\t\t\t\t.querySelector(\".icon\")\r\n\t\t\t\t.addEventListener(\r\n\t\t\t\t\t\"contextmenu\",\r\n\t\t\t\t\t(event) => onRemoveEffect(event, panel),\r\n\t\t\t\t\ttrue,\r\n\t\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (getSetting(\"condition-sheet\") && effect.isOfType(\"condition\")) {\r\n\t\t\tconst h1 = effectPanel.querySelector(\".effect-info > h1\");\r\n\t\t\th1.insertAdjacentHTML(\"beforeend\", editIcon);\r\n\t\t\th1.querySelector('[data-action=\"edit\"]').addEventListener(\r\n\t\t\t\t\"click\",\r\n\t\t\t\t(event) => onConditionSheet(event, panel),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onConditionSheet(event, panel) {\r\n\tconst effect = getEffect(event, panel);\r\n\tif (!effect?.isOfType(\"condition\")) return;\r\n\tevent.preventDefault();\r\n\teffect.sheet.render(true);\r\n}\r\n\r\nfunction onRemoveEffect(event, panel) {\r\n\tif (!event.shiftKey) return;\r\n\r\n\tconst effect = getEffect(event, panel);\r\n\tif (\r\n\t\t!effect ||\r\n\t\teffect.isLocked ||\r\n\t\t!effect.badge ||\r\n\t\teffect.badge.type !== \"counter\"\r\n\t)\r\n\t\treturn;\r\n\r\n\tevent.preventDefault();\r\n\tevent.stopPropagation();\r\n\tevent.stopImmediatePropagation();\r\n\r\n\teffect.delete();\r\n}\r\n\r\nfunction getEffect(event, panel) {\r\n\tconst target = event.currentTarget;\r\n\tconst effect = target.closest(\".effect-item[data-item-id]\");\r\n\tconst id = effect.dataset.itemId;\r\n\treturn panel.actor?.items.get(id);\r\n}\r\n", "export class MoveLootPopup extends FormApplication {\r\n\tconstructor(object, options, callback) {\r\n\t\tsuper(object, options);\r\n\t\tthis.onSubmitCallback = callback;\r\n\t}\r\n\r\n\tasync getData() {\r\n\t\tconst [prompt, buttonLabel] = this.options.isPurchase\r\n\t\t\t? [\"PF2E.loot.PurchaseLootMessage\", \"PF2E.loot.PurchaseLoot\"]\r\n\t\t\t: [\"PF2E.loot.MoveLootMessage\", \"PF2E.loot.MoveLoot\"];\r\n\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tmaxQuantity: this.options.maxQuantity,\r\n\t\t\tnewStack: this.options.newStack,\r\n\t\t\tlockStack: this.options.lockStack,\r\n\t\t\tprompt,\r\n\t\t\tbuttonLabel,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"MoveLootPopup\",\r\n\t\t\tclasses: [],\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.loot.MoveLootPopupTitle\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/popups/loot/move-loot-popup.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tmaxQuantity: 1,\r\n\t\t\tnewStack: false,\r\n\t\t\tlockStack: false,\r\n\t\t\tisPurchase: false,\r\n\t\t};\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tthis.onSubmitCallback(formData.quantity, formData.newStack);\r\n\t}\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function localeCompare(a, b) {\r\n\treturn a.localeCompare(b, game.i18n.lang);\r\n}\r\n\r\nexport function refreshCharacterSheets(actor) {\r\n\tfor (const win of Object.values(ui.windows)) {\r\n\t\tconst winActor = win.actor;\r\n\t\tif (!(win instanceof ActorSheet) || !winActor.isOfType(\"character\"))\r\n\t\t\tcontinue;\r\n\t\tif (!actor || actor === winActor) win.render();\r\n\t}\r\n}\r\n\r\nexport function compareArrays(arr1, arr2) {\r\n\tif (arr1.length !== arr2.length) return false;\r\n\r\n\tconst clonedArr2 = arr2.slice();\r\n\r\n\tfor (const arr1Value of arr1) {\r\n\t\tconst index = clonedArr2.findIndex((arr2Value) => arr1Value === arr2Value);\r\n\t\tif (index === -1) return false;\r\n\t\tclonedArr2.splice(index, 1);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nexport function ordinalString(value) {\r\n\tconst pluralRules = new Intl.PluralRules(game.i18n.lang, { type: \"ordinal\" });\r\n\tconst suffix = game.i18n.localize(\r\n\t\t`PF2E.OrdinalSuffixes.${pluralRules.select(value)}`,\r\n\t);\r\n\treturn game.i18n.format(\"PF2E.OrdinalNumber\", { value, suffix });\r\n}\r\n\r\nexport function isInstanceOf(obj, name) {\r\n\tif (typeof obj !== \"object\") return false;\r\n\r\n\tlet cursor = Reflect.getPrototypeOf(obj);\r\n\twhile (cursor) {\r\n\t\tif (cursor.constructor.name === name) return true;\r\n\t\tcursor = Reflect.getPrototypeOf(cursor);\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n\r\nexport function setInMemory(doc, key, value) {\r\n\treturn setProperty(doc, `modules.${MODULE_ID}.${key}`, value);\r\n}\r\n\r\nexport function getInMemory(doc, key) {\r\n\treturn getProperty(doc, `modules.${MODULE_ID}.${key}`);\r\n}\r\n\r\nexport function deleteInMemory(doc, key) {\r\n\tconst split = `modules.${MODULE_ID}.${key}`.split(\".\");\r\n\tconst last = split.pop();\r\n\tlet cursor = doc;\r\n\tfor (const key of split) {\r\n\t\tcursor = cursor[key];\r\n\t\tif (!cursor) return true;\r\n\t}\r\n\treturn delete cursor[last];\r\n}\r\n\r\nexport function calculateDistanceBetweenPoints(x1, y1, x2, y2) {\r\n\tconst x = x2 - x1;\r\n\tconst y = y2 - y1;\r\n\treturn Math.sqrt(x * x + y * y);\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} el\r\n * @returns {number | undefined}\r\n */\r\nexport function getElementIndex(el) {\r\n\treturn Array.from(el.parentElement.children).indexOf(el);\r\n}\r\n\r\nexport function indexIsValid(index) {\r\n\treturn index !== undefined && index !== -1;\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function templatePath(...path) {\r\n\tconst pathStr = path.filter((x) => typeof x === \"string\").join(\"/\");\r\n\treturn `modules/${MODULE_ID}/templates/${pathStr}.hbs`;\r\n}\r\n", "import { registerWrapper, unregisterWrapper } from \"./libwrapper\";\r\nimport { getInMemory, setInMemory } from \"./misc\";\r\nimport { templatePath } from \"./path\";\r\n\r\nconst registered = {\r\n\twrapperIds: [],\r\n\ttabs: new Collection(),\r\n};\r\n\r\nconst CHARACTER_SHEET_INNER_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner\";\r\nconst CHARACTER_SHEET_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render\";\r\nconst CHARACTER_SHEET_ACTIVE_LISTENERS =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners\";\r\n\r\nexport function isPlayedActor(actor) {\r\n\treturn actor && !actor.pack && actor.id && game.actors.has(actor.id);\r\n}\r\n\r\nexport function registerCharacterSheetExtraTab(options) {\r\n\tif (!registered.wrapperIds.length) {\r\n\t\tregistered.wrapperIds = [\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_RENDER, characterSheetRender),\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_INNER_RENDER, characterSheetInnerRender),\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tCHARACTER_SHEET_ACTIVE_LISTENERS,\r\n\t\t\t\tcharacterSheetActiveListeners,\r\n\t\t\t),\r\n\t\t];\r\n\t}\r\n\tregistered.tabs.set(options.tabName, options);\r\n}\r\n\r\nexport function unregisterCharacterSheetExtraTab(tabName) {\r\n\tregistered.tabs.delete(tabName);\r\n\tif (registered.wrapperIds.length && !registered.tabs.size) {\r\n\t\tfor (const wrapperId of registered.wrapperIds) {\r\n\t\t\tunregisterWrapper(wrapperId);\r\n\t\t}\r\n\t\tregistered.wrapperIds = [];\r\n\t}\r\n}\r\n\r\nasync function characterSheetRender(wrapped, ...args) {\r\n\tconst positions = {};\r\n\r\n\tfor (const { tabName } of registered.tabs) {\r\n\t\tconst existingTab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst existingAlternate = existingTab.find(\".alternate\")[0];\r\n\t\tif (!existingAlternate) continue;\r\n\t\tpositions[tabName] = existingAlternate.scrollTop;\r\n\t}\r\n\r\n\tawait wrapped(...args);\r\n\r\n\tfor (const { tabName } of registered.tabs) {\r\n\t\tconst oldPosition = positions[tabName];\r\n\t\tif (!oldPosition) continue;\r\n\r\n\t\tconst tab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst alternate = tab.find(\".alternate\")[0];\r\n\t\talternate.scrollTop = positions[tabName];\r\n\t}\r\n}\r\n\r\nasync function characterSheetInnerRender(wrapped, data) {\r\n\tconst inner = await wrapped(data);\r\n\tconst actor = this.actor;\r\n\r\n\tif (!registered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn inner;\r\n\t}\r\n\r\n\tconst element = this.element;\r\n\r\n\tfor (const {\r\n\t\ttabName,\r\n\t\tgetData,\r\n\t\ttemplateFolder,\r\n\t\tonRender,\r\n\t} of registered.tabs) {\r\n\t\tconst innerTab = getCharacterSheetTab(inner, tabName);\r\n\r\n\t\tconst tabData = await getData(\r\n\t\t\tactor,\r\n\t\t\tthis,\r\n\t\t\tgetCharacterSheetTab(element, tabName),\r\n\t\t);\r\n\r\n\t\tconst template = await renderTemplate(\r\n\t\t\ttemplatePath(templateFolder),\r\n\t\t\ttabData,\r\n\t\t);\r\n\r\n\t\tif (onRender) {\r\n\t\t\tawait onRender(actor, this, inner);\r\n\t\t}\r\n\r\n\t\tif (getInMemory(this, `${tabName}.toggled`)) {\r\n\t\t\tinnerTab.addClass(\"toggled\");\r\n\t\t}\r\n\r\n\t\tinnerTab.children(\":last\").before(template);\r\n\t}\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction characterSheetActiveListeners(wrapped, inner) {\r\n\twrapped(inner);\r\n\r\n\tconst actor = this.actor;\r\n\r\n\tif (!registered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const { tabName, addEvents } of registered.tabs) {\r\n\t\tinner\r\n\t\t\t.find(`nav.sheet-navigation .item[data-tab=${tabName}]`)\r\n\t\t\t.on(\"click\", (event) =>\r\n\t\t\t\tonCharacterSheetTabBtnToggle(event, inner, this, tabName),\r\n\t\t\t);\r\n\r\n\t\tconst tab = getCharacterSheetTab(inner, tabName);\r\n\t\taddEvents(tab.find(\"> .alternate\"), this, actor, inner);\r\n\t}\r\n}\r\n\r\nexport function getCharacterSheetTab(html, tabName) {\r\n\treturn html.find(\r\n\t\t`section.sheet-body .sheet-content > .tab[data-tab=${tabName}]`,\r\n\t);\r\n}\r\n\r\nfunction onCharacterSheetTabBtnToggle(event, html, sheet, tabName) {\r\n\tevent.preventDefault();\r\n\r\n\tconst tab = getCharacterSheetTab(html, tabName);\r\n\r\n\tif (tab.hasClass(\"active\")) {\r\n\t\ttab.toggleClass(\"toggled\");\r\n\t\ttab.scrollTop(0);\r\n\t\tsetInMemory(sheet, `${tabName}.toggled`, tab.hasClass(\"toggled\"));\r\n\t}\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function getFlag(doc, key, fallback) {\r\n\treturn doc.getFlag(MODULE_ID, key) ?? fallback;\r\n}\r\n\r\nexport function setFlag(doc, key, value) {\r\n\treturn doc.setFlag(MODULE_ID, key, value);\r\n}\r\n\r\nexport function unsetFlag(doc, key) {\r\n\treturn doc.unsetFlag(MODULE_ID, key);\r\n}\r\n\r\nexport function containsFlag(doc, key) {\r\n\treturn getProperty(doc, `flags.${MODULE_ID}.${key}`) !== undefined;\r\n}\r\n\r\nexport function updateSourceFlag(doc, key, value) {\r\n\treturn doc.updateSource({\r\n\t\t[`flags.${MODULE_ID}.${key}`]: value,\r\n\t});\r\n}\r\n\r\nexport function moduleFlagUpdate(update, key, value) {\r\n\tupdate[`flags.${MODULE_ID}.${key}`] = value;\r\n}\r\n", "import { getFlag, updateSourceFlag } from \"./flags\";\r\n\r\nexport function getChatMessageClass() {\r\n\treturn CONFIG.ChatMessage.documentClass;\r\n}\r\n\r\nexport function* latestChatMessages(nb, fromMessage) {\r\n\tconst chat = ui.chat?.element;\r\n\tif (!chat) return;\r\n\r\n\tconst messages = game.messages.contents;\r\n\tconst start =\r\n\t\t(fromMessage\r\n\t\t\t? messages.findLastIndex((m) => m === fromMessage)\r\n\t\t\t: messages.length) - 1;\r\n\r\n\tfor (let i = start; i >= start - nb; i--) {\r\n\t\tconst message = messages[i];\r\n\t\tif (!message) return;\r\n\r\n\t\tconst html = chat.find(`[data-message-id=${message.id}]`);\r\n\t\tif (!html.length) continue;\r\n\r\n\t\tyield { message, html };\r\n\t}\r\n}\r\n\r\nexport function chatUUID(uuid, label, fake = false) {\r\n\tif (fake) {\r\n\t\treturn `<span style=\"background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);\r\nborder-radius: 2px; white-space: nowrap; word-break: break-all;\">${label}</span>`;\r\n\t}\r\n\r\n\tif (label) return `@UUID[${uuid}]{${label}}`;\r\n\r\n\treturn `@UUID[${uuid}]`;\r\n}\r\n\r\nexport function bindOnPreCreateSpellDamageChatMessage(originalMessage) {\r\n\tconst messageId = originalMessage.id;\r\n\tconst save = getFlag(originalMessage, \"target.save\");\r\n\tif (!save) return;\r\n\r\n\tHooks.once(\"preCreateChatMessage\", (message) => {\r\n\t\tupdateSourceFlag(message, \"target.messageId\", messageId);\r\n\t\tupdateSourceFlag(message, \"target.save\", save);\r\n\t});\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\n\r\nexport function socketOn(callback) {\r\n\tgame.socket.on(`module.${MODULE_ID}`, callback);\r\n}\r\n\r\nexport function socketOff(callback) {\r\n\tgame.socket.off(`module.${MODULE_ID}`, callback);\r\n}\r\n\r\nexport function socketEmit(packet) {\r\n\tgame.socket.emit(`module.${MODULE_ID}`, packet);\r\n}\r\n", "export function isActiveGM() {\r\n\treturn game.user === game.users.activeGM;\r\n}\r\n\r\nexport function isUserGM() {\r\n\tconst user = game.data.users.find((x) => x._id === game.data.userId);\r\n\treturn user && user.role >= CONST.USER_ROLES.GAMEMASTER;\r\n}\r\n\r\nexport function isGMOnline() {\r\n\treturn game.users.some((user) => user.active && user.isGM);\r\n}\r\n\r\nexport function getCharacterOwner(actor, connected = false) {\r\n\tif (connected)\r\n\t\treturn game.users.find((x) => x.active && x.character === actor);\r\n\treturn game.users.find((x) => x.character === actor);\r\n}\r\n\r\nexport function getActiveOwner(doc) {\r\n\tconst activeOwners = game.users.filter(\r\n\t\t(user) =>\r\n\t\t\tuser.active && !user.isGM && doc.testUserPermission(user, \"OWNER\"),\r\n\t);\r\n\tactiveOwners.sort((a, b) => (a.id > b.id ? 1 : -1));\r\n\treturn activeOwners[0] || null;\r\n}\r\n\r\nexport function isActiveOwner(doc) {\r\n\treturn getActiveOwner(doc) === game.user;\r\n}\r\n\r\nexport function getOwner(doc, connected = false) {\r\n\tif (connected)\r\n\t\treturn game.users.find(\r\n\t\t\t(x) => x.active && doc.testUserPermission(x, \"OWNER\"),\r\n\t\t);\r\n\treturn game.users.find((x) => doc.testUserPermission(x, \"OWNER\"));\r\n}\r\n", "import { MoveLootPopup } from \"../apps/giveth/popup\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { chatUUID } from \"../shared/chat\";\r\nimport { registerUpstreamHook } from \"../shared/hook\";\r\nimport { localize } from \"../shared/localize\";\r\nimport { warn } from \"../shared/notification\";\r\nimport { getSetting } from \"../shared/settings\";\r\nimport { socketOff, socketOn, socketEmit } from \"../shared/socket\";\r\nimport { isActiveGM, isGMOnline } from \"../shared/user\";\r\n\r\nlet enabled = false;\r\nlet CANVAS_HOOK = null;\r\n\r\nexport function registerGiveth() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"giveth\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"no-message\"],\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-giveth\"],\r\n\t\tready: (isGM) => {\r\n\t\t\tif (getSetting(\"giveth\") !== \"disabled\") setup(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst isGM = game.user.isGM;\r\n\r\n\tif (value === \"disabled\" && enabled) {\r\n\t\tif (isGM) socketOff(onSocket);\r\n\t\telse if (CANVAS_HOOK) {\r\n\t\t\tHooks.off(\"dropCanvasData\", CANVAS_HOOK);\r\n\t\t\tCANVAS_HOOK = null;\r\n\t\t}\r\n\t\tenabled = false;\r\n\t} else if (value !== \"disabled\" && !enabled) {\r\n\t\tif (isGM) socketOn(onSocket);\r\n\t\telse if (!CANVAS_HOOK)\r\n\t\t\tCANVAS_HOOK = registerUpstreamHook(\"dropCanvasData\", onDropCanvasData);\r\n\t\tenabled = true;\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tif (!isActiveGM()) return;\r\n\tif (packet.type === \"giveth-condition\") takethCondition(packet);\r\n\telse if (packet.type === \"giveth-effect\") takethEffect(packet);\r\n\telse takethPhysical(packet);\r\n}\r\n\r\nfunction onDropCanvasData(canvas, data) {\r\n\tif (!isGMOnline()) return true;\r\n\r\n\tconst details = getDetailsFromData(data);\r\n\tif (!details) return true;\r\n\r\n\tconst target = canvas.tokens.placeables\r\n\t\t.slice()\r\n\t\t.filter((token) => {\r\n\t\t\tif (!token.document.actorLink) return false;\r\n\t\t\tconst target = token.actor;\r\n\t\t\tif (!isValidActor(target, data.actorId) || target.isOwner) return false;\r\n\t\t\tconst maximumX = token.x + (token.hitArea?.right ?? 0);\r\n\t\t\tconst maximumY = token.y + (token.hitArea?.bottom ?? 0);\r\n\t\t\treturn (\r\n\t\t\t\tdata.x >= token.x &&\r\n\t\t\t\tdata.y >= token.y &&\r\n\t\t\t\tdata.x <= maximumX &&\r\n\t\t\t\tdata.y <= maximumY\r\n\t\t\t);\r\n\t\t})\r\n\t\t.sort((a, b) => b.document.sort - a.document.sort)\r\n\t\t.at(0)?.actor;\r\n\r\n\tif (!target) return true;\r\n\r\n\tgiveth(details.actor, target, details.item, details.value);\r\n\treturn false;\r\n}\r\n\r\nfunction giveth(origin, target, item, value) {\r\n\tconst ownerId = origin.id;\r\n\tconst targetId = target.id;\r\n\tconst isIndex = !(item instanceof Item);\r\n\r\n\tif (!isIndex && item.isOfType(\"physical\")) {\r\n\t\tconst qty = item.quantity;\r\n\t\tif (qty < 1) return warn(\"giveth.notification.zero\");\r\n\r\n\t\tif (qty === 1)\r\n\t\t\treturn sendPhysicalRequest(ownerId, targetId, item.id, 1, false);\r\n\r\n\t\tnew MoveLootPopup(\r\n\t\t\torigin,\r\n\t\t\t{ maxQuantity: qty, lockStack: false, isPurchase: false },\r\n\t\t\t(qty, stack) => {\r\n\t\t\t\tsendPhysicalRequest(ownerId, targetId, item.id, qty, stack);\r\n\t\t\t},\r\n\t\t).render(true);\r\n\t} else {\r\n\t\tconst uuid = isIndex ? `Compendium.${item.pack}.${item._id}` : item.uuid;\r\n\t\tif (item.type === \"condition\") {\r\n\t\t\tsocketEmit({\r\n\t\t\t\ttype: \"giveth-condition\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tvalue: value ?? 1,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tsocketEmit({\r\n\t\t\t\ttype: \"giveth-effect\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction sendPhysicalRequest(ownerId, targetId, itemId, qty, stack) {\r\n\tsocketEmit({\r\n\t\ttype: \"giveth-physical\",\r\n\t\townerId,\r\n\t\ttargetId,\r\n\t\titemId,\r\n\t\tqty,\r\n\t\tstack,\r\n\t});\r\n}\r\n\r\nfunction isValidActor(actor, id) {\r\n\tif (!isPlayedActor(actor) || (id && actor.id === id)) return false;\r\n\treturn (\r\n\t\tactor.hasPlayerOwner &&\r\n\t\t!actor.isToken &&\r\n\t\tactor.isOfType(\"character\", \"npc\", \"vehicle\")\r\n\t);\r\n}\r\n\r\nfunction getDetailsFromData(data) {\r\n\tif (data.tokenId || data.type !== \"Item\" || !data.uuid) return;\r\n\r\n\tconst item = fromUuidSync(data.uuid);\r\n\tif (!item) return;\r\n\r\n\tlet actor = item.actor;\r\n\tif (!actor) {\r\n\t\tconst actorUUID = data.context?.origin.actor;\r\n\t\tactor = actorUUID ? fromUuidSync(actorUUID) : null;\r\n\t}\r\n\r\n\tif (!isValidActor(actor) || !actor.isOwner) return;\r\n\r\n\tconst isIndex = !(item instanceof Item);\r\n\tif (isIndex && item.pack && [\"effect\", \"condition\"].includes(item.type))\r\n\t\treturn { actor, item, value: data.value };\r\n\tif (!isIndex && item.isOfType(\"physical\", \"effect\"))\r\n\t\treturn { actor, item, value: data.value };\r\n}\r\n\r\nasync function takethCondition({ targetId, uuid, value }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\ttarget.increaseCondition(item.slug, { min: value });\r\n}\r\n\r\nasync function takethEffect({ targetId, uuid }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\tconst source = item\r\n\t\t.clone({ \"system.tokenIcon.show\": true, \"system.unidentified\": false })\r\n\t\t.toObject();\r\n\ttarget.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n\r\nasync function takethPhysical({ itemId, ownerId, qty, stack, targetId }) {\r\n\tconst owner = game.actors.get(ownerId);\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!owner || !target) return;\r\n\r\n\tconst item = owner.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tqty = Math.min(qty, item.quantity);\r\n\tconst newQty = item.quantity - qty;\r\n\r\n\tconst source = item.toObject();\r\n\tsource.system.quantity = qty;\r\n\tsource.system.equipped.carryType = \"worn\";\r\n\tif (item.isOfType(\"physical\") && \"invested\" in source.system.equipped) {\r\n\t\tsource.system.equipped.invested = item.traits.has(\"invested\")\r\n\t\t\t? false\r\n\t\t\t: null;\r\n\t}\r\n\r\n\tconst newItem = await target.addToInventory(source, undefined, stack);\r\n\tif (!newItem) return;\r\n\r\n\tif (newQty < 1) item.delete();\r\n\telse item.update({ \"system.quantity\": newQty });\r\n\r\n\tif (getSetting(\"giveth\") === \"no-message\") return;\r\n\r\n\tlet content = chatUUID(newItem.uuid, newItem.name, !newItem.isIdentified);\r\n\tif (qty > 1) content += ` x${qty}`;\r\n\r\n\tconst giveth = localize(\"giveth.giveth\", {\r\n\t\ttarget: target.name,\r\n\t});\r\n\r\n\tChatMessage.create({\r\n\t\tflavor: `<h4 class=\"action\">${giveth}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: owner }),\r\n\t});\r\n}\r\n", "import { getHeroActions, sendTradeRequest } from \"../../features/hero\";\r\nimport { subLocalize } from \"../../shared/localize\";\r\nimport { templatePath } from \"../../shared/path\";\r\nimport { getCharacterOwner, getOwner } from \"../../shared/user\";\r\n\r\nconst localize = subLocalize(\"hero.templates.trade\");\r\n\r\nexport class Trade extends Application {\r\n\tconstructor(actor) {\r\n\t\tsuper({ id: `pf2e-hero-actions-trade-${actor.id}` });\r\n\t\tthis._actor = actor;\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn mergeObject(Application.defaultOptions, {\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\ttemplate: templatePath(\"hero/trade\"),\r\n\t\t\twidth: 600,\r\n\t\t\theight: \"auto\",\r\n\t\t});\r\n\t}\r\n\r\n\tget actor() {\r\n\t\treturn this._actor;\r\n\t}\r\n\r\n\tget target() {\r\n\t\treturn this._target;\r\n\t}\r\n\r\n\tset target(value) {\r\n\t\tif (!value) {\r\n\t\t\tlocalize.error(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (value === this._target) return;\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t\tthis._target = value;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(), {\r\n\t\t\tactor: this.actor,\r\n\t\t\ttarget: this.target,\r\n\t\t\ttargets: game.actors.filter(\r\n\t\t\t\t(x) =>\r\n\t\t\t\t\tx.type === \"character\" && x.id !== this.actor.id && x.hasPlayerOwner,\r\n\t\t\t),\r\n\t\t\tactions: getHeroActions(this.actor),\r\n\t\t\ttargetActions: this.target ? getHeroActions(this.target) : [],\r\n\t\t\ti18n: localize,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\t\thtml\r\n\t\t\t.find('select[name=\"target\"]')\r\n\t\t\t.on(\"change\", this.#onChangeTarget.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"description\"]')\r\n\t\t\t.on(\"click\", this.#onDescription.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"trade\"]')\r\n\t\t\t.on(\"click\", this.#onSendTrade.bind(this));\r\n\t\thtml.find('[data-action=\"cancel\"]').on(\"click\", () => this.close());\r\n\t}\r\n\r\n\trender(force, options) {\r\n\t\tthis.actor.apps[this.appId] = this;\r\n\t\tif (this.target) this.target.apps[this.appId] = this;\r\n\t\treturn super.render(force, options);\r\n\t}\r\n\r\n\tasync close(options) {\r\n\t\tawait super.close(options);\r\n\t\tdelete this.actor.apps?.[this.appId];\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t}\r\n\r\n\t#onSendTrade() {\r\n\t\tif (!this.target) {\r\n\t\t\tlocalize.warn(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst action = this.element.find('[name=\"action\"]:checked').val();\r\n\t\tconst target = this.element.find('[name=\"targetAction\"]:checked').val();\r\n\r\n\t\tif (typeof action !== \"string\" || typeof target !== \"string\") {\r\n\t\t\tlocalize.warn(\"no-select\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst user =\r\n\t\t\tgetCharacterOwner(this.target, true) ??\r\n\t\t\tgetOwner(this.target, true) ??\r\n\t\t\tgame.users.activeGM;\r\n\r\n\t\tif (!user) {\r\n\t\t\tlocalize.warn(\"no-user\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsendTradeRequest({\r\n\t\t\tsender: {\r\n\t\t\t\tid: game.user.id,\r\n\t\t\t\tcid: this.actor.id,\r\n\t\t\t\tuuid: action,\r\n\t\t\t},\r\n\t\t\treceiver: {\r\n\t\t\t\tid: user.id,\r\n\t\t\t\tcid: this.target.id,\r\n\t\t\t\tuuid: target,\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\tasync #onDescription(event) {\r\n\t\tconst uuid = $(event.currentTarget).siblings(\"input\").val();\r\n\t\tconst entry = await fromUuid(uuid);\r\n\t\tentry?.sheet.render(true);\r\n\t}\r\n\r\n\t#onChangeTarget(event) {\r\n\t\tconst id = event.currentTarget.value;\r\n\t\tthis.target = game.actors.get(id);\r\n\t}\r\n}\r\n", "import { Trade } from \"../apps/hero/trade\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { chatUUID } from \"../shared/chat\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { localize, subLocalize } from \"../shared/localize\";\r\nimport { refreshCharacterSheets } from \"../shared/misc\";\r\nimport { error, warn } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting, setSetting } from \"../shared/settings\";\r\nimport { socketEmit, socketOff, socketOn } from \"../shared/socket\";\r\nimport { isActiveGM } from \"../shared/user\";\r\n\r\nconst MODULE_ID = \"pf2e-hero-actions\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderCharacterSheetPF2e\",\r\n\trenderCharacterSheetPF2e,\r\n\tsetupSocket,\r\n);\r\n\r\nconst JOURNAL_UUID = \"Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko\";\r\nconst TABLE_UUID = \"Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK\";\r\n\r\nconst TABLE_ICON = \"systems/pf2e/icons/features/feats/heroic-recovery.webp\";\r\n\r\nlet SOCKET = false;\r\n\r\nexport function registerHeroActions() {\r\n\treturn {\r\n\t\tname: \"heroActions\",\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"hero\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: (value) => setHook(value),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"hero-table\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"\",\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"hero-trade\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: () => refreshCharacterSheets(),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"hero-private\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [MODULE_ID],\r\n\t\tapi: {\r\n\t\t\tcreateTable,\r\n\t\t\tremoveHeroActions,\r\n\t\t\tgetHeroActions,\r\n\t\t\tuseHeroAction,\r\n\t\t\tgetHeroActionDetails,\r\n\t\t\tdrawHeroAction,\r\n\t\t\tdrawHeroActions,\r\n\t\t\tsendActionToChat,\r\n\t\t\tdiscardHeroActions,\r\n\t\t\ttradeHeroAction,\r\n\t\t\tgetDeckTable,\r\n\t\t\tgiveHeroActions,\r\n\t\t\tcreateChatMessage,\r\n\t\t},\r\n\t\tready: () => {\r\n\t\t\tsetHook(false, \"hero\");\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setupSocket(value) {\r\n\tif (value && !SOCKET) {\r\n\t\tsocketOn(onSocket);\r\n\t\tSOCKET = true;\r\n\t} else if (!value && SOCKET) {\r\n\t\tsocketOff(onSocket);\r\n\t\tSOCKET = false;\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tswitch (packet.type) {\r\n\t\tcase \"hero.trade-reject\":\r\n\t\t\tif (packet.sender.id !== game.user.id) return;\r\n\t\t\tonTradeRejected(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-accept\":\r\n\t\t\tif (!isActiveGM()) return;\r\n\t\t\tonTradeAccepted(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-request\":\r\n\t\t\tif (packet.receiver.id !== game.user.id) return;\r\n\t\t\tonTradeRequest(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-error\":\r\n\t\t\tif (!packet.users.includes(game.user.id)) return;\r\n\t\t\tonTradeError(packet.error);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tawait addActionsToSheet(html, actor);\r\n\taddSheetEvents(html, actor);\r\n}\r\n\r\nasync function addActionsToSheet(html, actor) {\r\n\tconst actions = getHeroActions(actor);\r\n\tconst diff = actor.heroPoints.value - actions.length;\r\n\tconst isOwner = actor.isOwner;\r\n\tconst localize = subLocalize(\"hero.templates.heroActions\");\r\n\r\n\tconst template = await renderTemplate(templatePath(\"hero/sheet\"), {\r\n\t\towner: isOwner,\r\n\t\tlist: actions,\r\n\t\tcanUse: diff >= 0 && isOwner,\r\n\t\tcanDraw: diff > 0 && isOwner,\r\n\t\tcanTrade: getSetting(\"hero-trade\"),\r\n\t\tmustDiscard: diff < 0,\r\n\t\tdiff: Math.abs(diff),\r\n\t\ti18n: (key, { hash }) => localize(key, hash),\r\n\t});\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)\",\r\n\t\t)\r\n\t\t.first()\r\n\t\t.after(template);\r\n}\r\n\r\nfunction addSheetEvents(html, actor) {\r\n\tconst list = html.find(\".tab.actions .heroActions-list\");\r\n\tlist\r\n\t\t.find(\"[data-action=draw]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionsDraw(actor, event));\r\n\tlist.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\tlist\r\n\t\t.find(\"[data-action=use]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionUse(actor, event));\r\n\tlist\r\n\t\t.find(\"[data-action=display]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionDisplay(actor, event));\r\n\tlist.find(\"[data-action=discard]\").on(\"click\", onClickHeroActionDiscard);\r\n\tlist\r\n\t\t.find(\"[data-action=discard-selected]\")\r\n\t\t.on(\"click\", () => onClickHeroActionsDiscard(actor, html));\r\n\thtml\r\n\t\t.find(\"[data-action=hero-actions-trade]\")\r\n\t\t.on(\"click\", () => tradeHeroAction(actor));\r\n}\r\n\r\nasync function onClickHeroActionsDiscard(actor, html) {\r\n\tconst discarded = html.find(\r\n\t\t\".tab.actions .heroActions-list .action.discarded\",\r\n\t);\r\n\tconst uuids = discarded.toArray().map((x) => x.dataset.uuid);\r\n\tdiscardHeroActions(actor, uuids);\r\n}\r\n\r\nfunction onClickHeroActionDiscard(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst list = action.closest(\".heroActions-list\");\r\n\r\n\taction.toggleClass(\"discarded\");\r\n\r\n\tconst toDiscard = Number(list.attr(\"data-discard\") ?? \"0\");\r\n\tconst $discarded = list.find(\".action.discarded\");\r\n\r\n\tlist.toggleClass(\"discardable\", $discarded.length === toDiscard);\r\n}\r\n\r\nasync function onClickHeroActionDisplay(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tsendActionToChat(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionUse(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tuseHeroAction(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionsDraw(actor, event) {\r\n\tevent.preventDefault();\r\n\tdrawHeroActions(actor);\r\n}\r\n\r\nexport function getHeroActions(actor) {\r\n\treturn getProperty(actor, `flags.${MODULE_ID}.heroActions`) ?? [];\r\n}\r\n\r\nasync function setHeroActions(actor, actions) {\r\n\treturn actor.update({ [`flags.${MODULE_ID}.heroActions`]: actions });\r\n}\r\n\r\nasync function onClickHeroActionExpand(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst summary = action.find(\".item-summary\");\r\n\r\n\tif (!summary.hasClass(\"loaded\")) {\r\n\t\tconst uuid = action.attr(\"data-uuid\");\r\n\t\tconst details = await getHeroActionDetails(uuid);\r\n\t\tif (!details) return;\r\n\r\n\t\tconst text = await TextEditor.enrichHTML(details.description, {\r\n\t\t\tasync: true,\r\n\t\t});\r\n\r\n\t\tsummary.find(\".item-description\").html(text);\r\n\t\tsummary.addClass(\"loaded\");\r\n\t}\r\n\r\n\taction.toggleClass(\"expanded\");\r\n}\r\n\r\nasync function getHeroActionDetails(uuid) {\r\n\tconst document = await fromUuid(uuid);\r\n\tif (!document) return undefined;\r\n\r\n\tconst parent = document instanceof JournalEntry ? document : document.parent;\r\n\tconst page =\r\n\t\tdocument instanceof JournalEntry ? document.pages.contents[0] : document;\r\n\r\n\tlet text = page?.text.content;\r\n\tif (!text) return undefined;\r\n\r\n\tif (parent.uuid === JOURNAL_UUID)\r\n\t\ttext = text.replace(/^<p>/, \"<p><strong>Trigger</strong> \");\r\n\treturn { name: page.name, description: text };\r\n}\r\n\r\nexport async function drawHeroActions(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst nb = actor.heroPoints.value - actions.length;\r\n\r\n\tconst drawn = [];\r\n\tfor (let i = 0; i < nb; i++) {\r\n\t\tconst action = await drawHeroAction();\r\n\r\n\t\tif (action === undefined) continue;\r\n\t\tif (action === null) return;\r\n\r\n\t\tactions.push(action);\r\n\t\tdrawn.push(action);\r\n\t}\r\n\r\n\tif (!drawn.length) return;\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: drawn,\r\n\t\tlabel: (nb) => localize(\"hero.actions-draw.header\", { nb }),\r\n\t\tsecret: true,\r\n\t});\r\n}\r\n\r\nfunction createChatMessage({ actor, actions, label, secret = false }) {\r\n\tconst { content, size } = chatActions(actions);\r\n\r\n\tlabel = typeof label === \"function\" ? label(size) : label;\r\n\r\n\tconst data = {\r\n\t\tflavor: `<h4 class=\"action\">${label}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t};\r\n\r\n\tif (secret && getSetting(\"hero-private\")) {\r\n\t\tdata.type = CONST.CHAT_MESSAGE_TYPES.ROLL;\r\n\t\tdata.rollMode = CONST.DICE_ROLL_MODES.PRIVATE;\r\n\t}\r\n\r\n\tChatMessage.create(data);\r\n}\r\n\r\nfunction chatActions(actions) {\r\n\tconst links = actions.map(({ uuid, name }) => chatUUID(uuid, name));\r\n\treturn {\r\n\t\tcontent: links\r\n\t\t\t.map((x) => `<div style=\"line-height: 1.6;\">${x}</div>`)\r\n\t\t\t.join(\"\"),\r\n\t\tsize: links.length,\r\n\t};\r\n}\r\n\r\nfunction tradeHeroAction(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tif (!actions || !actions.length) {\r\n\t\twarn(\"hero.no-action\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst diff = actions.length - actor.heroPoints.value;\r\n\tif (diff > 0) {\r\n\t\twarn(\"hero.no-points\", { nb: diff.toString() });\r\n\t\treturn;\r\n\t}\r\n\r\n\tnew Trade(actor).render(true);\r\n}\r\n\r\nasync function drawHeroAction() {\r\n\tconst table = await getDeckTable();\r\n\tconst localize = subLocalize(\"hero.table\");\r\n\r\n\tif (!table) {\r\n\t\tlocalize.error(\"drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (!table.formula) {\r\n\t\tif (game.user.isGM) {\r\n\t\t\tif (table.compendium) {\r\n\t\t\t\tlocalize.error(\"noFormulaCompendium\", true);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\tawait table.normalize();\r\n\t\t} else {\r\n\t\t\tlocalize.error(\"noFormula\", true);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tif (table.replacement === false) {\r\n\t\tconst notDrawn = table.results.some((r) => !r.drawn);\r\n\t\tif (!notDrawn) await table.resetResults();\r\n\t}\r\n\r\n\tconst draw = (await table.draw({ displayChat: false })).results[0];\r\n\tif (!draw) return;\r\n\r\n\tconst uuid = documentUuidFromTableResult(draw);\r\n\tif (uuid) return { uuid, name: await getLabelfromTableResult(draw, uuid) };\r\n}\r\n\r\nasync function useHeroAction(actor, uuid) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst points = actor.heroPoints.value;\r\n\tif (points < 1) return warn(\"hero.use.noPoints\");\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\r\n\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\tif (index === -1) return;\r\n\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) error(\"hero.use.noDetails\");\r\n\r\n\tactions.splice(index, 1);\r\n\r\n\tif (details) {\r\n\t\tactor.update({\r\n\t\t\t\"system.resources.heroPoints.value\": points - 1,\r\n\t\t\t[`flags.${MODULE_ID}.heroActions`]: actions,\r\n\t\t});\r\n\r\n\t\tChatMessage.create({\r\n\t\t\tflavor: `<h4 class=\"action\">${localize(\"hero.actions-use.header\")}</h4>`,\r\n\t\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\t\tspeaker: ChatMessage.getSpeaker({ actor }),\r\n\t\t});\r\n\t} else {\r\n\t\tsetHeroActions(actor, actions);\r\n\t}\r\n}\r\n\r\nasync function discardHeroActions(actor, actionsUUIDS) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst uuids =\r\n\t\ttypeof actionsUUIDS === \"string\" ? [actionsUUIDS] : actionsUUIDS;\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst removed = [];\r\n\r\n\tfor (const uuid of uuids) {\r\n\t\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\t\tif (index === -1) continue;\r\n\t\tremoved.push(actions[index]);\r\n\t\tactions.splice(index, 1);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: removed,\r\n\t\tlabel: (nb) => localize(\"hero.actions-discard.header\", { nb }),\r\n\t});\r\n}\r\n\r\nasync function getLabelfromTableResult(result, uuid) {\r\n\tif (result.type !== CONST.TABLE_RESULT_TYPES.TEXT) return result.text;\r\n\tconst label = /@UUID\\[[\\w\\.]+\\]{([\\w -]+)}/.exec(result.text)?.[1];\r\n\treturn label ?? (uuid && (await fromUuid(uuid))?.name);\r\n}\r\n\r\nasync function getTableFromUuid(uuid) {\r\n\tif (!uuid) return undefined;\r\n\tconst table = await fromUuid(uuid);\r\n\treturn table && table instanceof RollTable ? table : undefined;\r\n}\r\n\r\nasync function getDefaultCompendiumTable() {\r\n\treturn getTableFromUuid(TABLE_UUID);\r\n}\r\n\r\nfunction getDefaultWorldTable() {\r\n\treturn game.tables.find((x) => x.getFlag(\"core\", \"sourceId\") === TABLE_UUID);\r\n}\r\n\r\nasync function getCustomTable() {\r\n\treturn getTableFromUuid(getSetting(\"hero-table\"));\r\n}\r\n\r\nasync function getDeckTable() {\r\n\treturn (\r\n\t\t(await getCustomTable()) ??\r\n\t\tgetDefaultWorldTable() ??\r\n\t\t(await getDefaultCompendiumTable())\r\n\t);\r\n}\r\n\r\nasync function sendActionToChat(actor, uuid) {\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) return error(\"hero.details.missing\");\r\n\r\n\tChatMessage.create({\r\n\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t});\r\n}\r\n\r\nexport function sendTradeRequest(trade) {\r\n\tif (trade.receiver.id === game.user.id) {\r\n\t\tacceptRequest(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocketEmit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-request\",\r\n\t});\r\n}\r\n\r\nfunction acceptRequest(trade) {\r\n\tif (game.user.isGM) {\r\n\t\tonTradeAccepted(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocketEmit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-accept\",\r\n\t});\r\n}\r\n\r\nasync function onTradeAccepted(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderActions = getHeroActions(senderActor);\r\n\tconst receiverActions = getHeroActions(receiverActor);\r\n\r\n\tconst senderActionIndex = senderActions.findIndex(\r\n\t\t(x) => x.uuid === sender.uuid,\r\n\t);\r\n\tconst receiverActionIndex = receiverActions.findIndex(\r\n\t\t(x) => x.uuid === receiver.uuid,\r\n\t);\r\n\r\n\tif (senderActionIndex === -1 || receiverActionIndex === -1) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderAction = senderActions.splice(senderActionIndex, 1)[0];\r\n\tconst receiverAction = receiverActions.splice(receiverActionIndex, 1)[0];\r\n\r\n\tsenderActions.push(receiverAction);\r\n\treceiverActions.push(senderAction);\r\n\r\n\tsetHeroActions(senderActor, senderActions);\r\n\tsetHeroActions(receiverActor, receiverActions);\r\n\r\n\tconst sentLink = chatUUID(senderAction.uuid);\r\n\tconst receivedLink = chatUUID(receiverAction.uuid);\r\n\r\n\tconst localize = subLocalize(\"hero.trade-success\");\r\n\r\n\tlet content = `<div style=\"line-height: 1.6\">${localize(\"offer\", {\r\n\t\toffer: sentLink,\r\n\t})}</div>`;\r\n\tcontent += `<div style=\"line-height: 1.6\">${localize(\"receive\", {\r\n\t\treceive: receivedLink,\r\n\t})}</div>`;\r\n\r\n\tChatMessage.create({\r\n\t\tflavor: `<h4 class=\"action\">${localize(\"header\", {\r\n\t\t\tname: receiverActor.name,\r\n\t\t})}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: senderActor }),\r\n\t});\r\n}\r\n\r\nfunction sendTradeError({ sender, receiver }, error = \"trade-error\") {\r\n\tconst users = new Set([sender.id, receiver.id]);\r\n\r\n\tif (users.has(game.user.id)) {\r\n\t\tusers.delete(game.user.id);\r\n\t\tonTradeError(error);\r\n\t}\r\n\r\n\tif (!users.size) return;\r\n\r\n\tsocketEmit({\r\n\t\ttype: \"hero.trade-error\",\r\n\t\tusers: Array.from(users),\r\n\t\terror,\r\n\t});\r\n}\r\n\r\nfunction onTradeError(err) {\r\n\terror(\"hero.trade-error\");\r\n}\r\n\r\nasync function onTradeRequest(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.trade-request\");\r\n\r\n\tlet content = `<p>${localize(\"header\", {\r\n\t\tsender: senderActor.name,\r\n\t\treceiver: receiverActor.name,\r\n\t})}</p>`;\r\n\tcontent += `<p>${localize(\"give\", { give: chatUUID(sender.uuid) })}</p>`;\r\n\tcontent += `<p>${localize(\"want\", { want: chatUUID(receiver.uuid) })}</p>`;\r\n\tcontent += `<p style=\"margin-bottom: 1em;\">${localize(\"accept\")}</p>`;\r\n\r\n\tconst accept = await Dialog.confirm({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await TextEditor.enrichHTML(content, { async: true }),\r\n\t});\r\n\r\n\tif (accept) acceptRequest(trade);\r\n\telse rejectRequest(trade);\r\n}\r\n\r\nfunction rejectRequest(trade) {\r\n\tif (trade.sender.id === game.user.id) {\r\n\t\tonTradeRejected(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocketEmit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-reject\",\r\n\t});\r\n}\r\n\r\nasync function onTradeRejected({ receiver }) {\r\n\tconst actor = game.actors.get(receiver.cid);\r\n\twarn(\"hero.trade-rejected\", { name: actor.name }, true);\r\n}\r\n\r\nasync function createTable() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.createTable.choice\");\r\n\tconst template = templatePath(\"hero/dialogs/create-table\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"create\"),\r\n\t\t\ticon: '<i class=\"fas fa-border-all\"></i>',\r\n\t\t\tcallback: (html) => {\r\n\t\t\t\tconst type = html\r\n\t\t\t\t\t.find('.window-content input[name=\"type\"]:checked')\r\n\t\t\t\t\t.val();\r\n\t\t\t\tconst unique =\r\n\t\t\t\t\thtml.find('.window-content input[name=\"draw\"]:checked').val() ===\r\n\t\t\t\t\t\"unique\";\r\n\t\t\t\treturn { type, unique };\r\n\t\t\t},\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, { i18n: localize }),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-create-table\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tif (result.type === \"default\") createDefaultTable(result.unique);\r\n\telse createCustomTable(result.unique);\r\n}\r\n\r\nasync function createCustomTable(unique) {\r\n\tconst table = await createCustomActionsTable(unique);\r\n\tawait setTable(table);\r\n\ttable.sheet?.render(true);\r\n}\r\n\r\nfunction createCustomActionsTable(unique = true) {\r\n\tconst source = getTableSource(unique);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function createDefaultTable(unique) {\r\n\tconst localize = subLocalize(\"templates.createTable.default.confirm\");\r\n\tlet table = await getDefaultWorldTable();\r\n\r\n\tif (table) {\r\n\t\tconst override = await Dialog.confirm({\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tcontent: localize(\"content\"),\r\n\t\t});\r\n\r\n\t\tif (override) {\r\n\t\t\tconst update = getTableSource(unique);\r\n\t\t\tawait table.update(update);\r\n\t\t\treturn setTable(table, true);\r\n\t\t}\r\n\t}\r\n\r\n\ttable = await createDefautActionsTable(unique);\r\n\tawait setTable(table);\r\n}\r\n\r\nasync function createDefautActionsTable(unique = true) {\r\n\tconst table = await fromUuid(TABLE_UUID);\r\n\tconst source = getTableSource(unique, table);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function setTable(table, normalize = false) {\r\n\tif (normalize) await table.normalize();\r\n\tawait setSetting(\"hero-table\", table.uuid);\r\n}\r\n\r\nfunction getTableSource(unique, table) {\r\n\tconst source = {\r\n\t\tname: localize(\"hero.table.name\"),\r\n\t\treplacement: !(unique ?? true),\r\n\t\timg: TABLE_ICON,\r\n\t\tdescription: localize(\"hero.table.description\"),\r\n\t\tflags: {\r\n\t\t\tcore: {\r\n\t\t\t\tsourceId: TABLE_UUID,\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\tif (!table) return source;\r\n\treturn mergeObject(deepClone(table._source), source);\r\n}\r\n\r\nasync function removeHeroActions() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.removeActions\");\r\n\tconst template = templatePath(\"hero/dialogs/remove-actions\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"remove\"),\r\n\t\t\ticon: '<i class=\"fas fa-trash\"></i>',\r\n\t\t\tcallback: (html) =>\r\n\t\t\t\thtml\r\n\t\t\t\t\t.find('input[name=\"actor\"]:checked')\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((x) => game.actors.get(x.value))\r\n\t\t\t\t\t.filter((x) => x),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, {\r\n\t\t\tactors: game.actors.filter((x) => x.type === \"character\"),\r\n\t\t\ti18n: localize,\r\n\t\t}),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\trender: (html) => {\r\n\t\t\thtml.on(\"change\", 'input[name=\"all\"]', () =>\r\n\t\t\t\tremoveActionsToggleAll(html),\r\n\t\t\t);\r\n\t\t\thtml.on(\"change\", 'input[name=\"actor\"]', () =>\r\n\t\t\t\tremoveActionsToggleActor(html),\r\n\t\t\t);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst actors = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-remove-actions\",\r\n\t});\r\n\r\n\tif (!actors) return;\r\n\r\n\tif (!actors.length) {\r\n\t\tlocalize.warn(\"noSelection\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const actor of actors) {\r\n\t\tsetHeroActions(actor, []);\r\n\t}\r\n\r\n\tlocalize.info(\"removed\");\r\n}\r\n\r\nfunction removeActionsToggleAll(html) {\r\n\tconst state = html.find('input[name=\"all\"]')[0].checked;\r\n\thtml.find('input[name=\"actor\"]').prop(\"checked\", state);\r\n}\r\n\r\nfunction removeActionsToggleActor(html) {\r\n\tconst actors = html.find('input[name=\"actor\"]');\r\n\tconst checked = actors.filter(\":checked\");\r\n\tconst all = html.find('input[name=\"all\"]');\r\n\r\n\tif (actors.length === checked.length) {\r\n\t\tall.prop(\"checked\", true).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", true);\r\n\t} else if (!checked.length) {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", false);\r\n\t} else {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", true);\r\n\t}\r\n}\r\n\r\nfunction documentUuidFromTableResult(result) {\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.TEXT)\r\n\t\treturn /@UUID\\[([\\w\\.]+)\\]/.exec(result.text)?.[1];\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.DOCUMENT)\r\n\t\treturn `${result.documentCollection}.${result.documentId}`;\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.COMPENDIUM)\r\n\t\treturn `Compendium.${result.documentCollection}.${result.documentId}`;\r\n\treturn undefined;\r\n}\r\n\r\nasync function giveHeroActions(actor) {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst templateLocalize = subLocalize(\"hero.templates.giveAction\");\r\n\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\ttemplateLocalize.warn(\"noCharacter\");\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst table = await getDeckTable();\r\n\tif (!table) {\r\n\t\terror(\"hero.table.drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst isUnique = table.replacement === false;\r\n\r\n\tconst actionsList = (\r\n\t\tawait Promise.all(\r\n\t\t\ttable.results.map(async (result) => {\r\n\t\t\t\tconst uuid = documentUuidFromTableResult(result);\r\n\t\t\t\tif (!uuid) return;\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tkey: result.id,\r\n\t\t\t\t\tuuid,\r\n\t\t\t\t\tname: await getLabelfromTableResult(result, uuid),\r\n\t\t\t\t\tdrawn: result.drawn,\r\n\t\t\t\t};\r\n\t\t\t}),\r\n\t\t)\r\n\t).filter(Boolean);\r\n\r\n\tconst template = templatePath(\"hero/dialogs/give-action\");\r\n\tconst content = await renderTemplate(template, {\r\n\t\tactions: actionsList,\r\n\t\tisUnique,\r\n\t\ti18n: templateLocalize,\r\n\t});\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: templateLocalize(\"give\"),\r\n\t\t\ticon: '<i class=\"fa-solid fa-gift\"></i>',\r\n\t\t\tcallback: (html) => ({\r\n\t\t\t\tselected: html\r\n\t\t\t\t\t.find(\"[name=action]:checked\")\r\n\t\t\t\t\t.closest(\".action\")\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((el) => el.dataset),\r\n\t\t\t\tasDrawn: html.find(\"[name=drawn]\").prop(\"checked\") ?? false,\r\n\t\t\t\twithMessage: html.find(\"[name=message]\").prop(\"checked\"),\r\n\t\t\t}),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: templateLocalize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\ttitle: templateLocalize(\"title\"),\r\n\t\tcontent,\r\n\t\tbuttons,\r\n\t\trender: (html) => {\r\n\t\t\thtml.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-give-action\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst { selected, asDrawn, withMessage } = result;\r\n\tconst actions = getHeroActions(actor);\r\n\tconst tableUpdates = [];\r\n\r\n\tfor (const { uuid, name, key } of selected) {\r\n\t\tactions.push({ uuid, name });\r\n\t\tif (!asDrawn) continue;\r\n\r\n\t\tconst result = table.results.get(key);\r\n\t\tif (result && !result.drawn) tableUpdates.push(key);\r\n\t}\r\n\r\n\tif (tableUpdates.length) {\r\n\t\tawait table.updateEmbeddedDocuments(\r\n\t\t\t\"TableResult\",\r\n\t\t\ttableUpdates.map((key) => ({ _id: key, drawn: true })),\r\n\t\t);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\r\n\tif (withMessage) {\r\n\t\tcreateChatMessage({\r\n\t\t\tactor,\r\n\t\t\tactions: selected,\r\n\t\t\tlabel: (nb) => localize(\"hero.actions-give.header\", { nb }),\r\n\t\t\tsecret: true,\r\n\t\t});\r\n\t}\r\n}\r\n", "import { calculateDistanceBetweenPoints, getElementIndex } from \"./misc\";\r\n\r\n/** @type {DraggableData | null} */\r\nlet dragData = null;\r\n\r\nlet DRAG_ID = 0;\r\n\r\n/**\r\n * @template {DraggableOptions | DroppableOptions} T\r\n * @param {T} options\r\n * @param {OptionsFilter<T>} filters\r\n */\r\nfunction cleanOptions(options, filters) {\r\n\tfor (const [type, keys] of Object.entries(filters)) {\r\n\t\tfor (const key of keys) {\r\n\t\t\tconst option = options[key];\r\n\t\t\t// biome-ignore lint/suspicious/useValidTypeof: <explanation>\r\n\t\t\tif (!option || typeof option === type) continue;\r\n\t\t\toptions[option] = undefined;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {DraggableOptions} options\r\n */\r\nexport function makeDraggable(options) {\r\n\tif (!(options.element instanceof HTMLElement)) return;\r\n\r\n\tcleanOptions(options, {\r\n\t\tstring: [\"draggedClass\", \"group\", \"selector\", \"filter\", \"identifier\"],\r\n\t\tnumber: [\"triggerDistance\"],\r\n\t\tboolean: [\"cancelOnRightClick\"],\r\n\t\tfunction: [\"onCancel\", \"onDragEnd\", \"onDragStart\"],\r\n\t});\r\n\r\n\toptions.triggerDistance ??= 6;\r\n\r\n\toptions.cancelOnRightClick ??= true;\r\n\r\n\toptions.cursorImage ??= {};\r\n\toptions.cursorImage.id =\r\n\t\ttypeof options.cursorImage.id === \"string\" ? options.cursorImage.id : \"\";\r\n\toptions.cursorImage.img =\r\n\t\ttypeof options.cursorImage.img === \"function\"\r\n\t\t\t? options.cursorImage.img\r\n\t\t\t: undefined;\r\n\r\n\toptions.droppables ??= [];\r\n\r\n\tfor (let i = options.droppables.length - 1; i >= 0; i--) {\r\n\t\tconst droppable = options.droppables[i];\r\n\r\n\t\tif (!(droppable.element instanceof HTMLElement)) {\r\n\t\t\toptions.droppables.splice(i, 1);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tcleanOptions(droppable, {\r\n\t\t\tstring: [\"selector\", \"overClass\", \"filter\"],\r\n\t\t\tboolean: [\"purgeOnLeave\"],\r\n\t\t\tfunction: [\"onDragEnter\", \"onDragLeave\", \"onDragOver\", \"onDrop\"],\r\n\t\t});\r\n\t}\r\n\r\n\toptions.element.addEventListener(\"mousedown\", (event) =>\r\n\t\tonMouseDown(event, options),\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragCancel(event) {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.canceled = true;\r\n\r\n\tif (dragData.dragging && dragData.draggable.ghost) {\r\n\t\tdragData.draggable.ghost.reset();\r\n\t}\r\n\r\n\tif (dragData.dragging && dragData.options.onCancel) {\r\n\t\tawait dragData.options.onCancel(event, dragData.draggable);\r\n\t}\r\n\r\n\tcleanUp();\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragEnd(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging && dragData.options.onDragEnd) {\r\n\t\tawait dragData.options.onDragEnd(event, dragData.draggable, {\r\n\t\t\tcanceled: dragData.canceled,\r\n\t\t\tdropped: dragData.dropped,\r\n\t\t});\r\n\t}\r\n\r\n\twindow.removeEventListener(\"mousemove\", onMouseMove);\r\n\twindow.removeEventListener(\"mouseup\", onMouseUp);\r\n\r\n\tdragData = null;\r\n}\r\n\r\nfunction cleanUp() {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.draggable.classList.purge();\r\n\tdragData.draggable.ghost?.classList.purge();\r\n\tdragData.cursorElement?.remove();\r\n\r\n\tfor (const { classList } of Object.values(dragData.hovered)) {\r\n\t\tclassList.purge();\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n * @param {DraggableOptions} options\r\n */\r\nfunction onMouseDown(event, options) {\r\n\tif (\r\n\t\tevent.button === 2 &&\r\n\t\tdragData?.dragging &&\r\n\t\tdragData.options.cancelOnRightClick\r\n\t) {\r\n\t\tonDragCancel(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (event.button) return;\r\n\r\n\tconst target = closestInside(event.target, options.element, options);\r\n\tif (!target) return;\r\n\r\n\t/** @type {DraggableGhost | undefined} */\r\n\tlet _ghost;\r\n\r\n\tconst targetIndex = getElementIndex(target);\r\n\tconst targetParent = target.parentElement;\r\n\tconst targetClassList = newClassList(target);\r\n\r\n\t/** @type {DraggableData} */\r\n\tdragData = {\r\n\t\tcanceled: false,\r\n\t\tdragging: false,\r\n\t\tdropped: false,\r\n\t\toptions,\r\n\t\tgroup: options.group,\r\n\t\tdraggable: {\r\n\t\t\tidentifier: options.identifier,\r\n\t\t\telement: target,\r\n\t\t\ttriggeringElement: event.target,\r\n\t\t\tx: event.clientX,\r\n\t\t\ty: event.clientY,\r\n\t\t\tparent: targetParent,\r\n\t\t\tindex: targetIndex,\r\n\t\t\tclassList: targetClassList,\r\n\t\t\tget ghost() {\r\n\t\t\t\tif (_ghost) {\r\n\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t_ghost.classList.add(options.ghostClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn _ghost;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst { element = target.cloneNode(true), index = Infinity } =\r\n\t\t\t\t\toptions.createGhost?.(target, targetIndex) ?? {};\r\n\r\n\t\t\t\tconst classList = newClassList(element);\r\n\r\n\t\t\t\tif (options.draggedClass && element !== target) {\r\n\t\t\t\t\telement.classList.remove(options.draggedClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\tclassList.add(options.ghostClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t_ghost = {\r\n\t\t\t\t\telement,\r\n\t\t\t\t\tclassList,\r\n\t\t\t\t\tindex,\r\n\t\t\t\t\treset: () => {\r\n\t\t\t\t\t\telement.remove();\r\n\t\t\t\t\t\tif (element === target) {\r\n\t\t\t\t\t\t\tconst child = targetParent.children[targetIndex];\r\n\t\t\t\t\t\t\ttargetParent.insertBefore(target, child);\r\n\t\t\t\t\t\t\t_ghost.index = targetIndex;\r\n\t\t\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t\t\tclassList.remove(options.ghostClass);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t_ghost.index = Infinity;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t};\r\n\r\n\t\t\t\treturn _ghost;\r\n\t\t\t},\r\n\t\t\tresetPosition: () => {\r\n\t\t\t\ttarget.remove();\r\n\t\t\t\ttargetParent.children[targetIndex].before(target);\r\n\t\t\t},\r\n\t\t},\r\n\t\tdroppables: options.droppables.map((droppable) => ({\r\n\t\t\t...droppable,\r\n\t\t\tid: DRAG_ID++,\r\n\t\t})),\r\n\t\thovered: {},\r\n\t};\r\n\r\n\twindow.addEventListener(\"mousemove\", onMouseMove);\r\n\twindow.addEventListener(\"mouseup\", onMouseUp);\r\n}\r\n\r\nasync function onMouseMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tonDragMove(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst { draggable } = dragData;\r\n\tconst distance = calculateDistanceBetweenPoints(\r\n\t\tdraggable.x,\r\n\t\tdraggable.y,\r\n\t\tclientX,\r\n\t\tclientY,\r\n\t);\r\n\r\n\tif (distance > dragData.options.triggerDistance) {\r\n\t\tawait onDragStart(event);\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onMouseUp(event) {\r\n\tif (event.button || !dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tlet dropped = false;\r\n\r\n\t\tcleanUp();\r\n\r\n\t\tawait Promise.all(\r\n\t\t\tObject.values(dragData.hovered).map(async (hovered) => {\r\n\t\t\t\tif (!hovered.droppable.onDrop) return;\r\n\r\n\t\t\t\tconst hasDropped = await hovered.droppable.onDrop(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\t\ttriggeringElement: hovered.triggeringElement,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (hasDropped) dropped = true;\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\tdragData.dropped = dropped;\r\n\t}\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragStart(event) {\r\n\tif (dragData.dragging) return;\r\n\r\n\tdragData.dragging = true;\r\n\r\n\tif (dragData.options.cursorImage.img) {\r\n\t\tconst img = dragData.options.cursorImage.img(dragData.draggable.element);\r\n\t\tif (img instanceof HTMLElement) {\r\n\t\t\tdragData.cursorElement = img;\r\n\t\t} else {\r\n\t\t\tdragData.cursorElement = new Image();\r\n\t\t\tdragData.cursorElement.src = typeof img === \"string\" ? img : \"\";\r\n\t\t}\r\n\t} else {\r\n\t\tdragData.cursorElement = dragData.draggable.element.cloneNode(true);\r\n\t}\r\n\r\n\tdragData.cursorElement.id = dragData.options.cursorImage.id;\r\n\r\n\tif (dragData.options.draggedClass) {\r\n\t\tdragData.draggable.classList.add(dragData.options.draggedClass);\r\n\t}\r\n\r\n\tdocument.body.appendChild(dragData.cursorElement);\r\n\r\n\tawait dragData.options.onDragStart?.(event, dragData.draggable);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst cursorElement = dragData.cursorElement;\r\n\r\n\tconst offsetX = cursorElement.offsetWidth / 2;\r\n\tconst offsetY = cursorElement.offsetHeight / 2;\r\n\r\n\tcursorElement.style.left = `${clientX - offsetX}px`;\r\n\tcursorElement.style.top = `${clientY - offsetY}px`;\r\n\r\n\tawait Promise.all(\r\n\t\tdragData.droppables.map(async (droppable) => {\r\n\t\t\tconst target = closestInside(event.target, droppable.element, {\r\n\t\t\t\tselector: droppable.selector,\r\n\t\t\t\tfilter: droppable.filter,\r\n\t\t\t});\r\n\t\t\tconst hovered = dragData.hovered[droppable.id];\r\n\r\n\t\t\tif (hovered && (!target || hovered.element !== target)) {\r\n\t\t\t\tconst left = await droppable.onDragLeave?.(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (left !== false) {\r\n\t\t\t\t\tdelete dragData.hovered[droppable.id];\r\n\t\t\t\t\tif (droppable.purgeOnLeave) {\r\n\t\t\t\t\t\thovered.classList.purge();\r\n\t\t\t\t\t} else if (droppable.overClass) {\r\n\t\t\t\t\t\thovered.classList.remove(droppable.overClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!target) return;\r\n\r\n\t\t\tif (!hovered) {\r\n\t\t\t\tconst classList = newClassList(target);\r\n\r\n\t\t\t\tconst entered = await droppable.onDragEnter?.(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (entered !== false) {\r\n\t\t\t\t\tif (droppable.overClass) classList.add(droppable.overClass);\r\n\r\n\t\t\t\t\tdragData.hovered[droppable.id] = {\r\n\t\t\t\t\t\tid: droppable.id,\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\tdroppable,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t} else if (droppable.onDragOver) {\r\n\t\t\t\tawait droppable.onDragOver(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}),\r\n\t);\r\n}\r\n\r\n/**\r\n *\r\n * @param {HTMLElement} target\r\n * @returns {DraggableClassList}\r\n */\r\nexport function newClassList(target) {\r\n\treturn new (class extends Set {\r\n\t\tadd(value) {\r\n\t\t\ttarget.classList.add(value);\r\n\t\t\tsuper.add(value);\r\n\t\t}\r\n\t\tremove(value) {\r\n\t\t\ttarget.classList.remove(value);\r\n\t\t\tsuper.delete(value);\r\n\t\t}\r\n\t\ttoggle(value, enabled) {\r\n\t\t\tconst toggled = enabled ?? !target.classList.contains(value);\r\n\t\t\tif (toggled) this.add(value);\r\n\t\t\telse this.remove(value);\r\n\t\t}\r\n\t\tcontains(value) {\r\n\t\t\treturn this.has(value);\r\n\t\t}\r\n\t\tpurge() {\r\n\t\t\ttarget.classList.remove(...this);\r\n\t\t}\r\n\t})();\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {HTMLElement} parent\r\n * @param {Object} [options]\r\n * @param {string} [options.selector]\r\n * @param {string} [options.filter]\r\n * @returns {HTMLElement | undefined}\r\n */\r\nexport function closestInside(target, parent, { selector, filter } = {}) {\r\n\tif (!parent.contains(target)) return;\r\n\r\n\tif (!selector && !filter) return parent;\r\n\r\n\tlet element;\r\n\tlet cursor = target;\r\n\r\n\twhile (true) {\r\n\t\tif (filter && cursor.matches(filter)) return;\r\n\r\n\t\tif (!element && selector && cursor.matches(selector)) {\r\n\t\t\telement = cursor;\r\n\t\t}\r\n\r\n\t\tif (cursor === parent) break;\r\n\r\n\t\tcursor = cursor.parentElement;\r\n\t}\r\n\r\n\treturn !selector ? parent : element;\r\n}\r\n", "import {\r\n\tgetCharacterSheetTab,\r\n\tisPlayedActor,\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../shared/actor\";\r\nimport { closestInside, makeDraggable } from \"../shared/draggable\";\r\nimport { getFlag, setFlag } from \"../shared/flags\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport {\r\n\tcanBeInvested,\r\n\thasWornSlot,\r\n\tisHandwrapsOfMightyBlows,\r\n\tisHeld,\r\n\tisInvestedOrWornAs,\r\n\tisOneHanded,\r\n\tisTwoHanded,\r\n\titemCarryUpdate,\r\n} from \"../shared/item\";\r\nimport {\r\n\tgetElementIndex,\r\n\tgetInMemory,\r\n\tindexIsValid,\r\n\tsetInMemory,\r\n} from \"../shared/misc\";\r\nimport { error } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst closeHook = createHook(\r\n\t\"closeCharacterSheetPF2e\",\r\n\tcloseCharacterSheetPF2e,\r\n);\r\n\r\nlet dragging = false;\r\n\r\nexport function registerInventory() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"inventory\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tready: (isGm) => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nlet dragIdentifier;\r\n\r\nconst COINS = [\r\n\t\"platinum-pieces\",\r\n\t\"gold-pieces\",\r\n\t\"silver-pieces\",\r\n\t\"copper-pieces\",\r\n];\r\n\r\nfunction setup(value) {\r\n\tconst enabled = value ?? getSetting(\"inventory\");\r\n\tif (enabled) {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"inventory\",\r\n\t\t\ttemplateFolder: \"inventory/sheet\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t\tonRender,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"inventory\");\r\n\t}\r\n\tcloseHook(enabled);\r\n}\r\n\r\nfunction closeCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\tif (!getInMemory(sheet, \"inventory.requireSave\")) return;\r\n\r\n\tconst tab = getCharacterSheetTab(html, \"inventory\")[0];\r\n\tconst data = getCurrentData(tab);\r\n\tif (!data) return;\r\n\r\n\tsetFlag(actor, \"inventory\", data);\r\n}\r\n\r\nfunction onRender(actor, sheet, inner) {\r\n\tconst sidebar = inner.find(\"> aside\");\r\n\tsidebar.css(\"position\", \"relative\");\r\n\tsidebar.append(\r\n\t\t\"<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>\",\r\n\t);\r\n}\r\n\r\nfunction getCurrentData(tabElement) {\r\n\tif (!tabElement) return;\r\n\r\n\tconst alternate = tabElement.querySelector(\":scope > .alternate\");\r\n\tconst equipped = alternate.querySelector(\"[data-area='equipped']\");\r\n\r\n\tconst equippedItemId = (slot) => {\r\n\t\tconst el = equipped.querySelector(`[data-equipped-slot='${slot}']`);\r\n\t\tconst item = el.querySelector(\"[data-item-id]\");\r\n\t\treturn item?.dataset.itemId ?? null;\r\n\t};\r\n\r\n\tconst itemIds = (parent) => {\r\n\t\tconst ids = {};\r\n\t\tconst items = parent.querySelectorAll(\":scope > [data-item-id]\");\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tids[item.dataset.itemId] = i;\r\n\t\t}\r\n\t\treturn ids;\r\n\t};\r\n\r\n\tconst tabs = {};\r\n\tfor (const tab of alternate.querySelectorAll(\"[data-area='items-grid']\")) {\r\n\t\tconst tabId = tab.dataset.tabId;\r\n\t\ttabs[tabId] = itemIds(tab);\r\n\t}\r\n\r\n\treturn {\r\n\t\tequipped: {\r\n\t\t\thands: [equippedItemId(\"left-hand\"), equippedItemId(\"right-hand\")],\r\n\t\t\tarmor: [equippedItemId(\"armor\")],\r\n\t\t\tothers: itemIds(equipped),\r\n\t\t},\r\n\t\ttabs,\r\n\t};\r\n}\r\n\r\nasync function getData(actor, sheet, tabElement) {\r\n\tconst flags = getFlag(actor, \"inventory\");\r\n\tconst data = getCurrentData(tabElement[0]) ??\r\n\t\tflags ?? {\r\n\t\t\tequipped: {\r\n\t\t\t\thands: [null, null],\r\n\t\t\t\tarmor: [null],\r\n\t\t\t\tothers: {},\r\n\t\t\t},\r\n\t\t\ttabs: {},\r\n\t\t};\r\n\r\n\tif (!flags) {\r\n\t\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n\t}\r\n\r\n\tconst tabs = new Collection();\r\n\tconst orphans = {};\r\n\tconst containers = new Set();\r\n\tconst equipped = {\r\n\t\thands: [null, null],\r\n\t\tarmor: [null],\r\n\t\tothers: [],\r\n\t};\r\n\r\n\tfunction getTab(item) {\r\n\t\tconst tabId = item?.id;\r\n\r\n\t\tlet tab = tabs.get(tabId);\r\n\t\tif (tab) return tab;\r\n\r\n\t\ttab = {\r\n\t\t\tid: tabId,\r\n\t\t\titem: item,\r\n\t\t\tparent: item?.container,\r\n\t\t\tcontainers: [],\r\n\t\t\tmatrix: [],\r\n\t\t\tparents: [],\r\n\t\t};\r\n\r\n\t\ttabs.set(tabId, tab);\r\n\t\treturn tab;\r\n\t}\r\n\r\n\tfor (const item of actor.inventory) {\r\n\t\tif (\r\n\t\t\titem.isOfType(\"treasure\") &&\r\n\t\t\titem.system.stackGroup === \"coins\" &&\r\n\t\t\tCOINS.includes(item.slug)\r\n\t\t) {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst itemId = item.id;\r\n\t\tconst parent = item.container;\r\n\r\n\t\t// we retrieve the parent tab, undefined === root inventory\r\n\t\tconst tab = getTab(parent);\r\n\r\n\t\tconst addOrphan = (item) => {\r\n\t\t\torphans[tab.id] ??= [];\r\n\t\t\torphans[tab.id].push(item);\r\n\t\t};\r\n\r\n\t\tif (item.isOfType(\"backpack\")) {\r\n\t\t\ttab.containers.push(item);\r\n\t\t\tcontainers.add(item);\r\n\r\n\t\t\t// we create the tab for this container, in case it is empty\r\n\t\t\tgetTab(item);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst handsHeld = item.handsHeld;\r\n\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\tif (handsHeld === 2 && equippedHands === 0) {\r\n\t\t\tif (data.equipped.hands[0] === itemId) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (handsHeld === 1 && equippedHands <= 1) {\r\n\t\t\tconst handIndex = data.equipped.hands.indexOf(itemId);\r\n\t\t\tif (indexIsValid(handIndex)) {\r\n\t\t\t\tequipped.hands[handIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\tif (data.equipped.armor[0] === itemId) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\tisInvestedOrWornAs(item)\r\n\t\t) {\r\n\t\t\tconst equippedIndex = data.equipped.others[itemId];\r\n\t\t\tif (indexIsValid(equippedIndex)) {\r\n\t\t\t\tequipped.others[equippedIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst index = data.tabs[tab.id]?.[itemId];\r\n\t\tif (indexIsValid(index)) {\r\n\t\t\ttab.matrix[index] = item;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\taddOrphan(item);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tconst tabOrphans = orphans[tab.id];\r\n\t\tif (!tabOrphans) continue;\r\n\r\n\t\tfor (const item of tabOrphans) {\r\n\t\t\tconst handsHeld = item.handsHeld;\r\n\t\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\t\tif (equippedHands === 0 && handsHeld === 2) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (equippedHands <= 1 && handsHeld === 1) {\r\n\t\t\t\tconst otherIndex = equipped.hands[0] ? 1 : 0;\r\n\t\t\t\tequipped.hands[otherIndex] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\t\tisInvestedOrWornAs(item)\r\n\t\t\t) {\r\n\t\t\t\tequipped.others.push(item);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\ttab.matrix.push(item);\r\n\t\t}\r\n\r\n\t\ttab.matrix = tab.matrix.filter(Boolean);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tlet parent = tab.parent;\r\n\r\n\t\twhile (parent) {\r\n\t\t\ttab.parents.push(parent);\r\n\t\t\tparent = parent.container;\r\n\t\t}\r\n\r\n\t\ttab.parents.reverse();\r\n\r\n\t\tconst grouped = [tab.containers, tab.parents, tab.item].flat();\r\n\t\ttab.trailings = containers.filter((item) => !grouped.includes(item));\r\n\t}\r\n\r\n\t// if no item exist on the character, we still want one tab\r\n\tif (!tabs.size) getTab(undefined);\r\n\r\n\tequipped.others = equipped.others.filter(Boolean);\r\n\r\n\tconst activeTabId = getInMemory(sheet, \"inventory.activeTab\");\r\n\r\n\treturn {\r\n\t\ttabs: Array.from(tabs.values()),\r\n\t\tequipped,\r\n\t\tactor,\r\n\t\tselectedTab: tabs.get(activeTabId)?.id,\r\n\t\tcontainerBulk: (container) => {\r\n\t\t\tconst capacity = container.capacity;\r\n\t\t\treturn `${capacity.value.toString()} / ${capacity.max.toString()}`;\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction addEvents(tab, sheet, actor, inner) {\r\n\tconst containerTabs = tab.find(\"[data-tab-id]\");\r\n\tfor (const container of tab.find(\"[data-container-id]\")) {\r\n\t\tcontainer.addEventListener(\"click\", (event) => {\r\n\t\t\tconst tabId = container.dataset.containerId;\r\n\r\n\t\t\tcontainerTabs.removeClass(\"active\");\r\n\t\t\tcontainerTabs.filter(`[data-tab-id=${tabId}]`).addClass(\"active\");\r\n\r\n\t\t\tsetInMemory(sheet, \"inventory.activeTab\", tabId);\r\n\t\t});\r\n\t}\r\n\r\n\tconst sidebar = inner.find(\"#pf2e-toobelt-inventory-item-details\")[0];\r\n\tconst itemElements = tab.find(\"[data-item-id], [data-container-id]\");\r\n\tfor (const itemElement of itemElements) {\r\n\t\titemElement.addEventListener(\"mouseenter\", (event) =>\r\n\t\t\tonItemDetails(event, actor, itemElement, sidebar),\r\n\t\t);\r\n\t\titemElement.addEventListener(\"mouseleave\", (event) => {\r\n\t\t\tsidebar.classList.add(\"hidden\");\r\n\t\t});\r\n\t}\r\n\r\n\tif (!actor.isOwner) return;\r\n\r\n\tdragIdentifier = randomID();\r\n\r\n\tmakeDraggable({\r\n\t\telement: tab[0],\r\n\t\tselector: \"[data-item-id]\",\r\n\t\tfilter: \"input\",\r\n\t\tdraggedClass: \"dragged\",\r\n\t\tghostClass: \"ghost\",\r\n\t\tidentifier: dragIdentifier,\r\n\t\tcursorImage: {\r\n\t\t\tid: \"pf2e-toolbelt-inventory-cursor-image\",\r\n\t\t\timg: (target) => target.dataset.itemImg,\r\n\t\t},\r\n\t\tcreateGhost: createGhost,\r\n\t\tonDragStart: () => onDragStart(sidebar),\r\n\t\tonDragEnd: (event, draggable, options) => onDragEnd(sheet, options),\r\n\t\tdroppables: [\r\n\t\t\tcontainersDroppable(tab, sheet),\r\n\t\t\totherEquipmentDroppable(tab, sheet),\r\n\t\t\tlargeEquipmentDroppable(tab, sheet),\r\n\t\t\titemsListDroppable(tab, sheet),\r\n\t\t\titemsGridDroppable(tab, sheet),\r\n\t\t],\r\n\t});\r\n}\r\n\r\nasync function onItemDetails(event, actor, itemElement, sidebar) {\r\n\tif (dragging) return;\r\n\r\n\tlet details = itemElement.dataset.details;\r\n\r\n\tif (!details) {\r\n\t\tconst item = getItemFromElement(actor, itemElement);\r\n\t\tif (!item) return;\r\n\r\n\t\tdetails = await renderTemplate(templatePath(\"inventory/details\"), { item });\r\n\t\titemElement.dataset.details = details;\r\n\t}\r\n\r\n\tsidebar.innerHTML = details;\r\n\tsidebar.classList.remove(\"hidden\");\r\n}\r\n\r\nfunction onDragStart(sidebar) {\r\n\tdragging = true;\r\n\tsidebar.classList.add(\"hidden\");\r\n}\r\n\r\n/**\r\n * @param {*} sheet\r\n * @param {Parameters<DraggableDragEndFunction>[2]} options\r\n */\r\nfunction onDragEnd(sheet, { dropped, canceled }) {\r\n\tdragging = false;\r\n\tif (canceled || !dropped) return;\r\n\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n}\r\n\r\n/** @type {DraggableGhostFunction} */\r\nfunction createGhost(dragged, draggedIndex) {\r\n\treturn dragged.parentElement.dataset.area === \"items-grid\"\r\n\t\t? { element: dragged, index: draggedIndex }\r\n\t\t: undefined;\r\n}\r\n\r\n/** @param {DraggableObj} */\r\nfunction checkIdentifier(draggable) {\r\n\tif (draggable.identifier === dragIdentifier) return true;\r\n\terror(\"inventory.identifier.error\");\r\n\treturn false;\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsGridDroppable(html, sheet) {\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tif (\r\n\t\t\tdroppable.element === draggable.element ||\r\n\t\t\tdroppable.element === draggable.ghost\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst ghost = draggable.ghost;\r\n\t\tconst index = getElementIndex(droppable.element);\r\n\t\tconst target =\r\n\t\t\tghost.index >= index\r\n\t\t\t\t? droppable.element\r\n\t\t\t\t: droppable.element.nextElementSibling;\r\n\r\n\t\tdroppable.element.parentElement.insertBefore(ghost.element, target);\r\n\t\tghost.index = index;\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tconst parentGrid = droppable.element.parentElement;\r\n\t\tif (!parentGrid) return;\r\n\r\n\t\tconst isItem = closestInside(droppable.triggeringElement, parentGrid, {\r\n\t\t\tselector: \"[data-item-id]\",\r\n\t\t});\r\n\t\tif (isItem) return;\r\n\r\n\t\tconst parentList = parentGrid.parentElement;\r\n\t\tif (!parentList.contains(droppable.triggeringElement)) return;\r\n\r\n\t\tparentGrid.appendChild(draggable.ghost.element);\r\n\t\tdraggable.ghost.index = Infinity;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-grid'] [data-item-id]\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsListDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst isItem = closestInside(\r\n\t\t\tdroppable.triggeringElement,\r\n\t\t\tdroppable.element,\r\n\t\t\t{\r\n\t\t\t\tselector: \"[data-item-id]\",\r\n\t\t\t},\r\n\t\t);\r\n\t\tif (isItem) return;\r\n\r\n\t\tdroppable.element\r\n\t\t\t.querySelector(\"[data-area='items-grid']\")\r\n\t\t\t.appendChild(draggable.ghost.element);\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tdraggable.ghost.reset();\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return false;\r\n\r\n\t\tconst updates = [];\r\n\r\n\t\tif (draggable.element === draggable.ghost.element) {\r\n\t\t\tdraggable.ghost.classList.purge();\r\n\t\t\tcleanContainerItem(draggable.element);\r\n\t\t} else {\r\n\t\t\tmoveItemToContainer({\r\n\t\t\t\thtml,\r\n\t\t\t\tupdates,\r\n\t\t\t\titem,\r\n\t\t\t\t...draggable,\r\n\t\t\t\ttarget: draggable.ghost.element,\r\n\t\t\t});\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t\tdraggable.ghost.reset();\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-list']\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction largeEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\tconst rightHand = html.find(\"[data-equipped-slot=right-hand]\")[0];\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst slot = droppable.element.dataset.equippedSlot;\r\n\r\n\t\tif (\r\n\t\t\tslot === draggable.parent.dataset.equippedSlot ||\r\n\t\t\tdroppable.element.querySelector(\"[data-two-hands]\")\r\n\t\t) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canDrop = slot === \"armor\" ? item.isOfType(\"armor\") : true;\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tslot,\r\n\t\t\tcanDrop,\r\n\t\t};\r\n\t}\r\n\r\n\tfunction moveItemToSlot({\r\n\t\tupdates,\r\n\t\titem,\r\n\t\telement,\r\n\t\tdrop,\r\n\t\tnoTwoHand = false,\r\n\t\tnoUpdate = false,\r\n\t}) {\r\n\t\tconst dropSlot = drop instanceof HTMLElement ? drop : drop.element;\r\n\t\tconst slot = dropSlot.dataset.equippedSlot;\r\n\t\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\t\tconst isOneHand = isOneHanded(item);\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\t\tconst canInvest = canBeInvested(item);\r\n\r\n\t\tdropSlot.appendChild(movable);\r\n\r\n\t\tconst move = (carryType, handsHeld, inSlot, invested) => {\r\n\t\t\tif (!noUpdate) {\r\n\t\t\t\tupdates.push(\r\n\t\t\t\t\titemCarryUpdate(item, {\r\n\t\t\t\t\t\tcarryType,\r\n\t\t\t\t\t\thandsHeld,\r\n\t\t\t\t\t\tinSlot,\r\n\t\t\t\t\t\tinvested,\r\n\t\t\t\t\t\tcontainerId: null,\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tmovable.classList.toggle(\"invested\", canInvest && invested);\r\n\t\t};\r\n\r\n\t\tif (slot === \"armor\") {\r\n\t\t\tmove(\"worn\", 0, true, true);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (slot === \"right-hand\") {\r\n\t\t\tmove(\"held\", 1, false, isOneHand);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tmove(\r\n\t\t\t\"held\",\r\n\t\t\tisTwoHand && !noTwoHand ? 2 : 1,\r\n\t\t\tfalse,\r\n\t\t\tisHeld(item) && (!isTwoHand || !noTwoHand),\r\n\t\t);\r\n\t}\r\n\r\n\t/** @param {HTMLElement | {element: HTMLElement}} */\r\n\tfunction getSlottedItem(slot) {\r\n\t\tconst slotElement = slot instanceof HTMLElement ? slot : slot.element;\r\n\t\tconst element = slotElement.querySelector(\"[data-item-id]\");\r\n\t\tconst item = getItemFromElement(actor, element);\r\n\t\treturn { element, item };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\r\n\t\tif (canDrop !== undefined) {\r\n\t\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t\t}\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { item, canDrop, slot } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = [];\r\n\t\tconst slotted = getSlottedItem(droppable);\r\n\t\tconst dragArea = draggable.parent.dataset.area;\r\n\t\tconst dragSlot = draggable.parent.dataset.equippedSlot;\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\r\n\t\tlet noUpdate = false;\r\n\r\n\t\tif (dragArea === \"equipped\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({ html, updates, ...slotted });\r\n\t\t\t}\r\n\t\t} else if (dragArea === \"items-grid\") {\r\n\t\t\tif (slot === \"left-hand\" && isTwoHand) {\r\n\t\t\t\tconst otherSlotted = getSlottedItem(rightHand);\r\n\t\t\t\tif (otherSlotted.item) {\r\n\t\t\t\t\tmoveItemToContainer({ html, updates, ...otherSlotted });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\ttarget: draggable.element,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (dragSlot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tif (slotted.item.isOfType(\"armor\")) {\r\n\t\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\t\thtml,\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (slot === \"right-hand\") {\r\n\t\t\tnoUpdate = true;\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t\tnoTwoHand: true,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slotted.item) {\r\n\t\t\tif (isTwoHand) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t});\r\n\t\t\t\tnoUpdate = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tmoveItemToSlot({\r\n\t\t\tupdates,\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\tdrop: droppable,\r\n\t\t\tnoUpdate,\r\n\t\t});\r\n\r\n\t\tif (slot === \"left-hand\" || dragSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped] .main-items\")[0],\r\n\t\tselector: \"[data-equipped-slot]\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @return {DroppableObj} */\r\nfunction otherEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tif (draggable.parent === droppable.element) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (\r\n\t\t\t!item.isIdentified ||\r\n\t\t\t!(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item))\r\n\t\t) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canInvest = canBeInvested(item);\r\n\t\tconst canEquip = hasWornSlot(item);\r\n\t\tif (!canInvest && !canEquip) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\treturn { canDrop: true, item, canInvest };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop, canInvest } = getData(draggable, droppable);\r\n\t\tif (canDrop === undefined) return;\r\n\r\n\t\tdroppable.classList.add(\"show\");\r\n\t\tdroppable.classList.toggle(\"add-forbidden\", !canDrop);\r\n\t\tdroppable.classList.toggle(\"add-invest\", canDrop && canInvest);\r\n\t\tdroppable.classList.toggle(\"add-equip\", canDrop && !canInvest);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, canInvest, item } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tdroppable.element.appendChild(draggable.element);\r\n\t\tdraggable.element.classList.toggle(\"invested\", canInvest);\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", [\r\n\t\t\titemCarryUpdate(item, {\r\n\t\t\t\tcontainerId: null,\r\n\t\t\t\tinSlot: true,\r\n\t\t\t\tinvested: true,\r\n\t\t\t}),\r\n\t\t]);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped]\")[0],\r\n\t\tfilter: \".main-items\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction containersDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return { canDrop: false };\r\n\r\n\t\tconst containerId = droppable.element.dataset.containerId;\r\n\r\n\t\tif (containerId === \"undefined\") return { item, canDrop: true };\r\n\r\n\t\tconst container = actor.items.get(containerId);\r\n\t\tif (!container) return { canDrop: false };\r\n\r\n\t\tconst capacity = container.capacity;\r\n\t\tconst remaining = capacity.max.minus(capacity.value);\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tcontainer,\r\n\t\t\tcanDrop: remaining.value >= item.bulk.value,\r\n\t\t};\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, item, container } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = moveItemToContainer({\r\n\t\t\thtml,\r\n\t\t\tupdates: [],\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\ttarget: container,\r\n\t\t});\r\n\r\n\t\tif (draggable.parent.dataset.equippedSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-container-id]\",\r\n\t\tfilter: \".back\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\nfunction cleanContainerItem(item) {\r\n\titem.classList.remove(\"invested\");\r\n\titem.querySelector(\".vignette.hands\")?.remove();\r\n}\r\n\r\nfunction moveItemToContainer({ html, updates, item, element, target }) {\r\n\tconst targetIsElement = target instanceof HTMLElement;\r\n\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\r\n\tlet containerId = targetIsElement\r\n\t\t? target.closest(\"[data-tab-id]\").dataset.tabId\r\n\t\t: target instanceof Item\r\n\t\t  ? target.id\r\n\t\t  : target;\r\n\r\n\tcleanContainerItem(movable);\r\n\r\n\tif (targetIsElement) {\r\n\t\ttarget.before(movable);\r\n\t} else {\r\n\t\thtml\r\n\t\t\t.find(`.container-tab[data-tab-id=${containerId}] [data-area=items-grid]`)\r\n\t\t\t.append(movable);\r\n\t}\r\n\r\n\tcontainerId = [undefined, \"undefined\"].includes(containerId)\r\n\t\t? null\r\n\t\t: containerId;\r\n\r\n\tupdates.push(\r\n\t\titemCarryUpdate(item, {\r\n\t\t\tcontainerId: containerId,\r\n\t\t\tinSlot: false,\r\n\t\t\tinvested: false,\r\n\t\t\tcarryType: containerId ? \"stowed\" : \"worn\",\r\n\t\t\thandsHeld: 0,\r\n\t\t}),\r\n\t);\r\n\r\n\treturn updates;\r\n}\r\n\r\nfunction checkForTwoHandedSlots(html, actor) {\r\n\t/** @type {HTMLElement} */\r\n\tconst equipped = html.find(\"[data-area='equipped'] .main-items\")[0];\r\n\tconst leftHand = equipped.querySelector(\"[data-equipped-slot='left-hand']\");\r\n\tconst rightHand = equipped.querySelector(\"[data-equipped-slot='right-hand']\");\r\n\tconst leftSlotted = leftHand.querySelector(\"[data-item-id]\");\r\n\tconst rightSlotted = rightHand.querySelector(\".item:not(.fake)\");\r\n\tconst item = getItemFromElement(actor, leftSlotted);\r\n\tconst isTwoHand = !!item && isTwoHanded(item);\r\n\r\n\tif (!isTwoHand && rightSlotted?.dataset.twoHands) {\r\n\t\trightSlotted.remove();\r\n\t} else if (isTwoHand && !rightSlotted) {\r\n\t\t/** @type {HTMLElement} */\r\n\t\tconst clone = leftSlotted.cloneNode(true);\r\n\t\tclone.dataset.twoHands = \"true\";\r\n\t\trightHand.appendChild(clone);\r\n\t}\r\n}\r\n\r\n/** @param {HTMLElement | {element: HTMLElement}} */\r\nfunction getItemFromElement(actor, element) {\r\n\tif (!element) return;\r\n\r\n\tconst el = element instanceof HTMLElement ? element : element.element;\r\n\tconst { itemId, containerId } = el.dataset;\r\n\tconst id = itemId ?? containerId;\r\n\r\n\tif (id) return actor.items.get(id);\r\n}\r\n", "import { getFlag, setFlag } from \"../../shared/flags\";\r\nimport { subLocalize } from \"../../shared/localize\";\r\nimport { templatePath } from \"../../shared/path\";\r\n\r\nconst localize = subLocalize(\"knowledges.editLore\");\r\n\r\nexport class EditLores extends FormApplication {\r\n\tget actor() {\r\n\t\treturn this.object;\r\n\t}\r\n\r\n\tget id() {\r\n\t\treturn `npc-edit-lores-${this.actor.id}`;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.actor);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"knowledges/lores\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\tconst actor = this.actor;\r\n\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\tunspecified: getFlag(actor, \"knowledges.unspecified\") ?? \"\",\r\n\t\t\tspecific: getFlag(actor, \"knowledges.specific\") ?? \"\",\r\n\t\t\ti18n: localize,\r\n\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(event, { unspecified, specific }) {\r\n\t\tconst actor = this.object;\r\n\t\tsetFlag(actor, \"knowledges.unspecified\", unspecified.trim());\r\n\t\tsetFlag(actor, \"knowledges.specific\", specific.trim());\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"button.cancel\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "import { EditLores } from \"../apps/knowledges/lores\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { getFlag } from \"../shared/flags\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\"renderNPCSheetPF2e\", renderNPCSheetPF2e);\r\n\r\nexport function registerKnowledges() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"knowledges\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: (value) => setHook(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-npc-knowledges\"],\r\n\t\tready: (isGM) => {\r\n\t\t\tif (isGM && getSetting(\"knowledges\")) setHook(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction renderNPCSheetPF2e(sheet, $html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\treplaceLores(actor, $html);\r\n\taddEditButton($html);\r\n\taddEvents(actor, $html);\r\n}\r\n\r\nfunction knowledgeSelector(html, section, selector) {\r\n\treturn html.find(\r\n\t\t`[data-tab=\"main\"] .recall-knowledge ${\r\n\t\t\tsection === \"header\" ? \".section-header\" : \".section-body\"\r\n\t\t} ${selector}`,\r\n\t);\r\n}\r\n\r\nfunction editLores(actor) {\r\n\tnew EditLores(actor).render(true);\r\n}\r\n\r\nfunction replaceLores(actor, html) {\r\n\tconst unspecifics = getFlag(actor, \"knowledges.unspecified\");\r\n\tconst specifics = getFlag(actor, \"knowledges.specific\");\r\n\tif (!unspecifics && !specifics) return;\r\n\r\n\tconst lores = actor.identificationDCs.lore;\r\n\tconst body = knowledgeSelector(html, \"body\", \"\");\r\n\tbody.find(\".identification-skills\").last().remove();\r\n\r\n\tfunction tag(skills, dc, adjustment) {\r\n\t\tconst content = game.i18n.format(\r\n\t\t\t\"PF2E.Actor.NPC.Identification.Skills.Label\",\r\n\t\t\t{ skills, dc, adjustment },\r\n\t\t);\r\n\t\treturn `<div class=\"tag-legacy identification-skills tooltipstered\">${content}</div>`;\r\n\t}\r\n\r\n\tfunction addTags(lores, { dc, start }) {\r\n\t\tconst tags = lores\r\n\t\t\t.split(\",\")\r\n\t\t\t.filter((lore) => lore.trim())\r\n\t\t\t.map((lore) => tag(lore, dc, start))\r\n\t\t\t.join(\"\");\r\n\t\tbody.append(tags);\r\n\t}\r\n\r\n\taddTags(unspecifics || \"Unspecific\", lores[0]);\r\n\taddTags(specifics || \"Specific\", lores[1]);\r\n}\r\n\r\nfunction addEvents(actor, html) {\r\n\tconst edit = knowledgeSelector(html, \"header\", \"button.edit\");\r\n\tedit.on(\"click\", () => editLores(actor));\r\n}\r\n\r\nfunction addEditButton(html) {\r\n\tconst attempts = knowledgeSelector(html, \"header\", \"button\");\r\n\tconst edit = '<button type=\"button\" class=\"breakdown edit\">Edit</button>';\r\n\tattempts.before(edit);\r\n}\r\n", "import { bindOnPreCreateSpellDamageChatMessage } from \"../../shared/chat\";\r\nimport { subLocalize } from \"../../shared/localize\";\r\nimport { templatePath } from \"../../shared/path\";\r\n\r\nconst localize = subLocalize(\"merge.multi\");\r\n\r\nexport class MultiCast extends Application {\r\n\t#message;\r\n\t#event;\r\n\r\n\tconstructor(event, message, options) {\r\n\t\tsuper(options);\r\n\t\tthis.#event = event;\r\n\t\tthis.#message = message;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.spell);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"merge/multi\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\ti18n: localize,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"[data-action=cast]\").on(\"click\", this.#onCast.bind(this));\r\n\t\thtml.find(\"[data-action=cancel]\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\tasync #onCast(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst nb = this.element.find(\"[name=multi]\").val();\r\n\t\tif (nb < 1) {\r\n\t\t\tlocalize.error(\"zero\");\r\n\t\t\tthis.close();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst message = this.#message;\r\n\t\tif (!message) return;\r\n\r\n\t\tconst spell = message.item;\r\n\t\tconst actor = message.actor;\r\n\t\tif (!actor || !spell) return;\r\n\r\n\t\tconst updateSource = (damages, heightening) => {\r\n\t\t\tfor (const [id, damage] of Object.entries(damages)) {\r\n\t\t\t\tfor (let i = 0; i < nb - 1; i++) {\r\n\t\t\t\t\tconst newId = randomID();\r\n\r\n\t\t\t\t\tdamages[newId] = damage;\r\n\r\n\t\t\t\t\tif (heightening.type === \"interval\") {\r\n\t\t\t\t\t\tconst damage = heightening.damage[id];\r\n\t\t\t\t\t\tif (damage) heightening.damage[newId] = damage;\r\n\t\t\t\t\t} else if (heightening.type === \"fixed\") {\r\n\t\t\t\t\t\tfor (const data of Object.values(heightening.levels)) {\r\n\t\t\t\t\t\t\tconst damage = data.damage[id];\r\n\t\t\t\t\t\t\tif (!damage) continue;\r\n\t\t\t\t\t\t\tdata.damage[newId] = damage;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tconst embeddedSource = deepClone(message.flags.pf2e.casting?.embeddedSpell);\r\n\r\n\t\tif (embeddedSource) {\r\n\t\t\tconst damages = embeddedSource.system.damage;\r\n\r\n\t\t\tembeddedSource.system.heightening ??= {};\r\n\t\t\tconst heightening = embeddedSource.system.heightening;\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = new Item.implementation(embeddedSource, {\r\n\t\t\t\tparent: actor,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.trickMagicEntry = spell.trickMagicEntry;\r\n\r\n\t\t\tconst overlayIds = message.getFlag(\"pf2e\", \"origin.variant.overlays\");\r\n\t\t\tconst castRank = message.getFlag(\"pf2e\", \"origin.castRank\") ?? spell.rank;\r\n\t\t\tconst modifiedSpell = newSpell.loadVariant({ overlayIds, castRank });\r\n\t\t\tconst castSpell = modifiedSpell ?? newSpell;\r\n\r\n\t\t\tcastSpell.rollDamage(this.#event);\r\n\t\t} else {\r\n\t\t\tconst spellSource = spell.toObject();\r\n\t\t\tconst damages = spellSource.system.damage;\r\n\t\t\tconst heightening = spellSource.system.heightening ?? {};\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = spell.clone({\r\n\t\t\t\t\"system.damage\": damages,\r\n\t\t\t\t\"system.heightening\": heightening,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.rollDamage(this.#event);\r\n\t\t}\r\n\r\n\t\tif (spell.damageKinds.size) {\r\n\t\t\tbindOnPreCreateSpellDamageChatMessage(message);\r\n\t\t}\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "export function getDamageRollClass() {\r\n\treturn CONFIG.Dice.rolls.find((Roll) => Roll.name === \"DamageRoll\");\r\n}\r\n", "import { MultiCast } from \"../apps/merge/multi\";\r\nimport { MODULE_ID } from \"../module\";\r\nimport { getChatMessageClass, latestChatMessages } from \"../shared/chat\";\r\nimport { getFlag } from \"../shared/flags\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { localize } from \"../shared/localize\";\r\nimport { compareArrays } from \"../shared/misc\";\r\nimport { warn } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getDamageRollClass } from \"../shared/pf2e/classes\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderChatMessage\",\r\n\trenderChatMessage,\r\n\tupdateMessages,\r\n);\r\n\r\nexport function registerMerge() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"merge-damage\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"multi-cast\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"multi-cast\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"merge-damage\"),\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: (isGm) => {\r\n\t\t\tsetHook(false, [\"multi-cast\", \"merge-damage\"], true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction updateMessages() {\r\n\tfor (const { message, html } of latestChatMessages(10)) {\r\n\t\thtml.find(\"[data-action=multi-cast]\").remove();\r\n\t\thtml.find(\"[data-action=merge-damage]\").remove();\r\n\t\trenderChatMessage(message, html);\r\n\t}\r\n}\r\n\r\nfunction renderChatMessage(message, html) {\r\n\tif (!game.user.isGM && !message.isAuthor) return;\r\n\r\n\tif (getSetting(\"merge-damage\") && isDamageRoll(message))\r\n\t\trenderDamage(message, html);\r\n\telse if (\r\n\t\tgetSetting(\"multi-cast\") &&\r\n\t\tmessage.getFlag(\"pf2e\", \"origin.type\") === \"spell\"\r\n\t)\r\n\t\trenderSpell(message, html);\r\n}\r\n\r\nfunction renderSpell(message, html) {\r\n\tconst item = message.item;\r\n\tif (!item) return;\r\n\r\n\tconst spellBtn = html.find(\r\n\t\t\".message-content .chat-card .owner-buttons .spell-button\",\r\n\t);\r\n\r\n\tspellBtn\r\n\t\t.find(\"[data-action=spell-damage]\")\r\n\t\t.after(\r\n\t\t\t`<button data-action=\"multi-cast\">${localize(\r\n\t\t\t\t\"merge.spell.button\",\r\n\t\t\t)}</button>`,\r\n\t\t);\r\n\r\n\tspellBtn.find(\"[data-action=multi-cast]\").on(\"click\", (event) => {\r\n\t\tnew MultiCast(event, message).render(true);\r\n\t});\r\n}\r\n\r\nfunction renderDamage(message, html) {\r\n\tlet buttons = '<span class=\"pf2e-toolbelt-merge\">';\r\n\r\n\tif (getFlag(message, \"merge.merged\")) {\r\n\t\tconst tooltip = localize(\"merge.damage.split-tooltip\");\r\n\t\tbuttons += `<button data-action=\"split-damage\" title=\"${tooltip}\">`;\r\n\t\tbuttons += '<i class=\"fa-duotone fa-split\"></i>';\r\n\t}\r\n\r\n\tconst tooltip = localize(\"merge.damage.tooltip\");\r\n\tbuttons += `<button data-action=\"merge-damage\" title=\"${tooltip}\">`;\r\n\tbuttons += '<i class=\"fa-duotone fa-merge\"></i></button>';\r\n\r\n\tbuttons += \"</span>\";\r\n\r\n\tconst actorUUID = getActorUUID(message);\r\n\tconst targetUUIDs = getTargetUUIDs(message);\r\n\r\n\thtml.find(\".dice-result .dice-total\").append(buttons);\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=merge-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tfor (const { message: otherMessage } of latestChatMessages(5, message)) {\r\n\t\t\t\tconst otherTargetsUUIDS = getTargetUUIDs(otherMessage);\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\t!isDamageRoll(otherMessage) ||\r\n\t\t\t\t\tgetActorUUID(otherMessage) !== actorUUID ||\r\n\t\t\t\t\t!compareArrays(\r\n\t\t\t\t\t\ttargetUUIDs?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t\totherTargetsUUIDS?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\tmergeDamages(event, message, otherMessage, { actorUUID, targetUUIDs });\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\twarn(\"merge.damage.none\");\r\n\t\t});\r\n\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=split-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\t\t\tsplitDamages(event, message);\r\n\t\t});\r\n}\r\n\r\nasync function splitDamages(event, message) {\r\n\tconst sources = getFlag(message, \"merge.data\").flatMap((data) => data.source);\r\n\tawait removeChatMessages(message.id);\r\n\tawait getChatMessageClass().createDocuments(sources);\r\n}\r\n\r\nasync function mergeDamages(event, origin, other, { actorUUID, targetUUIDs }) {\r\n\tconst dataGroups = {};\r\n\r\n\tconst data = getMessageData(other).concat(getMessageData(origin));\r\n\tfor (const { name, notes, outcome, modifiers, tags } of data) {\r\n\t\tdataGroups[name] ??= {\r\n\t\t\tname,\r\n\t\t\ttags,\r\n\t\t\tnotes: new Set(),\r\n\t\t\tresults: [],\r\n\t\t};\r\n\r\n\t\tfor (const note of notes) {\r\n\t\t\tdataGroups[name].notes.add(note);\r\n\t\t}\r\n\r\n\t\tconst exists = dataGroups[name].results.some(\r\n\t\t\t(result) =>\r\n\t\t\t\tresult.outcome === outcome &&\r\n\t\t\t\tcompareArrays(result.modifiers, modifiers),\r\n\t\t);\r\n\r\n\t\tif (!exists) dataGroups[name].results.push({ outcome, modifiers });\r\n\t}\r\n\r\n\tconst groups = Object.values(dataGroups).map((group) => {\r\n\t\tgroup.label = group.name;\r\n\r\n\t\tfor (const result of group.results) {\r\n\t\t\tif (!result.outcome) continue;\r\n\t\t\tresult.label = game.i18n.localize(\r\n\t\t\t\t`PF2E.Check.Result.Degree.Attack.${result.outcome}`,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn group;\r\n\t});\r\n\r\n\tgroups.at(-1).isLastGroup = true;\r\n\r\n\tconst flavor = await renderTemplate(templatePath(\"merge/merged\"), {\r\n\t\tgroups,\r\n\t\thasMultipleGroups: groups.length > 1,\r\n\t});\r\n\r\n\tconst originRolls = getMessageRolls(origin);\r\n\tconst otherRolls = getMessageRolls(other);\r\n\tconst groupedRolls = [];\r\n\r\n\tfor (const roll of [].concat(otherRolls, originRolls)) {\r\n\t\tconst { options, total, terms } = roll;\r\n\t\tconst term = terms[0];\r\n\t\tconst formula = roll.formula\r\n\t\t\t.replaceAll(/(\\[[\\w,-]+\\])/g, \"\")\r\n\t\t\t.replace(/^\\(/, \"\")\r\n\t\t\t.replace(/\\)$/, \"\");\r\n\t\tconst group = groupedRolls.find(\r\n\t\t\t({ options: { flavor, critRule } }) =>\r\n\t\t\t\tflavor === options.flavor && critRule === options.critRule,\r\n\t\t);\r\n\r\n\t\tif (group) {\r\n\t\t\tgroup.terms.push(term);\r\n\t\t\tgroup.total += total;\r\n\t\t\tgroup.formulas.push(formula);\r\n\t\t} else {\r\n\t\t\tgroupedRolls.push({\r\n\t\t\t\toptions,\r\n\t\t\t\tformulas: [formula],\r\n\t\t\t\ttotal,\r\n\t\t\t\tterms: [term],\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tconst DamageRoll = getDamageRollClass();\r\n\tfor (const group of groupedRolls) {\r\n\t\tif (group.options.flavor.includes(\"persistent\")) {\r\n\t\t\tconst { index } = group.formulas.reduce(\r\n\t\t\t\t(prev, curr, index) => {\r\n\t\t\t\t\tconst value = new DamageRoll(curr).expectedValue;\r\n\t\t\t\t\tif (value <= prev.value) return prev;\r\n\t\t\t\t\treturn { value, index };\r\n\t\t\t\t},\r\n\t\t\t\t{ value: 0, index: -1 },\r\n\t\t\t);\r\n\r\n\t\t\tgroup.formulas = [group.formulas[index]];\r\n\t\t\tgroup.terms = [group.terms[index]];\r\n\t\t}\r\n\r\n\t\tgroup.formula = `(${group.formulas.join(\" + \")})[${group.options.flavor}]`;\r\n\t\tgroup.term =\r\n\t\t\tgroup.terms.length < 2 ? group.terms[0] : createTermGroup(group.terms);\r\n\t}\r\n\r\n\tconst roll = {\r\n\t\tclass: \"DamageRoll\",\r\n\t\toptions: {},\r\n\t\tdice: [],\r\n\t\tformula: `{${groupedRolls.map(({ formula }) => formula).join(\", \")}}`,\r\n\t\ttotal: groupedRolls.reduce((acc, { total }) => acc + total, 0),\r\n\t\tevaluated: true,\r\n\t\tterms: [\r\n\t\t\t{\r\n\t\t\t\tclass: \"InstancePool\",\r\n\t\t\t\toptions: {},\r\n\t\t\t\tevaluated: true,\r\n\t\t\t\tterms: groupedRolls.map(({ formula }) => formula),\r\n\t\t\t\tmodifiers: [],\r\n\t\t\t\trolls: groupedRolls.map(({ options, formula, total, term }) => ({\r\n\t\t\t\t\tclass: \"DamageInstance\",\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tdice: [],\r\n\t\t\t\t\tformula,\r\n\t\t\t\t\ttotal,\r\n\t\t\t\t\tterms: [term],\r\n\t\t\t\t\tevaluated: true,\r\n\t\t\t\t})),\r\n\t\t\t\tresults: groupedRolls.map(({ total }) => ({\r\n\t\t\t\t\tresult: total,\r\n\t\t\t\t\tactive: true,\r\n\t\t\t\t})),\r\n\t\t\t},\r\n\t\t],\r\n\t};\r\n\r\n\tif (game.modules.get(\"dice-so-nice\")?.active) {\r\n\t\tconst setHidden = (term) => {\r\n\t\t\tif (\"results\" in term) {\r\n\t\t\t\tfor (const result of term.results) {\r\n\t\t\t\t\tresult.hidden = true;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconst operands = (term.term ?? term).operands ?? [];\r\n\t\t\t\tfor (const operand of operands) {\r\n\t\t\t\t\tsetHidden(operand);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tfor (const r of roll.terms[0].rolls) {\r\n\t\t\tfor (const term of r.terms) {\r\n\t\t\t\tsetHidden(term);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tawait removeChatMessages(origin.id, other.id);\r\n\r\n\tawait getChatMessageClass().create({\r\n\t\tflavor,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.ROLL,\r\n\t\tspeaker: origin.speaker,\r\n\t\tflags: {\r\n\t\t\t[MODULE_ID]: {\r\n\t\t\t\tmerge: {\r\n\t\t\t\t\tactor: actorUUID,\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t\tmerged: true,\r\n\t\t\t\t\ttype: \"damage-roll\",\r\n\t\t\t\t\tdata,\r\n\t\t\t\t},\r\n\t\t\t\ttarget: {\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tpf2e: {\r\n\t\t\t\tcontext: {\r\n\t\t\t\t\toptions: Array.from(\r\n\t\t\t\t\t\tnew Set(data.flatMap((entry) => entry.itemTraits)),\r\n\t\t\t\t\t),\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t},\r\n\t\trolls: [roll],\r\n\t});\r\n}\r\n\r\nfunction getMessageData(message) {\r\n\tconst flags = getFlag(message, \"merge.data\");\r\n\tif (flags) return flags;\r\n\r\n\tconst source = message.toObject();\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source._id;\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source.timestamp;\r\n\r\n\tconst html = $(`<div>${message.flavor}</div>`);\r\n\tconst tags = html.find(\"h4.action + .tags\").prop(\"outerHTML\");\r\n\r\n\tconst modifiers = [];\r\n\thtml.find(\".tag.tag_transparent\").each(function () {\r\n\t\tmodifiers.push(this.innerHTML);\r\n\t});\r\n\r\n\tconst notes = source.flags.pf2e.context.notes.map(\r\n\t\t({ title, text }) =>\r\n\t\t\t`<strong>${game.i18n.localize(title)}</strong> ${game.i18n.localize(\r\n\t\t\t\ttext,\r\n\t\t\t)}`,\r\n\t);\r\n\r\n\treturn [\r\n\t\t{\r\n\t\t\tsource,\r\n\t\t\tname: source.flags.pf2e.strike?.name ?? message.item.name,\r\n\t\t\toutcome: source.flags.pf2e.context.outcome,\r\n\t\t\titemTraits: source.flags.pf2e.context.options.filter((option) =>\r\n\t\t\t\t/^(item|self):/.test(option),\r\n\t\t\t),\r\n\t\t\tmodifiers,\r\n\t\t\ttags,\r\n\t\t\tnotes,\r\n\t\t},\r\n\t];\r\n}\r\n\r\nfunction removeChatMessages(...ids) {\r\n\tconst joinedIds = ids.map((id) => `[data-message-id=${id}]`).join(\", \");\r\n\tui.chat.element.find(joinedIds).remove();\r\n\treturn ChatMessage.deleteDocuments(ids);\r\n}\r\n\r\nfunction createTermGroup(terms) {\r\n\tconst options = deepClone(terms[0].options);\r\n\r\n\tfor (const term of terms) {\r\n\t\tterm.options = {};\r\n\t}\r\n\r\n\treturn {\r\n\t\tclass: \"Grouping\",\r\n\t\toptions,\r\n\t\tevaluated: true,\r\n\t\tterm: {\r\n\t\t\tclass: \"ArithmeticExpression\",\r\n\t\t\toptions: {},\r\n\t\t\tevaluated: true,\r\n\t\t\toperator: \"+\",\r\n\t\t\toperands: [\r\n\t\t\t\tterms.shift(),\r\n\t\t\t\tterms.length > 1 ? createTermGroup(terms) : terms[0],\r\n\t\t\t],\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction getMessageRolls(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.rolls\") ??\r\n\t\tJSON.parse(message._source.rolls[0]).terms[0].rolls\r\n\t);\r\n}\r\n\r\nfunction getActorUUID(message) {\r\n\treturn getFlag(message, \"merge.actor\") ?? message.actor?.uuid;\r\n}\r\n\r\nfunction getTargetUUIDs(message) {\r\n\tconst targetTargets = getFlag(message, \"target.targets\");\r\n\tif (targetTargets) return targetTargets;\r\n\r\n\tconst mergeTargets =\r\n\t\tgetFlag(message, \"merge.targets\") ?? message.getFlag(\"pf2e\", \"target\");\r\n\tif (Array.isArray(mergeTargets)) return mergeTargets;\r\n\treturn mergeTargets ? [mergeTargets] : [];\r\n}\r\n\r\nfunction isDamageRoll(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.type\") === \"damage-roll\" ||\r\n\t\tmessage.getFlag(\"pf2e\", \"context.type\") === \"damage-roll\"\r\n\t);\r\n}\r\n", "import { registerWrapper, wrapperError } from \"../shared/libwrapper\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst ACTOR_PREPARE_EMBEDDED_DOCUMENTS =\r\n\t\"CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments\";\r\nconst TREASURE_PREPARE_BASE_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData\";\r\n\r\nexport function registerNobulk() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"nobulk\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"nobulk-coins\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tif (getSetting(\"nobulk\"))\r\n\t\t\t\tregisterWrapper(\r\n\t\t\t\t\tACTOR_PREPARE_EMBEDDED_DOCUMENTS,\r\n\t\t\t\t\tactorPrepareEmbeddedDocuments,\r\n\t\t\t\t\t\"WRAPPER\",\r\n\t\t\t\t);\r\n\t\t\tif (getSetting(\"nobulk-coins\"))\r\n\t\t\t\tregisterWrapper(\r\n\t\t\t\t\tTREASURE_PREPARE_BASE_DATA,\r\n\t\t\t\t\ttreasurePrepareBaseData,\r\n\t\t\t\t\t\"WRAPPER\",\r\n\t\t\t\t);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction treasurePrepareBaseData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (this.isCoinage) this.system.bulk.value = 0;\r\n\t} catch {\r\n\t\twrapperError(\"nobulk\", TREASURE_PREPARE_BASE_DATA);\r\n\t}\r\n}\r\n\r\nfunction actorPrepareEmbeddedDocuments(wrapped, ...args) {\r\n\twrapped(...args);\r\n\r\n\ttry {\r\n\t\tconst InventoryBulk = this.inventory.bulk.constructor;\r\n\r\n\t\tlet _value = null;\r\n\r\n\t\tObject.defineProperty(this.inventory.bulk, \"value\", {\r\n\t\t\tget() {\r\n\t\t\t\tif (_value) return _value;\r\n\t\t\t\t_value = InventoryBulk.computeTotalBulk(\r\n\t\t\t\t\tthis.actor.inventory.filter(\r\n\t\t\t\t\t\t(item) =>\r\n\t\t\t\t\t\t\t!item.isInContainer &&\r\n\t\t\t\t\t\t\titem.system.equipped.carryType !== \"dropped\",\r\n\t\t\t\t\t),\r\n\t\t\t\t\tthis.actor.size,\r\n\t\t\t\t);\r\n\t\t\t\treturn _value;\r\n\t\t\t},\r\n\t\t});\r\n\t} catch {\r\n\t\twrapperError(\"nobulk\", ACTOR_PREPARE_EMBEDDED_DOCUMENTS);\r\n\t}\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\nimport { isPlayedActor } from \"../shared/actor\";\r\nimport { getFlag, setFlag, unsetFlag } from \"../shared/flags\";\r\nimport { registerWrapper } from \"../shared/libwrapper\";\r\nimport { subLocalize } from \"../shared/localize\";\r\nimport { isInstanceOf } from \"../shared/misc\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst ACTOR_PREPARE_DATA = \"CONFIG.Actor.documentClass.prototype.prepareData\";\r\nconst DOCUMENT_SHEET_RENDER_INNER = \"DocumentSheet.prototype._renderInner\";\r\n\r\nexport function registerShare() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"share\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"force\"],\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tconst share = getSetting(\"share\");\r\n\t\t\tif (share === \"disabled\") return;\r\n\r\n\t\t\tregisterWrapper(ACTOR_PREPARE_DATA, prepareData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tDOCUMENT_SHEET_RENDER_INNER,\r\n\t\t\t\tdocumentSheetRenderInner,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tHooks.on(\"preUpdateActor\", preUpdateActor);\r\n\t\t\tHooks.on(\"deleteActor\", deleteActor);\r\n\t\t\tHooks.on(\"updateActor\", updateActor);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nasync function documentSheetRenderInner(wrapped, ...args) {\r\n\tconst inner = await wrapped(...args);\r\n\tif (!isInstanceOf(this, \"CreatureConfig\")) return inner;\r\n\r\n\tconst actor = this.actor;\r\n\tif (\r\n\t\t!isPlayedActor(actor) ||\r\n\t\t!actor.isOfType(\"character\", \"npc\") ||\r\n\t\tgetSlaves(actor).size\r\n\t)\r\n\t\treturn inner;\r\n\r\n\tconst masters = game.actors\r\n\t\t.filter((a) => a.id !== actor.id && a.isOwner && isValidMaster(a))\r\n\t\t.map((actor) => ({\r\n\t\t\tkey: actor.id,\r\n\t\t\tlabel: actor.name,\r\n\t\t}));\r\n\r\n\tconst group = await renderTemplate(templatePath(\"share/master\"), {\r\n\t\tmasters,\r\n\t\tmaster: getFlag(actor, \"share.master\"),\r\n\t\tselectPath: `flags.${MODULE_ID}.share.master`,\r\n\t\ti18n: subLocalize(\"share.templates.master\"),\r\n\t});\r\n\r\n\tinner.children().last().before(group);\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction deleteActor(actor) {\r\n\tremoveSlaveFromMaster(actor);\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tPromise.all(\r\n\t\tslaves.map(async (slave) => {\r\n\t\t\tunsetMaster(slave);\r\n\t\t\tawait unsetFlag(slave, \"share.master\");\r\n\t\t}),\r\n\t);\r\n}\r\n\r\nfunction preUpdateActor(actor, updates) {\r\n\tconst shareFlag = getProperty(updates, `flags.${MODULE_ID}.share`);\r\n\tif (shareFlag?.master) {\r\n\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\tif (isValidMaster(master)) {\r\n\t\t\tconst hpSource = deepClone(master._source.system.attributes.hp);\r\n\t\t\tsetProperty(updates, \"system.attributes.hp\", hpSource);\r\n\t\t}\r\n\t} else {\r\n\t\tconst master = getMaster(actor);\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (master && hpUpdate) {\r\n\t\t\tmaster.update(\r\n\t\t\t\t{ system: { attributes: { hp: hpUpdate } } },\r\n\t\t\t\t{ noHook: true },\r\n\t\t\t);\r\n\t\t\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\t\t\tdelete updates.system.attributes.hp;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction updateActor(actor, updates, options, userId) {\r\n\tconst isOriginalUser = game.user.id === userId;\r\n\r\n\tconst shareFlag = getShareFlag(updates);\r\n\tif (shareFlag?.master !== undefined) {\r\n\t\tconst slave = actor;\r\n\r\n\t\tremoveSlaveFromMaster(slave);\r\n\r\n\t\tif (shareFlag.master) {\r\n\t\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\t\tif (isValidMaster(master)) {\r\n\t\t\t\tsetMaster(slave, master);\r\n\t\t\t\taddSlaveToMaster(master, slave);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tunsetMaster(slave);\r\n\t\t}\r\n\t}\r\n\r\n\tif (!isOriginalUser) return;\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tif (slaves.size) {\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (hpUpdate) {\r\n\t\t\tconst data = { system: { attributes: { hp: hpUpdate } } };\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await slave.update(data, { noHook: true })),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await refreshActor(slave, updates)),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nasync function refreshActor(actor, data) {\r\n\tconst share = getSetting(\"share\");\r\n\tif (share === \"force\") {\r\n\t\tawait setFlag(actor, \"toggle\", !getFlag(actor, \"toggle\"));\r\n\t} else {\r\n\t\tactor.render(false, { action: \"update\" });\r\n\t\tactor._updateDependentTokens(data);\r\n\t}\r\n}\r\n\r\nfunction prepareData(wrapped) {\r\n\twrapped();\r\n\r\n\tconst masterId = getFlag(this, \"share.master\");\r\n\tconst master = masterId ? game.actors.get(masterId) : undefined;\r\n\r\n\tif (!isValidMaster(master)) return;\r\n\r\n\tif (!getMaster(this)) {\r\n\t\tsetMaster(this, master);\r\n\t\taddSlaveToMaster(master, this);\r\n\t}\r\n\r\n\tconst hp = this.system.attributes.hp;\r\n\tObject.defineProperty(this.system.attributes, \"hp\", {\r\n\t\tget() {\r\n\t\t\tconst masterHp = master.system.attributes.hp;\r\n\t\t\ttransfertHpData(masterHp, hp);\r\n\t\t\treturn hp;\r\n\t\t},\r\n\t\tenumerable: true,\r\n\t});\r\n}\r\n\r\nfunction transfertHpData(from, to) {\r\n\tto.breakdown = from.breakdown;\r\n\tto.max = from.max;\r\n\tto.sp = deepClone(from.sp);\r\n\tto.temp = from.temp;\r\n\tto.totalModifier = from.totalModifier;\r\n\tto.value = from.value;\r\n\tto._modifiers = from._modifiers.slice();\r\n}\r\n\r\nfunction getShareFlag(doc) {\r\n\treturn getProperty(doc, `flags.${MODULE_ID}.share`);\r\n}\r\n\r\nfunction getSlaves(actor) {\r\n\treturn getModuleProperty(actor, \"slaves\") ?? new Collection();\r\n}\r\n\r\nfunction setMaster(actor, master) {\r\n\tsetModuleProperty(actor, \"master\", master);\r\n}\r\n\r\nfunction unsetMaster(actor) {\r\n\tdeleteModuleProperty(actor, \"master\");\r\n}\r\n\r\nfunction getMaster(actor) {\r\n\treturn getModuleProperty(actor, \"master\");\r\n}\r\n\r\nfunction isValidMaster(actor) {\r\n\treturn actor && actor.type === \"character\" && !getMaster(actor);\r\n}\r\n\r\nfunction getModuleProperty(doc, path) {\r\n\treturn getProperty(doc, `modules.${MODULE_ID}.share.${path}`);\r\n}\r\n\r\nfunction setModuleProperty(doc, path, value) {\r\n\tsetProperty(doc, `modules.${MODULE_ID}.share.${path}`, value);\r\n}\r\n\r\nfunction deleteModuleProperty(doc, path) {\r\n\tdelete doc.modules?.[MODULE_ID]?.share?.[path];\r\n}\r\n\r\nfunction addSlaveToMaster(master, slave) {\r\n\tconst slaves = getSlaves(master);\r\n\tsetModuleProperty(master, \"slaves\", slaves.set(slave.id, slave));\r\n}\r\n\r\nfunction removeSlaveFromMaster(slave) {\r\n\tconst master = getMaster(slave);\r\n\tif (!master) return;\r\n\r\n\tconst slaves = getSlaves(master);\r\n\tslaves.delete(slave.id);\r\n}\r\n", "import { isPlayedActor } from \"../shared/actor\";\r\nimport { createHook } from \"../shared/hook\";\r\nimport { getItemWithSourceId, hasItemWithSourceId } from \"../shared/item\";\r\nimport { subLocalize } from \"../shared/localize\";\r\nimport { refreshCharacterSheets } from \"../shared/misc\";\r\nimport { info } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport { getSetting } from \"../shared/settings\";\r\nimport { isActiveOwner } from \"../shared/user\";\r\n\r\nconst setSheetHook = createHook(\r\n\t\"renderCharacterSheetPF2e\",\r\n\trenderCharacterSheetPF2e,\r\n);\r\nconst setDeleteCombatHook = createHook(\"deleteCombat\", deleteCombat);\r\nconst setDeleteCombatantHook = createHook(\"deleteCombatant\", deleteCombatant);\r\nconst setCreateCombatantHook = createHook(\"createCombatant\", createCombatant);\r\n\r\nconst STANCE_SAVANT = [\r\n\t\"Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu\",\r\n\t\"Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8\",\r\n];\r\n\r\nconst REPLACERS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA\", // gorilla pound\r\n\r\n\t\t{\r\n\t\t\treplace: \"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT\", // gorilla stance\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK\",\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nconst EXTRAS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt\", // arcane cascade\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl\",\r\n\t\t\taction: \"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28\", // cobra envenom\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT\", // dread marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv\", // the stance aura\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa\", // inspiring marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ\", // the stance aura\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nexport function registerStances() {\r\n\treturn {\r\n\t\tname: \"stances\",\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"stances\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-stances\"],\r\n\t\tapi: {\r\n\t\t\tgetStances,\r\n\t\t\ttoggleStance,\r\n\t\t\tisValidStance,\r\n\t\t},\r\n\t\tready: (isGm) => {\r\n\t\t\tif (getSetting(\"stances\")) setup(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tsetSheetHook(value);\r\n\tsetDeleteCombatHook(value);\r\n\tsetDeleteCombatantHook(value);\r\n\tsetCreateCombatantHook(value);\r\n}\r\n\r\nfunction isValidStance(stance) {\r\n\treturn (\r\n\t\tstance?.system.traits.value.includes(\"stance\") &&\r\n\t\tstance.system.selfEffect?.uuid\r\n\t);\r\n}\r\n\r\nfunction getStances(actor) {\r\n\tconst stances = [];\r\n\tconst replaced = new Set();\r\n\r\n\tfor (const {\r\n\t\treplace,\r\n\t\tsourceId,\r\n\t\teffectUUID,\r\n\t\teffect,\r\n\t\timg,\r\n\t\tname,\r\n\t\titemName,\r\n\t\taction,\r\n\t} of actorStances(actor)) {\r\n\t\tif (replace) replaced.add(replace);\r\n\r\n\t\tconst foundAction = action\r\n\t\t\t? getItemWithSourceId(actor, action, \"action\")\r\n\t\t\t: getItemWithSourceId(actor, sourceId, \"feat\");\r\n\r\n\t\tstances.push({\r\n\t\t\tname,\r\n\t\t\titemName,\r\n\t\t\tuuid: sourceId,\r\n\t\t\timg,\r\n\t\t\teffectUUID,\r\n\t\t\teffectID: effect?.id,\r\n\t\t\tactionUUID: foundAction.sourceId,\r\n\t\t\tactionID: foundAction.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn stances.filter(({ uuid }) => !replaced.has(uuid));\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst inCombat = actor\r\n\t\t.getActiveTokens(true, true)\r\n\t\t.some((token) => token.inCombat);\r\n\tconst tab = html.find(\r\n\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]\",\r\n\t);\r\n\tconst options = tab.find(\".actions-options\");\r\n\tconst template = await renderTemplate(templatePath(\"stances/sheet\"), {\r\n\t\tstances,\r\n\t\tcanUseStances: inCombat && !actor.isDead,\r\n\t\ti18n: subLocalize(\"stances\"),\r\n\t});\r\n\r\n\tif (options.length) options.after(template);\r\n\telse tab.prepend(template);\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance\",\r\n\t\t)\r\n\t\t.on(\"click\", (event) => onToggleStance(event, actor));\r\n}\r\n\r\nfunction onToggleStance(event, actor) {\r\n\tconst target = event.currentTarget;\r\n\tconst canUseStances = target\r\n\t\t.closest(\".pf2e-stances\")\r\n\t\t?.classList.contains(\"can-use-stances\");\r\n\tif (!event.ctrlKey && !canUseStances) return;\r\n\r\n\tconst effectUUID = target.dataset.effectUuid;\r\n\ttoggleStance(actor, effectUUID);\r\n}\r\n\r\nfunction* actorStances(actor) {\r\n\tfor (const feat of actor.itemTypes.feat) {\r\n\t\tconst sourceId = feat.sourceId;\r\n\r\n\t\tconst replacer = REPLACERS.get(sourceId);\r\n\t\tconst extra = EXTRAS.get(sourceId);\r\n\t\tif (!replacer && !extra && !isValidStance(feat)) continue;\r\n\r\n\t\tconst effectUUID =\r\n\t\t\treplacer?.effect ?? extra?.effect ?? feat.system.selfEffect.uuid;\r\n\t\tconst effect = fromUuidSync(effectUUID);\r\n\t\tif (!effect) continue;\r\n\r\n\t\tyield {\r\n\t\t\tname: (replacer && fromUuidSync(replacer.replace)?.name) ?? feat.name,\r\n\t\t\titemName: feat.name,\r\n\t\t\treplace: replacer?.replace,\r\n\t\t\textra,\r\n\t\t\tsourceId,\r\n\t\t\teffectUUID,\r\n\t\t\teffect: getItemWithSourceId(actor, effectUUID, \"effect\"),\r\n\t\t\taction: extra?.action,\r\n\t\t\timg: effect.img,\r\n\t\t};\r\n\t}\r\n}\r\n\r\nfunction getStancesEffects(actor) {\r\n\tconst effects = [];\r\n\r\n\tfor (const { effect } of actorStances(actor)) {\r\n\t\tif (!effect) continue;\r\n\t\teffects.push({\r\n\t\t\tuuid: effect.sourceId,\r\n\t\t\tid: effect.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn effects;\r\n}\r\n\r\nasync function toggleStance(actor, effectUUID) {\r\n\tconst effects = getStancesEffects(actor);\r\n\tconst already = effects.findIndex((effect) => effect.uuid === effectUUID);\r\n\r\n\tlet create = false;\r\n\r\n\tif (already === -1) {\r\n\t\tcreate = true;\r\n\t} else {\r\n\t\tconst other = effects.filter((effect) => effect.uuid !== effectUUID).length;\r\n\t\tconst more =\r\n\t\t\teffects.filter((effect) => effect.uuid === effectUUID).length > 1;\r\n\t\tif (other || more) effects.splice(already, 1);\r\n\t}\r\n\r\n\tif (effects.length) {\r\n\t\tawait actor.deleteEmbeddedDocuments(\r\n\t\t\t\"Item\",\r\n\t\t\teffects.map((x) => x.id),\r\n\t\t);\r\n\t}\r\n\r\n\tif (create) addStance(actor, effectUUID);\r\n}\r\n\r\nasync function addStance(actor, uuid) {\r\n\tconst effect = await fromUuid(uuid);\r\n\r\n\tif (effect) {\r\n\t\tconst obj = effect.toObject();\r\n\t\tif (!getProperty(obj, \"flags.core.sourceId\"))\r\n\t\t\tsetProperty(obj, \"flags.core.sourceId\", effect.uuid);\r\n\r\n\t\tconst items = await actor.createEmbeddedDocuments(\"Item\", [obj]);\r\n\t\titems[0]?.toMessage();\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n\r\nfunction deleteCombat(combat) {\r\n\tfor (const combatant of combat.combatants) {\r\n\t\tdeleteCombatant(combatant);\r\n\t}\r\n}\r\n\r\nfunction deleteCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isActiveOwner(actor)) {\r\n\t\tconst effects = getStancesEffects(actor).map((effect) => effect.id);\r\n\t\tif (effects.length) actor.deleteEmbeddedDocuments(\"Item\", effects);\r\n\t}\r\n\r\n\trefreshCharacterSheets(actor);\r\n}\r\n\r\nfunction createCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isActiveOwner(actor)) checkForSavant(actor);\r\n\r\n\trefreshCharacterSheets(actor);\r\n}\r\n\r\nfunction getActorFromCombatant(combatant) {\r\n\tconst actor = combatant.actor;\r\n\tif (actor && !actor.isToken && actor.isOfType(\"character\")) return actor;\r\n}\r\n\r\nasync function checkForSavant(actor) {\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst hasStancesEffects = stances.filter(({ effectID }) => effectID).length;\r\n\tif (hasStancesEffects) return;\r\n\r\n\tconst hasSavantFeat = hasItemWithSourceId(actor, STANCE_SAVANT, [\"feat\"]);\r\n\tif (!hasSavantFeat) return;\r\n\r\n\tif (stances.length === 1) {\r\n\t\tconst stance = stances[0];\r\n\t\tif (await addStance(actor, stance.effectUUID))\r\n\t\t\tinfo(\"stances.useStance\", { stance: stance.name });\r\n\t} else {\r\n\t\topenStancesMenu(actor, stances);\r\n\t}\r\n}\r\n\r\nasync function openStancesMenu(actor, stances) {\r\n\tconst localize = subLocalize(\"stances.menu\");\r\n\r\n\tnew Dialog({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await renderTemplate(templatePath(\"stances/menu\"), {\r\n\t\t\tstances,\r\n\t\t\ti18n: localize,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tyes: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-people-arrows\"></i>',\r\n\t\t\t\tlabel: localize(\"accept\"),\r\n\t\t\t\tcallback: (html) =>\r\n\t\t\t\t\taddStance(actor, html.find(\"[name=stance]:checked\").val()),\r\n\t\t\t},\r\n\t\t\tno: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n\t\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\t},\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "export function ErrorPF2e(message) {\r\n\treturn Error(`PF2e System | ${message}`);\r\n}\r\n\r\nlet intlNumberFormat;\r\nexport function signedInteger(\r\n\tvalue,\r\n\t{ emptyStringZero = false, zeroIsNegative = false } = {},\r\n) {\r\n\tif (value === 0 && emptyStringZero) return \"\";\r\n\r\n\tintlNumberFormat ??= new Intl.NumberFormat(game.i18n.lang, {\r\n\t\tmaximumFractionDigits: 0,\r\n\t\tsignDisplay: \"always\",\r\n\t});\r\n\r\n\tconst maybeNegativeZero = zeroIsNegative && value === 0 ? -0 : value;\r\n\r\n\treturn intlNumberFormat.format(maybeNegativeZero);\r\n}\r\n\r\nexport function spellSlotGroupIdToNumber(groupId) {\r\n\tif (groupId === \"cantrips\") return 0;\r\n\tconst numericValue = Number(groupId ?? NaN);\r\n\treturn numericValue.between(0, 10) ? numericValue : null;\r\n}\r\n\r\nexport function coerceToSpellGroupId(value) {\r\n\tif (value === \"cantrips\") return value;\r\n\tconst numericValue = Number(value) || NaN;\r\n\treturn numericValue.between(1, 10) ? numericValue : null;\r\n}\r\n", "import { MODULE_ID } from \"../module\";\r\nimport {\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../shared/actor\";\r\nimport { subLocalize } from \"../shared/localize\";\r\nimport { localeCompare, ordinalString } from \"../shared/misc\";\r\nimport { spellSlotGroupIdToNumber } from \"../shared/pf2e/misc\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nexport function registerSpellsSummary() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"summary\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"sort\"],\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-spells-summary\"],\r\n\t\tready: (isGm) => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst enabled = (value ?? getSetting(\"summary\")) !== \"disabled\";\r\n\tif (enabled) {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"spellcasting\",\r\n\t\t\ttemplateFolder: \"summary/sheet\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"spellcasting\");\r\n\t}\r\n}\r\n\r\nfunction addEvents(html, sheet, actor) {\r\n\tconst inputs = html.find(\".spell-type .uses .spell-slots-input input\");\r\n\tinputs.on(\"change\", (event) => onUsesInputChange(event, actor));\r\n\tinputs.on(\"focus\", onUsesInputFocus);\r\n\tinputs.on(\"blur\", onUsesInputBlur);\r\n\r\n\thtml\r\n\t\t.find(\".focus-pips\")\r\n\t\t.on(\"click contextmenu\", (event) => onToggleFocusPool(event, actor));\r\n\r\n\thtml\r\n\t\t.find(\".spell-slots-increment-reset\")\r\n\t\t.on(\"click\", (event) => onSlotsReset(event, sheet, actor));\r\n\r\n\thtml.find(\".item-image\").on(\"click\", (event) => onItemToChat(event, actor));\r\n}\r\n\r\nasync function onUsesInputChange(event, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { inputPath, entryId } = $(event.currentTarget).data();\r\n\tconst value = event.currentTarget.valueAsNumber;\r\n\tactor.updateEmbeddedDocuments(\"Item\", [{ _id: entryId, [inputPath]: value }]);\r\n}\r\n\r\nfunction onUsesInputFocus(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.add(\"hover\");\r\n}\r\n\r\nfunction onUsesInputBlur(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.remove(\"hover\");\r\n}\r\n\r\nfunction onToggleFocusPool(event, actor) {\r\n\tevent.preventDefault();\r\n\tconst change = event.type === \"click\" ? 1 : -1;\r\n\tconst points = (actor.system.resources.focus?.value ?? 0) + change;\r\n\tactor.update({ \"system.resources.focus.value\": points });\r\n}\r\n\r\nfunction onChargesReset(sheet, actor, entryId) {\r\n\tif (game.modules.get(\"pf2e-staves\")?.active) {\r\n\t\tconst original = getSpellcastingTab(sheet.element).find(\r\n\t\t\t\".directory-list.spellcastingEntry-list\",\r\n\t\t);\r\n\t\tconst entry = original.find(\r\n\t\t\t`.item-container.spellcasting-entry[data-item-id=${entryId}]`,\r\n\t\t);\r\n\t\tconst btn = entry.find(\r\n\t\t\t\".spell-ability-data .statistic-values a.pf2e-staves-charge\",\r\n\t\t);\r\n\t\tbtn[0]?.click();\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst dailies = game.modules.get(\"pf2e-dailies\");\r\n\tif (!dailies?.active) return;\r\n\r\n\tconst entry = actor.spellcasting.get(entryId);\r\n\tdailies.api.updateEntryCharges(entry, 9999);\r\n}\r\n\r\nfunction onSlotsReset(event, sheet, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { itemId, rank, isCharge } = $(event.currentTarget).data();\r\n\tif (!itemId) return;\r\n\r\n\tif (isCharge) {\r\n\t\tonChargesReset(sheet, actor, itemId);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst item = actor.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tif (item.isOfType(\"consumable\")) {\r\n\t\tconst max = item.system.uses?.max;\r\n\t\tif (max) item.update({ \"system.uses.value\": max });\r\n\t} else if (item.isOfType(\"spellcastingEntry\")) {\r\n\t\tconst slotLevel = rank >= 0 && rank <= 11 ? `slot${rank}` : \"slot0\";\r\n\t\tconst slot = item.system.slots?.[slotLevel];\r\n\t\tif (slot) item.update({ [`system.slots.${slotLevel}.value`]: slot.max });\r\n\t} else if (item.isOfType(\"spell\")) {\r\n\t\tconst max = item.system.location.uses?.max;\r\n\t\tif (max) item.update({ \"system.location.uses.value\": max });\r\n\t}\r\n}\r\n\r\nasync function onItemToChat(event, actor) {\r\n\tconst { entryId, itemId, castRank } =\r\n\t\tevent.currentTarget.closest(\".item\").dataset;\r\n\r\n\tconst collection = actor.spellcasting.collections.get(entryId);\r\n\tif (!collection) return;\r\n\r\n\tconst spell = collection.get(itemId);\r\n\tspell?.toMessage(event, { data: { castRank: Number(castRank ?? NaN) } });\r\n}\r\n\r\nfunction getSpellcastingTab(html) {\r\n\treturn html.find(\r\n\t\t\"section.sheet-body .sheet-content > .tab[data-tab=spellcasting]\",\r\n\t);\r\n}\r\n\r\nasync function getData(actor) {\r\n\tconst focusPool = actor.system.resources.focus ?? { value: 0, max: 0 };\r\n\tconst pf2eStavesActive = game.modules.get(\"pf2e-staves\")?.active;\r\n\tconst pf2eDailies = game.modules.get(\"pf2e-dailies\");\r\n\tconst pf2eDailiesActive = pf2eDailies?.active;\r\n\tconst stavesActive =\r\n\t\tpf2eStavesActive ||\r\n\t\t(pf2eDailiesActive && isNewerVersion(pf2eDailies.version, \"2.14.0\"));\r\n\tconst chargesPath = pf2eStavesActive\r\n\t\t? \"flags.pf2e-staves.charges\"\r\n\t\t: pf2eDailiesActive\r\n\t\t  ? \"flags.pf2e-dailies.staff.charges\"\r\n\t\t  : \"\";\r\n\r\n\tconst spells = [];\r\n\tconst focuses = [];\r\n\r\n\tlet rituals;\r\n\tlet hasFocusCantrips = false;\r\n\r\n\tconst entries = await Promise.all(\r\n\t\tactor.spellcasting.collections.map(async (spells) => {\r\n\t\t\treturn {\r\n\t\t\t\tentry: spells.entry,\r\n\t\t\t\tdata: await spells.entry.getSheetData({ spells }),\r\n\t\t\t};\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const { entry, data } of entries) {\r\n\t\tif (data.isRitual) {\r\n\t\t\trituals = data.groups.flatMap((slot, slotId) =>\r\n\t\t\t\tslot.active\r\n\t\t\t\t\t.map(({ spell }) => ({\r\n\t\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\t\tslotId,\r\n\t\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\t\trank: spell.rank,\r\n\t\t\t\t\t\ttime: spell.system.time.value,\r\n\t\t\t\t\t}))\r\n\t\t\t\t\t.filter(Boolean),\r\n\t\t\t);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst entryId = data.id;\r\n\t\tconst entryDc = data.statistic.dc.value;\r\n\t\tconst entryName = data.name;\r\n\t\tconst isFocus = data.isFocusPool;\r\n\t\tconst isCharge = entry.system?.prepared?.value === \"charge\";\r\n\t\tconst isInnate = data.isInnate;\r\n\t\tconst isPrepared = data.isPrepared;\r\n\t\tconst isSpontaneous = data.isSpontaneous;\r\n\t\tconst isFlexible = data.isFlexible;\r\n\r\n\t\tconst consumable = (() => {\r\n\t\t\tif (data.category !== \"items\") return;\r\n\t\t\tconst itemId = entry.id.split(\"-\")[0];\r\n\t\t\treturn actor.items.get(itemId);\r\n\t\t})();\r\n\r\n\t\tconst charges = (() => {\r\n\t\t\tif (!isCharge) return;\r\n\r\n\t\t\tconst dailiesData =\r\n\t\t\t\tpf2eDailiesActive &&\r\n\t\t\t\tpf2eDailies.api.getSpellcastingEntryStaffData(entry);\r\n\t\t\tconst { charges, max, canPayCost } = dailiesData ??\r\n\t\t\t\tgetProperty(entry, \"flags.pf2e-staves.charges\") ?? {\r\n\t\t\t\t\tcharges: 0,\r\n\t\t\t\t\tmax: 0,\r\n\t\t\t\t};\r\n\r\n\t\t\treturn {\r\n\t\t\t\tvalue: charges,\r\n\t\t\t\tmax,\r\n\t\t\t\tnoMax: true,\r\n\t\t\t\tcanPayCost: canPayCost ?? (() => true),\r\n\t\t\t};\r\n\t\t})();\r\n\r\n\t\tfor (const group of data.groups) {\r\n\t\t\tif (!group.active.length || group.uses?.max === 0) continue;\r\n\r\n\t\t\tconst slotSpells = [];\r\n\t\t\tconst isCantrip = group.id === \"cantrips\";\r\n\t\t\tconst groupNumber = spellSlotGroupIdToNumber(group.id);\r\n\t\t\tconst isBroken = !isCantrip && isCharge && !stavesActive;\r\n\r\n\t\t\tfor (let slotId = 0; slotId < group.active.length; slotId++) {\r\n\t\t\t\tconst active = group.active[slotId];\r\n\t\t\t\tif (!active || active.uses?.max === 0) continue;\r\n\r\n\t\t\t\tconst { spell, expended, virtual, uses, castRank } = active;\r\n\r\n\t\t\t\tslotSpells.push({\r\n\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\trange: spell.system.range.value || \"-\",\r\n\t\t\t\t\tcastRank: castRank ?? spell.rank,\r\n\t\t\t\t\tslotId,\r\n\t\t\t\t\tentryId,\r\n\t\t\t\t\tentryDc,\r\n\t\t\t\t\tentryName,\r\n\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\tinputId: isInnate ? spell.id : data.id,\r\n\t\t\t\t\tinputPath: consumable\r\n\t\t\t\t\t\t? \"system.uses.value\"\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? chargesPath\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"system.location.uses.value\"\r\n\t\t\t\t\t\t\t  : `system.slots.slot${groupNumber}.value`,\r\n\t\t\t\t\tisCharge,\r\n\t\t\t\t\tisActiveCharge: isCharge && stavesActive,\r\n\t\t\t\t\tisBroken,\r\n\t\t\t\t\tisVirtual: virtual,\r\n\t\t\t\t\tisInnate,\r\n\t\t\t\t\tisCantrip,\r\n\t\t\t\t\tisFocus,\r\n\t\t\t\t\tisPrepared,\r\n\t\t\t\t\tisSpontaneous: isSpontaneous || isFlexible,\r\n\t\t\t\t\tgroupId: group.id,\r\n\t\t\t\t\tconsumable,\r\n\t\t\t\t\tuses: consumable\r\n\t\t\t\t\t\t? consumable.system.uses\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? charges\r\n\t\t\t\t\t\t  : uses ?? group.uses,\r\n\t\t\t\t\texpended:\r\n\t\t\t\t\t\tisCharge && !isCantrip\r\n\t\t\t\t\t\t\t? !charges.canPayCost(groupNumber)\r\n\t\t\t\t\t\t\t: expended ??\r\n\t\t\t\t\t\t\t  (isFocus && !isCantrip ? focusPool.value <= 0 : false),\r\n\t\t\t\t\taction: spell.system.time.value,\r\n\t\t\t\t\ttype: consumable\r\n\t\t\t\t\t\t? `PF2E.Item.Consumable.Category.${consumable.category}`\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? `${MODULE_ID}.summary.staff`\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeInnate\"\r\n\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeSpontaneous\"\r\n\t\t\t\t\t\t\t\t  : isFlexible\r\n\t\t\t\t\t\t\t\t\t  ? \"PF2E.SpellFlexibleLabel\"\r\n\t\t\t\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.TraitFocus\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.SpellPreparedLabel\",\r\n\t\t\t\t\torder: isCharge\r\n\t\t\t\t\t\t? 0\r\n\t\t\t\t\t\t: isPrepared\r\n\t\t\t\t\t\t  ? 1\r\n\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t  ? 2\r\n\t\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t\t  ? 3\r\n\t\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t\t  ? 4\r\n\t\t\t\t\t\t\t\t\t  : 5,\r\n\t\t\t\t\tnoHover: isPrepared || isCantrip || isBroken || isFocus,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (slotSpells.length) {\r\n\t\t\t\tif (isFocus) {\r\n\t\t\t\t\tif (isCantrip) hasFocusCantrips = true;\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfocuses.push(...slotSpells);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tspells[groupNumber] ??= [];\r\n\t\t\t\tspells[groupNumber].push(...slotSpells);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (spells.length) {\r\n\t\tconst sort =\r\n\t\t\tgetSetting(\"summary\") === \"sort\"\r\n\t\t\t\t? (a, b) =>\r\n\t\t\t\t\t\ta.order === b.order\r\n\t\t\t\t\t\t\t? localeCompare(a.name, b.name)\r\n\t\t\t\t\t\t\t: a.order - b.order\r\n\t\t\t\t: (a, b) => localeCompare(a.name, b.name);\r\n\r\n\t\tfor (const entry of spells) {\r\n\t\t\tif (!entry) continue;\r\n\t\t\tentry.sort(sort);\r\n\t\t}\r\n\t}\r\n\r\n\tif (focuses.length) {\r\n\t\tfocuses.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\tspells[12] = focuses;\r\n\t\thasFocusCantrips = false;\r\n\t}\r\n\r\n\treturn {\r\n\t\tspells,\r\n\t\trituals,\r\n\t\tfocusPool,\r\n\t\thasFocusCantrips,\r\n\t\tisOwner: actor.isOwner,\r\n\t\ti18n: subLocalize(\"summary\"),\r\n\t\tentryRank: (rank) =>\r\n\t\t\tgame.i18n.format(\"PF2E.Item.Spell.Rank.Ordinal\", {\r\n\t\t\t\trank: ordinalString(rank),\r\n\t\t\t}),\r\n\t};\r\n}\r\n", "export async function roll3dDice(\r\n\troll,\r\n\t{ user = game.user, synchronize = true } = {},\r\n) {\r\n\tif (!game.modules.get(\"dice-so-nice\")?.active) return;\r\n\treturn game.dice3d.showForRoll(roll, user, synchronize);\r\n}\r\n", "export function applyStackingRules(modifiers) {\r\n\tlet total = 0;\r\n\tconst highestBonus = {};\r\n\tconst lowestPenalty = {};\r\n\r\n\t// There are no ability bonuses or penalties, so always take the highest ability modifier.\r\n\tconst abilityModifiers = modifiers.filter(\r\n\t\t(m) => m.type === \"ability\" && !m.ignored,\r\n\t);\r\n\tconst bestAbility = abilityModifiers.reduce((best, modifier) => {\r\n\t\tif (best === null) {\r\n\t\t\treturn modifier;\r\n\t\t}\r\n\r\n\t\treturn modifier.force\r\n\t\t\t? modifier\r\n\t\t\t: best.force\r\n\t\t\t  ? best\r\n\t\t\t  : modifier.modifier > best.modifier\r\n\t\t\t\t  ? modifier\r\n\t\t\t\t  : best;\r\n\t}, null);\r\n\tfor (const modifier of abilityModifiers) {\r\n\t\tmodifier.ignored = modifier !== bestAbility;\r\n\t}\r\n\r\n\tfor (const modifier of modifiers) {\r\n\t\t// Always disable ignored modifiers and don't do anything further with them.\r\n\t\tif (modifier.ignored) {\r\n\t\t\tmodifier.enabled = false;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Untyped modifiers always stack, so enable them and add their modifier.\r\n\t\tif (modifier.type === \"untyped\") {\r\n\t\t\tmodifier.enabled = true;\r\n\t\t\ttotal += modifier.modifier;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Otherwise, apply stacking rules to positive modifiers and negative modifiers separately.\r\n\t\tif (modifier.modifier < 0) {\r\n\t\t\ttotal += applyStacking(lowestPenalty, modifier, LOWER_PENALTY);\r\n\t\t} else {\r\n\t\t\ttotal += applyStacking(highestBonus, modifier, HIGHER_BONUS);\r\n\t\t}\r\n\t}\r\n\r\n\treturn total;\r\n}\r\n\r\nfunction applyStacking(best, modifier, isBetter) {\r\n\t// If there is no existing bonus of this type, then add ourselves.\r\n\tconst existing = best[modifier.type];\r\n\tif (existing === undefined) {\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier;\r\n\t}\r\n\r\n\tif (isBetter(modifier, existing)) {\r\n\t\t// If we are a better modifier according to the comparison, then we become the new 'best'.\r\n\t\texisting.enabled = false;\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier - existing.modifier;\r\n\t}\r\n\r\n\t// Otherwise, the existing modifier is better, so do nothing.\r\n\tmodifier.enabled = false;\r\n\treturn 0;\r\n}\r\n", "export function htmlQuery(parent, selectors) {\r\n\tif (!(parent instanceof Element || parent instanceof Document)) return null;\r\n\treturn parent.querySelector(selectors);\r\n}\r\n", "export async function extractEphemeralEffects({\r\n\taffects,\r\n\torigin,\r\n\ttarget,\r\n\titem,\r\n\tdomains,\r\n\toptions,\r\n}) {\r\n\tif (!(origin && target)) return [];\r\n\r\n\tconst [effectsFrom, effectsTo] =\r\n\t\taffects === \"target\" ? [origin, target] : [target, origin];\r\n\tconst fullOptions = [\r\n\t\t...options,\r\n\t\teffectsFrom.getRollOptions(domains),\r\n\t\teffectsTo.getSelfRollOptions(affects),\r\n\t].flat();\r\n\tconst resolvables = item\r\n\t\t? item.isOfType(\"spell\")\r\n\t\t\t? { spell: item }\r\n\t\t\t: { weapon: item }\r\n\t\t: {};\r\n\treturn (\r\n\t\tawait Promise.all(\r\n\t\t\tdomains\r\n\t\t\t\t.flatMap(\r\n\t\t\t\t\t(s) => effectsFrom.synthetics.ephemeralEffects[s]?.[affects] ?? [],\r\n\t\t\t\t)\r\n\t\t\t\t.map((d) => d({ test: fullOptions, resolvables })),\r\n\t\t)\r\n\t).flatMap((e) => e ?? []);\r\n}\r\n\r\nexport function extractNotes(rollNotes, selectors) {\r\n\treturn selectors.flatMap((s) => (rollNotes[s] ?? []).map((n) => n.clone()));\r\n}\r\n\r\nexport function extractDamageDice(deferredDice, selectors, options) {\r\n\treturn selectors\r\n\t\t.flatMap((s) => deferredDice[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n}\r\n\r\nexport function extractModifiers(synthetics, selectors, options) {\r\n\tconst { modifierAdjustments, modifiers: syntheticModifiers } = synthetics;\r\n\tconst modifiers = Array.from(new Set(selectors))\r\n\t\t.flatMap((s) => syntheticModifiers[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n\tfor (const modifier of modifiers) {\r\n\t\tmodifier.adjustments = extractModifierAdjustments(\r\n\t\t\tmodifierAdjustments,\r\n\t\t\tselectors,\r\n\t\t\tmodifier.slug,\r\n\t\t);\r\n\t}\r\n\r\n\treturn modifiers;\r\n}\r\n\r\nfunction extractModifierAdjustments(adjustmentsRecord, selectors, slug) {\r\n\tconst adjustments = Array.from(\r\n\t\tnew Set(selectors.flatMap((s) => adjustmentsRecord[s] ?? [])),\r\n\t);\r\n\treturn adjustments.filter((a) => [slug, null].includes(a.slug));\r\n}\r\n", "import { onDamageApplied } from \"../../features/target\";\r\nimport { isInstanceOf } from \"../misc\";\r\nimport { applyStackingRules } from \"./actor\";\r\nimport { htmlQuery } from \"./dom\";\r\nimport { ErrorPF2e, signedInteger } from \"./misc\";\r\nimport {\r\n\textractDamageDice,\r\n\textractEphemeralEffects,\r\n\textractModifiers,\r\n\textractNotes,\r\n} from \"./rules\";\r\n\r\nexport async function applyDamageFromMessage(\r\n\ttoken,\r\n\t{\r\n\t\tmessage,\r\n\t\tmultiplier = 1,\r\n\t\taddend = 0,\r\n\t\tpromptModifier = false,\r\n\t\trollIndex = 0,\r\n\t},\r\n) {\r\n\tif (promptModifier) return shiftAdjustDamage(message, multiplier, rollIndex);\r\n\r\n\tconst tokens = [token];\r\n\tif (tokens.length === 0) {\r\n\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\tlocalize: true,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst shieldBlockRequest = CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\tconst roll = message.rolls.at(rollIndex);\r\n\tif (!isInstanceOf(roll, \"DamageRoll\"))\r\n\t\tthrow ErrorPF2e(\"Unexpected error retrieving damage roll\");\r\n\r\n\tlet damage =\r\n\t\tmultiplier < 0\r\n\t\t\t? multiplier * roll.total + addend\r\n\t\t\t: roll.alter(multiplier, addend);\r\n\r\n\t// Get origin roll options and apply damage to a contextual clone: this may influence condition IWR, for example\r\n\tconst messageRollOptions = [...(message.flags.pf2e.context?.options ?? [])];\r\n\tconst originRollOptions = messageRollOptions\r\n\t\t.filter((o) => o.startsWith(\"self:\"))\r\n\t\t.map((o) => o.replace(/^self/, \"origin\"));\r\n\tconst messageItem = message.item;\r\n\r\n\tfor (const token of tokens) {\r\n\t\tif (!token.actor) continue;\r\n\r\n\t\t// If no target was acquired during a roll, set roll options for it during damage application\r\n\t\tif (!messageRollOptions.some((o) => o.startsWith(\"target\"))) {\r\n\t\t\tmessageRollOptions.push(...token.actor.getSelfRollOptions(\"target\"));\r\n\t\t}\r\n\t\tconst domain = multiplier > 0 ? \"damage-received\" : \"healing-received\";\r\n\t\tconst ephemeralEffects =\r\n\t\t\tmultiplier > 0\r\n\t\t\t\t? await extractEphemeralEffects({\r\n\t\t\t\t\t\taffects: \"target\",\r\n\t\t\t\t\t\torigin: message.actor,\r\n\t\t\t\t\t\ttarget: token.actor,\r\n\t\t\t\t\t\titem: message.item,\r\n\t\t\t\t\t\tdomains: [domain],\r\n\t\t\t\t\t\toptions: messageRollOptions,\r\n\t\t\t\t  })\r\n\t\t\t\t: [];\r\n\t\tconst contextClone = token.actor.getContextualClone(\r\n\t\t\toriginRollOptions,\r\n\t\t\tephemeralEffects,\r\n\t\t);\r\n\t\tconst applicationRollOptions = new Set([\r\n\t\t\t...messageRollOptions.filter((o) => !/^(?:self|target):/.test(o)),\r\n\t\t\t...originRollOptions,\r\n\t\t\t...contextClone.getSelfRollOptions(),\r\n\t\t]);\r\n\r\n\t\t// Target-specific damage/healing adjustments\r\n\t\tconst outcome = message.flags.pf2e.context?.outcome;\r\n\t\tconst breakdown = [];\r\n\t\tconst rolls = [];\r\n\t\tif (typeof damage === \"number\" && damage < 0) {\r\n\t\t\tconst critical = outcome === \"criticalSuccess\";\r\n\r\n\t\t\tconst resolvables = (() => {\r\n\t\t\t\tif (messageItem?.isOfType(\"spell\")) return { spell: messageItem };\r\n\t\t\t\tif (messageItem?.isOfType(\"weapon\")) return { weapon: messageItem };\r\n\t\t\t\treturn {};\r\n\t\t\t})();\r\n\r\n\t\t\tconst damageDice = extractDamageDice(\r\n\t\t\t\tcontextClone.synthetics.damageDice,\r\n\t\t\t\t[domain],\r\n\t\t\t\t{\r\n\t\t\t\t\tresolvables,\r\n\t\t\t\t\ttest: applicationRollOptions,\r\n\t\t\t\t},\r\n\t\t\t).filter(\r\n\t\t\t\t(d) =>\r\n\t\t\t\t\t(d.critical === null || d.critical === critical) &&\r\n\t\t\t\t\td.predicate.test(applicationRollOptions),\r\n\t\t\t);\r\n\r\n\t\t\tfor (const dice of damageDice) {\r\n\t\t\t\tconst formula = `${dice.diceNumber}${dice.dieSize}[${dice.label}]`;\r\n\t\t\t\tconst roll = await new Roll(formula).evaluate({ async: true });\r\n\t\t\t\troll._formula = `${dice.diceNumber}${dice.dieSize}`; // remove the label from the main formula\r\n\t\t\t\tawait roll.toMessage({\r\n\t\t\t\t\tflags: { pf2e: { suppressDamageButtons: true } },\r\n\t\t\t\t\tflavor: dice.label,\r\n\t\t\t\t\tspeaker: ChatMessage.getSpeaker({ token }),\r\n\t\t\t\t});\r\n\t\t\t\tbreakdown.push(`${dice.label} ${dice.diceNumber}${dice.dieSize}`);\r\n\t\t\t\trolls.push(roll);\r\n\t\t\t}\r\n\t\t\tif (rolls.length) {\r\n\t\t\t\tdamage -= rolls\r\n\t\t\t\t\t.map((roll) => roll.total)\r\n\t\t\t\t\t.reduce((previous, current) => previous + current);\r\n\t\t\t}\r\n\r\n\t\t\tconst modifiers = extractModifiers(contextClone.synthetics, [domain], {\r\n\t\t\t\tresolvables,\r\n\t\t\t}).filter(\r\n\t\t\t\t(m) =>\r\n\t\t\t\t\t(m.critical === null || m.critical === critical) &&\r\n\t\t\t\t\tm.predicate.test(applicationRollOptions),\r\n\t\t\t);\r\n\r\n\t\t\t// unlikely to have any typed modifiers, but apply stacking rules just in case even though the context of\r\n\t\t\t// previously applied modifiers has been lost\r\n\t\t\tdamage -= applyStackingRules(modifiers ?? []);\r\n\r\n\t\t\t// target-specific modifiers breakdown\r\n\t\t\tbreakdown.push(\r\n\t\t\t\t...modifiers\r\n\t\t\t\t\t.filter((m) => m.enabled)\r\n\t\t\t\t\t.map((m) => `${m.label} ${signedInteger(m.modifier)}`),\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tconst hasDamageOrHealing =\r\n\t\t\ttypeof damage === \"number\" ? damage !== 0 : damage.total !== 0;\r\n\t\tconst notes = hasDamageOrHealing\r\n\t\t\t? extractNotes(contextClone.synthetics.rollNotes, [domain]).filter(\r\n\t\t\t\t\t(n) =>\r\n\t\t\t\t\t\t(!outcome ||\r\n\t\t\t\t\t\t\tn.outcome.length === 0 ||\r\n\t\t\t\t\t\t\tn.outcome.includes(outcome)) &&\r\n\t\t\t\t\t\tn.predicate.test(applicationRollOptions),\r\n\t\t\t  )\r\n\t\t\t: [];\r\n\r\n\t\tawait contextClone.applyDamage({\r\n\t\t\tdamage,\r\n\t\t\ttoken,\r\n\t\t\titem: message.item,\r\n\t\t\tskipIWR: multiplier <= 0,\r\n\t\t\trollOptions: applicationRollOptions,\r\n\t\t\tshieldBlockRequest,\r\n\t\t\tbreakdown,\r\n\t\t\tnotes,\r\n\t\t});\r\n\t}\r\n\ttoggleOffShieldBlock(message.id);\r\n\r\n\t/**\r\n\t * added stuff HERE\r\n\t */\r\n\tonDamageApplied(message, token.id, rollIndex);\r\n}\r\n\r\nexport function onClickShieldBlock(target, shieldButton, messageEl) {\r\n\tconst getTokens = () => {\r\n\t\treturn [target];\r\n\t};\r\n\r\n\tconst getNonBrokenShields = (tokens) => {\r\n\t\tconst actor = tokens[0]?.actor;\r\n\t\treturn (\r\n\t\t\tactor?.itemTypes.shield.filter(\r\n\t\t\t\t(s) => s.isEquipped && !s.isBroken && !s.isDestroyed,\r\n\t\t\t) ?? []\r\n\t\t);\r\n\t};\r\n\r\n\t// Add a tooltipster instance to the shield button if needed.\r\n\tif (!shieldButton.classList.contains(\"tooltipstered\")) {\r\n\t\t$(shieldButton)\r\n\t\t\t.tooltipster({\r\n\t\t\t\tanimation: \"fade\",\r\n\t\t\t\ttrigger: \"click\",\r\n\t\t\t\tarrow: false,\r\n\t\t\t\tcontent: htmlQuery(messageEl, \"div.hover-content\"),\r\n\t\t\t\tcontentAsHTML: true,\r\n\t\t\t\tcontentCloning: true,\r\n\t\t\t\tdebug: false,\r\n\t\t\t\tinteractive: true,\r\n\t\t\t\tside: [\"top\"],\r\n\t\t\t\ttheme: \"crb-hover\",\r\n\t\t\t\tfunctionBefore: () => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tif (!tokens.length) return false;\r\n\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst hasMultipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// More than one shield and no selection. Show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && !shieldActivated) {\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// More than one shield and one was previously selected. Remove selection and show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && shieldButton.dataset.shieldId) {\r\n\t\t\t\t\t\tshieldButton.attributes.removeNamedItem(\"data-shield-id\");\r\n\t\t\t\t\t\tshieldButton.classList.remove(\"shield-activated\");\r\n\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Normal toggle behaviour. Tooltip is suppressed.\r\n\t\t\t\t\tshieldButton.classList.toggle(\"shield-activated\");\r\n\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle =\r\n\t\t\t\t\t\t!CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\t\t\t\tfunctionFormat: (instance, _helper, contentEl) => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst multipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// If the actor is wielding more than one shield, have the user pick which shield to use for blocking.\r\n\t\t\t\t\tif (multipleShields && !shieldActivated) {\r\n\t\t\t\t\t\t// Populate the list with the shield options\r\n\t\t\t\t\t\tconst listEl = htmlQuery(contentEl, \"ul.shield-options\");\r\n\t\t\t\t\t\tif (!listEl) return $(contentEl);\r\n\r\n\t\t\t\t\t\tconst shieldList = nonBrokenShields.map((shield) => {\r\n\t\t\t\t\t\t\tconst input = document.createElement(\"input\");\r\n\t\t\t\t\t\t\tinput.classList.add(\"data\");\r\n\t\t\t\t\t\t\tinput.type = \"radio\";\r\n\t\t\t\t\t\t\tinput.name = \"shield-id\";\r\n\t\t\t\t\t\t\tinput.value = shield.id;\r\n\t\t\t\t\t\t\tinput.addEventListener(\"click\", () => {\r\n\t\t\t\t\t\t\t\tshieldButton.dataset.shieldId = input.value;\r\n\t\t\t\t\t\t\t\tshieldButton.classList.add(\"shield-activated\");\r\n\t\t\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = true;\r\n\t\t\t\t\t\t\t\tinstance.close();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst shieldName = document.createElement(\"span\");\r\n\t\t\t\t\t\t\tshieldName.classList.add(\"label\");\r\n\t\t\t\t\t\t\tshieldName.innerHTML = shield.name;\r\n\r\n\t\t\t\t\t\t\tconst hardness = document.createElement(\"span\");\r\n\t\t\t\t\t\t\thardness.classList.add(\"tag\");\r\n\t\t\t\t\t\t\tconst hardnessLabel = game.i18n.localize(\"PF2E.HardnessLabel\");\r\n\t\t\t\t\t\t\thardness.innerHTML = `${hardnessLabel}: ${shield.hardness}`;\r\n\r\n\t\t\t\t\t\t\tconst itemLi = document.createElement(\"li\");\r\n\t\t\t\t\t\t\titemLi.classList.add(\"item\");\r\n\t\t\t\t\t\t\titemLi.append(input, shieldName, hardness);\r\n\r\n\t\t\t\t\t\t\treturn itemLi;\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tlistEl.replaceChildren(...shieldList);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn $(contentEl);\r\n\t\t\t\t},\r\n\t\t\t})\r\n\t\t\t.tooltipster(\"open\");\r\n\t}\r\n}\r\n\r\nfunction toggleOffShieldBlock(messageId) {\r\n\tfor (const app of [\"#chat-log\", \"#chat-popout\"]) {\r\n\t\tconst selector = `${app} > li.chat-message[data-message-id=\"${messageId}\"] button[data-action=shield-block]`;\r\n\t\tconst button = htmlQuery(document.body, selector);\r\n\t\tbutton?.classList.remove(\"shield-activated\");\r\n\t}\r\n\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n}\r\n\r\nasync function shiftAdjustDamage(token, { message, multiplier, rollIndex }) {\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/damage/adjustment-dialog.hbs\",\r\n\t);\r\n\tconst AdjustmentDialog = class extends Dialog {\r\n\t\tactivateListeners($html) {\r\n\t\t\tsuper.activateListeners($html);\r\n\t\t\t$html[0].querySelector(\"input\")?.focus();\r\n\t\t}\r\n\t};\r\n\tconst isHealing = multiplier < 0;\r\n\tnew AdjustmentDialog({\r\n\t\ttitle: game.i18n.localize(\r\n\t\t\tisHealing\r\n\t\t\t\t? \"PF2E.UI.shiftModifyHealingTitle\"\r\n\t\t\t\t: \"PF2E.UI.shiftModifyDamageTitle\",\r\n\t\t),\r\n\t\tcontent,\r\n\t\tbuttons: {\r\n\t\t\tok: {\r\n\t\t\t\tlabel: game.i18n.localize(\"PF2E.OK\"),\r\n\t\t\t\tcallback: async ($dialog) => {\r\n\t\t\t\t\t// In case of healing, multipler will have negative sign. The user will expect that positive\r\n\t\t\t\t\t// modifier would increase healing value, while negative would decrease.\r\n\t\t\t\t\tconst adjustment =\r\n\t\t\t\t\t\t(Number($dialog[0].querySelector(\"input\")?.value) || 0) *\r\n\t\t\t\t\t\tMath.sign(multiplier);\r\n\t\t\t\t\tapplyDamageFromMessage(token, {\r\n\t\t\t\t\t\tmessage,\r\n\t\t\t\t\t\tmultiplier,\r\n\t\t\t\t\t\taddend: adjustment,\r\n\t\t\t\t\t\tpromptModifier: false,\r\n\t\t\t\t\t\trollIndex,\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tcancel: {\r\n\t\t\t\tlabel: \"Cancel\",\r\n\t\t\t},\r\n\t\t},\r\n\t\tdefault: \"ok\",\r\n\t\tclose: () => {\r\n\t\t\ttoggleOffShieldBlock(message.id);\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "const DEGREE_ADJUSTMENT_AMOUNTS = {\r\n\tLOWER_BY_TWO: -2,\r\n\tLOWER: -1,\r\n\tINCREASE: 1,\r\n\tINCREASE_BY_TWO: 2,\r\n\tTO_CRITICAL_FAILURE: \"criticalFailure\",\r\n\tTO_FAILURE: \"failure\",\r\n\tTO_SUCCESS: \"success\",\r\n\tTO_CRITICAL_SUCCESS: \"criticalSuccess\",\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS_STRINGS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\nexport class DegreeOfSuccess {\r\n\tconstructor(roll, dc, dosAdjustments = null) {\r\n\t\tif (roll instanceof Roll) {\r\n\t\t\tthis.dieResult =\r\n\t\t\t\t(roll.isDeterministic\r\n\t\t\t\t\t? roll.terms.find((t) => t instanceof NumericTerm)\r\n\t\t\t\t\t: roll.dice.find((d) => d instanceof Die && d.faces === 20)\r\n\t\t\t\t)?.total ?? 1;\r\n\t\t\tthis.rollTotal = roll.total;\r\n\t\t} else {\r\n\t\t\tthis.dieResult = roll.dieValue;\r\n\t\t\tthis.rollTotal = roll.dieValue + roll.modifier;\r\n\t\t}\r\n\r\n\t\tthis.dc = typeof dc === \"number\" ? { value: dc } : dc;\r\n\r\n\t\tthis.unadjusted = this.#calculateDegreeOfSuccess();\r\n\t\tthis.adjustment = this.#getDegreeAdjustment(\r\n\t\t\tthis.unadjusted,\r\n\t\t\tdosAdjustments,\r\n\t\t);\r\n\t\tthis.value = this.adjustment\r\n\t\t\t? this.#adjustDegreeOfSuccess(this.adjustment.amount, this.unadjusted)\r\n\t\t\t: this.unadjusted;\r\n\t}\r\n\r\n\tstatic CRITICAL_FAILURE = 0;\r\n\tstatic FAILURE = 1;\r\n\tstatic SUCCESS = 2;\r\n\tstatic CRITICAL_SUCCESS = 3;\r\n\r\n\t#getDegreeAdjustment(degree, adjustments) {\r\n\t\tif (!adjustments) return null;\r\n\r\n\t\tfor (const outcome of [\"all\", ...DEGREE_OF_SUCCESS_STRINGS]) {\r\n\t\t\tconst { label, amount } = adjustments[outcome] ?? {};\r\n\t\t\tif (\r\n\t\t\t\tamount &&\r\n\t\t\t\tlabel &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_SUCCESS &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.INCREASE\r\n\t\t\t\t) &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_FAILURE &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.LOWER\r\n\t\t\t\t) &&\r\n\t\t\t\t(outcome === \"all\" ||\r\n\t\t\t\t\tDEGREE_OF_SUCCESS_STRINGS.indexOf(outcome) === degree)\r\n\t\t\t) {\r\n\t\t\t\treturn { label, amount };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\t#adjustDegreeOfSuccess(amount, degreeOfSuccess) {\r\n\t\tswitch (amount) {\r\n\t\t\tcase \"criticalFailure\":\r\n\t\t\t\treturn 0;\r\n\t\t\tcase \"failure\":\r\n\t\t\t\treturn 1;\r\n\t\t\tcase \"success\":\r\n\t\t\t\treturn 2;\r\n\t\t\tcase \"criticalSuccess\":\r\n\t\t\t\treturn 3;\r\n\t\t\tdefault:\r\n\t\t\t\treturn Math.clamped(degreeOfSuccess + amount, 0, 3);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * @param degree The current success value\r\n\t * @return The new success value\r\n\t */\r\n\t#adjustDegreeByDieValue(degree) {\r\n\t\tif (this.dieResult === 20) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.INCREASE,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (this.dieResult === 1) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.LOWER,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn degree;\r\n\t}\r\n\r\n\t#calculateDegreeOfSuccess() {\r\n\t\tconst dc = this.dc.value;\r\n\r\n\t\tif (this.rollTotal - dc >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS);\r\n\t\t}\r\n\r\n\t\tif (dc - this.rollTotal >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE);\r\n\t\t}\r\n\r\n\t\tif (this.rollTotal >= dc) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS);\r\n\t\t}\r\n\r\n\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE);\r\n\t}\r\n}\r\n", "export function getTemplateTokens(\r\n\tmeasuredTemplate,\r\n\t{ collisionOrigin, collisionType = \"move\" } = {},\r\n) {\r\n\tconst template =\r\n\t\tmeasuredTemplate instanceof MeasuredTemplateDocument\r\n\t\t\t? measuredTemplate.object\r\n\t\t\t: measuredTemplate;\r\n\r\n\tif (!canvas.scene) return [];\r\n\tconst { grid, dimensions } = canvas;\r\n\tif (!(grid && dimensions)) return [];\r\n\r\n\tif (!template?.highlightId) return [];\r\n\r\n\tconst gridHighlight = grid.getHighlightLayer(template.highlightId);\r\n\tif (!gridHighlight || grid.type !== CONST.GRID_TYPES.SQUARE) return [];\r\n\tconst origin = collisionOrigin ?? template.center;\r\n\r\n\t// Get all the tokens that are inside the highlight bounds\r\n\tconst tokens = canvas.tokens.quadtree.getObjects(\r\n\t\tgridHighlight.getLocalBounds(undefined, true),\r\n\t);\r\n\r\n\tconst gridSize = grid.size;\r\n\r\n\tconst containedTokens = [];\r\n\tfor (const token of tokens) {\r\n\t\tconst tokenDoc = token.document;\r\n\r\n\t\t// Collect the position of all grid squares that this token occupies as \"x.y\"\r\n\t\tconst tokenPositions = [];\r\n\t\tfor (let h = 0; h < tokenDoc.height; h++) {\r\n\t\t\tconst tokenX = Math.floor(token.x / gridSize) * gridSize;\r\n\t\t\tconst tokenY = Math.floor(token.y / gridSize) * gridSize;\r\n\r\n\t\t\tconst y = tokenY + h * gridSize;\r\n\t\t\ttokenPositions.push(`${tokenX}.${y}`);\r\n\t\t\tif (tokenDoc.width > 1) {\r\n\t\t\t\tfor (let w = 1; w < tokenDoc.width; w++) {\r\n\t\t\t\t\ttokenPositions.push(`${tokenX + w * gridSize}.${y}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const position of tokenPositions) {\r\n\t\t\t// Check if a position exists within this GridHiglight\r\n\t\t\tif (!gridHighlight.positions.has(position)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t// Position of cell's top-left corner, in pixels\r\n\t\t\tconst [gx, gy] = position.split(\".\").map((s) => Number(s));\r\n\t\t\t// Position of cell's center in pixels\r\n\t\t\tconst destination = {\r\n\t\t\t\tx: gx + dimensions.size * 0.5,\r\n\t\t\t\ty: gy + dimensions.size * 0.5,\r\n\t\t\t};\r\n\t\t\tif (destination.x < 0 || destination.y < 0) continue;\r\n\r\n\t\t\tconst hasCollision =\r\n\t\t\t\tcanvas.ready &&\r\n\t\t\t\tcollisionType &&\r\n\t\t\t\tCONFIG.Canvas.polygonBackends[collisionType].testCollision(\r\n\t\t\t\t\torigin,\r\n\t\t\t\t\tdestination,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttype: collisionType,\r\n\t\t\t\t\t\tmode: \"any\",\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\tif (!hasCollision) {\r\n\t\t\t\tcontainedTokens.push(token);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn containedTokens;\r\n}\r\n", "import {\r\n\tbindOnPreCreateSpellDamageChatMessage,\r\n\tlatestChatMessages,\r\n} from \"../shared/chat\";\r\nimport { roll3dDice } from \"../shared/dicesonice\";\r\nimport {\r\n\tgetFlag,\r\n\tmoduleFlagUpdate,\r\n\tsetFlag,\r\n\tupdateSourceFlag,\r\n} from \"../shared/flags\";\r\nimport { createChoicesHook, createHook } from \"../shared/hook\";\r\nimport { localize, subLocalize } from \"../shared/localize\";\r\nimport { deleteInMemory, getInMemory, setInMemory } from \"../shared/misc\";\r\nimport { warn } from \"../shared/notification\";\r\nimport { templatePath } from \"../shared/path\";\r\nimport {\r\n\tapplyDamageFromMessage,\r\n\tonClickShieldBlock,\r\n} from \"../shared/pf2e/chat\";\r\nimport { DegreeOfSuccess } from \"../shared/pf2e/success\";\r\nimport { choiceSettingIsEnabled, getSetting } from \"../shared/settings\";\r\nimport { socketEmit, socketOff, socketOn } from \"../shared/socket\";\r\nimport { getTemplateTokens } from \"../shared/template\";\r\nimport { isActiveGM, isUserGM } from \"../shared/user\";\r\n\r\nconst SAVES = {\r\n\tfortitude: { icon: \"fa-solid fa-chess-rook\", label: \"PF2E.SavesFortitude\" },\r\n\treflex: { icon: \"fa-solid fa-person-running\", label: \"PF2E.SavesReflex\" },\r\n\twill: { icon: \"fa-solid fa-brain\", label: \"PF2E.SavesWill\" },\r\n};\r\n\r\nconst REROLL = {\r\n\thero: {\r\n\t\ticon: \"fa-solid fa-hospital-symbol\",\r\n\t\treroll: \"PF2E.RerollMenu.HeroPoint\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageHeroPoint\",\r\n\t},\r\n\tnew: {\r\n\t\ticon: \"fa-solid fa-dice\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepNew\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.new\",\r\n\t},\r\n\tlower: {\r\n\t\ticon: \"fa-solid fa-dice-one\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepLower\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.lower\",\r\n\t},\r\n\thigher: {\r\n\t\ticon: \"fa-solid fa-dice-six\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepHigher\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.higher\",\r\n\t},\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\nconst setPrecreateMessageHook = createHook(\r\n\t\"preCreateChatMessage\",\r\n\tpreCreateChatMessage,\r\n);\r\nconst setRenderMessageHook = createChoicesHook(\r\n\t\"renderChatMessage\",\r\n\trenderChatMessage,\r\n);\r\nconst setCreateTemplateHook = createHook(\r\n\t\"createMeasuredTemplate\",\r\n\tcreateMeasuredTemplate,\r\n);\r\n\r\nlet SOCKET = false;\r\n\r\nexport function registerTargetTokenHelper() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"target\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: setHooks,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"target-client\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"small\", \"big\"],\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) =>\r\n\t\t\t\t\tsetRenderMessageHook(value && getSetting(\"target\")),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"target-template\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) =>\r\n\t\t\t\t\tsetCreateTemplateHook(value && getSetting(\"target\")),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [],\r\n\t\tready: () => {\r\n\t\t\tif (getSetting(\"target\")) setHooks(true);\r\n\t\t\tfor (const { message, html } of latestChatMessages(10)) {\r\n\t\t\t\trenderChatMessage(message, html);\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setHooks(value) {\r\n\tsetPrecreateMessageHook(value);\r\n\tsetRenderMessageHook(value);\r\n\tsetCreateTemplateHook(value && getSetting(\"target-template\"));\r\n\r\n\tif (isUserGM()) {\r\n\t\tif (value && !SOCKET) {\r\n\t\t\tsocketOn(onSocket);\r\n\t\t\tSOCKET = true;\r\n\t\t} else if (!value && SOCKET) {\r\n\t\t\tsocketOff(onSocket);\r\n\t\t\tSOCKET = false;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tif (!isActiveGM()) return;\r\n\tswitch (packet.type) {\r\n\t\tcase \"target.update-save\":\r\n\t\t\tupdateMessageSave(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"target.update-applied\":\r\n\t\t\tupdateMessageApplied(packet);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nasync function createMeasuredTemplate(template, _, userId) {\r\n\tconst user = game.user;\r\n\tif (user.id !== userId) return;\r\n\r\n\tconst localize = subLocalize(\"target.menu\");\r\n\tconst item = template.item;\r\n\tconst actor = template.actor;\r\n\tconst self = !actor ? undefined : actor.token ?? actor.getActiveTokens()[0];\r\n\r\n\tconst data = {\r\n\t\ttitle: item?.name || localize(\"title\"),\r\n\t\tcontent: await renderTemplate(templatePath(\"target/template-menu\"), {\r\n\t\t\ti18n: localize,\r\n\t\t\tnoSelf: !self,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tselect: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-bullseye-arrow\"></i>',\r\n\t\t\t\tlabel: localize(\"target\"),\r\n\t\t\t\tcallback: (html) => ({\r\n\t\t\t\t\ttargets: html.find(\"[name=targets]:checked\").val(),\r\n\t\t\t\t\tself: html.find(\"[name=self]\").prop(\"checked\"),\r\n\t\t\t\t\tneutral: html.find(\"[name=neutral]\").prop(\"checked\"),\r\n\t\t\t\t}),\r\n\t\t\t},\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-toolbelt-target-template\",\r\n\t\twidth: 260,\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst alliance = actor ? actor.alliance : user.isGM ? \"opposition\" : \"party\";\r\n\tconst opposition =\r\n\t\talliance === \"party\"\r\n\t\t\t? \"opposition\"\r\n\t\t\t: alliance === \"opposition\"\r\n\t\t\t  ? \"party\"\r\n\t\t\t  : null;\r\n\r\n\tconst tokens = getTemplateTokens(template);\r\n\tconst targets = tokens.filter((token) => {\r\n\t\tconst validActor = token.actor?.isOfType(\"creature\", \"hazard\", \"vehicle\");\r\n\t\tif (!validActor) return false;\r\n\r\n\t\tif (token.document.hidden) return false;\r\n\r\n\t\tif (self && token === self) return result.self;\r\n\r\n\t\tconst targetAlliance = token.actor ? token.actor.alliance : token.alliance;\r\n\r\n\t\tif (targetAlliance === null) return result.neutral;\r\n\r\n\t\treturn (\r\n\t\t\tresult.targets === \"all\" ||\r\n\t\t\t(result.targets === \"allies\" && targetAlliance === alliance) ||\r\n\t\t\t(result.targets === \"enemies\" && targetAlliance === opposition)\r\n\t\t);\r\n\t});\r\n\r\n\tconst targetsIds = targets.map((token) => token.id);\r\n\tuser.updateTokenTargets(targetsIds);\r\n\tuser.broadcastActivity({ targets: targetsIds });\r\n}\r\n\r\nlet HEALINGS_REGEX;\r\nfunction isRegenMessage(message) {\r\n\tHEALINGS_REGEX ??= (() => {\r\n\t\tconst healings = [\r\n\t\t\tgame.i18n.localize(\r\n\t\t\t\t\"PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage\",\r\n\t\t\t),\r\n\t\t\tgame.i18n.localize(\r\n\t\t\t\t\"PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage\",\r\n\t\t\t),\r\n\t\t];\r\n\t\treturn new RegExp(`^<div>(${healings.join(\"|\")})</div>`);\r\n\t})();\r\n\treturn HEALINGS_REGEX.test(message.flavor);\r\n}\r\n\r\nfunction isValidDamageMessage(message) {\r\n\treturn !message.rolls[0].options.evaluatePersistent;\r\n}\r\n\r\nfunction preCreateChatMessage(message) {\r\n\tconst isDamageRoll = message.isDamageRoll;\r\n\tconst updates = [];\r\n\r\n\tif (isDamageRoll && !isValidDamageMessage(message)) return;\r\n\r\n\tif (isDamageRoll && !getFlag(message, \"target\")) {\r\n\t\tconst token = message.token;\r\n\t\tconst actor = token?.actor;\r\n\t\tconst isRegen = isRegenMessage(message);\r\n\r\n\t\tconst targets = isRegen\r\n\t\t\t? actor\r\n\t\t\t\t? [{ token: token.uuid, actor: actor.uuid }]\r\n\t\t\t\t: []\r\n\t\t\t: Array.from(\r\n\t\t\t\t\tgame.user.targets.map((target) => ({\r\n\t\t\t\t\t\ttoken: target.document.uuid,\r\n\t\t\t\t\t\tactor: target.actor.uuid,\r\n\t\t\t\t\t})),\r\n\t\t\t  );\r\n\r\n\t\tupdates.push([\"targets\", targets]);\r\n\t\tif (isRegen) updates.push([\"isRegen\", true]);\r\n\r\n\t\tif (message.rolls.length === 2) {\r\n\t\t\tconst rolls = message.rolls.filter((roll) => roll.options);\r\n\t\t\tconst splashRollIndex = rolls.findIndex(\r\n\t\t\t\t(roll) => roll.options.splashOnly,\r\n\t\t\t);\r\n\t\t\tconst regularRollIndex = rolls.findIndex(\r\n\t\t\t\t(roll) =>\r\n\t\t\t\t\t!roll.options.splashOnly &&\r\n\t\t\t\t\troll.options.damage?.modifiers.some(\r\n\t\t\t\t\t\t(modifier) => modifier.damageCategory === \"splash\",\r\n\t\t\t\t\t),\r\n\t\t\t);\r\n\r\n\t\t\tif (splashRollIndex !== -1 && regularRollIndex !== -1) {\r\n\t\t\t\tupdates.push([\"splashIndex\", splashRollIndex]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (\r\n\t\tisDamageRoll ||\r\n\t\tmessage.getFlag(\"pf2e\", \"context.type\") === \"spell-cast\"\r\n\t) {\r\n\t\tconst item = message.item;\r\n\t\tconst save = item && item.type === \"spell\" && item.system.defense?.save;\r\n\t\tif (save) {\r\n\t\t\tconst dc = (() => {\r\n\t\t\t\tif (!item.trickMagicEntry) return item.spellcasting?.statistic.dc.value;\r\n\t\t\t\treturn $(message.content).find(\"[data-action=spell-save]\").data()?.dc;\r\n\t\t\t})();\r\n\t\t\tif (typeof dc === \"number\") updates.push([\"save\", { ...save, dc }]);\r\n\t\t}\r\n\t}\r\n\r\n\tif (!updates.length) return;\r\n\r\n\tupdateSourceFlag(\r\n\t\tmessage,\r\n\t\t\"target\",\r\n\t\tupdates.reduce((acc, [key, value]) => {\r\n\t\t\tacc[key] = value;\r\n\t\t\treturn acc;\r\n\t\t}, {}),\r\n\t);\r\n}\r\n\r\nasync function renderChatMessage(message, html) {\r\n\tconst clientEnabled = choiceSettingIsEnabled(\"target-client\");\r\n\r\n\tif (clientEnabled && message.isDamageRoll) {\r\n\t\tif (!isValidDamageMessage(message)) return;\r\n\t\tawait renderDamageChatMessage(message, html);\r\n\t\trefreshMessage(message);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst item = message.item;\r\n\tif (!item || item.type !== \"spell\") return;\r\n\r\n\tif (clientEnabled && !item.damageKinds.size) {\r\n\t\tawait renderSpellChatMessage(message, html, item);\r\n\t\trefreshMessage(message);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (item.trickMagicEntry && item.system.defense?.save) {\r\n\t\thtml.find(\"[data-action=spell-damage]\").on(\"click\", () => {\r\n\t\t\tbindOnPreCreateSpellDamageChatMessage(message);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction refreshMessage(message) {\r\n\tPromise.all(\r\n\t\t[ui.chat, ui.chat._popout].map(async (chat) => {\r\n\t\t\tconst el = chat?.element[0]?.querySelector(\"#chat-log\");\r\n\t\t\tif (!el || (!chat.isAtBottom && message.user._id !== game.user._id))\r\n\t\t\t\treturn;\r\n\r\n\t\t\tawait chat._waitForImages();\r\n\t\t\tel.scrollTop = el.scrollHeight;\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const app of Object.values(message.apps)) {\r\n\t\tif (!(app instanceof ChatPopout)) continue;\r\n\t\tif (!app.rendered) continue;\r\n\r\n\t\tapp.setPosition();\r\n\t}\r\n}\r\n\r\nasync function renderSpellChatMessage(message, html, spell) {\r\n\tconst data = await getMessageData(message);\r\n\tif (!data) return;\r\n\r\n\tconst { targets, save } = data;\r\n\tconst msgContent = html.find(\".message-content\");\r\n\tconst cardBtns = msgContent.find(\".card-buttons\");\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tconst saveBtn = cardBtns.find(\"[data-action=spell-save]\");\r\n\t\tconst wrapper = $('<div class=\"pf2e-toolbelt-target-wrapper\"></div>');\r\n\t\tconst targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n\r\n\t\tconst targetsBtn =\r\n\t\t\t$(`<button class=\"pf2e-toolbelt-target-targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n\t\ttargetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n\t\twrapper.append(targetsBtn);\r\n\t\twrapper.append(saveBtn);\r\n\t\tcardBtns.prepend(wrapper);\r\n\t}\r\n\r\n\tif (spell?.area && !spell.traits.has(\"aura\")) {\r\n\t\tconst template = canvas.scene?.templates.some(\r\n\t\t\t(template) => template.message === message && template.isOwner,\r\n\t\t);\r\n\t\tif (template)\r\n\t\t\tcardBtns.find(\".owner-buttons .hidden.small\").removeClass(\"hidden\");\r\n\t}\r\n\r\n\tif (!targets.length) return;\r\n\r\n\tconst rowsTemplate = $('<div class=\"pf2e-toolbelt-target-spell\"></div>');\r\n\r\n\tfor (const { template } of targets) {\r\n\t\trowsTemplate.append(\"<hr>\");\r\n\t\trowsTemplate.append(template);\r\n\t}\r\n\r\n\tmsgContent.after(rowsTemplate);\r\n\r\n\taddHeaderListeners(message, rowsTemplate, save);\r\n}\r\n\r\nfunction addTargets(event, message) {\r\n\tevent.stopPropagation();\r\n\tconst targets = game.user.targets;\r\n\r\n\tsetFlag(\r\n\t\tmessage,\r\n\t\t\"target.targets\",\r\n\t\tArray.from(\r\n\t\t\ttargets.map((target) => ({\r\n\t\t\t\ttoken: target.document.uuid,\r\n\t\t\t\tactor: target.actor.uuid,\r\n\t\t\t})),\r\n\t\t),\r\n\t);\r\n}\r\n\r\nasync function renderDamageChatMessage(message, html) {\r\n\tconst data = await getMessageData(message);\r\n\tconst msgContent = html.find(\".message-content\");\r\n\tconst damageRows = msgContent.find(\".damage-application\");\r\n\r\n\tconst buttons = $('<div class=\"pf2e-toolbelt-target-buttons\"></div>');\r\n\r\n\tif (data?.targets.length && damageRows.length) {\r\n\t\tconst toggleDamageRow = () => {\r\n\t\t\tconst expanded = !!getInMemory(message, \"target.expanded\");\r\n\t\t\ttoggleBtn.toggleClass(\"collapse\", expanded);\r\n\t\t\tdamageRows.toggleClass(\"hidden\", !expanded);\r\n\t\t};\r\n\r\n\t\tconst toggleTooltip = localize(\"target.chat.toggle.tooltip\");\r\n\t\tconst toggleBtn = $(`<button class=\"toggle\" title=\"${toggleTooltip}\">\r\n    <i class=\"fa-solid fa-plus expand\"></i>\r\n    <i class=\"fa-solid fa-minus collapse\"></i>\r\n</button>`);\r\n\r\n\t\ttoggleDamageRow();\r\n\r\n\t\ttoggleBtn.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\t\t\tsetInMemory(\r\n\t\t\t\tmessage,\r\n\t\t\t\t\"target.expanded\",\r\n\t\t\t\t!getInMemory(message, \"target.expanded\"),\r\n\t\t\t);\r\n\t\t\ttoggleDamageRow();\r\n\t\t});\r\n\r\n\t\tbuttons.append(toggleBtn);\r\n\t}\r\n\r\n\tif (data?.isRegen !== true && (game.user.isGM || message.isAuthor)) {\r\n\t\tconst targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n\t\tconst targetsBtn = $(`<button class=\"targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n\t\ttargetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n\t\tbuttons.append(targetsBtn);\r\n\t}\r\n\r\n\thtml.find(\".dice-result .dice-total\").append(buttons);\r\n\r\n\tif (!data?.targets.length) return;\r\n\r\n\tconst clonedRows = damageRows.clone();\r\n\tif (!clonedRows.length) return;\r\n\r\n\tclonedRows\r\n\t\t.removeClass(\"damage-application\")\r\n\t\t.addClass(\"target-damage-application\");\r\n\r\n\tif (getSetting(\"target-client\") !== \"big\")\r\n\t\tclonedRows.find(\"button\").addClass(\"small\");\r\n\r\n\tclonedRows.find(\"[data-action]\").each(function () {\r\n\t\tconst action = this.dataset.action;\r\n\t\tthis.dataset.action = `target-${action}`;\r\n\t});\r\n\r\n\tconst { targets, save } = data;\r\n\tconst rowsTemplate = $('<div class=\"pf2e-toolbelt-target-damage\"></div>');\r\n\r\n\tfor (const { uuid, template, save, isOwner, applied = {} } of targets) {\r\n\t\trowsTemplate.append(\"<hr>\");\r\n\t\trowsTemplate.append(template);\r\n\r\n\t\tif (!isOwner) continue;\r\n\r\n\t\tconst isBasicSave = !!(save?.result && save.basic);\r\n\t\tconst clones = clonedRows.clone();\r\n\r\n\t\tclones.each((index, el) => {\r\n\t\t\tel.dataset.rollIndex = index;\r\n\t\t\tel.dataset.targetUuid = uuid;\r\n\r\n\t\t\tel.classList.toggle(\r\n\t\t\t\t\"applied\",\r\n\t\t\t\t!!applied[index] ||\r\n\t\t\t\t\t(isBasicSave && save.result.success === \"criticalSuccess\"),\r\n\t\t\t);\r\n\t\t\tif (isBasicSave) el.classList.add(save.result.success);\r\n\t\t});\r\n\r\n\t\trowsTemplate.append(clones);\r\n\t}\r\n\r\n\tmsgContent.after(rowsTemplate);\r\n\r\n\taddHeaderListeners(message, rowsTemplate, save);\r\n\trowsTemplate\r\n\t\t.find(\"button[data-action^=target-]\")\r\n\t\t.on(\"click\", (event) => onTargetButton(event, message));\r\n}\r\n\r\nfunction addHeaderListeners(message, html, save) {\r\n\thtml.find(\"[data-action=ping-target]\").on(\"click\", pingTarget);\r\n\thtml.find(\"[data-action=open-target-sheet]\").on(\"click\", openTargetSheet);\r\n\thtml\r\n\t\t.find(\"[data-action=roll-save]\")\r\n\t\t.on(\"click\", (event) => rollSave(event, message, save));\r\n\thtml\r\n\t\t.find(\"[data-action=reroll-save]\")\r\n\t\t.on(\"click\", (event) => rerollSave(event, message, save));\r\n}\r\n\r\nasync function getMessageData(message) {\r\n\tconst isGM = game.user.isGM;\r\n\tconst targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n\tconst showDC = isGM || game.settings.get(\"pf2e\", \"metagame_showDC\");\r\n\tconst showMods = isGM || game.settings.get(\"pf2e\", \"metagame_showBreakdowns\");\r\n\tconst showSuccess = isGM || game.settings.get(\"pf2e\", \"metagame_showResults\");\r\n\r\n\tconst save = (() => {\r\n\t\tconst flag = getFlag(message, \"target.save\");\r\n\t\tif (!flag) return;\r\n\t\treturn {\r\n\t\t\t...flag,\r\n\t\t\t...SAVES[flag.statistic],\r\n\t\t};\r\n\t})();\r\n\r\n\tif (!targetsFlag.length && !save) return;\r\n\r\n\tif (save) {\r\n\t\tconst saveLabel = game.i18n.format(\"PF2E.SavingThrowWithName\", {\r\n\t\t\tsaveName: game.i18n.localize(save.label),\r\n\t\t});\r\n\t\tconst saveDC = showDC\r\n\t\t\t? localize(\"target.chat.save.dcWithValue\", { dc: save.dc })\r\n\t\t\t: \"\";\r\n\t\tsave.tooltipLabel = `${saveLabel} ${saveDC}`;\r\n\t\tsave.tooltip = await renderTemplate(templatePath(\"target/save-tooltip\"), {\r\n\t\t\tcheck: save.tooltipLabel,\r\n\t\t});\r\n\t}\r\n\r\n\tconst targets = (\r\n\t\tawait Promise.all(\r\n\t\t\ttargetsFlag.map(async ({ token }) => {\r\n\t\t\t\tconst target = await fromUuid(token);\r\n\t\t\t\tconst targetId = target.id;\r\n\t\t\t\tconst actor = target.actor;\r\n\t\t\t\tif (!actor) return;\r\n\r\n\t\t\t\tconst isVisible = !actor.hasCondition(\"undetected\");\r\n\t\t\t\tif (!isGM && !isVisible) return;\r\n\r\n\t\t\t\tconst isOwner = actor.isOwner;\r\n\t\t\t\tconst hasPlayerOwner = actor.hasPlayerOwner;\r\n\t\t\t\tconst isFriendly = isOwner || hasPlayerOwner;\r\n\t\t\t\tconst hasSave = save && !!actor?.saves[save.statistic];\r\n\r\n\t\t\t\tconst targetSave = await (async () => {\r\n\t\t\t\t\tif (!hasSave) return;\r\n\r\n\t\t\t\t\tconst flag = getFlag(message, `target.saves.${targetId}`);\r\n\t\t\t\t\tif (!flag) return;\r\n\r\n\t\t\t\t\tconst rerolled = flag.rerolled;\r\n\t\t\t\t\tconst canReroll = hasSave && isOwner && !rerolled;\r\n\t\t\t\t\tconst successLabel = game.i18n.localize(\r\n\t\t\t\t\t\t`PF2E.Check.Result.Degree.Check.${flag.success}`,\r\n\t\t\t\t\t);\r\n\t\t\t\t\tconst offset = flag.value - save.dc;\r\n\t\t\t\t\tconst result =\r\n\t\t\t\t\t\tisFriendly || showSuccess\r\n\t\t\t\t\t\t\t? localize(\r\n\t\t\t\t\t\t\t\t\t`target.chat.save.result.${\r\n\t\t\t\t\t\t\t\t\t\tshowDC\r\n\t\t\t\t\t\t\t\t\t\t\t? \"withOffset\"\r\n\t\t\t\t\t\t\t\t\t\t\t: isFriendly\r\n\t\t\t\t\t\t\t\t\t\t\t  ? \"withoutOffsetWithDie\"\r\n\t\t\t\t\t\t\t\t\t\t\t  : \"withoutOffset\"\r\n\t\t\t\t\t\t\t\t\t}`,\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\tsuccess: successLabel,\r\n\t\t\t\t\t\t\t\t\t\toffset: offset >= 0 ? `+${offset}` : offset,\r\n\t\t\t\t\t\t\t\t\t\tdie: `<i class=\"fa-solid fa-dice-d20\"></i> ${flag.die}`,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t\t\t: undefined;\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\t...flag,\r\n\t\t\t\t\t\tcanReroll,\r\n\t\t\t\t\t\ttooltip: await renderTemplate(templatePath(\"target/save-tooltip\"), {\r\n\t\t\t\t\t\t\ti18n: subLocalize(\"target.chat.save\"),\r\n\t\t\t\t\t\t\tcheck: save.tooltipLabel,\r\n\t\t\t\t\t\t\tresult,\r\n\t\t\t\t\t\t\tmodifiers: isFriendly || showMods ? flag.modifiers : [],\r\n\t\t\t\t\t\t\tcanReroll,\r\n\t\t\t\t\t\t\trerolled: REROLL[rerolled],\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t};\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tconst templateSave = save && {\r\n\t\t\t\t\t...save,\r\n\t\t\t\t\tresult: targetSave,\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst anonymous = game.modules.get(\"anonymous\");\r\n\t\t\t\tconst canSeeName = isGM\r\n\t\t\t\t\t? true\r\n\t\t\t\t\t: anonymous?.active\r\n\t\t\t\t\t  ? anonymous.api.playersSeeName(target.actor)\r\n\t\t\t\t\t  : target.playersCanSeeName;\r\n\t\t\t\tconst name = canSeeName\r\n\t\t\t\t\t? target.name\r\n\t\t\t\t\t: anonymous?.active\r\n\t\t\t\t\t  ? anonymous.api.getName(target.actor)\r\n\t\t\t\t\t  : localize(\"unnamed\");\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tisOwner,\r\n\t\t\t\t\tcanSeeName,\r\n\t\t\t\t\thasPlayerOwner,\r\n\t\t\t\t\tuuid: token,\r\n\t\t\t\t\ttarget: target,\r\n\t\t\t\t\tsave: templateSave,\r\n\t\t\t\t\tapplied: getFlag(message, `target.applied.${targetId}`),\r\n\t\t\t\t\ttemplate: await renderTemplate(templatePath(\"target/row-header\"), {\r\n\t\t\t\t\t\tname,\r\n\t\t\t\t\t\tisGM,\r\n\t\t\t\t\t\tisOwner,\r\n\t\t\t\t\t\thasPlayerOwner,\r\n\t\t\t\t\t\tisHidden: !isVisible,\r\n\t\t\t\t\t\tuuid: token,\r\n\t\t\t\t\t\tshowSuccess: isFriendly || showSuccess,\r\n\t\t\t\t\t\tsave: hasSave && templateSave,\r\n\t\t\t\t\t\tcanReroll: targetSave?.canReroll,\r\n\t\t\t\t\t\trerolled: REROLL[targetSave?.rerolled],\r\n\t\t\t\t\t\ti18n: subLocalize(\"target.chat.row\"),\r\n\t\t\t\t\t}),\r\n\t\t\t\t};\r\n\t\t\t}),\r\n\t\t)\r\n\t).filter(Boolean);\r\n\r\n\tif (isGM) {\r\n\t\ttargets.sort((a, b) => a.hasPlayerOwner - b.hasPlayerOwner);\r\n\t} else {\r\n\t\ttargets.sort((a, b) =>\r\n\t\t\t!a.isOwner && !b.isOwner\r\n\t\t\t\t? b.canSeeName - a.canSeeName\r\n\t\t\t\t: b.isOwner - a.isOwner,\r\n\t\t);\r\n\t}\r\n\r\n\treturn { targets, save, isRegen: getFlag(message, \"target.isRegen\") };\r\n}\r\n\r\nasync function getTargetFromEvent(event) {\r\n\tconst { targetUuid } =\r\n\t\tevent.currentTarget.closest(\"[data-target-uuid]\").dataset;\r\n\treturn fromUuid(targetUuid);\r\n}\r\n\r\nfunction isRollingSave(message, target) {\r\n\treturn getInMemory(message, `target.save.${target.id}`);\r\n}\r\n\r\nfunction setRollingSave(message, target) {\r\n\tsetInMemory(message, `target.save.${target.id}`, true);\r\n}\r\n\r\nasync function rerollSave(event, message, { dc }) {\r\n\tconst target = await getTargetFromEvent(event);\r\n\tconst actor = target?.actor;\r\n\tif (!actor) return;\r\n\r\n\tif (isRollingSave(message, target)) return;\r\n\r\n\tconst flag = getFlag(message, `target.saves.${target.id}`);\r\n\tif (!flag?.roll || flag.rerolled) return;\r\n\r\n\tconst heroPoints = actor.isOfType(\"character\") ? actor.heroPoints.value : 0;\r\n\r\n\tconst template = Object.entries(REROLL)\r\n\t\t.map(([type, { icon, reroll }]) => {\r\n\t\t\tif (type === \"hero\" && !heroPoints) return;\r\n\t\t\tconst label = game.i18n.localize(reroll);\r\n\t\t\treturn `<label><input type=\"radio\" name=\"reroll\" value=\"${type}\"><i class=\"${icon}\"></i> ${label}</label>`;\r\n\t\t})\r\n\t\t.filter(Boolean)\r\n\t\t.join(\"\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-rotate rotate\"></i>',\r\n\t\t\tlabel: \"reroll\",\r\n\t\t\tcallback: (html) => html.find(\"[name=reroll]:checked\").val() ?? null,\r\n\t\t},\r\n\t\tno: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n\t\t\tlabel: \"cancel\",\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst reroll = await Dialog.wait(\r\n\t\t{\r\n\t\t\ttitle: `${target.name} - ${localize(\r\n\t\t\t\t\"target.chat.save.reroll.confirm.title\",\r\n\t\t\t)}`,\r\n\t\t\tcontent: template,\r\n\t\t\tbuttons,\r\n\t\t\tclose: () => null,\r\n\t\t},\r\n\t\t{\r\n\t\t\tid: `pf2e-toolbelt-target-save-reroll-dialog-${target.id}`,\r\n\t\t},\r\n\t);\r\n\r\n\tif (!reroll) return;\r\n\r\n\tconst isHeroReroll = reroll === \"hero\";\r\n\tconst keep = isHeroReroll ? \"new\" : reroll;\r\n\r\n\tif (isHeroReroll) {\r\n\t\tconst { value, max } = actor.heroPoints;\r\n\r\n\t\tif (value < 1) {\r\n\t\t\twarn(\"target.chat.save.reroll.noPoints\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tawait actor.update({\r\n\t\t\t\"system.resources.heroPoints.value\": Math.clamped(value - 1, 0, max),\r\n\t\t});\r\n\t}\r\n\r\n\tsetRollingSave(message, target);\r\n\r\n\tconst oldRoll = Roll.fromJSON(flag.roll);\r\n\tconst unevaluatedNewRoll = oldRoll.clone();\r\n\tunevaluatedNewRoll.options.isReroll = true;\r\n\tHooks.callAll(\r\n\t\t\"pf2e.preReroll\",\r\n\t\tRoll.fromJSON(flag.roll),\r\n\t\tunevaluatedNewRoll,\r\n\t\tisHeroReroll,\r\n\t\tkeep,\r\n\t);\r\n\r\n\tconst newRoll = await unevaluatedNewRoll.evaluate({ async: true });\r\n\tawait roll3dDice(newRoll);\r\n\r\n\tHooks.callAll(\r\n\t\t\"pf2e.reroll\",\r\n\t\tRoll.fromJSON(flag.roll),\r\n\t\tnewRoll,\r\n\t\tisHeroReroll,\r\n\t\tkeep,\r\n\t);\r\n\r\n\tconst keptRoll =\r\n\t\t(keep === \"higher\" && oldRoll.total > newRoll.total) ||\r\n\t\t(keep === \"lower\" && oldRoll.total < newRoll.total)\r\n\t\t\t? oldRoll\r\n\t\t\t: newRoll;\r\n\r\n\tif (keptRoll === newRoll) {\r\n\t\tconst success = new DegreeOfSuccess(newRoll, dc, flag.dosAdjustments);\r\n\t\tkeptRoll.options.degreeOfSuccess = success.value;\r\n\t}\r\n\r\n\tconst packet = {\r\n\t\ttype: \"target.update-save\",\r\n\t\ttarget: target.id,\r\n\t\tdata: {\r\n\t\t\tvalue: keptRoll.total,\r\n\t\t\tdie: keptRoll.dice[0].total,\r\n\t\t\tsuccess: keptRoll.degreeOfSuccess,\r\n\t\t\troll: JSON.stringify(keptRoll.toJSON()),\r\n\t\t\tdosAdjustments: deepClone(flag.dosAdjustments),\r\n\t\t\tmodifiers: deepClone(flag.modifiers),\r\n\t\t\trerolled: reroll,\r\n\t\t},\r\n\t};\r\n\r\n\tif (keptRoll.options.keeleyAdd10) {\r\n\t\tpacket.data.modifiers.push({\r\n\t\t\tlabel: localize(\"target.chat.save.reroll.keeley\"),\r\n\t\t\tmodifier: 10,\r\n\t\t});\r\n\t}\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tpacket.message = message;\r\n\t\tupdateMessageSave(packet);\r\n\t} else {\r\n\t\tpacket.message = message.id;\r\n\t\tsocketEmit(packet);\r\n\t}\r\n}\r\n\r\nasync function rollSave(event, message, { dc, statistic }) {\r\n\tconst target = await getTargetFromEvent(event);\r\n\tconst actor = target?.actor;\r\n\tif (!actor) return;\r\n\r\n\tif (isRollingSave(message, target)) return;\r\n\r\n\tconst save = actor.saves[statistic];\r\n\tif (!save) return;\r\n\r\n\tsetRollingSave(message, target);\r\n\r\n\tconst item = (() => {\r\n\t\tconst item = message.item;\r\n\t\tif (item) return item;\r\n\r\n\t\tconst messageId = getFlag(message, \"target.messageId\");\r\n\t\tif (!messageId) return;\r\n\r\n\t\tconst otherMessage = game.messages.get(messageId);\r\n\t\tif (!otherMessage) return;\r\n\r\n\t\treturn otherMessage.item;\r\n\t})();\r\n\r\n\tconst skipDefault = !game.user.settings.showCheckDialogs;\r\n\r\n\tconst packet = {\r\n\t\ttype: \"target.update-save\",\r\n\t\ttarget: target.id,\r\n\t};\r\n\r\n\tsave.check.roll({\r\n\t\tdc: { value: dc },\r\n\t\titem,\r\n\t\torigin: actor,\r\n\t\tskipDialog: event.shiftKey ? !skipDefault : skipDefault,\r\n\t\tcreateMessage: false,\r\n\t\tcallback: async (roll, __, msg) => {\r\n\t\t\tawait roll3dDice(roll);\r\n\t\t\tpacket.data = {\r\n\t\t\t\tvalue: roll.total,\r\n\t\t\t\tdie: roll.dice[0].total,\r\n\t\t\t\tsuccess: roll.degreeOfSuccess,\r\n\t\t\t\troll: JSON.stringify(roll.toJSON()),\r\n\t\t\t\tdosAdjustments: msg.getFlag(\"pf2e\", \"context.dosAdjustments\"),\r\n\t\t\t\tmodifiers: msg\r\n\t\t\t\t\t.getFlag(\"pf2e\", \"modifiers\")\r\n\t\t\t\t\t.filter((modifier) => modifier.enabled)\r\n\t\t\t\t\t.map(({ label, modifier }) => ({ label, modifier })),\r\n\t\t\t};\r\n\r\n\t\t\tif (game.user.isGM || message.isAuthor) {\r\n\t\t\t\tpacket.message = message;\r\n\t\t\t\tupdateMessageSave(packet);\r\n\t\t\t} else {\r\n\t\t\t\tpacket.message = message.id;\r\n\t\t\t\tsocketEmit(packet);\r\n\t\t\t}\r\n\t\t},\r\n\t});\r\n}\r\n\r\nasync function updateMessageSave({ message, target, data }) {\r\n\tif (typeof message === \"string\") {\r\n\t\tmessage = game.messages.get(message);\r\n\t\tif (!message) return;\r\n\t}\r\n\r\n\tif (typeof data.success === \"number\") {\r\n\t\tdata.success = DEGREE_OF_SUCCESS[data.success];\r\n\t}\r\n\r\n\tawait setFlag(message, `target.saves.${target}`, deepClone(data));\r\n\tdeleteInMemory(message, `target.save.${target}`);\r\n}\r\n\r\nasync function openTargetSheet(event) {\r\n\tconst target = await getTargetFromEvent(event);\r\n\tif (!target) return;\r\n\r\n\ttarget.actor?.sheet.render(true);\r\n}\r\n\r\nasync function pingTarget(event) {\r\n\tif (!canvas.ready) return;\r\n\r\n\tconst target = await getTargetFromEvent(event);\r\n\tif (!target) return;\r\n\r\n\tcanvas.ping(target.center);\r\n}\r\n\r\nasync function onTargetButton(event, message) {\r\n\tconst btn = event.currentTarget;\r\n\tconst { rollIndex, targetUuid } = btn.closest(\"[data-target-uuid]\").dataset;\r\n\tconst target = await fromUuid(targetUuid);\r\n\tif (!target) return;\r\n\r\n\tconst type = btn.dataset.action;\r\n\r\n\tif (type === \"target-shield-block\") {\r\n\t\tonClickShieldBlock(target, btn, message.element);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst multiplier =\r\n\t\ttype === \"target-apply-healing\"\r\n\t\t\t? -1\r\n\t\t\t: type === \"target-half-damage\"\r\n\t\t\t  ? 0.5\r\n\t\t\t  : type === \"target-apply-damage\"\r\n\t\t\t\t  ? 1\r\n\t\t\t\t  : type === \"target-double-damage\"\r\n\t\t\t\t\t  ? 2\r\n\t\t\t\t\t  : 3;\r\n\r\n\tapplyDamageFromMessage(target, {\r\n\t\tmessage,\r\n\t\tmultiplier,\r\n\t\taddend: 0,\r\n\t\tpromptModifier: event.shiftKey,\r\n\t\trollIndex: Number(rollIndex),\r\n\t});\r\n}\r\n\r\nexport function onDamageApplied(message, tokenId, rollIndex) {\r\n\tconst updates = {};\r\n\tmoduleFlagUpdate(updates, `target.applied.${tokenId}.${rollIndex}`, true);\r\n\r\n\tconst splashRollIndex = getFlag(message, \"target.splashIndex\");\r\n\tif (splashRollIndex !== undefined) {\r\n\t\tconst regularRollIndex = splashRollIndex === 0 ? 1 : 0;\r\n\r\n\t\tif (rollIndex === splashRollIndex) {\r\n\t\t\tmoduleFlagUpdate(\r\n\t\t\t\tupdates,\r\n\t\t\t\t`target.applied.${tokenId}.${regularRollIndex}`,\r\n\t\t\t\ttrue,\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tmoduleFlagUpdate(\r\n\t\t\t\tupdates,\r\n\t\t\t\t`target.applied.${tokenId}.${splashRollIndex}`,\r\n\t\t\t\ttrue,\r\n\t\t\t);\r\n\r\n\t\t\tconst targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n\t\t\tfor (const target of targetsFlag) {\r\n\t\t\t\tconst targetId = target.token?.split(\".\").at(-1);\r\n\t\t\t\tif (targetId === tokenId) continue;\r\n\r\n\t\t\t\tmoduleFlagUpdate(\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t`target.applied.${targetId}.${regularRollIndex}`,\r\n\t\t\t\t\ttrue,\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tupdateMessageApplied({ message, updates });\r\n\t} else {\r\n\t\tsocketEmit({\r\n\t\t\ttype: \"target.update-applied\",\r\n\t\t\tmessage: message.id,\r\n\t\t\tupdates,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction updateMessageApplied({ message, updates }) {\r\n\tif (typeof message === \"string\") {\r\n\t\tmessage = game.messages.get(message);\r\n\t\tif (!message) return;\r\n\t}\r\n\tmessage.update(updates);\r\n}\r\n", "import { getSetting } from \"../shared/settings\";\r\n\r\nlet CREATE_HOOK = null;\r\nlet UPDATE_HOOK = null;\r\n\r\nexport function registerUnided() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"unided\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"create\", \"all\"],\r\n\t\t\t\tonChange: setHooks,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-unided\"],\r\n\t\tinit: () => {\r\n\t\t\tsetHooks();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setHooks(value) {\r\n\tconst settingValue = value ?? getSetting(\"unided\");\r\n\r\n\tif (settingValue === \"disabled\") {\r\n\t\tif (CREATE_HOOK) {\r\n\t\t\tHooks.off(\"preCreateItem\", CREATE_HOOK);\r\n\t\t\tCREATE_HOOK = null;\r\n\t\t}\r\n\t\tif (UPDATE_HOOK) {\r\n\t\t\tHooks.off(\"preUpdateItem\", UPDATE_HOOK);\r\n\t\t\tUPDATE_HOOK = null;\r\n\t\t}\r\n\t} else {\r\n\t\tif (!CREATE_HOOK) {\r\n\t\t\tCREATE_HOOK = Hooks.on(\"preCreateItem\", preCreateItem);\r\n\t\t}\r\n\t\tif (settingValue === \"all\" && !UPDATE_HOOK) {\r\n\t\t\tUPDATE_HOOK = Hooks.on(\"preUpdateItem\", preUpdateItem);\r\n\t\t} else if (settingValue !== \"all\" && UPDATE_HOOK) {\r\n\t\t\tHooks.off(\"preUpdateItem\", UPDATE_HOOK);\r\n\t\t\tUPDATE_HOOK = null;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction preCreateItem(item) {\r\n\tif (!item.img || !item.isOfType(\"physical\")) return;\r\n\titem._source.system.identification.unidentified.img = item.img;\r\n}\r\n\r\nfunction preUpdateItem(item, changes) {\r\n\tif (!item.isOfType(\"physical\") || !(\"img\" in changes)) return;\r\n\tsetProperty(changes, \"system.identification.unidentified.img\", changes.img);\r\n}\r\n", "import { createHook } from \"../shared/hook\";\r\nimport { getSetting } from \"../shared/settings\";\r\n\r\nconst setHook = createHook(\"updateCombat\", updateCombat);\r\n\r\nexport function registerUntarget() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tname: \"force-untarget\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"untarget\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup() {\r\n\tsetHook(getSetting(\"force-untarget\") || getSetting(\"untarget\"));\r\n}\r\n\r\nfunction updateCombat(_, data) {\r\n\tif (!(\"turn\" in data) && !(\"round\" in data)) return;\r\n\r\n\tconst user = game.user;\r\n\tuser.updateTokenTargets();\r\n\tuser.broadcastActivity({ targets: [] });\r\n}\r\n", "import { subLocalize } from \"../shared/localize\";\r\nimport { templatePath } from \"../shared/path\";\r\n\r\nconst localize = subLocalize(\"macros.condition\");\r\n\r\nexport async function permaConditionEffect(actor) {\r\n\tconst callback = (html, type) => {\r\n\t\tconst condition = html.find(\"[name=condition]\");\r\n\t\tconst { name, slug, img } = condition.find(\":selected\").data();\r\n\r\n\t\treturn {\r\n\t\t\ttype,\r\n\t\t\tslug,\r\n\t\t\timg,\r\n\t\t\tname:\r\n\t\t\t\thtml.find(\"[name=name]\").val().trim() ||\r\n\t\t\t\tlocalize(\"effect-name\", { condition: name }),\r\n\t\t\tuuid: condition.val(),\r\n\t\t\tbadge: Number(html.find(\"[name=badge]\").val() || 1),\r\n\t\t\tunidentified: html.find(\"[name=unidentified]\").prop(\"checked\"),\r\n\t\t};\r\n\t};\r\n\r\n\tconst buttons = {\r\n\t\tgenerate: {\r\n\t\t\ticon: '<i class=\"fas fa-suitcase\"></i>',\r\n\t\t\tlabel: localize(\"generate\"),\r\n\t\t\tcallback: (html) => callback(html, \"generate\"),\r\n\t\t},\r\n\t\tadd: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-user\"></i>',\r\n\t\t\tlabel: localize(\"add\"),\r\n\t\t\tcallback: (html) => callback(html, \"add\"),\r\n\t\t},\r\n\t};\r\n\r\n\tconst conditions = Array.from(game.pf2e.ConditionManager.conditions.values());\r\n\tconst withBadge = new Set(\r\n\t\tconditions\r\n\t\t\t.filter((condition) => !!condition.badge)\r\n\t\t\t.map((condition) => condition.slug),\r\n\t);\r\n\r\n\tconst content = await renderTemplate(templatePath(\"macros/condition\"), {\r\n\t\ti18n: localize,\r\n\t\tconditions: Array.from(\r\n\t\t\tnew Set(conditions.sort((a, b) => a.name.localeCompare(b.name))),\r\n\t\t),\r\n\t});\r\n\r\n\tconst setInputs = (html) => {\r\n\t\tconst { name, slug } = html.find(\"[name=condition] :selected\").data();\r\n\t\thtml\r\n\t\t\t.find(\"[name=name]\")\r\n\t\t\t.prop(\"placeholder\", localize(\"effect-name\", { condition: name }));\r\n\r\n\t\tconst hasBadge = withBadge.has(slug);\r\n\t\tconst badge = html.find(\"[name=badge]\");\r\n\t\tbadge.prop(\"disabled\", !hasBadge);\r\n\t\tif (!hasBadge) badge.val(1);\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(\r\n\t\t{\r\n\t\t\tbuttons,\r\n\t\t\tcontent,\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tclose: () => null,\r\n\t\t\trender: (html) => {\r\n\t\t\t\tsetInputs(html);\r\n\t\t\t\thtml.find(\"[name=condition]\").on(\"change\", () => setInputs(html));\r\n\t\t\t},\r\n\t\t},\r\n\t\t{\r\n\t\t\tid: \"pf2e-toolbelt-macros-condition\",\r\n\t\t\twidth: 320,\r\n\t\t},\r\n\t);\r\n\r\n\tif (!result) return;\r\n\r\n\tconst rule = {\r\n\t\tinMemoryOnly: true,\r\n\t\tkey: \"GrantItem\",\r\n\t\tuuid: result.uuid,\r\n\t};\r\n\r\n\tif (result.badge > 1 && withBadge.has(result.slug)) {\r\n\t\trule.alterations = [\r\n\t\t\t{\r\n\t\t\t\tmode: \"override\",\r\n\t\t\t\tproperty: \"badge-value\",\r\n\t\t\t\tvalue: result.badge,\r\n\t\t\t},\r\n\t\t];\r\n\t}\r\n\r\n\tconst source = {\r\n\t\tname: result.name,\r\n\t\ttype: \"effect\",\r\n\t\timg: result.img,\r\n\t\tsystem: {\r\n\t\t\trules: [rule],\r\n\t\t\tunidentified: result.unidentified,\r\n\t\t},\r\n\t};\r\n\r\n\tif (result.type === \"generate\" || !actor) await Item.create(source);\r\n\telse await actor.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n", "import { registerArp } from \"./features/arp\";\r\nimport { registerDebug } from \"./features/debug\";\r\nimport { registerEffectsPanelHelper } from \"./features/effects\";\r\nimport { registerGiveth } from \"./features/giveth\";\r\nimport { registerHeroActions } from \"./features/hero\";\r\nimport { registerInventory } from \"./features/inventory\";\r\nimport { registerKnowledges } from \"./features/knowledges\";\r\nimport { registerMerge } from \"./features/merge\";\r\nimport { registerNobulk } from \"./features/nobulk\";\r\nimport { registerShare } from \"./features/share\";\r\nimport { registerStances } from \"./features/stances\";\r\nimport { registerSpellsSummary } from \"./features/summary\";\r\nimport { registerTargetTokenHelper } from \"./features/target\";\r\nimport { registerUnided } from \"./features/unided\";\r\nimport { registerUntarget } from \"./features/untarget\";\r\nimport { permaConditionEffect } from \"./macros/condition\";\r\nimport { MODULE_ID } from \"./module\";\r\nimport { localize } from \"./shared/localize\";\r\nimport { warn } from \"./shared/notification\";\r\nimport { isUserGM } from \"./shared/user\";\r\n\r\nconst FEATURES = [\r\n\tregisterArp(),\r\n\tregisterNobulk(),\r\n\tregisterGiveth(),\r\n\tregisterKnowledges(),\r\n\tregisterUnided(),\r\n\tregisterMerge(),\r\n\tregisterEffectsPanelHelper(),\r\n\tregisterSpellsSummary(),\r\n\tregisterStances(),\r\n\tregisterHeroActions(),\r\n\tregisterShare(),\r\n\tregisterTargetTokenHelper(),\r\n\tregisterUntarget(),\r\n\tregisterInventory(),\r\n\tregisterDebug(),\r\n];\r\n\r\nconst CONFLICTS = new Set();\r\n\r\nlet firstClientSetting = null;\r\n\r\nHooks.once(\"init\", () => {\r\n\tconst isGM = isUserGM();\r\n\r\n\tconst settings = FEATURES.flatMap(({ settings = [] }) =>\r\n\t\tsettings.map((setting) => {\r\n\t\t\tconst key = setting.name;\r\n\r\n\t\t\tif (setting.choices) {\r\n\t\t\t\tsetting.choices = setting.choices.reduce((choices, choice) => {\r\n\t\t\t\t\tchoices[choice] = settingPath(key, `choices.${choice}`);\r\n\t\t\t\t\treturn choices;\r\n\t\t\t\t}, {});\r\n\t\t\t}\r\n\r\n\t\t\tsetting.key = key;\r\n\t\t\tsetting.scope ??= \"world\";\r\n\t\t\tsetting.config ??= true;\r\n\t\t\tsetting.name = settingPath(key, \"name\");\r\n\t\t\tsetting.hint = settingPath(key, \"hint\");\r\n\r\n\t\t\treturn setting;\r\n\t\t}),\r\n\t);\r\n\r\n\tconst [worldSettings, clientSettings] = [\"world\", \"client\"].map((scope) =>\r\n\t\tsettings.filter((settings) => settings.scope === scope),\r\n\t);\r\n\r\n\tfor (const setting of [worldSettings, clientSettings].flat()) {\r\n\t\tgame.settings.register(MODULE_ID, setting.key, setting);\r\n\t}\r\n\r\n\tif (isGM) {\r\n\t\tfirstClientSetting = clientSettings[0].key;\r\n\t\tHooks.on(\"renderSettingsConfig\", renderSettingsConfig);\r\n\t}\r\n\r\n\tconst module = game.modules.get(MODULE_ID);\r\n\tmodule.api = {\r\n\t\tmacros: {\r\n\t\t\tpermaConditionEffect,\r\n\t\t},\r\n\t};\r\n\r\n\tfor (const feature of FEATURES) {\r\n\t\tconst { init, conflicts = [], api, name } = feature;\r\n\r\n\t\tif (isGM) {\r\n\t\t\tfor (const id of conflicts) {\r\n\t\t\t\tconst conflictingModule = game.modules.get(id);\r\n\t\t\t\tif (conflictingModule?.active) {\r\n\t\t\t\t\tfeature.conflicting = true;\r\n\t\t\t\t\tCONFLICTS.add(conflictingModule.title);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (api && name) module.api[name] = api;\r\n\r\n\t\tif (!feature.conflicting && init) init(isGM);\r\n\t}\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n\tconst isGM = game.user.isGM;\r\n\r\n\tfor (const { conflicting, ready } of FEATURES) {\r\n\t\tif (!conflicting && ready) ready(isGM);\r\n\t}\r\n\r\n\tif (isGM) {\r\n\t\tfor (const conflict of CONFLICTS) {\r\n\t\t\twarn(\"module-conflict\", { name: conflict }, true);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nfunction settingPath(setting, key) {\r\n\treturn `${MODULE_ID}.settings.${setting}.${key}`;\r\n}\r\n\r\nfunction renderSettingsConfig(_, html) {\r\n\tif (!firstClientSetting) return;\r\n\r\n\tconst group = html.find(\r\n\t\t`.tab[data-tab=${MODULE_ID}] [data-setting-id=\"${MODULE_ID}.${firstClientSetting}\"]`,\r\n\t);\r\n\tgroup.before(`<h3>${localize(\"settings.client\")}</h3>`);\r\n}\r\n"],
  "mappings": "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",
  "names": ["HANDWRAPS_SLUG", "getSourceId", "doc", "__name", "includesSourceId", "list", "sourceId", "getItemSourceIdCondition", "item", "getItems", "actor", "itemTypes", "types", "type", "hasItemWithSourceId", "getItemWithSourceId", "canBeInvested", "hasWornSlot", "isWornAs", "isInvestedOrWornAs", "isHandwrapsOfMightyBlows", "isHeld", "isTwoHanded", "isOneHanded", "inSlotValue", "value", "usage", "toggleInvestedValue", "invest", "itemCarryUpdate", "carryType", "handsHeld", "inSlot", "invested", "containerId", "update", "MODULE_ID", "registerWrapper", "path", "callback", "type", "MODULE_ID", "__name", "unregisterWrapper", "id", "wrapperError", "feature", "localize", "args", "key", "data", "MODULE_ID", "__name", "hasLocalization", "localizePath", "subLocalize", "subKey", "fn", "warn", "info", "error", "hash", "notify", "str", "arg1", "arg2", "arg3", "type", "data", "permanent", "localize", "__name", "warn", "args", "info", "error", "getSetting", "setting", "MODULE_ID", "__name", "setSetting", "key", "value", "choiceSettingIsEnabled", "PREPARE_WEAPON_DATA", "PREPARE_WEAPON_DERIVED_DATA", "PREPARE_ARMOR_DATA", "PREPARE_ARMOR_DERIVED_DATA", "registerArp", "setting", "getSetting", "registerWrapper", "onPrepareWeaponData", "onPrepareWeaponDerivedData", "onPrepareArmorData", "onPrepareArmorDerivedData", "renderPhysicalItemSheetPF2e", "isGM", "choiceSettingIsEnabled", "info", "__name", "isValidActor", "actor", "isCharacter", "WEAPON_POTENCY_PRICE", "WEAPON_STRIKING_PRICE", "isShieldWeapon", "weapon", "isValidWeapon", "traits", "group", "category", "slug", "HANDWRAPS_SLUG", "wrapped", "level", "forceUpdate", "expectedPotency", "expectedStriking", "wrapperError", "coins", "potency", "striking", "ARMOR_POTENCY_PRICE", "ARMOR_RESILIENCY_PRICE", "isValidArmor", "armor", "expectedResilient", "resiliency", "sheet", "html", "item", "lookups", "x", "createHook", "event", "listener", "callback", "HOOK", "value", "otherSettings", "skipCallback", "settingValue", "s", "getSetting", "__name", "createChoicesHook", "registerUpstreamHook", "hook", "fn", "id", "index", "x", "hooked", "appHook", "createHook", "onRender", "actorHook", "itemHook", "registerDebug", "value", "setup", "__name", "enabled", "getSetting", "app", "html", "link", "event", "obj", "type", "variable", "setHook", "createHook", "renderEffectsPanel", "refreshEffectsPanel", "registerEffectsPanelHelper", "value", "__name", "panel", "html", "removeRow", "localize", "editIcon", "effectPanels", "effectPanel", "id", "effect", "getSetting", "event", "onRemoveEffect", "h1", "onConditionSheet", "getEffect", "MoveLootPopup", "__name", "object", "options", "callback", "prompt", "buttonLabel", "_event", "formData", "localeCompare", "a", "b", "__name", "refreshCharacterSheets", "actor", "win", "winActor", "compareArrays", "arr1", "arr2", "clonedArr2", "arr1Value", "index", "arr2Value", "ordinalString", "value", "pluralRules", "suffix", "isInstanceOf", "obj", "name", "cursor", "setInMemory", "doc", "key", "MODULE_ID", "getInMemory", "deleteInMemory", "split", "last", "calculateDistanceBetweenPoints", "x1", "y1", "x2", "y2", "x", "y", "getElementIndex", "el", "indexIsValid", "templatePath", "path", "pathStr", "x", "MODULE_ID", "__name", "registered", "CHARACTER_SHEET_INNER_RENDER", "CHARACTER_SHEET_RENDER", "CHARACTER_SHEET_ACTIVE_LISTENERS", "isPlayedActor", "actor", "__name", "registerCharacterSheetExtraTab", "options", "registerWrapper", "characterSheetRender", "characterSheetInnerRender", "characterSheetActiveListeners", "unregisterCharacterSheetExtraTab", "tabName", "wrapperId", "unregisterWrapper", "wrapped", "args", "positions", "existingAlternate", "getCharacterSheetTab", "alternate", "data", "inner", "element", "getData", "templateFolder", "onRender", "innerTab", "tabData", "template", "templatePath", "getInMemory", "addEvents", "event", "onCharacterSheetTabBtnToggle", "tab", "html", "sheet", "setInMemory", "getFlag", "doc", "key", "fallback", "MODULE_ID", "__name", "setFlag", "value", "unsetFlag", "updateSourceFlag", "doc", "key", "value", "MODULE_ID", "__name", "moduleFlagUpdate", "update", "getChatMessageClass", "__name", "latestChatMessages", "nb", "fromMessage", "chat", "messages", "start", "m", "i", "message", "html", "chatUUID", "uuid", "label", "fake", "bindOnPreCreateSpellDamageChatMessage", "originalMessage", "messageId", "save", "getFlag", "updateSourceFlag", "socketOn", "callback", "MODULE_ID", "__name", "socketOff", "socketEmit", "packet", "isActiveGM", "__name", "isUserGM", "user", "x", "isGMOnline", "getCharacterOwner", "actor", "connected", "getActiveOwner", "doc", "activeOwners", "a", "b", "isActiveOwner", "getOwner", "enabled", "CANVAS_HOOK", "registerGiveth", "setup", "isGM", "getSetting", "__name", "value", "socketOff", "onSocket", "socketOn", "registerUpstreamHook", "onDropCanvasData", "packet", "isActiveGM", "takethCondition", "takethEffect", "takethPhysical", "canvas", "data", "isGMOnline", "details", "getDetailsFromData", "target", "token", "isValidActor", "maximumX", "maximumY", "b", "giveth", "origin", "item", "ownerId", "targetId", "isIndex", "qty", "warn", "sendPhysicalRequest", "MoveLootPopup", "stack", "uuid", "socketEmit", "itemId", "actor", "id", "isPlayedActor", "actorUUID", "source", "owner", "newQty", "newItem", "content", "chatUUID", "localize", "localize", "subLocalize", "Trade", "__name", "actor", "templatePath", "value", "options", "x", "getHeroActions", "html", "#onChangeTarget", "#onDescription", "#onSendTrade", "force", "action", "target", "user", "getCharacterOwner", "getOwner", "sendTradeRequest", "event", "uuid", "id", "MODULE_ID", "setHook", "createHook", "renderCharacterSheetPF2e", "setupSocket", "JOURNAL_UUID", "TABLE_UUID", "TABLE_ICON", "SOCKET", "registerHeroActions", "value", "refreshCharacterSheets", "createTable", "removeHeroActions", "getHeroActions", "useHeroAction", "getHeroActionDetails", "drawHeroAction", "drawHeroActions", "sendActionToChat", "discardHeroActions", "tradeHeroAction", "getDeckTable", "giveHeroActions", "createChatMessage", "__name", "socketOn", "onSocket", "socketOff", "packet", "onTradeRejected", "isActiveGM", "onTradeAccepted", "onTradeRequest", "onTradeError", "sheet", "html", "actor", "isPlayedActor", "addActionsToSheet", "addSheetEvents", "actions", "diff", "isOwner", "localize", "subLocalize", "template", "templatePath", "getSetting", "key", "hash", "list", "event", "onClickHeroActionsDraw", "onClickHeroActionExpand", "onClickHeroActionUse", "onClickHeroActionDisplay", "onClickHeroActionDiscard", "onClickHeroActionsDiscard", "uuids", "x", "action", "toDiscard", "$discarded", "uuid", "setHeroActions", "summary", "details", "text", "document", "parent", "page", "warn", "nb", "drawn", "i", "label", "secret", "content", "size", "chatActions", "data", "links", "name", "chatUUID", "Trade", "table", "r", "draw", "documentUuidFromTableResult", "getLabelfromTableResult", "points", "index", "error", "actionsUUIDS", "removed", "result", "getTableFromUuid", "getDefaultCompendiumTable", "getDefaultWorldTable", "getCustomTable", "sendTradeRequest", "trade", "acceptRequest", "socketEmit", "sender", "receiver", "senderActor", "receiverActor", "sendTradeError", "senderActions", "receiverActions", "senderActionIndex", "receiverActionIndex", "senderAction", "receiverAction", "sentLink", "receivedLink", "users", "err", "rejectRequest", "buttons", "type", "unique", "createDefaultTable", "createCustomTable", "createCustomActionsTable", "setTable", "source", "getTableSource", "update", "createDefautActionsTable", "normalize", "setSetting", "removeActionsToggleAll", "removeActionsToggleActor", "actors", "state", "checked", "all", "templateLocalize", "isUnique", "actionsList", "el", "selected", "asDrawn", "withMessage", "tableUpdates", "dragData", "DRAG_ID", "cleanOptions", "options", "filters", "type", "keys", "key", "option", "__name", "makeDraggable", "i", "droppable", "event", "onMouseDown", "onDragCancel", "cleanUp", "onDragEnd", "onMouseMove", "onMouseUp", "classList", "target", "closestInside", "_ghost", "targetIndex", "getElementIndex", "targetParent", "targetClassList", "newClassList", "element", "index", "child", "onDragMove", "clientX", "clientY", "draggable", "calculateDistanceBetweenPoints", "onDragStart", "dropped", "hovered", "img", "cursorElement", "offsetX", "offsetY", "value", "enabled", "parent", "selector", "filter", "cursor", "closeHook", "createHook", "closeCharacterSheetPF2e", "dragging", "registerInventory", "value", "setup", "isGm", "__name", "dragIdentifier", "COINS", "enabled", "getSetting", "registerCharacterSheetExtraTab", "getData", "addEvents", "onRender", "unregisterCharacterSheetExtraTab", "sheet", "html", "actor", "isPlayedActor", "getInMemory", "tab", "getCharacterSheetTab", "data", "getCurrentData", "setFlag", "inner", "sidebar", "tabElement", "alternate", "equipped", "equippedItemId", "slot", "itemIds", "parent", "ids", "items", "i", "item", "tabs", "tabId", "flags", "getFlag", "setInMemory", "orphans", "containers", "getTab", "itemId", "addOrphan", "handsHeld", "equippedHands", "handIndex", "indexIsValid", "isHandwrapsOfMightyBlows", "isInvestedOrWornAs", "equippedIndex", "index", "tabOrphans", "otherIndex", "grouped", "activeTabId", "container", "capacity", "containerTabs", "event", "itemElements", "itemElement", "onItemDetails", "makeDraggable", "target", "createGhost", "onDragStart", "draggable", "options", "onDragEnd", "containersDroppable", "otherEquipmentDroppable", "largeEquipmentDroppable", "itemsListDroppable", "itemsGridDroppable", "details", "getItemFromElement", "templatePath", "dropped", "canceled", "dragged", "draggedIndex", "checkIdentifier", "error", "onDragEnter", "droppable", "ghost", "getElementIndex", "onDragLeave", "parentGrid", "closestInside", "onDrop", "updates", "cleanContainerItem", "moveItemToContainer", "checkForTwoHandedSlots", "rightHand", "canDrop", "moveItemToSlot", "element", "drop", "noTwoHand", "noUpdate", "dropSlot", "movable", "isOneHand", "isOneHanded", "isTwoHand", "isTwoHanded", "canInvest", "canBeInvested", "move", "carryType", "inSlot", "invested", "itemCarryUpdate", "isHeld", "getSlottedItem", "slotted", "dragArea", "dragSlot", "otherSlotted", "canEquip", "hasWornSlot", "containerId", "remaining", "targetIsElement", "leftHand", "leftSlotted", "rightSlotted", "clone", "el", "id", "localize", "subLocalize", "EditLores", "__name", "templatePath", "options", "actor", "getFlag", "event", "unspecified", "specific", "setFlag", "html", "#onCancel", "setHook", "createHook", "renderNPCSheetPF2e", "registerKnowledges", "value", "isGM", "getSetting", "__name", "sheet", "$html", "actor", "isPlayedActor", "replaceLores", "addEditButton", "addEvents", "knowledgeSelector", "html", "section", "selector", "editLores", "EditLores", "unspecifics", "getFlag", "specifics", "lores", "body", "tag", "skills", "dc", "adjustment", "addTags", "start", "tags", "lore", "attempts", "edit", "localize", "subLocalize", "MultiCast", "__name", "#message", "#event", "event", "message", "options", "templatePath", "html", "#onCast", "#onCancel", "nb", "spell", "actor", "updateSource", "damages", "heightening", "id", "damage", "i", "newId", "data", "embeddedSource", "newSpell", "overlayIds", "castRank", "spellSource", "bindOnPreCreateSpellDamageChatMessage", "getDamageRollClass", "Roll", "__name", "setHook", "createHook", "renderChatMessage", "updateMessages", "registerMerge", "value", "isGm", "__name", "message", "html", "latestChatMessages", "getSetting", "isDamageRoll", "renderDamage", "renderSpell", "spellBtn", "localize", "event", "MultiCast", "buttons", "getFlag", "tooltip", "actorUUID", "getActorUUID", "targetUUIDs", "getTargetUUIDs", "otherMessage", "otherTargetsUUIDS", "compareArrays", "t", "mergeDamages", "warn", "splitDamages", "sources", "data", "removeChatMessages", "getChatMessageClass", "origin", "other", "dataGroups", "getMessageData", "name", "notes", "outcome", "modifiers", "tags", "note", "result", "groups", "group", "flavor", "templatePath", "originRolls", "getMessageRolls", "otherRolls", "groupedRolls", "roll", "options", "total", "terms", "term", "formula", "critRule", "DamageRoll", "getDamageRollClass", "index", "prev", "curr", "createTermGroup", "acc", "setHidden", "operands", "operand", "r", "MODULE_ID", "entry", "flags", "source", "title", "text", "option", "ids", "joinedIds", "id", "targetTargets", "mergeTargets", "ACTOR_PREPARE_EMBEDDED_DOCUMENTS", "TREASURE_PREPARE_BASE_DATA", "registerNobulk", "getSetting", "registerWrapper", "actorPrepareEmbeddedDocuments", "treasurePrepareBaseData", "__name", "wrapped", "wrapperError", "args", "InventoryBulk", "_value", "item", "ACTOR_PREPARE_DATA", "DOCUMENT_SHEET_RENDER_INNER", "registerShare", "getSetting", "registerWrapper", "prepareData", "documentSheetRenderInner", "preUpdateActor", "deleteActor", "updateActor", "__name", "wrapped", "args", "inner", "isInstanceOf", "actor", "isPlayedActor", "getSlaves", "masters", "a", "isValidMaster", "group", "templatePath", "getFlag", "MODULE_ID", "subLocalize", "removeSlaveFromMaster", "slaves", "slave", "unsetMaster", "unsetFlag", "updates", "shareFlag", "master", "hpSource", "getMaster", "hpUpdate", "options", "userId", "isOriginalUser", "getShareFlag", "setMaster", "addSlaveToMaster", "data", "refreshActor", "setFlag", "masterId", "hp", "masterHp", "transfertHpData", "from", "to", "doc", "getModuleProperty", "setModuleProperty", "deleteModuleProperty", "path", "value", "setSheetHook", "createHook", "renderCharacterSheetPF2e", "setDeleteCombatHook", "deleteCombat", "setDeleteCombatantHook", "deleteCombatant", "setCreateCombatantHook", "createCombatant", "STANCE_SAVANT", "REPLACERS", "EXTRAS", "registerStances", "setup", "getStances", "toggleStance", "isValidStance", "isGm", "getSetting", "__name", "value", "stance", "actor", "stances", "replaced", "replace", "sourceId", "effectUUID", "effect", "img", "name", "itemName", "action", "actorStances", "foundAction", "getItemWithSourceId", "uuid", "sheet", "html", "isPlayedActor", "inCombat", "token", "tab", "options", "template", "templatePath", "subLocalize", "event", "onToggleStance", "target", "canUseStances", "feat", "replacer", "extra", "getStancesEffects", "effects", "already", "create", "other", "more", "x", "addStance", "obj", "combat", "combatant", "getActorFromCombatant", "isActiveOwner", "refreshCharacterSheets", "checkForSavant", "effectID", "hasItemWithSourceId", "info", "openStancesMenu", "localize", "ErrorPF2e", "message", "__name", "intlNumberFormat", "signedInteger", "value", "emptyStringZero", "zeroIsNegative", "maybeNegativeZero", "spellSlotGroupIdToNumber", "groupId", "numericValue", "registerSpellsSummary", "value", "setup", "isGm", "__name", "getSetting", "registerCharacterSheetExtraTab", "getData", "addEvents", "unregisterCharacterSheetExtraTab", "html", "sheet", "actor", "inputs", "event", "onUsesInputChange", "onUsesInputFocus", "onUsesInputBlur", "onToggleFocusPool", "onSlotsReset", "onItemToChat", "inputPath", "entryId", "change", "points", "onChargesReset", "getSpellcastingTab", "dailies", "entry", "itemId", "rank", "isCharge", "item", "max", "slotLevel", "slot", "castRank", "collection", "focusPool", "pf2eStavesActive", "pf2eDailies", "pf2eDailiesActive", "stavesActive", "chargesPath", "spells", "focuses", "rituals", "hasFocusCantrips", "entries", "data", "slotId", "spell", "entryDc", "entryName", "isFocus", "isInnate", "isPrepared", "isSpontaneous", "isFlexible", "consumable", "charges", "dailiesData", "canPayCost", "group", "slotSpells", "isCantrip", "groupNumber", "spellSlotGroupIdToNumber", "isBroken", "active", "expended", "virtual", "uses", "MODULE_ID", "sort", "a", "b", "localeCompare", "subLocalize", "ordinalString", "roll3dDice", "roll", "user", "synchronize", "__name", "applyStackingRules", "modifiers", "total", "highestBonus", "lowestPenalty", "abilityModifiers", "m", "bestAbility", "best", "modifier", "applyStacking", "__name", "isBetter", "existing", "htmlQuery", "parent", "selectors", "__name", "extractEphemeralEffects", "affects", "origin", "target", "item", "domains", "options", "effectsFrom", "effectsTo", "fullOptions", "resolvables", "s", "d", "e", "__name", "extractNotes", "rollNotes", "selectors", "n", "extractDamageDice", "deferredDice", "extractModifiers", "synthetics", "modifierAdjustments", "syntheticModifiers", "modifiers", "modifier", "extractModifierAdjustments", "adjustmentsRecord", "slug", "applyDamageFromMessage", "token", "message", "multiplier", "addend", "promptModifier", "rollIndex", "shiftAdjustDamage", "tokens", "shieldBlockRequest", "roll", "isInstanceOf", "ErrorPF2e", "damage", "messageRollOptions", "originRollOptions", "o", "messageItem", "domain", "ephemeralEffects", "extractEphemeralEffects", "contextClone", "applicationRollOptions", "outcome", "breakdown", "rolls", "critical", "resolvables", "damageDice", "extractDamageDice", "d", "dice", "formula", "previous", "current", "modifiers", "extractModifiers", "m", "applyStackingRules", "signedInteger", "notes", "extractNotes", "n", "toggleOffShieldBlock", "onDamageApplied", "__name", "onClickShieldBlock", "target", "shieldButton", "messageEl", "getTokens", "getNonBrokenShields", "s", "htmlQuery", "nonBrokenShields", "hasMultipleShields", "shieldActivated", "instance", "_helper", "contentEl", "multipleShields", "listEl", "shieldList", "shield", "input", "shieldName", "hardness", "hardnessLabel", "itemLi", "messageId", "app", "selector", "content", "AdjustmentDialog", "$html", "isHealing", "$dialog", "adjustment", "DEGREE_ADJUSTMENT_AMOUNTS", "DEGREE_OF_SUCCESS_STRINGS", "DegreeOfSuccess", "_DegreeOfSuccess", "__name", "roll", "dc", "dosAdjustments", "t", "d", "#calculateDegreeOfSuccess", "#getDegreeAdjustment", "#adjustDegreeOfSuccess", "degree", "adjustments", "outcome", "label", "amount", "degreeOfSuccess", "#adjustDegreeByDieValue", "getTemplateTokens", "measuredTemplate", "collisionOrigin", "collisionType", "template", "grid", "dimensions", "gridHighlight", "origin", "tokens", "gridSize", "containedTokens", "token", "tokenDoc", "tokenPositions", "h", "tokenX", "y", "w", "position", "gx", "gy", "s", "destination", "__name", "SAVES", "REROLL", "DEGREE_OF_SUCCESS", "setPrecreateMessageHook", "createHook", "preCreateChatMessage", "setRenderMessageHook", "createChoicesHook", "renderChatMessage", "setCreateTemplateHook", "createMeasuredTemplate", "SOCKET", "registerTargetTokenHelper", "setHooks", "value", "getSetting", "message", "html", "latestChatMessages", "__name", "isUserGM", "socketOn", "onSocket", "socketOff", "packet", "isActiveGM", "updateMessageSave", "updateMessageApplied", "template", "_", "userId", "user", "localize", "subLocalize", "item", "actor", "self", "data", "templatePath", "result", "alliance", "opposition", "targetsIds", "getTemplateTokens", "token", "targetAlliance", "HEALINGS_REGEX", "isRegenMessage", "healings", "isValidDamageMessage", "isDamageRoll", "updates", "getFlag", "isRegen", "targets", "target", "rolls", "roll", "splashRollIndex", "regularRollIndex", "modifier", "save", "dc", "updateSourceFlag", "acc", "key", "clientEnabled", "choiceSettingIsEnabled", "renderDamageChatMessage", "refreshMessage", "renderSpellChatMessage", "bindOnPreCreateSpellDamageChatMessage", "chat", "el", "app", "spell", "getMessageData", "msgContent", "cardBtns", "saveBtn", "wrapper", "targetsTooltip", "targetsBtn", "event", "addTargets", "rowsTemplate", "addHeaderListeners", "setFlag", "damageRows", "buttons", "toggleDamageRow", "expanded", "getInMemory", "toggleBtn", "toggleTooltip", "setInMemory", "clonedRows", "action", "uuid", "isOwner", "applied", "isBasicSave", "clones", "index", "onTargetButton", "pingTarget", "openTargetSheet", "rollSave", "rerollSave", "isGM", "targetsFlag", "showDC", "showMods", "showSuccess", "flag", "saveLabel", "saveDC", "targetId", "isVisible", "hasPlayerOwner", "isFriendly", "hasSave", "targetSave", "rerolled", "canReroll", "successLabel", "offset", "templateSave", "anonymous", "canSeeName", "name", "a", "b", "getTargetFromEvent", "targetUuid", "isRollingSave", "setRollingSave", "heroPoints", "type", "icon", "reroll", "label", "isHeroReroll", "keep", "max", "warn", "oldRoll", "unevaluatedNewRoll", "newRoll", "roll3dDice", "keptRoll", "success", "DegreeOfSuccess", "socketEmit", "statistic", "messageId", "otherMessage", "skipDefault", "__", "msg", "deleteInMemory", "btn", "rollIndex", "onClickShieldBlock", "applyDamageFromMessage", "onDamageApplied", "tokenId", "moduleFlagUpdate", "CREATE_HOOK", "UPDATE_HOOK", "registerUnided", "setHooks", "__name", "value", "settingValue", "getSetting", "preCreateItem", "preUpdateItem", "item", "changes", "setHook", "createHook", "updateCombat", "registerUntarget", "setup", "__name", "getSetting", "_", "data", "user", "localize", "subLocalize", "permaConditionEffect", "actor", "callback", "__name", "html", "type", "condition", "name", "slug", "img", "buttons", "conditions", "withBadge", "content", "templatePath", "a", "b", "setInputs", "hasBadge", "badge", "result", "rule", "source", "FEATURES", "registerArp", "registerNobulk", "registerGiveth", "registerKnowledges", "registerUnided", "registerMerge", "registerEffectsPanelHelper", "registerSpellsSummary", "registerStances", "registerHeroActions", "registerShare", "registerTargetTokenHelper", "registerUntarget", "registerInventory", "registerDebug", "CONFLICTS", "firstClientSetting", "isGM", "isUserGM", "settings", "setting", "key", "choices", "choice", "settingPath", "worldSettings", "clientSettings", "scope", "MODULE_ID", "renderSettingsConfig", "module", "permaConditionEffect", "feature", "init", "conflicts", "api", "name", "id", "conflictingModule", "conflicting", "ready", "conflict", "warn", "__name", "_", "html", "localize"]
}
