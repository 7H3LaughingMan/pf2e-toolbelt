{
  "version": 3,
  "sources": ["../../../../../dev/module-api/foundry/actor.js", "../../../../../dev/module-api/foundry/application.js", "../../../../../dev/module-api/foundry/chat.js", "../../../../../dev/module-api/foundry/document.js", "../../../../../dev/module-api/utils/array.js", "../../../../../dev/module-api/utils/html.js", "../../../../../dev/module-api/utils/math.js", "../../../../../dev/module-api/utils/object.js", "../../../../../dev/module-api/utils/string.js", "../../../../../dev/module-api/foundry/flags.js", "../../../../../dev/module-api/foundry/handlebars.js", "../../../../../dev/module-api/foundry/hooks.js", "../../../../../dev/module-api/foundry/item.js", "../../../../../dev/module-api/foundry/libwrapper.js", "../../../../../dev/module-api/foundry/localize.js", "../../../../../dev/module-api/foundry/module.js", "../../../../../dev/module-api/foundry/notifications.js", "../../../../../dev/module-api/foundry/settings.js", "../../../../../dev/module-api/foundry/socket.js", "../../../../../dev/module-api/foundry/user.js", "../../../../../dev/module-api/pf2e/browser.js", "../../../../../dev/module-api/pf2e/html.js", "../../../../../dev/module-api/pf2e/misc.js", "../../../../../dev/module-api/pf2e/rules.js", "../../../../../dev/module-api/pf2e/chat.js", "../../../../../dev/module-api/pf2e/classes.js", "../../../../../dev/module-api/pf2e/dc.js", "../../../../../dev/module-api/pf2e/spell.js", "../../../../../dev/module-api/pf2e/identify.js", "../../../../../dev/module-api/pf2e/inline-roll.js", "../../../../../dev/module-api/pf2e/item.js", "../../../../../dev/module-api/pf2e/success.js", "../../../../../dev/module-api/pf2e/template.js", "../src/misc.js", "../src/features/arp.js", "../src/tool.js", "../src/features/debug.js", "../src/features/effects.js", "../src/actor-sheet.js", "../src/features/giveth.js", "../src/apps/hero/trade.js", "../src/features/hero.js", "../src/draggable.js", "../src/features/inventory.js", "../src/apps/knowledges/lores.js", "../src/features/knowledges.js", "../node_modules/nouislider/dist/nouislider.mjs", "../src/apps/merchant/buy.js", "../src/features/merchant.js", "../src/chat.js", "../src/apps/merge/multi.js", "../src/features/merge.js", "../src/features/nobulk.js", "../src/features/share.js", "../src/features/stances.js", "../src/features/summary.js", "../src/features/target.js", "../src/features/template.js", "../src/features/unided.js", "../src/features/untarget.js", "../src/macros/condition.js", "../src/main.js"],
  "sourcesContent": ["/**\r\n * @param {unknown} actor\r\n * @returns {unknown}\r\n */\r\nexport function getOwner(actor) {\r\n\tconst isValidUser = (user) => user.active && !user.isGM;\r\n\r\n\tlet owners = game.users.filter(\r\n\t\t(user) => isValidUser(user) && user.character === actor,\r\n\t);\r\n\r\n\tif (!owners.length) {\r\n\t\towners = game.users.filter(\r\n\t\t\t(user) => isValidUser(user) && actor.testUserPermission(user, \"OWNER\"),\r\n\t\t);\r\n\t}\r\n\r\n\towners.sort((a, b) => (a.id > b.id ? 1 : -1));\r\n\r\n\treturn owners[0] || null;\r\n}\r\n\r\n/**\r\n * @param {unknown} actor\r\n * @returns {boolean}\r\n */\r\nexport function isOwner(actor) {\r\n\treturn getOwner(actor) === game.user;\r\n}\r\n\r\n/**\r\n * @param {Actor} actor\r\n * @returns {string}\r\n */\r\nexport function getHighestName(actor) {\r\n\treturn actor.token?.name ?? actor.prototypeToken?.name ?? actor.name;\r\n}\r\n", "/**\r\n * @param {string} actorType\r\n */\r\nexport function refreshActorSheets(actorType) {\r\n\tfor (const app of Object.values(ui.windows)) {\r\n\t\tif (app instanceof ActorSheet && app.actor?.type === actorType) {\r\n\t\t\tapp.render();\r\n\t\t}\r\n\t}\r\n}\r\n", "/**\r\n * @generator\r\n * @template T\r\n * @param {number} nb\r\n * @param {T} [fromMessage]\r\n * @returns {{message: T, html: JQuery}}\r\n */\r\nexport function* latestChatMessages(nb, fromMessage) {\r\n\tconst chat = ui.chat?.element;\r\n\tif (!chat) return;\r\n\r\n\tconst messages = game.messages.contents;\r\n\tconst start =\r\n\t\t(fromMessage\r\n\t\t\t? messages.findLastIndex((m) => m === fromMessage)\r\n\t\t\t: messages.length) - 1;\r\n\r\n\tfor (let i = start; i >= start - nb; i--) {\r\n\t\tconst message = messages[i];\r\n\t\tif (!message) return;\r\n\r\n\t\tconst html = chat.find(`[data-message-id=${message.id}]`);\r\n\t\tif (!html.length) continue;\r\n\r\n\t\tyield { message, html };\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {string} uuid\r\n * @param {string} [label]\r\n * @returns {string}\r\n */\r\nexport function chatUUID(uuid, label) {\r\n\tif (!uuid) {\r\n\t\treturn `<span style=\"background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);\r\nborder-radius: 2px; white-space: nowrap; word-break: break-all;\">${label}</span>`;\r\n\t}\r\n\r\n\tif (label) return `@UUID[${uuid}]{${label}}`;\r\n\r\n\treturn `@UUID[${uuid}]`;\r\n}\r\n\r\n/**\r\n * @param {object} message\r\n * @returns {string}\r\n */\r\nexport function hasEmbeddedSpell(message) {\r\n\treturn !!(\r\n\t\tmessage.getFlag(\"pf2e\", \"casting.embeddedSpell\") ||\r\n\t\tmessage.item?.trickMagicEntry\r\n\t);\r\n}\r\n", "import { MODULE, socketEmit } from \".\";\r\n\r\n/**\r\n * @param {object} doc\r\n * @param {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getInMemory(doc, ...path) {\r\n\treturn getProperty(doc, `modules.${MODULE.id}.${path.join(\".\")}`);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {Boolean}\r\n */\r\nexport function setInMemory(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn setProperty(doc, `modules.${MODULE.id}.${args.join(\".\")}`, value);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {unknown}\r\n */\r\nexport function getInMemoryAndSetIfNot(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\tconst current = getInMemory(doc, ...args);\r\n\tif (current != null) return current;\r\n\tconst result = typeof value === \"function\" ? value() : value;\r\n\tsetInMemory(doc, ...args, result);\r\n\treturn result;\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param {string[]} path\r\n * @returns {boolean}\r\n */\r\nexport function deleteInMemory(doc, ...path) {\r\n\tconst split = [\"modules\", MODULE.id, ...path.flatMap((x) => x.split(\".\"))];\r\n\tconst last = split.pop();\r\n\tlet cursor = doc;\r\n\tfor (const key of split) {\r\n\t\tcursor = cursor[key];\r\n\t\tif (!cursor) return true;\r\n\t}\r\n\treturn delete cursor[last];\r\n}\r\n\r\n/**\r\n * @param {object} options\r\n * @param {FoundryDocument} options.doc\r\n * @param {Record<string, unknown>} [options.updates]\r\n * @returns {Promise<void>}\r\n */\r\nexport async function updateDocument({ doc, updates, message }, userId) {\r\n\tconst foundryDoc =\r\n\t\tdoc instanceof foundry.abstract.Document ? doc : await fromUuid(doc);\r\n\r\n\tif (!foundryDoc.isOwner) {\r\n\t\tsocketEmit({\r\n\t\t\ttype: \"permission.update-document\",\r\n\t\t\tdoc: foundryDoc.uuid,\r\n\t\t\tupdates,\r\n\t\t\tmessage,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tfoundryDoc.update(updates);\r\n\r\n\tif (message) {\r\n\t\tmessage.user = userId ?? game.user.id;\r\n\t\tChatMessage.implementation.create(message);\r\n\t}\r\n}\r\n\r\n/** *\r\n * @param {foundry.Document} doc\r\n * @returns {string|undefined}\r\n */\r\nexport function getSourceId(doc) {\r\n\treturn doc.getFlag(\"core\", \"sourceId\");\r\n}\r\n\r\n/**\r\n * @param {foundry.Document} doc\r\n * @param {string|} list\r\n * @returns {boolean}\r\n */\r\nexport function includesSourceId(doc, list) {\r\n\tconst sourceId = getSourceId(doc);\r\n\treturn sourceId ? list.includes(sourceId) : false;\r\n}\r\n\r\n/**\r\n * @param {string|string[]} sourceId\r\n * @returns {(item: object) => boolean}\r\n */\r\nexport function getSourceIdCondition(sourceId) {\r\n\treturn Array.isArray(sourceId)\r\n\t\t? (item) => includesSourceId(item, sourceId)\r\n\t\t: (item) => getSourceId(item) === sourceId;\r\n}\r\n", "/**\r\n * @template T\r\n *\r\n * @param {T[]} arr\r\n * @param {(value: T) => unknown} fn\r\n * @param {string | number} [key]\r\n * @returns {Record<T, unknown>}\r\n */\r\n\r\nexport function arrayToObject(arr, fn, key) {\r\n\tconst obj = {};\r\n\tfor (const entry of arr) {\r\n\t\tconst k = Array.isArray(entry)\r\n\t\t\t? entry[key ?? 0]\r\n\t\t\t: typeof entry === \"object\" && key != null\r\n\t\t\t  ? entry[key]\r\n\t\t\t  : entry;\r\n\t\tobj[k] = fn(entry);\r\n\t}\r\n\treturn obj;\r\n}\r\n\r\n/**\r\n *\r\n * @param {unknown[]} arr1\r\n * @param {unknown[]} arr2\r\n * @returns {boolean}\r\n */\r\nexport function compareArrays(arr1, arr2) {\r\n\tif (arr1.length !== arr2.length) return false;\r\n\r\n\tconst clonedArr2 = arr2.slice();\r\n\r\n\tfor (const arr1Value of arr1) {\r\n\t\tconst index = clonedArr2.findIndex((arr2Value) => arr1Value === arr2Value);\r\n\t\tif (index === -1) return false;\r\n\t\tclonedArr2.splice(index, 1);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\n/**\r\n * @param {number | undefined} index\r\n * @returns {boolean}\r\n */\r\nexport function indexIsValid(index) {\r\n\treturn index !== undefined && index !== -1;\r\n}\r\n\r\n/**\r\n * @param {number} start\r\n * @param {number} end\r\n * @returns {number[]}\r\n */\r\nexport function sequenceArray(start, end) {\r\n\tconst levels = [];\r\n\r\n\tif (start <= end) {\r\n\t\tfor (let i = start; i <= end; i++) levels.push(i);\r\n\t} else {\r\n\t\tfor (let i = start; i >= end; i--) levels.push(i);\r\n\t}\r\n\r\n\treturn levels;\r\n}\r\n", "/**\r\n * @param {HTMLElement} el\r\n * @returns {number | undefined}\r\n */\r\nexport function getElementIndex(el) {\r\n\treturn Array.from(el.parentElement.children).indexOf(el);\r\n}\r\n", "/**\r\n * @param {number} x1\r\n * @param {number} y1\r\n * @param {number} x2\r\n * @param {number} y2\r\n * @returns {number}\r\n */\r\nexport function calculateDistanceBetweenPoints(x1, y1, x2, y2) {\r\n\tconst x = x2 - x1;\r\n\tconst y = y2 - y1;\r\n\treturn Math.sqrt(x * x + y * y);\r\n}\r\n", "export const AsyncFunction = (async () => {}).constructor;\r\n\r\n/**\r\n * @param {object} obj\r\n * @param {string} name\r\n * @returns {boolean}\r\n */\r\nexport function isInstanceOf(obj, name) {\r\n\tif (typeof obj !== \"object\") return false;\r\n\r\n\tlet cursor = Reflect.getPrototypeOf(obj);\r\n\twhile (cursor) {\r\n\t\tif (cursor.constructor.name === name) return true;\r\n\t\tcursor = Reflect.getPrototypeOf(cursor);\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n", "/**\r\n * @param {string} separator\r\n * @param  {(string|string[])[]} path\r\n * @returns {string}\r\n */\r\nexport function joinStr(separator, ...path) {\r\n\tconst pathArr = Array.isArray(path[0]) ? path[0] : path;\r\n\treturn pathArr.filter((x) => typeof x === \"string\").join(separator);\r\n}\r\n\r\n/**\r\n * @param {string} str\r\n * @returns {string}\r\n */\r\nexport function capitalize(str) {\r\n\tif (!str) return \"\";\r\n\treturn str[0].toUpperCase() + str.slice(1);\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function flagPath(...path) {\r\n\treturn `flags.${MODULE.id}.${joinStr(\".\", path)}`;\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getFlag(doc, ...path) {\r\n\treturn doc.getFlag(MODULE.id, path.join(\".\"));\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getFlagProperty(doc, ...path) {\r\n\treturn getProperty(doc, flagPath(...path));\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {T} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {Promise<T>}\r\n */\r\nexport function setFlag(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn doc.setFlag(MODULE.id, args.join(\".\"), value);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {T} doc\r\n * @param {string[]} path\r\n * @returns {Promise<T>}\r\n */\r\nexport function unsetFlag(doc, ...path) {\r\n\treturn doc.unsetFlag(MODULE.id, path.join(\".\"));\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @returns {unknown}\r\n */\r\nexport function getModuleFlags(doc) {\r\n\treturn getProperty(doc, `flags.${MODULE.id}`);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {object}\r\n */\r\nexport function updateSourceFlag(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn doc.updateSource({\r\n\t\t[flagPath(...args)]: value,\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {object} updates\r\n * @param  {(string|unknown)[]} args\r\n */\r\nexport function moduleFlagUpdate(updates, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\tupdates[flagPath(...args)] = value;\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param  {(string|object)[]} args\r\n * @returns {Promise<string>}\r\n */\r\nexport function render(...args) {\r\n\tconst data = typeof args.at(-1) === \"object\" ? args.splice(-1)[0] : {};\r\n\tconst path = templatePath(...args);\r\n\treturn renderTemplate(path, data);\r\n}\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function templatePath(...path) {\r\n\treturn `modules/${MODULE.id}/templates/${joinStr(\"/\", path)}.hbs`;\r\n}\r\n", "/**\r\n * @param {string} event\r\n * @param {Functionn} listener\r\n * @returns {number}\r\n */\r\nexport function registerUpstreamHook(event, listener) {\r\n\tconst id = Hooks.on(event, listener);\r\n\tconst index = Hooks.events[event].findIndex((x) => x.id === id);\r\n\r\n\tif (index !== 0) {\r\n\t\tconst [hooked] = Hooks.events[event].splice(index, 1);\r\n\t\tHooks.events[event].unshift(hooked);\r\n\t}\r\n\r\n\treturn id;\r\n}\r\n", "import { getSourceIdCondition } from \"./document\";\r\n\r\n/**\r\n *\r\n * @param {object} actor\r\n * @param {string|string[]} itemTypes\r\n * @returns {object[]}\r\n */\r\nexport function getItems(actor, itemTypes = []) {\r\n\tconst types = typeof itemTypes === \"string\" ? [itemTypes] : itemTypes;\r\n\treturn types.length\r\n\t\t? types.flatMap((type) => actor.itemTypes[type])\r\n\t\t: actor.items;\r\n}\r\n\r\n/**\r\n * @param {object} actor\r\n * @param {string} sourceId\r\n * @param {string|string[]} itemTypes\r\n * @returns {boolean}\r\n */\r\nexport function hasItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).some(getSourceIdCondition(sourceId));\r\n}\r\n\r\n/**\r\n * @param {object} actor\r\n * @param {string} sourceId\r\n * @param {string|string[]} itemTypes\r\n * @returns {object} item\r\n */\r\nexport function getItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).find(getSourceIdCondition(sourceId));\r\n}\r\n", "import { MODULE } from \".\";\r\n\r\n/**\r\n * @param {string} path\r\n * @param {(...args: unknown[]) => unknown} callback\r\n * @param {\"WRAPPER\" | \"OVERRIDE\" | \"MIXED\"} type\r\n * @returns {string}\r\n */\r\nexport function registerWrapper(path, callback, type = \"WRAPPER\") {\r\n\treturn libWrapper.register(MODULE.id, path, callback, type);\r\n}\r\n\r\n/**\r\n * @param {string} id\r\n */\r\nexport function unregisterWrapper(id) {\r\n\tlibWrapper.unregister(MODULE.id, id);\r\n}\r\n", "import { MODULE, error, info, warn } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param {(string | object)[]} args\r\n * @returns {string}\r\n */\r\nexport function localize(...args) {\r\n\targs.unshift(MODULE.id);\r\n\tconst data = typeof args.at(-1) === \"object\" ? args.splice(-1)[0] : undefined;\r\n\treturn game.i18n[data ? \"format\" : \"localize\"](joinStr(\".\", args), data);\r\n}\r\n\r\n/**\r\n * Check if a module localization exists\r\n * @param {string[]} keys\r\n * @returns {boolean}\r\n */\r\nexport function hasLocalization(...keys) {\r\n\treturn game.i18n.has(`${MODULE.id}.${keys.join(\".\")}`, false);\r\n}\r\n\r\n/**\r\n * Used to localize in handlebars template\r\n * @param  {(string | {hash: object})[]} args\r\n * @returns {string}\r\n */\r\nexport function templateLocalize(...args) {\r\n\tconst data = args.splice(-1)[0].hash;\r\n\treturn localize(...args, data);\r\n}\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function localizePath(...path) {\r\n\treturn `${MODULE.id}.${path.join(\".\")}`;\r\n}\r\n\r\n/**\r\n * Convenient localization object with a sub context\r\n * @param {string} subKey\r\n * @returns {typeof localize & {path: typeof localizePath, template: typeof templateLocalize, warn: typeof warn, info: typeof info, error: typeof error, i18n: {i18n: typeof templateLocalize, i18Path: typeof localizePath}}}\r\n */\r\nexport function subLocalize(subKey) {\r\n\tconst fn = (...args) => localize(subKey, ...args);\r\n\r\n\tObject.defineProperties(fn, {\r\n\t\twarn: {\r\n\t\t\tvalue: (str, arg1, arg2) => warn(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tinfo: {\r\n\t\t\tvalue: (str, arg1, arg2) => info(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\terror: {\r\n\t\t\tvalue: (str, arg1, arg2) => error(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\thas: {\r\n\t\t\tvalue: (key) => hasLocalization(subKey, key),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tpath: {\r\n\t\t\tvalue: (key) => localizePath(subKey, key),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ttemplate: {\r\n\t\t\tvalue: (key, { hash }) => fn(key, hash),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ti18n: {\r\n\t\t\tget() {\r\n\t\t\t\treturn {\r\n\t\t\t\t\ti18n: this.template,\r\n\t\t\t\t\ti18Path: this.path,\r\n\t\t\t\t};\r\n\t\t\t},\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t});\r\n\r\n\treturn fn;\r\n}\r\n\r\n/**\r\n * @param {string} a\r\n * @param {string} b\r\n * @returns {number}\r\n */\r\nexport function localeCompare(a, b) {\r\n\treturn a.localeCompare(b, game.i18n.lang);\r\n}\r\n", "/**\r\n * @type {string}\r\n */\r\nlet MODULE_ID = null;\r\n\r\nexport const MODULE = {\r\n\tget id() {\r\n\t\tif (!MODULE_ID) {\r\n\t\t\tthrow new Error(\"Module id needs to be registered.\");\r\n\t\t}\r\n\t\treturn MODULE_ID;\r\n\t},\r\n\t/**\r\n\t * @param {string} str\r\n\t */\r\n\terror(str) {\r\n\t\tthrow new Error(`[${this.id}] ${str}`);\r\n\t},\r\n};\r\n\r\n/**\r\n * register the module id\r\n * @param {string} id\r\n */\r\nexport function registerModule(id) {\r\n\tMODULE_ID = id;\r\n}\r\n\r\n/**\r\n * @param {string} [id]\r\n * @returns {object}\r\n */\r\nexport function getModule(id) {\r\n\treturn game.modules.get(id ?? MODULE.id);\r\n}\r\n", "import { localize } from \"./localize\";\r\n\r\n/**\r\n * @param {string} str\r\n * @param {\"warning\" | \"info\" | \"error\" | object | boolean} [arg1]\r\n * @param {object | boolean} [arg2]\r\n * @param {boolean} [arg3]\r\n */\r\nfunction notify(str, arg1, arg2, arg3) {\r\n\tconst type = typeof arg1 === \"string\" ? arg1 : \"info\";\r\n\tconst data =\r\n\t\ttypeof arg1 === \"object\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"object\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : undefined;\r\n\tconst permanent =\r\n\t\ttypeof arg1 === \"boolean\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"boolean\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : arg3 ?? false;\r\n\r\n\tui.notifications.notify(localize(str, data), type, { permanent });\r\n}\r\n\r\n/**\r\n * @typedef { (str: string, arg1?: object | boolean, arg2?: boolean) => void } Notify\r\n */\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function warn(str, arg1, arg2) {\r\n\tnotify(str, \"warning\", arg1, arg2);\r\n}\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function info(str, arg1, arg2) {\r\n\tnotify(str, \"info\", arg1, arg2);\r\n}\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function error(str, arg1, arg2) {\r\n\tnotify(str, \"error\", arg1, arg2);\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { arrayToObject } from \"../utils/array\";\r\n\r\n/**\r\n * @template {number | boolean | string} T\r\n * @param { {key: string, type: new (...args: unknkown[]) => T, default: T, [k: string]: unknown }} options\r\n */\r\nexport function registerSetting(options) {\r\n\toptions.key ??= options.name;\r\n\r\n\tif (Array.isArray(options.choices)) {\r\n\t\toptions.choices = arrayToObject(options.choices, (choice) =>\r\n\t\t\tsettingPath(options.key, \"choices\", choice),\r\n\t\t);\r\n\t}\r\n\r\n\toptions.name = settingPath(options.key, \"name\");\r\n\toptions.hint = settingPath(options.key, \"hint\");\r\n\toptions.scope ??= \"world\";\r\n\toptions.config ??= true;\r\n\r\n\tgame.settings.register(MODULE.id, options.key, options);\r\n}\r\n\r\nexport function registerSettingMenu(options) {\r\n\toptions.key ??= options.name;\r\n\r\n\toptions.name = settingPath(\"menus\", options.key, \"name\");\r\n\toptions.label = settingPath(\"menus\", options.key, \"label\");\r\n\toptions.hint = settingPath(\"menus\", options.key, \"hint\");\r\n\toptions.restricted ??= true;\r\n\toptions.icon ??= \"fas fa-cogs\";\r\n\r\n\tgame.settings.registerMenu(MODULE.id, options.key, options);\r\n}\r\n\r\n/**\r\n * @param {string[]} path\r\n * @returns\r\n */\r\nexport function settingPath(...path) {\r\n\treturn `${MODULE.id}.settings.${path.join(\".\")}`;\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @returns {unknown}\r\n */\r\nexport function getSetting(setting) {\r\n\treturn game.settings.get(MODULE.id, setting);\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @returns {boolean}\r\n */\r\nexport function isChoiceSetting(setting) {\r\n\treturn !!game.settings.settings.get(`${MODULE.id}.${setting}`)?.choices;\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {string} setting\r\n * @param {T} value\r\n * @returns {Promise<T>}\r\n */\r\nexport function setSetting(setting, value) {\r\n\treturn game.settings.set(MODULE.id, setting, value);\r\n}\r\n", "import { MODULE, updateDocument } from \".\";\r\n\r\n/**\r\n * @typedef { {key: string, [k: string]: unknown} } ModulePacket\r\n * @typedef { (packet: ModulePacket, senderId: string) => void} ModuleSocketFunction\r\n */\r\n\r\n/**\r\n * @param {ModuleSocketFunction} callback\r\n */\r\nexport function socketOn(callback) {\r\n\tgame.socket.on(`module.${MODULE.id}`, callback);\r\n}\r\n\r\n/**\r\n * @param {ModuleSocketFunction} callback\r\n */\r\nexport function socketOff(callback) {\r\n\tgame.socket.off(`module.${MODULE.id}`, callback);\r\n}\r\n\r\n/**\r\n * @param {ModulePacket} packet\r\n */\r\nexport function socketEmit(packet) {\r\n\tgame.socket.emit(`module.${MODULE.id}`, packet);\r\n}\r\n\r\nlet permissionSocketRegistered = false;\r\nexport function registerPermissionSocket() {\r\n\tif (permissionSocketRegistered) return;\r\n\r\n\tpermissionSocketRegistered = true;\r\n\r\n\tsocketOn((packet, userId) => {\r\n\t\tswitch (packet.type) {\r\n\t\t\tcase \"permission.update-document\":\r\n\t\t\t\tupdateDocument(packet, userId);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t});\r\n}\r\n", "function getUser() {\r\n\treturn game.user ?? game.data.users.find((x) => x._id === game.data.userId);\r\n}\r\n\r\n/**\r\n * @returns {boolean}\r\n */\r\nexport function isUserGM() {\r\n\tconst user = getUser();\r\n\treturn user && user.role >= CONST.USER_ROLES.ASSISTANT;\r\n}\r\n\r\n/**\r\n * @returns {boolean}\r\n */\r\nexport function isActiveGM() {\r\n\treturn game.user === game.users.activeGM;\r\n}\r\n\r\n/**\r\n * @returns {boolean}\r\n */\r\nexport function isGMOnline() {\r\n\treturn game.users.some((user) => user.active && user.isGM);\r\n}\r\n", "/**\r\n * @typedef {\"equipment\"} TabName\r\n * @typedef {TabName | Record<string, unknown>} TabOrTabName\r\n */\r\n\r\n/**\r\n * @param {TabOrTabName} tabOrName\r\n * @returns {Promise<object[]>}\r\n */\r\nexport function getTabResults(tabOrName) {\r\n\tconst tab = tabFromTabOrTabName(tabOrName);\r\n\treturn Promise.all(\r\n\t\ttab.currentIndex.flatMap(async ({ uuid }) =>\r\n\t\t\t(await fromUuid(uuid))?.toObject(),\r\n\t\t),\r\n\t);\r\n}\r\n\r\n/**\r\n * @returns {object}\r\n */\r\nexport function getBrowser() {\r\n\treturn game.pf2e.compendiumBrowser;\r\n}\r\n\r\n/**\r\n * @param {TabName} tabName\r\n * @returns {object}\r\n */\r\nexport function getBrowserTab(tabName) {\r\n\treturn game.pf2e.compendiumBrowser.tabs[tabName];\r\n}\r\n\r\n/**\r\n * @param {TabName} tabOrName\r\n * @param {object|false} [data]\r\n * @returns {Promise<void>}\r\n */\r\nexport function openBrowserTab(tabOrName, data) {\r\n\tconst tab = tabFromTabOrTabName(tabOrName);\r\n\tconst tabData =\r\n\t\ttypeof data === \"object\"\r\n\t\t\t? data\r\n\t\t\t: data === false && tab.isInitialized\r\n\t\t\t  ? deepClone(tab.defaultFilterData)\r\n\t\t\t  : undefined;\r\n\treturn game.pf2e.compendiumBrowser.openTab(tab.tabName, tabData);\r\n}\r\n\r\n/**\r\n *\r\n * @param {TabOrTabName} tab\r\n * @returns {object}\r\n */\r\nfunction tabFromTabOrTabName(tab) {\r\n\tif (typeof tab === \"string\") {\r\n\t\treturn getBrowserTab(tab);\r\n\t}\r\n\treturn tab;\r\n}\r\n\r\nlet equipmentTabData;\r\nexport function getEquipmentTabData({ collapsed = false, mergeWith } = {}) {\r\n\tconst tab = getBrowserTab(\"equipment\");\r\n\r\n\tconst returned = (equipmentData) => {\r\n\t\tconst filterData = deepClone(equipmentData);\r\n\r\n\t\tif (collapsed) {\r\n\t\t\tfor (const [typeName, type] of Object.entries(filterData)) {\r\n\t\t\t\tif (typeName === \"order\" || typeName === \"search\") continue;\r\n\t\t\t\tfor (const category of Object.values(type)) {\r\n\t\t\t\t\tif (\"isExpanded\" in category) {\r\n\t\t\t\t\t\tcategory.isExpanded = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof mergeWith === \"object\") {\r\n\t\t\tmergeObject(filterData, mergeWith);\r\n\r\n\t\t\tfor (const data of Object.values(filterData.checkboxes)) {\r\n\t\t\t\tif (!data.selected.length) continue;\r\n\r\n\t\t\t\tdata.isExpanded = true;\r\n\t\t\t\tfor (const selected of data.selected) {\r\n\t\t\t\t\tdata.options[selected].selected = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfor (const type of [\"ranges\", \"sliders\"]) {\r\n\t\t\t\tconst defaultType = equipmentData[type];\r\n\r\n\t\t\t\tfor (const [category, data] of Object.entries(filterData[type])) {\r\n\t\t\t\t\tconst defaultCategory = defaultType[category];\r\n\t\t\t\t\tif (objectsEqual(data.values, defaultCategory.values)) continue;\r\n\t\t\t\t\tdata.isExpanded = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn filterData;\r\n\t};\r\n\r\n\tif (tab.defaultFilterData) {\r\n\t\treturn returned(tab.defaultFilterData);\r\n\t}\r\n\r\n\tif (equipmentTabData) {\r\n\t\treturn returned(equipmentTabData);\r\n\t}\r\n\r\n\tequipmentTabData = tab.prepareFilterData();\r\n\r\n\tequipmentTabData.checkboxes.armorTypes.options = tab.generateCheckboxOptions(\r\n\t\tCONFIG.PF2E.armorCategories,\r\n\t);\r\n\tmergeObject(\r\n\t\tequipmentTabData.checkboxes.armorTypes.options,\r\n\t\ttab.generateCheckboxOptions(CONFIG.PF2E.armorGroups),\r\n\t);\r\n\tequipmentTabData.checkboxes.weaponTypes.options = tab.generateCheckboxOptions(\r\n\t\tCONFIG.PF2E.weaponCategories,\r\n\t);\r\n\tmergeObject(\r\n\t\tequipmentTabData.checkboxes.weaponTypes.options,\r\n\t\ttab.generateCheckboxOptions(CONFIG.PF2E.weaponGroups),\r\n\t);\r\n\r\n\tequipmentTabData.multiselects.traits.options = tab.generateMultiselectOptions(\r\n\t\t{\r\n\t\t\t...CONFIG.PF2E.armorTraits,\r\n\t\t\t...CONFIG.PF2E.consumableTraits,\r\n\t\t\t...CONFIG.PF2E.equipmentTraits,\r\n\t\t\t...CONFIG.PF2E.shieldTraits,\r\n\t\t\t...CONFIG.PF2E.weaponTraits,\r\n\t\t},\r\n\t);\r\n\r\n\tequipmentTabData.checkboxes.itemTypes.options = tab.generateCheckboxOptions({\r\n\t\tweapon: \"TYPES.Item.weapon\",\r\n\t\tshield: \"TYPES.Item.shield\",\r\n\t\tarmor: \"TYPES.Item.armor\",\r\n\t\tequipment: \"TYPES.Item.equipment\",\r\n\t\tconsumable: \"TYPES.Item.consumable\",\r\n\t\ttreasure: \"TYPES.Item.treasure\",\r\n\t\tbackpack: \"TYPES.Item.backpack\",\r\n\t\tkit: \"TYPES.Item.kit\",\r\n\t});\r\n\tequipmentTabData.checkboxes.rarity.options = tab.generateCheckboxOptions(\r\n\t\tCONFIG.PF2E.rarityTraits,\r\n\t\tfalse,\r\n\t);\r\n\r\n\treturn returned(equipmentTabData);\r\n}\r\n", "import * as R from \"remeda\";\r\n\r\n/**\r\n * @param {HTMLElement} parent\r\n * @param {string} selectors\r\n * @returns {HTMLElement|null}\r\n */\r\nexport function htmlQuery(parent, selectors) {\r\n\tif (!(parent instanceof Element || parent instanceof Document)) return null;\r\n\treturn parent.querySelector(selectors);\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} parent\r\n * @param {string} selectors\r\n * @returns {NodeListOf<HTMLElement>}\r\n */\r\nexport function htmlQueryAll(parent, selectors) {\r\n\tif (!(parent instanceof Element || parent instanceof Document)) return [];\r\n\treturn Array.from(parent.querySelectorAll(selectors));\r\n}\r\n\r\n/**\r\n * @param {string} nodeName\r\n * @param {{\r\n *   classes?: string[];\r\n *   dataset?: Record<string, string | number | boolean | null | undefined>;\r\n *   children?: (HTMLElement | string)[];\r\n *   innerHTML?: string;\r\n * }}\r\n * @returns {HTMLElement}\r\n */\r\nexport function createHTMLElement(\r\n\tnodeName,\r\n\t{ classes = [], dataset = {}, children = [], innerHTML } = {},\r\n) {\r\n\tconst element = document.createElement(nodeName);\r\n\tif (classes.length > 0) element.classList.add(...classes);\r\n\r\n\tfor (const [key, value] of Object.entries(dataset).filter(\r\n\t\t([, v]) => !R.isNil(v) && v !== false,\r\n\t)) {\r\n\t\telement.dataset[key] = value === true ? \"\" : String(value);\r\n\t}\r\n\r\n\tif (innerHTML) {\r\n\t\telement.innerHTML = innerHTML;\r\n\t} else {\r\n\t\tfor (const child of children) {\r\n\t\t\tconst childElement =\r\n\t\t\t\tchild instanceof HTMLElement ? child : new Text(child);\r\n\t\t\telement.appendChild(childElement);\r\n\t\t}\r\n\t}\r\n\r\n\treturn element;\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} child\r\n * @param {string} selectors\r\n * @returns {HTMLElement|null}\r\n */\r\nexport function htmlClosest(child, selectors) {\r\n\tif (!(child instanceof Element)) return null;\r\n\treturn child.closest(selectors);\r\n}\r\n", "/**\r\n * @param {number} value\r\n * @returns {string}\r\n */\r\nexport function ordinalString(value) {\r\n\tconst pluralRules = new Intl.PluralRules(game.i18n.lang, { type: \"ordinal\" });\r\n\tconst suffix = game.i18n.localize(\r\n\t\t`PF2E.OrdinalSuffixes.${pluralRules.select(value)}`,\r\n\t);\r\n\treturn game.i18n.format(\"PF2E.OrdinalNumber\", { value, suffix });\r\n}\r\n\r\n/**\r\n * @param {string} message\r\n * @returns {Error}\r\n */\r\nexport function ErrorPF2e(message) {\r\n\treturn Error(`PF2e System | ${message}`);\r\n}\r\n\r\n/**\r\n * @type {Intl.NumberFormat}\r\n */\r\nlet intlNumberFormat;\r\n/**\r\n * @param {number} value\r\n * @param {object} [options]\r\n * @param {boolean} [options.emptyStringZero]\r\n * @param {boolean} [options.zeroIsNegative]\r\n * @returns {string}\r\n */\r\nexport function signedInteger(\r\n\tvalue,\r\n\t{ emptyStringZero = false, zeroIsNegative = false } = {},\r\n) {\r\n\tif (value === 0 && emptyStringZero) return \"\";\r\n\r\n\tintlNumberFormat ??= new Intl.NumberFormat(game.i18n.lang, {\r\n\t\tmaximumFractionDigits: 0,\r\n\t\tsignDisplay: \"always\",\r\n\t});\r\n\r\n\tconst maybeNegativeZero = zeroIsNegative && value === 0 ? -0 : value;\r\n\r\n\treturn intlNumberFormat.format(maybeNegativeZero);\r\n}\r\n\r\n/**\r\n * @param {object} obj\r\n * @param {unknown} key\r\n * @returns {boolean}\r\n */\r\nexport function objectHasKey(obj, key) {\r\n\treturn (typeof key === \"string\" || typeof key === \"number\") && key in obj;\r\n}\r\n\r\n/**\r\n * @param {string} prefix\r\n * @returns {(...args: (string|Record<string, unknown>)[]) => string}\r\n */\r\nexport function localizer(prefix) {\r\n\treturn (...[suffix, formatArgs]) =>\r\n\t\tformatArgs\r\n\t\t\t? game.i18n.format(`${prefix}.${suffix}`, formatArgs)\r\n\t\t\t: game.i18n.localize(`${prefix}.${suffix}`);\r\n}\r\n\r\nconst actionGlyphMap = {\r\n\t0: \"F\",\r\n\tfree: \"F\",\r\n\t1: \"A\",\r\n\t2: \"D\",\r\n\t3: \"T\",\r\n\t\"1 or 2\": \"A/D\",\r\n\t\"1 to 3\": \"A - T\",\r\n\t\"2 or 3\": \"D/T\",\r\n\treaction: \"R\",\r\n};\r\n\r\n/**\r\n * @param {typeof actionGlyphMap} action\r\n * @returns {string}\r\n */\r\nexport function getActionGlyph(action) {\r\n\tif (!action && action !== 0) return \"\";\r\n\r\n\tconst value =\r\n\t\ttypeof action !== \"object\"\r\n\t\t\t? action\r\n\t\t\t: action.type === \"action\"\r\n\t\t\t  ? action.value\r\n\t\t\t  : action.type;\r\n\tconst sanitized = String(value ?? \"\")\r\n\t\t.toLowerCase()\r\n\t\t.trim();\r\n\r\n\treturn actionGlyphMap[sanitized]?.replace(\"-\", \"\u2013\") ?? \"\";\r\n}\r\n\r\nconst actionImgMap = {\r\n\t0: \"systems/pf2e/icons/actions/FreeAction.webp\",\r\n\tfree: \"systems/pf2e/icons/actions/FreeAction.webp\",\r\n\t1: \"systems/pf2e/icons/actions/OneAction.webp\",\r\n\t2: \"systems/pf2e/icons/actions/TwoActions.webp\",\r\n\t3: \"systems/pf2e/icons/actions/ThreeActions.webp\",\r\n\t\"1 or 2\": \"systems/pf2e/icons/actions/OneTwoActions.webp\",\r\n\t\"1 to 3\": \"systems/pf2e/icons/actions/OneThreeActions.webp\",\r\n\t\"2 or 3\": \"systems/pf2e/icons/actions/TwoThreeActions.webp\",\r\n\treaction: \"systems/pf2e/icons/actions/Reaction.webp\",\r\n\tpassive: \"systems/pf2e/icons/actions/Passive.webp\",\r\n};\r\n\r\n/**\r\n *\r\n * @param {string | {type: string, value: 1|2|3|null} | null} action\r\n * @param {string} [fallback]\r\n * @returns {string|null}\r\n */\r\nexport function getActionIcon(\r\n\taction,\r\n\tfallback = \"systems/pf2e/icons/actions/Empty.webp\",\r\n) {\r\n\tif (action === null) return actionImgMap.passive;\r\n\tconst value =\r\n\t\ttypeof action !== \"object\"\r\n\t\t\t? action\r\n\t\t\t: action.type === \"action\"\r\n\t\t\t  ? action.value\r\n\t\t\t  : action.type;\r\n\tconst sanitized = String(value ?? \"\")\r\n\t\t.toLowerCase()\r\n\t\t.trim();\r\n\treturn actionImgMap[sanitized] ?? fallback;\r\n}\r\n\r\n/**\r\n * @param {string} text\r\n * @param {object} [options]\r\n * @param {boolean|null} [options.camel]\r\n * @returns {string}\r\n */\r\nexport function sluggify(text, options) {\r\n\treturn game.pf2e.system.sluggify(text, options);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {Set<T>} set\r\n * @param {T} value\r\n * @returns {boolean}\r\n */\r\nexport function setHasElement(set, value) {\r\n\treturn set.has(value);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {[T, T]} array\r\n * @param {T} value\r\n * @returns {boolean}\r\n */\r\nexport function tupleHasValue(array, value) {\r\n\treturn array.includes(value);\r\n}\r\n\r\n/**\r\n * @param {unknown} value\r\n * @returns {boolean}\r\n */\r\nexport function isObject(value) {\r\n\treturn typeof value === \"object\" && value !== null;\r\n}\r\n", "import * as R from \"remeda\";\r\n\r\n/**\r\n * @param {object} options\r\n * @param {string} options.affects\r\n * @param {object} options.origin\r\n * @param {object} options.target\r\n * @param {object} options.item\r\n * @param {string[]} options.domains\r\n * @param {string[]} options.options\r\n * @returns {Promise<object[]>}\r\n */\r\nexport async function extractEphemeralEffects({\r\n\taffects,\r\n\torigin,\r\n\ttarget,\r\n\titem,\r\n\tdomains,\r\n\toptions,\r\n}) {\r\n\tif (!(origin && target)) return [];\r\n\r\n\tconst [effectsFrom, effectsTo] =\r\n\t\taffects === \"target\" ? [origin, target] : [target, origin];\r\n\tconst fullOptions = [\r\n\t\t...options,\r\n\t\teffectsFrom.getRollOptions(domains),\r\n\t\teffectsTo.getSelfRollOptions(affects),\r\n\t].flat();\r\n\tconst resolvables = item\r\n\t\t? item.isOfType(\"spell\")\r\n\t\t\t? { spell: item }\r\n\t\t\t: { weapon: item }\r\n\t\t: {};\r\n\treturn (\r\n\t\tawait Promise.all(\r\n\t\t\tdomains\r\n\t\t\t\t.flatMap(\r\n\t\t\t\t\t(s) => effectsFrom.synthetics.ephemeralEffects[s]?.[affects] ?? [],\r\n\t\t\t\t)\r\n\t\t\t\t.map((d) => d({ test: fullOptions, resolvables })),\r\n\t\t)\r\n\t).flatMap((e) => e ?? []);\r\n}\r\n\r\n/**\r\n * @param {object} rollNotes\r\n * @param {string[]} selectors\r\n * @returns {object[]}\r\n */\r\nexport function extractNotes(rollNotes, selectors) {\r\n\treturn selectors.flatMap((s) => (rollNotes[s] ?? []).map((n) => n.clone()));\r\n}\r\n\r\n/**\r\n *\r\n * @param {object} deferredDice\r\n * @param {string[]} selectors\r\n * @param {object} options\r\n * @returns {object[]}\r\n */\r\nexport function extractDamageDice(synthetics, options) {\r\n\treturn options.selectors\r\n\t\t.flatMap((s) => synthetics[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n}\r\n\r\n/**\r\n * @param {object} synthetics\r\n * @param {string[]} selectors\r\n * @param {object} options\r\n * @returns {object[]}\r\n */\r\nexport function extractModifiers(synthetics, selectors, options = {}) {\r\n\tconst domains = R.uniq(selectors);\r\n\tconst modifiers = domains\r\n\t\t.flatMap((s) => synthetics.modifiers[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n\tfor (const modifier of modifiers) {\r\n\t\tmodifier.domains = [...domains];\r\n\t\tmodifier.adjustments = extractModifierAdjustments(\r\n\t\t\tsynthetics.modifierAdjustments,\r\n\t\t\tdomains,\r\n\t\t\tmodifier.slug,\r\n\t\t);\r\n\t\tif (domains.some((s) => s.endsWith(\"damage\"))) {\r\n\t\t\tmodifier.alterations = extractDamageAlterations(\r\n\t\t\t\tsynthetics.damageAlterations,\r\n\t\t\t\tdomains,\r\n\t\t\t\tmodifier.slug,\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\treturn modifiers;\r\n}\r\n\r\nfunction extractDamageAlterations(alterationsRecord, selectors, slug) {\r\n\tconst alterations = R.uniq(\r\n\t\tselectors.flatMap((s) => alterationsRecord[s] ?? []),\r\n\t);\r\n\treturn alterations.filter((a) => [slug, null].includes(a.slug));\r\n}\r\n\r\nfunction extractModifierAdjustments(adjustmentsRecord, selectors, slug) {\r\n\tconst adjustments = R.uniq(\r\n\t\tselectors.flatMap((s) => adjustmentsRecord[s] ?? []),\r\n\t);\r\n\treturn adjustments.filter((a) => [slug, null].includes(a.slug));\r\n}\r\n", "import { getHighestName } from \"../foundry\";\r\nimport { isInstanceOf } from \"../utils\";\r\nimport { htmlQuery } from \"./html\";\r\nimport { ErrorPF2e, getActionGlyph } from \"./misc\";\r\nimport { extractEphemeralEffects } from \"./rules\";\r\nimport { traitSlugToObject } from \"./tags\";\r\n\r\n/**\r\n * @typedef {(message: object, tokens: object[], rollIndex: number) => void} OnDamageApplied\r\n *\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.addend\r\n * @param {boolean} options.promptModifier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nexport async function applyDamageFromMessage({\r\n\tmessage,\r\n\tmultiplier = 1,\r\n\taddend = 0,\r\n\tpromptModifier = false,\r\n\trollIndex = 0,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tif (promptModifier) {\r\n\t\treturn shiftAdjustDamage({\r\n\t\t\tmessage,\r\n\t\t\tmultiplier,\r\n\t\t\trollIndex,\r\n\t\t\t// added\r\n\t\t\ttokens,\r\n\t\t\tonDamageApplied,\r\n\t\t});\r\n\t}\r\n\r\n\t// changed\r\n\ttokens ??= (() => {\r\n\t\tconst html = htmlQuery(\r\n\t\t\tui.chat.element[0],\r\n\t\t\t`li.chat-message[data-message-id=\"${message.id}\"]`,\r\n\t\t);\r\n\t\treturn html?.dataset.actorIsTarget && message.token\r\n\t\t\t? [message.token]\r\n\t\t\t: game.user.getActiveTokens();\r\n\t})();\r\n\tif (tokens.length === 0) {\r\n\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\tlocalize: true,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst shieldBlockRequest = CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\tconst roll = message.rolls.at(rollIndex);\r\n\tif (!isInstanceOf(roll, \"DamageRoll\"))\r\n\t\tthrow ErrorPF2e(\"Unexpected error retrieving damage roll\");\r\n\r\n\tconst damage =\r\n\t\tmultiplier < 0\r\n\t\t\t? multiplier * roll.total + addend\r\n\t\t\t: roll.alter(multiplier, addend);\r\n\r\n\t// Get origin roll options and apply damage to a contextual clone: this may influence condition IWR, for example\r\n\tconst messageRollOptions = [...(message.flags.pf2e.context?.options ?? [])];\r\n\tconst originRollOptions = messageRollOptions\r\n\t\t.filter((o) => o.startsWith(\"self:\"))\r\n\t\t.map((o) => o.replace(/^self/, \"origin\"));\r\n\tconst messageItem = message.item;\r\n\tconst effectRollOptions = messageItem?.isOfType(\r\n\t\t\"affliction\",\r\n\t\t\"condition\",\r\n\t\t\"effect\",\r\n\t)\r\n\t\t? messageItem.getRollOptions(\"item\")\r\n\t\t: [];\r\n\r\n\tfor (const token of tokens) {\r\n\t\tif (!token.actor) continue;\r\n\r\n\t\t// If no target was acquired during a roll, set roll options for it during damage application\r\n\t\tif (!messageRollOptions.some((o) => o.startsWith(\"target\"))) {\r\n\t\t\tmessageRollOptions.push(...token.actor.getSelfRollOptions(\"target\"));\r\n\t\t}\r\n\t\tconst domain = multiplier > 0 ? \"damage-received\" : \"healing-received\";\r\n\t\tconst ephemeralEffects =\r\n\t\t\tmultiplier > 0\r\n\t\t\t\t? await extractEphemeralEffects({\r\n\t\t\t\t\t\taffects: \"target\",\r\n\t\t\t\t\t\torigin: message.actor,\r\n\t\t\t\t\t\ttarget: token.actor,\r\n\t\t\t\t\t\titem: message.item,\r\n\t\t\t\t\t\tdomains: [domain],\r\n\t\t\t\t\t\toptions: messageRollOptions,\r\n\t\t\t\t  })\r\n\t\t\t\t: [];\r\n\t\tconst contextClone = token.actor.getContextualClone(\r\n\t\t\toriginRollOptions,\r\n\t\t\tephemeralEffects,\r\n\t\t);\r\n\t\tconst rollOptions = new Set([\r\n\t\t\t...messageRollOptions.filter((o) => !/^(?:self|target):/.test(o)),\r\n\t\t\t...effectRollOptions,\r\n\t\t\t...originRollOptions,\r\n\t\t\t...contextClone.getSelfRollOptions(),\r\n\t\t]);\r\n\r\n\t\tawait contextClone.applyDamage({\r\n\t\t\tdamage,\r\n\t\t\ttoken,\r\n\t\t\titem: message.item,\r\n\t\t\tskipIWR: multiplier <= 0,\r\n\t\t\trollOptions,\r\n\t\t\tshieldBlockRequest,\r\n\t\t\toutcome: message.flags.pf2e.context?.outcome,\r\n\t\t});\r\n\t}\r\n\ttoggleOffShieldBlock(message.id);\r\n\r\n\t// added\r\n\tonDamageApplied?.(message, tokens, rollIndex);\r\n}\r\n\r\n/**\r\n * @param {object} target\r\n * @param {HTMLElement} shieldButton\r\n * @param {HTMLElement} messageEl\r\n */\r\nexport function onClickShieldBlock(target, shieldButton, messageEl) {\r\n\t// changed\r\n\tconst getTokens = () => {\r\n\t\treturn [target];\r\n\t};\r\n\tconst getNonBrokenShields = (tokens) => {\r\n\t\tconst actor = tokens[0]?.actor;\r\n\t\treturn (\r\n\t\t\tactor?.itemTypes.shield.filter(\r\n\t\t\t\t(s) => s.isEquipped && !s.isBroken && !s.isDestroyed,\r\n\t\t\t) ?? []\r\n\t\t);\r\n\t};\r\n\r\n\t// Add a tooltipster instance to the shield button if needed.\r\n\tif (!shieldButton.classList.contains(\"tooltipstered\")) {\r\n\t\t$(shieldButton)\r\n\t\t\t.tooltipster({\r\n\t\t\t\tanimation: \"fade\",\r\n\t\t\t\ttrigger: \"click\",\r\n\t\t\t\tarrow: false,\r\n\t\t\t\tcontent: htmlQuery(messageEl, \"div.hover-content\"),\r\n\t\t\t\tcontentAsHTML: true,\r\n\t\t\t\tcontentCloning: true,\r\n\t\t\t\tdebug: false,\r\n\t\t\t\tinteractive: true,\r\n\t\t\t\tside: [\"top\"],\r\n\t\t\t\ttheme: \"crb-hover\",\r\n\t\t\t\tfunctionBefore: () => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tif (!tokens.length) return false;\r\n\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst hasMultipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// More than one shield and no selection. Show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && !shieldActivated) {\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// More than one shield and one was previously selected. Remove selection and show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && shieldButton.dataset.shieldId) {\r\n\t\t\t\t\t\tshieldButton.attributes.removeNamedItem(\"data-shield-id\");\r\n\t\t\t\t\t\tshieldButton.classList.remove(\"shield-activated\");\r\n\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Normal toggle behaviour. Tooltip is suppressed.\r\n\t\t\t\t\tshieldButton.classList.toggle(\"shield-activated\");\r\n\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle =\r\n\t\t\t\t\t\t!CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\t\t\t\tfunctionFormat: (instance, _helper, contentEl) => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst multipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// If the actor is wielding more than one shield, have the user pick which shield to use for blocking.\r\n\t\t\t\t\tif (multipleShields && !shieldActivated) {\r\n\t\t\t\t\t\t// Populate the list with the shield options\r\n\t\t\t\t\t\tconst listEl = htmlQuery(contentEl, \"ul.shield-options\");\r\n\t\t\t\t\t\tif (!listEl) return $(contentEl);\r\n\r\n\t\t\t\t\t\tconst shieldList = nonBrokenShields.map((shield) => {\r\n\t\t\t\t\t\t\tconst input = document.createElement(\"input\");\r\n\t\t\t\t\t\t\tinput.classList.add(\"data\");\r\n\t\t\t\t\t\t\tinput.type = \"radio\";\r\n\t\t\t\t\t\t\tinput.name = \"shield-id\";\r\n\t\t\t\t\t\t\tinput.value = shield.id;\r\n\t\t\t\t\t\t\tinput.addEventListener(\"click\", () => {\r\n\t\t\t\t\t\t\t\tshieldButton.dataset.shieldId = input.value;\r\n\t\t\t\t\t\t\t\tshieldButton.classList.add(\"shield-activated\");\r\n\t\t\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = true;\r\n\t\t\t\t\t\t\t\tinstance.close();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst shieldName = document.createElement(\"span\");\r\n\t\t\t\t\t\t\tshieldName.classList.add(\"label\");\r\n\t\t\t\t\t\t\tshieldName.innerHTML = shield.name;\r\n\r\n\t\t\t\t\t\t\tconst hardness = document.createElement(\"span\");\r\n\t\t\t\t\t\t\thardness.classList.add(\"tag\");\r\n\t\t\t\t\t\t\tconst hardnessLabel = game.i18n.localize(\"PF2E.HardnessLabel\");\r\n\t\t\t\t\t\t\thardness.innerHTML = `${hardnessLabel}: ${shield.hardness}`;\r\n\r\n\t\t\t\t\t\t\tconst itemLi = document.createElement(\"li\");\r\n\t\t\t\t\t\t\titemLi.classList.add(\"item\");\r\n\t\t\t\t\t\t\titemLi.append(input, shieldName, hardness);\r\n\r\n\t\t\t\t\t\t\treturn itemLi;\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tlistEl.replaceChildren(...shieldList);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn $(contentEl);\r\n\t\t\t\t},\r\n\t\t\t})\r\n\t\t\t.tooltipster(\"open\");\r\n\t}\r\n}\r\n\r\n/**\r\n * adapted to toggle multiple buttons\r\n * @param {string} messageId\r\n */\r\nexport function toggleOffShieldBlock(messageId) {\r\n\tfor (const app of [\"#chat-log\", \"#chat-popout\"]) {\r\n\t\tconst selector = `${app} > li.chat-message[data-message-id=\"${messageId}\"] button[data-action$=shield-block]`;\r\n\t\tfor (const button of document.body.querySelectorAll(selector)) {\r\n\t\t\tbutton?.classList.remove(\"shield-activated\");\r\n\t\t}\r\n\t}\r\n\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n}\r\n\r\n/**\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nasync function shiftAdjustDamage({\r\n\tmessage,\r\n\tmultiplier,\r\n\trollIndex,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/damage/adjustment-dialog.hbs\",\r\n\t);\r\n\tconst AdjustmentDialog = class extends Dialog {\r\n\t\tactivateListeners($html) {\r\n\t\t\tsuper.activateListeners($html);\r\n\t\t\t$html[0].querySelector(\"input\")?.focus();\r\n\t\t}\r\n\t};\r\n\tconst isHealing = multiplier < 0;\r\n\tnew AdjustmentDialog({\r\n\t\ttitle: game.i18n.localize(\r\n\t\t\tisHealing\r\n\t\t\t\t? \"PF2E.UI.shiftModifyHealingTitle\"\r\n\t\t\t\t: \"PF2E.UI.shiftModifyDamageTitle\",\r\n\t\t),\r\n\t\tcontent,\r\n\t\tbuttons: {\r\n\t\t\tok: {\r\n\t\t\t\tlabel: game.i18n.localize(\"PF2E.OK\"),\r\n\t\t\t\tcallback: async ($dialog) => {\r\n\t\t\t\t\t// In case of healing, multipler will have negative sign. The user will expect that positive\r\n\t\t\t\t\t// modifier would increase healing value, while negative would decrease.\r\n\t\t\t\t\tconst adjustment =\r\n\t\t\t\t\t\t(Number($dialog[0].querySelector(\"input\")?.value) || 0) *\r\n\t\t\t\t\t\tMath.sign(multiplier);\r\n\t\t\t\t\tapplyDamageFromMessage({\r\n\t\t\t\t\t\tmessage,\r\n\t\t\t\t\t\tmultiplier,\r\n\t\t\t\t\t\taddend: adjustment,\r\n\t\t\t\t\t\tpromptModifier: false,\r\n\t\t\t\t\t\trollIndex,\r\n\t\t\t\t\t\t// added\r\n\t\t\t\t\t\ttokens,\r\n\t\t\t\t\t\tonDamageApplied,\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tcancel: {\r\n\t\t\t\tlabel: \"Cancel\",\r\n\t\t\t},\r\n\t\t},\r\n\t\tdefault: \"ok\",\r\n\t\tclose: () => {\r\n\t\t\ttoggleOffShieldBlock(message.id);\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n\r\n/**\r\n * @param {Item} item\r\n * @param {string} rollMode\r\n * @returns {ChatMessage}\r\n */\r\nexport async function createSelfEffectMessage(item, rollMode = \"roll\") {\r\n\tif (!item.system.selfEffect) {\r\n\t\tthrow ErrorPF2e(\r\n\t\t\t[\r\n\t\t\t\t\"Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.\",\r\n\t\t\t\t\"Support will be expanded at a later time.\",\r\n\t\t\t].join(\" \"),\r\n\t\t);\r\n\t}\r\n\r\n\tconst { actor, actionCost } = item;\r\n\tconst token = actor.getActiveTokens(true, true).shift() ?? null;\r\n\r\n\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\tconst speaker = ChatMessagePF2e.getSpeaker({ actor, token });\r\n\tconst flavor = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/action/flavor.hbs\",\r\n\t\t{\r\n\t\t\taction: { title: item.name, glyph: getActionGlyph(actionCost) },\r\n\t\t\titem,\r\n\t\t\ttraits: item.system.traits.value.map((t) =>\r\n\t\t\t\ttraitSlugToObject(t, CONFIG.PF2E.actionTraits),\r\n\t\t\t),\r\n\t\t},\r\n\t);\r\n\r\n\t// Get a preview slice of the message\r\n\tconst previewLength = 100;\r\n\tconst descriptionPreview = (() => {\r\n\t\tif (item.actor.pack) return null;\r\n\t\tconst tempDiv = document.createElement(\"div\");\r\n\t\tconst documentTypes = [...CONST.DOCUMENT_LINK_TYPES, \"Compendium\", \"UUID\"];\r\n\t\tconst linkPattern = new RegExp(\r\n\t\t\t`@(${documentTypes.join(\r\n\t\t\t\t\"|\",\r\n\t\t\t)})\\\\[([^#\\\\]]+)(?:#([^\\\\]]+))?](?:{([^}]+)})?`,\r\n\t\t\t\"g\",\r\n\t\t);\r\n\t\ttempDiv.innerHTML = item.description.replace(\r\n\t\t\tlinkPattern,\r\n\t\t\t(_match, ...args) => args[3],\r\n\t\t);\r\n\r\n\t\treturn tempDiv.innerText.slice(0, previewLength);\r\n\t})();\r\n\tconst description = {\r\n\t\tfull:\r\n\t\t\tdescriptionPreview && descriptionPreview.length < previewLength\r\n\t\t\t\t? item.description\r\n\t\t\t\t: null,\r\n\t\tpreview: descriptionPreview,\r\n\t};\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/action/self-effect.hbs\",\r\n\t\t{\r\n\t\t\tactor: item.actor,\r\n\t\t\tdescription,\r\n\t\t},\r\n\t);\r\n\tconst flags = { pf2e: { context: { type: \"self-effect\", item: item.id } } };\r\n\tconst messageData = ChatMessagePF2e.applyRollMode(\r\n\t\t{ speaker, flavor, content, flags },\r\n\t\trollMode,\r\n\t);\r\n\r\n\treturn ChatMessagePF2e.create(messageData);\r\n}\r\n\r\n/**\r\n * @param {string} subtitle\r\n * @returns {Promise<string>}\r\n */\r\nexport function createManipulateFlavor(subtitle) {\r\n\treturn renderTemplate(\"systems/pf2e/templates/chat/action/flavor.hbs\", {\r\n\t\taction: {\r\n\t\t\ttitle: \"PF2E.Actions.Interact.Title\",\r\n\t\t\tsubtitle: subtitle,\r\n\t\t\tglyph: getActionGlyph(1),\r\n\t\t},\r\n\t\ttraits: [\r\n\t\t\t{\r\n\t\t\t\tname: \"manipulate\",\r\n\t\t\t\tlabel: CONFIG.PF2E.featTraits.manipulate,\r\n\t\t\t\tdescription: CONFIG.PF2E.traitsDescriptions.manipulate,\r\n\t\t\t},\r\n\t\t],\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {string} message\r\n * @param {string} img\r\n * @returns {Promise<string>}\r\n */\r\nexport function createTradeContent(message, img) {\r\n\treturn renderTemplate(\"systems/pf2e/templates/chat/action/content.hbs\", {\r\n\t\timgPath: img,\r\n\t\tmessage: message.replace(/\\b1 \u00D7 /, \"\"),\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {foundry.Document|string} docOrUuid\r\n * @param {object} [options]\r\n * @param {boolean} [options.async]\r\n * @param {string} [options.label]\r\n * @returns {Promise<string>}\r\n */\r\nexport function createFancyLink(docOrUuid, { async = true, label } = {}) {\r\n\tlet link =\r\n\t\tdocOrUuid instanceof foundry.abstract.Document\r\n\t\t\t? docOrUuid.link\r\n\t\t\t: `@UUID[${docOrUuid}]`;\r\n\tif (label) {\r\n\t\tlink = link.replace(/\\{.+?\\}$/, \"\");\r\n\t\tlink = `${link}{${label}}`;\r\n\t}\r\n\treturn TextEditor.enrichHTML(link, { async });\r\n}\r\n\r\n/**\r\n *\r\n * @param {string} subtitle\r\n * @param {string} content\r\n * @param {Actor} actor\r\n * @param {string} [senderId]\r\n * @returns {Promise<ChatMessage>}\r\n */\r\nexport async function createManipulationMessage(\r\n\tsubtitle,\r\n\tcontent,\r\n\tactor,\r\n\tsenderId,\r\n) {\r\n\treturn ChatMessage.implementation.create({\r\n\t\tuser: senderId ?? game.user.id,\r\n\t\tspeaker: ChatMessage.getSpeaker({\r\n\t\t\tactor,\r\n\t\t\talias: getHighestName(actor),\r\n\t\t}),\r\n\t\tflavor: await createManipulateFlavor(subtitle),\r\n\t\tcontent: content,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.EMOTE,\r\n\t});\r\n}\r\n\r\n/**\r\n *\r\n * @param {string} subtitle\r\n * @param {string} message\r\n * @param {Actor} actor\r\n * @param {Item} item\r\n * @param {string} [senderId]\r\n * @returns {Promise<ChatMessage>}\r\n */\r\nexport async function createTradeMessage(\r\n\tsubtitle,\r\n\tmessage,\r\n\tactor,\r\n\titem,\r\n\tsenderId,\r\n) {\r\n\tconst content = await createTradeContent(message, item.img);\r\n\treturn createManipulationMessage(subtitle, content, actor, senderId);\r\n}\r\n", "/**\r\n * @returns { new (...args: unknkown[]) => object}\r\n */\r\nexport function getDamageRollClass() {\r\n\treturn CONFIG.Dice.rolls.find((Roll) => Roll.name === \"DamageRoll\");\r\n}\r\n", "export const adjustmentScale = [\r\n\t\"incredibly-easy\",\r\n\t\"very-easy\",\r\n\t\"easy\",\r\n\t\"normal\",\r\n\t\"hard\",\r\n\t\"very-hard\",\r\n\t\"incredibly-hard\",\r\n];\r\n\r\nexport const dcAdjustments = new Map([\r\n\t[\"incredibly-easy\", -10],\r\n\t[\"very-easy\", -5],\r\n\t[\"easy\", -2],\r\n\t[\"normal\", 0],\r\n\t[\"hard\", 2],\r\n\t[\"very-hard\", 5],\r\n\t[\"incredibly-hard\", 10],\r\n]);\r\n\r\nexport const dcByLevel = new Map([\r\n\t[-1, 13],\r\n\t[0, 14],\r\n\t[1, 15],\r\n\t[2, 16],\r\n\t[3, 18],\r\n\t[4, 19],\r\n\t[5, 20],\r\n\t[6, 22],\r\n\t[7, 23],\r\n\t[8, 24],\r\n\t[9, 26],\r\n\t[10, 27],\r\n\t[11, 28],\r\n\t[12, 30],\r\n\t[13, 31],\r\n\t[14, 32],\r\n\t[15, 34],\r\n\t[16, 35],\r\n\t[17, 36],\r\n\t[18, 38],\r\n\t[19, 39],\r\n\t[20, 40],\r\n\t[21, 42],\r\n\t[22, 44],\r\n\t[23, 46],\r\n\t[24, 48],\r\n\t[25, 50],\r\n]);\r\n\r\nexport const simpleDCs = new Map([\r\n\t[\"untrained\", 10],\r\n\t[\"trained\", 15],\r\n\t[\"expert\", 20],\r\n\t[\"master\", 30],\r\n\t[\"legendary\", 40],\r\n]);\r\n\r\nexport const simpleDCsWithoutLevel = new Map([\r\n\t[\"untrained\", 10],\r\n\t[\"trained\", 15],\r\n\t[\"expert\", 20],\r\n\t[\"master\", 25],\r\n\t[\"legendary\", 30],\r\n]);\r\n\r\n/**\r\n * @typedef {\"untrained\" | \"trained\" | \"expert\" | \"master\" | \"legendary\"} Rank\r\n */\r\n\r\n/**\r\n * @typedef {\"common\" | \"uncommon\" | \"rare\" | \"unique\"} Rarity\r\n */\r\n\r\n/**\r\n * @param {number} level\r\n * @returns {number}\r\n */\r\nexport function getDcByLevel(level) {\r\n\tconst clamped = Math.clamped(level, -1, 25);\r\n\treturn dcByLevel.get(clamped);\r\n}\r\n\r\n/**\r\n * @param {number} level\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @param {Rarity} [options.rarity]\r\n * @returns {number}\r\n */\r\nexport function calculateDC(level, { pwol, rarity = \"common\" } = {}) {\r\n\tpwol ??= game.pf2e.settings.variants.pwol.enabled;\r\n\r\n\t// assume level 0 if garbage comes in. We cast level to number because the backing data may actually have it\r\n\t// stored as a string, which we can't catch at compile time\r\n\tconst dc = dcByLevel.get(level) ?? 14;\r\n\tif (pwol) {\r\n\t\t// -1 shouldn't be subtracted since it's just\r\n\t\t// a creature level and not related to PC levels\r\n\t\treturn adjustDCByRarity(dc - Math.max(level, 0), rarity);\r\n\t}\r\n\r\n\treturn adjustDCByRarity(dc, rarity);\r\n}\r\n\r\n/**\r\n *\r\n * @param {Rank} rank\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @returns {number}\r\n */\r\nexport function calculateSimpleDC(rank, { pwol = false } = {}) {\r\n\tif (pwol) {\r\n\t\treturn simpleDCsWithoutLevel.get(rank) ?? 10;\r\n\t}\r\n\r\n\treturn simpleDCs.get(rank) ?? 10;\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} spellLevel\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @returns {number}\r\n */\r\nexport function calculateSpellDC(spellLevel, { pwol = false } = {}) {\r\n\treturn calculateDC(spellLevel * 2 - 1, { pwol });\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} dc\r\n * @param {Rarity} rarity\r\n * @returns {number}\r\n */\r\nexport function adjustDCByRarity(dc, rarity = \"common\") {\r\n\treturn adjustDC(dc, rarityToDCAdjustment(rarity));\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} dc\r\n * @param {Rarity} adjustment\r\n * @returns {number}\r\n */\r\nexport function adjustDC(dc, adjustment = \"normal\") {\r\n\treturn dc + (dcAdjustments.get(adjustment) ?? 0);\r\n}\r\n\r\n/**\r\n * @param {Rarity} rarity\r\n * @returns {\"hard\" | \"normal\" | \"very-hard\" | \"incredibly-hard\"}\r\n */\r\nexport function rarityToDCAdjustment(rarity = \"common\") {\r\n\tswitch (rarity) {\r\n\t\tcase \"uncommon\":\r\n\t\t\treturn \"hard\";\r\n\t\tcase \"rare\":\r\n\t\t\treturn \"very-hard\";\r\n\t\tcase \"unique\":\r\n\t\t\treturn \"incredibly-hard\";\r\n\t\tdefault:\r\n\t\t\treturn \"normal\";\r\n\t}\r\n}\r\n", "export const EFFECT_AREA_SHAPES = [\r\n\t\"burst\",\r\n\t\"cone\",\r\n\t\"cube\",\r\n\t\"cylinder\",\r\n\t\"emanation\",\r\n\t\"line\",\r\n\t\"square\",\r\n];\r\n\r\nexport const MAGIC_TRADITIONS = new Set([\r\n\t\"arcane\",\r\n\t\"divine\",\r\n\t\"occult\",\r\n\t\"primal\",\r\n]);\r\n\r\nexport const traditionSkills = {\r\n\tarcane: \"arcana\",\r\n\tdivine: \"religion\",\r\n\toccult: \"occultism\",\r\n\tprimal: \"nature\",\r\n};\r\n\r\n/**\r\n * @param {string} groupId\r\n * @returns {number|null}\r\n */\r\nexport function spellSlotGroupIdToNumber(groupId) {\r\n\tif (groupId === \"cantrips\") return 0;\r\n\tconst numericValue = Number(groupId ?? NaN);\r\n\treturn numericValue.between(0, 10) ? numericValue : null;\r\n}\r\n\r\n/**\r\n * @param {string} value\r\n * @returns {number|null}\r\n */\r\nexport function coerceToSpellGroupId(value) {\r\n\tif (value === \"cantrips\") return value;\r\n\tconst numericValue = Number(value) || NaN;\r\n\treturn numericValue.between(1, 10) ? numericValue : null;\r\n}\r\n", "import { adjustDCByRarity, calculateDC } from \"./dc\";\r\nimport { setHasElement } from \"./misc\";\r\nimport { MAGIC_TRADITIONS } from \"./spell\";\r\n\r\nexport class IdentifyItemPopup extends FormApplication {\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"identify-item\",\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.identification.Identify\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/actors/identify-item.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tclasses: [\"identify-popup\"],\r\n\t\t};\r\n\t}\r\n\r\n\tdcs = getItemIdentificationDCs(this.object, {\r\n\t\tpwol: game.pf2e.settings.variants.pwol.enabled,\r\n\t\tnotMatchingTraditionModifier: game.settings.get(\r\n\t\t\t\"pf2e\",\r\n\t\t\t\"identifyMagicNotMatchingTraditionModifier\",\r\n\t\t),\r\n\t});\r\n\r\n\tasync getData() {\r\n\t\tconst item = this.object;\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tisMagic: item.isMagical,\r\n\t\t\tisAlchemical: item.isAlchemical,\r\n\t\t\tdcs: this.dcs,\r\n\t\t};\r\n\t}\r\n\r\n\tactivateListeners($html) {\r\n\t\tconst html = $html[0];\r\n\r\n\t\tconst updateButton =\r\n\t\t\thtml.querySelector < HTMLButtonElement > \"button.update-identification\";\r\n\t\tupdateButton?.addEventListener(\"click\", () => {\r\n\t\t\tthis.submit({ updateData: { status: updateButton.value } });\r\n\t\t});\r\n\r\n\t\t// Add listener on Post skill checks to chat button that posts item unidentified img and name and skill checks\r\n\t\thtml\r\n\t\t\t.querySelector(\"button.post-skill-checks\")\r\n\t\t\t?.addEventListener(\"click\", async () => {\r\n\t\t\t\tconst item = this.object;\r\n\t\t\t\tconst identifiedName = item.system.identification.identified.name;\r\n\t\t\t\tconst dcs = this.dcs;\r\n\t\t\t\tconst action = item.isMagical\r\n\t\t\t\t\t? \"identify-magic\"\r\n\t\t\t\t\t: item.isAlchemical\r\n\t\t\t\t\t  ? \"identify-alchemy\"\r\n\t\t\t\t\t  : \"recall-knowledge\";\r\n\r\n\t\t\t\tconst content = await renderTemplate(\r\n\t\t\t\t\t\"systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs\",\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tidentifiedName,\r\n\t\t\t\t\t\taction,\r\n\t\t\t\t\t\tskills: R.omit(dcs, [\"dc\"]),\r\n\t\t\t\t\t\tunidentified: item.system.identification.unidentified,\r\n\t\t\t\t\t\tuuid: item.uuid,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tawait ChatMessage.implementation.create({\r\n\t\t\t\t\tuser: game.user.id,\r\n\t\t\t\t\tcontent,\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tconst status = formData.status;\r\n\t\tif (status === \"identified\") {\r\n\t\t\treturn this.object.setIdentificationStatus(status);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function getItemIdentificationDCs(\r\n\titem,\r\n\t{ pwol = false, notMatchingTraditionModifier },\r\n) {\r\n\tconst baseDC = calculateDC(item.level, { pwol });\r\n\tconst rarity = getDcRarity(item);\r\n\tconst dc = adjustDCByRarity(baseDC, rarity);\r\n\tif (item.isMagical) {\r\n\t\treturn getIdentifyMagicDCs(item, dc, notMatchingTraditionModifier);\r\n\t}\r\n\r\n\treturn { crafting: dc };\r\n}\r\n\r\n/**\r\n *\r\n * @param {Item} item\r\n * @returns {import('./dc').Rarity}\r\n */\r\nfunction getDcRarity(item) {\r\n\treturn item.traits.has(\"cursed\") ? \"unique\" : item.rarity;\r\n}\r\n\r\n/**\r\n *\r\n * @param {PhysicalItemPF2e} item\r\n * @param {number} baseDC\r\n * @param {number} notMatchingTraditionModifier\r\n * @returns {{arcana: number; nature: number; occultism: number; religion: number;}}\r\n */\r\nfunction getIdentifyMagicDCs(item, baseDC, notMatchingTraditionModifier) {\r\n\tconst result = {\r\n\t\toccult: baseDC,\r\n\t\tprimal: baseDC,\r\n\t\tdivine: baseDC,\r\n\t\tarcane: baseDC,\r\n\t};\r\n\tconst traditions = getMagicTraditions(item);\r\n\tfor (const key of MAGIC_TRADITIONS) {\r\n\t\t// once an item has a magic tradition, all skills\r\n\t\t// that don't match the tradition are hard\r\n\t\tif (traditions.size > 0 && !traditions.has(key)) {\r\n\t\t\tresult[key] = baseDC + notMatchingTraditionModifier;\r\n\t\t}\r\n\t}\r\n\treturn {\r\n\t\tarcana: result.arcane,\r\n\t\tnature: result.primal,\r\n\t\treligion: result.divine,\r\n\t\toccultism: result.occult,\r\n\t};\r\n}\r\n\r\n/**\r\n * @param {PhysicalItemPF2e} item\r\n * @returns {MAGIC_TRADITIONS}\r\n */\r\nfunction getMagicTraditions(item) {\r\n\tconst traits = item.system.traits.value;\r\n\treturn new Set(traits.filter((t) => setHasElement(MAGIC_TRADITIONS, t)));\r\n}\r\n", "import * as R from \"remeda\";\r\nimport { getSelectedActors } from \"./actor\";\r\nimport { calculateDC } from \"./dc\";\r\nimport { htmlClosest, htmlQueryAll } from \"./html\";\r\nimport { ErrorPF2e, getActionGlyph, sluggify, tupleHasValue } from \"./misc\";\r\nimport { eventToRollParams } from \"./scripts\";\r\nimport { EFFECT_AREA_SHAPES } from \"./spell\";\r\n\r\nconst SAVE_TYPES = [\"fortitude\", \"reflex\", \"will\"];\r\nconst inlineSelector = [\"action\", \"check\", \"effect-area\"]\r\n\t.map((keyword) => `[data-pf2-${keyword}]`)\r\n\t.join(\",\");\r\n\r\nexport const InlineRollLinks = {\r\n\tinjectRepostElement: (links, foundryDoc) => {\r\n\t\tfor (const link of links) {\r\n\t\t\tif (!foundryDoc || foundryDoc.isOwner) link.classList.add(\"with-repost\");\r\n\r\n\t\t\tconst repostButtons = htmlQueryAll(link, \"i[data-pf2-repost]\");\r\n\t\t\tif (repostButtons.length > 0) {\r\n\t\t\t\tif (foundryDoc && !foundryDoc.isOwner) {\r\n\t\t\t\t\tfor (const button of repostButtons) {\r\n\t\t\t\t\t\tbutton.remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlink.classList.remove(\"with-repost\");\r\n\t\t\t\t}\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (foundryDoc && !foundryDoc.isOwner) continue;\r\n\r\n\t\t\tconst newButton = document.createElement(\"i\");\r\n\t\t\tconst icon =\r\n\t\t\t\tlink.parentElement?.dataset?.pf2Checkgroup !== undefined\r\n\t\t\t\t\t? \"fa-comment-alt-dots\"\r\n\t\t\t\t\t: \"fa-comment-alt\";\r\n\t\t\tnewButton.classList.add(\"fa-solid\", icon);\r\n\t\t\tnewButton.dataset.pf2Repost = \"\";\r\n\t\t\tnewButton.title = game.i18n.localize(\"PF2E.Repost\");\r\n\t\t\tlink.appendChild(newButton);\r\n\r\n\t\t\tnewButton.addEventListener(\"click\", (event) => {\r\n\t\t\t\tevent.stopPropagation();\r\n\t\t\t\tconst target = event.target;\r\n\t\t\t\tif (!(target instanceof HTMLElement)) return;\r\n\t\t\t\tconst parent = target?.parentElement;\r\n\t\t\t\tif (!parent) return;\r\n\r\n\t\t\t\tconst document = resolveDocument(target, foundryDoc);\r\n\t\t\t\tInlineRollLinks.repostAction(parent, document);\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\r\n\tlisten: (html, foundryDoc = resolveDocument(html)) => {\r\n\t\tconst links = htmlQueryAll(html, inlineSelector).filter((l) =>\r\n\t\t\t[\"A\", \"SPAN\"].includes(l.nodeName),\r\n\t\t);\r\n\t\tInlineRollLinks.injectRepostElement(links, foundryDoc);\r\n\r\n\t\tInlineRollLinks.flavorDamageRolls(\r\n\t\t\thtml,\r\n\t\t\tfoundryDoc instanceof Actor ? foundryDoc : null,\r\n\t\t);\r\n\r\n\t\tfor (const link of links.filter((l) => l.dataset.pf2Action)) {\r\n\t\t\tconst { pf2Action, pf2Glyph, pf2Variant, pf2Dc, pf2ShowDc, pf2Skill } =\r\n\t\t\t\tlink.dataset;\r\n\t\t\tlink.addEventListener(\"click\", (event) => {\r\n\t\t\t\tconst slug = sluggify(pf2Action ?? \"\");\r\n\t\t\t\tconst visibility = pf2ShowDc ?? \"all\";\r\n\t\t\t\tconst difficultyClass = Number.isNumeric(pf2Dc)\r\n\t\t\t\t\t? { scope: \"check\", value: Number(pf2Dc) || 0, visibility }\r\n\t\t\t\t\t: pf2Dc;\r\n\t\t\t\tif (slug && game.pf2e.actions.has(slug)) {\r\n\t\t\t\t\tgame.pf2e.actions\r\n\t\t\t\t\t\t.get(slug)\r\n\t\t\t\t\t\t?.use({\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t\tvariant: pf2Variant,\r\n\t\t\t\t\t\t\tdifficultyClass,\r\n\t\t\t\t\t\t\tstatistic: pf2Skill,\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\t.catch((reason) => ui.notifications.warn(reason));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst action =\r\n\t\t\t\t\t\tgame.pf2e.actions[\r\n\t\t\t\t\t\t\tpf2Action ? sluggify(pf2Action, { camel: \"dromedary\" }) : \"\"\r\n\t\t\t\t\t\t];\r\n\t\t\t\t\tif (pf2Action && action) {\r\n\t\t\t\t\t\taction({\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t\tglyph: pf2Glyph,\r\n\t\t\t\t\t\t\tvariant: pf2Variant,\r\n\t\t\t\t\t\t\tdifficultyClass,\r\n\t\t\t\t\t\t\tskill: pf2Skill,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\t`PF2e System | Skip executing unknown action '${pf2Action}'`,\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfor (const link of links.filter(\r\n\t\t\t(l) => l.dataset.pf2Check && !l.dataset.invalid,\r\n\t\t)) {\r\n\t\t\tconst {\r\n\t\t\t\tpf2Check,\r\n\t\t\t\tpf2Dc,\r\n\t\t\t\tpf2Traits,\r\n\t\t\t\tpf2Label,\r\n\t\t\t\tpf2Defense,\r\n\t\t\t\tpf2Adjustment,\r\n\t\t\t\tpf2Roller,\r\n\t\t\t\tpf2RollOptions,\r\n\t\t\t} = link.dataset;\r\n\t\t\tconst overrideTraits = \"overrideTraits\" in link.dataset;\r\n\t\t\tconst targetOwner = \"targetOwner\" in link.dataset;\r\n\r\n\t\t\tif (!pf2Check) return;\r\n\r\n\t\t\tlink.addEventListener(\"click\", async (event) => {\r\n\t\t\t\tconst parent = resolveActor(foundryDoc, link);\r\n\t\t\t\t// const actors = [parent];\r\n\t\t\t\tconst actors = (() => {\r\n\t\t\t\t\tswitch (pf2Roller) {\r\n\t\t\t\t\t\tcase \"self\":\r\n\t\t\t\t\t\t\treturn parent?.canUserModify(game.user, \"update\") ? [parent] : [];\r\n\t\t\t\t\t\tcase \"party\":\r\n\t\t\t\t\t\t\tif (parent?.isOfType(\"party\")) return [parent];\r\n\t\t\t\t\t\t\treturn R.compact([game.actors.party]);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Use the DOM document as a fallback if it's an actor and the check isn't a saving throw\r\n\t\t\t\t\tconst sheetActor = (() => {\r\n\t\t\t\t\t\tconst maybeActor =\r\n\t\t\t\t\t\t\tfoundryDoc instanceof Actor\r\n\t\t\t\t\t\t\t\t? foundryDoc\r\n\t\t\t\t\t\t\t\t: foundryDoc instanceof Item && foundryDoc.actor\r\n\t\t\t\t\t\t\t\t  ? foundryDoc.actor\r\n\t\t\t\t\t\t\t\t  : null;\r\n\t\t\t\t\t\treturn maybeActor?.isOwner && !maybeActor.isOfType(\"loot\", \"party\")\r\n\t\t\t\t\t\t\t? maybeActor\r\n\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t})();\r\n\t\t\t\t\tconst rollingActors = [\r\n\t\t\t\t\t\tsheetActor ??\r\n\t\t\t\t\t\t\tgetSelectedActors({ exclude: [\"loot\"], assignedFallback: true }),\r\n\t\t\t\t\t].flat();\r\n\r\n\t\t\t\t\tconst isSave = tupleHasValue(SAVE_TYPES, pf2Check);\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tparent?.isOfType(\"party\") ||\r\n\t\t\t\t\t\t(rollingActors.length === 0 && parent && !isSave)\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\treturn [parent];\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn rollingActors;\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tif (actors.length === 0) {\r\n\t\t\t\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\t\t\t\tlocalize: true,\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst extraRollOptions = [\r\n\t\t\t\t\t...(pf2Traits?.split(\",\").map((o) => o.trim()) ?? []),\r\n\t\t\t\t\t...(pf2RollOptions?.split(\",\").map((o) => o.trim()) ?? []),\r\n\t\t\t\t];\r\n\t\t\t\tconst eventRollParams = eventToRollParams(event, { type: \"check\" });\r\n\t\t\t\tconst checkSlug = link.dataset.slug\r\n\t\t\t\t\t? sluggify(link.dataset.slug)\r\n\t\t\t\t\t: null;\r\n\r\n\t\t\t\tswitch (pf2Check) {\r\n\t\t\t\t\tcase \"flat\": {\r\n\t\t\t\t\t\tfor (const actor of actors) {\r\n\t\t\t\t\t\t\tconst flatCheck = new actor.saves.reflex.constructor(actor, {\r\n\t\t\t\t\t\t\t\tlabel: \"\",\r\n\t\t\t\t\t\t\t\tslug: \"flat\",\r\n\t\t\t\t\t\t\t\tmodifiers: [],\r\n\t\t\t\t\t\t\t\tcheck: { type: \"flat-check\" },\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst dc = Number.isInteger(Number(pf2Dc))\r\n\t\t\t\t\t\t\t\t? { label: pf2Label, value: Number(pf2Dc) }\r\n\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\tflatCheck.roll({\r\n\t\t\t\t\t\t\t\t...eventRollParams,\r\n\t\t\t\t\t\t\t\tslug: checkSlug,\r\n\t\t\t\t\t\t\t\textraRollOptions,\r\n\t\t\t\t\t\t\t\tdc,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdefault: {\r\n\t\t\t\t\t\tconst isSavingThrow = tupleHasValue(SAVE_TYPES, pf2Check);\r\n\r\n\t\t\t\t\t\t// Get actual traits for display in chat cards\r\n\t\t\t\t\t\tconst traits = isSavingThrow\r\n\t\t\t\t\t\t\t? []\r\n\t\t\t\t\t\t\t: extraRollOptions.filter((t) => t in CONFIG.PF2E.actionTraits) ??\r\n\t\t\t\t\t\t\t  [];\r\n\r\n\t\t\t\t\t\tfor (const actor of actors) {\r\n\t\t\t\t\t\t\tconst statistic = (() => {\r\n\t\t\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t\t\tpf2Check in CONFIG.PF2E.magicTraditions &&\r\n\t\t\t\t\t\t\t\t\tactor.isOfType(\"creature\")\r\n\t\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\t\tconst bestSpellcasting =\r\n\t\t\t\t\t\t\t\t\t\tactor.spellcasting\r\n\t\t\t\t\t\t\t\t\t\t\t.filter((c) => c.tradition === pf2Check)\r\n\t\t\t\t\t\t\t\t\t\t\t.flatMap((s) => s.statistic ?? [])\r\n\t\t\t\t\t\t\t\t\t\t\t.sort((a, b) => b.check.mod - a.check.mod)\r\n\t\t\t\t\t\t\t\t\t\t\t.shift() ?? null;\r\n\t\t\t\t\t\t\t\t\tif (bestSpellcasting) return bestSpellcasting;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\treturn actor.getStatistic(pf2Check);\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tif (!statistic) {\r\n\t\t\t\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\t\t\tErrorPF2e(`Skip rolling unknown statistic ${pf2Check}`)\r\n\t\t\t\t\t\t\t\t\t\t.message,\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tconst targetActor = pf2Defense\r\n\t\t\t\t\t\t\t\t? targetOwner\r\n\t\t\t\t\t\t\t\t\t? parent\r\n\t\t\t\t\t\t\t\t\t: game.user.targets.first()?.actor\r\n\t\t\t\t\t\t\t\t: null;\r\n\r\n\t\t\t\t\t\t\tconst dcValue = (() => {\r\n\t\t\t\t\t\t\t\tconst adjustment = Number(pf2Adjustment) || 0;\r\n\t\t\t\t\t\t\t\tif (pf2Dc === \"@self.level\") {\r\n\t\t\t\t\t\t\t\t\treturn calculateDC(actor.level) + adjustment;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\treturn Number(pf2Dc ?? \"NaN\") + adjustment;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tconst dc = (() => {\r\n\t\t\t\t\t\t\t\tif (Number.isInteger(dcValue)) {\r\n\t\t\t\t\t\t\t\t\treturn { label: pf2Label, value: dcValue };\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\tif (pf2Defense) {\r\n\t\t\t\t\t\t\t\t\tconst defenseStat = targetActor?.getStatistic(pf2Defense);\r\n\t\t\t\t\t\t\t\t\treturn defenseStat\r\n\t\t\t\t\t\t\t\t\t\t? {\r\n\t\t\t\t\t\t\t\t\t\t\t\tstatistic: defenseStat.dc,\r\n\t\t\t\t\t\t\t\t\t\t\t\tscope: \"check\",\r\n\t\t\t\t\t\t\t\t\t\t\t\tvalue: defenseStat.dc.value,\r\n\t\t\t\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\t// Retrieve the item if:\r\n\t\t\t\t\t\t\t// (2) The item is an action or,\r\n\t\t\t\t\t\t\t// (1) The check is a saving throw and the item is not a weapon.\r\n\t\t\t\t\t\t\t// Exclude weapons so that roll notes on strikes from incapacitation abilities continue to work.\r\n\t\t\t\t\t\t\tconst item = (() => {\r\n\t\t\t\t\t\t\t\tconst itemFromDoc =\r\n\t\t\t\t\t\t\t\t\tfoundryDoc instanceof Item\r\n\t\t\t\t\t\t\t\t\t\t? foundryDoc\r\n\t\t\t\t\t\t\t\t\t\t: foundryDoc instanceof ChatMessage\r\n\t\t\t\t\t\t\t\t\t\t  ? foundryDoc.item\r\n\t\t\t\t\t\t\t\t\t\t  : null;\r\n\r\n\t\t\t\t\t\t\t\treturn itemFromDoc?.isOfType(\r\n\t\t\t\t\t\t\t\t\t\"action\",\r\n\t\t\t\t\t\t\t\t\t\"feat\",\r\n\t\t\t\t\t\t\t\t\t\"campaignFeature\",\r\n\t\t\t\t\t\t\t\t) ||\r\n\t\t\t\t\t\t\t\t\t(isSavingThrow && !itemFromDoc?.isOfType(\"weapon\"))\r\n\t\t\t\t\t\t\t\t\t? itemFromDoc\r\n\t\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tconst args = {\r\n\t\t\t\t\t\t\t\t...eventRollParams,\r\n\t\t\t\t\t\t\t\textraRollOptions,\r\n\t\t\t\t\t\t\t\torigin:\r\n\t\t\t\t\t\t\t\t\tisSavingThrow && parent instanceof Actor ? parent : null,\r\n\t\t\t\t\t\t\t\tdc,\r\n\t\t\t\t\t\t\t\ttarget: !isSavingThrow && dc?.statistic ? targetActor : null,\r\n\t\t\t\t\t\t\t\titem,\r\n\t\t\t\t\t\t\t\ttraits,\r\n\t\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\t\t// Use a special header for checks against defenses\r\n\t\t\t\t\t\t\tconst itemIsEncounterAction =\r\n\t\t\t\t\t\t\t\t!overrideTraits &&\r\n\t\t\t\t\t\t\t\t!!(item?.isOfType(\"action\", \"feat\") && item.actionCost) &&\r\n\t\t\t\t\t\t\t\t![\"flat-check\", \"saving-throw\"].includes(statistic.check.type);\r\n\t\t\t\t\t\t\tif (itemIsEncounterAction) {\r\n\t\t\t\t\t\t\t\tconst subtitleLocKey =\r\n\t\t\t\t\t\t\t\t\tpf2Check in CONFIG.PF2E.magicTraditions\r\n\t\t\t\t\t\t\t\t\t\t? \"PF2E.ActionsCheck.spell\"\r\n\t\t\t\t\t\t\t\t\t\t: statistic.check.type === \"attack-roll\"\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.ActionsCheck.x-attack-roll\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.ActionsCheck.x\";\r\n\t\t\t\t\t\t\t\targs.label = await renderTemplate(\r\n\t\t\t\t\t\t\t\t\t\"systems/pf2e/templates/chat/action/header.hbs\",\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\tglyph: getActionGlyph(item.actionCost),\r\n\t\t\t\t\t\t\t\t\t\tsubtitle: game.i18n.format(subtitleLocKey, {\r\n\t\t\t\t\t\t\t\t\t\t\ttype: statistic.label,\r\n\t\t\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t\t\t\ttitle: item.name,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\textraRollOptions.push(...createActionOptions(item));\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tstatistic.roll(args);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst templateConversion = {\r\n\t\t\tburst: \"circle\",\r\n\t\t\tcone: \"cone\",\r\n\t\t\tcube: \"rect\",\r\n\t\t\temanation: \"circle\",\r\n\t\t\tline: \"ray\",\r\n\t\t\trect: \"rect\",\r\n\t\t\tsquare: \"rect\",\r\n\t\t};\r\n\r\n\t\tfor (const link of links.filter((l) =>\r\n\t\t\tl.hasAttribute(\"data-pf2-effect-area\"),\r\n\t\t)) {\r\n\t\t\tconst {\r\n\t\t\t\tpf2EffectArea,\r\n\t\t\t\tpf2Distance,\r\n\t\t\t\tpf2TemplateData,\r\n\t\t\t\tpf2Traits,\r\n\t\t\t\tpf2Width,\r\n\t\t\t} = link.dataset;\r\n\t\t\tlink.addEventListener(\"click\", () => {\r\n\t\t\t\tif (!canvas.ready) return;\r\n\r\n\t\t\t\tif (typeof pf2EffectArea !== \"string\") {\r\n\t\t\t\t\tconsole.warn(`PF2e System | Could not create template'`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst data = JSON.parse(pf2TemplateData ?? \"{}\");\r\n\t\t\t\tdata.distance ||= Number(pf2Distance);\r\n\t\t\t\tdata.fillColor ||= game.user.color;\r\n\t\t\t\tdata.t = templateConversion[pf2EffectArea];\r\n\r\n\t\t\t\tswitch (data.t) {\r\n\t\t\t\t\tcase \"ray\":\r\n\t\t\t\t\t\tdata.width =\r\n\t\t\t\t\t\t\tNumber(pf2Width) ||\r\n\t\t\t\t\t\t\tCONFIG.MeasuredTemplate.defaults.width *\r\n\t\t\t\t\t\t\t\tcanvas.dimensions.distance;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"cone\":\r\n\t\t\t\t\t\tdata.angle ||= CONFIG.MeasuredTemplate.defaults.angle;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"rect\": {\r\n\t\t\t\t\t\tconst distance = data.distance ?? 0;\r\n\t\t\t\t\t\tdata.distance = Math.hypot(distance, distance);\r\n\t\t\t\t\t\tdata.width = distance;\r\n\t\t\t\t\t\tdata.direction = 45;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst flags = {\r\n\t\t\t\t\tpf2e: {},\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst normalSize = (Math.ceil(data.distance) / 5) * 5 || 5;\r\n\t\t\t\tif (\r\n\t\t\t\t\ttupleHasValue(EFFECT_AREA_SHAPES, pf2EffectArea) &&\r\n\t\t\t\t\tdata.distance === normalSize\r\n\t\t\t\t) {\r\n\t\t\t\t\tflags.pf2e.areaShape = pf2EffectArea;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst messageId =\r\n\t\t\t\t\tfoundryDoc instanceof ChatMessage\r\n\t\t\t\t\t\t? foundryDoc.id\r\n\t\t\t\t\t\t: htmlClosest(html, \"[data-message-id]\")?.dataset.messageId ?? null;\r\n\t\t\t\tif (messageId) {\r\n\t\t\t\t\tflags.pf2e.messageId = messageId;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst actor = resolveActor(foundryDoc, link);\r\n\t\t\t\tif (actor || pf2Traits) {\r\n\t\t\t\t\tconst origin = {};\r\n\t\t\t\t\tif (actor) {\r\n\t\t\t\t\t\torigin.actor = actor.uuid;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (pf2Traits) {\r\n\t\t\t\t\t\torigin.traits = pf2Traits.split(\",\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tflags.pf2e.origin = origin;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!R.isEmpty(flags.pf2e)) {\r\n\t\t\t\t\tdata.flags = flags;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcanvas.templates.createPreview(data);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfor (const link of html.querySelectorAll(\"a[data-damage-roll]\")) {\r\n\t\t\tlink.dataset.itemUuid = foundryDoc.uuid;\r\n\t\t}\r\n\t},\r\n\r\n\tmakeRepostHtml: (target, defaultVisibility) => {\r\n\t\tconst flavor = game.i18n.localize(target.dataset.pf2RepostFlavor ?? \"\");\r\n\t\tconst showDC = target.dataset.pf2ShowDc ?? defaultVisibility;\r\n\t\treturn `<span data-visibility=\"${showDC}\">${flavor}</span> ${target.outerHTML}`.trim();\r\n\t},\r\n\r\n\trepostAction: async (target, foundryDoc = null) => {\r\n\t\tif (\r\n\t\t\t![\"pf2Action\", \"pf2Check\", \"pf2EffectArea\"].some(\r\n\t\t\t\t(d) => d in target.dataset,\r\n\t\t\t)\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst actor = resolveActor(foundryDoc, target);\r\n\t\tconst defaultVisibility = (actor ?? foundryDoc)?.hasPlayerOwner\r\n\t\t\t? \"all\"\r\n\t\t\t: \"gm\";\r\n\t\tconst content = (() => {\r\n\t\t\tif (target.parentElement?.dataset?.pf2Checkgroup !== undefined) {\r\n\t\t\t\tconst content = htmlQueryAll(target.parentElement, inlineSelector)\r\n\t\t\t\t\t.map((target) =>\r\n\t\t\t\t\t\tInlineRollLinks.makeRepostHtml(target, defaultVisibility),\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.join(\"<br>\");\r\n\r\n\t\t\t\treturn `<div data-pf2-checkgroup>${content}</div>`;\r\n\t\t\t}\r\n\r\n\t\t\treturn InlineRollLinks.makeRepostHtml(target, defaultVisibility);\r\n\t\t})();\r\n\r\n\t\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\t\tconst speaker = actor\r\n\t\t\t? ChatMessagePF2e.getSpeaker({\r\n\t\t\t\t\tactor,\r\n\t\t\t\t\ttoken: actor.getActiveTokens(true, true).shift(),\r\n\t\t\t  })\r\n\t\t\t: ChatMessagePF2e.getSpeaker();\r\n\r\n\t\t// If the originating document is a journal entry, include its UUID as a flag. If a chat message, copy over\r\n\t\t// the origin flag.\r\n\t\tconst message = game.messages.get(\r\n\t\t\thtmlClosest(target, \"[data-message-id]\")?.dataset.messageId ?? \"\",\r\n\t\t);\r\n\t\tconst flags =\r\n\t\t\tfoundryDoc instanceof JournalEntry\r\n\t\t\t\t? { pf2e: { journalEntry: foundryDoc.uuid } }\r\n\t\t\t\t: message?.flags.pf2e.origin\r\n\t\t\t\t  ? { pf2e: { origin: fu.deepClone(message.flags.pf2e.origin) } }\r\n\t\t\t\t  : {};\r\n\r\n\t\treturn ChatMessagePF2e.create({ speaker, content, flags });\r\n\t},\r\n\r\n\t/** Give inline damage-roll links from items flavor text of the item name */\r\n\tflavorDamageRolls(html, actor = null) {\r\n\t\tfor (const rollLink of htmlQueryAll(\r\n\t\t\thtml,\r\n\t\t\t\"a.inline-roll[data-damage-roll]\",\r\n\t\t)) {\r\n\t\t\tconst itemId = htmlClosest(rollLink, \"[data-item-id]\")?.dataset.itemId;\r\n\t\t\tconst item = actor?.items.get(itemId ?? \"\");\r\n\t\t\tif (item) rollLink.dataset.flavor ||= item.name;\r\n\t\t}\r\n\t},\r\n};\r\n\r\n/** If the provided document exists returns it, otherwise attempt to derive it from the sheet */\r\nfunction resolveDocument(html, foundryDoc) {\r\n\tif (foundryDoc) return foundryDoc;\r\n\r\n\tconst sheet =\r\n\t\tui.windows[Number(html.closest(\".app.sheet\")?.dataset.appid)] ?? null;\r\n\r\n\tconst document = sheet?.document;\r\n\treturn document instanceof Actor || document instanceof JournalEntry\r\n\t\t? document\r\n\t\t: null;\r\n}\r\n\r\n/** Retrieve an actor via a passed document or item UUID in the dataset of a link */\r\nfunction resolveActor(foundryDoc, anchor) {\r\n\tif (foundryDoc instanceof Actor) return foundryDoc;\r\n\tif (foundryDoc instanceof Item || foundryDoc instanceof ChatMessage)\r\n\t\treturn foundryDoc.actor;\r\n\r\n\t// Retrieve item/actor from anywhere via UUID\r\n\tconst itemUuid = anchor.dataset.itemUuid;\r\n\tconst itemByUUID =\r\n\t\titemUuid && !itemUuid.startsWith(\"Compendium.\")\r\n\t\t\t? fromUuidSync(itemUuid)\r\n\t\t\t: null;\r\n\treturn itemByUUID instanceof Item ? itemByUUID.actor : null;\r\n}\r\n\r\n/** Create roll options with information about the action being used */\r\nfunction createActionOptions(item, extra = []) {\r\n\tif (!item?.isOfType(\"action\", \"feat\") || !item.actionCost) return [];\r\n\r\n\tconst slug = item.slug ?? sluggify(item.name);\r\n\tconst traits = R.uniq(\r\n\t\t[\r\n\t\t\titem.system.traits.value,\r\n\t\t\textra.filter((t) => t in CONFIG.PF2E.actionTraits),\r\n\t\t].flat(),\r\n\t);\r\n\tconst actionCost = item.actionCost.value;\r\n\r\n\treturn R.compact([\r\n\t\t`action:${slug}`,\r\n\t\t`action:cost:${actionCost}`,\r\n\t\t`self:action:slug:${slug}`,\r\n\t\t`self:action:cost:${actionCost}`,\r\n\t\t...traits.map((t) => `self:action:trait:${t}`),\r\n\t]);\r\n}\r\n", "import { createHTMLElement, htmlClosest } from \"./html\";\r\nimport { ErrorPF2e, localizer, setHasElement, sluggify } from \"./misc\";\r\nimport { eventToRollMode } from \"./scripts\";\r\n\r\nexport const HANDWRAPS_SLUG = \"handwraps-of-mighty-blows\";\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function canBeInvested(item) {\r\n\treturn item.traits.has(\"invested\");\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function hasWornSlot(item) {\r\n\treturn item.system.equipped.inSlot != null;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nfunction isWornAs(item) {\r\n\treturn item.system.usage.type === \"worn\" && item.system.equipped.inSlot;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isInvestedOrWornAs(item) {\r\n\treturn item.isInvested || isWornAs(item);\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHeld(item) {\r\n\treturn item.system.usage.type === \"held\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isTwoHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-two-hands\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isOneHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-one-hand\";\r\n}\r\n\r\n/**\r\n * @tempate T\r\n * @param {object} item\r\n * @param {T} value\r\n * @returns {T|undefined}\r\n */\r\nfunction inSlotValue(item, value) {\r\n\tconst usage = item.system.usage;\r\n\treturn usage.type === \"worn\" && usage.where ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {boolean} [invest]\r\n * @returns {boolean|undefined}\r\n */\r\nfunction toggleInvestedValue(item, invest) {\r\n\tconst value = invest ?? !item.system.equipped.invested;\r\n\treturn item.traits.has(\"invested\") ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {object} options\r\n * @param {string} [options.carryType]\r\n * @param {number} [options.handsHeld]\r\n * @param {boolean} [options.inSlot]\r\n * @param {boolean} [options.invested]\r\n * @param {string|null} [options.containerId]\r\n * @returns {object}\r\n */\r\nexport function itemCarryUpdate(\r\n\titem,\r\n\t{ carryType = \"worn\", handsHeld = 0, inSlot, invested, containerId },\r\n) {\r\n\tconst update = {\r\n\t\t_id: item.id,\r\n\t\tsystem: {\r\n\t\t\tequipped: {\r\n\t\t\t\tcarryType: carryType,\r\n\t\t\t\thandsHeld: handsHeld,\r\n\t\t\t\tinSlot: inSlotValue(item, inSlot),\r\n\t\t\t\tinvested: toggleInvestedValue(item, invested),\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\r\n\tif (containerId !== undefined) {\r\n\t\tupdate.system.containerId = containerId;\r\n\t}\r\n\r\n\treturn update;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHandwrapsOfMightyBlows(item) {\r\n\treturn (\r\n\t\titem.isOfType(\"weapon\") &&\r\n\t\titem.slug === HANDWRAPS_SLUG &&\r\n\t\titem.category === \"unarmed\"\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {Item} item\r\n * @param {number} [quantity]\r\n * @returns {Coins}\r\n */\r\nexport function calculateItemPrice(item, quantity = 1, ratio = 1) {\r\n\tconst coins = game.pf2e.Coins.fromPrice(item.price, quantity);\r\n\tif (ratio === 1) return coins;\r\n\treturn coins.scale(ratio);\r\n}\r\n\r\n/**\r\n * @param {Actor} target\r\n * @param {Item} item\r\n * @param {number} quantity\r\n * @param {string} [containerId]\r\n * @param {boolean} [newStack]\r\n * @returns {Promise<Item>}\r\n */\r\nexport async function transferItemToActor(\r\n\ttarget,\r\n\titem,\r\n\tquantity,\r\n\tcontainerId,\r\n\tnewStack,\r\n) {\r\n\tconst itemQuantity = Math.min(quantity, item.quantity);\r\n\tconst newQuantity = item.quantity - itemQuantity;\r\n\r\n\tif (newQuantity < 1) {\r\n\t\tawait item.delete();\r\n\t} else {\r\n\t\tawait item.update({ \"system.quantity\": newQuantity });\r\n\t}\r\n\r\n\tconst newItemData = item.toObject();\r\n\tnewItemData.system.quantity = itemQuantity;\r\n\tnewItemData.system.equipped.carryType = \"worn\";\r\n\tif (\"invested\" in newItemData.system.equipped) {\r\n\t\tnewItemData.system.equipped.invested = item.traits.has(\"invested\")\r\n\t\t\t? false\r\n\t\t\t: null;\r\n\t}\r\n\r\n\treturn target.addToInventory(newItemData, containerId, newStack);\r\n}\r\n\r\nexport class MoveLootPopup extends FormApplication {\r\n\t/**\r\n\t * @param {Actor} object\r\n\t * @param {object} options\r\n\t * @param {{default: number, max: number}} options.quantity\r\n\t * @param {boolean} options.newStack\r\n\t * @param {boolean} options.lockStack\r\n\t * @param {boolean} options.isPurchase\r\n\t * @param {(quantity: number, newStack: boolean) => void} callback\r\n\t */\r\n\tconstructor(object, options, callback) {\r\n\t\tsuper(object, options);\r\n\t\tthis.onSubmitCallback = callback;\r\n\t}\r\n\r\n\tasync getData() {\r\n\t\tconst [prompt, buttonLabel] = this.options.isPurchase\r\n\t\t\t? [\"PF2E.loot.PurchaseLootMessage\", \"PF2E.loot.PurchaseLoot\"]\r\n\t\t\t: [\"PF2E.loot.MoveLootMessage\", \"PF2E.loot.MoveLoot\"];\r\n\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tquantity: {\r\n\t\t\t\tdefault: this.options.quantity.default,\r\n\t\t\t\tmax: this.options.quantity.max,\r\n\t\t\t},\r\n\t\t\tnewStack: this.options.newStack,\r\n\t\t\tlockStack: this.options.lockStack,\r\n\t\t\tprompt,\r\n\t\t\tbuttonLabel,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"MoveLootPopup\",\r\n\t\t\tclasses: [],\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.loot.MoveLootPopupTitle\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/popups/loot/move-loot-popup.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tquantity: {\r\n\t\t\t\tdefault: 1,\r\n\t\t\t\tmax: 1,\r\n\t\t\t},\r\n\t\t\tnewStack: false,\r\n\t\t\tlockStack: false,\r\n\t\t\tisPurchase: false,\r\n\t\t};\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tthis.onSubmitCallback(formData.quantity, formData.newStack);\r\n\t}\r\n}\r\n\r\nexport async function detachSubitem(subitem, skipConfirm) {\r\n\tconst parentItem = subitem.parentItem;\r\n\tif (!parentItem) throw ErrorPF2e(\"Subitem has no parent item\");\r\n\r\n\tconst localize = localizer(\"PF2E.Item.Physical.Attach.Detach\");\r\n\tconst confirmed =\r\n\t\tskipConfirm ||\r\n\t\t(await Dialog.confirm({\r\n\t\t\ttitle: localize(\"Label\"),\r\n\t\t\tcontent: createHTMLElement(\"p\", {\r\n\t\t\t\tchildren: [localize(\"Prompt\", { attachable: subitem.name })],\r\n\t\t\t}).outerHTML,\r\n\t\t}));\r\n\tif (!confirmed) return;\r\n\r\n\tconst deletePromise = subitem.delete();\r\n\tconst createPromise = (async () => {\r\n\t\t// Find a stack match, cloning the subitem as worn so the search won't fail due to it being equipped\r\n\t\tconst stack = subitem.isOfType(\"consumable\")\r\n\t\t\t? parentItem.actor?.inventory.findStackableItem(\r\n\t\t\t\t\tsubitem.clone({ \"system.equipped.carryType\": \"worn\" }),\r\n\t\t\t  )\r\n\t\t\t: null;\r\n\t\tconst keepId =\r\n\t\t\t!!parentItem.actor && !parentItem.actor.items.has(subitem.id);\r\n\t\treturn (\r\n\t\t\tstack?.update({ \"system.quantity\": stack.quantity + 1 }) ??\r\n\t\t\tItem.implementation.create(\r\n\t\t\t\tmergeObject(subitem.toObject(), {\r\n\t\t\t\t\t\"system.containerId\": parentItem.system.containerId,\r\n\t\t\t\t}),\r\n\t\t\t\t{ parent: parentItem.actor, keepId },\r\n\t\t\t)\r\n\t\t);\r\n\t})();\r\n\r\n\tawait Promise.all([deletePromise, createPromise]);\r\n}\r\n\r\nexport async function unownedItemToMessage(event, item, actor, options = {}) {\r\n\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\r\n\t// Basic template rendering data\r\n\tconst type = sluggify(item.type);\r\n\tconst template = `systems/pf2e/templates/chat/${type}-card.hbs`;\r\n\tconst token = actor.token;\r\n\tconst nearestItem = htmlClosest(event?.target, \".item\");\r\n\tconst rollOptions = options.data ?? { ...(nearestItem?.dataset ?? {}) };\r\n\tconst templateData = {\r\n\t\tactor: actor,\r\n\t\ttokenId: token ? `${token.parent?.id}.${token.id}` : null,\r\n\t\titem: item,\r\n\t\tdata: await item.getChatData(undefined, rollOptions),\r\n\t};\r\n\r\n\t// Basic chat message data\r\n\tconst originalEvent =\r\n\t\tevent instanceof MouseEvent ? event : event?.originalEvent;\r\n\tconst rollMode = options.rollMode ?? eventToRollMode(originalEvent);\r\n\tconst chatData = ChatMessagePF2e.applyRollMode(\r\n\t\t{\r\n\t\t\ttype: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n\t\t\tspeaker: ChatMessagePF2e.getSpeaker({\r\n\t\t\t\tactor: actor,\r\n\t\t\t\ttoken: actor.getActiveTokens(false, true).at(0),\r\n\t\t\t}),\r\n\t\t\tcontent: await renderTemplate(template, templateData),\r\n\t\t\tflags: { pf2e: { origin: item.getOriginData() } },\r\n\t\t},\r\n\t\trollMode,\r\n\t);\r\n\r\n\t// Create the chat message\r\n\treturn options.create ?? true\r\n\t\t? ChatMessagePF2e.create(chatData, { rollMode, renderSheet: false })\r\n\t\t: new ChatMessagePF2e(chatData, { rollMode });\r\n}\r\n\r\n/**\r\n * @param {ItemOrSource} item\r\n * @param  {...any: string[]} types\r\n * @returns {boolean}\r\n */\r\nexport function itemIsOfType(item, ...types) {\r\n\treturn (\r\n\t\ttypeof item.name === \"string\" &&\r\n\t\ttypes.some((t) =>\r\n\t\t\tt === \"physical\"\r\n\t\t\t\t? setHasElement(PHYSICAL_ITEM_TYPES, item.type)\r\n\t\t\t\t: item.type === t,\r\n\t\t)\r\n\t);\r\n}\r\n", "export const DEGREE_OF_SUCCESS = {\r\n\tCRITICAL_SUCCESS: 3,\r\n\tSUCCESS: 2,\r\n\tFAILURE: 1,\r\n\tCRITICAL_FAILURE: 0,\r\n};\r\n\r\nexport const DEGREE_ADJUSTMENT_AMOUNTS = {\r\n\tLOWER_BY_TWO: -2,\r\n\tLOWER: -1,\r\n\tINCREASE: 1,\r\n\tINCREASE_BY_TWO: 2,\r\n\tTO_CRITICAL_FAILURE: \"criticalFailure\",\r\n\tTO_FAILURE: \"failure\",\r\n\tTO_SUCCESS: \"success\",\r\n\tTO_CRITICAL_SUCCESS: \"criticalSuccess\",\r\n};\r\n\r\nexport const DEGREE_OF_SUCCESS_STRINGS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\n/**\r\n * @class\r\n * @constructor\r\n */\r\nexport class DegreeOfSuccess {\r\n\t/**\r\n\t * @param {{dieResult: number, rollTotal: number}} roll\r\n\t * @param {number|{value: number}} dc\r\n\t * @param {object|null} [dosAdjustments]\r\n\t */\r\n\tconstructor(roll, dc, dosAdjustments = null) {\r\n\t\tif (roll instanceof Roll) {\r\n\t\t\tthis.dieResult =\r\n\t\t\t\t(roll.isDeterministic\r\n\t\t\t\t\t? roll.terms.find((t) => t instanceof NumericTerm)\r\n\t\t\t\t\t: roll.dice.find((d) => d instanceof Die && d.faces === 20)\r\n\t\t\t\t)?.total ?? 1;\r\n\t\t\tthis.rollTotal = roll.total;\r\n\t\t} else {\r\n\t\t\tthis.dieResult = roll.dieValue;\r\n\t\t\tthis.rollTotal = roll.dieValue + roll.modifier;\r\n\t\t}\r\n\r\n\t\tthis.dc = typeof dc === \"number\" ? { value: dc } : dc;\r\n\r\n\t\tthis.unadjusted = this.#calculateDegreeOfSuccess();\r\n\t\tthis.adjustment = this.#getDegreeAdjustment(\r\n\t\t\tthis.unadjusted,\r\n\t\t\tdosAdjustments,\r\n\t\t);\r\n\t\t/**\r\n\t\t * @type {0|1|2|3}\r\n\t\t */\r\n\t\tthis.value = this.adjustment\r\n\t\t\t? this.#adjustDegreeOfSuccess(this.adjustment.amount, this.unadjusted)\r\n\t\t\t: this.unadjusted;\r\n\t}\r\n\r\n\tstatic CRITICAL_FAILURE = 0;\r\n\tstatic FAILURE = 1;\r\n\tstatic SUCCESS = 2;\r\n\tstatic CRITICAL_SUCCESS = 3;\r\n\r\n\t#getDegreeAdjustment(degree, adjustments) {\r\n\t\tif (!adjustments) return null;\r\n\r\n\t\tfor (const outcome of [\"all\", ...DEGREE_OF_SUCCESS_STRINGS]) {\r\n\t\t\tconst { label, amount } = adjustments[outcome] ?? {};\r\n\t\t\tif (\r\n\t\t\t\tamount &&\r\n\t\t\t\tlabel &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_SUCCESS &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.INCREASE\r\n\t\t\t\t) &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_FAILURE &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.LOWER\r\n\t\t\t\t) &&\r\n\t\t\t\t(outcome === \"all\" ||\r\n\t\t\t\t\tDEGREE_OF_SUCCESS_STRINGS.indexOf(outcome) === degree)\r\n\t\t\t) {\r\n\t\t\t\treturn { label, amount };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\t#adjustDegreeOfSuccess(amount, degreeOfSuccess) {\r\n\t\tswitch (amount) {\r\n\t\t\tcase \"criticalFailure\":\r\n\t\t\t\treturn 0;\r\n\t\t\tcase \"failure\":\r\n\t\t\t\treturn 1;\r\n\t\t\tcase \"success\":\r\n\t\t\t\treturn 2;\r\n\t\t\tcase \"criticalSuccess\":\r\n\t\t\t\treturn 3;\r\n\t\t\tdefault:\r\n\t\t\t\treturn Math.clamped(degreeOfSuccess + amount, 0, 3);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * @param degree The current success value\r\n\t * @return The new success value\r\n\t */\r\n\t#adjustDegreeByDieValue(degree) {\r\n\t\tif (this.dieResult === 20) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.INCREASE,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (this.dieResult === 1) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.LOWER,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn degree;\r\n\t}\r\n\r\n\t#calculateDegreeOfSuccess() {\r\n\t\tconst dc = this.dc.value;\r\n\r\n\t\tif (this.rollTotal - dc >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS);\r\n\t\t}\r\n\r\n\t\tif (dc - this.rollTotal >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE);\r\n\t\t}\r\n\r\n\t\tif (this.rollTotal >= dc) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS);\r\n\t\t}\r\n\r\n\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE);\r\n\t}\r\n}\r\n", "/**\r\n * @param {unknown} measuredTemplate\r\n * @param {{collisionOrigin?: {x: number, y: number}, collisionType?: \"move\" | \"sight\"}} [options]\r\n * @returns {unknown[]}\r\n */\r\nexport function getTemplateTokens(\r\n\tmeasuredTemplate,\r\n\t{ collisionOrigin, collisionType = \"move\" } = {},\r\n) {\r\n\tconst template =\r\n\t\tmeasuredTemplate instanceof MeasuredTemplateDocument\r\n\t\t\t? measuredTemplate.object\r\n\t\t\t: measuredTemplate;\r\n\r\n\tif (!canvas.scene) return [];\r\n\tconst { grid, dimensions } = canvas;\r\n\tif (!(grid && dimensions)) return [];\r\n\r\n\tif (!template?.highlightId) return [];\r\n\r\n\tconst gridHighlight = grid.getHighlightLayer(template.highlightId);\r\n\tif (!gridHighlight || grid.type !== CONST.GRID_TYPES.SQUARE) return [];\r\n\tconst origin = collisionOrigin ?? template.center;\r\n\r\n\tconst tokens = canvas.tokens.quadtree.getObjects(\r\n\t\tgridHighlight.getLocalBounds(undefined, true),\r\n\t);\r\n\r\n\tconst gridSize = grid.size;\r\n\r\n\tconst containedTokens = [];\r\n\tfor (const token of tokens) {\r\n\t\tconst tokenDoc = token.document;\r\n\r\n\t\tconst tokenPositions = [];\r\n\t\tfor (let h = 0; h < tokenDoc.height; h++) {\r\n\t\t\tconst tokenX = Math.floor(token.x / gridSize) * gridSize;\r\n\t\t\tconst tokenY = Math.floor(token.y / gridSize) * gridSize;\r\n\r\n\t\t\tconst y = tokenY + h * gridSize;\r\n\t\t\ttokenPositions.push(`${tokenX}.${y}`);\r\n\t\t\tif (tokenDoc.width > 1) {\r\n\t\t\t\tfor (let w = 1; w < tokenDoc.width; w++) {\r\n\t\t\t\t\ttokenPositions.push(`${tokenX + w * gridSize}.${y}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const position of tokenPositions) {\r\n\t\t\tif (!gridHighlight.positions.has(position)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tconst [gx, gy] = position.split(\".\").map((s) => Number(s));\r\n\t\t\tconst destination = {\r\n\t\t\t\tx: gx + dimensions.size * 0.5,\r\n\t\t\t\ty: gy + dimensions.size * 0.5,\r\n\t\t\t};\r\n\t\t\tif (destination.x < 0 || destination.y < 0) continue;\r\n\r\n\t\t\tconst hasCollision =\r\n\t\t\t\tcanvas.ready &&\r\n\t\t\t\tcollisionType &&\r\n\t\t\t\tCONFIG.Canvas.polygonBackends[collisionType].testCollision(\r\n\t\t\t\t\torigin,\r\n\t\t\t\t\tdestination,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttype: collisionType,\r\n\t\t\t\t\t\tmode: \"any\",\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\tif (!hasCollision) {\r\n\t\t\t\tcontainedTokens.push(token);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn containedTokens;\r\n}\r\n", "import { MODULE, getSetting, isChoiceSetting } from \"module-api\";\r\n\r\nexport function wrapperError(feature, path) {\r\n\tconsole.error(\r\n\t\t`an error occured in the feature '${feature}' of the module '${MODULE.id}' with the wrapper: '${path}'`,\r\n\t);\r\n}\r\n\r\nexport function settingIsEnabled(setting) {\r\n\tconst value = getSetting(setting);\r\n\treturn isChoiceSetting(setting) ? value !== \"disabled\" : value;\r\n}\r\n\r\nexport function calledIfSetting(fn, setting) {\r\n\treturn () => {\r\n\t\tconst value = getSetting(setting);\r\n\t\tconst enabled = isChoiceSetting(setting) ? value !== \"disabled\" : value;\r\n\t\tif (enabled) {\r\n\t\t\tfn(value);\r\n\t\t\treturn;\r\n\t\t}\r\n\t};\r\n}\r\n", "import { HANDWRAPS_SLUG, getSetting, info, registerWrapper } from \"module-api\";\r\nimport { wrapperError } from \"../misc\";\r\n\r\nconst PREPARE_WEAPON_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData\";\r\nconst PREPARE_WEAPON_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData\";\r\n\r\nconst PREPARE_ARMOR_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData\";\r\nconst PREPARE_ARMOR_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData\";\r\n\r\nexport const arpOptions = {\r\n\tname: \"arp\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"auto-runes\",\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"disabled\",\r\n\t\t\tchoices: [\"disabled\", \"force\", \"lower\"],\r\n\t\t\trequiresReload: true,\r\n\t\t},\r\n\t],\r\n\tconflicts: [\"pf2e-arp\"],\r\n\tinit: () => {\r\n\t\tconst setting = getSetting(\"auto-runes\");\r\n\t\tif (setting === \"disabled\") return;\r\n\r\n\t\tregisterWrapper(PREPARE_WEAPON_DATA, onPrepareWeaponData, \"WRAPPER\");\r\n\t\tregisterWrapper(\r\n\t\t\tPREPARE_WEAPON_DERIVED_DATA,\r\n\t\t\tonPrepareWeaponDerivedData,\r\n\t\t\t\"WRAPPER\",\r\n\t\t);\r\n\r\n\t\tregisterWrapper(PREPARE_ARMOR_DATA, onPrepareArmorData, \"WRAPPER\");\r\n\t\tregisterWrapper(\r\n\t\t\tPREPARE_ARMOR_DERIVED_DATA,\r\n\t\t\tonPrepareArmorDerivedData,\r\n\t\t\t\"WRAPPER\",\r\n\t\t);\r\n\r\n\t\tif (setting === \"force\") {\r\n\t\t\tHooks.on(\"renderPhysicalItemSheetPF2e\", renderPhysicalItemSheetPF2e);\r\n\t\t}\r\n\t},\r\n\tready: (isGM) => {\r\n\t\tif (\r\n\t\t\tisGM &&\r\n\t\t\tgetSetting(\"auto-runes\") !== \"disabled\" &&\r\n\t\t\tgame.settings.get(\"pf2e\", \"automaticBonusVariant\") !== \"noABP\"\r\n\t\t) {\r\n\t\t\tgame.settings.set(\"pf2e\", \"automaticBonusVariant\", \"noABP\");\r\n\t\t\tinfo(\"arp.forceVariant\");\r\n\t\t}\r\n\t},\r\n};\r\n\r\nfunction isValidActor(actor, isCharacter = false) {\r\n\treturn (\r\n\t\tactor &&\r\n\t\t!actor.getFlag(\"pf2e\", \"disableABP\") &&\r\n\t\t(!isCharacter || actor.isOfType(\"character\"))\r\n\t);\r\n}\r\n\r\n/**\r\n * weapon\r\n */\r\n\r\nconst WEAPON_POTENCY_PRICE = {\r\n\t1: 35,\r\n\t2: 935,\r\n\t3: 8935,\r\n\t4: 8935,\r\n};\r\n\r\nconst WEAPON_STRIKING_PRICE = {\r\n\t1: 65,\r\n\t2: 1065,\r\n\t3: 31065,\r\n};\r\n\r\nfunction isShieldWeapon(weapon) {\r\n\treturn [\"shield-boss\", \"shield-spikes\"].includes(\r\n\t\tweapon._source.system.baseItem,\r\n\t);\r\n}\r\n\r\nfunction isValidWeapon(weapon) {\r\n\tconst traits = weapon._source.system.traits.value;\r\n\tconst { group, category, slug } = weapon._source.system;\r\n\r\n\tif (category === \"unarmed\" && slug !== HANDWRAPS_SLUG) {\r\n\t\treturn weapon.actor.itemTypes.weapon.some(\r\n\t\t\t(item) =>\r\n\t\t\t\titem.slug === HANDWRAPS_SLUG &&\r\n\t\t\t\titem._source.system.category === \"unarmed\" &&\r\n\t\t\t\titem._source.system.equipped.carryType === \"worn\" &&\r\n\t\t\t\titem._source.system.equipped.inSlot === true &&\r\n\t\t\t\titem._source.system.equipped.invested === true &&\r\n\t\t\t\titem._source.system.identification.status === \"identified\",\r\n\t\t);\r\n\t}\r\n\r\n\treturn (\r\n\t\t(group !== \"shield\" || isShieldWeapon(weapon)) &&\r\n\t\t!traits.includes(\"alchemical\") &&\r\n\t\t!traits.includes(\"bomb\")\r\n\t);\r\n}\r\n\r\nfunction onPrepareWeaponData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidWeapon(this)) return wrapped();\r\n\r\n\t\tconst traits = this._source.system.traits.value;\r\n\t\tif (traits.includes(\"alchemical\") && traits.includes(\"bomb\"))\r\n\t\t\treturn wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 2 ? null : level < 10 ? 1 : level < 16 ? 2 : 3;\r\n\t\tconst expectedStriking =\r\n\t\t\tlevel < 4 ? null : level < 12 ? 1 : level < 19 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.striking <= expectedStriking || forceUpdate) {\r\n\t\t\tthis.system.runes.striking = expectedStriking;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareWeaponDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidWeapon(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= WEAPON_POTENCY_PRICE[potency];\r\n\r\n\t\tconst striking = this.system.runes.striking;\r\n\t\tif (striking) coins.gp -= WEAPON_STRIKING_PRICE[striking];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || striking) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * amor\r\n */\r\n\r\nconst ARMOR_POTENCY_PRICE = {\r\n\t1: 160,\r\n\t2: 1060,\r\n\t3: 20560,\r\n\t4: 20560,\r\n};\r\n\r\nconst ARMOR_RESILIENCY_PRICE = {\r\n\t1: 340,\r\n\t2: 3440,\r\n\t3: 49440,\r\n};\r\n\r\nfunction isValidArmor(armor) {\r\n\treturn true;\r\n}\r\n\r\nfunction onPrepareArmorData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidArmor(this)) return wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 5 ? null : level < 11 ? 1 : level < 18 ? 2 : 3;\r\n\t\tconst expectedResilient =\r\n\t\t\tlevel < 8 ? null : level < 14 ? 1 : level < 20 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.resilient <= expectedResilient || forceUpdate) {\r\n\t\t\tthis.system.runes.resilient = expectedResilient;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareArmorDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidArmor(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= ARMOR_POTENCY_PRICE[potency];\r\n\r\n\t\tconst resiliency = this.system.runes.resilient;\r\n\t\tif (resiliency) coins.gp -= ARMOR_RESILIENCY_PRICE[resiliency];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || resiliency) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * item sheet\r\n */\r\n\r\nfunction renderPhysicalItemSheetPF2e(sheet, html) {\r\n\tconst item = sheet.item;\r\n\tif (\r\n\t\t!item ||\r\n\t\t!item.isOfType(\"weapon\", \"armor\") ||\r\n\t\t!isValidActor(item.actor, true)\r\n\t)\r\n\t\treturn;\r\n\r\n\tconst lookups = [\"potency\", \"striking\", \"resilient\"]\r\n\t\t.map((x) => `[name=\"system.runes.${x}\"]`)\r\n\t\t.join(\", \");\r\n\thtml.find(`[data-tab=details] fieldset .form-group:has(${lookups})`).hide();\r\n}\r\n", "import {\r\n\tgetSetting,\r\n\tregisterUpstreamHook,\r\n\tsocketEmit,\r\n\tsocketOff,\r\n\tsocketOn,\r\n} from \"module-api\";\r\n\r\nexport function checkFeatureOptions(options) {\r\n\tif (!options.name) {\r\n\t\tthrow new Error(\"module features need a name\");\r\n\t}\r\n\r\n\tif (!options.settings?.length) {\r\n\t\tthrow new Error(\"module features need at least one setting\");\r\n\t}\r\n}\r\n\r\nexport function createTool(options) {\r\n\tcheckFeatureOptions(options);\r\n\r\n\tconst tool = {};\r\n\r\n\tif (options.hooks?.length) {\r\n\t\tconst hooks = new Map();\r\n\r\n\t\ttool.hooks = {\r\n\t\t\t/**\r\n\t\t\t * @param {string} key\r\n\t\t\t * @param {unknown} value\r\n\t\t\t */\r\n\t\t\tset: (key, value) => {\r\n\t\t\t\thooks.get(key)?.(value);\r\n\t\t\t},\r\n\t\t\t/**\r\n\t\t\t * @param {string} key\r\n\t\t\t * @param {string} setting\r\n\t\t\t */\r\n\t\t\tsetFromSetting: (key, setting) => {\r\n\t\t\t\tconst value = getSetting(setting);\r\n\t\t\t\thooks.get(key)?.(value);\r\n\t\t\t},\r\n\t\t\t/**\r\n\t\t\t * @param {unknown} value\r\n\t\t\t */\r\n\t\t\tsetAll: (value) => {\r\n\t\t\t\tfor (const [_, listener] of hooks) {\r\n\t\t\t\t\tlistener(value);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tfor (const hook of options.hooks) {\r\n\t\t\tconst key = hook.key ?? hook[0] ?? hook.event;\r\n\t\t\thooks.set(key, createHook(hook));\r\n\t\t}\r\n\r\n\t\tif (options.hooks.length === 1) {\r\n\t\t\t/**\r\n\t\t\t * @type {ReturnType<createHook> & {fromSetting: (setting: value) => void}}\r\n\t\t\t */\r\n\t\t\ttool.setHook = [...hooks][0][1];\r\n\t\t\ttool.setHook.fromSetting = function (setting) {\r\n\t\t\t\tconst value = getSetting(setting);\r\n\t\t\t\tthis(value);\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tif (options.socket) {\r\n\t\ttool.socket = createSocket(options.name, options.socket);\r\n\t}\r\n\r\n\treturn tool;\r\n}\r\n\r\nfunction createHook(hook) {\r\n\tconst {\r\n\t\tevent,\r\n\t\tlistener,\r\n\t\tuseChoices = false,\r\n\t\tisUpstream = false,\r\n\t} = Array.isArray(hook) ? { event: hook[0], listener: hook[1] } : hook;\r\n\r\n\tlet hookId = null;\r\n\r\n\tconst isEnabled = !useChoices\r\n\t\t? (value) => value\r\n\t\t: typeof useChoices === \"string\"\r\n\t\t  ? (value) => value === useChoices\r\n\t\t  : (value) => value !== \"disabled\";\r\n\r\n\tconst registerFn = (isUpstream ? registerUpstreamHook : Hooks.on).bind(Hooks);\r\n\r\n\treturn (value) => {\r\n\t\tconst enabled = isEnabled(value);\r\n\r\n\t\tif (enabled && !hookId) {\r\n\t\t\thookId = registerFn(event, listener);\r\n\t\t} else if (!enabled && hookId) {\r\n\t\t\tHooks.off(event, hookId);\r\n\t\t\thookId = null;\r\n\t\t}\r\n\t};\r\n}\r\n\r\nfunction createSocket(key, listener) {\r\n\tlet socketEnabled = false;\r\n\r\n\tconst toolKey = `tool-${key}-`;\r\n\r\n\tconst onSocket = (packet, userId) => {\r\n\t\tif (!packet.type?.startsWith(toolKey)) return;\r\n\t\tpacket.type = packet.type.slice(toolKey.length);\r\n\t\tlistener(packet, userId);\r\n\t};\r\n\r\n\treturn {\r\n\t\temit(packet) {\r\n\t\t\tpacket.type = toolKey + packet.type;\r\n\t\t\tsocketEmit(packet);\r\n\t\t},\r\n\t\tactivate() {\r\n\t\t\tif (socketEnabled) return;\r\n\t\t\tsocketEnabled = true;\r\n\t\t\tsocketOn(onSocket);\r\n\t\t},\r\n\t\tdisable() {\r\n\t\t\tif (!socketEnabled) return;\r\n\t\t\tsocketEnabled = false;\r\n\t\t\tsocketOff(onSocket);\r\n\t\t},\r\n\t\ttoggle(enabled = !socketEnabled) {\r\n\t\t\tif (enabled) this.activate();\r\n\t\t\telse this.disable();\r\n\t\t},\r\n\t};\r\n}\r\n", "import { calledIfSetting } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nexport const debugOptions = {\r\n\tname: \"debug\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"debug\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tconfig: false,\r\n\t\t\tscope: \"client\",\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t],\r\n\thooks: [\r\n\t\t[\"renderApplication\", onRender],\r\n\t\t[\"renderActorSheet\", onRender],\r\n\t\t[\"renderItemSheet\", onRender],\r\n\t],\r\n\tinit: calledIfSetting(setup, \"debug\"),\r\n};\r\n\r\nconst { hooks } = createTool(debugOptions);\r\n\r\nfunction setup(value) {\r\n\thooks.setAll(value);\r\n}\r\n\r\nfunction onRender(app, html) {\r\n\tconst link = html.find(\".document-id-link\")[0];\r\n\tif (!link) return;\r\n\r\n\tlink.addEventListener(\r\n\t\t\"click\",\r\n\t\t(event) => {\r\n\t\t\tif (!event.shiftKey) return;\r\n\r\n\t\t\tconst obj = app.object;\r\n\t\t\tif (!obj) return;\r\n\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tconst type = obj.type;\r\n\r\n\t\t\tlet i = 2;\r\n\t\t\tlet variable = type;\r\n\t\t\twhile (window[variable]) {\r\n\t\t\t\tvariable = `${type}${i++}`;\r\n\t\t\t}\r\n\r\n\t\t\twindow[variable] = obj;\r\n\t\t\tconsole.log(variable, obj);\r\n\t\t},\r\n\t\ttrue,\r\n\t);\r\n}\r\n", "import { getSetting, localize } from \"module-api\";\r\nimport { createTool } from \"../tool\";\r\n\r\nconst setupDebounced = debounce(setup, 1);\r\n\r\nexport const effectsOptions = {\r\n    name: \"effects\",\r\n    settings: [\r\n        {\r\n            key: \"effect-remove\",\r\n            type: Boolean,\r\n            default: false,\r\n            scope: \"client\",\r\n            onChange: setupDebounced,\r\n        },\r\n        {\r\n            key: \"condition-sheet\",\r\n            type: Boolean,\r\n            default: false,\r\n            scope: \"client\",\r\n            onChange: setupDebounced,\r\n        },\r\n    ],\r\n    hooks: [[\"renderEffectsPanel\", renderEffectsPanel]],\r\n    conflicts: [\"pf2e-effect-description\"],\r\n    init: setupDebounced,\r\n};\r\n\r\nconst { setHook } = createTool(effectsOptions);\r\n\r\nfunction setup() {\r\n    const enabled = getSetting(\"effect-remove\") || getSetting(\"condition-sheet\");\r\n    setHook(enabled);\r\n    refreshEffectsPanel();\r\n}\r\n\r\nfunction refreshEffectsPanel() {\r\n    game.pf2e.effectPanel?.render();\r\n}\r\n\r\nfunction renderEffectsPanel(panel, html) {\r\n    const removeRow = `<div>${localize(\"effects.remove\")}</div>`;\r\n    const editIcon = `<a data-action=\"edit\" data-tooltip=\"Edit Item\"><i class=\"fa-solid fa-fw fa-pencil\"></i></a>`;\r\n\r\n    const effectPanels = html.find(\".effect-item[data-item-id]\").toArray();\r\n    for (const effectPanel of effectPanels) {\r\n        const id = effectPanel.dataset.itemId;\r\n        const effect = panel.actor?.items.get(id);\r\n        if (!effect) continue;\r\n\r\n        if (\r\n            getSetting(\"effect-remove\") &&\r\n            !effect.isLocked &&\r\n            effect.badge &&\r\n            effect.badge.type === \"counter\"\r\n        ) {\r\n            effectPanel\r\n                .querySelector(\".effect-info .instructions\")\r\n                .insertAdjacentHTML(\"beforeend\", removeRow);\r\n            effectPanel\r\n                .querySelector(\".icon\")\r\n                .addEventListener(\"contextmenu\", (event) => onRemoveEffect(event, panel), true);\r\n        }\r\n\r\n        if (getSetting(\"condition-sheet\") && effect.isOfType(\"condition\")) {\r\n            const h1 = effectPanel.querySelector(\".effect-info > h1\");\r\n            h1.insertAdjacentHTML(\"beforeend\", editIcon);\r\n            h1.querySelector('[data-action=\"edit\"]').addEventListener(\"click\", (event) =>\r\n                onConditionSheet(event, panel)\r\n            );\r\n        }\r\n    }\r\n}\r\n\r\nfunction onConditionSheet(event, panel) {\r\n    const effect = getEffect(event, panel);\r\n    if (!effect?.isOfType(\"condition\")) return;\r\n    event.preventDefault();\r\n    effect.sheet.render(true);\r\n}\r\n\r\nfunction onRemoveEffect(event, panel) {\r\n    if (!event.shiftKey) return;\r\n\r\n    const effect = getEffect(event, panel);\r\n    if (!effect || effect.isLocked || !effect.badge || effect.badge.type !== \"counter\") return;\r\n\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    event.stopImmediatePropagation();\r\n\r\n    effect.delete();\r\n}\r\n\r\nfunction getEffect(event, panel) {\r\n    const target = event.currentTarget;\r\n    const effect = target.closest(\".effect-item[data-item-id]\");\r\n    const id = effect.dataset.itemId;\r\n    return panel.actor?.items.get(id);\r\n}\r\n", "import {\r\n\tgetInMemory,\r\n\tregisterWrapper,\r\n\trender,\r\n\tsetInMemory,\r\n\tunregisterWrapper,\r\n} from \"module-api\";\r\n\r\nconst sheetTabsRegistered = {\r\n\twrapperIds: [],\r\n\ttabs: new Collection(),\r\n};\r\n\r\nconst CHARACTER_SHEET_INNER_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner\";\r\nconst CHARACTER_SHEET_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render\";\r\nconst CHARACTER_SHEET_ACTIVE_LISTENERS =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners\";\r\n\r\nexport function isPlayedActor(actor) {\r\n\treturn actor && !actor.pack && actor.id && game.actors.has(actor.id);\r\n}\r\n\r\nexport function registerCharacterSheetExtraTab(options) {\r\n\tif (!sheetTabsRegistered.wrapperIds.length) {\r\n\t\tsheetTabsRegistered.wrapperIds = [\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_RENDER, characterSheetRender),\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_INNER_RENDER, characterSheetInnerRender),\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tCHARACTER_SHEET_ACTIVE_LISTENERS,\r\n\t\t\t\tcharacterSheetActiveListeners,\r\n\t\t\t),\r\n\t\t];\r\n\t}\r\n\tsheetTabsRegistered.tabs.set(options.tabName, options);\r\n}\r\n\r\nexport function unregisterCharacterSheetExtraTab(tabName) {\r\n\tsheetTabsRegistered.tabs.delete(tabName);\r\n\tif (sheetTabsRegistered.wrapperIds.length && !sheetTabsRegistered.tabs.size) {\r\n\t\tfor (const wrapperId of sheetTabsRegistered.wrapperIds) {\r\n\t\t\tunregisterWrapper(wrapperId);\r\n\t\t}\r\n\t\tsheetTabsRegistered.wrapperIds = [];\r\n\t}\r\n}\r\n\r\nasync function characterSheetRender(wrapped, ...args) {\r\n\tconst positions = {};\r\n\r\n\tfor (const { tabName } of sheetTabsRegistered.tabs) {\r\n\t\tconst existingTab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst existingAlternate = existingTab.find(\".toolbelt-alternate\")[0];\r\n\t\tif (!existingAlternate) continue;\r\n\t\tpositions[tabName] = existingAlternate.scrollTop;\r\n\t}\r\n\r\n\tawait wrapped(...args);\r\n\r\n\tfor (const { tabName } of sheetTabsRegistered.tabs) {\r\n\t\tconst oldPosition = positions[tabName];\r\n\t\tif (!oldPosition) continue;\r\n\r\n\t\tconst tab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst alternate = tab.find(\".toolbelt-alternate\")[0];\r\n\t\talternate.scrollTop = positions[tabName];\r\n\t}\r\n}\r\n\r\nasync function characterSheetInnerRender(wrapped, data) {\r\n\tconst inner = await wrapped(data);\r\n\tconst actor = this.actor;\r\n\r\n\tif (!sheetTabsRegistered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn inner;\r\n\t}\r\n\r\n\tconst element = this.element;\r\n\r\n\tfor (const {\r\n\t\ttabName,\r\n\t\tgetData,\r\n\t\ttemplateFolder,\r\n\t\tonRender,\r\n\t\tbeforeSelector,\r\n\t} of sheetTabsRegistered.tabs) {\r\n\t\tconst innerTab = getCharacterSheetTab(inner, tabName);\r\n\r\n\t\tconst tabData = await getData(\r\n\t\t\tactor,\r\n\t\t\tthis,\r\n\t\t\tgetCharacterSheetTab(element, tabName),\r\n\t\t);\r\n\r\n\t\tconst template = await render(templateFolder, tabData);\r\n\r\n\t\tif (onRender) {\r\n\t\t\tawait onRender(actor, this, inner);\r\n\t\t}\r\n\r\n\t\tif (getInMemory(this, `${tabName}.toggled`)) {\r\n\t\t\tinnerTab.addClass(\"toggled\");\r\n\t\t}\r\n\r\n\t\tif (beforeSelector) {\r\n\t\t\tinnerTab.find(beforeSelector).before(template);\r\n\t\t} else {\r\n\t\t\tinnerTab.children(\":last\").before(template);\r\n\t\t}\r\n\t}\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction characterSheetActiveListeners(wrapped, inner) {\r\n\twrapped(inner);\r\n\r\n\tconst actor = this.actor;\r\n\r\n\tif (!sheetTabsRegistered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const { tabName, addEvents } of sheetTabsRegistered.tabs) {\r\n\t\tinner\r\n\t\t\t.find(`nav.sheet-navigation .item[data-tab=${tabName}]`)\r\n\t\t\t.on(\"click\", (event) =>\r\n\t\t\t\tonCharacterSheetTabBtnToggle(event, inner, this, tabName),\r\n\t\t\t);\r\n\r\n\t\tconst tab = getCharacterSheetTab(inner, tabName);\r\n\t\taddEvents(tab.find(\".toolbelt-alternate\"), this, actor, inner);\r\n\t}\r\n}\r\n\r\nexport function getCharacterSheetTab(html, tabName) {\r\n\treturn html.find(\r\n\t\t`section.sheet-body .sheet-content > .tab[data-tab=${tabName}]`,\r\n\t);\r\n}\r\n\r\nfunction onCharacterSheetTabBtnToggle(event, html, sheet, tabName) {\r\n\tevent.preventDefault();\r\n\r\n\tconst tab = getCharacterSheetTab(html, tabName);\r\n\r\n\tif (tab.hasClass(\"active\")) {\r\n\t\ttab.toggleClass(\"toggled\");\r\n\t\ttab.scrollTop(0);\r\n\t\tsetInMemory(sheet, `${tabName}.toggled`, tab.hasClass(\"toggled\"));\r\n\t}\r\n}\r\n", "import {\r\n\tMoveLootPopup,\r\n\tcreateFancyLink,\r\n\tcreateTradeMessage,\r\n\tgetHighestName,\r\n\tgetSetting,\r\n\tisGMOnline,\r\n\tlocalize,\r\n\ttransferItemToActor,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor-sheet\";\r\nimport { calledIfSetting } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nexport const givethOptions = {\r\n\tname: \"giveth\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"giveth\",\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"disabled\",\r\n\t\t\tchoices: [\"disabled\", \"enabled\", \"no-message\"],\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t],\r\n\thooks: [\r\n\t\t{\r\n\t\t\tevent: \"dropCanvasData\",\r\n\t\t\tlistener: dropCanvasData,\r\n\t\t\tisUpstream: true,\r\n\t\t\tuseChoices: true,\r\n\t\t},\r\n\t],\r\n\tsocket: onSocket,\r\n\tconflicts: [\"pf2e-giveth\"],\r\n\tready: calledIfSetting(setup, \"giveth\"),\r\n};\r\n\r\nconst { socket, setHook } = createTool(givethOptions);\r\n\r\nfunction setup(value) {\r\n\tif (game.user.isGM) {\r\n\t\tsocket.toggle(value);\r\n\t} else {\r\n\t\tsetHook(value);\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet, userId) {\r\n\tif (packet.type === \"giveth-condition\") takethCondition(packet);\r\n\telse if (packet.type === \"giveth-effect\") takethEffect(packet);\r\n\telse takethPhysical(packet, userId);\r\n}\r\n\r\nfunction dropCanvasData(canvas, data) {\r\n\tif (!isGMOnline()) return true;\r\n\r\n\tconst details = getDetailsFromData(data);\r\n\tif (!details) return true;\r\n\r\n\tconst target = canvas.tokens.placeables\r\n\t\t.slice()\r\n\t\t.filter((token) => {\r\n\t\t\tif (!token.document.actorLink) return false;\r\n\t\t\tconst target = token.actor;\r\n\t\t\tif (!isValidActor(target, data.actorId) || target.isOwner) return false;\r\n\t\t\tconst maximumX = token.x + (token.hitArea?.right ?? 0);\r\n\t\t\tconst maximumY = token.y + (token.hitArea?.bottom ?? 0);\r\n\t\t\treturn (\r\n\t\t\t\tdata.x >= token.x &&\r\n\t\t\t\tdata.y >= token.y &&\r\n\t\t\t\tdata.x <= maximumX &&\r\n\t\t\t\tdata.y <= maximumY\r\n\t\t\t);\r\n\t\t})\r\n\t\t.sort((a, b) => b.document.sort - a.document.sort)\r\n\t\t.at(0)?.actor;\r\n\r\n\tif (!target) return true;\r\n\r\n\tgiveth(details.actor, target, details.item, details.value);\r\n\treturn false;\r\n}\r\n\r\nfunction giveth(origin, target, item, value) {\r\n\tconst ownerId = origin.id;\r\n\tconst targetId = target.id;\r\n\tconst isIndex = !(item instanceof Item);\r\n\r\n\tif (!isIndex && item.isOfType(\"physical\")) {\r\n\t\tconst qty = item.quantity;\r\n\r\n\t\tif (qty < 1) {\r\n\t\t\treturn warn(\"giveth.notification.zero\");\r\n\t\t}\r\n\t\tif (qty === 1) {\r\n\t\t\treturn sendPhysicalRequest(ownerId, targetId, item.id, 1, false);\r\n\t\t}\r\n\r\n\t\tconst stackable = target.inventory.findStackableItem(item._source);\r\n\r\n\t\tnew MoveLootPopup(\r\n\t\t\torigin,\r\n\t\t\t{\r\n\t\t\t\tquantity: { max: qty, default: qty },\r\n\t\t\t\tlockStack: !stackable,\r\n\t\t\t\tisPurchase: false,\r\n\t\t\t},\r\n\t\t\t(quantity, newStack) => {\r\n\t\t\t\tsendPhysicalRequest(ownerId, targetId, item.id, quantity, newStack);\r\n\t\t\t},\r\n\t\t).render(true);\r\n\t} else {\r\n\t\tconst uuid = isIndex ? `Compendium.${item.pack}.${item._id}` : item.uuid;\r\n\t\tif (item.type === \"condition\") {\r\n\t\t\tsocket.emit({\r\n\t\t\t\ttype: \"giveth-condition\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tvalue: value ?? 1,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tsocket.emit({\r\n\t\t\t\ttype: \"giveth-effect\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction sendPhysicalRequest(ownerId, targetId, itemId, qty, stack) {\r\n\tsocket.emit({\r\n\t\ttype: \"giveth-physical\",\r\n\t\townerId,\r\n\t\ttargetId,\r\n\t\titemId,\r\n\t\tqty,\r\n\t\tstack,\r\n\t});\r\n}\r\n\r\nfunction isValidActor(actor, id) {\r\n\tif (!isPlayedActor(actor) || (id && actor.id === id)) return false;\r\n\treturn (\r\n\t\tactor.hasPlayerOwner &&\r\n\t\t!actor.isToken &&\r\n\t\tactor.isOfType(\"character\", \"npc\", \"vehicle\")\r\n\t);\r\n}\r\n\r\nfunction getDetailsFromData(data) {\r\n\tif (data.tokenId || data.type !== \"Item\" || !data.uuid) return;\r\n\r\n\tconst item = fromUuidSync(data.uuid);\r\n\tif (!item) return;\r\n\r\n\tlet actor = item.actor;\r\n\tif (!actor) {\r\n\t\tconst actorUUID = data.context?.origin.actor;\r\n\t\tactor = actorUUID ? fromUuidSync(actorUUID) : null;\r\n\t}\r\n\r\n\tif (!isValidActor(actor) || !actor.isOwner) return;\r\n\r\n\tconst isIndex = !(item instanceof Item);\r\n\tif (isIndex && item.pack && [\"effect\", \"condition\"].includes(item.type))\r\n\t\treturn { actor, item, value: data.value };\r\n\tif (!isIndex && item.isOfType(\"physical\", \"effect\"))\r\n\t\treturn { actor, item, value: data.value };\r\n}\r\n\r\nasync function takethCondition({ targetId, uuid, value }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\ttarget.increaseCondition(item.slug, { min: value });\r\n}\r\n\r\nasync function takethEffect({ targetId, uuid }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\tconst source = item\r\n\t\t.clone({ \"system.tokenIcon.show\": true, \"system.unidentified\": false })\r\n\t\t.toObject();\r\n\ttarget.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n\r\nasync function takethPhysical(\r\n\t{ itemId, ownerId, qty, stack, targetId },\r\n\tsenderId,\r\n) {\r\n\tconst owner = game.actors.get(ownerId);\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!owner || !target) return;\r\n\r\n\tconst item = owner.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tconst itemQuantity = Math.min(qty, item.quantity);\r\n\tconst newItem = await transferItemToActor(\r\n\t\ttarget,\r\n\t\titem,\r\n\t\titemQuantity,\r\n\t\tundefined,\r\n\t\tstack,\r\n\t);\r\n\r\n\tif (getSetting(\"giveth\") === \"no-message\") return;\r\n\r\n\tconst message = localize(\"giveth.giveth\", {\r\n\t\tgiver: getHighestName(owner),\r\n\t\tquantity: itemQuantity,\r\n\t\titem: await createFancyLink(newItem),\r\n\t\trecipient: getHighestName(target),\r\n\t});\r\n\r\n\tawait createTradeMessage(\r\n\t\tlocalize(\"giveth.subtitle\"),\r\n\t\tmessage,\r\n\t\towner,\r\n\t\tnewItem,\r\n\t\tsenderId,\r\n\t);\r\n}\r\n", "import { getOwner, subLocalize, templatePath } from \"module-api\";\r\nimport { getHeroActions, sendTradeRequest } from \"../../features/hero\";\r\n\r\nconst localize = subLocalize(\"hero.templates.trade\");\r\n\r\nexport class Trade extends Application {\r\n\tconstructor(actor) {\r\n\t\tsuper({ id: `pf2e-hero-actions-trade-${actor.id}` });\r\n\t\tthis._actor = actor;\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn mergeObject(Application.defaultOptions, {\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\ttemplate: templatePath(\"hero/trade\"),\r\n\t\t\twidth: 600,\r\n\t\t\theight: \"auto\",\r\n\t\t});\r\n\t}\r\n\r\n\tget actor() {\r\n\t\treturn this._actor;\r\n\t}\r\n\r\n\tget target() {\r\n\t\treturn this._target;\r\n\t}\r\n\r\n\tset target(value) {\r\n\t\tif (!value) {\r\n\t\t\tlocalize.error(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (value === this._target) return;\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t\tthis._target = value;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(), {\r\n\t\t\tactor: this.actor,\r\n\t\t\ttarget: this.target,\r\n\t\t\ttargets: game.actors.filter(\r\n\t\t\t\t(x) =>\r\n\t\t\t\t\tx.type === \"character\" && x.id !== this.actor.id && x.hasPlayerOwner,\r\n\t\t\t),\r\n\t\t\tactions: getHeroActions(this.actor),\r\n\t\t\ttargetActions: this.target ? getHeroActions(this.target) : [],\r\n\t\t\ti18n: localize.template,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\t\thtml\r\n\t\t\t.find('select[name=\"target\"]')\r\n\t\t\t.on(\"change\", this.#onChangeTarget.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"description\"]')\r\n\t\t\t.on(\"click\", this.#onDescription.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"trade\"]')\r\n\t\t\t.on(\"click\", this.#onSendTrade.bind(this));\r\n\t\thtml.find('[data-action=\"cancel\"]').on(\"click\", () => this.close());\r\n\t}\r\n\r\n\trender(force, options) {\r\n\t\tthis.actor.apps[this.appId] = this;\r\n\t\tif (this.target) this.target.apps[this.appId] = this;\r\n\t\treturn super.render(force, options);\r\n\t}\r\n\r\n\tasync close(options) {\r\n\t\tawait super.close(options);\r\n\t\tdelete this.actor.apps?.[this.appId];\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t}\r\n\r\n\t#onSendTrade() {\r\n\t\tif (!this.target) {\r\n\t\t\tlocalize.warn(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst action = this.element.find('[name=\"action\"]:checked').val();\r\n\t\tconst target = this.element.find('[name=\"targetAction\"]:checked').val();\r\n\r\n\t\tif (typeof action !== \"string\" || typeof target !== \"string\") {\r\n\t\t\tlocalize.warn(\"no-select\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst user = getOwner(this.target) ?? game.users.activeGM;\r\n\r\n\t\tif (!user) {\r\n\t\t\tlocalize.warn(\"no-user\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsendTradeRequest({\r\n\t\t\tsender: {\r\n\t\t\t\tid: game.user.id,\r\n\t\t\t\tcid: this.actor.id,\r\n\t\t\t\tuuid: action,\r\n\t\t\t},\r\n\t\t\treceiver: {\r\n\t\t\t\tid: user.id,\r\n\t\t\t\tcid: this.target.id,\r\n\t\t\t\tuuid: target,\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\tasync #onDescription(event) {\r\n\t\tconst uuid = $(event.currentTarget).siblings(\"input\").val();\r\n\t\tconst entry = await fromUuid(uuid);\r\n\t\tentry?.sheet.render(true);\r\n\t}\r\n\r\n\t#onChangeTarget(event) {\r\n\t\tconst id = event.currentTarget.value;\r\n\t\tthis.target = game.actors.get(id);\r\n\t}\r\n}\r\n", "import {\r\n\tchatUUID,\r\n\terror,\r\n\tgetSetting,\r\n\tisActiveGM,\r\n\tlocalize,\r\n\trefreshActorSheets,\r\n\trender,\r\n\tsetSetting,\r\n\tsubLocalize,\r\n\ttemplatePath,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor-sheet\";\r\nimport { Trade } from \"../apps/hero/trade\";\r\nimport { calledIfSetting } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nconst STANDALONE_ID = \"pf2e-hero-actions\";\r\n\r\nconst JOURNAL_UUID = \"Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko\";\r\nconst TABLE_UUID = \"Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK\";\r\n\r\nconst TABLE_ICON = \"systems/pf2e/icons/features/feats/heroic-recovery.webp\";\r\n\r\nexport const heroOptions = {\r\n\tname: \"heroActions\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"hero\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t\t{\r\n\t\t\tkey: \"hero-table\",\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"\",\r\n\t\t},\r\n\t\t{\r\n\t\t\tkey: \"hero-trade\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tonChange: () => refreshActorSheets(\"character\"),\r\n\t\t},\r\n\t\t{\r\n\t\t\tkey: \"hero-private\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t},\r\n\t],\r\n\tsocket: onSocket,\r\n\thooks: [[\"renderCharacterSheetPF2e\", renderCharacterSheetPF2e]],\r\n\tconflicts: [STANDALONE_ID],\r\n\tapi: {\r\n\t\tcreateTable,\r\n\t\tremoveHeroActions,\r\n\t\tgetHeroActions,\r\n\t\tuseHeroAction,\r\n\t\tgetHeroActionDetails,\r\n\t\tdrawHeroAction,\r\n\t\tdrawHeroActions,\r\n\t\tsendActionToChat,\r\n\t\tdiscardHeroActions,\r\n\t\ttradeHeroAction,\r\n\t\tgetDeckTable,\r\n\t\tgiveHeroActions,\r\n\t\tcreateChatMessage,\r\n\t},\r\n\tinit: calledIfSetting(setup, \"hero\"),\r\n};\r\n\r\nconst { socket, setHook } = createTool(heroOptions);\r\n\r\nfunction setup(value) {\r\n\tsocket.toggle(value);\r\n\tsetHook(value);\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tswitch (packet.type) {\r\n\t\tcase \"hero.trade-reject\":\r\n\t\t\tif (packet.sender.id !== game.user.id) return;\r\n\t\t\tonTradeRejected(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-accept\":\r\n\t\t\tif (!isActiveGM()) return;\r\n\t\t\tonTradeAccepted(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-request\":\r\n\t\t\tif (packet.receiver.id !== game.user.id) return;\r\n\t\t\tonTradeRequest(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-error\":\r\n\t\t\tif (!packet.users.includes(game.user.id)) return;\r\n\t\t\tonTradeError(packet.error);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tawait addActionsToSheet(html, actor);\r\n\taddSheetEvents(html, actor);\r\n}\r\n\r\nasync function addActionsToSheet(html, actor) {\r\n\tconst actions = getHeroActions(actor);\r\n\tconst diff = actor.heroPoints.value - actions.length;\r\n\tconst isOwner = actor.isOwner;\r\n\tconst localize = subLocalize(\"hero.templates.heroActions\");\r\n\r\n\tconst template = await render(\"hero/sheet\", {\r\n\t\towner: isOwner,\r\n\t\tlist: actions,\r\n\t\tcanUse: diff >= 0 && isOwner,\r\n\t\tcanDraw: diff > 0 && isOwner,\r\n\t\tcanTrade: getSetting(\"hero-trade\"),\r\n\t\tmustDiscard: diff < 0,\r\n\t\tdiff: Math.abs(diff),\r\n\t\ti18n: localize.template,\r\n\t});\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)\",\r\n\t\t)\r\n\t\t.first()\r\n\t\t.after(template);\r\n}\r\n\r\nfunction addSheetEvents(html, actor) {\r\n\tconst list = html.find(\".tab.actions .heroActions-list\");\r\n\tlist\r\n\t\t.find(\"[data-action=draw]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionsDraw(actor, event));\r\n\tlist.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\tlist\r\n\t\t.find(\"[data-action=use]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionUse(actor, event));\r\n\tlist\r\n\t\t.find(\"[data-action=display]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionDisplay(actor, event));\r\n\tlist.find(\"[data-action=discard]\").on(\"click\", onClickHeroActionDiscard);\r\n\tlist\r\n\t\t.find(\"[data-action=discard-selected]\")\r\n\t\t.on(\"click\", () => onClickHeroActionsDiscard(actor, html));\r\n\thtml\r\n\t\t.find(\"[data-action=hero-actions-trade]\")\r\n\t\t.on(\"click\", () => tradeHeroAction(actor));\r\n}\r\n\r\nasync function onClickHeroActionsDiscard(actor, html) {\r\n\tconst discarded = html.find(\r\n\t\t\".tab.actions .heroActions-list .action.discarded\",\r\n\t);\r\n\tconst uuids = discarded.toArray().map((x) => x.dataset.uuid);\r\n\tdiscardHeroActions(actor, uuids);\r\n}\r\n\r\nfunction onClickHeroActionDiscard(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst list = action.closest(\".heroActions-list\");\r\n\r\n\taction.toggleClass(\"discarded\");\r\n\r\n\tconst toDiscard = Number(list.attr(\"data-discard\") ?? \"0\");\r\n\tconst $discarded = list.find(\".action.discarded\");\r\n\r\n\tlist.toggleClass(\"discardable\", $discarded.length === toDiscard);\r\n}\r\n\r\nasync function onClickHeroActionDisplay(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tsendActionToChat(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionUse(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tuseHeroAction(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionsDraw(actor, event) {\r\n\tevent.preventDefault();\r\n\tdrawHeroActions(actor);\r\n}\r\n\r\nexport function getHeroActions(actor) {\r\n\treturn getProperty(actor, `flags.${STANDALONE_ID}.heroActions`) ?? [];\r\n}\r\n\r\nasync function setHeroActions(actor, actions) {\r\n\treturn actor.update({ [`flags.${STANDALONE_ID}.heroActions`]: actions });\r\n}\r\n\r\nasync function onClickHeroActionExpand(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst summary = action.find(\".item-summary\");\r\n\r\n\tif (!summary.hasClass(\"loaded\")) {\r\n\t\tconst uuid = action.attr(\"data-uuid\");\r\n\t\tconst details = await getHeroActionDetails(uuid);\r\n\t\tif (!details) return;\r\n\r\n\t\tconst text = await TextEditor.enrichHTML(details.description, {\r\n\t\t\tasync: true,\r\n\t\t});\r\n\r\n\t\tsummary.find(\".item-description\").html(text);\r\n\t\tsummary.addClass(\"loaded\");\r\n\t}\r\n\r\n\taction.toggleClass(\"expanded\");\r\n}\r\n\r\nasync function getHeroActionDetails(uuid) {\r\n\tconst document = await fromUuid(uuid);\r\n\tif (!document) return undefined;\r\n\r\n\tconst parent = document instanceof JournalEntry ? document : document.parent;\r\n\tconst page =\r\n\t\tdocument instanceof JournalEntry ? document.pages.contents[0] : document;\r\n\r\n\tlet text = page?.text.content;\r\n\tif (!text) return undefined;\r\n\r\n\tif (parent.uuid === JOURNAL_UUID)\r\n\t\ttext = text.replace(/^<p>/, \"<p><strong>Trigger</strong> \");\r\n\treturn { name: page.name, description: text };\r\n}\r\n\r\nexport async function drawHeroActions(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst nb = actor.heroPoints.value - actions.length;\r\n\r\n\tconst drawn = [];\r\n\tfor (let i = 0; i < nb; i++) {\r\n\t\tconst action = await drawHeroAction();\r\n\r\n\t\tif (action === undefined) continue;\r\n\t\tif (action === null) return;\r\n\r\n\t\tactions.push(action);\r\n\t\tdrawn.push(action);\r\n\t}\r\n\r\n\tif (!drawn.length) return;\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: drawn,\r\n\t\tlabel: (nb) => localize(\"hero.actions-draw.header\", { nb }),\r\n\t\tsecret: true,\r\n\t});\r\n}\r\n\r\nfunction createChatMessage({ actor, actions, label, secret = false }) {\r\n\tconst { content, size } = chatActions(actions);\r\n\r\n\tlabel = typeof label === \"function\" ? label(size) : label;\r\n\r\n\tconst data = {\r\n\t\tflavor: `<h4 class=\"action\">${label}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t};\r\n\r\n\tif (secret && getSetting(\"hero-private\")) {\r\n\t\tdata.type = CONST.CHAT_MESSAGE_TYPES.ROLL;\r\n\t\tdata.rollMode = CONST.DICE_ROLL_MODES.PRIVATE;\r\n\t}\r\n\r\n\tChatMessage.create(data);\r\n}\r\n\r\nfunction chatActions(actions) {\r\n\tconst links = actions.map(({ uuid, name }) => chatUUID(uuid, name));\r\n\treturn {\r\n\t\tcontent: links\r\n\t\t\t.map((x) => `<div style=\"line-height: 1.6;\">${x}</div>`)\r\n\t\t\t.join(\"\"),\r\n\t\tsize: links.length,\r\n\t};\r\n}\r\n\r\nfunction tradeHeroAction(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tif (!actions || !actions.length) {\r\n\t\twarn(\"hero.no-action\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst diff = actions.length - actor.heroPoints.value;\r\n\tif (diff > 0) {\r\n\t\twarn(\"hero.no-points\", { nb: diff.toString() });\r\n\t\treturn;\r\n\t}\r\n\r\n\tnew Trade(actor).render(true);\r\n}\r\n\r\nasync function drawHeroAction() {\r\n\tconst table = await getDeckTable();\r\n\tconst localize = subLocalize(\"hero.table\");\r\n\r\n\tif (!table) {\r\n\t\tlocalize.error(\"drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (!table.formula) {\r\n\t\tif (game.user.isGM) {\r\n\t\t\tif (table.compendium) {\r\n\t\t\t\tlocalize.error(\"noFormulaCompendium\", true);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\tawait table.normalize();\r\n\t\t} else {\r\n\t\t\tlocalize.error(\"noFormula\", true);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tif (table.replacement === false) {\r\n\t\tconst notDrawn = table.results.some((r) => !r.drawn);\r\n\t\tif (!notDrawn) await table.resetResults();\r\n\t}\r\n\r\n\tconst draw = (await table.draw({ displayChat: false })).results[0];\r\n\tif (!draw) return;\r\n\r\n\tconst uuid = documentUuidFromTableResult(draw);\r\n\tif (uuid) return { uuid, name: await getLabelfromTableResult(draw, uuid) };\r\n}\r\n\r\nasync function useHeroAction(actor, uuid) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst points = actor.heroPoints.value;\r\n\tif (points < 1) return warn(\"hero.use.noPoints\");\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\r\n\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\tif (index === -1) return;\r\n\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) error(\"hero.use.noDetails\");\r\n\r\n\tactions.splice(index, 1);\r\n\r\n\tif (details) {\r\n\t\tactor.update({\r\n\t\t\t\"system.resources.heroPoints.value\": points - 1,\r\n\t\t\t[`flags.${STANDALONE_ID}.heroActions`]: actions,\r\n\t\t});\r\n\r\n\t\tChatMessage.create({\r\n\t\t\tflavor: `<h4 class=\"action\">${localize(\"hero.actions-use.header\")}</h4>`,\r\n\t\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\t\tspeaker: ChatMessage.getSpeaker({ actor }),\r\n\t\t});\r\n\t} else {\r\n\t\tsetHeroActions(actor, actions);\r\n\t}\r\n}\r\n\r\nasync function discardHeroActions(actor, actionsUUIDS) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst uuids =\r\n\t\ttypeof actionsUUIDS === \"string\" ? [actionsUUIDS] : actionsUUIDS;\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst removed = [];\r\n\r\n\tfor (const uuid of uuids) {\r\n\t\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\t\tif (index === -1) continue;\r\n\t\tremoved.push(actions[index]);\r\n\t\tactions.splice(index, 1);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: removed,\r\n\t\tlabel: (nb) => localize(\"hero.actions-discard.header\", { nb }),\r\n\t});\r\n}\r\n\r\nasync function getLabelfromTableResult(result, uuid) {\r\n\tif (result.type !== CONST.TABLE_RESULT_TYPES.TEXT) return result.text;\r\n\tconst label = /@UUID\\[[\\w\\.]+\\]{([\\w -]+)}/.exec(result.text)?.[1];\r\n\treturn label ?? (uuid && (await fromUuid(uuid))?.name);\r\n}\r\n\r\nasync function getTableFromUuid(uuid) {\r\n\tif (!uuid) return undefined;\r\n\tconst table = await fromUuid(uuid);\r\n\treturn table && table instanceof RollTable ? table : undefined;\r\n}\r\n\r\nasync function getDefaultCompendiumTable() {\r\n\treturn getTableFromUuid(TABLE_UUID);\r\n}\r\n\r\nfunction getDefaultWorldTable() {\r\n\treturn game.tables.find((x) => x.getFlag(\"core\", \"sourceId\") === TABLE_UUID);\r\n}\r\n\r\nasync function getCustomTable() {\r\n\treturn getTableFromUuid(getSetting(\"hero-table\"));\r\n}\r\n\r\nasync function getDeckTable() {\r\n\treturn (\r\n\t\t(await getCustomTable()) ??\r\n\t\tgetDefaultWorldTable() ??\r\n\t\t(await getDefaultCompendiumTable())\r\n\t);\r\n}\r\n\r\nasync function sendActionToChat(actor, uuid) {\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) return error(\"hero.details.missing\");\r\n\r\n\tChatMessage.create({\r\n\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t});\r\n}\r\n\r\nexport function sendTradeRequest(trade) {\r\n\tif (trade.receiver.id === game.user.id) {\r\n\t\tacceptRequest(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocket.emit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-request\",\r\n\t});\r\n}\r\n\r\nfunction acceptRequest(trade) {\r\n\tif (game.user.isGM) {\r\n\t\tonTradeAccepted(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocket.emit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-accept\",\r\n\t});\r\n}\r\n\r\nasync function onTradeAccepted(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderActions = getHeroActions(senderActor);\r\n\tconst receiverActions = getHeroActions(receiverActor);\r\n\r\n\tconst senderActionIndex = senderActions.findIndex(\r\n\t\t(x) => x.uuid === sender.uuid,\r\n\t);\r\n\tconst receiverActionIndex = receiverActions.findIndex(\r\n\t\t(x) => x.uuid === receiver.uuid,\r\n\t);\r\n\r\n\tif (senderActionIndex === -1 || receiverActionIndex === -1) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderAction = senderActions.splice(senderActionIndex, 1)[0];\r\n\tconst receiverAction = receiverActions.splice(receiverActionIndex, 1)[0];\r\n\r\n\tsenderActions.push(receiverAction);\r\n\treceiverActions.push(senderAction);\r\n\r\n\tsetHeroActions(senderActor, senderActions);\r\n\tsetHeroActions(receiverActor, receiverActions);\r\n\r\n\tconst sentLink = chatUUID(senderAction.uuid);\r\n\tconst receivedLink = chatUUID(receiverAction.uuid);\r\n\r\n\tconst localize = subLocalize(\"hero.trade-success\");\r\n\r\n\tlet content = `<div style=\"line-height: 1.6\">${localize(\"offer\", {\r\n\t\toffer: sentLink,\r\n\t})}</div>`;\r\n\tcontent += `<div style=\"line-height: 1.6\">${localize(\"receive\", {\r\n\t\treceive: receivedLink,\r\n\t})}</div>`;\r\n\r\n\tChatMessage.create({\r\n\t\tflavor: `<h4 class=\"action\">${localize(\"header\", {\r\n\t\t\tname: receiverActor.name,\r\n\t\t})}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: senderActor }),\r\n\t});\r\n}\r\n\r\nfunction sendTradeError({ sender, receiver }, error = \"trade-error\") {\r\n\tconst users = new Set([sender.id, receiver.id]);\r\n\r\n\tif (users.has(game.user.id)) {\r\n\t\tusers.delete(game.user.id);\r\n\t\tonTradeError(error);\r\n\t}\r\n\r\n\tif (!users.size) return;\r\n\r\n\tsocket.emit({\r\n\t\ttype: \"hero.trade-error\",\r\n\t\tusers: Array.from(users),\r\n\t\terror,\r\n\t});\r\n}\r\n\r\nfunction onTradeError(err) {\r\n\terror(\"hero.trade-error\");\r\n}\r\n\r\nasync function onTradeRequest(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.trade-request\");\r\n\r\n\tlet content = `<p>${localize(\"header\", {\r\n\t\tsender: senderActor.name,\r\n\t\treceiver: receiverActor.name,\r\n\t})}</p>`;\r\n\tcontent += `<p>${localize(\"give\", { give: chatUUID(sender.uuid) })}</p>`;\r\n\tcontent += `<p>${localize(\"want\", { want: chatUUID(receiver.uuid) })}</p>`;\r\n\tcontent += `<p style=\"margin-bottom: 1em;\">${localize(\"accept\")}</p>`;\r\n\r\n\tconst accept = await Dialog.confirm({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await TextEditor.enrichHTML(content, { async: true }),\r\n\t});\r\n\r\n\tif (accept) acceptRequest(trade);\r\n\telse rejectRequest(trade);\r\n}\r\n\r\nfunction rejectRequest(trade) {\r\n\tif (trade.sender.id === game.user.id) {\r\n\t\tonTradeRejected(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocket.emit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-reject\",\r\n\t});\r\n}\r\n\r\nasync function onTradeRejected({ receiver }) {\r\n\tconst actor = game.actors.get(receiver.cid);\r\n\twarn(\"hero.trade-rejected\", { name: actor.name }, true);\r\n}\r\n\r\nasync function createTable() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.createTable.choice\");\r\n\tconst template = templatePath(\"hero/dialogs/create-table\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"create\"),\r\n\t\t\ticon: '<i class=\"fas fa-border-all\"></i>',\r\n\t\t\tcallback: (html) => {\r\n\t\t\t\tconst type = html\r\n\t\t\t\t\t.find('.window-content input[name=\"type\"]:checked')\r\n\t\t\t\t\t.val();\r\n\t\t\t\tconst unique =\r\n\t\t\t\t\thtml.find('.window-content input[name=\"draw\"]:checked').val() ===\r\n\t\t\t\t\t\"unique\";\r\n\t\t\t\treturn { type, unique };\r\n\t\t\t},\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, { i18n: localize.template }),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-create-table\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tif (result.type === \"default\") createDefaultTable(result.unique);\r\n\telse createCustomTable(result.unique);\r\n}\r\n\r\nasync function createCustomTable(unique) {\r\n\tconst table = await createCustomActionsTable(unique);\r\n\tawait setTable(table);\r\n\ttable.sheet?.render(true);\r\n}\r\n\r\nfunction createCustomActionsTable(unique = true) {\r\n\tconst source = getTableSource(unique);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function createDefaultTable(unique) {\r\n\tconst localize = subLocalize(\"templates.createTable.default.confirm\");\r\n\tlet table = await getDefaultWorldTable();\r\n\r\n\tif (table) {\r\n\t\tconst override = await Dialog.confirm({\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tcontent: localize(\"content\"),\r\n\t\t});\r\n\r\n\t\tif (override) {\r\n\t\t\tconst update = getTableSource(unique);\r\n\t\t\tawait table.update(update);\r\n\t\t\treturn setTable(table, true);\r\n\t\t}\r\n\t}\r\n\r\n\ttable = await createDefautActionsTable(unique);\r\n\tawait setTable(table);\r\n}\r\n\r\nasync function createDefautActionsTable(unique = true) {\r\n\tconst table = await fromUuid(TABLE_UUID);\r\n\tconst source = getTableSource(unique, table);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function setTable(table, normalize = false) {\r\n\tif (normalize) await table.normalize();\r\n\tawait setSetting(\"hero-table\", table.uuid);\r\n}\r\n\r\nfunction getTableSource(unique, table) {\r\n\tconst source = {\r\n\t\tname: localize(\"hero.table.name\"),\r\n\t\treplacement: !(unique ?? true),\r\n\t\timg: TABLE_ICON,\r\n\t\tdescription: localize(\"hero.table.description\"),\r\n\t\tflags: {\r\n\t\t\tcore: {\r\n\t\t\t\tsourceId: TABLE_UUID,\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\tif (!table) return source;\r\n\treturn mergeObject(deepClone(table._source), source);\r\n}\r\n\r\nasync function removeHeroActions() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.removeActions\");\r\n\tconst template = templatePath(\"hero/dialogs/remove-actions\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"remove\"),\r\n\t\t\ticon: '<i class=\"fas fa-trash\"></i>',\r\n\t\t\tcallback: (html) =>\r\n\t\t\t\thtml\r\n\t\t\t\t\t.find('input[name=\"actor\"]:checked')\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((x) => game.actors.get(x.value))\r\n\t\t\t\t\t.filter((x) => x),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, {\r\n\t\t\tactors: game.actors.filter((x) => x.type === \"character\"),\r\n\t\t\ti18n: localize.template,\r\n\t\t}),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\trender: (html) => {\r\n\t\t\thtml.on(\"change\", 'input[name=\"all\"]', () =>\r\n\t\t\t\tremoveActionsToggleAll(html),\r\n\t\t\t);\r\n\t\t\thtml.on(\"change\", 'input[name=\"actor\"]', () =>\r\n\t\t\t\tremoveActionsToggleActor(html),\r\n\t\t\t);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst actors = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-remove-actions\",\r\n\t});\r\n\r\n\tif (!actors) return;\r\n\r\n\tif (!actors.length) {\r\n\t\tlocalize.warn(\"noSelection\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const actor of actors) {\r\n\t\tsetHeroActions(actor, []);\r\n\t}\r\n\r\n\tlocalize.info(\"removed\");\r\n}\r\n\r\nfunction removeActionsToggleAll(html) {\r\n\tconst state = html.find('input[name=\"all\"]')[0].checked;\r\n\thtml.find('input[name=\"actor\"]').prop(\"checked\", state);\r\n}\r\n\r\nfunction removeActionsToggleActor(html) {\r\n\tconst actors = html.find('input[name=\"actor\"]');\r\n\tconst checked = actors.filter(\":checked\");\r\n\tconst all = html.find('input[name=\"all\"]');\r\n\r\n\tif (actors.length === checked.length) {\r\n\t\tall.prop(\"checked\", true).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", true);\r\n\t} else if (!checked.length) {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", false);\r\n\t} else {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", true);\r\n\t}\r\n}\r\n\r\nfunction documentUuidFromTableResult(result) {\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.TEXT)\r\n\t\treturn /@UUID\\[([\\w\\.]+)\\]/.exec(result.text)?.[1];\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.DOCUMENT)\r\n\t\treturn `${result.documentCollection}.${result.documentId}`;\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.COMPENDIUM)\r\n\t\treturn `Compendium.${result.documentCollection}.${result.documentId}`;\r\n\treturn undefined;\r\n}\r\n\r\nasync function giveHeroActions(actor) {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst templateLocalize = subLocalize(\"hero.templates.giveAction\");\r\n\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\ttemplateLocalize.warn(\"noCharacter\");\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst table = await getDeckTable();\r\n\tif (!table) {\r\n\t\terror(\"hero.table.drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst isUnique = table.replacement === false;\r\n\r\n\tconst actionsList = (\r\n\t\tawait Promise.all(\r\n\t\t\ttable.results.map(async (result) => {\r\n\t\t\t\tconst uuid = documentUuidFromTableResult(result);\r\n\t\t\t\tif (!uuid) return;\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tkey: result.id,\r\n\t\t\t\t\tuuid,\r\n\t\t\t\t\tname: await getLabelfromTableResult(result, uuid),\r\n\t\t\t\t\tdrawn: result.drawn,\r\n\t\t\t\t};\r\n\t\t\t}),\r\n\t\t)\r\n\t).filter(Boolean);\r\n\r\n\tconst template = templatePath(\"hero/dialogs/give-action\");\r\n\tconst content = await renderTemplate(template, {\r\n\t\tactions: actionsList,\r\n\t\tisUnique,\r\n\t\ti18n: templateLocalize,\r\n\t});\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: templateLocalize(\"give\"),\r\n\t\t\ticon: '<i class=\"fa-solid fa-gift\"></i>',\r\n\t\t\tcallback: (html) => ({\r\n\t\t\t\tselected: html\r\n\t\t\t\t\t.find(\"[name=action]:checked\")\r\n\t\t\t\t\t.closest(\".action\")\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((el) => el.dataset),\r\n\t\t\t\tasDrawn: html.find(\"[name=drawn]\").prop(\"checked\") ?? false,\r\n\t\t\t\twithMessage: html.find(\"[name=message]\").prop(\"checked\"),\r\n\t\t\t}),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: templateLocalize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\ttitle: templateLocalize(\"title\"),\r\n\t\tcontent,\r\n\t\tbuttons,\r\n\t\trender: (html) => {\r\n\t\t\thtml.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-give-action\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst { selected, asDrawn, withMessage } = result;\r\n\tconst actions = getHeroActions(actor);\r\n\tconst tableUpdates = [];\r\n\r\n\tfor (const { uuid, name, key } of selected) {\r\n\t\tactions.push({ uuid, name });\r\n\t\tif (!asDrawn) continue;\r\n\r\n\t\tconst result = table.results.get(key);\r\n\t\tif (result && !result.drawn) tableUpdates.push(key);\r\n\t}\r\n\r\n\tif (tableUpdates.length) {\r\n\t\tawait table.updateEmbeddedDocuments(\r\n\t\t\t\"TableResult\",\r\n\t\t\ttableUpdates.map((key) => ({ _id: key, drawn: true })),\r\n\t\t);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\r\n\tif (withMessage) {\r\n\t\tcreateChatMessage({\r\n\t\t\tactor,\r\n\t\t\tactions: selected,\r\n\t\t\tlabel: (nb) => localize(\"hero.actions-give.header\", { nb }),\r\n\t\t\tsecret: true,\r\n\t\t});\r\n\t}\r\n}\r\n", "import { calculateDistanceBetweenPoints, getElementIndex } from \"module-api\";\r\n\r\n/** @type {DraggableData | null} */\r\nlet dragData = null;\r\n\r\nlet DRAG_ID = 0;\r\n\r\n/**\r\n * @template {DraggableOptions | DroppableOptions} T\r\n * @param {T} options\r\n * @param {OptionsFilter<T>} filters\r\n */\r\nfunction cleanOptions(options, filters) {\r\n\tfor (const [type, keys] of Object.entries(filters)) {\r\n\t\tfor (const key of keys) {\r\n\t\t\tconst option = options[key];\r\n\t\t\t// biome-ignore lint/suspicious/useValidTypeof: <explanation>\r\n\t\t\tif (!option || typeof option === type) continue;\r\n\t\t\toptions[option] = undefined;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {DraggableOptions} options\r\n */\r\nexport function makeDraggable(options) {\r\n\tif (!(options.element instanceof HTMLElement)) return;\r\n\r\n\tcleanOptions(options, {\r\n\t\tstring: [\"draggedClass\", \"group\", \"selector\", \"filter\", \"identifier\"],\r\n\t\tnumber: [\"triggerDistance\"],\r\n\t\tboolean: [\"cancelOnRightClick\"],\r\n\t\tfunction: [\"onCancel\", \"onDragEnd\", \"onDragStart\"],\r\n\t});\r\n\r\n\toptions.triggerDistance ??= 6;\r\n\r\n\toptions.cancelOnRightClick ??= true;\r\n\r\n\toptions.cursorImage ??= {};\r\n\toptions.cursorImage.id =\r\n\t\ttypeof options.cursorImage.id === \"string\" ? options.cursorImage.id : \"\";\r\n\toptions.cursorImage.img =\r\n\t\ttypeof options.cursorImage.img === \"function\"\r\n\t\t\t? options.cursorImage.img\r\n\t\t\t: undefined;\r\n\r\n\toptions.droppables ??= [];\r\n\r\n\tfor (let i = options.droppables.length - 1; i >= 0; i--) {\r\n\t\tconst droppable = options.droppables[i];\r\n\r\n\t\tif (!(droppable.element instanceof HTMLElement)) {\r\n\t\t\toptions.droppables.splice(i, 1);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tcleanOptions(droppable, {\r\n\t\t\tstring: [\"selector\", \"overClass\", \"filter\"],\r\n\t\t\tboolean: [\"purgeOnLeave\"],\r\n\t\t\tfunction: [\"onDragEnter\", \"onDragLeave\", \"onDragOver\", \"onDrop\"],\r\n\t\t});\r\n\t}\r\n\r\n\toptions.element.addEventListener(\"mousedown\", (event) =>\r\n\t\tonMouseDown(event, options),\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragCancel(event) {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.canceled = true;\r\n\r\n\tif (dragData.dragging && dragData.draggable.ghost) {\r\n\t\tdragData.draggable.ghost.reset();\r\n\t}\r\n\r\n\tif (dragData.dragging && dragData.options.onCancel) {\r\n\t\tawait dragData.options.onCancel(event, dragData.draggable);\r\n\t}\r\n\r\n\tcleanUp();\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragEnd(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging && dragData.options.onDragEnd) {\r\n\t\tawait dragData.options.onDragEnd(event, dragData.draggable, {\r\n\t\t\tcanceled: dragData.canceled,\r\n\t\t\tdropped: dragData.dropped,\r\n\t\t});\r\n\t}\r\n\r\n\twindow.removeEventListener(\"mousemove\", onMouseMove);\r\n\twindow.removeEventListener(\"mouseup\", onMouseUp);\r\n\r\n\tdragData = null;\r\n}\r\n\r\nfunction cleanUp() {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.draggable.classList.purge();\r\n\tdragData.draggable.ghost?.classList.purge();\r\n\tdragData.cursorElement?.remove();\r\n\r\n\tfor (const { classList } of Object.values(dragData.hovered)) {\r\n\t\tclassList.purge();\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n * @param {DraggableOptions} options\r\n */\r\nfunction onMouseDown(event, options) {\r\n\tif (\r\n\t\tevent.button === 2 &&\r\n\t\tdragData?.dragging &&\r\n\t\tdragData.options.cancelOnRightClick\r\n\t) {\r\n\t\tonDragCancel(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (event.button) return;\r\n\r\n\tconst target = closestInside(event.target, options.element, options);\r\n\tif (!target) return;\r\n\r\n\t/** @type {DraggableGhost | undefined} */\r\n\tlet _ghost;\r\n\r\n\tconst targetIndex = getElementIndex(target);\r\n\tconst targetParent = target.parentElement;\r\n\tconst targetClassList = newClassList(target);\r\n\r\n\t/** @type {DraggableData} */\r\n\tdragData = {\r\n\t\tcanceled: false,\r\n\t\tdragging: false,\r\n\t\tdropped: false,\r\n\t\toptions,\r\n\t\tgroup: options.group,\r\n\t\tdraggable: {\r\n\t\t\tidentifier: options.identifier,\r\n\t\t\telement: target,\r\n\t\t\ttriggeringElement: event.target,\r\n\t\t\tx: event.clientX,\r\n\t\t\ty: event.clientY,\r\n\t\t\tparent: targetParent,\r\n\t\t\tindex: targetIndex,\r\n\t\t\tclassList: targetClassList,\r\n\t\t\tget ghost() {\r\n\t\t\t\tif (_ghost) {\r\n\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t_ghost.classList.add(options.ghostClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn _ghost;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst { element = target.cloneNode(true), index = Infinity } =\r\n\t\t\t\t\toptions.createGhost?.(target, targetIndex) ?? {};\r\n\r\n\t\t\t\tconst classList = newClassList(element);\r\n\r\n\t\t\t\tif (options.draggedClass && element !== target) {\r\n\t\t\t\t\telement.classList.remove(options.draggedClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\tclassList.add(options.ghostClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t_ghost = {\r\n\t\t\t\t\telement,\r\n\t\t\t\t\tclassList,\r\n\t\t\t\t\tindex,\r\n\t\t\t\t\treset: () => {\r\n\t\t\t\t\t\telement.remove();\r\n\t\t\t\t\t\tif (element === target) {\r\n\t\t\t\t\t\t\tconst child = targetParent.children[targetIndex];\r\n\t\t\t\t\t\t\ttargetParent.insertBefore(target, child);\r\n\t\t\t\t\t\t\t_ghost.index = targetIndex;\r\n\t\t\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t\t\tclassList.remove(options.ghostClass);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t_ghost.index = Infinity;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t};\r\n\r\n\t\t\t\treturn _ghost;\r\n\t\t\t},\r\n\t\t\tresetPosition: () => {\r\n\t\t\t\ttarget.remove();\r\n\t\t\t\ttargetParent.children[targetIndex].before(target);\r\n\t\t\t},\r\n\t\t},\r\n\t\tdroppables: options.droppables.map((droppable) => ({\r\n\t\t\t...droppable,\r\n\t\t\tid: DRAG_ID++,\r\n\t\t})),\r\n\t\thovered: {},\r\n\t};\r\n\r\n\twindow.addEventListener(\"mousemove\", onMouseMove);\r\n\twindow.addEventListener(\"mouseup\", onMouseUp);\r\n}\r\n\r\nasync function onMouseMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tonDragMove(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst { draggable } = dragData;\r\n\tconst distance = calculateDistanceBetweenPoints(\r\n\t\tdraggable.x,\r\n\t\tdraggable.y,\r\n\t\tclientX,\r\n\t\tclientY,\r\n\t);\r\n\r\n\tif (distance > dragData.options.triggerDistance) {\r\n\t\tawait onDragStart(event);\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onMouseUp(event) {\r\n\tif (event.button || !dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tlet dropped = false;\r\n\r\n\t\tcleanUp();\r\n\r\n\t\tawait Promise.all(\r\n\t\t\tObject.values(dragData.hovered).map(async (hovered) => {\r\n\t\t\t\tif (!hovered.droppable.onDrop) return;\r\n\r\n\t\t\t\tconst hasDropped = await hovered.droppable.onDrop(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\t\ttriggeringElement: hovered.triggeringElement,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (hasDropped) dropped = true;\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\tdragData.dropped = dropped;\r\n\t}\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragStart(event) {\r\n\tif (dragData.dragging) return;\r\n\r\n\tdragData.dragging = true;\r\n\r\n\tif (dragData.options.cursorImage.img) {\r\n\t\tconst img = dragData.options.cursorImage.img(dragData.draggable.element);\r\n\t\tif (img instanceof HTMLElement) {\r\n\t\t\tdragData.cursorElement = img;\r\n\t\t} else {\r\n\t\t\tdragData.cursorElement = new Image();\r\n\t\t\tdragData.cursorElement.src = typeof img === \"string\" ? img : \"\";\r\n\t\t}\r\n\t} else {\r\n\t\tdragData.cursorElement = dragData.draggable.element.cloneNode(true);\r\n\t}\r\n\r\n\tdragData.cursorElement.id = dragData.options.cursorImage.id;\r\n\r\n\tif (dragData.options.draggedClass) {\r\n\t\tdragData.draggable.classList.add(dragData.options.draggedClass);\r\n\t}\r\n\r\n\tdocument.body.appendChild(dragData.cursorElement);\r\n\r\n\tawait dragData.options.onDragStart?.(event, dragData.draggable);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst cursorElement = dragData.cursorElement;\r\n\r\n\tconst offsetX = cursorElement.offsetWidth / 2;\r\n\tconst offsetY = cursorElement.offsetHeight / 2;\r\n\r\n\tcursorElement.style.left = `${clientX - offsetX}px`;\r\n\tcursorElement.style.top = `${clientY - offsetY}px`;\r\n\r\n\tawait Promise.all(\r\n\t\tdragData.droppables.map(async (droppable) => {\r\n\t\t\tconst target = closestInside(event.target, droppable.element, {\r\n\t\t\t\tselector: droppable.selector,\r\n\t\t\t\tfilter: droppable.filter,\r\n\t\t\t});\r\n\t\t\tconst hovered = dragData.hovered[droppable.id];\r\n\r\n\t\t\tif (hovered && (!target || hovered.element !== target)) {\r\n\t\t\t\tconst left = await droppable.onDragLeave?.(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (left !== false) {\r\n\t\t\t\t\tdelete dragData.hovered[droppable.id];\r\n\t\t\t\t\tif (droppable.purgeOnLeave) {\r\n\t\t\t\t\t\thovered.classList.purge();\r\n\t\t\t\t\t} else if (droppable.overClass) {\r\n\t\t\t\t\t\thovered.classList.remove(droppable.overClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!target) return;\r\n\r\n\t\t\tif (!hovered) {\r\n\t\t\t\tconst classList = newClassList(target);\r\n\r\n\t\t\t\tconst entered = await droppable.onDragEnter?.(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (entered !== false) {\r\n\t\t\t\t\tif (droppable.overClass) classList.add(droppable.overClass);\r\n\r\n\t\t\t\t\tdragData.hovered[droppable.id] = {\r\n\t\t\t\t\t\tid: droppable.id,\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\tdroppable,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t} else if (droppable.onDragOver) {\r\n\t\t\t\tawait droppable.onDragOver(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}),\r\n\t);\r\n}\r\n\r\n/**\r\n *\r\n * @param {HTMLElement} target\r\n * @returns {DraggableClassList}\r\n */\r\nexport function newClassList(target) {\r\n\treturn new (class extends Set {\r\n\t\tadd(value) {\r\n\t\t\ttarget.classList.add(value);\r\n\t\t\tsuper.add(value);\r\n\t\t}\r\n\t\tremove(value) {\r\n\t\t\ttarget.classList.remove(value);\r\n\t\t\tsuper.delete(value);\r\n\t\t}\r\n\t\ttoggle(value, enabled) {\r\n\t\t\tconst toggled = enabled ?? !target.classList.contains(value);\r\n\t\t\tif (toggled) this.add(value);\r\n\t\t\telse this.remove(value);\r\n\t\t}\r\n\t\tcontains(value) {\r\n\t\t\treturn this.has(value);\r\n\t\t}\r\n\t\tpurge() {\r\n\t\t\ttarget.classList.remove(...this);\r\n\t\t}\r\n\t})();\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {HTMLElement} parent\r\n * @param {Object} [options]\r\n * @param {string} [options.selector]\r\n * @param {string} [options.filter]\r\n * @returns {HTMLElement | undefined}\r\n */\r\nexport function closestInside(target, parent, { selector, filter } = {}) {\r\n\tif (!parent.contains(target)) return;\r\n\r\n\tif (!selector && !filter) return parent;\r\n\r\n\tlet element;\r\n\tlet cursor = target;\r\n\r\n\twhile (true) {\r\n\t\tif (filter && cursor.matches(filter)) return;\r\n\r\n\t\tif (!element && selector && cursor.matches(selector)) {\r\n\t\t\telement = cursor;\r\n\t\t}\r\n\r\n\t\tif (cursor === parent) break;\r\n\r\n\t\tcursor = cursor.parentElement;\r\n\t}\r\n\r\n\treturn !selector ? parent : element;\r\n}\r\n", "import {\r\n\tcanBeInvested,\r\n\terror,\r\n\tgetElementIndex,\r\n\tgetFlag,\r\n\tgetInMemory,\r\n\thasWornSlot,\r\n\tindexIsValid,\r\n\tisHandwrapsOfMightyBlows,\r\n\tisHeld,\r\n\tisInvestedOrWornAs,\r\n\tisOneHanded,\r\n\tisTwoHanded,\r\n\titemCarryUpdate,\r\n\trefreshActorSheets,\r\n\trender,\r\n\tsetFlag,\r\n\tsetInMemory,\r\n} from \"module-api\";\r\nimport {\r\n\tgetCharacterSheetTab,\r\n\tisPlayedActor,\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../actor-sheet\";\r\nimport { closestInside, makeDraggable } from \"../draggable\";\r\nimport { calledIfSetting } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nlet dragging = false;\r\n\r\nexport const inventoryOptions = {\r\n\tname: \"inventory\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"inventory\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tscope: \"client\",\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t],\r\n\thooks: [[\"closeCharacterSheetPF2e\", closeCharacterSheetPF2e]],\r\n\tready: calledIfSetting(setup, \"inventory\"),\r\n};\r\n\r\nconst { setHook } = createTool(inventoryOptions);\r\n\r\nlet dragIdentifier;\r\n\r\nconst COINS = [\r\n\t\"platinum-pieces\",\r\n\t\"gold-pieces\",\r\n\t\"silver-pieces\",\r\n\t\"copper-pieces\",\r\n];\r\n\r\nfunction setup(value) {\r\n\tif (value) {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"inventory\",\r\n\t\t\ttemplateFolder: \"inventory/sheet\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t\tonRender,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"inventory\");\r\n\t}\r\n\r\n\tsetHook(value);\r\n\trefreshActorSheets(\"character\");\r\n}\r\n\r\nfunction closeCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\tif (!getInMemory(sheet, \"inventory.requireSave\")) return;\r\n\r\n\tconst tab = getCharacterSheetTab(html, \"inventory\")[0];\r\n\tconst data = getCurrentData(tab);\r\n\tif (!data) return;\r\n\r\n\tsetFlag(actor, \"inventory\", data);\r\n}\r\n\r\nfunction onRender(actor, sheet, inner) {\r\n\tconst sidebar = inner.find(\"> aside\");\r\n\tsidebar.css(\"position\", \"relative\");\r\n\tsidebar.append(\r\n\t\t\"<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>\",\r\n\t);\r\n}\r\n\r\nfunction getCurrentData(tabElement) {\r\n\tif (!tabElement) return;\r\n\r\n\tconst alternate = tabElement.querySelector(\".toolbelt-alternate\");\r\n\tif (!alternate) return;\r\n\r\n\tconst equipped = alternate.querySelector(\"[data-area='equipped']\");\r\n\r\n\tconst equippedItemId = (slot) => {\r\n\t\tconst el = equipped.querySelector(`[data-equipped-slot='${slot}']`);\r\n\t\tconst item = el.querySelector(\"[data-item-id]\");\r\n\t\treturn item?.dataset.itemId ?? null;\r\n\t};\r\n\r\n\tconst itemIds = (parent) => {\r\n\t\tconst ids = {};\r\n\t\tconst items = parent.querySelectorAll(\":scope > [data-item-id]\");\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tids[item.dataset.itemId] = i;\r\n\t\t}\r\n\t\treturn ids;\r\n\t};\r\n\r\n\tconst tabs = {};\r\n\tfor (const tab of alternate.querySelectorAll(\"[data-area='items-grid']\")) {\r\n\t\tconst tabId = tab.dataset.tabId;\r\n\t\ttabs[tabId] = itemIds(tab);\r\n\t}\r\n\r\n\treturn {\r\n\t\tequipped: {\r\n\t\t\thands: [equippedItemId(\"left-hand\"), equippedItemId(\"right-hand\")],\r\n\t\t\tarmor: [equippedItemId(\"armor\")],\r\n\t\t\tothers: itemIds(equipped),\r\n\t\t},\r\n\t\ttabs,\r\n\t};\r\n}\r\n\r\nasync function getData(actor, sheet, tabElement) {\r\n\tconst flags = getFlag(actor, \"inventory\");\r\n\tconst data = getCurrentData(tabElement[0]) ??\r\n\t\tflags ?? {\r\n\t\t\tequipped: {\r\n\t\t\t\thands: [null, null],\r\n\t\t\t\tarmor: [null],\r\n\t\t\t\tothers: {},\r\n\t\t\t},\r\n\t\t\ttabs: {},\r\n\t\t};\r\n\r\n\tif (!flags) {\r\n\t\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n\t}\r\n\r\n\tconst tabs = new Collection();\r\n\tconst orphans = {};\r\n\tconst containers = new Set();\r\n\tconst equipped = {\r\n\t\thands: [null, null],\r\n\t\tarmor: [null],\r\n\t\tothers: [],\r\n\t};\r\n\r\n\tfunction getTab(item) {\r\n\t\tconst tabId = item?.id;\r\n\r\n\t\tlet tab = tabs.get(tabId);\r\n\t\tif (tab) return tab;\r\n\r\n\t\ttab = {\r\n\t\t\tid: tabId,\r\n\t\t\titem: item,\r\n\t\t\tparent: item?.container,\r\n\t\t\tcontainers: [],\r\n\t\t\tmatrix: [],\r\n\t\t\tparents: [],\r\n\t\t};\r\n\r\n\t\ttabs.set(tabId, tab);\r\n\t\treturn tab;\r\n\t}\r\n\r\n\tfor (const item of actor.inventory) {\r\n\t\tif (\r\n\t\t\titem.isOfType(\"treasure\") &&\r\n\t\t\titem.system.stackGroup === \"coins\" &&\r\n\t\t\tCOINS.includes(item.slug)\r\n\t\t) {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst itemId = item.id;\r\n\t\tconst parent = item.container;\r\n\r\n\t\t// we retrieve the parent tab, undefined === root inventory\r\n\t\tconst tab = getTab(parent);\r\n\r\n\t\tconst addOrphan = (item) => {\r\n\t\t\torphans[tab.id] ??= [];\r\n\t\t\torphans[tab.id].push(item);\r\n\t\t};\r\n\r\n\t\tif (item.isOfType(\"backpack\")) {\r\n\t\t\ttab.containers.push(item);\r\n\t\t\tcontainers.add(item);\r\n\r\n\t\t\t// we create the tab for this container, in case it is empty\r\n\t\t\tgetTab(item);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst handsHeld = item.handsHeld;\r\n\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\tif (handsHeld === 2 && equippedHands === 0) {\r\n\t\t\tif (data.equipped.hands[0] === itemId) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (handsHeld === 1 && equippedHands <= 1) {\r\n\t\t\tconst handIndex = data.equipped.hands.indexOf(itemId);\r\n\t\t\tif (indexIsValid(handIndex)) {\r\n\t\t\t\tequipped.hands[handIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\tif (data.equipped.armor[0] === itemId) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\tisInvestedOrWornAs(item)\r\n\t\t) {\r\n\t\t\tconst equippedIndex = data.equipped.others[itemId];\r\n\t\t\tif (indexIsValid(equippedIndex)) {\r\n\t\t\t\tequipped.others[equippedIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst index = data.tabs[tab.id]?.[itemId];\r\n\t\tif (indexIsValid(index)) {\r\n\t\t\ttab.matrix[index] = item;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\taddOrphan(item);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tconst tabOrphans = orphans[tab.id];\r\n\t\tif (!tabOrphans) continue;\r\n\r\n\t\tfor (const item of tabOrphans) {\r\n\t\t\tconst handsHeld = item.handsHeld;\r\n\t\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\t\tif (equippedHands === 0 && handsHeld === 2) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (equippedHands <= 1 && handsHeld === 1) {\r\n\t\t\t\tconst otherIndex = equipped.hands[0] ? 1 : 0;\r\n\t\t\t\tequipped.hands[otherIndex] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\t\tisInvestedOrWornAs(item)\r\n\t\t\t) {\r\n\t\t\t\tequipped.others.push(item);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\ttab.matrix.push(item);\r\n\t\t}\r\n\r\n\t\ttab.matrix = tab.matrix.filter(Boolean);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tlet parent = tab.parent;\r\n\r\n\t\twhile (parent) {\r\n\t\t\ttab.parents.push(parent);\r\n\t\t\tparent = parent.container;\r\n\t\t}\r\n\r\n\t\ttab.parents.reverse();\r\n\r\n\t\tconst grouped = [tab.containers, tab.parents, tab.item].flat();\r\n\t\ttab.trailings = containers.filter((item) => !grouped.includes(item));\r\n\t}\r\n\r\n\t// if no item exist on the character, we still want one tab\r\n\tif (!tabs.size) getTab(undefined);\r\n\r\n\tequipped.others = equipped.others.filter(Boolean);\r\n\r\n\tconst activeTabId = getInMemory(sheet, \"inventory.activeTab\");\r\n\r\n\treturn {\r\n\t\ttabs: Array.from(tabs.values()),\r\n\t\tequipped,\r\n\t\tactor,\r\n\t\tselectedTab: tabs.get(activeTabId)?.id,\r\n\t\tcontainerBulk: (container) => {\r\n\t\t\tconst capacity = container.capacity;\r\n\t\t\treturn `${capacity.value.toString()} / ${capacity.max.toString()}`;\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction addEvents(tab, sheet, actor, inner) {\r\n\tconst containerTabs = tab.find(\"[data-tab-id]\");\r\n\tfor (const container of tab.find(\"[data-container-id]\")) {\r\n\t\tcontainer.addEventListener(\"click\", (event) => {\r\n\t\t\tconst tabId = container.dataset.containerId;\r\n\r\n\t\t\tcontainerTabs.removeClass(\"active\");\r\n\t\t\tcontainerTabs.filter(`[data-tab-id=${tabId}]`).addClass(\"active\");\r\n\r\n\t\t\tsetInMemory(sheet, \"inventory.activeTab\", tabId);\r\n\t\t});\r\n\t}\r\n\r\n\tconst sidebar = inner.find(\"#pf2e-toobelt-inventory-item-details\")[0];\r\n\tconst itemElements = tab.find(\"[data-item-id], [data-container-id]\");\r\n\tfor (const itemElement of itemElements) {\r\n\t\titemElement.addEventListener(\"mouseenter\", (event) =>\r\n\t\t\tonItemDetails(event, actor, itemElement, sidebar),\r\n\t\t);\r\n\t\titemElement.addEventListener(\"mouseleave\", (event) => {\r\n\t\t\tsidebar.classList.add(\"hidden\");\r\n\t\t});\r\n\t}\r\n\r\n\tif (!actor.isOwner) return;\r\n\r\n\tdragIdentifier = randomID();\r\n\r\n\tmakeDraggable({\r\n\t\telement: tab[0],\r\n\t\tselector: \"[data-item-id]\",\r\n\t\tfilter: \"input\",\r\n\t\tdraggedClass: \"dragged\",\r\n\t\tghostClass: \"ghost\",\r\n\t\tidentifier: dragIdentifier,\r\n\t\tcursorImage: {\r\n\t\t\tid: \"pf2e-toolbelt-inventory-cursor-image\",\r\n\t\t\timg: (target) => target.dataset.itemImg,\r\n\t\t},\r\n\t\tcreateGhost: createGhost,\r\n\t\tonDragStart: () => onDragStart(sidebar),\r\n\t\tonDragEnd: (event, draggable, options) => onDragEnd(sheet, options),\r\n\t\tdroppables: [\r\n\t\t\tcontainersDroppable(tab, sheet),\r\n\t\t\totherEquipmentDroppable(tab, sheet),\r\n\t\t\tlargeEquipmentDroppable(tab, sheet),\r\n\t\t\titemsListDroppable(tab, sheet),\r\n\t\t\titemsGridDroppable(tab, sheet),\r\n\t\t],\r\n\t});\r\n}\r\n\r\nasync function onItemDetails(event, actor, itemElement, sidebar) {\r\n\tif (dragging) return;\r\n\r\n\tlet details = itemElement.dataset.details;\r\n\r\n\tif (!details) {\r\n\t\tconst item = getItemFromElement(actor, itemElement);\r\n\t\tif (!item) return;\r\n\r\n\t\tdetails = await render(\"inventory/details\", { item });\r\n\t\titemElement.dataset.details = details;\r\n\t}\r\n\r\n\tsidebar.innerHTML = details;\r\n\tsidebar.classList.remove(\"hidden\");\r\n}\r\n\r\nfunction onDragStart(sidebar) {\r\n\tdragging = true;\r\n\tsidebar.classList.add(\"hidden\");\r\n}\r\n\r\n/**\r\n * @param {*} sheet\r\n * @param {Parameters<DraggableDragEndFunction>[2]} options\r\n */\r\nfunction onDragEnd(sheet, { dropped, canceled }) {\r\n\tdragging = false;\r\n\tif (canceled || !dropped) return;\r\n\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n}\r\n\r\n/** @type {DraggableGhostFunction} */\r\nfunction createGhost(dragged, draggedIndex) {\r\n\treturn dragged.parentElement.dataset.area === \"items-grid\"\r\n\t\t? { element: dragged, index: draggedIndex }\r\n\t\t: undefined;\r\n}\r\n\r\n/** @param {DraggableObj} */\r\nfunction checkIdentifier(draggable) {\r\n\tif (draggable.identifier === dragIdentifier) return true;\r\n\terror(\"inventory.identifier.error\");\r\n\treturn false;\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsGridDroppable(html, sheet) {\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tif (\r\n\t\t\tdroppable.element === draggable.element ||\r\n\t\t\tdroppable.element === draggable.ghost\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst ghost = draggable.ghost;\r\n\t\tconst index = getElementIndex(droppable.element);\r\n\t\tconst target =\r\n\t\t\tghost.index >= index\r\n\t\t\t\t? droppable.element\r\n\t\t\t\t: droppable.element.nextElementSibling;\r\n\r\n\t\tdroppable.element.parentElement.insertBefore(ghost.element, target);\r\n\t\tghost.index = index;\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tconst parentGrid = droppable.element.parentElement;\r\n\t\tif (!parentGrid) return;\r\n\r\n\t\tconst isItem = closestInside(droppable.triggeringElement, parentGrid, {\r\n\t\t\tselector: \"[data-item-id]\",\r\n\t\t});\r\n\t\tif (isItem) return;\r\n\r\n\t\tconst parentList = parentGrid.parentElement;\r\n\t\tif (!parentList.contains(droppable.triggeringElement)) return;\r\n\r\n\t\tparentGrid.appendChild(draggable.ghost.element);\r\n\t\tdraggable.ghost.index = Infinity;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-grid'] [data-item-id]\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsListDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst isItem = closestInside(\r\n\t\t\tdroppable.triggeringElement,\r\n\t\t\tdroppable.element,\r\n\t\t\t{\r\n\t\t\t\tselector: \"[data-item-id]\",\r\n\t\t\t},\r\n\t\t);\r\n\t\tif (isItem) return;\r\n\r\n\t\tdroppable.element\r\n\t\t\t.querySelector(\"[data-area='items-grid']\")\r\n\t\t\t.appendChild(draggable.ghost.element);\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tdraggable.ghost.reset();\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return false;\r\n\r\n\t\tconst updates = [];\r\n\r\n\t\tif (draggable.element === draggable.ghost.element) {\r\n\t\t\tdraggable.ghost.classList.purge();\r\n\t\t\tcleanContainerItem(draggable.element);\r\n\t\t} else {\r\n\t\t\tmoveItemToContainer({\r\n\t\t\t\thtml,\r\n\t\t\t\tupdates,\r\n\t\t\t\titem,\r\n\t\t\t\t...draggable,\r\n\t\t\t\ttarget: draggable.ghost.element,\r\n\t\t\t});\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t\tdraggable.ghost.reset();\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-list']\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction largeEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\tconst rightHand = html.find(\"[data-equipped-slot=right-hand]\")[0];\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst slot = droppable.element.dataset.equippedSlot;\r\n\r\n\t\tif (\r\n\t\t\tslot === draggable.parent.dataset.equippedSlot ||\r\n\t\t\tdroppable.element.querySelector(\"[data-two-hands]\")\r\n\t\t) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canDrop = slot === \"armor\" ? item.isOfType(\"armor\") : true;\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tslot,\r\n\t\t\tcanDrop,\r\n\t\t};\r\n\t}\r\n\r\n\tfunction moveItemToSlot({\r\n\t\tupdates,\r\n\t\titem,\r\n\t\telement,\r\n\t\tdrop,\r\n\t\tnoTwoHand = false,\r\n\t\tnoUpdate = false,\r\n\t}) {\r\n\t\tconst dropSlot = drop instanceof HTMLElement ? drop : drop.element;\r\n\t\tconst slot = dropSlot.dataset.equippedSlot;\r\n\t\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\t\tconst isOneHand = isOneHanded(item);\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\t\tconst canInvest = canBeInvested(item);\r\n\r\n\t\tdropSlot.appendChild(movable);\r\n\r\n\t\tconst move = (carryType, handsHeld, inSlot, invested) => {\r\n\t\t\tif (!noUpdate) {\r\n\t\t\t\tupdates.push(\r\n\t\t\t\t\titemCarryUpdate(item, {\r\n\t\t\t\t\t\tcarryType,\r\n\t\t\t\t\t\thandsHeld,\r\n\t\t\t\t\t\tinSlot,\r\n\t\t\t\t\t\tinvested,\r\n\t\t\t\t\t\tcontainerId: null,\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tmovable.classList.toggle(\"invested\", canInvest && invested);\r\n\t\t};\r\n\r\n\t\tif (slot === \"armor\") {\r\n\t\t\tmove(\"worn\", 0, true, true);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (slot === \"right-hand\") {\r\n\t\t\tmove(\"held\", 1, false, isOneHand);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tmove(\r\n\t\t\t\"held\",\r\n\t\t\tisTwoHand && !noTwoHand ? 2 : 1,\r\n\t\t\tfalse,\r\n\t\t\tisHeld(item) && (!isTwoHand || !noTwoHand),\r\n\t\t);\r\n\t}\r\n\r\n\t/** @param {HTMLElement | {element: HTMLElement}} */\r\n\tfunction getSlottedItem(slot) {\r\n\t\tconst slotElement = slot instanceof HTMLElement ? slot : slot.element;\r\n\t\tconst element = slotElement.querySelector(\"[data-item-id]\");\r\n\t\tconst item = getItemFromElement(actor, element);\r\n\t\treturn { element, item };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\r\n\t\tif (canDrop !== undefined) {\r\n\t\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t\t}\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { item, canDrop, slot } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = [];\r\n\t\tconst slotted = getSlottedItem(droppable);\r\n\t\tconst dragArea = draggable.parent.dataset.area;\r\n\t\tconst dragSlot = draggable.parent.dataset.equippedSlot;\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\r\n\t\tlet noUpdate = false;\r\n\r\n\t\tif (dragArea === \"equipped\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({ html, updates, ...slotted });\r\n\t\t\t}\r\n\t\t} else if (dragArea === \"items-grid\") {\r\n\t\t\tif (slot === \"left-hand\" && isTwoHand) {\r\n\t\t\t\tconst otherSlotted = getSlottedItem(rightHand);\r\n\t\t\t\tif (otherSlotted.item) {\r\n\t\t\t\t\tmoveItemToContainer({ html, updates, ...otherSlotted });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\ttarget: draggable.element,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (dragSlot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tif (slotted.item.isOfType(\"armor\")) {\r\n\t\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\t\thtml,\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (slot === \"right-hand\") {\r\n\t\t\tnoUpdate = true;\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t\tnoTwoHand: true,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slotted.item) {\r\n\t\t\tif (isTwoHand) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t});\r\n\t\t\t\tnoUpdate = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tmoveItemToSlot({\r\n\t\t\tupdates,\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\tdrop: droppable,\r\n\t\t\tnoUpdate,\r\n\t\t});\r\n\r\n\t\tif (slot === \"left-hand\" || dragSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped] .main-items\")[0],\r\n\t\tselector: \"[data-equipped-slot]\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @return {DroppableObj} */\r\nfunction otherEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tif (draggable.parent === droppable.element) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (\r\n\t\t\t!item.isIdentified ||\r\n\t\t\t!(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item))\r\n\t\t) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canInvest = canBeInvested(item);\r\n\t\tconst canEquip = hasWornSlot(item);\r\n\t\tif (!canInvest && !canEquip) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\treturn { canDrop: true, item, canInvest };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop, canInvest } = getData(draggable, droppable);\r\n\t\tif (canDrop === undefined) return;\r\n\r\n\t\tdroppable.classList.add(\"show\");\r\n\t\tdroppable.classList.toggle(\"add-forbidden\", !canDrop);\r\n\t\tdroppable.classList.toggle(\"add-invest\", canDrop && canInvest);\r\n\t\tdroppable.classList.toggle(\"add-equip\", canDrop && !canInvest);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, canInvest, item } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tdroppable.element.appendChild(draggable.element);\r\n\t\tdraggable.element.classList.toggle(\"invested\", canInvest);\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", [\r\n\t\t\titemCarryUpdate(item, {\r\n\t\t\t\tcontainerId: null,\r\n\t\t\t\tinSlot: true,\r\n\t\t\t\tinvested: true,\r\n\t\t\t}),\r\n\t\t]);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped]\")[0],\r\n\t\tfilter: \".main-items\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction containersDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return { canDrop: false };\r\n\r\n\t\tconst containerId = droppable.element.dataset.containerId;\r\n\r\n\t\tif (containerId === \"undefined\") return { item, canDrop: true };\r\n\r\n\t\tconst container = actor.items.get(containerId);\r\n\t\tif (!container) return { canDrop: false };\r\n\r\n\t\tconst capacity = container.capacity;\r\n\t\tconst remaining = capacity.max.minus(capacity.value);\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tcontainer,\r\n\t\t\tcanDrop: remaining.value >= item.bulk.value,\r\n\t\t};\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, item, container } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = moveItemToContainer({\r\n\t\t\thtml,\r\n\t\t\tupdates: [],\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\ttarget: container,\r\n\t\t});\r\n\r\n\t\tif (draggable.parent.dataset.equippedSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-container-id]\",\r\n\t\tfilter: \".back\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\nfunction cleanContainerItem(item) {\r\n\titem.classList.remove(\"invested\");\r\n\titem.querySelector(\".vignette.hands\")?.remove();\r\n}\r\n\r\nfunction moveItemToContainer({ html, updates, item, element, target }) {\r\n\tconst targetIsElement = target instanceof HTMLElement;\r\n\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\r\n\tlet containerId = targetIsElement\r\n\t\t? target.closest(\"[data-tab-id]\").dataset.tabId\r\n\t\t: target instanceof Item\r\n\t\t  ? target.id\r\n\t\t  : target;\r\n\r\n\tcleanContainerItem(movable);\r\n\r\n\tif (targetIsElement) {\r\n\t\ttarget.before(movable);\r\n\t} else {\r\n\t\thtml\r\n\t\t\t.find(`.container-tab[data-tab-id=${containerId}] [data-area=items-grid]`)\r\n\t\t\t.append(movable);\r\n\t}\r\n\r\n\tcontainerId = [undefined, \"undefined\"].includes(containerId)\r\n\t\t? null\r\n\t\t: containerId;\r\n\r\n\tupdates.push(\r\n\t\titemCarryUpdate(item, {\r\n\t\t\tcontainerId: containerId,\r\n\t\t\tinSlot: false,\r\n\t\t\tinvested: false,\r\n\t\t\tcarryType: containerId ? \"stowed\" : \"worn\",\r\n\t\t\thandsHeld: 0,\r\n\t\t}),\r\n\t);\r\n\r\n\treturn updates;\r\n}\r\n\r\nfunction checkForTwoHandedSlots(html, actor) {\r\n\t/** @type {HTMLElement} */\r\n\tconst equipped = html.find(\"[data-area='equipped'] .main-items\")[0];\r\n\tconst leftHand = equipped.querySelector(\"[data-equipped-slot='left-hand']\");\r\n\tconst rightHand = equipped.querySelector(\"[data-equipped-slot='right-hand']\");\r\n\tconst leftSlotted = leftHand.querySelector(\"[data-item-id]\");\r\n\tconst rightSlotted = rightHand.querySelector(\".item:not(.fake)\");\r\n\tconst item = getItemFromElement(actor, leftSlotted);\r\n\tconst isTwoHand = !!item && isTwoHanded(item);\r\n\r\n\tif (!isTwoHand && rightSlotted?.dataset.twoHands) {\r\n\t\trightSlotted.remove();\r\n\t} else if (isTwoHand && !rightSlotted) {\r\n\t\t/** @type {HTMLElement} */\r\n\t\tconst clone = leftSlotted.cloneNode(true);\r\n\t\tclone.dataset.twoHands = \"true\";\r\n\t\trightHand.appendChild(clone);\r\n\t}\r\n}\r\n\r\n/** @param {HTMLElement | {element: HTMLElement}} */\r\nfunction getItemFromElement(actor, element) {\r\n\tif (!element) return;\r\n\r\n\tconst el = element instanceof HTMLElement ? element : element.element;\r\n\tconst { itemId, containerId } = el.dataset;\r\n\tconst id = itemId ?? containerId;\r\n\r\n\tif (id) return actor.items.get(id);\r\n}\r\n", "import { getFlag, setFlag, subLocalize, templatePath } from \"module-api\";\r\n\r\nconst localize = subLocalize(\"knowledges.editLore\");\r\n\r\nexport class EditLores extends FormApplication {\r\n\tget actor() {\r\n\t\treturn this.object;\r\n\t}\r\n\r\n\tget id() {\r\n\t\treturn `npc-edit-lores-${this.actor.id}`;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.actor);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"knowledges/lores\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\tconst actor = this.actor;\r\n\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\tunspecified: getFlag(actor, \"knowledges.unspecified\") ?? \"\",\r\n\t\t\tspecific: getFlag(actor, \"knowledges.specific\") ?? \"\",\r\n\t\t\ti18n: localize.template,\r\n\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(event, { unspecified, specific }) {\r\n\t\tconst actor = this.object;\r\n\t\tsetFlag(actor, \"knowledges.unspecified\", unspecified.trim());\r\n\t\tsetFlag(actor, \"knowledges.specific\", specific.trim());\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"button.cancel\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "import { getFlag, refreshActorSheets } from \"module-api\";\r\nimport { isPlayedActor } from \"../actor-sheet\";\r\nimport { EditLores } from \"../apps/knowledges/lores\";\r\nimport { calledIfSetting } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nexport const knowledgesOptions = {\r\n\tname: \"knowledges\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"knowledges\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t],\r\n\thooks: [[\"renderNPCSheetPF2e\", renderNPCSheetPF2e]],\r\n\tconflicts: [\"pf2e-npc-knowledges\"],\r\n\tready: calledIfSetting(setup, \"knowledges\"),\r\n};\r\n\r\nconst { setHook } = createTool(knowledgesOptions);\r\n\r\nfunction setup(value) {\r\n\tsetHook(value);\r\n\trefreshActorSheets(\"npc\");\r\n}\r\n\r\nfunction renderNPCSheetPF2e(sheet, $html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\treplaceLores(actor, $html);\r\n\taddEditButton($html);\r\n\taddEvents(actor, $html);\r\n}\r\n\r\nfunction knowledgeSelector(html, section, selector) {\r\n\treturn html.find(\r\n\t\t`[data-tab=\"main\"] .recall-knowledge ${\r\n\t\t\tsection === \"header\" ? \".section-header\" : \".section-body\"\r\n\t\t} ${selector}`,\r\n\t);\r\n}\r\n\r\nfunction editLores(actor) {\r\n\tnew EditLores(actor).render(true);\r\n}\r\n\r\nfunction replaceLores(actor, html) {\r\n\tconst unspecifics = getFlag(actor, \"knowledges.unspecified\");\r\n\tconst specifics = getFlag(actor, \"knowledges.specific\");\r\n\tif (!unspecifics && !specifics) return;\r\n\r\n\tconst lores = actor.identificationDCs.lore;\r\n\tconst body = knowledgeSelector(html, \"body\", \"\");\r\n\tbody.find(\".identification-skills\").last().remove();\r\n\r\n\tfunction tag(skills, dc, adjustment) {\r\n\t\tconst content = game.i18n.format(\r\n\t\t\t\"PF2E.Actor.NPC.Identification.Skills.Label\",\r\n\t\t\t{ skills, dc, adjustment },\r\n\t\t);\r\n\t\treturn `<div class=\"tag-legacy identification-skills tooltipstered\">${content}</div>`;\r\n\t}\r\n\r\n\tfunction addTags(lores, { dc, start }) {\r\n\t\tconst tags = lores\r\n\t\t\t.split(\",\")\r\n\t\t\t.filter((lore) => lore.trim())\r\n\t\t\t.map((lore) => tag(lore, dc, start))\r\n\t\t\t.join(\"\");\r\n\t\tbody.append(tags);\r\n\t}\r\n\r\n\taddTags(unspecifics || \"Unspecific\", lores[0]);\r\n\taddTags(specifics || \"Specific\", lores[1]);\r\n}\r\n\r\nfunction addEvents(actor, html) {\r\n\tconst edit = knowledgeSelector(html, \"header\", \"button.edit\");\r\n\tedit.on(\"click\", () => editLores(actor));\r\n}\r\n\r\nfunction addEditButton(html) {\r\n\tconst attempts = knowledgeSelector(html, \"header\", \"button\");\r\n\tconst edit = '<button type=\"button\" class=\"breakdown edit\">Edit</button>';\r\n\tattempts.before(edit);\r\n}\r\n", "\"use strict\";\nexport var PipsMode;\n(function (PipsMode) {\n    PipsMode[\"Range\"] = \"range\";\n    PipsMode[\"Steps\"] = \"steps\";\n    PipsMode[\"Positions\"] = \"positions\";\n    PipsMode[\"Count\"] = \"count\";\n    PipsMode[\"Values\"] = \"values\";\n})(PipsMode || (PipsMode = {}));\nexport var PipsType;\n(function (PipsType) {\n    PipsType[PipsType[\"None\"] = -1] = \"None\";\n    PipsType[PipsType[\"NoValue\"] = 0] = \"NoValue\";\n    PipsType[PipsType[\"LargeValue\"] = 1] = \"LargeValue\";\n    PipsType[PipsType[\"SmallValue\"] = 2] = \"SmallValue\";\n})(PipsType || (PipsType = {}));\n//region Helper Methods\nfunction isValidFormatter(entry) {\n    return isValidPartialFormatter(entry) && typeof entry.from === \"function\";\n}\nfunction isValidPartialFormatter(entry) {\n    // partial formatters only need a to function and not a from function\n    return typeof entry === \"object\" && typeof entry.to === \"function\";\n}\nfunction removeElement(el) {\n    el.parentElement.removeChild(el);\n}\nfunction isSet(value) {\n    return value !== null && value !== undefined;\n}\n// Bindable version\nfunction preventDefault(e) {\n    e.preventDefault();\n}\n// Removes duplicates from an array.\nfunction unique(array) {\n    return array.filter(function (a) {\n        return !this[a] ? (this[a] = true) : false;\n    }, {});\n}\n// Round a value to the closest 'to'.\nfunction closest(value, to) {\n    return Math.round(value / to) * to;\n}\n// Current position of an element relative to the document.\nfunction offset(elem, orientation) {\n    var rect = elem.getBoundingClientRect();\n    var doc = elem.ownerDocument;\n    var docElem = doc.documentElement;\n    var pageOffset = getPageOffset(doc);\n    // getBoundingClientRect contains left scroll in Chrome on Android.\n    // I haven't found a feature detection that proves this. Worst case\n    // scenario on mis-match: the 'tap' feature on horizontal sliders breaks.\n    if (/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)) {\n        pageOffset.x = 0;\n    }\n    return orientation ? rect.top + pageOffset.y - docElem.clientTop : rect.left + pageOffset.x - docElem.clientLeft;\n}\n// Checks whether a value is numerical.\nfunction isNumeric(a) {\n    return typeof a === \"number\" && !isNaN(a) && isFinite(a);\n}\n// Sets a class and removes it after [duration] ms.\nfunction addClassFor(element, className, duration) {\n    if (duration > 0) {\n        addClass(element, className);\n        setTimeout(function () {\n            removeClass(element, className);\n        }, duration);\n    }\n}\n// Limits a value to 0 - 100\nfunction limit(a) {\n    return Math.max(Math.min(a, 100), 0);\n}\n// Wraps a variable as an array, if it isn't one yet.\n// Note that an input array is returned by reference!\nfunction asArray(a) {\n    return Array.isArray(a) ? a : [a];\n}\n// Counts decimals\nfunction countDecimals(numStr) {\n    numStr = String(numStr);\n    var pieces = numStr.split(\".\");\n    return pieces.length > 1 ? pieces[1].length : 0;\n}\n// http://youmightnotneedjquery.com/#add_class\nfunction addClass(el, className) {\n    if (el.classList && !/\\s/.test(className)) {\n        el.classList.add(className);\n    }\n    else {\n        el.className += \" \" + className;\n    }\n}\n// http://youmightnotneedjquery.com/#remove_class\nfunction removeClass(el, className) {\n    if (el.classList && !/\\s/.test(className)) {\n        el.classList.remove(className);\n    }\n    else {\n        el.className = el.className.replace(new RegExp(\"(^|\\\\b)\" + className.split(\" \").join(\"|\") + \"(\\\\b|$)\", \"gi\"), \" \");\n    }\n}\n// https://plainjs.com/javascript/attributes/adding-removing-and-testing-for-classes-9/\nfunction hasClass(el, className) {\n    return el.classList ? el.classList.contains(className) : new RegExp(\"\\\\b\" + className + \"\\\\b\").test(el.className);\n}\n// https://developer.mozilla.org/en-US/docs/Web/API/Window/scrollY#Notes\nfunction getPageOffset(doc) {\n    var supportPageOffset = window.pageXOffset !== undefined;\n    var isCSS1Compat = (doc.compatMode || \"\") === \"CSS1Compat\";\n    var x = supportPageOffset\n        ? window.pageXOffset\n        : isCSS1Compat\n            ? doc.documentElement.scrollLeft\n            : doc.body.scrollLeft;\n    var y = supportPageOffset\n        ? window.pageYOffset\n        : isCSS1Compat\n            ? doc.documentElement.scrollTop\n            : doc.body.scrollTop;\n    return {\n        x: x,\n        y: y,\n    };\n}\n// we provide a function to compute constants instead\n// of accessing window.* as soon as the module needs it\n// so that we do not compute anything if not needed\nfunction getActions() {\n    // Determine the events to bind. IE11 implements pointerEvents without\n    // a prefix, which breaks compatibility with the IE10 implementation.\n    return window.navigator.pointerEnabled\n        ? {\n            start: \"pointerdown\",\n            move: \"pointermove\",\n            end: \"pointerup\",\n        }\n        : window.navigator.msPointerEnabled\n            ? {\n                start: \"MSPointerDown\",\n                move: \"MSPointerMove\",\n                end: \"MSPointerUp\",\n            }\n            : {\n                start: \"mousedown touchstart\",\n                move: \"mousemove touchmove\",\n                end: \"mouseup touchend\",\n            };\n}\n// https://github.com/WICG/EventListenerOptions/blob/gh-pages/explainer.md\n// Issue #785\nfunction getSupportsPassive() {\n    var supportsPassive = false;\n    /* eslint-disable */\n    try {\n        var opts = Object.defineProperty({}, \"passive\", {\n            get: function () {\n                supportsPassive = true;\n            },\n        });\n        // @ts-ignore\n        window.addEventListener(\"test\", null, opts);\n    }\n    catch (e) { }\n    /* eslint-enable */\n    return supportsPassive;\n}\nfunction getSupportsTouchActionNone() {\n    return window.CSS && CSS.supports && CSS.supports(\"touch-action\", \"none\");\n}\n//endregion\n//region Range Calculation\n// Determine the size of a sub-range in relation to a full range.\nfunction subRangeRatio(pa, pb) {\n    return 100 / (pb - pa);\n}\n// (percentage) How many percent is this value of this range?\nfunction fromPercentage(range, value, startRange) {\n    return (value * 100) / (range[startRange + 1] - range[startRange]);\n}\n// (percentage) Where is this value on this range?\nfunction toPercentage(range, value) {\n    return fromPercentage(range, range[0] < 0 ? value + Math.abs(range[0]) : value - range[0], 0);\n}\n// (value) How much is this percentage on this range?\nfunction isPercentage(range, value) {\n    return (value * (range[1] - range[0])) / 100 + range[0];\n}\nfunction getJ(value, arr) {\n    var j = 1;\n    while (value >= arr[j]) {\n        j += 1;\n    }\n    return j;\n}\n// (percentage) Input a value, find where, on a scale of 0-100, it applies.\nfunction toStepping(xVal, xPct, value) {\n    if (value >= xVal.slice(-1)[0]) {\n        return 100;\n    }\n    var j = getJ(value, xVal);\n    var va = xVal[j - 1];\n    var vb = xVal[j];\n    var pa = xPct[j - 1];\n    var pb = xPct[j];\n    return pa + toPercentage([va, vb], value) / subRangeRatio(pa, pb);\n}\n// (value) Input a percentage, find where it is on the specified range.\nfunction fromStepping(xVal, xPct, value) {\n    // There is no range group that fits 100\n    if (value >= 100) {\n        return xVal.slice(-1)[0];\n    }\n    var j = getJ(value, xPct);\n    var va = xVal[j - 1];\n    var vb = xVal[j];\n    var pa = xPct[j - 1];\n    var pb = xPct[j];\n    return isPercentage([va, vb], (value - pa) * subRangeRatio(pa, pb));\n}\n// (percentage) Get the step that applies at a certain value.\nfunction getStep(xPct, xSteps, snap, value) {\n    if (value === 100) {\n        return value;\n    }\n    var j = getJ(value, xPct);\n    var a = xPct[j - 1];\n    var b = xPct[j];\n    // If 'snap' is set, steps are used as fixed points on the slider.\n    if (snap) {\n        // Find the closest position, a or b.\n        if (value - a > (b - a) / 2) {\n            return b;\n        }\n        return a;\n    }\n    if (!xSteps[j - 1]) {\n        return value;\n    }\n    return xPct[j - 1] + closest(value - xPct[j - 1], xSteps[j - 1]);\n}\n//endregion\n//region Spectrum\nvar Spectrum = /** @class */ (function () {\n    function Spectrum(entry, snap, singleStep) {\n        this.xPct = [];\n        this.xVal = [];\n        this.xSteps = [];\n        this.xNumSteps = [];\n        this.xHighestCompleteStep = [];\n        this.xSteps = [singleStep || false];\n        this.xNumSteps = [false];\n        this.snap = snap;\n        var index;\n        var ordered = [];\n        // Map the object keys to an array.\n        Object.keys(entry).forEach(function (index) {\n            ordered.push([asArray(entry[index]), index]);\n        });\n        // Sort all entries by value (numeric sort).\n        ordered.sort(function (a, b) {\n            return a[0][0] - b[0][0];\n        });\n        // Convert all entries to subranges.\n        for (index = 0; index < ordered.length; index++) {\n            this.handleEntryPoint(ordered[index][1], ordered[index][0]);\n        }\n        // Store the actual step values.\n        // xSteps is sorted in the same order as xPct and xVal.\n        this.xNumSteps = this.xSteps.slice(0);\n        // Convert all numeric steps to the percentage of the subrange they represent.\n        for (index = 0; index < this.xNumSteps.length; index++) {\n            this.handleStepPoint(index, this.xNumSteps[index]);\n        }\n    }\n    Spectrum.prototype.getDistance = function (value) {\n        var distances = [];\n        for (var index = 0; index < this.xNumSteps.length - 1; index++) {\n            distances[index] = fromPercentage(this.xVal, value, index);\n        }\n        return distances;\n    };\n    // Calculate the percentual distance over the whole scale of ranges.\n    // direction: 0 = backwards / 1 = forwards\n    Spectrum.prototype.getAbsoluteDistance = function (value, distances, direction) {\n        var xPct_index = 0;\n        // Calculate range where to start calculation\n        if (value < this.xPct[this.xPct.length - 1]) {\n            while (value > this.xPct[xPct_index + 1]) {\n                xPct_index++;\n            }\n        }\n        else if (value === this.xPct[this.xPct.length - 1]) {\n            xPct_index = this.xPct.length - 2;\n        }\n        // If looking backwards and the value is exactly at a range separator then look one range further\n        if (!direction && value === this.xPct[xPct_index + 1]) {\n            xPct_index++;\n        }\n        if (distances === null) {\n            distances = [];\n        }\n        var start_factor;\n        var rest_factor = 1;\n        var rest_rel_distance = distances[xPct_index];\n        var range_pct = 0;\n        var rel_range_distance = 0;\n        var abs_distance_counter = 0;\n        var range_counter = 0;\n        // Calculate what part of the start range the value is\n        if (direction) {\n            start_factor = (value - this.xPct[xPct_index]) / (this.xPct[xPct_index + 1] - this.xPct[xPct_index]);\n        }\n        else {\n            start_factor = (this.xPct[xPct_index + 1] - value) / (this.xPct[xPct_index + 1] - this.xPct[xPct_index]);\n        }\n        // Do until the complete distance across ranges is calculated\n        while (rest_rel_distance > 0) {\n            // Calculate the percentage of total range\n            range_pct = this.xPct[xPct_index + 1 + range_counter] - this.xPct[xPct_index + range_counter];\n            // Detect if the margin, padding or limit is larger then the current range and calculate\n            if (distances[xPct_index + range_counter] * rest_factor + 100 - start_factor * 100 > 100) {\n                // If larger then take the percentual distance of the whole range\n                rel_range_distance = range_pct * start_factor;\n                // Rest factor of relative percentual distance still to be calculated\n                rest_factor = (rest_rel_distance - 100 * start_factor) / distances[xPct_index + range_counter];\n                // Set start factor to 1 as for next range it does not apply.\n                start_factor = 1;\n            }\n            else {\n                // If smaller or equal then take the percentual distance of the calculate percentual part of that range\n                rel_range_distance = ((distances[xPct_index + range_counter] * range_pct) / 100) * rest_factor;\n                // No rest left as the rest fits in current range\n                rest_factor = 0;\n            }\n            if (direction) {\n                abs_distance_counter = abs_distance_counter - rel_range_distance;\n                // Limit range to first range when distance becomes outside of minimum range\n                if (this.xPct.length + range_counter >= 1) {\n                    range_counter--;\n                }\n            }\n            else {\n                abs_distance_counter = abs_distance_counter + rel_range_distance;\n                // Limit range to last range when distance becomes outside of maximum range\n                if (this.xPct.length - range_counter >= 1) {\n                    range_counter++;\n                }\n            }\n            // Rest of relative percentual distance still to be calculated\n            rest_rel_distance = distances[xPct_index + range_counter] * rest_factor;\n        }\n        return value + abs_distance_counter;\n    };\n    Spectrum.prototype.toStepping = function (value) {\n        value = toStepping(this.xVal, this.xPct, value);\n        return value;\n    };\n    Spectrum.prototype.fromStepping = function (value) {\n        return fromStepping(this.xVal, this.xPct, value);\n    };\n    Spectrum.prototype.getStep = function (value) {\n        value = getStep(this.xPct, this.xSteps, this.snap, value);\n        return value;\n    };\n    Spectrum.prototype.getDefaultStep = function (value, isDown, size) {\n        var j = getJ(value, this.xPct);\n        // When at the top or stepping down, look at the previous sub-range\n        if (value === 100 || (isDown && value === this.xPct[j - 1])) {\n            j = Math.max(j - 1, 1);\n        }\n        return (this.xVal[j] - this.xVal[j - 1]) / size;\n    };\n    Spectrum.prototype.getNearbySteps = function (value) {\n        var j = getJ(value, this.xPct);\n        return {\n            stepBefore: {\n                startValue: this.xVal[j - 2],\n                step: this.xNumSteps[j - 2],\n                highestStep: this.xHighestCompleteStep[j - 2],\n            },\n            thisStep: {\n                startValue: this.xVal[j - 1],\n                step: this.xNumSteps[j - 1],\n                highestStep: this.xHighestCompleteStep[j - 1],\n            },\n            stepAfter: {\n                startValue: this.xVal[j],\n                step: this.xNumSteps[j],\n                highestStep: this.xHighestCompleteStep[j],\n            },\n        };\n    };\n    Spectrum.prototype.countStepDecimals = function () {\n        var stepDecimals = this.xNumSteps.map(countDecimals);\n        return Math.max.apply(null, stepDecimals);\n    };\n    Spectrum.prototype.hasNoSize = function () {\n        return this.xVal[0] === this.xVal[this.xVal.length - 1];\n    };\n    // Outside testing\n    Spectrum.prototype.convert = function (value) {\n        return this.getStep(this.toStepping(value));\n    };\n    Spectrum.prototype.handleEntryPoint = function (index, value) {\n        var percentage;\n        // Covert min/max syntax to 0 and 100.\n        if (index === \"min\") {\n            percentage = 0;\n        }\n        else if (index === \"max\") {\n            percentage = 100;\n        }\n        else {\n            percentage = parseFloat(index);\n        }\n        // Check for correct input.\n        if (!isNumeric(percentage) || !isNumeric(value[0])) {\n            throw new Error(\"noUiSlider: 'range' value isn't numeric.\");\n        }\n        // Store values.\n        this.xPct.push(percentage);\n        this.xVal.push(value[0]);\n        var value1 = Number(value[1]);\n        // NaN will evaluate to false too, but to keep\n        // logging clear, set step explicitly. Make sure\n        // not to override the 'step' setting with false.\n        if (!percentage) {\n            if (!isNaN(value1)) {\n                this.xSteps[0] = value1;\n            }\n        }\n        else {\n            this.xSteps.push(isNaN(value1) ? false : value1);\n        }\n        this.xHighestCompleteStep.push(0);\n    };\n    Spectrum.prototype.handleStepPoint = function (i, n) {\n        // Ignore 'false' stepping.\n        if (!n) {\n            return;\n        }\n        // Step over zero-length ranges (#948);\n        if (this.xVal[i] === this.xVal[i + 1]) {\n            this.xSteps[i] = this.xHighestCompleteStep[i] = this.xVal[i];\n            return;\n        }\n        // Factor to range ratio\n        this.xSteps[i] =\n            fromPercentage([this.xVal[i], this.xVal[i + 1]], n, 0) / subRangeRatio(this.xPct[i], this.xPct[i + 1]);\n        var totalSteps = (this.xVal[i + 1] - this.xVal[i]) / this.xNumSteps[i];\n        var highestStep = Math.ceil(Number(totalSteps.toFixed(3)) - 1);\n        var step = this.xVal[i] + this.xNumSteps[i] * highestStep;\n        this.xHighestCompleteStep[i] = step;\n    };\n    return Spectrum;\n}());\n//endregion\n//region Options\n/*\tEvery input option is tested and parsed. This will prevent\n    endless validation in internal methods. These tests are\n    structured with an item for every option available. An\n    option can be marked as required by setting the 'r' flag.\n    The testing function is provided with three arguments:\n        - The provided value for the option;\n        - A reference to the options object;\n        - The name for the option;\n\n    The testing function returns false when an error is detected,\n    or true when everything is OK. It can also modify the option\n    object, to make sure all values can be correctly looped elsewhere. */\n//region Defaults\nvar defaultFormatter = {\n    to: function (value) {\n        return value === undefined ? \"\" : value.toFixed(2);\n    },\n    from: Number,\n};\nvar cssClasses = {\n    target: \"target\",\n    base: \"base\",\n    origin: \"origin\",\n    handle: \"handle\",\n    handleLower: \"handle-lower\",\n    handleUpper: \"handle-upper\",\n    touchArea: \"touch-area\",\n    horizontal: \"horizontal\",\n    vertical: \"vertical\",\n    background: \"background\",\n    connect: \"connect\",\n    connects: \"connects\",\n    ltr: \"ltr\",\n    rtl: \"rtl\",\n    textDirectionLtr: \"txt-dir-ltr\",\n    textDirectionRtl: \"txt-dir-rtl\",\n    draggable: \"draggable\",\n    drag: \"state-drag\",\n    tap: \"state-tap\",\n    active: \"active\",\n    tooltip: \"tooltip\",\n    pips: \"pips\",\n    pipsHorizontal: \"pips-horizontal\",\n    pipsVertical: \"pips-vertical\",\n    marker: \"marker\",\n    markerHorizontal: \"marker-horizontal\",\n    markerVertical: \"marker-vertical\",\n    markerNormal: \"marker-normal\",\n    markerLarge: \"marker-large\",\n    markerSub: \"marker-sub\",\n    value: \"value\",\n    valueHorizontal: \"value-horizontal\",\n    valueVertical: \"value-vertical\",\n    valueNormal: \"value-normal\",\n    valueLarge: \"value-large\",\n    valueSub: \"value-sub\",\n};\n// Namespaces of internal event listeners\nvar INTERNAL_EVENT_NS = {\n    tooltips: \".__tooltips\",\n    aria: \".__aria\",\n};\n//endregion\nfunction testStep(parsed, entry) {\n    if (!isNumeric(entry)) {\n        throw new Error(\"noUiSlider: 'step' is not numeric.\");\n    }\n    // The step option can still be used to set stepping\n    // for linear sliders. Overwritten if set in 'range'.\n    parsed.singleStep = entry;\n}\nfunction testKeyboardPageMultiplier(parsed, entry) {\n    if (!isNumeric(entry)) {\n        throw new Error(\"noUiSlider: 'keyboardPageMultiplier' is not numeric.\");\n    }\n    parsed.keyboardPageMultiplier = entry;\n}\nfunction testKeyboardMultiplier(parsed, entry) {\n    if (!isNumeric(entry)) {\n        throw new Error(\"noUiSlider: 'keyboardMultiplier' is not numeric.\");\n    }\n    parsed.keyboardMultiplier = entry;\n}\nfunction testKeyboardDefaultStep(parsed, entry) {\n    if (!isNumeric(entry)) {\n        throw new Error(\"noUiSlider: 'keyboardDefaultStep' is not numeric.\");\n    }\n    parsed.keyboardDefaultStep = entry;\n}\nfunction testRange(parsed, entry) {\n    // Filter incorrect input.\n    if (typeof entry !== \"object\" || Array.isArray(entry)) {\n        throw new Error(\"noUiSlider: 'range' is not an object.\");\n    }\n    // Catch missing start or end.\n    if (entry.min === undefined || entry.max === undefined) {\n        throw new Error(\"noUiSlider: Missing 'min' or 'max' in 'range'.\");\n    }\n    parsed.spectrum = new Spectrum(entry, parsed.snap || false, parsed.singleStep);\n}\nfunction testStart(parsed, entry) {\n    entry = asArray(entry);\n    // Validate input. Values aren't tested, as the public .val method\n    // will always provide a valid location.\n    if (!Array.isArray(entry) || !entry.length) {\n        throw new Error(\"noUiSlider: 'start' option is incorrect.\");\n    }\n    // Store the number of handles.\n    parsed.handles = entry.length;\n    // When the slider is initialized, the .val method will\n    // be called with the start options.\n    parsed.start = entry;\n}\nfunction testSnap(parsed, entry) {\n    if (typeof entry !== \"boolean\") {\n        throw new Error(\"noUiSlider: 'snap' option must be a boolean.\");\n    }\n    // Enforce 100% stepping within subranges.\n    parsed.snap = entry;\n}\nfunction testAnimate(parsed, entry) {\n    if (typeof entry !== \"boolean\") {\n        throw new Error(\"noUiSlider: 'animate' option must be a boolean.\");\n    }\n    // Enforce 100% stepping within subranges.\n    parsed.animate = entry;\n}\nfunction testAnimationDuration(parsed, entry) {\n    if (typeof entry !== \"number\") {\n        throw new Error(\"noUiSlider: 'animationDuration' option must be a number.\");\n    }\n    parsed.animationDuration = entry;\n}\nfunction testConnect(parsed, entry) {\n    var connect = [false];\n    var i;\n    // Map legacy options\n    if (entry === \"lower\") {\n        entry = [true, false];\n    }\n    else if (entry === \"upper\") {\n        entry = [false, true];\n    }\n    // Handle boolean options\n    if (entry === true || entry === false) {\n        for (i = 1; i < parsed.handles; i++) {\n            connect.push(entry);\n        }\n        connect.push(false);\n    }\n    // Reject invalid input\n    else if (!Array.isArray(entry) || !entry.length || entry.length !== parsed.handles + 1) {\n        throw new Error(\"noUiSlider: 'connect' option doesn't match handle count.\");\n    }\n    else {\n        connect = entry;\n    }\n    parsed.connect = connect;\n}\nfunction testOrientation(parsed, entry) {\n    // Set orientation to an a numerical value for easy\n    // array selection.\n    switch (entry) {\n        case \"horizontal\":\n            parsed.ort = 0;\n            break;\n        case \"vertical\":\n            parsed.ort = 1;\n            break;\n        default:\n            throw new Error(\"noUiSlider: 'orientation' option is invalid.\");\n    }\n}\nfunction testMargin(parsed, entry) {\n    if (!isNumeric(entry)) {\n        throw new Error(\"noUiSlider: 'margin' option must be numeric.\");\n    }\n    // Issue #582\n    if (entry === 0) {\n        return;\n    }\n    parsed.margin = parsed.spectrum.getDistance(entry);\n}\nfunction testLimit(parsed, entry) {\n    if (!isNumeric(entry)) {\n        throw new Error(\"noUiSlider: 'limit' option must be numeric.\");\n    }\n    parsed.limit = parsed.spectrum.getDistance(entry);\n    if (!parsed.limit || parsed.handles < 2) {\n        throw new Error(\"noUiSlider: 'limit' option is only supported on linear sliders with 2 or more handles.\");\n    }\n}\nfunction testPadding(parsed, entry) {\n    var index;\n    if (!isNumeric(entry) && !Array.isArray(entry)) {\n        throw new Error(\"noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.\");\n    }\n    if (Array.isArray(entry) && !(entry.length === 2 || isNumeric(entry[0]) || isNumeric(entry[1]))) {\n        throw new Error(\"noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.\");\n    }\n    if (entry === 0) {\n        return;\n    }\n    if (!Array.isArray(entry)) {\n        entry = [entry, entry];\n    }\n    // 'getDistance' returns false for invalid values.\n    parsed.padding = [parsed.spectrum.getDistance(entry[0]), parsed.spectrum.getDistance(entry[1])];\n    for (index = 0; index < parsed.spectrum.xNumSteps.length - 1; index++) {\n        // last \"range\" can't contain step size as it is purely an endpoint.\n        if (parsed.padding[0][index] < 0 || parsed.padding[1][index] < 0) {\n            throw new Error(\"noUiSlider: 'padding' option must be a positive number(s).\");\n        }\n    }\n    var totalPadding = entry[0] + entry[1];\n    var firstValue = parsed.spectrum.xVal[0];\n    var lastValue = parsed.spectrum.xVal[parsed.spectrum.xVal.length - 1];\n    if (totalPadding / (lastValue - firstValue) > 1) {\n        throw new Error(\"noUiSlider: 'padding' option must not exceed 100% of the range.\");\n    }\n}\nfunction testDirection(parsed, entry) {\n    // Set direction as a numerical value for easy parsing.\n    // Invert connection for RTL sliders, so that the proper\n    // handles get the connect/background classes.\n    switch (entry) {\n        case \"ltr\":\n            parsed.dir = 0;\n            break;\n        case \"rtl\":\n            parsed.dir = 1;\n            break;\n        default:\n            throw new Error(\"noUiSlider: 'direction' option was not recognized.\");\n    }\n}\nfunction testBehaviour(parsed, entry) {\n    // Make sure the input is a string.\n    if (typeof entry !== \"string\") {\n        throw new Error(\"noUiSlider: 'behaviour' must be a string containing options.\");\n    }\n    // Check if the string contains any keywords.\n    // None are required.\n    var tap = entry.indexOf(\"tap\") >= 0;\n    var drag = entry.indexOf(\"drag\") >= 0;\n    var fixed = entry.indexOf(\"fixed\") >= 0;\n    var snap = entry.indexOf(\"snap\") >= 0;\n    var hover = entry.indexOf(\"hover\") >= 0;\n    var unconstrained = entry.indexOf(\"unconstrained\") >= 0;\n    var dragAll = entry.indexOf(\"drag-all\") >= 0;\n    var smoothSteps = entry.indexOf(\"smooth-steps\") >= 0;\n    if (fixed) {\n        if (parsed.handles !== 2) {\n            throw new Error(\"noUiSlider: 'fixed' behaviour must be used with 2 handles\");\n        }\n        // Use margin to enforce fixed state\n        testMargin(parsed, parsed.start[1] - parsed.start[0]);\n    }\n    if (unconstrained && (parsed.margin || parsed.limit)) {\n        throw new Error(\"noUiSlider: 'unconstrained' behaviour cannot be used with margin or limit\");\n    }\n    parsed.events = {\n        tap: tap || snap,\n        drag: drag,\n        dragAll: dragAll,\n        smoothSteps: smoothSteps,\n        fixed: fixed,\n        snap: snap,\n        hover: hover,\n        unconstrained: unconstrained,\n    };\n}\nfunction testTooltips(parsed, entry) {\n    if (entry === false) {\n        return;\n    }\n    if (entry === true || isValidPartialFormatter(entry)) {\n        parsed.tooltips = [];\n        for (var i = 0; i < parsed.handles; i++) {\n            parsed.tooltips.push(entry);\n        }\n    }\n    else {\n        entry = asArray(entry);\n        if (entry.length !== parsed.handles) {\n            throw new Error(\"noUiSlider: must pass a formatter for all handles.\");\n        }\n        entry.forEach(function (formatter) {\n            if (typeof formatter !== \"boolean\" && !isValidPartialFormatter(formatter)) {\n                throw new Error(\"noUiSlider: 'tooltips' must be passed a formatter or 'false'.\");\n            }\n        });\n        parsed.tooltips = entry;\n    }\n}\nfunction testHandleAttributes(parsed, entry) {\n    if (entry.length !== parsed.handles) {\n        throw new Error(\"noUiSlider: must pass a attributes for all handles.\");\n    }\n    parsed.handleAttributes = entry;\n}\nfunction testAriaFormat(parsed, entry) {\n    if (!isValidPartialFormatter(entry)) {\n        throw new Error(\"noUiSlider: 'ariaFormat' requires 'to' method.\");\n    }\n    parsed.ariaFormat = entry;\n}\nfunction testFormat(parsed, entry) {\n    if (!isValidFormatter(entry)) {\n        throw new Error(\"noUiSlider: 'format' requires 'to' and 'from' methods.\");\n    }\n    parsed.format = entry;\n}\nfunction testKeyboardSupport(parsed, entry) {\n    if (typeof entry !== \"boolean\") {\n        throw new Error(\"noUiSlider: 'keyboardSupport' option must be a boolean.\");\n    }\n    parsed.keyboardSupport = entry;\n}\nfunction testDocumentElement(parsed, entry) {\n    // This is an advanced option. Passed values are used without validation.\n    parsed.documentElement = entry;\n}\nfunction testCssPrefix(parsed, entry) {\n    if (typeof entry !== \"string\" && entry !== false) {\n        throw new Error(\"noUiSlider: 'cssPrefix' must be a string or `false`.\");\n    }\n    parsed.cssPrefix = entry;\n}\nfunction testCssClasses(parsed, entry) {\n    if (typeof entry !== \"object\") {\n        throw new Error(\"noUiSlider: 'cssClasses' must be an object.\");\n    }\n    if (typeof parsed.cssPrefix === \"string\") {\n        parsed.cssClasses = {};\n        Object.keys(entry).forEach(function (key) {\n            parsed.cssClasses[key] = parsed.cssPrefix + entry[key];\n        });\n    }\n    else {\n        parsed.cssClasses = entry;\n    }\n}\n// Test all developer settings and parse to assumption-safe values.\nfunction testOptions(options) {\n    // To prove a fix for #537, freeze options here.\n    // If the object is modified, an error will be thrown.\n    // Object.freeze(options);\n    var parsed = {\n        margin: null,\n        limit: null,\n        padding: null,\n        animate: true,\n        animationDuration: 300,\n        ariaFormat: defaultFormatter,\n        format: defaultFormatter,\n    };\n    // Tests are executed in the order they are presented here.\n    var tests = {\n        step: { r: false, t: testStep },\n        keyboardPageMultiplier: { r: false, t: testKeyboardPageMultiplier },\n        keyboardMultiplier: { r: false, t: testKeyboardMultiplier },\n        keyboardDefaultStep: { r: false, t: testKeyboardDefaultStep },\n        start: { r: true, t: testStart },\n        connect: { r: true, t: testConnect },\n        direction: { r: true, t: testDirection },\n        snap: { r: false, t: testSnap },\n        animate: { r: false, t: testAnimate },\n        animationDuration: { r: false, t: testAnimationDuration },\n        range: { r: true, t: testRange },\n        orientation: { r: false, t: testOrientation },\n        margin: { r: false, t: testMargin },\n        limit: { r: false, t: testLimit },\n        padding: { r: false, t: testPadding },\n        behaviour: { r: true, t: testBehaviour },\n        ariaFormat: { r: false, t: testAriaFormat },\n        format: { r: false, t: testFormat },\n        tooltips: { r: false, t: testTooltips },\n        keyboardSupport: { r: true, t: testKeyboardSupport },\n        documentElement: { r: false, t: testDocumentElement },\n        cssPrefix: { r: true, t: testCssPrefix },\n        cssClasses: { r: true, t: testCssClasses },\n        handleAttributes: { r: false, t: testHandleAttributes },\n    };\n    var defaults = {\n        connect: false,\n        direction: \"ltr\",\n        behaviour: \"tap\",\n        orientation: \"horizontal\",\n        keyboardSupport: true,\n        cssPrefix: \"noUi-\",\n        cssClasses: cssClasses,\n        keyboardPageMultiplier: 5,\n        keyboardMultiplier: 1,\n        keyboardDefaultStep: 10,\n    };\n    // AriaFormat defaults to regular format, if any.\n    if (options.format && !options.ariaFormat) {\n        options.ariaFormat = options.format;\n    }\n    // Run all options through a testing mechanism to ensure correct\n    // input. It should be noted that options might get modified to\n    // be handled properly. E.g. wrapping integers in arrays.\n    Object.keys(tests).forEach(function (name) {\n        // If the option isn't set, but it is required, throw an error.\n        if (!isSet(options[name]) && defaults[name] === undefined) {\n            if (tests[name].r) {\n                throw new Error(\"noUiSlider: '\" + name + \"' is required.\");\n            }\n            return;\n        }\n        tests[name].t(parsed, !isSet(options[name]) ? defaults[name] : options[name]);\n    });\n    // Forward pips options\n    parsed.pips = options.pips;\n    // All recent browsers accept unprefixed transform.\n    // We need -ms- for IE9 and -webkit- for older Android;\n    // Assume use of -webkit- if unprefixed and -ms- are not supported.\n    // https://caniuse.com/#feat=transforms2d\n    var d = document.createElement(\"div\");\n    var msPrefix = d.style.msTransform !== undefined;\n    var noPrefix = d.style.transform !== undefined;\n    parsed.transformRule = noPrefix ? \"transform\" : msPrefix ? \"msTransform\" : \"webkitTransform\";\n    // Pips don't move, so we can place them using left/top.\n    var styles = [\n        [\"left\", \"top\"],\n        [\"right\", \"bottom\"],\n    ];\n    parsed.style = styles[parsed.dir][parsed.ort];\n    return parsed;\n}\n//endregion\nfunction scope(target, options, originalOptions) {\n    var actions = getActions();\n    var supportsTouchActionNone = getSupportsTouchActionNone();\n    var supportsPassive = supportsTouchActionNone && getSupportsPassive();\n    // All variables local to 'scope' are prefixed with 'scope_'\n    // Slider DOM Nodes\n    var scope_Target = target;\n    var scope_Base;\n    var scope_Handles;\n    var scope_Connects;\n    var scope_Pips;\n    var scope_Tooltips;\n    // Slider state values\n    var scope_Spectrum = options.spectrum;\n    var scope_Values = [];\n    var scope_Locations = [];\n    var scope_HandleNumbers = [];\n    var scope_ActiveHandlesCount = 0;\n    var scope_Events = {};\n    // Document Nodes\n    var scope_Document = target.ownerDocument;\n    var scope_DocumentElement = options.documentElement || scope_Document.documentElement;\n    var scope_Body = scope_Document.body;\n    // For horizontal sliders in standard ltr documents,\n    // make .noUi-origin overflow to the left so the document doesn't scroll.\n    var scope_DirOffset = scope_Document.dir === \"rtl\" || options.ort === 1 ? 0 : 100;\n    // Creates a node, adds it to target, returns the new node.\n    function addNodeTo(addTarget, className) {\n        var div = scope_Document.createElement(\"div\");\n        if (className) {\n            addClass(div, className);\n        }\n        addTarget.appendChild(div);\n        return div;\n    }\n    // Append a origin to the base\n    function addOrigin(base, handleNumber) {\n        var origin = addNodeTo(base, options.cssClasses.origin);\n        var handle = addNodeTo(origin, options.cssClasses.handle);\n        addNodeTo(handle, options.cssClasses.touchArea);\n        handle.setAttribute(\"data-handle\", String(handleNumber));\n        if (options.keyboardSupport) {\n            // https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/tabindex\n            // 0 = focusable and reachable\n            handle.setAttribute(\"tabindex\", \"0\");\n            handle.addEventListener(\"keydown\", function (event) {\n                return eventKeydown(event, handleNumber);\n            });\n        }\n        if (options.handleAttributes !== undefined) {\n            var attributes_1 = options.handleAttributes[handleNumber];\n            Object.keys(attributes_1).forEach(function (attribute) {\n                handle.setAttribute(attribute, attributes_1[attribute]);\n            });\n        }\n        handle.setAttribute(\"role\", \"slider\");\n        handle.setAttribute(\"aria-orientation\", options.ort ? \"vertical\" : \"horizontal\");\n        if (handleNumber === 0) {\n            addClass(handle, options.cssClasses.handleLower);\n        }\n        else if (handleNumber === options.handles - 1) {\n            addClass(handle, options.cssClasses.handleUpper);\n        }\n        origin.handle = handle;\n        return origin;\n    }\n    // Insert nodes for connect elements\n    function addConnect(base, add) {\n        if (!add) {\n            return false;\n        }\n        return addNodeTo(base, options.cssClasses.connect);\n    }\n    // Add handles to the slider base.\n    function addElements(connectOptions, base) {\n        var connectBase = addNodeTo(base, options.cssClasses.connects);\n        scope_Handles = [];\n        scope_Connects = [];\n        scope_Connects.push(addConnect(connectBase, connectOptions[0]));\n        // [::::O====O====O====]\n        // connectOptions = [0, 1, 1, 1]\n        for (var i = 0; i < options.handles; i++) {\n            // Keep a list of all added handles.\n            scope_Handles.push(addOrigin(base, i));\n            scope_HandleNumbers[i] = i;\n            scope_Connects.push(addConnect(connectBase, connectOptions[i + 1]));\n        }\n    }\n    // Initialize a single slider.\n    function addSlider(addTarget) {\n        // Apply classes and data to the target.\n        addClass(addTarget, options.cssClasses.target);\n        if (options.dir === 0) {\n            addClass(addTarget, options.cssClasses.ltr);\n        }\n        else {\n            addClass(addTarget, options.cssClasses.rtl);\n        }\n        if (options.ort === 0) {\n            addClass(addTarget, options.cssClasses.horizontal);\n        }\n        else {\n            addClass(addTarget, options.cssClasses.vertical);\n        }\n        var textDirection = getComputedStyle(addTarget).direction;\n        if (textDirection === \"rtl\") {\n            addClass(addTarget, options.cssClasses.textDirectionRtl);\n        }\n        else {\n            addClass(addTarget, options.cssClasses.textDirectionLtr);\n        }\n        return addNodeTo(addTarget, options.cssClasses.base);\n    }\n    function addTooltip(handle, handleNumber) {\n        if (!options.tooltips || !options.tooltips[handleNumber]) {\n            return false;\n        }\n        return addNodeTo(handle.firstChild, options.cssClasses.tooltip);\n    }\n    function isSliderDisabled() {\n        return scope_Target.hasAttribute(\"disabled\");\n    }\n    // Disable the slider dragging if any handle is disabled\n    function isHandleDisabled(handleNumber) {\n        var handleOrigin = scope_Handles[handleNumber];\n        return handleOrigin.hasAttribute(\"disabled\");\n    }\n    function disable(handleNumber) {\n        if (handleNumber !== null && handleNumber !== undefined) {\n            scope_Handles[handleNumber].setAttribute(\"disabled\", \"\");\n            scope_Handles[handleNumber].handle.removeAttribute(\"tabindex\");\n        }\n        else {\n            scope_Target.setAttribute(\"disabled\", \"\");\n            scope_Handles.forEach(function (handle) {\n                handle.handle.removeAttribute(\"tabindex\");\n            });\n        }\n    }\n    function enable(handleNumber) {\n        if (handleNumber !== null && handleNumber !== undefined) {\n            scope_Handles[handleNumber].removeAttribute(\"disabled\");\n            scope_Handles[handleNumber].handle.setAttribute(\"tabindex\", \"0\");\n        }\n        else {\n            scope_Target.removeAttribute(\"disabled\");\n            scope_Handles.forEach(function (handle) {\n                handle.removeAttribute(\"disabled\");\n                handle.handle.setAttribute(\"tabindex\", \"0\");\n            });\n        }\n    }\n    function removeTooltips() {\n        if (scope_Tooltips) {\n            removeEvent(\"update\" + INTERNAL_EVENT_NS.tooltips);\n            scope_Tooltips.forEach(function (tooltip) {\n                if (tooltip) {\n                    removeElement(tooltip);\n                }\n            });\n            scope_Tooltips = null;\n        }\n    }\n    // The tooltips option is a shorthand for using the 'update' event.\n    function tooltips() {\n        removeTooltips();\n        // Tooltips are added with options.tooltips in original order.\n        scope_Tooltips = scope_Handles.map(addTooltip);\n        bindEvent(\"update\" + INTERNAL_EVENT_NS.tooltips, function (values, handleNumber, unencoded) {\n            if (!scope_Tooltips || !options.tooltips) {\n                return;\n            }\n            if (scope_Tooltips[handleNumber] === false) {\n                return;\n            }\n            var formattedValue = values[handleNumber];\n            if (options.tooltips[handleNumber] !== true) {\n                formattedValue = options.tooltips[handleNumber].to(unencoded[handleNumber]);\n            }\n            scope_Tooltips[handleNumber].innerHTML = formattedValue;\n        });\n    }\n    function aria() {\n        removeEvent(\"update\" + INTERNAL_EVENT_NS.aria);\n        bindEvent(\"update\" + INTERNAL_EVENT_NS.aria, function (values, handleNumber, unencoded, tap, positions) {\n            // Update Aria Values for all handles, as a change in one changes min and max values for the next.\n            scope_HandleNumbers.forEach(function (index) {\n                var handle = scope_Handles[index];\n                var min = checkHandlePosition(scope_Locations, index, 0, true, true, true);\n                var max = checkHandlePosition(scope_Locations, index, 100, true, true, true);\n                var now = positions[index];\n                // Formatted value for display\n                var text = String(options.ariaFormat.to(unencoded[index]));\n                // Map to slider range values\n                min = scope_Spectrum.fromStepping(min).toFixed(1);\n                max = scope_Spectrum.fromStepping(max).toFixed(1);\n                now = scope_Spectrum.fromStepping(now).toFixed(1);\n                handle.children[0].setAttribute(\"aria-valuemin\", min);\n                handle.children[0].setAttribute(\"aria-valuemax\", max);\n                handle.children[0].setAttribute(\"aria-valuenow\", now);\n                handle.children[0].setAttribute(\"aria-valuetext\", text);\n            });\n        });\n    }\n    function getGroup(pips) {\n        // Use the range.\n        if (pips.mode === PipsMode.Range || pips.mode === PipsMode.Steps) {\n            return scope_Spectrum.xVal;\n        }\n        if (pips.mode === PipsMode.Count) {\n            if (pips.values < 2) {\n                throw new Error(\"noUiSlider: 'values' (>= 2) required for mode 'count'.\");\n            }\n            // Divide 0 - 100 in 'count' parts.\n            var interval = pips.values - 1;\n            var spread = 100 / interval;\n            var values = [];\n            // List these parts and have them handled as 'positions'.\n            while (interval--) {\n                values[interval] = interval * spread;\n            }\n            values.push(100);\n            return mapToRange(values, pips.stepped);\n        }\n        if (pips.mode === PipsMode.Positions) {\n            // Map all percentages to on-range values.\n            return mapToRange(pips.values, pips.stepped);\n        }\n        if (pips.mode === PipsMode.Values) {\n            // If the value must be stepped, it needs to be converted to a percentage first.\n            if (pips.stepped) {\n                return pips.values.map(function (value) {\n                    // Convert to percentage, apply step, return to value.\n                    return scope_Spectrum.fromStepping(scope_Spectrum.getStep(scope_Spectrum.toStepping(value)));\n                });\n            }\n            // Otherwise, we can simply use the values.\n            return pips.values;\n        }\n        return []; // pips.mode = never\n    }\n    function mapToRange(values, stepped) {\n        return values.map(function (value) {\n            return scope_Spectrum.fromStepping(stepped ? scope_Spectrum.getStep(value) : value);\n        });\n    }\n    function generateSpread(pips) {\n        function safeIncrement(value, increment) {\n            // Avoid floating point variance by dropping the smallest decimal places.\n            return Number((value + increment).toFixed(7));\n        }\n        var group = getGroup(pips);\n        var indexes = {};\n        var firstInRange = scope_Spectrum.xVal[0];\n        var lastInRange = scope_Spectrum.xVal[scope_Spectrum.xVal.length - 1];\n        var ignoreFirst = false;\n        var ignoreLast = false;\n        var prevPct = 0;\n        // Create a copy of the group, sort it and filter away all duplicates.\n        group = unique(group.slice().sort(function (a, b) {\n            return a - b;\n        }));\n        // Make sure the range starts with the first element.\n        if (group[0] !== firstInRange) {\n            group.unshift(firstInRange);\n            ignoreFirst = true;\n        }\n        // Likewise for the last one.\n        if (group[group.length - 1] !== lastInRange) {\n            group.push(lastInRange);\n            ignoreLast = true;\n        }\n        group.forEach(function (current, index) {\n            // Get the current step and the lower + upper positions.\n            var step;\n            var i;\n            var q;\n            var low = current;\n            var high = group[index + 1];\n            var newPct;\n            var pctDifference;\n            var pctPos;\n            var type;\n            var steps;\n            var realSteps;\n            var stepSize;\n            var isSteps = pips.mode === PipsMode.Steps;\n            // When using 'steps' mode, use the provided steps.\n            // Otherwise, we'll step on to the next subrange.\n            if (isSteps) {\n                step = scope_Spectrum.xNumSteps[index];\n            }\n            // Default to a 'full' step.\n            if (!step) {\n                step = high - low;\n            }\n            // If high is undefined we are at the last subrange. Make sure it iterates once (#1088)\n            if (high === undefined) {\n                high = low;\n            }\n            // Make sure step isn't 0, which would cause an infinite loop (#654)\n            step = Math.max(step, 0.0000001);\n            // Find all steps in the subrange.\n            for (i = low; i <= high; i = safeIncrement(i, step)) {\n                // Get the percentage value for the current step,\n                // calculate the size for the subrange.\n                newPct = scope_Spectrum.toStepping(i);\n                pctDifference = newPct - prevPct;\n                steps = pctDifference / (pips.density || 1);\n                realSteps = Math.round(steps);\n                // This ratio represents the amount of percentage-space a point indicates.\n                // For a density 1 the points/percentage = 1. For density 2, that percentage needs to be re-divided.\n                // Round the percentage offset to an even number, then divide by two\n                // to spread the offset on both sides of the range.\n                stepSize = pctDifference / realSteps;\n                // Divide all points evenly, adding the correct number to this subrange.\n                // Run up to <= so that 100% gets a point, event if ignoreLast is set.\n                for (q = 1; q <= realSteps; q += 1) {\n                    // The ratio between the rounded value and the actual size might be ~1% off.\n                    // Correct the percentage offset by the number of points\n                    // per subrange. density = 1 will result in 100 points on the\n                    // full range, 2 for 50, 4 for 25, etc.\n                    pctPos = prevPct + q * stepSize;\n                    indexes[pctPos.toFixed(5)] = [scope_Spectrum.fromStepping(pctPos), 0];\n                }\n                // Determine the point type.\n                type = group.indexOf(i) > -1 ? PipsType.LargeValue : isSteps ? PipsType.SmallValue : PipsType.NoValue;\n                // Enforce the 'ignoreFirst' option by overwriting the type for 0.\n                if (!index && ignoreFirst && i !== high) {\n                    type = 0;\n                }\n                if (!(i === high && ignoreLast)) {\n                    // Mark the 'type' of this point. 0 = plain, 1 = real value, 2 = step value.\n                    indexes[newPct.toFixed(5)] = [i, type];\n                }\n                // Update the percentage count.\n                prevPct = newPct;\n            }\n        });\n        return indexes;\n    }\n    function addMarking(spread, filterFunc, formatter) {\n        var _a, _b;\n        var element = scope_Document.createElement(\"div\");\n        var valueSizeClasses = (_a = {},\n            _a[PipsType.None] = \"\",\n            _a[PipsType.NoValue] = options.cssClasses.valueNormal,\n            _a[PipsType.LargeValue] = options.cssClasses.valueLarge,\n            _a[PipsType.SmallValue] = options.cssClasses.valueSub,\n            _a);\n        var markerSizeClasses = (_b = {},\n            _b[PipsType.None] = \"\",\n            _b[PipsType.NoValue] = options.cssClasses.markerNormal,\n            _b[PipsType.LargeValue] = options.cssClasses.markerLarge,\n            _b[PipsType.SmallValue] = options.cssClasses.markerSub,\n            _b);\n        var valueOrientationClasses = [options.cssClasses.valueHorizontal, options.cssClasses.valueVertical];\n        var markerOrientationClasses = [options.cssClasses.markerHorizontal, options.cssClasses.markerVertical];\n        addClass(element, options.cssClasses.pips);\n        addClass(element, options.ort === 0 ? options.cssClasses.pipsHorizontal : options.cssClasses.pipsVertical);\n        function getClasses(type, source) {\n            var a = source === options.cssClasses.value;\n            var orientationClasses = a ? valueOrientationClasses : markerOrientationClasses;\n            var sizeClasses = a ? valueSizeClasses : markerSizeClasses;\n            return source + \" \" + orientationClasses[options.ort] + \" \" + sizeClasses[type];\n        }\n        function addSpread(offset, value, type) {\n            // Apply the filter function, if it is set.\n            type = filterFunc ? filterFunc(value, type) : type;\n            if (type === PipsType.None) {\n                return;\n            }\n            // Add a marker for every point\n            var node = addNodeTo(element, false);\n            node.className = getClasses(type, options.cssClasses.marker);\n            node.style[options.style] = offset + \"%\";\n            // Values are only appended for points marked '1' or '2'.\n            if (type > PipsType.NoValue) {\n                node = addNodeTo(element, false);\n                node.className = getClasses(type, options.cssClasses.value);\n                node.setAttribute(\"data-value\", String(value));\n                node.style[options.style] = offset + \"%\";\n                node.innerHTML = String(formatter.to(value));\n            }\n        }\n        // Append all points.\n        Object.keys(spread).forEach(function (offset) {\n            addSpread(offset, spread[offset][0], spread[offset][1]);\n        });\n        return element;\n    }\n    function removePips() {\n        if (scope_Pips) {\n            removeElement(scope_Pips);\n            scope_Pips = null;\n        }\n    }\n    function pips(pips) {\n        // Fix #669\n        removePips();\n        var spread = generateSpread(pips);\n        var filter = pips.filter;\n        var format = pips.format || {\n            to: function (value) {\n                return String(Math.round(value));\n            },\n        };\n        scope_Pips = scope_Target.appendChild(addMarking(spread, filter, format));\n        return scope_Pips;\n    }\n    // Shorthand for base dimensions.\n    function baseSize() {\n        var rect = scope_Base.getBoundingClientRect();\n        var alt = (\"offset\" + [\"Width\", \"Height\"][options.ort]);\n        return options.ort === 0 ? rect.width || scope_Base[alt] : rect.height || scope_Base[alt];\n    }\n    // Handler for attaching events trough a proxy.\n    function attachEvent(events, element, callback, data) {\n        // This function can be used to 'filter' events to the slider.\n        // element is a node, not a nodeList\n        var method = function (event) {\n            var e = fixEvent(event, data.pageOffset, data.target || element);\n            // fixEvent returns false if this event has a different target\n            // when handling (multi-) touch events;\n            if (!e) {\n                return false;\n            }\n            // doNotReject is passed by all end events to make sure released touches\n            // are not rejected, leaving the slider \"stuck\" to the cursor;\n            if (isSliderDisabled() && !data.doNotReject) {\n                return false;\n            }\n            // Stop if an active 'tap' transition is taking place.\n            if (hasClass(scope_Target, options.cssClasses.tap) && !data.doNotReject) {\n                return false;\n            }\n            // Ignore right or middle clicks on start #454\n            if (events === actions.start && e.buttons !== undefined && e.buttons > 1) {\n                return false;\n            }\n            // Ignore right or middle clicks on start #454\n            if (data.hover && e.buttons) {\n                return false;\n            }\n            // 'supportsPassive' is only true if a browser also supports touch-action: none in CSS.\n            // iOS safari does not, so it doesn't get to benefit from passive scrolling. iOS does support\n            // touch-action: manipulation, but that allows panning, which breaks\n            // sliders after zooming/on non-responsive pages.\n            // See: https://bugs.webkit.org/show_bug.cgi?id=133112\n            if (!supportsPassive) {\n                e.preventDefault();\n            }\n            e.calcPoint = e.points[options.ort];\n            // Call the event handler with the event [ and additional data ].\n            callback(e, data);\n            return;\n        };\n        var methods = [];\n        // Bind a closure on the target for every event type.\n        events.split(\" \").forEach(function (eventName) {\n            element.addEventListener(eventName, method, supportsPassive ? { passive: true } : false);\n            methods.push([eventName, method]);\n        });\n        return methods;\n    }\n    // Provide a clean event with standardized offset values.\n    function fixEvent(e, pageOffset, eventTarget) {\n        // Filter the event to register the type, which can be\n        // touch, mouse or pointer. Offset changes need to be\n        // made on an event specific basis.\n        var touch = e.type.indexOf(\"touch\") === 0;\n        var mouse = e.type.indexOf(\"mouse\") === 0;\n        var pointer = e.type.indexOf(\"pointer\") === 0;\n        var x = 0;\n        var y = 0;\n        // IE10 implemented pointer events with a prefix;\n        if (e.type.indexOf(\"MSPointer\") === 0) {\n            pointer = true;\n        }\n        // Erroneous events seem to be passed in occasionally on iOS/iPadOS after user finishes interacting with\n        // the slider. They appear to be of type MouseEvent, yet they don't have usual properties set. Ignore\n        // events that have no touches or buttons associated with them. (#1057, #1079, #1095)\n        if (e.type === \"mousedown\" && !e.buttons && !e.touches) {\n            return false;\n        }\n        // The only thing one handle should be concerned about is the touches that originated on top of it.\n        if (touch) {\n            // Returns true if a touch originated on the target.\n            var isTouchOnTarget = function (checkTouch) {\n                var target = checkTouch.target;\n                return (target === eventTarget ||\n                    eventTarget.contains(target) ||\n                    (e.composed && e.composedPath().shift() === eventTarget));\n            };\n            // In the case of touchstart events, we need to make sure there is still no more than one\n            // touch on the target so we look amongst all touches.\n            if (e.type === \"touchstart\") {\n                var targetTouches = Array.prototype.filter.call(e.touches, isTouchOnTarget);\n                // Do not support more than one touch per handle.\n                if (targetTouches.length > 1) {\n                    return false;\n                }\n                x = targetTouches[0].pageX;\n                y = targetTouches[0].pageY;\n            }\n            else {\n                // In the other cases, find on changedTouches is enough.\n                var targetTouch = Array.prototype.find.call(e.changedTouches, isTouchOnTarget);\n                // Cancel if the target touch has not moved.\n                if (!targetTouch) {\n                    return false;\n                }\n                x = targetTouch.pageX;\n                y = targetTouch.pageY;\n            }\n        }\n        pageOffset = pageOffset || getPageOffset(scope_Document);\n        if (mouse || pointer) {\n            x = e.clientX + pageOffset.x;\n            y = e.clientY + pageOffset.y;\n        }\n        e.pageOffset = pageOffset;\n        e.points = [x, y];\n        e.cursor = mouse || pointer; // Fix #435\n        return e;\n    }\n    // Translate a coordinate in the document to a percentage on the slider\n    function calcPointToPercentage(calcPoint) {\n        var location = calcPoint - offset(scope_Base, options.ort);\n        var proposal = (location * 100) / baseSize();\n        // Clamp proposal between 0% and 100%\n        // Out-of-bound coordinates may occur when .noUi-base pseudo-elements\n        // are used (e.g. contained handles feature)\n        proposal = limit(proposal);\n        return options.dir ? 100 - proposal : proposal;\n    }\n    // Find handle closest to a certain percentage on the slider\n    function getClosestHandle(clickedPosition) {\n        var smallestDifference = 100;\n        var handleNumber = false;\n        scope_Handles.forEach(function (handle, index) {\n            // Disabled handles are ignored\n            if (isHandleDisabled(index)) {\n                return;\n            }\n            var handlePosition = scope_Locations[index];\n            var differenceWithThisHandle = Math.abs(handlePosition - clickedPosition);\n            // Initial state\n            var clickAtEdge = differenceWithThisHandle === 100 && smallestDifference === 100;\n            // Difference with this handle is smaller than the previously checked handle\n            var isCloser = differenceWithThisHandle < smallestDifference;\n            var isCloserAfter = differenceWithThisHandle <= smallestDifference && clickedPosition > handlePosition;\n            if (isCloser || isCloserAfter || clickAtEdge) {\n                handleNumber = index;\n                smallestDifference = differenceWithThisHandle;\n            }\n        });\n        return handleNumber;\n    }\n    // Fire 'end' when a mouse or pen leaves the document.\n    function documentLeave(event, data) {\n        if (event.type === \"mouseout\" &&\n            event.target.nodeName === \"HTML\" &&\n            event.relatedTarget === null) {\n            eventEnd(event, data);\n        }\n    }\n    // Handle movement on document for handle and range drag.\n    function eventMove(event, data) {\n        // Fix #498\n        // Check value of .buttons in 'start' to work around a bug in IE10 mobile (data.buttonsProperty).\n        // https://connect.microsoft.com/IE/feedback/details/927005/mobile-ie10-windows-phone-buttons-property-of-pointermove-event-always-zero\n        // IE9 has .buttons and .which zero on mousemove.\n        // Firefox breaks the spec MDN defines.\n        if (navigator.appVersion.indexOf(\"MSIE 9\") === -1 && event.buttons === 0 && data.buttonsProperty !== 0) {\n            return eventEnd(event, data);\n        }\n        // Check if we are moving up or down\n        var movement = (options.dir ? -1 : 1) * (event.calcPoint - data.startCalcPoint);\n        // Convert the movement into a percentage of the slider width/height\n        var proposal = (movement * 100) / data.baseSize;\n        moveHandles(movement > 0, proposal, data.locations, data.handleNumbers, data.connect);\n    }\n    // Unbind move events on document, call callbacks.\n    function eventEnd(event, data) {\n        // The handle is no longer active, so remove the class.\n        if (data.handle) {\n            removeClass(data.handle, options.cssClasses.active);\n            scope_ActiveHandlesCount -= 1;\n        }\n        // Unbind the move and end events, which are added on 'start'.\n        data.listeners.forEach(function (c) {\n            scope_DocumentElement.removeEventListener(c[0], c[1]);\n        });\n        if (scope_ActiveHandlesCount === 0) {\n            // Remove dragging class.\n            removeClass(scope_Target, options.cssClasses.drag);\n            setZindex();\n            // Remove cursor styles and text-selection events bound to the body.\n            if (event.cursor) {\n                scope_Body.style.cursor = \"\";\n                scope_Body.removeEventListener(\"selectstart\", preventDefault);\n            }\n        }\n        if (options.events.smoothSteps) {\n            data.handleNumbers.forEach(function (handleNumber) {\n                setHandle(handleNumber, scope_Locations[handleNumber], true, true, false, false);\n            });\n            data.handleNumbers.forEach(function (handleNumber) {\n                fireEvent(\"update\", handleNumber);\n            });\n        }\n        data.handleNumbers.forEach(function (handleNumber) {\n            fireEvent(\"change\", handleNumber);\n            fireEvent(\"set\", handleNumber);\n            fireEvent(\"end\", handleNumber);\n        });\n    }\n    // Bind move events on document.\n    function eventStart(event, data) {\n        // Ignore event if any handle is disabled\n        if (data.handleNumbers.some(isHandleDisabled)) {\n            return;\n        }\n        var handle;\n        if (data.handleNumbers.length === 1) {\n            var handleOrigin = scope_Handles[data.handleNumbers[0]];\n            handle = handleOrigin.children[0];\n            scope_ActiveHandlesCount += 1;\n            // Mark the handle as 'active' so it can be styled.\n            addClass(handle, options.cssClasses.active);\n        }\n        // A drag should never propagate up to the 'tap' event.\n        event.stopPropagation();\n        // Record the event listeners.\n        var listeners = [];\n        // Attach the move and end events.\n        var moveEvent = attachEvent(actions.move, scope_DocumentElement, eventMove, {\n            // The event target has changed so we need to propagate the original one so that we keep\n            // relying on it to extract target touches.\n            target: event.target,\n            handle: handle,\n            connect: data.connect,\n            listeners: listeners,\n            startCalcPoint: event.calcPoint,\n            baseSize: baseSize(),\n            pageOffset: event.pageOffset,\n            handleNumbers: data.handleNumbers,\n            buttonsProperty: event.buttons,\n            locations: scope_Locations.slice(),\n        });\n        var endEvent = attachEvent(actions.end, scope_DocumentElement, eventEnd, {\n            target: event.target,\n            handle: handle,\n            listeners: listeners,\n            doNotReject: true,\n            handleNumbers: data.handleNumbers,\n        });\n        var outEvent = attachEvent(\"mouseout\", scope_DocumentElement, documentLeave, {\n            target: event.target,\n            handle: handle,\n            listeners: listeners,\n            doNotReject: true,\n            handleNumbers: data.handleNumbers,\n        });\n        // We want to make sure we pushed the listeners in the listener list rather than creating\n        // a new one as it has already been passed to the event handlers.\n        listeners.push.apply(listeners, moveEvent.concat(endEvent, outEvent));\n        // Text selection isn't an issue on touch devices,\n        // so adding cursor styles can be skipped.\n        if (event.cursor) {\n            // Prevent the 'I' cursor and extend the range-drag cursor.\n            scope_Body.style.cursor = getComputedStyle(event.target).cursor;\n            // Mark the target with a dragging state.\n            if (scope_Handles.length > 1) {\n                addClass(scope_Target, options.cssClasses.drag);\n            }\n            // Prevent text selection when dragging the handles.\n            // In noUiSlider <= 9.2.0, this was handled by calling preventDefault on mouse/touch start/move,\n            // which is scroll blocking. The selectstart event is supported by FireFox starting from version 52,\n            // meaning the only holdout is iOS Safari. This doesn't matter: text selection isn't triggered there.\n            // The 'cursor' flag is false.\n            // See: http://caniuse.com/#search=selectstart\n            scope_Body.addEventListener(\"selectstart\", preventDefault, false);\n        }\n        data.handleNumbers.forEach(function (handleNumber) {\n            fireEvent(\"start\", handleNumber);\n        });\n    }\n    // Move closest handle to tapped location.\n    function eventTap(event) {\n        // The tap event shouldn't propagate up\n        event.stopPropagation();\n        var proposal = calcPointToPercentage(event.calcPoint);\n        var handleNumber = getClosestHandle(proposal);\n        // Tackle the case that all handles are 'disabled'.\n        if (handleNumber === false) {\n            return;\n        }\n        // Flag the slider as it is now in a transitional state.\n        // Transition takes a configurable amount of ms (default 300). Re-enable the slider after that.\n        if (!options.events.snap) {\n            addClassFor(scope_Target, options.cssClasses.tap, options.animationDuration);\n        }\n        setHandle(handleNumber, proposal, true, true);\n        setZindex();\n        fireEvent(\"slide\", handleNumber, true);\n        fireEvent(\"update\", handleNumber, true);\n        if (!options.events.snap) {\n            fireEvent(\"change\", handleNumber, true);\n            fireEvent(\"set\", handleNumber, true);\n        }\n        else {\n            eventStart(event, { handleNumbers: [handleNumber] });\n        }\n    }\n    // Fires a 'hover' event for a hovered mouse/pen position.\n    function eventHover(event) {\n        var proposal = calcPointToPercentage(event.calcPoint);\n        var to = scope_Spectrum.getStep(proposal);\n        var value = scope_Spectrum.fromStepping(to);\n        Object.keys(scope_Events).forEach(function (targetEvent) {\n            if (\"hover\" === targetEvent.split(\".\")[0]) {\n                scope_Events[targetEvent].forEach(function (callback) {\n                    callback.call(scope_Self, value);\n                });\n            }\n        });\n    }\n    // Handles keydown on focused handles\n    // Don't move the document when pressing arrow keys on focused handles\n    function eventKeydown(event, handleNumber) {\n        if (isSliderDisabled() || isHandleDisabled(handleNumber)) {\n            return false;\n        }\n        var horizontalKeys = [\"Left\", \"Right\"];\n        var verticalKeys = [\"Down\", \"Up\"];\n        var largeStepKeys = [\"PageDown\", \"PageUp\"];\n        var edgeKeys = [\"Home\", \"End\"];\n        if (options.dir && !options.ort) {\n            // On an right-to-left slider, the left and right keys act inverted\n            horizontalKeys.reverse();\n        }\n        else if (options.ort && !options.dir) {\n            // On a top-to-bottom slider, the up and down keys act inverted\n            verticalKeys.reverse();\n            largeStepKeys.reverse();\n        }\n        // Strip \"Arrow\" for IE compatibility. https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key\n        var key = event.key.replace(\"Arrow\", \"\");\n        var isLargeDown = key === largeStepKeys[0];\n        var isLargeUp = key === largeStepKeys[1];\n        var isDown = key === verticalKeys[0] || key === horizontalKeys[0] || isLargeDown;\n        var isUp = key === verticalKeys[1] || key === horizontalKeys[1] || isLargeUp;\n        var isMin = key === edgeKeys[0];\n        var isMax = key === edgeKeys[1];\n        if (!isDown && !isUp && !isMin && !isMax) {\n            return true;\n        }\n        event.preventDefault();\n        var to;\n        if (isUp || isDown) {\n            var direction = isDown ? 0 : 1;\n            var steps = getNextStepsForHandle(handleNumber);\n            var step = steps[direction];\n            // At the edge of a slider, do nothing\n            if (step === null) {\n                return false;\n            }\n            // No step set, use the default of 10% of the sub-range\n            if (step === false) {\n                step = scope_Spectrum.getDefaultStep(scope_Locations[handleNumber], isDown, options.keyboardDefaultStep);\n            }\n            if (isLargeUp || isLargeDown) {\n                step *= options.keyboardPageMultiplier;\n            }\n            else {\n                step *= options.keyboardMultiplier;\n            }\n            // Step over zero-length ranges (#948);\n            step = Math.max(step, 0.0000001);\n            // Decrement for down steps\n            step = (isDown ? -1 : 1) * step;\n            to = scope_Values[handleNumber] + step;\n        }\n        else if (isMax) {\n            // End key\n            to = options.spectrum.xVal[options.spectrum.xVal.length - 1];\n        }\n        else {\n            // Home key\n            to = options.spectrum.xVal[0];\n        }\n        setHandle(handleNumber, scope_Spectrum.toStepping(to), true, true);\n        fireEvent(\"slide\", handleNumber);\n        fireEvent(\"update\", handleNumber);\n        fireEvent(\"change\", handleNumber);\n        fireEvent(\"set\", handleNumber);\n        return false;\n    }\n    // Attach events to several slider parts.\n    function bindSliderEvents(behaviour) {\n        // Attach the standard drag event to the handles.\n        if (!behaviour.fixed) {\n            scope_Handles.forEach(function (handle, index) {\n                // These events are only bound to the visual handle\n                // element, not the 'real' origin element.\n                attachEvent(actions.start, handle.children[0], eventStart, {\n                    handleNumbers: [index],\n                });\n            });\n        }\n        // Attach the tap event to the slider base.\n        if (behaviour.tap) {\n            attachEvent(actions.start, scope_Base, eventTap, {});\n        }\n        // Fire hover events\n        if (behaviour.hover) {\n            attachEvent(actions.move, scope_Base, eventHover, {\n                hover: true,\n            });\n        }\n        // Make the range draggable.\n        if (behaviour.drag) {\n            scope_Connects.forEach(function (connect, index) {\n                if (connect === false || index === 0 || index === scope_Connects.length - 1) {\n                    return;\n                }\n                var handleBefore = scope_Handles[index - 1];\n                var handleAfter = scope_Handles[index];\n                var eventHolders = [connect];\n                var handlesToDrag = [handleBefore, handleAfter];\n                var handleNumbersToDrag = [index - 1, index];\n                addClass(connect, options.cssClasses.draggable);\n                // When the range is fixed, the entire range can\n                // be dragged by the handles. The handle in the first\n                // origin will propagate the start event upward,\n                // but it needs to be bound manually on the other.\n                if (behaviour.fixed) {\n                    eventHolders.push(handleBefore.children[0]);\n                    eventHolders.push(handleAfter.children[0]);\n                }\n                if (behaviour.dragAll) {\n                    handlesToDrag = scope_Handles;\n                    handleNumbersToDrag = scope_HandleNumbers;\n                }\n                eventHolders.forEach(function (eventHolder) {\n                    attachEvent(actions.start, eventHolder, eventStart, {\n                        handles: handlesToDrag,\n                        handleNumbers: handleNumbersToDrag,\n                        connect: connect,\n                    });\n                });\n            });\n        }\n    }\n    // Attach an event to this slider, possibly including a namespace\n    function bindEvent(namespacedEvent, callback) {\n        scope_Events[namespacedEvent] = scope_Events[namespacedEvent] || [];\n        scope_Events[namespacedEvent].push(callback);\n        // If the event bound is 'update,' fire it immediately for all handles.\n        if (namespacedEvent.split(\".\")[0] === \"update\") {\n            scope_Handles.forEach(function (a, index) {\n                fireEvent(\"update\", index);\n            });\n        }\n    }\n    function isInternalNamespace(namespace) {\n        return namespace === INTERNAL_EVENT_NS.aria || namespace === INTERNAL_EVENT_NS.tooltips;\n    }\n    // Undo attachment of event\n    function removeEvent(namespacedEvent) {\n        var event = namespacedEvent && namespacedEvent.split(\".\")[0];\n        var namespace = event ? namespacedEvent.substring(event.length) : namespacedEvent;\n        Object.keys(scope_Events).forEach(function (bind) {\n            var tEvent = bind.split(\".\")[0];\n            var tNamespace = bind.substring(tEvent.length);\n            if ((!event || event === tEvent) && (!namespace || namespace === tNamespace)) {\n                // only delete protected internal event if intentional\n                if (!isInternalNamespace(tNamespace) || namespace === tNamespace) {\n                    delete scope_Events[bind];\n                }\n            }\n        });\n    }\n    // External event handling\n    function fireEvent(eventName, handleNumber, tap) {\n        Object.keys(scope_Events).forEach(function (targetEvent) {\n            var eventType = targetEvent.split(\".\")[0];\n            if (eventName === eventType) {\n                scope_Events[targetEvent].forEach(function (callback) {\n                    callback.call(\n                    // Use the slider public API as the scope ('this')\n                    scope_Self, \n                    // Return values as array, so arg_1[arg_2] is always valid.\n                    scope_Values.map(options.format.to), \n                    // Handle index, 0 or 1\n                    handleNumber, \n                    // Un-formatted slider values\n                    scope_Values.slice(), \n                    // Event is fired by tap, true or false\n                    tap || false, \n                    // Left offset of the handle, in relation to the slider\n                    scope_Locations.slice(), \n                    // add the slider public API to an accessible parameter when this is unavailable\n                    scope_Self);\n                });\n            }\n        });\n    }\n    // Split out the handle positioning logic so the Move event can use it, too\n    function checkHandlePosition(reference, handleNumber, to, lookBackward, lookForward, getValue, smoothSteps) {\n        var distance;\n        // For sliders with multiple handles, limit movement to the other handle.\n        // Apply the margin option by adding it to the handle positions.\n        if (scope_Handles.length > 1 && !options.events.unconstrained) {\n            if (lookBackward && handleNumber > 0) {\n                distance = scope_Spectrum.getAbsoluteDistance(reference[handleNumber - 1], options.margin, false);\n                to = Math.max(to, distance);\n            }\n            if (lookForward && handleNumber < scope_Handles.length - 1) {\n                distance = scope_Spectrum.getAbsoluteDistance(reference[handleNumber + 1], options.margin, true);\n                to = Math.min(to, distance);\n            }\n        }\n        // The limit option has the opposite effect, limiting handles to a\n        // maximum distance from another. Limit must be > 0, as otherwise\n        // handles would be unmovable.\n        if (scope_Handles.length > 1 && options.limit) {\n            if (lookBackward && handleNumber > 0) {\n                distance = scope_Spectrum.getAbsoluteDistance(reference[handleNumber - 1], options.limit, false);\n                to = Math.min(to, distance);\n            }\n            if (lookForward && handleNumber < scope_Handles.length - 1) {\n                distance = scope_Spectrum.getAbsoluteDistance(reference[handleNumber + 1], options.limit, true);\n                to = Math.max(to, distance);\n            }\n        }\n        // The padding option keeps the handles a certain distance from the\n        // edges of the slider. Padding must be > 0.\n        if (options.padding) {\n            if (handleNumber === 0) {\n                distance = scope_Spectrum.getAbsoluteDistance(0, options.padding[0], false);\n                to = Math.max(to, distance);\n            }\n            if (handleNumber === scope_Handles.length - 1) {\n                distance = scope_Spectrum.getAbsoluteDistance(100, options.padding[1], true);\n                to = Math.min(to, distance);\n            }\n        }\n        if (!smoothSteps) {\n            to = scope_Spectrum.getStep(to);\n        }\n        // Limit percentage to the 0 - 100 range\n        to = limit(to);\n        // Return false if handle can't move\n        if (to === reference[handleNumber] && !getValue) {\n            return false;\n        }\n        return to;\n    }\n    // Uses slider orientation to create CSS rules. a = base value;\n    function inRuleOrder(v, a) {\n        var o = options.ort;\n        return (o ? a : v) + \", \" + (o ? v : a);\n    }\n    // Moves handle(s) by a percentage\n    // (bool, % to move, [% where handle started, ...], [index in scope_Handles, ...])\n    function moveHandles(upward, proposal, locations, handleNumbers, connect) {\n        var proposals = locations.slice();\n        // Store first handle now, so we still have it in case handleNumbers is reversed\n        var firstHandle = handleNumbers[0];\n        var smoothSteps = options.events.smoothSteps;\n        var b = [!upward, upward];\n        var f = [upward, !upward];\n        // Copy handleNumbers so we don't change the dataset\n        handleNumbers = handleNumbers.slice();\n        // Check to see which handle is 'leading'.\n        // If that one can't move the second can't either.\n        if (upward) {\n            handleNumbers.reverse();\n        }\n        // Step 1: get the maximum percentage that any of the handles can move\n        if (handleNumbers.length > 1) {\n            handleNumbers.forEach(function (handleNumber, o) {\n                var to = checkHandlePosition(proposals, handleNumber, proposals[handleNumber] + proposal, b[o], f[o], false, smoothSteps);\n                // Stop if one of the handles can't move.\n                if (to === false) {\n                    proposal = 0;\n                }\n                else {\n                    proposal = to - proposals[handleNumber];\n                    proposals[handleNumber] = to;\n                }\n            });\n        }\n        // If using one handle, check backward AND forward\n        else {\n            b = f = [true];\n        }\n        var state = false;\n        // Step 2: Try to set the handles with the found percentage\n        handleNumbers.forEach(function (handleNumber, o) {\n            state =\n                setHandle(handleNumber, locations[handleNumber] + proposal, b[o], f[o], false, smoothSteps) || state;\n        });\n        // Step 3: If a handle moved, fire events\n        if (state) {\n            handleNumbers.forEach(function (handleNumber) {\n                fireEvent(\"update\", handleNumber);\n                fireEvent(\"slide\", handleNumber);\n            });\n            // If target is a connect, then fire drag event\n            if (connect != undefined) {\n                fireEvent(\"drag\", firstHandle);\n            }\n        }\n    }\n    // Takes a base value and an offset. This offset is used for the connect bar size.\n    // In the initial design for this feature, the origin element was 1% wide.\n    // Unfortunately, a rounding bug in Chrome makes it impossible to implement this feature\n    // in this manner: https://bugs.chromium.org/p/chromium/issues/detail?id=798223\n    function transformDirection(a, b) {\n        return options.dir ? 100 - a - b : a;\n    }\n    // Updates scope_Locations and scope_Values, updates visual state\n    function updateHandlePosition(handleNumber, to) {\n        // Update locations.\n        scope_Locations[handleNumber] = to;\n        // Convert the value to the slider stepping/range.\n        scope_Values[handleNumber] = scope_Spectrum.fromStepping(to);\n        var translation = transformDirection(to, 0) - scope_DirOffset;\n        var translateRule = \"translate(\" + inRuleOrder(translation + \"%\", \"0\") + \")\";\n        scope_Handles[handleNumber].style[options.transformRule] = translateRule;\n        updateConnect(handleNumber);\n        updateConnect(handleNumber + 1);\n    }\n    // Handles before the slider middle are stacked later = higher,\n    // Handles after the middle later is lower\n    // [[7] [8] .......... | .......... [5] [4]\n    function setZindex() {\n        scope_HandleNumbers.forEach(function (handleNumber) {\n            var dir = scope_Locations[handleNumber] > 50 ? -1 : 1;\n            var zIndex = 3 + (scope_Handles.length + dir * handleNumber);\n            scope_Handles[handleNumber].style.zIndex = String(zIndex);\n        });\n    }\n    // Test suggested values and apply margin, step.\n    // if exactInput is true, don't run checkHandlePosition, then the handle can be placed in between steps (#436)\n    function setHandle(handleNumber, to, lookBackward, lookForward, exactInput, smoothSteps) {\n        if (!exactInput) {\n            to = checkHandlePosition(scope_Locations, handleNumber, to, lookBackward, lookForward, false, smoothSteps);\n        }\n        if (to === false) {\n            return false;\n        }\n        updateHandlePosition(handleNumber, to);\n        return true;\n    }\n    // Updates style attribute for connect nodes\n    function updateConnect(index) {\n        // Skip connects set to false\n        if (!scope_Connects[index]) {\n            return;\n        }\n        var l = 0;\n        var h = 100;\n        if (index !== 0) {\n            l = scope_Locations[index - 1];\n        }\n        if (index !== scope_Connects.length - 1) {\n            h = scope_Locations[index];\n        }\n        // We use two rules:\n        // 'translate' to change the left/top offset;\n        // 'scale' to change the width of the element;\n        // As the element has a width of 100%, a translation of 100% is equal to 100% of the parent (.noUi-base)\n        var connectWidth = h - l;\n        var translateRule = \"translate(\" + inRuleOrder(transformDirection(l, connectWidth) + \"%\", \"0\") + \")\";\n        var scaleRule = \"scale(\" + inRuleOrder(connectWidth / 100, \"1\") + \")\";\n        scope_Connects[index].style[options.transformRule] =\n            translateRule + \" \" + scaleRule;\n    }\n    // Parses value passed to .set method. Returns current value if not parse-able.\n    function resolveToValue(to, handleNumber) {\n        // Setting with null indicates an 'ignore'.\n        // Inputting 'false' is invalid.\n        if (to === null || to === false || to === undefined) {\n            return scope_Locations[handleNumber];\n        }\n        // If a formatted number was passed, attempt to decode it.\n        if (typeof to === \"number\") {\n            to = String(to);\n        }\n        to = options.format.from(to);\n        if (to !== false) {\n            to = scope_Spectrum.toStepping(to);\n        }\n        // If parsing the number failed, use the current value.\n        if (to === false || isNaN(to)) {\n            return scope_Locations[handleNumber];\n        }\n        return to;\n    }\n    // Set the slider value.\n    function valueSet(input, fireSetEvent, exactInput) {\n        var values = asArray(input);\n        var isInit = scope_Locations[0] === undefined;\n        // Event fires by default\n        fireSetEvent = fireSetEvent === undefined ? true : fireSetEvent;\n        // Animation is optional.\n        // Make sure the initial values were set before using animated placement.\n        if (options.animate && !isInit) {\n            addClassFor(scope_Target, options.cssClasses.tap, options.animationDuration);\n        }\n        // First pass, without lookAhead but with lookBackward. Values are set from left to right.\n        scope_HandleNumbers.forEach(function (handleNumber) {\n            setHandle(handleNumber, resolveToValue(values[handleNumber], handleNumber), true, false, exactInput);\n        });\n        var i = scope_HandleNumbers.length === 1 ? 0 : 1;\n        // Spread handles evenly across the slider if the range has no size (min=max)\n        if (isInit && scope_Spectrum.hasNoSize()) {\n            exactInput = true;\n            scope_Locations[0] = 0;\n            if (scope_HandleNumbers.length > 1) {\n                var space_1 = 100 / (scope_HandleNumbers.length - 1);\n                scope_HandleNumbers.forEach(function (handleNumber) {\n                    scope_Locations[handleNumber] = handleNumber * space_1;\n                });\n            }\n        }\n        // Secondary passes. Now that all base values are set, apply constraints.\n        // Iterate all handles to ensure constraints are applied for the entire slider (Issue #1009)\n        for (; i < scope_HandleNumbers.length; ++i) {\n            scope_HandleNumbers.forEach(function (handleNumber) {\n                setHandle(handleNumber, scope_Locations[handleNumber], true, true, exactInput);\n            });\n        }\n        setZindex();\n        scope_HandleNumbers.forEach(function (handleNumber) {\n            fireEvent(\"update\", handleNumber);\n            // Fire the event only for handles that received a new value, as per #579\n            if (values[handleNumber] !== null && fireSetEvent) {\n                fireEvent(\"set\", handleNumber);\n            }\n        });\n    }\n    // Reset slider to initial values\n    function valueReset(fireSetEvent) {\n        valueSet(options.start, fireSetEvent);\n    }\n    // Set value for a single handle\n    function valueSetHandle(handleNumber, value, fireSetEvent, exactInput) {\n        // Ensure numeric input\n        handleNumber = Number(handleNumber);\n        if (!(handleNumber >= 0 && handleNumber < scope_HandleNumbers.length)) {\n            throw new Error(\"noUiSlider: invalid handle number, got: \" + handleNumber);\n        }\n        // Look both backward and forward, since we don't want this handle to \"push\" other handles (#960);\n        // The exactInput argument can be used to ignore slider stepping (#436)\n        setHandle(handleNumber, resolveToValue(value, handleNumber), true, true, exactInput);\n        fireEvent(\"update\", handleNumber);\n        if (fireSetEvent) {\n            fireEvent(\"set\", handleNumber);\n        }\n    }\n    // Get the slider value.\n    function valueGet(unencoded) {\n        if (unencoded === void 0) { unencoded = false; }\n        if (unencoded) {\n            // return a copy of the raw values\n            return scope_Values.length === 1 ? scope_Values[0] : scope_Values.slice(0);\n        }\n        var values = scope_Values.map(options.format.to);\n        // If only one handle is used, return a single value.\n        if (values.length === 1) {\n            return values[0];\n        }\n        return values;\n    }\n    // Removes classes from the root and empties it.\n    function destroy() {\n        // remove protected internal listeners\n        removeEvent(INTERNAL_EVENT_NS.aria);\n        removeEvent(INTERNAL_EVENT_NS.tooltips);\n        Object.keys(options.cssClasses).forEach(function (key) {\n            removeClass(scope_Target, options.cssClasses[key]);\n        });\n        while (scope_Target.firstChild) {\n            scope_Target.removeChild(scope_Target.firstChild);\n        }\n        delete scope_Target.noUiSlider;\n    }\n    function getNextStepsForHandle(handleNumber) {\n        var location = scope_Locations[handleNumber];\n        var nearbySteps = scope_Spectrum.getNearbySteps(location);\n        var value = scope_Values[handleNumber];\n        var increment = nearbySteps.thisStep.step;\n        var decrement = null;\n        // If snapped, directly use defined step value\n        if (options.snap) {\n            return [\n                value - nearbySteps.stepBefore.startValue || null,\n                nearbySteps.stepAfter.startValue - value || null,\n            ];\n        }\n        // If the next value in this step moves into the next step,\n        // the increment is the start of the next step - the current value\n        if (increment !== false) {\n            if (value + increment > nearbySteps.stepAfter.startValue) {\n                increment = nearbySteps.stepAfter.startValue - value;\n            }\n        }\n        // If the value is beyond the starting point\n        if (value > nearbySteps.thisStep.startValue) {\n            decrement = nearbySteps.thisStep.step;\n        }\n        else if (nearbySteps.stepBefore.step === false) {\n            decrement = false;\n        }\n        // If a handle is at the start of a step, it always steps back into the previous step first\n        else {\n            decrement = value - nearbySteps.stepBefore.highestStep;\n        }\n        // Now, if at the slider edges, there is no in/decrement\n        if (location === 100) {\n            increment = null;\n        }\n        else if (location === 0) {\n            decrement = null;\n        }\n        // As per #391, the comparison for the decrement step can have some rounding issues.\n        var stepDecimals = scope_Spectrum.countStepDecimals();\n        // Round per #391\n        if (increment !== null && increment !== false) {\n            increment = Number(increment.toFixed(stepDecimals));\n        }\n        if (decrement !== null && decrement !== false) {\n            decrement = Number(decrement.toFixed(stepDecimals));\n        }\n        return [decrement, increment];\n    }\n    // Get the current step size for the slider.\n    function getNextSteps() {\n        return scope_HandleNumbers.map(getNextStepsForHandle);\n    }\n    // Updatable: margin, limit, padding, step, range, animate, snap\n    function updateOptions(optionsToUpdate, fireSetEvent) {\n        // Spectrum is created using the range, snap, direction and step options.\n        // 'snap' and 'step' can be updated.\n        // If 'snap' and 'step' are not passed, they should remain unchanged.\n        var v = valueGet();\n        var updateAble = [\n            \"margin\",\n            \"limit\",\n            \"padding\",\n            \"range\",\n            \"animate\",\n            \"snap\",\n            \"step\",\n            \"format\",\n            \"pips\",\n            \"tooltips\",\n        ];\n        // Only change options that we're actually passed to update.\n        updateAble.forEach(function (name) {\n            // Check for undefined. null removes the value.\n            if (optionsToUpdate[name] !== undefined) {\n                originalOptions[name] = optionsToUpdate[name];\n            }\n        });\n        var newOptions = testOptions(originalOptions);\n        // Load new options into the slider state\n        updateAble.forEach(function (name) {\n            if (optionsToUpdate[name] !== undefined) {\n                options[name] = newOptions[name];\n            }\n        });\n        scope_Spectrum = newOptions.spectrum;\n        // Limit, margin and padding depend on the spectrum but are stored outside of it. (#677)\n        options.margin = newOptions.margin;\n        options.limit = newOptions.limit;\n        options.padding = newOptions.padding;\n        // Update pips, removes existing.\n        if (options.pips) {\n            pips(options.pips);\n        }\n        else {\n            removePips();\n        }\n        // Update tooltips, removes existing.\n        if (options.tooltips) {\n            tooltips();\n        }\n        else {\n            removeTooltips();\n        }\n        // Invalidate the current positioning so valueSet forces an update.\n        scope_Locations = [];\n        valueSet(isSet(optionsToUpdate.start) ? optionsToUpdate.start : v, fireSetEvent);\n    }\n    // Initialization steps\n    function setupSlider() {\n        // Create the base element, initialize HTML and set classes.\n        // Add handles and connect elements.\n        scope_Base = addSlider(scope_Target);\n        addElements(options.connect, scope_Base);\n        // Attach user events.\n        bindSliderEvents(options.events);\n        // Use the public value method to set the start values.\n        valueSet(options.start);\n        if (options.pips) {\n            pips(options.pips);\n        }\n        if (options.tooltips) {\n            tooltips();\n        }\n        aria();\n    }\n    setupSlider();\n    var scope_Self = {\n        destroy: destroy,\n        steps: getNextSteps,\n        on: bindEvent,\n        off: removeEvent,\n        get: valueGet,\n        set: valueSet,\n        setHandle: valueSetHandle,\n        reset: valueReset,\n        disable: disable,\n        enable: enable,\n        // Exposed for unit testing, don't use this in your application.\n        __moveHandles: function (upward, proposal, handleNumbers) {\n            moveHandles(upward, proposal, scope_Locations, handleNumbers);\n        },\n        options: originalOptions,\n        updateOptions: updateOptions,\n        target: scope_Target,\n        removePips: removePips,\n        removeTooltips: removeTooltips,\n        getPositions: function () {\n            return scope_Locations.slice();\n        },\n        getTooltips: function () {\n            return scope_Tooltips;\n        },\n        getOrigins: function () {\n            return scope_Handles;\n        },\n        pips: pips, // Issue #594\n    };\n    return scope_Self;\n}\n// Run the standard initializer\nfunction initialize(target, originalOptions) {\n    if (!target || !target.nodeName) {\n        throw new Error(\"noUiSlider: create requires a single element, got: \" + target);\n    }\n    // Throw an error if the slider was already initialized.\n    if (target.noUiSlider) {\n        throw new Error(\"noUiSlider: Slider was already initialized.\");\n    }\n    // Test the options and create the slider environment;\n    var options = testOptions(originalOptions);\n    var api = scope(target, options, originalOptions);\n    target.noUiSlider = api;\n    return api;\n}\nexport { initialize as create };\nexport { cssClasses };\nexport default {\n    // Exposed for unit testing, don't use this in your application.\n    __spectrum: Spectrum,\n    // A reference to the default classes, allows global changes.\n    // Use the cssClasses option for changes to one slider.\n    cssClasses: cssClasses,\n    create: initialize,\n};\n", "import {\r\n\tgetBrowser,\r\n\tgetBrowserTab,\r\n\tgetEquipmentTabData,\r\n\tgetFlag,\r\n\trender,\r\n\tsetFlag,\r\n\tsubLocalize,\r\n\ttemplatePath,\r\n} from \"module-api\";\r\nimport noUiSlider from \"nouislider\";\r\nimport {\r\n\tPRICE_RATIO,\r\n\tclampPriceRatio,\r\n\tclampPurse,\r\n\tgetBuyAll,\r\n} from \"../../features/merchant\";\r\n\r\nconst localize = subLocalize(\"merchant.buy\");\r\n\r\nexport class BuyItems extends Application {\r\n\tconstructor(actor, options = {}) {\r\n\t\tsuper(options);\r\n\r\n\t\tthis.actor = actor;\r\n\r\n\t\tthis.defaultData = getEquipmentTabData({ collapsed: true });\r\n\t\tthis.defaultData.name = \"\";\r\n\r\n\t\tthis.editing = null;\r\n\r\n\t\tthis.tabs = {\r\n\t\t\tequipment: {\r\n\t\t\t\tfilterData: deepClone(this.defaultData),\r\n\t\t\t\tisOfType: (...types) => {\r\n\t\t\t\t\treturn types.includes(\"equipment\");\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tthis.activeTab = \"equipment\";\r\n\r\n\t\tthis.navigationTab = {\r\n\t\t\tactive: \"equipment\",\r\n\t\t};\r\n\r\n\t\tthis.expanded = {};\r\n\t}\r\n\r\n\tget id() {\r\n\t\treturn `pf2e-toolbelt-buy-${this.actor.id}`;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.actor);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"merchant/buy\");\r\n\t}\r\n\r\n\tget tab() {\r\n\t\treturn this.tabs.equipment;\r\n\t}\r\n\r\n\tget filters() {\r\n\t\treturn getFlag(this.actor, \"merchant.filters\") ?? [];\r\n\t}\r\n\r\n\tasync setFilters(filters, reset = false) {\r\n\t\tif (reset) this.resetFilters();\r\n\t\tawait setFlag(this.actor, \"merchant.filters\", filters);\r\n\t\tthis.render();\r\n\t}\r\n\r\n\trender(force, options) {\r\n\t\tthis.actor.apps[this.appId] = this;\r\n\t\treturn super.render(force, options);\r\n\t}\r\n\r\n\tasync close(options) {\r\n\t\tawait super.close(options);\r\n\t\tdelete this.actor.apps?.[this.appId];\r\n\t}\r\n\r\n\tasync getData(options) {\r\n\t\tconst filters = this.filters;\r\n\t\tconst defaultRatio = getFlag(this.actor, \"merchant.buyRatio\");\r\n\t\tconst defaultPurse = getFlag(this.actor, \"merchant.buyPurse\");\r\n\r\n\t\tconst formatPurse = (value) => {\r\n\t\t\tconst clamped = clampPurse(value);\r\n\t\t\treturn clamped < 0 ? \"\" : Math.floor(clamped);\r\n\t\t};\r\n\r\n\t\tconst getSummary = (filter) => {\r\n\t\t\tconst summary = [];\r\n\r\n\t\t\tconst getDefaultData = (category, type) => {\r\n\t\t\t\tconst defaultData = this.defaultData[category][type];\r\n\t\t\t\treturn {\r\n\t\t\t\t\tdefaultData,\r\n\t\t\t\t\ttitle: game.i18n.localize(defaultData.label),\r\n\t\t\t\t};\r\n\t\t\t};\r\n\r\n\t\t\tconst checkboxes = Object.entries(filter.checkboxes ?? {});\r\n\t\t\tfor (const [type, { selected }] of checkboxes) {\r\n\t\t\t\tconst { title, defaultData } = getDefaultData(\"checkboxes\", type);\r\n\t\t\t\tconst row = selected\r\n\t\t\t\t\t.map((entry) => defaultData.options[entry].label)\r\n\t\t\t\t\t.join(\", \");\r\n\t\t\t\tsummary.push({ title, row });\r\n\t\t\t}\r\n\r\n\t\t\tconst multiselects = Object.entries(filter.multiselects ?? {});\r\n\t\t\tfor (const [type, { selected, conjunction }] of multiselects) {\r\n\t\t\t\tconst { title } = getDefaultData(\"multiselects\", type);\r\n\t\t\t\tconst row = selected\r\n\t\t\t\t\t.map(({ label, not }) => {\r\n\t\t\t\t\t\tif (not) return `<s>${label}</s>`;\r\n\t\t\t\t\t\treturn label;\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.join(\", \");\r\n\t\t\t\tsummary.push({ title: `${title} (${conjunction})`, row });\r\n\t\t\t}\r\n\r\n\t\t\tfor (const category of [\"ranges\", \"sliders\"]) {\r\n\t\t\t\tconst entries = Object.entries(filter[category] ?? {});\r\n\t\t\t\tfor (const [type, { values }] of entries) {\r\n\t\t\t\t\tconst { title } = getDefaultData(category, type);\r\n\t\t\t\t\tconst min = values.inputMin ?? values.min;\r\n\t\t\t\t\tconst max = values.inputMax ?? values.max;\r\n\t\t\t\t\tconst row = `${min} - ${max}`;\r\n\t\t\t\t\tsummary.push({ title, row });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn summary\r\n\t\t\t\t.map(({ title, row }) => `<div><strong>${title}: </strong>${row}</div>`)\r\n\t\t\t\t.join(\"\");\r\n\t\t};\r\n\r\n\t\treturn {\r\n\t\t\t...this.tabs.equipment,\r\n\t\t\t...localize.i18n,\r\n\t\t\tfilters: filters.map((filter) => ({\r\n\t\t\t\t...filter,\r\n\t\t\t\tsummary: getSummary(filter),\r\n\t\t\t\texpanded: this.expanded[filter.id],\r\n\t\t\t\tname: this.getFilterName(filter),\r\n\t\t\t\tpurse: formatPurse(filter.purse),\r\n\t\t\t\tpriceRatio: clampPriceRatio(\"buy\", filter.priceRatio),\r\n\t\t\t})),\r\n\t\t\tdefaultFilter: {\r\n\t\t\t\tid: \"\",\r\n\t\t\t\tname: localize(\"default.label\"),\r\n\t\t\t\tpurse: formatPurse(defaultPurse),\r\n\t\t\t\tpriceRatio: clampPriceRatio(\"buy\", defaultRatio),\r\n\t\t\t\tbuyAll: getBuyAll(this.actor),\r\n\t\t\t},\r\n\t\t\tpriceRatio: PRICE_RATIO,\r\n\t\t};\r\n\t}\r\n\r\n\tasync activateListeners(html) {\r\n\t\tconst filterData = this.tab.filterData;\r\n\r\n\t\tconst controlArea = html.find(\".control-area\");\r\n\t\tcontrolArea.find(\"[id]\").removeAttr(\"id\");\r\n\t\tcontrolArea.find(\"[data-filter-name='source']\").remove();\r\n\r\n\t\tconst sortcontainer = controlArea.find(\".sortcontainer\");\r\n\t\tsortcontainer.children().remove();\r\n\r\n\t\tconst extra = await render(\"merchant/extra\", {\r\n\t\t\tvalue: filterData.name,\r\n\t\t\tediting: this.editing,\r\n\t\t\t...localize.i18n,\r\n\t\t});\r\n\r\n\t\tsortcontainer.append(extra);\r\n\r\n\t\tsortcontainer.find(\"[name=filter-name]\").on(\"change\", (event) => {\r\n\t\t\tfilterData.name = event.currentTarget.value.trim();\r\n\t\t});\r\n\r\n\t\tsortcontainer.find(\"button\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\r\n\t\t\tconst { action } = event.currentTarget.dataset;\r\n\r\n\t\t\tswitch (action) {\r\n\t\t\t\tcase \"reset-filter\":\r\n\t\t\t\t\tthis.resetFilters();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"save-filter\":\r\n\t\t\t\t\tthis.saveFilter();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst filtercontainers = controlArea.find(\r\n\t\t\t\".filtercontainer:not([data-filter-type=multiselects])\",\r\n\t\t);\r\n\t\tfor (const container of filtercontainers) {\r\n\t\t\tconst { filterType, filterName } = container.dataset;\r\n\t\t\tconst data = filterData[filterType][filterName];\r\n\r\n\t\t\tconst title = container.querySelector(\".title\");\r\n\t\t\ttitle.querySelector(\"button\")?.remove();\r\n\r\n\t\t\tconst content = title.nextElementSibling;\r\n\t\t\ttitle.addEventListener(\"click\", () => {\r\n\t\t\t\tcontent.style.display = data.isExpanded ? \"none\" : \"\";\r\n\t\t\t\tdata.isExpanded = !data.isExpanded;\r\n\t\t\t});\r\n\t\t\tcontent.style.display = data.isExpanded ? \"\" : \"none\";\r\n\r\n\t\t\tcontainer.setAttribute(\"data-buy-filter-type\", filterType);\r\n\t\t\tcontainer.setAttribute(\"data-buy-filter-name\", filterName);\r\n\r\n\t\t\tcontainer.removeAttribute(\"data-filter-type\");\r\n\t\t\tcontainer.removeAttribute(\"data-filter-name\");\r\n\r\n\t\t\tif (filterType === \"sliders\") {\r\n\t\t\t\tconst sliderElement = content.querySelector(\"[class^=slider-]\");\r\n\t\t\t\tconst slider = noUiSlider.create(sliderElement, {\r\n\t\t\t\t\trange: {\r\n\t\t\t\t\t\tmin: data.values.lowerLimit,\r\n\t\t\t\t\t\tmax: data.values.upperLimit,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tstart: [data.values.min, data.values.max],\r\n\t\t\t\t\ttooltips: {\r\n\t\t\t\t\t\tto(value) {\r\n\t\t\t\t\t\t\treturn Math.floor(value).toString();\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t\tconnect: [false, true, false],\r\n\t\t\t\t\tbehaviour: \"snap\",\r\n\t\t\t\t\tstep: data.values.step,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tconst minLabel = sliderElement.previousElementSibling;\r\n\t\t\t\tconst maxLabel = sliderElement.nextElementSibling;\r\n\r\n\t\t\t\tslider.on(\"change\", (values) => {\r\n\t\t\t\t\tconst [min, max] = values.map((value) => Number(value));\r\n\r\n\t\t\t\t\tdata.values.min = min;\r\n\t\t\t\t\tdata.values.max = max;\r\n\r\n\t\t\t\t\tminLabel.textContent = min;\r\n\t\t\t\t\tmaxLabel.textContent = max;\r\n\t\t\t\t});\r\n\t\t\t} else if (filterType === \"ranges\") {\r\n\t\t\t\tconst lowerEl = content.querySelector(\"input[name^=lowerBound]\");\r\n\t\t\t\tconst upperEl = content.querySelector(\"input[name^=upperBound]\");\r\n\t\t\t\tfor (const range of [lowerEl, upperEl]) {\r\n\t\t\t\t\trange.addEventListener(\"change\", () => {\r\n\t\t\t\t\t\tconst lowerBound = lowerEl.value ?? \"\";\r\n\t\t\t\t\t\tconst upperBound = upperEl.value ?? \"\";\r\n\t\t\t\t\t\tconst values = this.parseRangeFilterInput(\r\n\t\t\t\t\t\t\tfilterName,\r\n\t\t\t\t\t\t\tlowerBound,\r\n\t\t\t\t\t\t\tupperBound,\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tdata.values = values;\r\n\t\t\t\t\t\tdata.changed = true;\r\n\t\t\t\t\t\tlowerEl.value = values.inputMin;\r\n\t\t\t\t\t\tupperEl.value = values.inputMax;\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else if (filterType === \"checkboxes\") {\r\n\t\t\t\tconst checkboxes = container.querySelectorAll(\"input[type=checkbox]\");\r\n\t\t\t\tfor (const checkboxElement of checkboxes) {\r\n\t\t\t\t\tcheckboxElement.addEventListener(\"click\", () => {\r\n\t\t\t\t\t\tconst optionName = checkboxElement.name;\r\n\t\t\t\t\t\tconst option = data.options[optionName];\r\n\t\t\t\t\t\toption.selected = !option.selected;\r\n\t\t\t\t\t\tif (option.selected) {\r\n\t\t\t\t\t\t\tdata.selected.push(optionName);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tdata.selected = data.selected.filter(\r\n\t\t\t\t\t\t\t\t(name) => name !== optionName,\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtml\r\n\t\t\t.find(\"input[type=text], input[type=search], input[type=number]\")\r\n\t\t\t.on(\"keyup\", (event) => {\r\n\t\t\t\tif (event.key !== \"Enter\") return;\r\n\t\t\t\tevent.currentTarget.blur();\r\n\t\t\t});\r\n\r\n\t\tgetBrowser().activateListeners.call(this, html);\r\n\r\n\t\tconst filterElements = html.find(\".filters .filter\");\r\n\r\n\t\tconst getFilterId = (event) => {\r\n\t\t\tconst filterElement = event.currentTarget.closest(\"[data-filter-id]\");\r\n\t\t\treturn {\r\n\t\t\t\tfilterElement,\r\n\t\t\t\tfilterId: filterElement.dataset.filterId,\r\n\t\t\t};\r\n\t\t};\r\n\r\n\t\tfilterElements.find(\"[data-action]\").on(\"click\", (event) => {\r\n\t\t\tevent.preventDefault();\r\n\r\n\t\t\tconst { filterId, filterElement } = getFilterId(event);\r\n\t\t\tconst { direction, action } = event.currentTarget.dataset;\r\n\r\n\t\t\tswitch (action) {\r\n\t\t\t\tcase \"delete-filter\":\r\n\t\t\t\t\tthis.deleteFilter(filterId);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"move-filter\":\r\n\t\t\t\t\tthis.moveFilterPosition(filterId, direction);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"edit-filter\":\r\n\t\t\t\t\tthis.editFilter(filterId);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"toggle-summary\":\r\n\t\t\t\t\tthis.toggleFilterSummary(filterElement, filterId);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst setFilterValue = (filterId, key, value) => {\r\n\t\t\tif (!filterId) {\r\n\t\t\t\tsetFlag(this.actor, `merchant.${key}`, value);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst filters = this.filters.slice();\r\n\t\t\tconst filter = filters.find((f) => f.id === filterId);\r\n\t\t\tif (!filter) return;\r\n\r\n\t\t\tfilter[key] = value;\r\n\t\t\tthis.setFilters(filters);\r\n\t\t};\r\n\r\n\t\tfilterElements.find(\"[name=price-ratio]\").on(\"change\", (event) => {\r\n\t\t\tconst { filterId } = getFilterId(event);\r\n\t\t\tconst value = event.currentTarget.valueAsNumber;\r\n\t\t\tconst ratio = clampPriceRatio(\"buy\", value);\r\n\t\t\tsetFilterValue(filterId, filterId ? \"priceRatio\" : \"buyRatio\", ratio);\r\n\t\t});\r\n\r\n\t\tfilterElements.find(\"[name=purse]\").on(\"change\", (event) => {\r\n\t\t\tconst { filterId } = getFilterId(event);\r\n\t\t\tconst value = event.currentTarget.value;\r\n\t\t\tconst purse = clampPurse(value);\r\n\t\t\tsetFilterValue(filterId, filterId ? \"purse\" : \"buyPurse\", purse);\r\n\t\t});\r\n\r\n\t\tfilterElements.find(\"[name=buy-all]\").on(\"change\", (event) => {\r\n\t\t\tconst value = event.currentTarget.checked;\r\n\t\t\tsetFlag(this.actor, \"merchant.buyAll\", value);\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleFilterSummary(filterElement, filterId) {\r\n\t\tconst isExpanded = this.expanded[filterId];\r\n\t\tthis.expanded[filterId] = !isExpanded;\r\n\t\tfilterElement.classList.toggle(\"expanded\", !isExpanded);\r\n\t}\r\n\r\n\teditFilter(filterId) {\r\n\t\tconst filter = this.filters.find((f) => f.id === filterId);\r\n\t\tif (!filter) return;\r\n\r\n\t\tconst filterData = getEquipmentTabData({\r\n\t\t\tcollapsed: true,\r\n\t\t\tmergeWith: deepClone(filter),\r\n\t\t});\r\n\r\n\t\tthis.tab.filterData = filterData;\r\n\t\tthis.editing = filterId;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tdeleteFilter(filterId, skipConfirm = false) {\r\n\t\tconst filters = this.filters.slice();\r\n\t\tconst index = filters.findIndex((f) => f.id === filterId);\r\n\t\tif (index === -1) return;\r\n\r\n\t\tconst deleteIt = () => {\r\n\t\t\tfilters.splice(index, 1);\r\n\t\t\tthis.setFilters(filters, this.editing === filterId);\r\n\t\t};\r\n\r\n\t\tif (skipConfirm) {\r\n\t\t\tdeleteIt();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tDialog.confirm({\r\n\t\t\ttitle: localize(\"delete.title\"),\r\n\t\t\tcontent: localize(\"delete.content\", {\r\n\t\t\t\tname: filters[index].name,\r\n\t\t\t}),\r\n\t\t\tyes: () => {\r\n\t\t\t\tconst index = filters.findIndex((f) => f.id === filterId);\r\n\t\t\t\tif (index !== -1) deleteIt();\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tmoveFilterPosition(filterId, direction) {\r\n\t\tconst filters = this.filters.slice();\r\n\t\tif (filters.length < 2) return;\r\n\r\n\t\tconst index = filters.findIndex((f) => f.id === filterId);\r\n\t\tif (index === -1) return;\r\n\r\n\t\tif (direction === \"up\" && index === 0) return;\r\n\t\tif (direction === \"down\" && index === filters.length - 1) return;\r\n\r\n\t\tconst newIndex = direction === \"down\" ? index + 1 : index - 1;\r\n\t\tconst filter = filters.splice(index, 1)[0];\r\n\t\tfilters.splice(newIndex, 0, filter);\r\n\r\n\t\tthis.setFilters(filters);\r\n\t}\r\n\r\n\tparseRangeFilterInput(name, lowerRange, upperRange) {\r\n\t\tconst tab = getBrowserTab(\"equipment\");\r\n\r\n\t\tconst defaultRange = this.defaultData.ranges[name].values;\r\n\t\tconst lower = lowerRange.trim() || defaultRange.inputMin;\r\n\t\tconst upper = upperRange.trim() || defaultRange.inputMax;\r\n\r\n\t\tconst values = tab.parseRangeFilterInput(name, lower, upper);\r\n\t\tif (values.max < values.min) {\r\n\t\t\tvalues.max = values.min;\r\n\t\t\tvalues.inputMax = values.inputMin;\r\n\t\t}\r\n\r\n\t\treturn values;\r\n\t}\r\n\r\n\tresetFilters() {\r\n\t\tthis.editing = null;\r\n\t\tthis.tab.filterData = deepClone(this.defaultData);\r\n\t\tthis.render(false, { force: true });\r\n\t}\r\n\r\n\tstatic compareItemWithFilter(item, filterData) {\r\n\t\tconst tab = getBrowserTab(\"equipment\");\r\n\t\tconst {\r\n\t\t\tcheckboxes = {},\r\n\t\t\tmultiselects = {},\r\n\t\t\tranges = {},\r\n\t\t\tsliders = {},\r\n\t\t} = filterData;\r\n\r\n\t\t// Level\r\n\t\tif (\r\n\t\t\tsliders.level &&\r\n\t\t\t(item.level < sliders.level.values.min ||\r\n\t\t\t\titem.level > sliders.level.values.max)\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Price\r\n\t\tif (\r\n\t\t\tranges.price &&\r\n\t\t\t(item.priceInCopper < ranges.price.values.min ||\r\n\t\t\t\titem.priceInCopper > ranges.price.values.max)\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Item type\r\n\t\tif (\r\n\t\t\tcheckboxes.itemTypes?.selected.length > 0 &&\r\n\t\t\t!checkboxes.itemTypes.selected.includes(item.type)\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Armor\r\n\t\tif (\r\n\t\t\tcheckboxes.armorTypes?.selected.length > 0 &&\r\n\t\t\t!tab.arrayIncludes(checkboxes.armorTypes.selected, [\r\n\t\t\t\titem.category,\r\n\t\t\t\titem.group,\r\n\t\t\t])\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Weapon categories\r\n\t\tif (\r\n\t\t\tcheckboxes.weaponTypes?.selected.length > 0 &&\r\n\t\t\t!tab.arrayIncludes(checkboxes.weaponTypes.selected, [\r\n\t\t\t\titem.category,\r\n\t\t\t\titem.group,\r\n\t\t\t])\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Traits\r\n\t\tif (\r\n\t\t\tmultiselects.traits &&\r\n\t\t\t!tab.filterTraits(\r\n\t\t\t\t[...item.traits],\r\n\t\t\t\tmultiselects.traits.selected,\r\n\t\t\t\tmultiselects.traits.conjunction,\r\n\t\t\t)\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Source\r\n\t\tif (\r\n\t\t\tcheckboxes.source?.selected.length > 0 &&\r\n\t\t\t!checkboxes.source.selected.includes(item.source)\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Rarity\r\n\t\tif (\r\n\t\t\tcheckboxes.rarity?.selected.length > 0 &&\r\n\t\t\t!checkboxes.rarity.selected.includes(item.rarity)\r\n\t\t) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\tgetFilterName(filter) {\r\n\t\treturn filter.name || `filter-${filter.id}`;\r\n\t}\r\n\r\n\textractFilterData() {\r\n\t\tconst defaultData = this.defaultData;\r\n\t\tconst filterData = this.tab.filterData;\r\n\t\tconst extractedData = {};\r\n\r\n\t\tfor (const type of [\"checkboxes\", \"multiselects\"]) {\r\n\t\t\tfor (const [category, data] of Object.entries(filterData[type])) {\r\n\t\t\t\tif (!data.selected.length) continue;\r\n\r\n\t\t\t\tconst path = `${type}.${category}`;\r\n\t\t\t\tsetProperty(extractedData, `${path}.selected`, data.selected);\r\n\t\t\t\tif (type === \"multiselects\") {\r\n\t\t\t\t\tsetProperty(extractedData, `${path}.conjunction`, data.conjunction);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const type of [\"ranges\", \"sliders\"]) {\r\n\t\t\tconst defaultType = defaultData[type];\r\n\r\n\t\t\tfor (const [category, data] of Object.entries(filterData[type])) {\r\n\t\t\t\tconst defaultCategory = defaultType[category];\r\n\t\t\t\tif (objectsEqual(data.values, defaultCategory.values)) continue;\r\n\t\t\t\tsetProperty(extractedData, `${type}.${category}.values`, data.values);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (isEmpty(extractedData)) return;\r\n\r\n\t\textractedData.name = filterData.name.trim();\r\n\t\textractedData.id = filterData.id ?? randomID();\r\n\t\textractedData.priceRatio = filterData.priceRatio;\r\n\t\textractedData.purse = filterData.purse;\r\n\r\n\t\treturn extractedData;\r\n\t}\r\n\r\n\tsaveFilter() {\r\n\t\tconst filter = this.extractFilterData();\r\n\t\tif (!filter) {\r\n\t\t\tlocalize.warn(\"empty\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst allFilters = this.filters.slice();\r\n\r\n\t\tif (this.editing) {\r\n\t\t\tconst index = allFilters.findIndex((x) => x.id === this.editing);\r\n\t\t\tif (index === -1) return;\r\n\t\t\tallFilters[index] = filter;\r\n\t\t} else {\r\n\t\t\tallFilters.push(filter);\r\n\t\t}\r\n\r\n\t\tlocalize.info(this.editing ? \"saved\" : \"created\", {\r\n\t\t\tname: this.getFilterName(filter),\r\n\t\t});\r\n\t\tthis.setFilters(allFilters, true);\r\n\t}\r\n}\r\n", "import {\r\n\tErrorPF2e,\r\n\tcalculateItemPrice,\r\n\tcreateFancyLink,\r\n\tcreateTradeMessage,\r\n\tdeleteInMemory,\r\n\tflagPath,\r\n\tgetBrowser,\r\n\tgetBrowserTab,\r\n\tgetFlag,\r\n\tgetHighestName,\r\n\tgetInMemory,\r\n\tgetInMemoryAndSetIfNot,\r\n\tgetSetting,\r\n\topenBrowserTab,\r\n\tregisterWrapper,\r\n\trender,\r\n\tsetFlag,\r\n\tsetInMemory,\r\n\tsubLocalize,\r\n\ttransferItemToActor,\r\n} from \"module-api\";\r\nimport { BuyItems } from \"../apps/merchant/buy\";\r\nimport { wrapperError } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nconst localize = subLocalize(\"merchant\");\r\n\r\nconst ITEM_PREPARE_DERIVED_DATA =\r\n\t\"CONFIG.Item.documentClass.prototype.prepareDerivedData\";\r\nconst LOOT_TRANSFER_ITEM_TO_ACTOR =\r\n\t\"CONFIG.PF2E.Actor.documentClasses.loot.prototype.transferItemToActor\";\r\nconst ACTOR_TRANSFER_ITEM_TO_ACTOR =\r\n\t\"CONFIG.Actor.documentClass.prototype.transferItemToActor\";\r\nconst BROWSER_CLOSE = \"game.pf2e.compendiumBrowser.constructor.prototype.close\";\r\nconst BROWSER_INNER_RENDER =\r\n\t\"game.pf2e.compendiumBrowser.constructor.prototype._renderInner\";\r\nconst BROWSER_ACTIVE_LISTENERS =\r\n\t\"game.pf2e.compendiumBrowser.constructor.prototype.activateListeners\";\r\nconst BROWSER_RENDER_RESULTS =\r\n\t\"game.pf2e.compendiumBrowser.tabs.equipment.constructor.prototype.renderResults\";\r\n\r\nconst PULL_LIMIT = 100;\r\n\r\nexport const PRICE_RATIO = {\r\n\tmin: 0.1,\r\n\tmax: 5,\r\n\tstep: 0.1,\r\n\tbuy: 0.5,\r\n\tsell: 1,\r\n};\r\n\r\nexport const merchantOptions = {\r\n\tname: \"merchant\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"merchant\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\trequiresReload: true,\r\n\t\t},\r\n\t],\r\n\tsocket: onSocket,\r\n\tinit: (isGM) => {\r\n\t\tif (!getSetting(\"merchant\")) return;\r\n\r\n\t\tif (isGM) {\r\n\t\t\tsocket.activate();\r\n\t\t\tHooks.on(\"renderLootSheetPF2e\", renderLootSheetPF2e);\r\n\t\t}\r\n\r\n\t\tregisterWrapper(\r\n\t\t\tITEM_PREPARE_DERIVED_DATA,\r\n\t\t\titemPrepareDerivedData,\r\n\t\t\t\"WRAPPER\",\r\n\t\t);\r\n\t\tregisterWrapper(\r\n\t\t\tLOOT_TRANSFER_ITEM_TO_ACTOR,\r\n\t\t\tlootTranferItemToActor,\r\n\t\t\t\"OVERRIDE\",\r\n\t\t);\r\n\t\tregisterWrapper(\r\n\t\t\tACTOR_TRANSFER_ITEM_TO_ACTOR,\r\n\t\t\tactorTranferItemToActor,\r\n\t\t\t\"MIXED\",\r\n\t\t);\r\n\t},\r\n\tready: (isGM) => {\r\n\t\tif (!isGM || !getSetting(\"merchant\")) return;\r\n\t\tregisterWrapper(BROWSER_CLOSE, browserClose);\r\n\t\tregisterWrapper(BROWSER_INNER_RENDER, browserInnerRender);\r\n\t\tregisterWrapper(BROWSER_RENDER_RESULTS, browserRenderResults);\r\n\t\tregisterWrapper(BROWSER_ACTIVE_LISTENERS, browserActiveListeners);\r\n\t},\r\n};\r\n\r\nconst { socket } = createTool(merchantOptions);\r\n\r\nfunction onSocket(packet, userId) {\r\n\tswitch (packet.type) {\r\n\t\tcase \"buy-deal\":\r\n\t\t\tmakeBuyDeal(packet, userId);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nasync function browserClose(wrapped, options) {\r\n\tdeleteInMemory(this, \"merchant\");\r\n\tawait wrapped(options);\r\n}\r\n\r\nasync function browserInnerRender(wrapped, data) {\r\n\tconst inner = await wrapped(data);\r\n\tconst actor = getInMemory(this, \"merchant.actor\");\r\n\tif (!actor) return inner;\r\n\r\n\tdeleteInMemory(this, \"merchant.selection\");\r\n\r\n\tsetInMemory(\r\n\t\tthis,\r\n\t\t\"merchant.owned\",\r\n\t\tactor.inventory.map((x) => x.sourceId),\r\n\t);\r\n\r\n\tinner.addClass(\"toolbelt-merchant\");\r\n\r\n\tconst tabElement = inner.find(\".content .tab[data-tab=equipment]\");\r\n\r\n\tconst controlArea = tabElement.find(\".control-area\");\r\n\tcontrolArea.prepend(`<h2>${actor.name}</h2>`);\r\n\tcontrolArea.find(\"input[name=textFilter]\").remove();\r\n\r\n\tconst footer = tabElement.find(\".list-buttons\");\r\n\tfooter.find(\"button\").remove();\r\n\r\n\tconst selected = localize(\"browser.selected\");\r\n\tfooter.append(`<div>${selected}: <span>0</span>/<span>0</span></div>`);\r\n\r\n\tconst btn = localize(\"browser.add\");\r\n\tfooter.append(`<button type='button'>${btn}</button>`);\r\n\r\n\tconst all = localize(\"browser.all\");\r\n\tfooter.append(`<label>${all} <input type='checkbox'></button></label>`);\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction updateBrowser(selection, skipAll = false) {\r\n\tconst browserApp = document.getElementById(\"compendium-browser\");\r\n\tif (!browserApp) return;\r\n\r\n\tconst browserTab = browserApp.querySelector(\r\n\t\t\".content-box.toolbelt-merchant .content .tab[data-tab=equipment]\",\r\n\t);\r\n\tconst footer = browserTab.querySelector(\".list-buttons\");\r\n\r\n\tconst tab = getBrowserTab(\"equipment\");\r\n\tconst selected = selection.length;\r\n\tconst total = tab.currentIndex.length;\r\n\r\n\tconst numbers = footer.querySelectorAll(\":scope > div span\");\r\n\tif (numbers.length) {\r\n\t\tnumbers[0].textContent = selected;\r\n\t\tnumbers[1].textContent = total;\r\n\t}\r\n\r\n\tconst isAtLimit = selected >= PULL_LIMIT;\r\n\r\n\tif (!skipAll) {\r\n\t\tconst checkbox = footer.querySelector(\":scope > label input\");\r\n\t\tif (checkbox) {\r\n\t\t\tif (selected === 0) {\r\n\t\t\t\tcheckbox.indeterminate = false;\r\n\t\t\t\tcheckbox.checked = false;\r\n\t\t\t} else if (isAtLimit || selected >= total) {\r\n\t\t\t\tcheckbox.indeterminate = false;\r\n\t\t\t\tcheckbox.checked = true;\r\n\t\t\t} else {\r\n\t\t\t\tcheckbox.indeterminate = true;\r\n\t\t\t\tcheckbox.checked = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfooter.querySelector(\"button\").disabled = selected === 0;\r\n\r\n\tconst reachedLimit = localize(\"browser.limit\");\r\n\tconst checkboxes = browserTab.querySelectorAll(\".result-list .item input\");\r\n\tfor (const checkbox of checkboxes) {\r\n\t\tconst checked = checkbox.checked;\r\n\t\tconst disabled = !checked && isAtLimit;\r\n\r\n\t\tcheckbox.disabled = disabled;\r\n\t\tcheckbox.dataset.tooltip = disabled ? reachedLimit : \"\";\r\n\t}\r\n}\r\n\r\nfunction fillSelection(\r\n\ttab,\r\n\tselection,\r\n\towned = getInMemory(tab.browser, \"merchant.owned\"),\r\n) {\r\n\tselection.length = 0;\r\n\tfor (const { uuid } of tab.currentIndex) {\r\n\t\tif (owned.includes(uuid)) continue;\r\n\t\tselection.push(uuid);\r\n\t\tif (selection.length >= PULL_LIMIT) break;\r\n\t}\r\n\treturn selection;\r\n}\r\n\r\nfunction browserActiveListeners(wrapped, inner) {\r\n\twrapped(inner);\r\n\r\n\t// biome-ignore lint/complexity/noUselessThisAlias: <explanation>\r\n\tconst browser = this;\r\n\tconst actor = getInMemory(browser, \"merchant.actor\");\r\n\tif (!actor) return;\r\n\r\n\tconst browserTab = inner[0].querySelector(\r\n\t\t\".content .tab[data-tab=equipment]\",\r\n\t);\r\n\tconst footer = browserTab.querySelector(\".list-buttons\");\r\n\r\n\tconst checkbox = footer.querySelector(\"label input[type=checkbox]\");\r\n\tif (checkbox) {\r\n\t\tconst tab = getBrowserTab(\"equipment\");\r\n\r\n\t\tcheckbox.addEventListener(\"change\", () => {\r\n\t\t\tconst checkAll = checkbox.checked;\r\n\t\t\tconst selection = getInMemory(tab.browser, \"merchant.selection\");\r\n\r\n\t\t\tif (checkAll) fillSelection(tab, selection);\r\n\t\t\telse selection.length = 0;\r\n\r\n\t\t\tconst checkboxes = browserTab.querySelectorAll(\".item input\");\r\n\t\t\tfor (const checkbox of checkboxes) {\r\n\t\t\t\tconst uuid = checkbox.dataset.uuid;\r\n\t\t\t\tcheckbox.checked = selection.includes(uuid);\r\n\t\t\t}\r\n\r\n\t\t\tupdateBrowser(selection, false);\r\n\t\t});\r\n\t}\r\n\r\n\tconst btn = footer.querySelector(\"button\");\r\n\tif (btn) {\r\n\t\tbtn.addEventListener(\"click\", () => {\r\n\t\t\tconst selection = getInMemory(browser, \"merchant.selection\");\r\n\t\t\tconst msg = localize(\"browser.dialogMsg\", { nb: selection.length });\r\n\r\n\t\t\tDialog.confirm({\r\n\t\t\t\tcontent: `<div style=\"margin-bottom: 0.5em;\">${msg}</div>`,\r\n\t\t\t\ttitle: `${localize(\"browser.pull\")} - ${actor.name}`,\r\n\t\t\t\tyes: async (html) => {\r\n\t\t\t\t\tlocalize.info(\"browser.wait\");\r\n\t\t\t\t\tbrowser.close();\r\n\r\n\t\t\t\t\tconst items = await Promise.all(\r\n\t\t\t\t\t\tselection.map((uuid) => fromUuid(uuid)),\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tawait actor.createEmbeddedDocuments(\r\n\t\t\t\t\t\t\"Item\",\r\n\t\t\t\t\t\titems.map((item) => item.toObject()),\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tlocalize.info(\"browser.finished\");\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}\r\n\r\nasync function browserRenderResults(wrapped, start) {\r\n\tconst items = await wrapped(start);\r\n\tconst owned = getInMemory(this.browser, \"merchant.owned\");\r\n\tif (!owned) return items;\r\n\r\n\tconst browser = this.browser;\r\n\r\n\tconst selection = getInMemoryAndSetIfNot(\r\n\t\tbrowser,\r\n\t\t\"merchant.selection\",\r\n\t\t() => {\r\n\t\t\tconst selection = fillSelection(this, [], owned);\r\n\t\t\tupdateBrowser(selection);\r\n\t\t\treturn selection;\r\n\t\t},\r\n\t);\r\n\r\n\tconst isAtLimit =\r\n\t\tselection.length >= PULL_LIMIT\r\n\t\t\t? `data-tooltip=\"${localize(\"browser.limit\")}\" disabled`\r\n\t\t\t: \"\";\r\n\r\n\tconst ownedStr = localize(\"browser.owned\");\r\n\tconst isOwned = `<i class=\"fa-solid fa-box\" data-tooltip=\"${ownedStr}\"></i>`;\r\n\r\n\tfor (const item of items) {\r\n\t\tfor (const a of item.querySelectorAll(\":scope > a\")) {\r\n\t\t\ta.remove();\r\n\t\t}\r\n\r\n\t\tconst uuid = item.dataset.entryUuid;\r\n\r\n\t\tif (owned.includes(uuid)) {\r\n\t\t\titem.insertAdjacentHTML(\"beforeend\", isOwned);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst checked = selection.includes(uuid) ? \"checked\" : \"\";\r\n\t\titem.insertAdjacentHTML(\r\n\t\t\t\"beforeend\",\r\n\t\t\t`<input type='checkbox' data-uuid=\"${uuid}\" \r\n\t\t\t${checked} ${!checked ? isAtLimit : \"\"}>`,\r\n\t\t);\r\n\r\n\t\tconst checkbox = item.querySelector(\"input\");\r\n\t\tcheckbox.addEventListener(\"change\", () => {\r\n\t\t\tif (checkbox.checked) {\r\n\t\t\t\tselection.push(uuid);\r\n\t\t\t} else {\r\n\t\t\t\tconst index = selection.indexOf(uuid);\r\n\t\t\t\tselection.splice(index, 1);\r\n\t\t\t}\r\n\t\t\tupdateBrowser(selection);\r\n\t\t});\r\n\t}\r\n\r\n\treturn items;\r\n}\r\n\r\nasync function renderLootSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!actor?.isMerchant) return;\r\n\r\n\tconst {\r\n\t\tnoCoins = false,\r\n\t\tbuyItems = false,\r\n\t\tpriceRatio = 1,\r\n\t\tinfiniteStocks = false,\r\n\t\tinfiniteItems = {},\r\n\t} = getFlag(actor, \"merchant\") ?? {};\r\n\r\n\tconst sheetTemplate = await render(\"merchant/sheet\", {\r\n\t\tnoCoins,\r\n\t\tbuyItems,\r\n\t\tinfiniteStocks,\r\n\t\tpriceRatio: {\r\n\t\t\t...PRICE_RATIO,\r\n\t\t\tvalue: clampPriceRatio(\"sell\", priceRatio),\r\n\t\t},\r\n\t\tactorUUID: actor.uuid,\r\n\t\t...localize.i18n,\r\n\t\tflagPath: (str) => flagPath(\"merchant\", str),\r\n\t});\r\n\r\n\tconst sidebar = html.find(\".sheet-sidebar\");\r\n\r\n\tsidebar.find(\".editor\").before(sheetTemplate);\r\n\r\n\tconst better = sidebar.find(\".better-merchant\");\r\n\tbetter\r\n\t\t.find(\"[data-action=open-equipment-tab]\")\r\n\t\t.on(\"click\", (event) => openEquipmentTab(actor));\r\n\tbetter\r\n\t\t.find(\"[data-action=open-buy-settings]\")\r\n\t\t.on(\"click\", (event) => openBuySettings(event, actor));\r\n\r\n\tconst itemTypes = html\r\n\t\t.find(\".content .sheet-body [data-item-types]\")\r\n\t\t.filter(\"[data-item-types!=treasure]\");\r\n\r\n\tlet hasInfiniteStock = infiniteStocks;\r\n\r\n\tif (infiniteStocks) {\r\n\t\titemTypes.find(\".quantity a\").remove();\r\n\t} else {\r\n\t\tconst items = itemTypes.find(\"[data-item-id]\");\r\n\t\tconst tooltip = localize.path(\"infinite-item.tooltip\");\r\n\r\n\t\tfor (const item of items) {\r\n\t\t\tconst itemId = item.dataset.itemId;\r\n\t\t\tconst isInfinite = !!infiniteItems[itemId];\r\n\r\n\t\t\tconst toggle =\r\n\t\t\t\t$(`<a data-action=\"toggle-infinite-item\" data-tooltip=\"${tooltip}\">\r\n\t<i class=\"${isInfinite ? \"fa-solid\" : \"fa-duotone\"} fa-infinity\"></i>\r\n</a>`)[0];\r\n\r\n\t\t\titem.querySelector(\".item-controls\").prepend(toggle);\r\n\r\n\t\t\tif (isInfinite) {\r\n\t\t\t\tfor (const el of item.querySelectorAll(\".quantity a\")) {\r\n\t\t\t\t\tel.remove();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\ttoggle.addEventListener(\"click\", (event) => {\r\n\t\t\t\tconst flagKey = `merchant.infiniteItems.${itemId}`;\r\n\t\t\t\tconst current = getFlag(actor, flagKey) ?? false;\r\n\t\t\t\tsetFlag(actor, flagKey, !current);\r\n\t\t\t});\r\n\r\n\t\t\tif (isInfinite) {\r\n\t\t\t\thasInfiniteStock = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (hasInfiniteStock) {\r\n\t\thtml.find(\".content .sheet-body .coinage .wealth h3:last span\").html(\"-\");\r\n\r\n\t\thtml.find(\".content .sheet-body .total-bulk span\").html(\r\n\t\t\tgame.i18n.format(\"PF2E.Actor.Inventory.TotalBulk\", {\r\n\t\t\t\tbulk: \"-\",\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n}\r\n\r\nfunction itemPrepareDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!this.isOfType(\"physical\") || this.isOfType(\"treasure\")) return;\r\n\r\n\t\tconst actor = this.actor;\r\n\t\tif (!actor?.isMerchant) return;\r\n\r\n\t\tconst actorFlags = getFlag(actor, \"merchant\");\r\n\t\tif (!actorFlags) return;\r\n\r\n\t\tconst { priceRatio, infiniteStocks, infiniteItems = {} } = actorFlags;\r\n\r\n\t\tif (priceRatio !== 1) {\r\n\t\t\tconst ratio = clampPriceRatio(\"sell\", priceRatio);\r\n\t\t\tthis.system.price.value = this.system.price.value.scale(ratio);\r\n\t\t}\r\n\r\n\t\tconst isInfinite = (() => {\r\n\t\t\tif (typeof infiniteStocks === \"boolean\" && infiniteStocks) {\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\tconst infiniteItem = infiniteItems[this.id];\r\n\t\t\treturn typeof infiniteItem === \"boolean\" && infiniteItem;\r\n\t\t})();\r\n\r\n\t\tif (isInfinite) {\r\n\t\t\tthis.system.quantity = 9999;\r\n\t\t}\r\n\t} catch (error) {\r\n\t\twrapperError(\"merchant\", ITEM_PREPARE_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\nasync function lootTranferItemToActor(...args) {\r\n\tconst [targetActor, item, quantity] = args;\r\n\tconst thisSuper = Actor.implementation.prototype;\r\n\r\n\tif (!(this.isOwner && targetActor.isOwner)) {\r\n\t\treturn thisSuper.transferItemToActor.apply(this, args);\r\n\t}\r\n\tif (this.isMerchant && item.isOfType(\"physical\")) {\r\n\t\tconst itemValue = game.pf2e.Coins.fromPrice(item.price, quantity);\r\n\t\tif (await targetActor.inventory.removeCoins(itemValue)) {\r\n\t\t\tif (!getFlag(this, \"merchant.noCoins\")) {\r\n\t\t\t\tawait item.actor.inventory.addCoins(itemValue);\r\n\t\t\t}\r\n\t\t\treturn thisSuper.transferItemToActor.apply(this, args);\r\n\t\t}\r\n\t\tif (this.isLoot) {\r\n\t\t\tthrow ErrorPF2e(\"Loot transfer failed\");\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\treturn thisSuper.transferItemToActor.apply(this, args);\r\n}\r\n\r\nfunction getFilters(actor) {\r\n\treturn getFlag(actor, \"merchant.filters\")?.slice() ?? [];\r\n}\r\n\r\nexport function getBuyAll(actor) {\r\n\treturn getFlag(actor, \"merchant.buyAll\") ?? true;\r\n}\r\n\r\nfunction createPurse(filter, itemPrice) {\r\n\tconst isDefault = filter instanceof Actor;\r\n\tconst purse = clampPurse(\r\n\t\tisDefault ? getFlag(filter, \"merchant.buyPurse\") : filter.purse,\r\n\t);\r\n\tconst ratio = clampPriceRatio(\r\n\t\t\"buy\",\r\n\t\tisDefault ? getFlag(filter, \"merchant.buyRatio\") : filter.priceRatio,\r\n\t);\r\n\tconst price = itemPrice.scale(ratio);\r\n\tconst isInfinite = purse < 0;\r\n\tconst goldValue = price.goldValue;\r\n\r\n\treturn {\r\n\t\tprice,\r\n\t\tratio,\r\n\t\tpurse,\r\n\t\tgoldValue,\r\n\t\tisInfinite,\r\n\t\tcanAfford: isInfinite || purse >= goldValue,\r\n\t};\r\n}\r\n\r\nasync function actorTranferItemToActor(wrapped, ...args) {\r\n\tconst [buyer, item, quantity = 1, containerId, newStack] = args;\r\n\tif (\r\n\t\t!buyer.isOfType(\"loot\") ||\r\n\t\t!buyer.isMerchant ||\r\n\t\t!getFlag(buyer, \"merchant.buyItems\")\r\n\t) {\r\n\t\treturn wrapped(...args);\r\n\t}\r\n\r\n\tconst hasPlayerOwner = this.hasPlayerOwner;\r\n\r\n\tswitch (this.type) {\r\n\t\tcase \"character\":\r\n\t\tcase \"party\":\r\n\t\t\tbreak;\r\n\t\tcase \"loot\":\r\n\t\t\tif (!hasPlayerOwner || this.isMerchant) {\r\n\t\t\t\treturn wrapped(...args);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase \"npc\":\r\n\t\t\tif (!hasPlayerOwner) {\r\n\t\t\t\treturn wrapped(...args);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\treturn wrapped(...args);\r\n\t}\r\n\r\n\tconst targetName = buyer.name;\r\n\tconst itemQuantity = Math.min(quantity, item.quantity);\r\n\tconst itemPrice = calculateItemPrice(item, itemQuantity);\r\n\r\n\tconst totalPurse = createPurse(buyer, itemPrice);\r\n\tif (!totalPurse.canAfford) {\r\n\t\tlocalize.info(\"buy.poor.total\", { actor: targetName });\r\n\t\treturn;\r\n\t}\r\n\r\n\tlet poor = false;\r\n\tlet selected = null;\r\n\tconst filters = getFilters(buyer);\r\n\r\n\tfor (const filter of filters) {\r\n\t\tif (BuyItems.compareItemWithFilter(item, filter)) {\r\n\t\t\tconst purse = createPurse(filter, itemPrice);\r\n\t\t\tif (!purse.canAfford) {\r\n\t\t\t\tpoor = true;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tselected = filter.id;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tif (!selected && !getBuyAll(buyer)) {\r\n\t\tlocalize.info(poor ? \"buy.poor.filter\" : \"buy.refuse\", {\r\n\t\t\tactor: targetName,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tmakeBuyDeal({\r\n\t\tbuyer,\r\n\t\tseller: this,\r\n\t\titem,\r\n\t\tquantity,\r\n\t\tcontainerId,\r\n\t\tnewStack,\r\n\t\tfilter: selected,\r\n\t});\r\n}\r\n\r\nasync function makeBuyDeal(options, senderId) {\r\n\tconst getDocument = async (option, Class) => {\r\n\t\treturn option instanceof Class ? option : await fromUuid(option);\r\n\t};\r\n\r\n\tconst errorMsg = (err) => {\r\n\t\tlocalize.error(\r\n\t\t\t\"An error occured while making a deal (F12 for more details in the console).\",\r\n\t\t);\r\n\t\tthrow new Error(err);\r\n\t};\r\n\r\n\tconst buyer = await getDocument(options.buyer, Actor);\r\n\tconst seller = await getDocument(options.seller, Actor);\r\n\tconst item = await getDocument(options.item, Item);\r\n\r\n\tif (!buyer || !seller || !item) {\r\n\t\tconst docs = [\"buyer\", \"seller\", \"item\"]\r\n\t\t\t.map((x) => `${x}: ${options[x].uuid ?? options[x]}`)\r\n\t\t\t.join(\", \");\r\n\t\terrorMsg(\r\n\t\t\t`Missing actors or item to finish processing the buy deal, ${docs}.`,\r\n\t\t);\r\n\t}\r\n\r\n\tif (!buyer.isOwner || !seller.isOwner) {\r\n\t\tsocket.emit({\r\n\t\t\t...options,\r\n\t\t\ttype: \"buy-deal\",\r\n\t\t\tbuyer: buyer.uuid,\r\n\t\t\tseller: seller.uuid,\r\n\t\t\titem: item.uuid,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\t// get item data\r\n\tconst itemQuantity = Math.min(options.quantity, item.quantity);\r\n\tconst itemPrice = calculateItemPrice(item, itemQuantity);\r\n\r\n\t// get purse data\r\n\tconst filters = getFilters(buyer);\r\n\tconst filter = filters.find((f) => f.id === options.filter);\r\n\tconst totalPurse = createPurse(buyer, itemPrice);\r\n\tconst filterPurse = filter ? createPurse(filter, itemPrice) : undefined;\r\n\r\n\tconst purseError = (type, purse) => {\r\n\t\terrorMsg(\r\n\t\t\t`${buyer.uuid} can't buy ${itemQuantity} x ${item.uuid}, the ${type} gold purse doesn't have enough founds, need: ${goldPrice}, has: ${purse}.`,\r\n\t\t);\r\n\t};\r\n\r\n\tif (!totalPurse.canAfford) {\r\n\t\tpurseError(\"total\", totalPurse);\r\n\t}\r\n\tif (filterPurse && !filterPurse.canAfford) {\r\n\t\tpurseError(\"filter\", filter.purse);\r\n\t}\r\n\r\n\tconst selectedPurse = filterPurse ?? totalPurse;\r\n\tconst purseUpdates = {};\r\n\r\n\tif (!totalPurse.isInfinite) {\r\n\t\tpurseUpdates[flagPath(\"merchant.buyPurse\")] =\r\n\t\t\ttotalPurse.purse - selectedPurse.goldValue;\r\n\t}\r\n\tif (filterPurse && !filterPurse.isInfinite) {\r\n\t\tfilter.purse = filterPurse.purse - selectedPurse.goldValue;\r\n\t\tpurseUpdates[flagPath(\"merchant.filters\")] = filters;\r\n\t}\r\n\tif (!isEmpty(purseUpdates)) {\r\n\t\tawait buyer.update(purseUpdates);\r\n\t}\r\n\r\n\tawait seller.inventory.addCoins(selectedPurse.price);\r\n\r\n\tconst newItem = await transferItemToActor(buyer, item, itemQuantity);\r\n\r\n\tconst message = localize(\"sold.message\", {\r\n\t\tbuyer: getHighestName(buyer),\r\n\t\tquantity: itemQuantity,\r\n\t\titem: await createFancyLink(newItem),\r\n\t\tseller: getHighestName(seller),\r\n\t\tprice: parseFloat(selectedPurse.goldValue.toFixed(2)),\r\n\t});\r\n\r\n\tawait createTradeMessage(\r\n\t\tlocalize(\"sold.subtitle\"),\r\n\t\tmessage,\r\n\t\tbuyer,\r\n\t\tnewItem,\r\n\t\tsenderId,\r\n\t);\r\n}\r\n\r\nfunction openEquipmentTab(actor) {\r\n\tconst browser = getBrowser();\r\n\tsetInMemory(browser, \"merchant\", { actor });\r\n\topenBrowserTab(\"equipment\", false);\r\n}\r\n\r\nfunction openBuySettings(event, actor) {\r\n\tnew BuyItems(actor).render(true);\r\n}\r\n\r\n/**\r\n * @param {\"buy\"|\"sell\"} type\r\n * @param {unknown} value\r\n * @returns {number}\r\n */\r\nexport function clampPriceRatio(type, value) {\r\n\tif (!Number.isNumeric(value)) return PRICE_RATIO[type];\r\n\treturn Math.clamped(value, PRICE_RATIO.min, PRICE_RATIO.max);\r\n}\r\n\r\nexport function clampPurse(value) {\r\n\tif (!Number.isNumeric(value)) return -1;\r\n\treturn Math.max(value, -1);\r\n}\r\n", "import { getFlag, updateSourceFlag } from \"module-api\";\r\n\r\nexport function bindOnPreCreateSpellDamageChatMessage(originalMessage) {\r\n\tconst messageId = originalMessage.id;\r\n\tconst save = getFlag(originalMessage, \"target.save\");\r\n\tif (!save) return;\r\n\r\n\tHooks.once(\"preCreateChatMessage\", (message) => {\r\n\t\tupdateSourceFlag(message, \"target.messageId\", messageId);\r\n\t\tupdateSourceFlag(message, \"target.save\", save);\r\n\t});\r\n}\r\n", "import { subLocalize, templatePath } from \"module-api\";\r\nimport { bindOnPreCreateSpellDamageChatMessage } from \"../../chat\";\r\n\r\nconst localize = subLocalize(\"merge.multi\");\r\n\r\nexport class MultiCast extends Application {\r\n\t#message;\r\n\t#event;\r\n\r\n\tconstructor(event, message, options) {\r\n\t\tsuper(options);\r\n\t\tthis.#event = event;\r\n\t\tthis.#message = message;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.#message.item);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"merge/multi\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\ti18n: localize.template,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"[data-action=cast]\").on(\"click\", this.#onCast.bind(this));\r\n\t\thtml.find(\"[data-action=cancel]\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\tasync #onCast(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst nb = this.element.find(\"[name=multi]\").val();\r\n\t\tif (nb < 1) {\r\n\t\t\tlocalize.error(\"zero\");\r\n\t\t\tthis.close();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst message = this.#message;\r\n\t\tif (!message) return;\r\n\r\n\t\tconst spell = message.item;\r\n\t\tconst actor = message.actor;\r\n\t\tif (!actor || !spell) return;\r\n\r\n\t\tconst updateSource = (damages, heightening) => {\r\n\t\t\tfor (const [id, damage] of Object.entries(damages)) {\r\n\t\t\t\tfor (let i = 0; i < nb - 1; i++) {\r\n\t\t\t\t\tconst newId = randomID();\r\n\r\n\t\t\t\t\tdamages[newId] = damage;\r\n\r\n\t\t\t\t\tif (heightening.type === \"interval\") {\r\n\t\t\t\t\t\tconst damage = heightening.damage[id];\r\n\t\t\t\t\t\tif (damage) heightening.damage[newId] = damage;\r\n\t\t\t\t\t} else if (heightening.type === \"fixed\") {\r\n\t\t\t\t\t\tfor (const data of Object.values(heightening.levels)) {\r\n\t\t\t\t\t\t\tconst damage = data.damage[id];\r\n\t\t\t\t\t\t\tif (!damage) continue;\r\n\t\t\t\t\t\t\tdata.damage[newId] = damage;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tconst embeddedSource = deepClone(message.flags.pf2e.casting?.embeddedSpell);\r\n\r\n\t\tif (embeddedSource) {\r\n\t\t\tconst damages = embeddedSource.system.damage;\r\n\r\n\t\t\tembeddedSource.system.heightening ??= {};\r\n\t\t\tconst heightening = embeddedSource.system.heightening;\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = new Item.implementation(embeddedSource, {\r\n\t\t\t\tparent: actor,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.trickMagicEntry = spell.trickMagicEntry;\r\n\r\n\t\t\tconst overlayIds = message.getFlag(\"pf2e\", \"origin.variant.overlays\");\r\n\t\t\tconst castRank = message.getFlag(\"pf2e\", \"origin.castRank\") ?? spell.rank;\r\n\t\t\tconst modifiedSpell = newSpell.loadVariant({ overlayIds, castRank });\r\n\t\t\tconst castSpell = modifiedSpell ?? newSpell;\r\n\r\n\t\t\tcastSpell.rollDamage(this.#event);\r\n\t\t} else {\r\n\t\t\tconst spellSource = spell.toObject();\r\n\t\t\tconst damages = spellSource.system.damage;\r\n\t\t\tconst heightening = spellSource.system.heightening ?? {};\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = spell.clone({\r\n\t\t\t\t\"system.damage\": damages,\r\n\t\t\t\t\"system.heightening\": heightening,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.rollDamage(this.#event);\r\n\t\t}\r\n\r\n\t\tif (spell.damageKinds.size) {\r\n\t\t\tbindOnPreCreateSpellDamageChatMessage(message);\r\n\t\t}\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "import {\r\n\tMODULE,\r\n\tcompareArrays,\r\n\tgetDamageRollClass,\r\n\tgetFlag,\r\n\tgetSetting,\r\n\tlatestChatMessages,\r\n\tlocalize,\r\n\trender,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { MultiCast } from \"../apps/merge/multi\";\r\nimport { createTool } from \"../tool\";\r\n\r\nconst setupDebounced = debounce(setup, 1);\r\n\r\nexport const mergeOptions = {\r\n\tname: \"merge\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"merge-damage\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tscope: \"client\",\r\n\t\t\tonChange: setupDebounced,\r\n\t\t},\r\n\t\t{\r\n\t\t\tkey: \"multi-cast\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tscope: \"client\",\r\n\t\t\tonChange: setupDebounced,\r\n\t\t},\r\n\t],\r\n\thooks: [[\"renderChatMessage\", renderChatMessage]],\r\n\tinit: setupDebounced,\r\n};\r\n\r\nconst { setHook } = createTool(mergeOptions);\r\n\r\nfunction setup() {\r\n\tconst enabled = getSetting(\"merge-damage\") || getSetting(\"multi-cast\");\r\n\tsetHook(enabled);\r\n\tupdateMessages();\r\n}\r\n\r\nfunction updateMessages() {\r\n\tfor (const { message, html } of latestChatMessages(10)) {\r\n\t\thtml.find(\"[data-action=multi-cast]\").remove();\r\n\t\thtml.find(\"[data-action=merge-damage]\").remove();\r\n\t\trenderChatMessage(message, html);\r\n\t}\r\n}\r\n\r\nfunction renderChatMessage(message, html) {\r\n\tif (!game.user.isGM && !message.isAuthor) return;\r\n\r\n\tif (getSetting(\"merge-damage\") && isDamageRoll(message))\r\n\t\trenderDamage(message, html);\r\n\telse if (\r\n\t\tgetSetting(\"multi-cast\") &&\r\n\t\tmessage.getFlag(\"pf2e\", \"origin.type\") === \"spell\"\r\n\t)\r\n\t\trenderSpell(message, html);\r\n}\r\n\r\nfunction renderSpell(message, html) {\r\n\tconst item = message.item;\r\n\tif (!item) return;\r\n\r\n\tconst spellBtn = html.find(\r\n\t\t\".message-content .chat-card .owner-buttons .spell-button\",\r\n\t);\r\n\r\n\tspellBtn\r\n\t\t.find(\"[data-action=spell-damage]\")\r\n\t\t.after(\r\n\t\t\t`<button data-action=\"multi-cast\">${localize(\r\n\t\t\t\t\"merge.spell.button\",\r\n\t\t\t)}</button>`,\r\n\t\t);\r\n\r\n\tspellBtn.find(\"[data-action=multi-cast]\").on(\"click\", (event) => {\r\n\t\tnew MultiCast(event, message).render(true);\r\n\t});\r\n}\r\n\r\nfunction renderDamage(message, html) {\r\n\tlet buttons = '<span class=\"pf2e-toolbelt-merge\">';\r\n\r\n\tif (getFlag(message, \"merge.merged\")) {\r\n\t\tconst tooltip = localize(\"merge.damage.split-tooltip\");\r\n\t\tbuttons += `<button data-action=\"split-damage\" title=\"${tooltip}\">`;\r\n\t\tbuttons += '<i class=\"fa-duotone fa-split\"></i>';\r\n\t}\r\n\r\n\tconst tooltip = localize(\"merge.damage.tooltip\");\r\n\tbuttons += `<button data-action=\"merge-damage\" title=\"${tooltip}\">`;\r\n\tbuttons += '<i class=\"fa-duotone fa-merge\"></i></button>';\r\n\r\n\tbuttons += \"</span>\";\r\n\r\n\tconst actorUUID = getActorUUID(message);\r\n\tconst targetUUIDs = getTargetUUIDs(message);\r\n\r\n\thtml.find(\".dice-result .dice-total\").append(buttons);\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=merge-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tfor (const { message: otherMessage } of latestChatMessages(5, message)) {\r\n\t\t\t\tconst otherTargetsUUIDS = getTargetUUIDs(otherMessage);\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\t!isDamageRoll(otherMessage) ||\r\n\t\t\t\t\tgetActorUUID(otherMessage) !== actorUUID ||\r\n\t\t\t\t\t!compareArrays(\r\n\t\t\t\t\t\ttargetUUIDs?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t\totherTargetsUUIDS?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\tmergeDamages(event, message, otherMessage, { actorUUID, targetUUIDs });\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\twarn(\"merge.damage.none\");\r\n\t\t});\r\n\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=split-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\t\t\tsplitDamages(event, message);\r\n\t\t});\r\n}\r\n\r\nasync function splitDamages(event, message) {\r\n\tconst sources = getFlag(message, \"merge.data\").flatMap((data) => data.source);\r\n\tawait removeChatMessages(message.id);\r\n\tawait ChatMessage.implementation.createDocuments(sources);\r\n}\r\n\r\nasync function mergeDamages(event, origin, other, { actorUUID, targetUUIDs }) {\r\n\tconst dataGroups = {};\r\n\r\n\tconst data = getMessageData(other).concat(getMessageData(origin));\r\n\tfor (const { name, notes, outcome, modifiers, tags } of data) {\r\n\t\tdataGroups[name] ??= {\r\n\t\t\tname,\r\n\t\t\ttags,\r\n\t\t\tnotes: new Set(),\r\n\t\t\tresults: [],\r\n\t\t};\r\n\r\n\t\tfor (const note of notes) {\r\n\t\t\tdataGroups[name].notes.add(note);\r\n\t\t}\r\n\r\n\t\tconst exists = dataGroups[name].results.some(\r\n\t\t\t(result) =>\r\n\t\t\t\tresult.outcome === outcome &&\r\n\t\t\t\tcompareArrays(result.modifiers, modifiers),\r\n\t\t);\r\n\r\n\t\tif (!exists) dataGroups[name].results.push({ outcome, modifiers });\r\n\t}\r\n\r\n\tconst groups = Object.values(dataGroups).map((group) => {\r\n\t\tgroup.label = group.name;\r\n\r\n\t\tfor (const result of group.results) {\r\n\t\t\tif (!result.outcome) continue;\r\n\t\t\tresult.label = game.i18n.localize(\r\n\t\t\t\t`PF2E.Check.Result.Degree.Attack.${result.outcome}`,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn group;\r\n\t});\r\n\r\n\tgroups.at(-1).isLastGroup = true;\r\n\r\n\tconst flavor = await render(\"merge/merged\", {\r\n\t\tgroups,\r\n\t\thasMultipleGroups: groups.length > 1,\r\n\t});\r\n\r\n\tconst originRolls = getMessageRolls(origin);\r\n\tconst otherRolls = getMessageRolls(other);\r\n\tconst groupedRolls = [];\r\n\r\n\tfor (const roll of [].concat(otherRolls, originRolls)) {\r\n\t\tconst { options, total, terms } = roll;\r\n\t\tconst term = terms[0];\r\n\t\tconst formula = roll.formula\r\n\t\t\t.replaceAll(/(\\[[\\w,-]+\\])/g, \"\")\r\n\t\t\t.replace(/^\\(/, \"\")\r\n\t\t\t.replace(/\\)$/, \"\");\r\n\t\tconst group = groupedRolls.find(\r\n\t\t\t({ options: { flavor, critRule } }) =>\r\n\t\t\t\tflavor === options.flavor && critRule === options.critRule,\r\n\t\t);\r\n\r\n\t\tif (group) {\r\n\t\t\tgroup.terms.push(term);\r\n\t\t\tgroup.total += total;\r\n\t\t\tgroup.formulas.push(formula);\r\n\t\t} else {\r\n\t\t\tgroupedRolls.push({\r\n\t\t\t\toptions,\r\n\t\t\t\tformulas: [formula],\r\n\t\t\t\ttotal,\r\n\t\t\t\tterms: [term],\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tconst DamageRoll = getDamageRollClass();\r\n\tfor (const group of groupedRolls) {\r\n\t\tif (group.options.flavor.includes(\"persistent\")) {\r\n\t\t\tconst { index } = group.formulas.reduce(\r\n\t\t\t\t(prev, curr, index) => {\r\n\t\t\t\t\tconst value = new DamageRoll(curr).expectedValue;\r\n\t\t\t\t\tif (value <= prev.value) return prev;\r\n\t\t\t\t\treturn { value, index };\r\n\t\t\t\t},\r\n\t\t\t\t{ value: 0, index: -1 },\r\n\t\t\t);\r\n\r\n\t\t\tgroup.formulas = [group.formulas[index]];\r\n\t\t\tgroup.terms = [group.terms[index]];\r\n\t\t}\r\n\r\n\t\tgroup.formula = `(${group.formulas.join(\" + \")})[${group.options.flavor}]`;\r\n\t\tgroup.term =\r\n\t\t\tgroup.terms.length < 2 ? group.terms[0] : createTermGroup(group.terms);\r\n\t}\r\n\r\n\tconst roll = {\r\n\t\tclass: \"DamageRoll\",\r\n\t\toptions: {},\r\n\t\tdice: [],\r\n\t\tformula: `{${groupedRolls.map(({ formula }) => formula).join(\", \")}}`,\r\n\t\ttotal: groupedRolls.reduce((acc, { total }) => acc + total, 0),\r\n\t\tevaluated: true,\r\n\t\tterms: [\r\n\t\t\t{\r\n\t\t\t\tclass: \"InstancePool\",\r\n\t\t\t\toptions: {},\r\n\t\t\t\tevaluated: true,\r\n\t\t\t\tterms: groupedRolls.map(({ formula }) => formula),\r\n\t\t\t\tmodifiers: [],\r\n\t\t\t\trolls: groupedRolls.map(({ options, formula, total, term }) => ({\r\n\t\t\t\t\tclass: \"DamageInstance\",\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tdice: [],\r\n\t\t\t\t\tformula,\r\n\t\t\t\t\ttotal,\r\n\t\t\t\t\tterms: [term],\r\n\t\t\t\t\tevaluated: true,\r\n\t\t\t\t})),\r\n\t\t\t\tresults: groupedRolls.map(({ total }) => ({\r\n\t\t\t\t\tresult: total,\r\n\t\t\t\t\tactive: true,\r\n\t\t\t\t})),\r\n\t\t\t},\r\n\t\t],\r\n\t};\r\n\r\n\tif (game.modules.get(\"dice-so-nice\")?.active) {\r\n\t\tconst setHidden = (term) => {\r\n\t\t\tif (\"results\" in term) {\r\n\t\t\t\tfor (const result of term.results) {\r\n\t\t\t\t\tresult.hidden = true;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconst operands = (term.term ?? term).operands ?? [];\r\n\t\t\t\tfor (const operand of operands) {\r\n\t\t\t\t\tsetHidden(operand);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tfor (const r of roll.terms[0].rolls) {\r\n\t\t\tfor (const term of r.terms) {\r\n\t\t\t\tsetHidden(term);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tawait removeChatMessages(origin.id, other.id);\r\n\r\n\tawait ChatMessage.implementation.create({\r\n\t\tflavor,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.ROLL,\r\n\t\tspeaker: origin.speaker,\r\n\t\tflags: {\r\n\t\t\t[MODULE.id]: {\r\n\t\t\t\tmerge: {\r\n\t\t\t\t\tactor: actorUUID,\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t\tmerged: true,\r\n\t\t\t\t\ttype: \"damage-roll\",\r\n\t\t\t\t\tdata,\r\n\t\t\t\t},\r\n\t\t\t\ttarget: {\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tpf2e: {\r\n\t\t\t\tcontext: {\r\n\t\t\t\t\toptions: Array.from(\r\n\t\t\t\t\t\tnew Set(data.flatMap((entry) => entry.itemTraits)),\r\n\t\t\t\t\t),\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t},\r\n\t\trolls: [roll],\r\n\t});\r\n}\r\n\r\nfunction getMessageData(message) {\r\n\tconst flags = getFlag(message, \"merge.data\");\r\n\tif (flags) return flags;\r\n\r\n\tconst source = message.toObject();\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source._id;\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source.timestamp;\r\n\r\n\tconst html = $(`<div>${message.flavor}</div>`);\r\n\tconst tags = html.find(\"h4.action + .tags\").prop(\"outerHTML\");\r\n\r\n\tconst modifiers = [];\r\n\thtml.find(\".tag.tag_transparent\").each(function () {\r\n\t\tmodifiers.push(this.innerHTML);\r\n\t});\r\n\r\n\tconst notes = source.flags.pf2e.context.notes.map(\r\n\t\t({ title, text }) =>\r\n\t\t\t`<strong>${game.i18n.localize(title)}</strong> ${game.i18n.localize(\r\n\t\t\t\ttext,\r\n\t\t\t)}`,\r\n\t);\r\n\r\n\treturn [\r\n\t\t{\r\n\t\t\tsource,\r\n\t\t\tname: source.flags.pf2e.strike?.name ?? message.item.name,\r\n\t\t\toutcome: source.flags.pf2e.context.outcome,\r\n\t\t\titemTraits: source.flags.pf2e.context.options.filter((option) =>\r\n\t\t\t\t/^(item|self):/.test(option),\r\n\t\t\t),\r\n\t\t\tmodifiers,\r\n\t\t\ttags,\r\n\t\t\tnotes,\r\n\t\t},\r\n\t];\r\n}\r\n\r\nfunction removeChatMessages(...ids) {\r\n\tconst joinedIds = ids.map((id) => `[data-message-id=${id}]`).join(\", \");\r\n\tui.chat.element.find(joinedIds).remove();\r\n\treturn ChatMessage.deleteDocuments(ids);\r\n}\r\n\r\nfunction createTermGroup(terms) {\r\n\tconst options = deepClone(terms[0].options);\r\n\r\n\tfor (const term of terms) {\r\n\t\tterm.options = {};\r\n\t}\r\n\r\n\treturn {\r\n\t\tclass: \"Grouping\",\r\n\t\toptions,\r\n\t\tevaluated: true,\r\n\t\tterm: {\r\n\t\t\tclass: \"ArithmeticExpression\",\r\n\t\t\toptions: {},\r\n\t\t\tevaluated: true,\r\n\t\t\toperator: \"+\",\r\n\t\t\toperands: [\r\n\t\t\t\tterms.shift(),\r\n\t\t\t\tterms.length > 1 ? createTermGroup(terms) : terms[0],\r\n\t\t\t],\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction getMessageRolls(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.rolls\") ??\r\n\t\tJSON.parse(message._source.rolls[0]).terms[0].rolls\r\n\t);\r\n}\r\n\r\nfunction getActorUUID(message) {\r\n\treturn getFlag(message, \"merge.actor\") ?? message.actor?.uuid;\r\n}\r\n\r\nfunction getTargetUUIDs(message) {\r\n\tconst targetTargets = getFlag(message, \"target.targets\");\r\n\tif (targetTargets) return targetTargets;\r\n\r\n\tconst mergeTargets =\r\n\t\tgetFlag(message, \"merge.targets\") ?? message.getFlag(\"pf2e\", \"target\");\r\n\tif (Array.isArray(mergeTargets)) return mergeTargets;\r\n\treturn mergeTargets ? [mergeTargets] : [];\r\n}\r\n\r\nfunction isDamageRoll(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.type\") === \"damage-roll\" ||\r\n\t\tmessage.getFlag(\"pf2e\", \"context.type\") === \"damage-roll\"\r\n\t);\r\n}\r\n", "import { getSetting, registerWrapper } from \"module-api\";\r\nimport { wrapperError } from \"../misc\";\r\n\r\nconst ACTOR_PREPARE_EMBEDDED_DOCUMENTS =\r\n\t\"CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments\";\r\nconst TREASURE_PREPARE_BASE_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData\";\r\n\r\nexport const nobulkOptions = {\r\n\tname: \"nobulk\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"nobulk\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\trequiresReload: true,\r\n\t\t},\r\n\t\t{\r\n\t\t\tkey: \"nobulk-coins\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\trequiresReload: true,\r\n\t\t},\r\n\t],\r\n\tinit: () => {\r\n\t\tif (getSetting(\"nobulk\")) {\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tACTOR_PREPARE_EMBEDDED_DOCUMENTS,\r\n\t\t\t\tactorPrepareEmbeddedDocuments,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\t\t}\r\n\t\tif (getSetting(\"nobulk-coins\")) {\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tTREASURE_PREPARE_BASE_DATA,\r\n\t\t\t\ttreasurePrepareBaseData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\t\t}\r\n\t},\r\n};\r\n\r\nfunction treasurePrepareBaseData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (this.isCoinage) this.system.bulk.value = 0;\r\n\t} catch {\r\n\t\twrapperError(\"nobulk\", TREASURE_PREPARE_BASE_DATA);\r\n\t}\r\n}\r\n\r\nfunction actorPrepareEmbeddedDocuments(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tconst InventoryBulk = this.inventory.bulk.constructor;\r\n\r\n\t\tlet _value = null;\r\n\r\n\t\tObject.defineProperty(this.inventory.bulk, \"value\", {\r\n\t\t\tget() {\r\n\t\t\t\tif (_value) return _value;\r\n\t\t\t\t_value = InventoryBulk.computeTotalBulk(\r\n\t\t\t\t\tthis.actor.inventory.filter(\r\n\t\t\t\t\t\t(item) =>\r\n\t\t\t\t\t\t\t!item.isInContainer &&\r\n\t\t\t\t\t\t\titem.system.equipped.carryType !== \"dropped\",\r\n\t\t\t\t\t),\r\n\t\t\t\t\tthis.actor.size,\r\n\t\t\t\t);\r\n\t\t\t\treturn _value;\r\n\t\t\t},\r\n\t\t});\r\n\t} catch {\r\n\t\twrapperError(\"nobulk\", ACTOR_PREPARE_EMBEDDED_DOCUMENTS);\r\n\t}\r\n}\r\n", "import {\r\n\tdeleteInMemory,\r\n\tflagPath,\r\n\tgetFlag,\r\n\tgetFlagProperty,\r\n\tgetInMemory,\r\n\tgetSetting,\r\n\tisInstanceOf,\r\n\tregisterWrapper,\r\n\trender,\r\n\tsetFlag,\r\n\tsetInMemory,\r\n\tsubLocalize,\r\n\tunsetFlag,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor-sheet\";\r\n\r\nconst ACTOR_PREPARE_DATA = \"CONFIG.Actor.documentClass.prototype.prepareData\";\r\nconst DOCUMENT_SHEET_RENDER_INNER = \"DocumentSheet.prototype._renderInner\";\r\n\r\nexport const shareOptions = {\r\n\tname: \"share\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"share\",\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"disabled\",\r\n\t\t\tchoices: [\"disabled\", \"enabled\", \"force\"],\r\n\t\t\trequiresReload: true,\r\n\t\t},\r\n\t],\r\n\tinit: () => {\r\n\t\tconst share = getSetting(\"share\");\r\n\t\tif (share === \"disabled\") return;\r\n\r\n\t\tregisterWrapper(ACTOR_PREPARE_DATA, prepareData, \"WRAPPER\");\r\n\t\tregisterWrapper(\r\n\t\t\tDOCUMENT_SHEET_RENDER_INNER,\r\n\t\t\tdocumentSheetRenderInner,\r\n\t\t\t\"WRAPPER\",\r\n\t\t);\r\n\r\n\t\tHooks.on(\"preUpdateActor\", preUpdateActor);\r\n\t\tHooks.on(\"deleteActor\", deleteActor);\r\n\t\tHooks.on(\"updateActor\", updateActor);\r\n\t},\r\n};\r\n\r\nasync function documentSheetRenderInner(wrapped, ...args) {\r\n\tconst inner = await wrapped(...args);\r\n\tif (!isInstanceOf(this, \"CreatureConfig\")) return inner;\r\n\r\n\tconst actor = this.actor;\r\n\tif (\r\n\t\t!isPlayedActor(actor) ||\r\n\t\t!actor.isOfType(\"character\", \"npc\") ||\r\n\t\tgetSlaves(actor).size\r\n\t)\r\n\t\treturn inner;\r\n\r\n\tconst masters = game.actors\r\n\t\t.filter((a) => a.id !== actor.id && a.isOwner && isValidMaster(a))\r\n\t\t.map((actor) => ({\r\n\t\t\tkey: actor.id,\r\n\t\t\tlabel: actor.name,\r\n\t\t}));\r\n\r\n\tconst group = await render(\"share/master\", {\r\n\t\tmasters,\r\n\t\tmaster: getFlag(actor, \"share.master\"),\r\n\t\tselectPath: flagPath(\"share.master\"),\r\n\t\ti18n: subLocalize(\"share.templates.master\"),\r\n\t});\r\n\r\n\tinner.children().last().before(group);\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction deleteActor(actor) {\r\n\tremoveSlaveFromMaster(actor);\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tPromise.all(\r\n\t\tslaves.map(async (slave) => {\r\n\t\t\tunsetMaster(slave);\r\n\t\t\tawait unsetFlag(slave, \"share.master\");\r\n\t\t}),\r\n\t);\r\n}\r\n\r\nfunction preUpdateActor(actor, updates) {\r\n\tconst shareFlag = getFlagProperty(updates, \"share\");\r\n\tif (shareFlag?.master) {\r\n\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\tif (isValidMaster(master)) {\r\n\t\t\tconst hpSource = deepClone(master._source.system.attributes.hp);\r\n\t\t\tsetProperty(updates, \"system.attributes.hp\", hpSource);\r\n\t\t}\r\n\t} else {\r\n\t\tconst master = getMaster(actor);\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (master && hpUpdate) {\r\n\t\t\tmaster.update(\r\n\t\t\t\t{ system: { attributes: { hp: hpUpdate } } },\r\n\t\t\t\t{ noHook: true },\r\n\t\t\t);\r\n\t\t\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\t\t\tdelete updates.system.attributes.hp;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction updateActor(actor, updates, options, userId) {\r\n\tconst isOriginalUser = game.user.id === userId;\r\n\r\n\tconst shareFlag = getFlagProperty(updates, \"share\");\r\n\tif (shareFlag?.master !== undefined) {\r\n\t\tconst slave = actor;\r\n\r\n\t\tremoveSlaveFromMaster(slave);\r\n\r\n\t\tif (shareFlag.master) {\r\n\t\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\t\tif (isValidMaster(master)) {\r\n\t\t\t\tsetMaster(slave, master);\r\n\t\t\t\taddSlaveToMaster(master, slave);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tunsetMaster(slave);\r\n\t\t}\r\n\t}\r\n\r\n\tif (!isOriginalUser) return;\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tif (slaves.size) {\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (hpUpdate) {\r\n\t\t\tconst data = { system: { attributes: { hp: hpUpdate } } };\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await slave.update(data, { noHook: true })),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await refreshActor(slave, updates)),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nasync function refreshActor(actor, data) {\r\n\tconst share = getSetting(\"share\");\r\n\tif (share === \"force\") {\r\n\t\tawait setFlag(actor, \"toggle\", !getFlag(actor, \"toggle\"));\r\n\t} else {\r\n\t\tactor.render(false, { action: \"update\" });\r\n\t\tactor._updateDependentTokens(data);\r\n\t}\r\n}\r\n\r\nfunction prepareData(wrapped) {\r\n\twrapped();\r\n\r\n\tconst masterId = getFlag(this, \"share.master\");\r\n\tconst master = masterId ? game.actors.get(masterId) : undefined;\r\n\r\n\tif (!isValidMaster(master)) return;\r\n\r\n\tif (!getMaster(this)) {\r\n\t\tsetMaster(this, master);\r\n\t\taddSlaveToMaster(master, this);\r\n\t}\r\n\r\n\tconst hp = this.system.attributes.hp;\r\n\tObject.defineProperty(this.system.attributes, \"hp\", {\r\n\t\tget() {\r\n\t\t\tconst masterHp = master.system.attributes.hp;\r\n\t\t\ttransfertHpData(masterHp, hp);\r\n\t\t\treturn hp;\r\n\t\t},\r\n\t\tenumerable: true,\r\n\t});\r\n}\r\n\r\nfunction transfertHpData(from, to) {\r\n\tto.breakdown = from.breakdown;\r\n\tto.max = from.max;\r\n\tto.sp = deepClone(from.sp);\r\n\tto.temp = from.temp;\r\n\tto.totalModifier = from.totalModifier;\r\n\tto.value = from.value;\r\n\tto._modifiers = from._modifiers.slice();\r\n}\r\n\r\nfunction getSlaves(actor) {\r\n\treturn getInMemory(actor, \"share.slaves\") ?? new Collection();\r\n}\r\n\r\nfunction setMaster(actor, master) {\r\n\treturn setInMemory(actor, \"share.master\", master);\r\n}\r\n\r\nfunction unsetMaster(actor) {\r\n\treturn deleteInMemory(actor, \"share.master\");\r\n}\r\n\r\nfunction getMaster(actor) {\r\n\treturn getInMemory(actor, \"share.master\");\r\n}\r\n\r\nfunction isValidMaster(actor) {\r\n\treturn actor && actor.type === \"character\" && !getMaster(actor);\r\n}\r\n\r\nfunction addSlaveToMaster(master, slave) {\r\n\tconst slaves = getSlaves(master);\r\n\treturn setInMemory(master, \"share.slaves\", slaves.set(slave.id, slave));\r\n}\r\n\r\nfunction removeSlaveFromMaster(slave) {\r\n\tconst master = getMaster(slave);\r\n\tif (!master) return;\r\n\r\n\tconst slaves = getSlaves(master);\r\n\tslaves.delete(slave.id);\r\n}\r\n", "import {\r\n\tgetItemWithSourceId,\r\n\thasItemWithSourceId,\r\n\tinfo,\r\n\tisOwner,\r\n\trefreshActorSheets,\r\n\trender,\r\n\tsubLocalize,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor-sheet\";\r\nimport { calledIfSetting } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nconst STANCE_SAVANT = [\r\n\t\"Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu\",\r\n\t\"Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8\",\r\n];\r\n\r\nconst REPLACERS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA\", // gorilla pound\r\n\r\n\t\t{\r\n\t\t\treplace: \"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT\", // gorilla stance\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK\",\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nconst EXTRAS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt\", // arcane cascade\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl\",\r\n\t\t\taction: \"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28\", // cobra envenom\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT\", // dread marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv\", // the stance aura\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa\", // inspiring marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ\", // the stance aura\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nexport const stancesOptions = {\r\n\tname: \"stances\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"stances\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tscope: \"client\",\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t],\r\n\thooks: [\r\n\t\t[\"deleteCombat\", deleteCombat],\r\n\t\t[\"deleteCombatant\", deleteCombatant],\r\n\t\t[\"createCombatant\", createCombatant],\r\n\t\t[\"renderCharacterSheetPF2e\", renderCharacterSheetPF2e],\r\n\t],\r\n\tconflicts: [\"pf2e-stances\"],\r\n\tapi: {\r\n\t\tgetStances,\r\n\t\ttoggleStance,\r\n\t\tisValidStance,\r\n\t},\r\n\tready: calledIfSetting(setup, \"stances\"),\r\n};\r\n\r\nconst { hooks } = createTool(stancesOptions);\r\n\r\nfunction setup(value) {\r\n\thooks.setAll(value);\r\n\trefreshActorSheets(\"character\");\r\n}\r\n\r\nfunction isValidStance(stance) {\r\n\treturn (\r\n\t\tstance?.system.traits.value.includes(\"stance\") &&\r\n\t\tstance.system.selfEffect?.uuid\r\n\t);\r\n}\r\n\r\nfunction getStances(actor) {\r\n\tconst stances = [];\r\n\tconst replaced = new Set();\r\n\r\n\tfor (const {\r\n\t\treplace,\r\n\t\tsourceId,\r\n\t\teffectUUID,\r\n\t\teffect,\r\n\t\timg,\r\n\t\tname,\r\n\t\titemName,\r\n\t\taction,\r\n\t} of actorStances(actor)) {\r\n\t\tif (replace) replaced.add(replace);\r\n\r\n\t\tconst foundAction = action\r\n\t\t\t? getItemWithSourceId(actor, action, \"action\")\r\n\t\t\t: getItemWithSourceId(actor, sourceId, \"feat\");\r\n\r\n\t\tstances.push({\r\n\t\t\tname,\r\n\t\t\titemName,\r\n\t\t\tuuid: sourceId,\r\n\t\t\timg,\r\n\t\t\teffectUUID,\r\n\t\t\teffectID: effect?.id,\r\n\t\t\tactionUUID: foundAction.sourceId,\r\n\t\t\tactionID: foundAction.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn stances.filter(({ uuid }) => !replaced.has(uuid));\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst inCombat = actor\r\n\t\t.getActiveTokens(true, true)\r\n\t\t.some((token) => token.inCombat);\r\n\tconst tab = html.find(\r\n\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]\",\r\n\t);\r\n\tconst options = tab.find(\".actions-options\");\r\n\tconst template = await render(\"stances/sheet\", {\r\n\t\tstances,\r\n\t\tcanUseStances: inCombat && !actor.isDead,\r\n\t\ti18n: subLocalize(\"stances\"),\r\n\t});\r\n\r\n\tif (options.length) options.after(template);\r\n\telse tab.prepend(template);\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance\",\r\n\t\t)\r\n\t\t.on(\"click\", (event) => onToggleStance(event, actor));\r\n}\r\n\r\nfunction onToggleStance(event, actor) {\r\n\tconst target = event.currentTarget;\r\n\tconst canUseStances = target\r\n\t\t.closest(\".pf2e-stances\")\r\n\t\t?.classList.contains(\"can-use-stances\");\r\n\tif (!event.ctrlKey && !canUseStances) return;\r\n\r\n\tconst effectUUID = target.dataset.effectUuid;\r\n\ttoggleStance(actor, effectUUID);\r\n}\r\n\r\nfunction* actorStances(actor) {\r\n\tfor (const feat of actor.itemTypes.feat) {\r\n\t\tconst sourceId = feat.sourceId;\r\n\r\n\t\tconst replacer = REPLACERS.get(sourceId);\r\n\t\tconst extra = EXTRAS.get(sourceId);\r\n\t\tif (!replacer && !extra && !isValidStance(feat)) continue;\r\n\r\n\t\tconst effectUUID =\r\n\t\t\treplacer?.effect ?? extra?.effect ?? feat.system.selfEffect.uuid;\r\n\t\tconst effect = fromUuidSync(effectUUID);\r\n\t\tif (!effect) continue;\r\n\r\n\t\tyield {\r\n\t\t\tname: (replacer && fromUuidSync(replacer.replace)?.name) ?? feat.name,\r\n\t\t\titemName: feat.name,\r\n\t\t\treplace: replacer?.replace,\r\n\t\t\textra,\r\n\t\t\tsourceId,\r\n\t\t\teffectUUID,\r\n\t\t\teffect: getItemWithSourceId(actor, effectUUID, \"effect\"),\r\n\t\t\taction: extra?.action,\r\n\t\t\timg: effect.img,\r\n\t\t};\r\n\t}\r\n}\r\n\r\nfunction getStancesEffects(actor) {\r\n\tconst effects = [];\r\n\r\n\tfor (const { effect } of actorStances(actor)) {\r\n\t\tif (!effect) continue;\r\n\t\teffects.push({\r\n\t\t\tuuid: effect.sourceId,\r\n\t\t\tid: effect.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn effects;\r\n}\r\n\r\nasync function toggleStance(actor, effectUUID) {\r\n\tconst effects = getStancesEffects(actor);\r\n\tconst already = effects.findIndex((effect) => effect.uuid === effectUUID);\r\n\r\n\tlet create = false;\r\n\r\n\tif (already === -1) {\r\n\t\tcreate = true;\r\n\t} else {\r\n\t\tconst other = effects.filter((effect) => effect.uuid !== effectUUID).length;\r\n\t\tconst more =\r\n\t\t\teffects.filter((effect) => effect.uuid === effectUUID).length > 1;\r\n\t\tif (other || more) effects.splice(already, 1);\r\n\t}\r\n\r\n\tif (effects.length) {\r\n\t\tawait actor.deleteEmbeddedDocuments(\r\n\t\t\t\"Item\",\r\n\t\t\teffects.map((x) => x.id),\r\n\t\t);\r\n\t}\r\n\r\n\tif (create) addStance(actor, effectUUID);\r\n}\r\n\r\nasync function addStance(actor, uuid) {\r\n\tconst effect = await fromUuid(uuid);\r\n\r\n\tif (effect) {\r\n\t\tconst obj = effect.toObject();\r\n\t\tif (!getProperty(obj, \"flags.core.sourceId\"))\r\n\t\t\tsetProperty(obj, \"flags.core.sourceId\", effect.uuid);\r\n\r\n\t\tconst items = await actor.createEmbeddedDocuments(\"Item\", [obj]);\r\n\t\titems[0]?.toMessage();\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n\r\nfunction deleteCombat(combat) {\r\n\tfor (const combatant of combat.combatants) {\r\n\t\tdeleteCombatant(combatant);\r\n\t}\r\n}\r\n\r\nfunction deleteCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isOwner(actor)) {\r\n\t\tconst effects = getStancesEffects(actor).map((effect) => effect.id);\r\n\t\tif (effects.length) actor.deleteEmbeddedDocuments(\"Item\", effects);\r\n\t}\r\n\r\n\tactor.sheet.render();\r\n}\r\n\r\nfunction createCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isOwner(actor)) checkForSavant(actor);\r\n\r\n\tactor.sheet.render();\r\n}\r\n\r\nfunction getActorFromCombatant(combatant) {\r\n\tconst actor = combatant.actor;\r\n\tif (actor && !actor.isToken && actor.isOfType(\"character\")) return actor;\r\n}\r\n\r\nasync function checkForSavant(actor) {\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst hasStancesEffects = stances.filter(({ effectID }) => effectID).length;\r\n\tif (hasStancesEffects) return;\r\n\r\n\tconst hasSavantFeat = hasItemWithSourceId(actor, STANCE_SAVANT, [\"feat\"]);\r\n\tif (!hasSavantFeat) return;\r\n\r\n\tif (stances.length === 1) {\r\n\t\tconst stance = stances[0];\r\n\t\tif (await addStance(actor, stance.effectUUID))\r\n\t\t\tinfo(\"stances.useStance\", { stance: stance.name });\r\n\t} else {\r\n\t\topenStancesMenu(actor, stances);\r\n\t}\r\n}\r\n\r\nasync function openStancesMenu(actor, stances) {\r\n\tconst localize = subLocalize(\"stances.menu\");\r\n\r\n\tnew Dialog({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await render(\"stances/menu\", {\r\n\t\t\tstances,\r\n\t\t\ti18n: localize.template,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tyes: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-people-arrows\"></i>',\r\n\t\t\t\tlabel: localize(\"accept\"),\r\n\t\t\t\tcallback: (html) =>\r\n\t\t\t\t\taddStance(actor, html.find(\"[name=stance]:checked\").val()),\r\n\t\t\t},\r\n\t\t\tno: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n\t\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\t},\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "import {\r\n\tgetSetting,\r\n\tlocaleCompare,\r\n\tlocalizePath,\r\n\tordinalString,\r\n\trefreshActorSheets,\r\n\tspellSlotGroupIdToNumber,\r\n\tsubLocalize,\r\n} from \"module-api\";\r\nimport {\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../actor-sheet\";\r\nimport { calledIfSetting } from \"../misc\";\r\n\r\nexport const summaryOptions = {\r\n\tname: \"summary\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"summary\",\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"disabled\",\r\n\t\t\tscope: \"client\",\r\n\t\t\tchoices: [\"disabled\", \"enabled\", \"sort\"],\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t],\r\n\tconflicts: [\"pf2e-spells-summary\"],\r\n\tready: calledIfSetting(setup, \"summary\"),\r\n};\r\n\r\nfunction setup(value) {\r\n\tif (value !== \"disabled\") {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"spellcasting\",\r\n\t\t\ttemplateFolder: \"summary/sheet\",\r\n\t\t\tbeforeSelector: \".spell-collections [data-tab=known-spells]\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"spellcasting\");\r\n\t}\r\n\r\n\trefreshActorSheets(\"character\");\r\n}\r\n\r\nfunction addEvents(html, sheet, actor) {\r\n\tconst inputs = html.find(\".spell-type .uses .spell-slots-input input\");\r\n\tinputs.on(\"change\", (event) => onUsesInputChange(event, actor));\r\n\tinputs.on(\"focus\", onUsesInputFocus);\r\n\tinputs.on(\"blur\", onUsesInputBlur);\r\n\r\n\thtml\r\n\t\t.find(\".focus-pips\")\r\n\t\t.on(\"click contextmenu\", (event) => onToggleFocusPool(event, actor));\r\n\r\n\thtml\r\n\t\t.find(\".spell-slots-increment-reset\")\r\n\t\t.on(\"click\", (event) => onSlotsReset(event, sheet, actor));\r\n\r\n\thtml.find(\".item-image\").on(\"click\", (event) => onItemToChat(event, actor));\r\n}\r\n\r\nasync function onUsesInputChange(event, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { inputPath, entryId } = $(event.currentTarget).data();\r\n\tconst value = event.currentTarget.valueAsNumber;\r\n\tactor.updateEmbeddedDocuments(\"Item\", [{ _id: entryId, [inputPath]: value }]);\r\n}\r\n\r\nfunction onUsesInputFocus(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.add(\"hover\");\r\n}\r\n\r\nfunction onUsesInputBlur(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.remove(\"hover\");\r\n}\r\n\r\nfunction onToggleFocusPool(event, actor) {\r\n\tevent.preventDefault();\r\n\tconst change = event.type === \"click\" ? 1 : -1;\r\n\tconst points = (actor.system.resources.focus?.value ?? 0) + change;\r\n\tactor.update({ \"system.resources.focus.value\": points });\r\n}\r\n\r\nfunction onChargesReset(sheet, actor, entryId) {\r\n\tif (game.modules.get(\"pf2e-staves\")?.active) {\r\n\t\tconst original = getSpellcastingTab(sheet.element).find(\r\n\t\t\t\".directory-list.spellcastingEntry-list\",\r\n\t\t);\r\n\t\tconst entry = original.find(\r\n\t\t\t`.item-container.spellcasting-entry[data-item-id=${entryId}]`,\r\n\t\t);\r\n\t\tconst btn = entry.find(\r\n\t\t\t\".spell-ability-data .statistic-values a.pf2e-staves-charge\",\r\n\t\t);\r\n\t\tbtn[0]?.click();\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst dailies = game.modules.get(\"pf2e-dailies\");\r\n\tif (!dailies?.active) return;\r\n\r\n\tconst entry = actor.spellcasting.get(entryId);\r\n\tdailies.api.updateEntryCharges(entry, 9999);\r\n}\r\n\r\nfunction onSlotsReset(event, sheet, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { itemId, rank, isCharge } = $(event.currentTarget).data();\r\n\tif (!itemId) return;\r\n\r\n\tif (isCharge) {\r\n\t\tonChargesReset(sheet, actor, itemId);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst item = actor.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tif (item.isOfType(\"consumable\")) {\r\n\t\tconst max = item.system.uses?.max;\r\n\t\tif (max) item.update({ \"system.uses.value\": max });\r\n\t} else if (item.isOfType(\"spellcastingEntry\")) {\r\n\t\tconst slotLevel = rank >= 0 && rank <= 11 ? `slot${rank}` : \"slot0\";\r\n\t\tconst slot = item.system.slots?.[slotLevel];\r\n\t\tif (slot) item.update({ [`system.slots.${slotLevel}.value`]: slot.max });\r\n\t} else if (item.isOfType(\"spell\")) {\r\n\t\tconst max = item.system.location.uses?.max;\r\n\t\tif (max) item.update({ \"system.location.uses.value\": max });\r\n\t}\r\n}\r\n\r\nasync function onItemToChat(event, actor) {\r\n\tconst { entryId, itemId, castRank } =\r\n\t\tevent.currentTarget.closest(\".item\").dataset;\r\n\r\n\tconst collection = actor.spellcasting.collections.get(entryId);\r\n\tif (!collection) return;\r\n\r\n\tconst spell = collection.get(itemId);\r\n\tspell?.toMessage(event, { data: { castRank: Number(castRank ?? NaN) } });\r\n}\r\n\r\nfunction getSpellcastingTab(html) {\r\n\treturn html.find(\r\n\t\t\"section.sheet-body .sheet-content > .tab[data-tab=spellcasting]\",\r\n\t);\r\n}\r\n\r\nasync function getData(actor) {\r\n\tconst focusPool = actor.system.resources.focus ?? { value: 0, max: 0 };\r\n\tconst pf2eStavesActive = game.modules.get(\"pf2e-staves\")?.active;\r\n\tconst pf2eDailies = game.modules.get(\"pf2e-dailies\");\r\n\tconst pf2eDailiesActive = pf2eDailies?.active;\r\n\tconst stavesActive =\r\n\t\tpf2eStavesActive ||\r\n\t\t(pf2eDailiesActive && isNewerVersion(pf2eDailies.version, \"2.14.0\"));\r\n\tconst chargesPath = pf2eStavesActive\r\n\t\t? \"flags.pf2e-staves.charges\"\r\n\t\t: pf2eDailiesActive\r\n\t\t  ? \"flags.pf2e-dailies.staff.charges\"\r\n\t\t  : \"\";\r\n\r\n\tconst spells = [];\r\n\tconst focuses = [];\r\n\r\n\tlet rituals;\r\n\tlet hasFocusCantrips = false;\r\n\r\n\tconst entries = await Promise.all(\r\n\t\tactor.spellcasting.collections.map(async (spells) => {\r\n\t\t\treturn {\r\n\t\t\t\tentry: spells.entry,\r\n\t\t\t\tdata: await spells.entry.getSheetData({ spells }),\r\n\t\t\t};\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const { entry, data } of entries) {\r\n\t\tif (data.isRitual) {\r\n\t\t\trituals = data.groups.flatMap((slot, slotId) =>\r\n\t\t\t\tslot.active\r\n\t\t\t\t\t.map(({ spell }) => ({\r\n\t\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\t\tslotId,\r\n\t\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\t\trank: spell.rank,\r\n\t\t\t\t\t\ttime: spell.system.time.value,\r\n\t\t\t\t\t}))\r\n\t\t\t\t\t.filter(Boolean),\r\n\t\t\t);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst entryId = data.id;\r\n\t\tconst entryDc = data.statistic.dc.value;\r\n\t\tconst entryName = data.name;\r\n\t\tconst isFocus = data.isFocusPool;\r\n\t\tconst isCharge = entry.system?.prepared?.value === \"charge\";\r\n\t\tconst isInnate = data.isInnate;\r\n\t\tconst isPrepared = data.isPrepared;\r\n\t\tconst isSpontaneous = data.isSpontaneous;\r\n\t\tconst isFlexible = data.isFlexible;\r\n\r\n\t\tconst consumable = (() => {\r\n\t\t\tif (data.category !== \"items\") return;\r\n\t\t\tconst itemId = entry.id.split(\"-\")[0];\r\n\t\t\treturn actor.items.get(itemId);\r\n\t\t})();\r\n\r\n\t\tconst charges = (() => {\r\n\t\t\tif (!isCharge) return;\r\n\r\n\t\t\tconst dailiesData =\r\n\t\t\t\tpf2eDailiesActive &&\r\n\t\t\t\tpf2eDailies.api.getSpellcastingEntryStaffData(entry);\r\n\t\t\tconst { charges, max, canPayCost } = dailiesData ??\r\n\t\t\t\tgetProperty(entry, \"flags.pf2e-staves.charges\") ?? {\r\n\t\t\t\t\tcharges: 0,\r\n\t\t\t\t\tmax: 0,\r\n\t\t\t\t};\r\n\r\n\t\t\treturn {\r\n\t\t\t\tvalue: charges,\r\n\t\t\t\tmax,\r\n\t\t\t\tnoMax: true,\r\n\t\t\t\tcanPayCost: canPayCost ?? (() => true),\r\n\t\t\t};\r\n\t\t})();\r\n\r\n\t\tfor (const group of data.groups) {\r\n\t\t\tif (!group.active.length || group.uses?.max === 0) continue;\r\n\r\n\t\t\tconst slotSpells = [];\r\n\t\t\tconst isCantrip = group.id === \"cantrips\";\r\n\t\t\tconst groupNumber = spellSlotGroupIdToNumber(group.id);\r\n\t\t\tconst isBroken = !isCantrip && isCharge && !stavesActive;\r\n\r\n\t\t\tfor (let slotId = 0; slotId < group.active.length; slotId++) {\r\n\t\t\t\tconst active = group.active[slotId];\r\n\t\t\t\tif (!active || active.uses?.max === 0) continue;\r\n\r\n\t\t\t\tconst { spell, expended, virtual, uses, castRank } = active;\r\n\r\n\t\t\t\tslotSpells.push({\r\n\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\trange: spell.system.range.value || \"-  \",\r\n\t\t\t\t\tcastRank: castRank ?? spell.rank,\r\n\t\t\t\t\tslotId,\r\n\t\t\t\t\tentryId,\r\n\t\t\t\t\tentryDc,\r\n\t\t\t\t\tentryName,\r\n\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\tinputId: isInnate ? spell.id : data.id,\r\n\t\t\t\t\tinputPath: consumable\r\n\t\t\t\t\t\t? \"system.uses.value\"\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? chargesPath\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"system.location.uses.value\"\r\n\t\t\t\t\t\t\t  : `system.slots.slot${groupNumber}.value`,\r\n\t\t\t\t\tisCharge,\r\n\t\t\t\t\tisActiveCharge: isCharge && stavesActive,\r\n\t\t\t\t\tisBroken,\r\n\t\t\t\t\tisVirtual: virtual,\r\n\t\t\t\t\tisInnate,\r\n\t\t\t\t\tisCantrip,\r\n\t\t\t\t\tisFocus,\r\n\t\t\t\t\tisPrepared,\r\n\t\t\t\t\tisSpontaneous: isSpontaneous || isFlexible,\r\n\t\t\t\t\tgroupId: group.id,\r\n\t\t\t\t\tconsumable,\r\n\t\t\t\t\tuses: consumable\r\n\t\t\t\t\t\t? consumable.system.uses\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? charges\r\n\t\t\t\t\t\t  : uses ?? group.uses,\r\n\t\t\t\t\texpended:\r\n\t\t\t\t\t\tisCharge && !isCantrip\r\n\t\t\t\t\t\t\t? !charges.canPayCost(groupNumber)\r\n\t\t\t\t\t\t\t: expended ??\r\n\t\t\t\t\t\t\t  (isFocus && !isCantrip ? focusPool.value <= 0 : false),\r\n\t\t\t\t\taction: spell.system.time.value,\r\n\t\t\t\t\ttype: consumable\r\n\t\t\t\t\t\t? `PF2E.Item.Consumable.Category.${consumable.category}`\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? localizePath(\"summary.staff\")\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeInnate\"\r\n\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeSpontaneous\"\r\n\t\t\t\t\t\t\t\t  : isFlexible\r\n\t\t\t\t\t\t\t\t\t  ? \"PF2E.SpellFlexibleLabel\"\r\n\t\t\t\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.TraitFocus\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.SpellPreparedLabel\",\r\n\t\t\t\t\torder: isCharge\r\n\t\t\t\t\t\t? 0\r\n\t\t\t\t\t\t: isPrepared\r\n\t\t\t\t\t\t  ? 1\r\n\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t  ? 2\r\n\t\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t\t  ? 3\r\n\t\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t\t  ? 4\r\n\t\t\t\t\t\t\t\t\t  : 5,\r\n\t\t\t\t\tnoHover: isPrepared || isCantrip || isBroken || isFocus,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (slotSpells.length) {\r\n\t\t\t\tif (isFocus) {\r\n\t\t\t\t\tif (isCantrip) hasFocusCantrips = true;\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfocuses.push(...slotSpells);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tspells[groupNumber] ??= [];\r\n\t\t\t\tspells[groupNumber].push(...slotSpells);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (spells.length) {\r\n\t\tconst sort =\r\n\t\t\tgetSetting(\"summary\") === \"sort\"\r\n\t\t\t\t? (a, b) =>\r\n\t\t\t\t\t\ta.order === b.order\r\n\t\t\t\t\t\t\t? localeCompare(a.name, b.name)\r\n\t\t\t\t\t\t\t: a.order - b.order\r\n\t\t\t\t: (a, b) => localeCompare(a.name, b.name);\r\n\r\n\t\tfor (const entry of spells) {\r\n\t\t\tif (!entry) continue;\r\n\t\t\tentry.sort(sort);\r\n\t\t}\r\n\t}\r\n\r\n\tif (focuses.length) {\r\n\t\tfocuses.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\tspells[12] = focuses;\r\n\t\thasFocusCantrips = false;\r\n\t}\r\n\r\n\treturn {\r\n\t\tspells,\r\n\t\trituals,\r\n\t\tfocusPool,\r\n\t\thasFocusCantrips,\r\n\t\tisOwner: actor.isOwner,\r\n\t\ti18n: subLocalize(\"summary\"),\r\n\t\tentryRank: (rank) =>\r\n\t\t\tgame.i18n.format(\"PF2E.Item.Spell.Rank.Ordinal\", {\r\n\t\t\t\trank: ordinalString(rank),\r\n\t\t\t}),\r\n\t};\r\n}\r\n", "import {\r\n    DegreeOfSuccess,\r\n    MODULE,\r\n    applyDamageFromMessage,\r\n    deleteInMemory,\r\n    getFlag,\r\n    getInMemory,\r\n    getSetting,\r\n    hasEmbeddedSpell,\r\n    info,\r\n    isActiveGM,\r\n    latestChatMessages,\r\n    localize,\r\n    localizePath,\r\n    moduleFlagUpdate,\r\n    onClickShieldBlock,\r\n    registerWrapper,\r\n    render,\r\n    setFlag,\r\n    setInMemory,\r\n    subLocalize,\r\n    toggleOffShieldBlock,\r\n    updateSourceFlag,\r\n    warn,\r\n} from \"module-api\";\r\nimport { bindOnPreCreateSpellDamageChatMessage } from \"../chat\";\r\nimport { createTool } from \"../tool\";\r\n\r\nconst SAVES = {\r\n    fortitude: { icon: \"fa-solid fa-chess-rook\", label: \"PF2E.SavesFortitude\" },\r\n    reflex: { icon: \"fa-solid fa-person-running\", label: \"PF2E.SavesReflex\" },\r\n    will: { icon: \"fa-solid fa-brain\", label: \"PF2E.SavesWill\" },\r\n};\r\n\r\nconst REROLL = {\r\n    hero: {\r\n        icon: \"fa-solid fa-hospital-symbol\",\r\n        reroll: \"PF2E.RerollMenu.HeroPoint\",\r\n        rerolled: \"PF2E.RerollMenu.MessageHeroPoint\",\r\n    },\r\n    new: {\r\n        icon: \"fa-solid fa-dice\",\r\n        reroll: \"PF2E.RerollMenu.KeepNew\",\r\n        rerolled: \"PF2E.RerollMenu.MessageKeep.new\",\r\n    },\r\n    lower: {\r\n        icon: \"fa-solid fa-dice-one\",\r\n        reroll: \"PF2E.RerollMenu.KeepLower\",\r\n        rerolled: \"PF2E.RerollMenu.MessageKeep.lower\",\r\n    },\r\n    higher: {\r\n        icon: \"fa-solid fa-dice-six\",\r\n        reroll: \"PF2E.RerollMenu.KeepHigher\",\r\n        rerolled: \"PF2E.RerollMenu.MessageKeep.higher\",\r\n    },\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS = [\"criticalFailure\", \"failure\", \"success\", \"criticalSuccess\"];\r\n\r\nconst TEXTEDITOR_ENRICH_HTML = \"TextEditor.enrichHTML\";\r\nconst CHATLOG_ACTIVATE_LISTENERS = \"ChatLog.prototype.activateListeners\";\r\n\r\nexport const targetOptions = {\r\n    name: \"target\",\r\n    settings: [\r\n        {\r\n            key: \"target\",\r\n            type: Boolean,\r\n            default: false,\r\n            requiresReload: true,\r\n        },\r\n        {\r\n            key: \"target-client\",\r\n            type: String,\r\n            default: \"disabled\",\r\n            choices: [\"disabled\", \"small\", \"big\"],\r\n            scope: \"client\",\r\n        },\r\n    ],\r\n    hideSettings: [\r\n        {\r\n            global: \"target\",\r\n            settings: [\"target-client\"],\r\n        },\r\n    ],\r\n    socket: onSocket,\r\n    init: (isGM) => {\r\n        if (!getSetting(\"target\")) return;\r\n\r\n        socket.activate();\r\n\r\n        if (isGM) {\r\n            Hooks.on(\"getChatLogEntryContext\", getChatLogEntryContext);\r\n        }\r\n\r\n        registerWrapper(TEXTEDITOR_ENRICH_HTML, textEditorEnrichHTML);\r\n        registerWrapper(CHATLOG_ACTIVATE_LISTENERS, chatActivateListeners);\r\n\r\n        document.body.addEventListener(\"dragstart\", onDragStart, true);\r\n\r\n        Hooks.on(\"preCreateChatMessage\", preCreateChatMessage);\r\n    },\r\n    ready: (isGM) => {\r\n        if (!getSetting(\"target\")) return;\r\n\r\n        Hooks.on(\"renderChatMessage\", renderChatMessage);\r\n\r\n        for (const { message, html } of latestChatMessages(10)) {\r\n            renderChatMessage(message, html);\r\n        }\r\n    },\r\n};\r\n\r\nconst { socket } = createTool(targetOptions);\r\n\r\nfunction onSocket(packet, userId) {\r\n    const activeGM = isActiveGM();\r\n\r\n    switch (packet.type) {\r\n        case \"update-save\": {\r\n            activeGM && updateMessageSave(packet);\r\n            break;\r\n        }\r\n        case \"update-applied\": {\r\n            activeGM && updateMessageApplied(packet);\r\n            break;\r\n        }\r\n        case \"dice-so-nice\": {\r\n            game.user.id !== userId && roll3dDice(packet.roll, packet.target, true);\r\n            break;\r\n        }\r\n    }\r\n}\r\n\r\nasync function roll3dDice(rollData, targetData, self = false) {\r\n    if (!game.modules.get(\"dice-so-nice\")?.active) return;\r\n\r\n    const target = targetData instanceof TokenDocument ? targetData : await fromUuid(targetData);\r\n\r\n    const user = game.user;\r\n    const roll = rollData instanceof Roll ? rollData : Roll.fromData(rollData);\r\n\r\n    const synchronize = !self && game.settings.get(\"pf2e\", \"metagame_showBreakdowns\");\r\n\r\n    if (!self && !synchronize) {\r\n        socket.emit({\r\n            type: \"dice-so-nice\",\r\n            roll: roll.toJSON(),\r\n            target: target?.uuid,\r\n        });\r\n    } else if (self) {\r\n        if (!user.isGM && !target?.playersCanSeeName) {\r\n            roll.ghost = true;\r\n        }\r\n    }\r\n\r\n    return game.dice3d.showForRoll(roll, user, synchronize);\r\n}\r\n\r\nconst INLINE_CHECK_REGEX = /(class=\"inline-check[\\w0-9 -]*\")/g;\r\nfunction textEditorEnrichHTML(wrapped, ...args) {\r\n    let enriched = wrapped(...args);\r\n\r\n    if (typeof enriched === \"string\") {\r\n        enriched = enriched.replace(INLINE_CHECK_REGEX, \"$1 draggable='true'\");\r\n        return enriched;\r\n    }\r\n\r\n    return Promise.resolve().then(async () => {\r\n        enriched = await enriched;\r\n        return enriched.replace(INLINE_CHECK_REGEX, \"$1 draggable='true'\");\r\n    });\r\n}\r\n\r\nfunction chatActivateListeners(wrapped, html) {\r\n    wrapped(html);\r\n    html[0].addEventListener(\"drop\", onChatMessageDrop);\r\n}\r\n\r\nfunction onChatMessageDrop(event) {\r\n    const target = event.target.closest(\"li.chat-message\");\r\n    if (!target) return;\r\n\r\n    const { isBasic, pf2Dc, pf2Check, type, pf2RollOptions, pf2Traits } =\r\n        TextEditor.getDragEventData(event);\r\n    if (type !== `${MODULE.id}-check-roll`) return;\r\n\r\n    const messageId = target.dataset.messageId;\r\n    const message = game.messages.get(messageId);\r\n    if (!message || !message.isDamageRoll) return;\r\n\r\n    if (!game.user.isGM && !message.isAuthor) {\r\n        warn(\"target.chat.drop.unauth\");\r\n        return;\r\n    }\r\n\r\n    if (getFlag(message, \"target.save\")) {\r\n        warn(\"target.chat.drop.already\");\r\n        return;\r\n    }\r\n\r\n    setFlag(message, \"target\", {\r\n        rollOptions: [\r\n            ...(pf2Traits?.split(\",\").map((o) => o.trim()) ?? []),\r\n            ...(pf2RollOptions?.split(\",\").map((o) => o.trim()) ?? []),\r\n        ],\r\n        save: {\r\n            basic: isBasic,\r\n            dc: Number(pf2Dc),\r\n            statistic: pf2Check,\r\n        },\r\n    });\r\n\r\n    info(\"target.chat.drop.added\");\r\n}\r\n\r\nlet BASIC_SAVE_REGEX;\r\nfunction onDragStart(event) {\r\n    const { target, dataTransfer } = event;\r\n    if (\r\n        !dataTransfer ||\r\n        !(target instanceof HTMLAnchorElement) ||\r\n        !target.classList.contains(\"inline-check\")\r\n    )\r\n        return;\r\n\r\n    const data = {\r\n        ...target.dataset,\r\n        type: `${MODULE.id}-check-roll`,\r\n    };\r\n\r\n    if (!data.pf2Dc || ![\"reflex\", \"will\", \"fortitude\"].includes(data.pf2Check)) {\r\n        event.preventDefault();\r\n        return;\r\n    }\r\n\r\n    event.stopPropagation();\r\n\r\n    if (data.isBasic == null) {\r\n        const label = target.querySelector(\"span.label\")?.lastChild.textContent.trim();\r\n\r\n        if (label) {\r\n            if (!BASIC_SAVE_REGEX) {\r\n                const saves = Object.values(CONFIG.PF2E.saves).map((x) => game.i18n.localize(x));\r\n                const joined = game.i18n.format(\"PF2E.InlineCheck.BasicWithSave\", {\r\n                    save: `(${saves.join(\"|\")})`,\r\n                });\r\n                BASIC_SAVE_REGEX = new RegExp(joined);\r\n            }\r\n\r\n            data.isBasic = BASIC_SAVE_REGEX.test(label);\r\n        } else {\r\n            data.isBasic = false;\r\n        }\r\n    }\r\n\r\n    dataTransfer.setData(\"text/plain\", JSON.stringify(data));\r\n}\r\n\r\nfunction getChatLogEntryContext(_, data) {\r\n    const getMessageData = (html) => {\r\n        const messageId = html.data(\"messageId\");\r\n        const message = game.messages.get(messageId);\r\n        if (!message) return;\r\n\r\n        const inMemory = getInMemory(message, \"target\");\r\n        if (!inMemory) return;\r\n\r\n        return {\r\n            message,\r\n            inMemory,\r\n        };\r\n    };\r\n\r\n    data.unshift({\r\n        icon: '<i class=\"fa-solid fa-dice-d20\"></i>',\r\n        name: localizePath(\"target.chat.context.saves.name\"),\r\n        condition: (html) => {\r\n            const data = getMessageData(html);\r\n            return !!data?.inMemory.canRollSave?.length;\r\n        },\r\n        callback: (html) => {\r\n            const { inMemory, message } = getMessageData(html) ?? {};\r\n            const canRollSave = inMemory.canRollSave;\r\n            if (!canRollSave?.length) return;\r\n\r\n            const save = getSaveData(message);\r\n            if (!save) return;\r\n\r\n            rollSave(\r\n                {\r\n                    target: html.find(\".pf2e-toolbelt-target-damage\")[0],\r\n                },\r\n                message,\r\n                save,\r\n                canRollSave\r\n            );\r\n        },\r\n    });\r\n}\r\n\r\nlet HEALINGS_REGEX;\r\nfunction isRegenMessage(message) {\r\n    HEALINGS_REGEX ??= (() => {\r\n        const healings = [\r\n            game.i18n.localize(\"PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage\"),\r\n            game.i18n.localize(\"PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage\"),\r\n        ];\r\n        return new RegExp(`^<div>(${healings.join(\"|\")})</div>`);\r\n    })();\r\n    return HEALINGS_REGEX.test(message.flavor);\r\n}\r\n\r\nfunction isValidDamageMessage(message) {\r\n    return !message.rolls[0].options.evaluatePersistent;\r\n}\r\n\r\nfunction preCreateChatMessage(message) {\r\n    const isDamageRoll = message.isDamageRoll;\r\n    const updates = [];\r\n\r\n    if (isDamageRoll && !isValidDamageMessage(message)) return;\r\n\r\n    if (isDamageRoll && !getFlag(message, \"target\")) {\r\n        const token = message.token;\r\n        const actor = token?.actor;\r\n        const isRegen = isRegenMessage(message);\r\n\r\n        const targets = isRegen\r\n            ? actor\r\n                ? [{ token: token.uuid, actor: actor.uuid }]\r\n                : []\r\n            : getTargets();\r\n\r\n        updates.push([\"targets\", targets]);\r\n        if (isRegen) updates.push([\"isRegen\", true]);\r\n\r\n        if (message.rolls.length === 2) {\r\n            const rolls = message.rolls.filter((roll) => roll.options);\r\n            const splashRollIndex = rolls.findIndex((roll) => roll.options.splashOnly);\r\n            const regularRollIndex = rolls.findIndex(\r\n                (roll) =>\r\n                    !roll.options.splashOnly &&\r\n                    roll.options.damage?.modifiers.some(\r\n                        (modifier) => modifier.damageCategory === \"splash\"\r\n                    )\r\n            );\r\n\r\n            if (splashRollIndex !== -1 && regularRollIndex !== -1) {\r\n                updates.push([\"splashIndex\", splashRollIndex]);\r\n            }\r\n        }\r\n    }\r\n\r\n    if (isDamageRoll || message.getFlag(\"pf2e\", \"context.type\") === \"spell-cast\") {\r\n        const item = message.item;\r\n        const save = item && item.type === \"spell\" && item.system.defense?.save;\r\n        if (save) {\r\n            const dc = item.spellcasting?.statistic.dc.value;\r\n            if (typeof dc === \"number\") updates.push([\"save\", { ...save, dc }]);\r\n        }\r\n    }\r\n\r\n    if (!updates.length) return;\r\n\r\n    updateSourceFlag(\r\n        message,\r\n        \"target\",\r\n        updates.reduce((acc, [key, value]) => {\r\n            acc[key] = value;\r\n            return acc;\r\n        }, {})\r\n    );\r\n}\r\n\r\nasync function renderChatMessage(message, html) {\r\n    const clientEnabled = getSetting(\"target-client\") !== \"disabled\";\r\n    deleteInMemory(message, \"target.canRollSave\");\r\n\r\n    if (clientEnabled && message.isDamageRoll) {\r\n        if (!isValidDamageMessage(message)) return;\r\n        await renderDamageChatMessage(message, html);\r\n        refreshMessage(message);\r\n        return;\r\n    }\r\n\r\n    const item = message.item;\r\n    if (!item || item.type !== \"spell\") return;\r\n\r\n    if (clientEnabled && !item.damageKinds.size) {\r\n        await renderSpellChatMessage(message, html, item);\r\n        refreshMessage(message);\r\n        return;\r\n    }\r\n\r\n    // we remove that\r\n    if (item.system.defense?.save && hasEmbeddedSpell(message)) {\r\n        html.find(\"[data-action=spell-damage]\").on(\"click\", () => {\r\n            bindOnPreCreateSpellDamageChatMessage(message);\r\n        });\r\n    }\r\n}\r\n\r\nfunction refreshMessage(message) {\r\n    Promise.all(\r\n        [ui.chat, ui.chat._popout].map(async (chat) => {\r\n            const el = chat?.element[0]?.querySelector(\"#chat-log\");\r\n            if (!el || (!chat.isAtBottom && message.user._id !== game.user._id)) return;\r\n\r\n            await chat._waitForImages();\r\n            el.scrollTop = el.scrollHeight;\r\n        })\r\n    );\r\n\r\n    for (const app of Object.values(message.apps)) {\r\n        if (!(app instanceof ChatPopout)) continue;\r\n        if (!app.rendered) continue;\r\n\r\n        app.setPosition();\r\n    }\r\n}\r\n\r\nasync function renderSpellChatMessage(message, html, spell) {\r\n    const data = await getMessageData(message);\r\n    if (!data) return;\r\n\r\n    const { targets, save } = data;\r\n    const msgContent = html.find(\".message-content\");\r\n    const cardBtns = msgContent.find(\".card-buttons\");\r\n\r\n    if (game.user.isGM || message.isAuthor) {\r\n        const saveBtn = cardBtns.find(\"[data-action=spell-save]\");\r\n        const wrapper = $('<div class=\"pf2e-toolbelt-target-wrapper\"></div>');\r\n        const targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n\r\n        const targetsBtn =\r\n            $(`<button class=\"pf2e-toolbelt-target-targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n        targetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n        wrapper.append(targetsBtn);\r\n        wrapper.append(saveBtn);\r\n        cardBtns.prepend(wrapper);\r\n    }\r\n\r\n    if (spell?.area && !spell.traits.has(\"aura\")) {\r\n        const template = canvas.scene?.templates.some(\r\n            (template) => template.message === message && template.isOwner\r\n        );\r\n        if (template) cardBtns.find(\".owner-buttons .hidden.small\").removeClass(\"hidden\");\r\n    }\r\n\r\n    if (!targets.length) return;\r\n\r\n    const rowsTemplate = $('<div class=\"pf2e-toolbelt-target-spell\"></div>');\r\n\r\n    for (const { template } of targets) {\r\n        rowsTemplate.append(\"<hr>\");\r\n        rowsTemplate.append(template);\r\n    }\r\n\r\n    msgContent.after(rowsTemplate);\r\n\r\n    addHeaderListeners(message, rowsTemplate, save);\r\n}\r\n\r\nfunction getTargets() {\r\n    return Array.from(\r\n        game.user.targets\r\n            .filter((target) => target.actor)\r\n            .map((target) => ({\r\n                token: target.document.uuid,\r\n                actor: target.actor.uuid,\r\n            }))\r\n    );\r\n}\r\n\r\nfunction addTargets(event, message) {\r\n    event.stopPropagation();\r\n    setFlag(message, \"target.targets\", getTargets());\r\n}\r\n\r\nasync function renderDamageChatMessage(message, html) {\r\n    const data = await getMessageData(message);\r\n    const msgContent = html.find(\".message-content\");\r\n    const damageRows = msgContent.find(\".damage-application\");\r\n\r\n    const buttons = $('<div class=\"pf2e-toolbelt-target-buttons\"></div>');\r\n\r\n    if (data?.targets.length && damageRows.length) {\r\n        const toggleDamageRow = () => {\r\n            const expanded = !!getInMemory(message, \"target.expanded\");\r\n            toggleBtn.toggleClass(\"collapse\", expanded);\r\n            damageRows.toggleClass(\"hidden\", !expanded);\r\n        };\r\n\r\n        const toggleTooltip = localize(\"target.chat.toggle.tooltip\");\r\n        const toggleBtn = $(`<button class=\"toggle\" title=\"${toggleTooltip}\">\r\n    <i class=\"fa-solid fa-plus expand\"></i>\r\n    <i class=\"fa-solid fa-minus collapse\"></i>\r\n</button>`);\r\n\r\n        toggleDamageRow();\r\n\r\n        toggleBtn.on(\"click\", (event) => {\r\n            event.stopPropagation();\r\n            setInMemory(message, \"target.expanded\", !getInMemory(message, \"target.expanded\"));\r\n            toggleDamageRow();\r\n        });\r\n\r\n        buttons.append(toggleBtn);\r\n    }\r\n\r\n    if (data?.isRegen !== true && (game.user.isGM || message.isAuthor)) {\r\n        const targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n        const targetsBtn = $(`<button class=\"targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n        targetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n        buttons.append(targetsBtn);\r\n    }\r\n\r\n    html.find(\".dice-result .dice-total\").append(buttons);\r\n\r\n    if (!data?.targets.length) return;\r\n\r\n    const clonedRows = damageRows.clone();\r\n    if (!clonedRows.length) return;\r\n\r\n    clonedRows.removeClass(\"damage-application\").addClass(\"target-damage-application\");\r\n\r\n    if (getSetting(\"target-client\") !== \"big\") clonedRows.find(\"button\").addClass(\"small\");\r\n\r\n    clonedRows.find(\"[data-action]\").each(function () {\r\n        const action = this.dataset.action;\r\n        this.dataset.action = `target-${action}`;\r\n    });\r\n\r\n    const { targets, save } = data;\r\n    const rowsTemplate = $('<div class=\"pf2e-toolbelt-target-damage\"></div>');\r\n\r\n    for (const { uuid, template, save, isOwner, applied = {} } of targets) {\r\n        rowsTemplate.append(\"<hr>\");\r\n        rowsTemplate.append(template);\r\n\r\n        if (!isOwner) continue;\r\n\r\n        const isBasicSave = !!(save?.result && save.basic);\r\n        const clones = clonedRows.clone();\r\n\r\n        clones.each((index, el) => {\r\n            el.dataset.rollIndex = index;\r\n            el.dataset.targetUuid = uuid;\r\n\r\n            el.classList.toggle(\r\n                \"applied\",\r\n                !!applied[index] || (isBasicSave && save.result.success === \"criticalSuccess\")\r\n            );\r\n            if (isBasicSave) el.classList.add(save.result.success);\r\n        });\r\n\r\n        rowsTemplate.append(clones);\r\n    }\r\n\r\n    msgContent.after(rowsTemplate);\r\n\r\n    addHeaderListeners(message, rowsTemplate, save);\r\n    rowsTemplate\r\n        .find(\"button[data-action^=target-]\")\r\n        .on(\"click\", (event) => onTargetButton(event, message, html));\r\n}\r\n\r\nfunction getRowsElement(event) {\r\n    return event.target?.closest(\".pf2e-toolbelt-target-damage\");\r\n}\r\n\r\nfunction disableSaveListeners(event) {\r\n    getRowsElement(event)?.classList.add(\"disable-saves\");\r\n}\r\n\r\nfunction enableSaveListeners(event) {\r\n    getRowsElement(event)?.classList.remove(\"disable-saves\");\r\n}\r\n\r\nfunction addHeaderListeners(message, html, save) {\r\n    const listener = (event) => {\r\n        const target = event.target.closest(\"[data-action]\");\r\n        if (!target) return;\r\n\r\n        const dataAction = target.dataset.action;\r\n        const saveEnabled = () => {\r\n            return !getRowsElement(event)?.classList.contains(\"disable-saves\");\r\n        };\r\n\r\n        switch (dataAction) {\r\n            case \"ping-target\": {\r\n                pingTarget(event);\r\n                break;\r\n            }\r\n            case \"open-target-sheet\": {\r\n                openTargetSheet(event);\r\n                break;\r\n            }\r\n            case \"roll-save\": {\r\n                saveEnabled() && rollSave(event, message, save);\r\n                break;\r\n            }\r\n            case \"reroll-save\": {\r\n                saveEnabled() && rerollSave(event, message, save);\r\n                break;\r\n            }\r\n        }\r\n    };\r\n\r\n    html.on(\"click\", listener);\r\n}\r\n\r\nfunction getSaveData(message) {\r\n    const flag = getFlag(message, \"target.save\");\r\n    if (!flag) return;\r\n    return {\r\n        ...flag,\r\n        ...SAVES[flag.statistic],\r\n    };\r\n}\r\n\r\nasync function getMessageData(message) {\r\n    const isGM = game.user.isGM;\r\n    const targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n    const showDC = isGM || game.settings.get(\"pf2e\", \"metagame_showDC\");\r\n    const showMods = isGM || game.settings.get(\"pf2e\", \"metagame_showBreakdowns\");\r\n    const showSuccess = isGM || game.settings.get(\"pf2e\", \"metagame_showResults\");\r\n\r\n    const save = getSaveData(message);\r\n    if (!targetsFlag.length && !save) return;\r\n\r\n    if (save) {\r\n        const saveLabel = game.i18n.format(\"PF2E.SavingThrowWithName\", {\r\n            saveName: game.i18n.localize(save.label),\r\n        });\r\n        const saveDC = showDC ? localize(\"target.chat.save.dcWithValue\", { dc: save.dc }) : \"\";\r\n        save.tooltipLabel = `${saveLabel} ${saveDC}`;\r\n        save.tooltip = await render(\"target/save-tooltip\", {\r\n            check: save.tooltipLabel,\r\n        });\r\n    }\r\n\r\n    const canRollSave = [];\r\n\r\n    const targets = (\r\n        await Promise.all(\r\n            targetsFlag.map(async ({ token }) => {\r\n                const target = await fromUuid(token);\r\n                const targetId = target.id;\r\n                const actor = target.actor;\r\n                if (!actor) return;\r\n\r\n                const isVisible = !actor.hasCondition(\"undetected\");\r\n                if (!isGM && !isVisible) return;\r\n\r\n                const isOwner = actor.isOwner;\r\n                const hasPlayerOwner = actor.hasPlayerOwner;\r\n                const isFriendly = isOwner || hasPlayerOwner;\r\n                const hasSave = save && !!actor?.saves[save.statistic];\r\n                const saveFlag = getFlag(message, `target.saves.${targetId}`);\r\n\r\n                if (hasSave && !hasPlayerOwner && !saveFlag) {\r\n                    canRollSave.push(token);\r\n                }\r\n\r\n                const targetSave = await (async () => {\r\n                    if (!hasSave || !saveFlag) return;\r\n\r\n                    const rerolled = saveFlag.rerolled;\r\n                    const canReroll = hasSave && isOwner && !rerolled;\r\n                    const successLabel = game.i18n.localize(\r\n                        `PF2E.Check.Result.Degree.Check.${saveFlag.success}`\r\n                    );\r\n                    const offset = saveFlag.value - save.dc;\r\n                    const result =\r\n                        isFriendly || showSuccess\r\n                            ? localize(\r\n                                  `target.chat.save.result.${\r\n                                      showDC\r\n                                          ? \"withOffset\"\r\n                                          : isFriendly\r\n                                          ? \"withoutOffsetWithDie\"\r\n                                          : \"withoutOffset\"\r\n                                  }`,\r\n                                  {\r\n                                      success: successLabel,\r\n                                      offset: offset >= 0 ? `+${offset}` : offset,\r\n                                      die: `<i class=\"fa-solid fa-dice-d20\"></i> ${saveFlag.die}`,\r\n                                  }\r\n                              )\r\n                            : undefined;\r\n\r\n                    const adjustment =\r\n                        (isFriendly || showMods) && saveFlag.success !== saveFlag.unadjustedOutcome\r\n                            ? saveFlag.dosAdjustments[saveFlag.unadjustedOutcome]?.label\r\n                            : undefined;\r\n\r\n                    return {\r\n                        ...saveFlag,\r\n                        canReroll,\r\n                        tooltip: await render(\"target/save-tooltip\", {\r\n                            i18n: subLocalize(\"target.chat.save\").template,\r\n                            check: save.tooltipLabel,\r\n                            result,\r\n                            modifiers: isFriendly || showMods ? saveFlag.modifiers : [],\r\n                            adjustment,\r\n                            canReroll,\r\n                            rerolled: REROLL[rerolled],\r\n                        }),\r\n                    };\r\n                })();\r\n\r\n                const templateSave = save && {\r\n                    ...save,\r\n                    result: targetSave,\r\n                };\r\n\r\n                const anonymous = game.modules.get(\"anonymous\");\r\n                const canSeeName = isGM\r\n                    ? true\r\n                    : anonymous?.active\r\n                    ? anonymous.api.playersSeeName(target.actor)\r\n                    : !game.pf2e.settings.tokens.nameVisibility || target.playersCanSeeName;\r\n                const name = canSeeName\r\n                    ? target.name\r\n                    : anonymous?.active\r\n                    ? anonymous.api.getName(target.actor)\r\n                    : localize(\"unnamed\");\r\n\r\n                return {\r\n                    isOwner,\r\n                    canSeeName,\r\n                    hasPlayerOwner,\r\n                    uuid: token,\r\n                    target: target,\r\n                    save: templateSave,\r\n                    applied: getFlag(message, `target.applied.${targetId}`),\r\n                    template: await render(\"target/row-header\", {\r\n                        name,\r\n                        isGM,\r\n                        isOwner,\r\n                        hasPlayerOwner,\r\n                        isHidden: !isVisible,\r\n                        uuid: token,\r\n                        showSuccess: isFriendly || showSuccess,\r\n                        save: hasSave && templateSave,\r\n                        canReroll: targetSave?.canReroll,\r\n                        rerolled: REROLL[targetSave?.rerolled],\r\n                        i18n: subLocalize(\"target.chat.row\"),\r\n                    }),\r\n                };\r\n            })\r\n        )\r\n    ).filter(Boolean);\r\n\r\n    setInMemory(message, \"target.canRollSave\", canRollSave);\r\n\r\n    if (isGM) {\r\n        targets.sort((a, b) => a.hasPlayerOwner - b.hasPlayerOwner);\r\n    } else {\r\n        targets.sort((a, b) =>\r\n            !a.isOwner && !b.isOwner ? b.hasPlayerOwner - a.hasPlayerOwner : b.isOwner - a.isOwner\r\n        );\r\n    }\r\n\r\n    return { targets, save, isRegen: getFlag(message, \"target.isRegen\") };\r\n}\r\n\r\nasync function getTargetFromEvent(event) {\r\n    const { targetUuid } = event.target.closest(\"[data-target-uuid]\").dataset;\r\n    return fromUuid(targetUuid);\r\n}\r\n\r\nasync function rerollSave(event, message, { dc }) {\r\n    const target = await getTargetFromEvent(event);\r\n    const actor = target?.actor;\r\n    if (!actor) return;\r\n\r\n    const flag = getFlag(message, `target.saves.${target.id}`);\r\n    if (!flag?.roll || flag.rerolled) return;\r\n\r\n    const heroPoints = actor.isOfType(\"character\") ? actor.heroPoints.value : 0;\r\n\r\n    const template = Object.entries(REROLL)\r\n        .map(([type, { icon, reroll }]) => {\r\n            if (type === \"hero\" && !heroPoints) return;\r\n            const label = game.i18n.localize(reroll);\r\n            return `<label><input type=\"radio\" name=\"reroll\" value=\"${type}\"><i class=\"${icon}\"></i> ${label}</label>`;\r\n        })\r\n        .filter(Boolean)\r\n        .join(\"\");\r\n\r\n    const buttons = {\r\n        yes: {\r\n            icon: '<i class=\"fa-solid fa-rotate rotate\"></i>',\r\n            label: \"reroll\",\r\n            callback: (html) => html.find(\"[name=reroll]:checked\").val() ?? null,\r\n        },\r\n        no: {\r\n            icon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n            label: \"cancel\",\r\n            callback: () => null,\r\n        },\r\n    };\r\n\r\n    disableSaveListeners(event);\r\n\r\n    const reroll = await Dialog.wait(\r\n        {\r\n            title: `${target.name} - ${localize(\"target.chat.save.reroll.confirm.title\")}`,\r\n            content: template,\r\n            buttons,\r\n            close: () => null,\r\n        },\r\n        {\r\n            id: `pf2e-toolbelt-target-save-reroll-dialog-${target.id}`,\r\n        }\r\n    );\r\n\r\n    if (!reroll) {\r\n        enableSaveListeners(event);\r\n        return;\r\n    }\r\n\r\n    const isHeroReroll = reroll === \"hero\";\r\n    const keep = isHeroReroll ? \"new\" : reroll;\r\n\r\n    if (isHeroReroll) {\r\n        const { value, max } = actor.heroPoints;\r\n\r\n        if (value < 1) {\r\n            warn(\"target.chat.save.reroll.noPoints\");\r\n            return;\r\n        }\r\n\r\n        await actor.update({\r\n            \"system.resources.heroPoints.value\": Math.clamped(value - 1, 0, max),\r\n        });\r\n    }\r\n\r\n    const oldRoll = Roll.fromJSON(flag.roll);\r\n    const unevaluatedNewRoll = oldRoll.clone();\r\n    unevaluatedNewRoll.options.isReroll = true;\r\n    Hooks.callAll(\r\n        \"pf2e.preReroll\",\r\n        Roll.fromJSON(flag.roll),\r\n        unevaluatedNewRoll,\r\n        isHeroReroll,\r\n        keep\r\n    );\r\n\r\n    const newRoll = await unevaluatedNewRoll.evaluate({ async: true });\r\n    await roll3dDice(newRoll, target);\r\n\r\n    Hooks.callAll(\"pf2e.reroll\", Roll.fromJSON(flag.roll), newRoll, isHeroReroll, keep);\r\n\r\n    const keptRoll =\r\n        (keep === \"higher\" && oldRoll.total > newRoll.total) ||\r\n        (keep === \"lower\" && oldRoll.total < newRoll.total)\r\n            ? oldRoll\r\n            : newRoll;\r\n\r\n    if (keptRoll === newRoll) {\r\n        const success = new DegreeOfSuccess(newRoll, dc, flag.dosAdjustments);\r\n        keptRoll.options.degreeOfSuccess = success.value;\r\n    }\r\n\r\n    const isAuthor = game.user.isGM || message.isAuthor;\r\n\r\n    const data = {\r\n        value: keptRoll.total,\r\n        die: keptRoll.dice[0].total,\r\n        success: keptRoll.degreeOfSuccess,\r\n        roll: JSON.stringify(keptRoll.toJSON()),\r\n        dosAdjustments: deepClone(flag.dosAdjustments),\r\n        modifiers: deepClone(flag.modifiers),\r\n        rerolled: reroll,\r\n    };\r\n\r\n    if (keptRoll.options.keeleyAdd10) {\r\n        data.modifiers.push({\r\n            label: localize(\"target.chat.save.reroll.keeley\"),\r\n            modifier: 10,\r\n        });\r\n    }\r\n\r\n    const packet = {\r\n        type: \"update-save\",\r\n        message: isAuthor ? message : message.id,\r\n        targets: [\r\n            {\r\n                target: target.id,\r\n                data,\r\n            },\r\n        ],\r\n    };\r\n\r\n    if (game.user.isGM || message.isAuthor) {\r\n        updateMessageSave(packet);\r\n    } else {\r\n        socket.emit(packet);\r\n    }\r\n}\r\n\r\nasync function rollSave(event, message, { dc, statistic }, tokens) {\r\n    const isAuthor = game.user.isGM || message.isAuthor;\r\n\r\n    const targetPromises = Array.isArray(tokens)\r\n        ? tokens.map((uuid) => fromUuid(uuid))\r\n        : [getTargetFromEvent(event)];\r\n\r\n    const packet = {\r\n        type: \"update-save\",\r\n        message: isAuthor ? message : message.id,\r\n        targets: [],\r\n    };\r\n\r\n    disableSaveListeners(event);\r\n\r\n    await Promise.all(\r\n        targetPromises.map(async (targetPromise) => {\r\n            const target = await targetPromise;\r\n            const actor = target?.actor;\r\n            if (!actor) return;\r\n\r\n            const save = actor.saves[statistic];\r\n            if (!save) return;\r\n\r\n            const item = (() => {\r\n                const item = message.item;\r\n                if (item) return item;\r\n\r\n                const messageId = getFlag(message, \"target.messageId\");\r\n                if (messageId) {\r\n                    const otherMessage = game.messages.get(messageId);\r\n                    return otherMessage?.item;\r\n                }\r\n            })();\r\n\r\n            const rollOptions = getFlag(message, \"target.rollOptions\");\r\n            const skipDefault = !game.user.settings.showCheckDialogs;\r\n            const skipDialog =\r\n                targetPromises.length > 1 || (event.shiftKey ? !skipDefault : skipDefault);\r\n\r\n            if (targetPromises.length === 1 && !skipDialog) {\r\n                let checkDialog;\r\n\r\n                Hooks.once(\"renderCheckModifiersDialog\", (dialog) => {\r\n                    checkDialog = dialog;\r\n                });\r\n\r\n                const hookId = Hooks.on(\"closeCheckModifiersDialog\", (dialog) => {\r\n                    if (checkDialog !== dialog) return;\r\n\r\n                    Hooks.off(\"closeCheckModifiersDialog\", hookId);\r\n\r\n                    if (!dialog.isResolved) {\r\n                        enableSaveListeners(event);\r\n                    }\r\n                });\r\n            }\r\n\r\n            return new Promise((resolve) => {\r\n                save.check.roll({\r\n                    dc: { value: dc },\r\n                    item,\r\n                    origin: actor,\r\n                    skipDialog,\r\n                    extraRollOptions: rollOptions,\r\n                    createMessage: false,\r\n                    callback: async (roll, __, msg) => {\r\n                        await roll3dDice(roll, target);\r\n\r\n                        const context = msg.getFlag(\"pf2e\", \"context\");\r\n\r\n                        const data = {\r\n                            value: roll.total,\r\n                            die: roll.dice[0].total,\r\n                            success: roll.degreeOfSuccess,\r\n                            roll: JSON.stringify(roll.toJSON()),\r\n                            dosAdjustments: context.dosAdjustments,\r\n                            unadjustedOutcome: context.unadjustedOutcome,\r\n                            modifiers: msg\r\n                                .getFlag(\"pf2e\", \"modifiers\")\r\n                                .filter((modifier) => modifier.enabled)\r\n                                .map(({ label, modifier }) => ({ label, modifier })),\r\n                        };\r\n\r\n                        packet.targets.push({\r\n                            data,\r\n                            target: target.id,\r\n                        });\r\n\r\n                        resolve();\r\n                    },\r\n                });\r\n            });\r\n        })\r\n    );\r\n\r\n    if (isAuthor) {\r\n        updateMessageSave(packet);\r\n    } else {\r\n        socket.emit(packet);\r\n    }\r\n}\r\n\r\nasync function updateMessageSave({ targets, message }) {\r\n    if (typeof message === \"string\") {\r\n        message = game.messages.get(message);\r\n        if (!message) return;\r\n    }\r\n\r\n    const updates = {};\r\n\r\n    for (const { data, target } of targets) {\r\n        if (typeof data.success === \"number\") {\r\n            data.success = DEGREE_OF_SUCCESS[data.success];\r\n        }\r\n        updates[target] = deepClone(data);\r\n    }\r\n\r\n    await setFlag(message, \"target.saves\", updates);\r\n}\r\n\r\nasync function openTargetSheet(event) {\r\n    const target = await getTargetFromEvent(event);\r\n    if (!target) return;\r\n\r\n    target.actor?.sheet.render(true);\r\n}\r\n\r\nasync function pingTarget(event) {\r\n    if (!canvas.ready) return;\r\n\r\n    const target = await getTargetFromEvent(event);\r\n    if (!target) return;\r\n\r\n    canvas.ping(target.center);\r\n}\r\n\r\nasync function onTargetButton(event, message, html) {\r\n    const btn = event.currentTarget;\r\n    const { rollIndex, targetUuid } = btn.closest(\"[data-target-uuid]\").dataset;\r\n    const target = await fromUuid(targetUuid);\r\n    if (!target) return;\r\n\r\n    const type = btn.dataset.action;\r\n\r\n    if (type === \"target-shield-block\") {\r\n        const messageId = message.id;\r\n\r\n        if (!btn.classList.contains(\"shield-activated\")) {\r\n            toggleOffShieldBlock(messageId);\r\n        }\r\n\r\n        requestAnimationFrame(() => {\r\n            onClickShieldBlock(target, btn, html[0]);\r\n        });\r\n\r\n        return;\r\n    }\r\n\r\n    const multiplier =\r\n        type === \"target-apply-healing\"\r\n            ? -1\r\n            : type === \"target-half-damage\"\r\n            ? 0.5\r\n            : type === \"target-apply-damage\"\r\n            ? 1\r\n            : type === \"target-double-damage\"\r\n            ? 2\r\n            : 3;\r\n\r\n    applyDamageFromMessage({\r\n        message,\r\n        multiplier,\r\n        addend: 0,\r\n        promptModifier: event.shiftKey,\r\n        rollIndex: Number(rollIndex),\r\n        tokens: [target],\r\n        onDamageApplied,\r\n    });\r\n}\r\n\r\nexport function onDamageApplied(message, tokens, rollIndex) {\r\n    const updates = {};\r\n\r\n    for (const token of tokens) {\r\n        const tokenId = token.id;\r\n\r\n        moduleFlagUpdate(updates, `target.applied.${tokenId}.${rollIndex}`, true);\r\n\r\n        const splashRollIndex = getFlag(message, \"target.splashIndex\");\r\n        if (splashRollIndex !== undefined) {\r\n            const regularRollIndex = splashRollIndex === 0 ? 1 : 0;\r\n\r\n            if (rollIndex === splashRollIndex) {\r\n                moduleFlagUpdate(updates, `target.applied.${tokenId}.${regularRollIndex}`, true);\r\n            } else {\r\n                moduleFlagUpdate(updates, `target.applied.${tokenId}.${splashRollIndex}`, true);\r\n\r\n                const targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n                for (const target of targetsFlag) {\r\n                    const targetId = target.token?.split(\".\").at(-1);\r\n                    if (targetId === tokenId) continue;\r\n\r\n                    moduleFlagUpdate(\r\n                        updates,\r\n                        `target.applied.${targetId}.${regularRollIndex}`,\r\n                        true\r\n                    );\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (game.user.isGM || message.isAuthor) {\r\n        updateMessageApplied({ message, updates });\r\n    } else {\r\n        socket.emit({\r\n            type: \"update-applied\",\r\n            message: message.id,\r\n            updates,\r\n        });\r\n    }\r\n}\r\n\r\nfunction updateMessageApplied({ message, updates }) {\r\n    if (typeof message === \"string\") {\r\n        message = game.messages.get(message);\r\n        if (!message) return;\r\n    }\r\n    message.update(updates);\r\n}\r\n", "import { getTemplateTokens, render, subLocalize } from \"module-api\";\r\nimport { createTool } from \"../tool\";\r\n\r\nexport const templateOptions = {\r\n\tname: \"template\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"target-template\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tscope: \"client\",\r\n\t\t\tonChange: (value) => setHook(value),\r\n\t\t},\r\n\t],\r\n\thooks: [[\"createMeasuredTemplate\", createMeasuredTemplate]],\r\n\tinit: () => {\r\n\t\tsetHook.fromSetting(\"target-template\");\r\n\t},\r\n};\r\n\r\nconst { setHook } = createTool(templateOptions);\r\n\r\nasync function createMeasuredTemplate(template, _, userId) {\r\n\tconst user = game.user;\r\n\tif (user.id !== userId) return;\r\n\r\n\tconst localize = subLocalize(\"target.menu\");\r\n\tconst item = template.item;\r\n\tconst actor = template.actor;\r\n\tconst self = !actor ? undefined : actor.token ?? actor.getActiveTokens()[0];\r\n\r\n\tconst data = {\r\n\t\ttitle: item?.name || localize(\"title\"),\r\n\t\tcontent: await render(\"template/menu\", {\r\n\t\t\ti18n: localize.template,\r\n\t\t\tnoSelf: !self,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tselect: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-bullseye-arrow\"></i>',\r\n\t\t\t\tlabel: localize(\"target\"),\r\n\t\t\t\tcallback: (html) => ({\r\n\t\t\t\t\ttargets: html.find(\"[name=targets]:checked\").val(),\r\n\t\t\t\t\tself: html.find(\"[name=self]\").prop(\"checked\"),\r\n\t\t\t\t\tneutral: html.find(\"[name=neutral]\").prop(\"checked\"),\r\n\t\t\t\t}),\r\n\t\t\t},\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-toolbelt-target-template\",\r\n\t\twidth: 260,\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst alliance = actor ? actor.alliance : user.isGM ? \"opposition\" : \"party\";\r\n\tconst opposition =\r\n\t\talliance === \"party\"\r\n\t\t\t? \"opposition\"\r\n\t\t\t: alliance === \"opposition\"\r\n\t\t\t  ? \"party\"\r\n\t\t\t  : null;\r\n\r\n\tconst tokens = getTemplateTokens(template);\r\n\tconst targets = tokens.filter((token) => {\r\n\t\tconst validActor = token.actor?.isOfType(\"creature\", \"hazard\", \"vehicle\");\r\n\t\tif (!validActor) return false;\r\n\r\n\t\tif (token.document.hidden) return false;\r\n\r\n\t\tif (self && token === self) return result.self;\r\n\r\n\t\tconst targetAlliance = token.actor ? token.actor.alliance : token.alliance;\r\n\r\n\t\tif (targetAlliance === null) return result.neutral;\r\n\r\n\t\treturn (\r\n\t\t\tresult.targets === \"all\" ||\r\n\t\t\t(result.targets === \"allies\" && targetAlliance === alliance) ||\r\n\t\t\t(result.targets === \"enemies\" && targetAlliance === opposition)\r\n\t\t);\r\n\t});\r\n\r\n\tconst targetsIds = targets.map((token) => token.id);\r\n\tuser.updateTokenTargets(targetsIds);\r\n\tuser.broadcastActivity({ targets: targetsIds });\r\n}\r\n", "import { calledIfSetting } from \"../misc\";\r\nimport { createTool } from \"../tool\";\r\n\r\nexport const unidedOptions = {\r\n\tname: \"unided\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"unided\",\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"disabled\",\r\n\t\t\tchoices: [\"disabled\", \"create\", \"all\"],\r\n\t\t\tonChange: (value) => setup(value),\r\n\t\t},\r\n\t],\r\n\thooks: [\r\n\t\t{ event: \"preCreateItem\", listener: preCreateItem, useChoices: true },\r\n\t\t{ event: \"preUpdateItem\", listener: preUpdateItem, useChoices: \"all\" },\r\n\t],\r\n\tconflicts: [\"pf2e-unided\"],\r\n\tinit: calledIfSetting(setup, \"unided\"),\r\n};\r\n\r\nconst { hooks } = createTool(unidedOptions);\r\n\r\nfunction setup(value) {\r\n\thooks.setAll(value);\r\n}\r\n\r\nfunction preCreateItem(item) {\r\n\tif (!item.img || !item.isOfType(\"physical\")) return;\r\n\titem._source.system.identification.unidentified.img = item.img;\r\n}\r\n\r\nfunction preUpdateItem(item, changes) {\r\n\tif (!item.isOfType(\"physical\") || !(\"img\" in changes)) return;\r\n\tsetProperty(changes, \"system.identification.unidentified.img\", changes.img);\r\n}\r\n", "import { getSetting } from \"module-api\";\r\nimport { createTool } from \"../tool\";\r\n\r\nconst setupDebounced = debounce(setup, 1);\r\n\r\nexport const untargetOptions = {\r\n\tname: \"untarget\",\r\n\tsettings: [\r\n\t\t{\r\n\t\t\tkey: \"force-untarget\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tonChange: setupDebounced,\r\n\t\t},\r\n\t\t{\r\n\t\t\tkey: \"untarget\",\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false,\r\n\t\t\tscope: \"client\",\r\n\t\t\tonChange: setupDebounced,\r\n\t\t},\r\n\t],\r\n\thooks: [[\"updateCombat\", updateCombat]],\r\n\tinit: setupDebounced,\r\n};\r\n\r\nconst { setHook } = createTool(untargetOptions);\r\n\r\nfunction setup() {\r\n\tconst enabled = getSetting(\"force-untarget\") || getSetting(\"untarget\");\r\n\tsetHook(enabled);\r\n}\r\n\r\nfunction updateCombat(_, data) {\r\n\tif (!(\"turn\" in data) && !(\"round\" in data)) return;\r\n\r\n\tconst user = game.user;\r\n\tuser.updateTokenTargets();\r\n\tuser.broadcastActivity({ targets: [] });\r\n}\r\n", "import { render, subLocalize } from \"module-api\";\r\n\r\nconst localize = subLocalize(\"macros.condition\");\r\n\r\nexport async function permaConditionEffect(actor) {\r\n\tconst callback = (html, type) => {\r\n\t\tconst condition = html.find(\"[name=condition]\");\r\n\t\tconst { name, slug, img } = condition.find(\":selected\").data();\r\n\r\n\t\treturn {\r\n\t\t\ttype,\r\n\t\t\tslug,\r\n\t\t\timg,\r\n\t\t\tname:\r\n\t\t\t\thtml.find(\"[name=name]\").val().trim() ||\r\n\t\t\t\tlocalize(\"effect-name\", { condition: name }),\r\n\t\t\tuuid: condition.val(),\r\n\t\t\tbadge: Number(html.find(\"[name=badge]\").val() || 1),\r\n\t\t\tunidentified: html.find(\"[name=unidentified]\").prop(\"checked\"),\r\n\t\t};\r\n\t};\r\n\r\n\tconst buttons = {\r\n\t\tgenerate: {\r\n\t\t\ticon: '<i class=\"fas fa-suitcase\"></i>',\r\n\t\t\tlabel: localize(\"generate\"),\r\n\t\t\tcallback: (html) => callback(html, \"generate\"),\r\n\t\t},\r\n\t\tadd: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-user\"></i>',\r\n\t\t\tlabel: localize(\"add\"),\r\n\t\t\tcallback: (html) => callback(html, \"add\"),\r\n\t\t},\r\n\t};\r\n\r\n\tconst conditions = Array.from(game.pf2e.ConditionManager.conditions.values());\r\n\tconst withBadge = new Set(\r\n\t\tconditions\r\n\t\t\t.filter((condition) => !!condition.badge)\r\n\t\t\t.map((condition) => condition.slug),\r\n\t);\r\n\r\n\tconst content = await render(\"macros/condition\", {\r\n\t\ti18n: localize.template,\r\n\t\tconditions: Array.from(\r\n\t\t\tnew Set(conditions.sort((a, b) => a.name.localeCompare(b.name))),\r\n\t\t),\r\n\t});\r\n\r\n\tconst setInputs = (html) => {\r\n\t\tconst { name, slug } = html.find(\"[name=condition] :selected\").data();\r\n\t\thtml\r\n\t\t\t.find(\"[name=name]\")\r\n\t\t\t.prop(\"placeholder\", localize(\"effect-name\", { condition: name }));\r\n\r\n\t\tconst hasBadge = withBadge.has(slug);\r\n\t\tconst badge = html.find(\"[name=badge]\");\r\n\t\tbadge.prop(\"disabled\", !hasBadge);\r\n\t\tif (!hasBadge) badge.val(1);\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(\r\n\t\t{\r\n\t\t\tbuttons,\r\n\t\t\tcontent,\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tclose: () => null,\r\n\t\t\trender: (html) => {\r\n\t\t\t\tsetInputs(html);\r\n\t\t\t\thtml.find(\"[name=condition]\").on(\"change\", () => setInputs(html));\r\n\t\t\t},\r\n\t\t},\r\n\t\t{\r\n\t\t\tid: \"pf2e-toolbelt-macros-condition\",\r\n\t\t\twidth: 320,\r\n\t\t},\r\n\t);\r\n\r\n\tif (!result) return;\r\n\r\n\tconst rule = {\r\n\t\tinMemoryOnly: true,\r\n\t\tkey: \"GrantItem\",\r\n\t\tuuid: result.uuid,\r\n\t};\r\n\r\n\tif (result.badge > 1 && withBadge.has(result.slug)) {\r\n\t\trule.alterations = [\r\n\t\t\t{\r\n\t\t\t\tmode: \"override\",\r\n\t\t\t\tproperty: \"badge-value\",\r\n\t\t\t\tvalue: result.badge,\r\n\t\t\t},\r\n\t\t];\r\n\t}\r\n\r\n\tconst source = {\r\n\t\tname: result.name,\r\n\t\ttype: \"effect\",\r\n\t\timg: result.img,\r\n\t\tsystem: {\r\n\t\t\trules: [rule],\r\n\t\t\tunidentified: result.unidentified,\r\n\t\t},\r\n\t};\r\n\r\n\tif (result.type === \"generate\" || !actor) await Item.create(source);\r\n\telse await actor.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n", "import {\r\n\tMODULE,\r\n\tgetModule,\r\n\tisUserGM,\r\n\tlocalize,\r\n\tregisterModule,\r\n\tregisterSetting,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { arpOptions } from \"./features/arp\";\r\nimport { debugOptions } from \"./features/debug\";\r\nimport { effectsOptions } from \"./features/effects\";\r\nimport { givethOptions } from \"./features/giveth\";\r\nimport { heroOptions } from \"./features/hero\";\r\nimport { inventoryOptions } from \"./features/inventory\";\r\nimport { knowledgesOptions } from \"./features/knowledges\";\r\nimport { merchantOptions } from \"./features/merchant\";\r\nimport { mergeOptions } from \"./features/merge\";\r\nimport { nobulkOptions } from \"./features/nobulk\";\r\nimport { shareOptions } from \"./features/share\";\r\nimport { stancesOptions } from \"./features/stances\";\r\nimport { summaryOptions } from \"./features/summary\";\r\nimport { targetOptions } from \"./features/target\";\r\nimport { templateOptions } from \"./features/template\";\r\nimport { unidedOptions } from \"./features/unided\";\r\nimport { untargetOptions } from \"./features/untarget\";\r\nimport { permaConditionEffect } from \"./macros/condition\";\r\nimport { settingIsEnabled } from \"./misc\";\r\nimport { checkFeatureOptions } from \"./tool\";\r\n\r\nregisterModule(\"pf2e-toolbelt\");\r\n\r\nconst FEATURES = [\r\n\tarpOptions,\r\n\tdebugOptions,\r\n\teffectsOptions,\r\n\tgivethOptions,\r\n\theroOptions,\r\n\tinventoryOptions,\r\n\tknowledgesOptions,\r\n\tmerchantOptions,\r\n\tmergeOptions,\r\n\tnobulkOptions,\r\n\tshareOptions,\r\n\tstancesOptions,\r\n\tsummaryOptions,\r\n\ttargetOptions,\r\n\ttemplateOptions,\r\n\tunidedOptions,\r\n\tuntargetOptions,\r\n];\r\n\r\nconst CONFLICTS = new Set();\r\n\r\nlet firstClientSetting = null;\r\n\r\nHooks.once(\"init\", () => {\r\n\tconst isGM = isUserGM();\r\n\tconst settings = [];\r\n\r\n\tfor (const feature of FEATURES) {\r\n\t\tcheckFeatureOptions(feature);\r\n\t\tsettings.push(...feature.settings);\r\n\t}\r\n\r\n\tconst worldSettings = settings.filter(\r\n\t\t({ scope }) => !scope || scope === \"world\",\r\n\t);\r\n\tconst clientSettings = settings.filter(({ scope }) => scope === \"client\");\r\n\r\n\tfor (const setting of [worldSettings, clientSettings].flat()) {\r\n\t\tregisterSetting(setting);\r\n\t}\r\n\r\n\tif (isGM && clientSettings.length) {\r\n\t\tconst first = clientSettings.find((x) => x.config !== false);\r\n\t\tif (first) {\r\n\t\t\tfirstClientSetting = first.key;\r\n\t\t\tHooks.on(\"renderSettingsConfig\", renderSettingsConfig);\r\n\t\t}\r\n\t}\r\n\r\n\tconst module = getModule();\r\n\tmodule.api = {\r\n\t\tmacros: {\r\n\t\t\tpermaConditionEffect,\r\n\t\t},\r\n\t};\r\n\r\n\tfor (const feature of FEATURES) {\r\n\t\tconst { init, conflicts = [], api, name } = feature;\r\n\r\n\t\tif (isGM) {\r\n\t\t\tfor (const id of conflicts) {\r\n\t\t\t\tconst conflictingModule = game.modules.get(id);\r\n\t\t\t\tif (conflictingModule?.active) {\r\n\t\t\t\t\tfeature.conflicting = true;\r\n\t\t\t\t\tCONFLICTS.add(conflictingModule.title);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (api) {\r\n\t\t\tmodule.api[name] = api;\r\n\t\t}\r\n\r\n\t\tif (!feature.conflicting && init) init(isGM);\r\n\t}\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n\tconst isGM = game.user.isGM;\r\n\r\n\tfor (const { conflicting, ready } of FEATURES) {\r\n\t\tif (!conflicting && ready) ready(isGM);\r\n\t}\r\n\r\n\tif (isGM) {\r\n\t\tfor (const conflict of CONFLICTS) {\r\n\t\t\twarn(\"module-conflict\", { name: conflict }, true);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nfunction renderSettingsConfig(_, html) {\r\n\tconst moduleId = MODULE.id;\r\n\tconst moduleTab = html.find(`.tab[data-tab=${moduleId}]`);\r\n\r\n\tconst getSettingSection = (setting) => {\r\n\t\treturn moduleTab.find(`[data-setting-id=\"${moduleId}.${setting}\"]`);\r\n\t};\r\n\r\n\tif (firstClientSetting) {\r\n\t\tconst section = getSettingSection(firstClientSetting);\r\n\t\tsection.before(`<h3>${localize(\"settings.client\")}</h3>`);\r\n\t}\r\n\r\n\tfor (const { hideSettings = [] } of FEATURES) {\r\n\t\tfor (const { global, settings } of hideSettings) {\r\n\t\t\tconst enabled = settingIsEnabled(global);\r\n\t\t\tif (enabled) continue;\r\n\r\n\t\t\tfor (const setting of settings) {\r\n\t\t\t\tconst section = getSettingSection(setting);\r\n\t\t\t\tsection.remove();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"],
  "mappings": "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",
  "names": ["getOwner", "actor", "isValidUser", "__name", "user", "owners", "a", "b", "isOwner", "getHighestName", "refreshActorSheets", "actorType", "app", "__name", "latestChatMessages", "nb", "fromMessage", "chat", "messages", "start", "m", "message", "html", "__name", "chatUUID", "uuid", "label", "hasEmbeddedSpell", "getInMemory", "doc", "path", "MODULE", "__name", "setInMemory", "args", "value", "getInMemoryAndSetIfNot", "current", "result", "deleteInMemory", "split", "x", "last", "cursor", "key", "getSourceId", "doc", "__name", "includesSourceId", "list", "sourceId", "getSourceIdCondition", "item", "arrayToObject", "arr", "fn", "key", "obj", "entry", "k", "__name", "compareArrays", "arr1", "arr2", "clonedArr2", "arr1Value", "index", "arr2Value", "indexIsValid", "getElementIndex", "el", "__name", "calculateDistanceBetweenPoints", "x1", "y1", "x2", "y2", "x", "y", "__name", "AsyncFunction", "isInstanceOf", "obj", "name", "cursor", "__name", "joinStr", "separator", "path", "x", "__name", "flagPath", "path", "MODULE", "joinStr", "__name", "getFlag", "doc", "getFlagProperty", "setFlag", "args", "value", "unsetFlag", "updateSourceFlag", "doc", "args", "value", "flagPath", "__name", "moduleFlagUpdate", "updates", "render", "args", "data", "path", "templatePath", "__name", "MODULE", "joinStr", "registerUpstreamHook", "event", "listener", "id", "index", "x", "hooked", "__name", "getItems", "actor", "itemTypes", "types", "type", "__name", "hasItemWithSourceId", "sourceId", "getSourceIdCondition", "getItemWithSourceId", "registerWrapper", "path", "callback", "type", "MODULE", "__name", "unregisterWrapper", "id", "localize", "args", "MODULE", "data", "joinStr", "__name", "hasLocalization", "keys", "localizePath", "path", "MODULE", "__name", "subLocalize", "subKey", "fn", "args", "localize", "str", "arg1", "arg2", "warn", "info", "error", "key", "hasLocalization", "hash", "localeCompare", "a", "b", "MODULE_ID", "MODULE", "str", "registerModule", "id", "__name", "getModule", "notify", "str", "arg1", "arg2", "arg3", "type", "data", "permanent", "localize", "__name", "warn", "info", "error", "registerSetting", "options", "arrayToObject", "choice", "settingPath", "MODULE", "__name", "settingPath", "path", "MODULE", "__name", "getSetting", "setting", "isChoiceSetting", "setSetting", "value", "socketOn", "callback", "MODULE", "__name", "socketOff", "socketEmit", "packet", "getUser", "x", "__name", "isUserGM", "user", "isActiveGM", "isGMOnline", "getBrowser", "__name", "getBrowserTab", "tabName", "openBrowserTab", "tabOrName", "data", "tab", "tabFromTabOrTabName", "tabData", "equipmentTabData", "getEquipmentTabData", "collapsed", "mergeWith", "returned", "equipmentData", "filterData", "typeName", "type", "category", "selected", "defaultType", "defaultCategory", "htmlQuery", "parent", "selectors", "__name", "ordinalString", "value", "pluralRules", "suffix", "__name", "ErrorPF2e", "message", "actionGlyphMap", "getActionGlyph", "action", "value", "sanitized", "__name", "setHasElement", "set", "value", "__name", "extractEphemeralEffects", "affects", "origin", "target", "item", "domains", "options", "effectsFrom", "effectsTo", "fullOptions", "resolvables", "s", "d", "e", "__name", "applyDamageFromMessage", "message", "multiplier", "addend", "promptModifier", "rollIndex", "tokens", "onDamageApplied", "shiftAdjustDamage", "htmlQuery", "shieldBlockRequest", "roll", "isInstanceOf", "ErrorPF2e", "damage", "messageRollOptions", "originRollOptions", "o", "messageItem", "effectRollOptions", "token", "domain", "ephemeralEffects", "extractEphemeralEffects", "contextClone", "rollOptions", "toggleOffShieldBlock", "__name", "onClickShieldBlock", "target", "shieldButton", "messageEl", "getTokens", "getNonBrokenShields", "s", "nonBrokenShields", "hasMultipleShields", "shieldActivated", "instance", "_helper", "contentEl", "multipleShields", "listEl", "shieldList", "shield", "input", "shieldName", "hardness", "hardnessLabel", "itemLi", "messageId", "app", "selector", "button", "content", "AdjustmentDialog", "$html", "isHealing", "$dialog", "adjustment", "createManipulateFlavor", "subtitle", "getActionGlyph", "__name", "createTradeContent", "message", "img", "createFancyLink", "docOrUuid", "async", "label", "link", "createManipulationMessage", "content", "actor", "senderId", "getHighestName", "createTradeMessage", "item", "getDamageRollClass", "Roll", "__name", "dcAdjustments", "dcByLevel", "calculateDC", "level", "pwol", "rarity", "dc", "dcByLevel", "adjustDCByRarity", "__name", "adjustDCByRarity", "dc", "rarity", "adjustDC", "rarityToDCAdjustment", "__name", "adjustment", "dcAdjustments", "MAGIC_TRADITIONS", "spellSlotGroupIdToNumber", "groupId", "numericValue", "__name", "IdentifyItemPopup", "__name", "getItemIdentificationDCs", "item", "$html", "html", "updateButton", "identifiedName", "dcs", "action", "content", "_event", "formData", "status", "pwol", "notMatchingTraditionModifier", "baseDC", "calculateDC", "rarity", "getDcRarity", "dc", "adjustDCByRarity", "getIdentifyMagicDCs", "result", "traditions", "getMagicTraditions", "key", "MAGIC_TRADITIONS", "traits", "t", "setHasElement", "inlineSelector", "keyword", "HANDWRAPS_SLUG", "canBeInvested", "item", "__name", "hasWornSlot", "isWornAs", "isInvestedOrWornAs", "isHeld", "isTwoHanded", "isOneHanded", "inSlotValue", "value", "usage", "toggleInvestedValue", "invest", "itemCarryUpdate", "carryType", "handsHeld", "inSlot", "invested", "containerId", "update", "isHandwrapsOfMightyBlows", "calculateItemPrice", "quantity", "ratio", "coins", "transferItemToActor", "target", "newStack", "itemQuantity", "newQuantity", "newItemData", "MoveLootPopup", "object", "options", "callback", "prompt", "buttonLabel", "_event", "formData", "DEGREE_ADJUSTMENT_AMOUNTS", "DEGREE_OF_SUCCESS_STRINGS", "DegreeOfSuccess", "_DegreeOfSuccess", "__name", "roll", "dc", "dosAdjustments", "t", "d", "#calculateDegreeOfSuccess", "#getDegreeAdjustment", "#adjustDegreeOfSuccess", "degree", "adjustments", "outcome", "label", "amount", "degreeOfSuccess", "#adjustDegreeByDieValue", "getTemplateTokens", "measuredTemplate", "collisionOrigin", "collisionType", "template", "grid", "dimensions", "gridHighlight", "origin", "tokens", "gridSize", "containedTokens", "token", "tokenDoc", "tokenPositions", "h", "tokenX", "y", "w", "position", "gx", "gy", "s", "destination", "__name", "wrapperError", "feature", "path", "MODULE", "__name", "settingIsEnabled", "setting", "value", "getSetting", "isChoiceSetting", "calledIfSetting", "fn", "PREPARE_WEAPON_DATA", "PREPARE_WEAPON_DERIVED_DATA", "PREPARE_ARMOR_DATA", "PREPARE_ARMOR_DERIVED_DATA", "arpOptions", "setting", "getSetting", "registerWrapper", "onPrepareWeaponData", "onPrepareWeaponDerivedData", "onPrepareArmorData", "onPrepareArmorDerivedData", "renderPhysicalItemSheetPF2e", "isGM", "info", "isValidActor", "actor", "isCharacter", "__name", "WEAPON_POTENCY_PRICE", "WEAPON_STRIKING_PRICE", "isShieldWeapon", "weapon", "isValidWeapon", "traits", "group", "category", "slug", "HANDWRAPS_SLUG", "item", "wrapped", "level", "forceUpdate", "expectedPotency", "expectedStriking", "wrapperError", "coins", "potency", "striking", "ARMOR_POTENCY_PRICE", "ARMOR_RESILIENCY_PRICE", "isValidArmor", "armor", "expectedResilient", "resiliency", "sheet", "html", "lookups", "x", "checkFeatureOptions", "options", "__name", "createTool", "tool", "hooks", "key", "value", "setting", "getSetting", "_", "listener", "hook", "createHook", "createSocket", "event", "useChoices", "isUpstream", "hookId", "isEnabled", "registerFn", "registerUpstreamHook", "enabled", "socketEnabled", "toolKey", "onSocket", "packet", "userId", "socketEmit", "socketOn", "socketOff", "debugOptions", "value", "setup", "onRender", "calledIfSetting", "hooks", "createTool", "__name", "app", "html", "link", "event", "obj", "type", "i", "variable", "setupDebounced", "setup", "effectsOptions", "renderEffectsPanel", "setHook", "createTool", "enabled", "getSetting", "refreshEffectsPanel", "__name", "panel", "html", "removeRow", "localize", "editIcon", "effectPanels", "effectPanel", "id", "effect", "event", "onRemoveEffect", "h1", "onConditionSheet", "getEffect", "sheetTabsRegistered", "CHARACTER_SHEET_INNER_RENDER", "CHARACTER_SHEET_RENDER", "CHARACTER_SHEET_ACTIVE_LISTENERS", "isPlayedActor", "actor", "__name", "registerCharacterSheetExtraTab", "options", "registerWrapper", "characterSheetRender", "characterSheetInnerRender", "characterSheetActiveListeners", "unregisterCharacterSheetExtraTab", "tabName", "wrapperId", "unregisterWrapper", "wrapped", "args", "positions", "existingAlternate", "getCharacterSheetTab", "alternate", "data", "inner", "element", "getData", "templateFolder", "onRender", "beforeSelector", "innerTab", "tabData", "template", "render", "getInMemory", "addEvents", "event", "onCharacterSheetTabBtnToggle", "tab", "html", "sheet", "setInMemory", "givethOptions", "value", "setup", "dropCanvasData", "onSocket", "calledIfSetting", "socket", "setHook", "createTool", "__name", "packet", "userId", "takethCondition", "takethEffect", "takethPhysical", "canvas", "data", "isGMOnline", "details", "getDetailsFromData", "target", "token", "isValidActor", "maximumX", "maximumY", "b", "giveth", "origin", "item", "ownerId", "targetId", "isIndex", "qty", "warn", "sendPhysicalRequest", "stackable", "MoveLootPopup", "quantity", "newStack", "uuid", "itemId", "stack", "actor", "id", "isPlayedActor", "actorUUID", "source", "senderId", "owner", "itemQuantity", "newItem", "transferItemToActor", "getSetting", "message", "localize", "getHighestName", "createFancyLink", "createTradeMessage", "localize", "subLocalize", "Trade", "__name", "actor", "templatePath", "value", "options", "x", "getHeroActions", "html", "#onChangeTarget", "#onDescription", "#onSendTrade", "force", "action", "target", "user", "getOwner", "sendTradeRequest", "event", "uuid", "id", "STANDALONE_ID", "JOURNAL_UUID", "TABLE_UUID", "TABLE_ICON", "heroOptions", "value", "setup", "refreshActorSheets", "onSocket", "renderCharacterSheetPF2e", "createTable", "removeHeroActions", "getHeroActions", "useHeroAction", "getHeroActionDetails", "drawHeroAction", "drawHeroActions", "sendActionToChat", "discardHeroActions", "tradeHeroAction", "getDeckTable", "giveHeroActions", "createChatMessage", "calledIfSetting", "socket", "setHook", "createTool", "__name", "packet", "onTradeRejected", "isActiveGM", "onTradeAccepted", "onTradeRequest", "onTradeError", "sheet", "html", "actor", "isPlayedActor", "addActionsToSheet", "addSheetEvents", "actions", "diff", "isOwner", "localize", "subLocalize", "template", "render", "getSetting", "list", "event", "onClickHeroActionsDraw", "onClickHeroActionExpand", "onClickHeroActionUse", "onClickHeroActionDisplay", "onClickHeroActionDiscard", "onClickHeroActionsDiscard", "uuids", "x", "action", "toDiscard", "$discarded", "uuid", "setHeroActions", "summary", "details", "text", "document", "parent", "page", "warn", "nb", "drawn", "i", "label", "secret", "content", "size", "chatActions", "data", "links", "name", "chatUUID", "Trade", "table", "r", "draw", "documentUuidFromTableResult", "getLabelfromTableResult", "points", "index", "error", "actionsUUIDS", "removed", "result", "getTableFromUuid", "getDefaultCompendiumTable", "getDefaultWorldTable", "getCustomTable", "sendTradeRequest", "trade", "acceptRequest", "sender", "receiver", "senderActor", "receiverActor", "sendTradeError", "senderActions", "receiverActions", "senderActionIndex", "receiverActionIndex", "senderAction", "receiverAction", "sentLink", "receivedLink", "users", "err", "rejectRequest", "templatePath", "buttons", "type", "unique", "createDefaultTable", "createCustomTable", "createCustomActionsTable", "setTable", "source", "getTableSource", "update", "createDefautActionsTable", "normalize", "setSetting", "removeActionsToggleAll", "removeActionsToggleActor", "actors", "state", "checked", "all", "templateLocalize", "isUnique", "actionsList", "el", "selected", "asDrawn", "withMessage", "tableUpdates", "key", "dragData", "DRAG_ID", "cleanOptions", "options", "filters", "type", "keys", "key", "option", "__name", "makeDraggable", "i", "droppable", "event", "onMouseDown", "onDragCancel", "cleanUp", "onDragEnd", "onMouseMove", "onMouseUp", "classList", "target", "closestInside", "_ghost", "targetIndex", "getElementIndex", "targetParent", "targetClassList", "newClassList", "element", "index", "child", "onDragMove", "clientX", "clientY", "draggable", "calculateDistanceBetweenPoints", "onDragStart", "dropped", "hovered", "img", "cursorElement", "offsetX", "offsetY", "value", "enabled", "parent", "selector", "filter", "cursor", "dragging", "inventoryOptions", "value", "setup", "closeCharacterSheetPF2e", "calledIfSetting", "setHook", "createTool", "dragIdentifier", "COINS", "registerCharacterSheetExtraTab", "getData", "addEvents", "onRender", "unregisterCharacterSheetExtraTab", "refreshActorSheets", "__name", "sheet", "html", "actor", "isPlayedActor", "getInMemory", "tab", "getCharacterSheetTab", "data", "getCurrentData", "setFlag", "inner", "sidebar", "tabElement", "alternate", "equipped", "equippedItemId", "slot", "itemIds", "parent", "ids", "items", "i", "item", "tabs", "tabId", "flags", "getFlag", "setInMemory", "orphans", "containers", "getTab", "itemId", "addOrphan", "handsHeld", "equippedHands", "handIndex", "indexIsValid", "isHandwrapsOfMightyBlows", "isInvestedOrWornAs", "equippedIndex", "index", "tabOrphans", "otherIndex", "grouped", "activeTabId", "container", "capacity", "containerTabs", "event", "itemElements", "itemElement", "onItemDetails", "makeDraggable", "target", "createGhost", "onDragStart", "draggable", "options", "onDragEnd", "containersDroppable", "otherEquipmentDroppable", "largeEquipmentDroppable", "itemsListDroppable", "itemsGridDroppable", "details", "getItemFromElement", "render", "dropped", "canceled", "dragged", "draggedIndex", "checkIdentifier", "error", "onDragEnter", "droppable", "ghost", "getElementIndex", "onDragLeave", "parentGrid", "closestInside", "onDrop", "updates", "cleanContainerItem", "moveItemToContainer", "checkForTwoHandedSlots", "rightHand", "canDrop", "moveItemToSlot", "element", "drop", "noTwoHand", "noUpdate", "dropSlot", "movable", "isOneHand", "isOneHanded", "isTwoHand", "isTwoHanded", "canInvest", "canBeInvested", "move", "carryType", "inSlot", "invested", "itemCarryUpdate", "isHeld", "getSlottedItem", "slotted", "dragArea", "dragSlot", "otherSlotted", "canEquip", "hasWornSlot", "containerId", "remaining", "targetIsElement", "leftHand", "leftSlotted", "rightSlotted", "clone", "el", "id", "localize", "subLocalize", "EditLores", "__name", "templatePath", "options", "actor", "getFlag", "event", "unspecified", "specific", "setFlag", "html", "#onCancel", "knowledgesOptions", "value", "setup", "renderNPCSheetPF2e", "calledIfSetting", "setHook", "createTool", "refreshActorSheets", "__name", "sheet", "$html", "actor", "isPlayedActor", "replaceLores", "addEditButton", "addEvents", "knowledgeSelector", "html", "section", "selector", "editLores", "EditLores", "unspecifics", "getFlag", "specifics", "lores", "body", "tag", "skills", "dc", "adjustment", "addTags", "start", "tags", "lore", "attempts", "edit", "PipsMode", "PipsType", "isValidFormatter", "entry", "isValidPartialFormatter", "__name", "removeElement", "el", "isSet", "value", "preventDefault", "unique", "array", "a", "closest", "to", "offset", "elem", "orientation", "rect", "doc", "docElem", "pageOffset", "getPageOffset", "isNumeric", "addClassFor", "element", "className", "duration", "addClass", "removeClass", "limit", "asArray", "countDecimals", "numStr", "pieces", "hasClass", "supportPageOffset", "isCSS1Compat", "x", "y", "getActions", "getSupportsPassive", "supportsPassive", "opts", "getSupportsTouchActionNone", "subRangeRatio", "pa", "pb", "fromPercentage", "range", "startRange", "toPercentage", "isPercentage", "getJ", "arr", "j", "toStepping", "xVal", "xPct", "va", "vb", "fromStepping", "getStep", "xSteps", "snap", "b", "Spectrum", "singleStep", "index", "ordered", "distances", "direction", "xPct_index", "start_factor", "rest_factor", "rest_rel_distance", "range_pct", "rel_range_distance", "abs_distance_counter", "range_counter", "isDown", "size", "stepDecimals", "percentage", "value1", "i", "totalSteps", "highestStep", "step", "defaultFormatter", "cssClasses", "INTERNAL_EVENT_NS", "testStep", "parsed", "testKeyboardPageMultiplier", "testKeyboardMultiplier", "testKeyboardDefaultStep", "testRange", "testStart", "testSnap", "testAnimate", "testAnimationDuration", "testConnect", "connect", "testOrientation", "testMargin", "testLimit", "testPadding", "totalPadding", "firstValue", "lastValue", "testDirection", "testBehaviour", "tap", "drag", "fixed", "hover", "unconstrained", "dragAll", "smoothSteps", "testTooltips", "formatter", "testHandleAttributes", "testAriaFormat", "testFormat", "testKeyboardSupport", "testDocumentElement", "testCssPrefix", "testCssClasses", "key", "testOptions", "options", "tests", "defaults", "name", "d", "msPrefix", "noPrefix", "styles", "scope", "target", "originalOptions", "actions", "supportsTouchActionNone", "scope_Target", "scope_Base", "scope_Handles", "scope_Connects", "scope_Pips", "scope_Tooltips", "scope_Spectrum", "scope_Values", "scope_Locations", "scope_HandleNumbers", "scope_ActiveHandlesCount", "scope_Events", "scope_Document", "scope_DocumentElement", "scope_Body", "scope_DirOffset", "addNodeTo", "addTarget", "div", "addOrigin", "base", "handleNumber", "origin", "handle", "event", "eventKeydown", "attributes_1", "attribute", "addConnect", "add", "addElements", "connectOptions", "connectBase", "addSlider", "textDirection", "addTooltip", "isSliderDisabled", "isHandleDisabled", "handleOrigin", "disable", "enable", "removeTooltips", "removeEvent", "tooltip", "tooltips", "bindEvent", "values", "unencoded", "formattedValue", "aria", "positions", "min", "checkHandlePosition", "max", "now", "text", "getGroup", "pips", "interval", "spread", "mapToRange", "stepped", "generateSpread", "safeIncrement", "increment", "group", "indexes", "firstInRange", "lastInRange", "ignoreFirst", "ignoreLast", "prevPct", "current", "q", "low", "high", "newPct", "pctDifference", "pctPos", "type", "steps", "realSteps", "stepSize", "isSteps", "addMarking", "filterFunc", "_a", "_b", "valueSizeClasses", "markerSizeClasses", "valueOrientationClasses", "markerOrientationClasses", "getClasses", "source", "orientationClasses", "sizeClasses", "addSpread", "node", "removePips", "filter", "format", "baseSize", "alt", "attachEvent", "events", "callback", "data", "method", "e", "fixEvent", "methods", "eventName", "eventTarget", "touch", "mouse", "pointer", "isTouchOnTarget", "checkTouch", "targetTouches", "targetTouch", "calcPointToPercentage", "calcPoint", "location", "proposal", "getClosestHandle", "clickedPosition", "smallestDifference", "handlePosition", "differenceWithThisHandle", "clickAtEdge", "isCloser", "isCloserAfter", "documentLeave", "eventEnd", "eventMove", "movement", "moveHandles", "c", "setZindex", "setHandle", "fireEvent", "eventStart", "listeners", "moveEvent", "endEvent", "outEvent", "eventTap", "eventHover", "targetEvent", "scope_Self", "horizontalKeys", "verticalKeys", "largeStepKeys", "edgeKeys", "isLargeDown", "isLargeUp", "isUp", "isMin", "isMax", "getNextStepsForHandle", "bindSliderEvents", "behaviour", "handleBefore", "handleAfter", "eventHolders", "handlesToDrag", "handleNumbersToDrag", "eventHolder", "namespacedEvent", "isInternalNamespace", "namespace", "bind", "tEvent", "tNamespace", "eventType", "reference", "lookBackward", "lookForward", "getValue", "distance", "inRuleOrder", "v", "o", "upward", "locations", "handleNumbers", "proposals", "firstHandle", "f", "state", "transformDirection", "updateHandlePosition", "translation", "translateRule", "updateConnect", "dir", "zIndex", "exactInput", "l", "h", "connectWidth", "scaleRule", "resolveToValue", "valueSet", "input", "fireSetEvent", "isInit", "space_1", "valueReset", "valueSetHandle", "valueGet", "destroy", "nearbySteps", "decrement", "getNextSteps", "updateOptions", "optionsToUpdate", "updateAble", "newOptions", "setupSlider", "initialize", "api", "nouislider_default", "Spectrum", "cssClasses", "initialize", "localize", "subLocalize", "BuyItems", "__name", "actor", "options", "getEquipmentTabData", "types", "templatePath", "getFlag", "filters", "reset", "setFlag", "force", "defaultRatio", "defaultPurse", "formatPurse", "value", "clamped", "clampPurse", "getSummary", "filter", "summary", "getDefaultData", "category", "type", "defaultData", "checkboxes", "selected", "title", "row", "entry", "multiselects", "conjunction", "label", "not", "entries", "values", "min", "max", "clampPriceRatio", "getBuyAll", "PRICE_RATIO", "html", "filterData", "controlArea", "sortcontainer", "extra", "render", "event", "action", "filtercontainers", "container", "filterType", "filterName", "data", "content", "sliderElement", "slider", "nouislider_default", "minLabel", "maxLabel", "lowerEl", "upperEl", "range", "lowerBound", "upperBound", "checkboxElement", "optionName", "option", "name", "getBrowser", "filterElements", "getFilterId", "filterElement", "filterId", "direction", "setFilterValue", "key", "f", "ratio", "purse", "isExpanded", "skipConfirm", "index", "deleteIt", "newIndex", "lowerRange", "upperRange", "tab", "getBrowserTab", "defaultRange", "lower", "upper", "item", "ranges", "sliders", "extractedData", "path", "defaultType", "defaultCategory", "allFilters", "x", "localize", "subLocalize", "ITEM_PREPARE_DERIVED_DATA", "LOOT_TRANSFER_ITEM_TO_ACTOR", "ACTOR_TRANSFER_ITEM_TO_ACTOR", "BROWSER_CLOSE", "BROWSER_INNER_RENDER", "BROWSER_ACTIVE_LISTENERS", "BROWSER_RENDER_RESULTS", "PULL_LIMIT", "PRICE_RATIO", "merchantOptions", "onSocket", "isGM", "getSetting", "socket", "renderLootSheetPF2e", "registerWrapper", "itemPrepareDerivedData", "lootTranferItemToActor", "actorTranferItemToActor", "browserClose", "browserInnerRender", "browserRenderResults", "browserActiveListeners", "createTool", "packet", "userId", "makeBuyDeal", "__name", "wrapped", "options", "deleteInMemory", "data", "inner", "actor", "getInMemory", "setInMemory", "x", "tabElement", "controlArea", "footer", "selected", "btn", "all", "updateBrowser", "selection", "skipAll", "browserApp", "browserTab", "tab", "getBrowserTab", "total", "numbers", "isAtLimit", "checkbox", "reachedLimit", "checkboxes", "disabled", "fillSelection", "owned", "uuid", "browser", "checkAll", "msg", "html", "items", "item", "start", "getInMemoryAndSetIfNot", "isOwned", "a", "checked", "index", "sheet", "noCoins", "buyItems", "priceRatio", "infiniteStocks", "infiniteItems", "getFlag", "sheetTemplate", "render", "clampPriceRatio", "str", "flagPath", "sidebar", "better", "event", "openEquipmentTab", "openBuySettings", "itemTypes", "hasInfiniteStock", "tooltip", "itemId", "isInfinite", "toggle", "el", "flagKey", "current", "setFlag", "actorFlags", "ratio", "infiniteItem", "wrapperError", "args", "targetActor", "quantity", "thisSuper", "itemValue", "ErrorPF2e", "getFilters", "getBuyAll", "createPurse", "filter", "itemPrice", "isDefault", "purse", "clampPurse", "price", "goldValue", "buyer", "containerId", "newStack", "hasPlayerOwner", "targetName", "itemQuantity", "calculateItemPrice", "poor", "filters", "BuyItems", "senderId", "getDocument", "option", "Class", "errorMsg", "err", "seller", "docs", "f", "totalPurse", "filterPurse", "purseError", "type", "selectedPurse", "purseUpdates", "newItem", "transferItemToActor", "message", "getHighestName", "createFancyLink", "createTradeMessage", "getBrowser", "openBrowserTab", "value", "bindOnPreCreateSpellDamageChatMessage", "originalMessage", "messageId", "save", "getFlag", "message", "updateSourceFlag", "__name", "localize", "subLocalize", "MultiCast", "__name", "#message", "#event", "event", "message", "options", "templatePath", "html", "#onCast", "#onCancel", "nb", "spell", "actor", "updateSource", "damages", "heightening", "id", "damage", "i", "newId", "data", "embeddedSource", "newSpell", "overlayIds", "castRank", "spellSource", "bindOnPreCreateSpellDamageChatMessage", "setupDebounced", "setup", "mergeOptions", "renderChatMessage", "setHook", "createTool", "enabled", "getSetting", "updateMessages", "__name", "message", "html", "latestChatMessages", "isDamageRoll", "renderDamage", "renderSpell", "spellBtn", "localize", "event", "MultiCast", "buttons", "getFlag", "tooltip", "actorUUID", "getActorUUID", "targetUUIDs", "getTargetUUIDs", "otherMessage", "otherTargetsUUIDS", "compareArrays", "t", "mergeDamages", "warn", "splitDamages", "sources", "data", "removeChatMessages", "origin", "other", "dataGroups", "getMessageData", "name", "notes", "outcome", "modifiers", "tags", "note", "result", "groups", "group", "flavor", "render", "originRolls", "getMessageRolls", "otherRolls", "groupedRolls", "roll", "options", "total", "terms", "term", "formula", "critRule", "DamageRoll", "getDamageRollClass", "index", "prev", "curr", "value", "createTermGroup", "acc", "setHidden", "operands", "operand", "r", "MODULE", "entry", "flags", "source", "title", "text", "option", "ids", "joinedIds", "id", "targetTargets", "mergeTargets", "ACTOR_PREPARE_EMBEDDED_DOCUMENTS", "TREASURE_PREPARE_BASE_DATA", "nobulkOptions", "getSetting", "registerWrapper", "actorPrepareEmbeddedDocuments", "treasurePrepareBaseData", "wrapped", "wrapperError", "__name", "InventoryBulk", "_value", "item", "ACTOR_PREPARE_DATA", "DOCUMENT_SHEET_RENDER_INNER", "shareOptions", "getSetting", "registerWrapper", "prepareData", "documentSheetRenderInner", "preUpdateActor", "deleteActor", "updateActor", "wrapped", "args", "inner", "isInstanceOf", "actor", "isPlayedActor", "getSlaves", "masters", "a", "isValidMaster", "group", "render", "getFlag", "flagPath", "subLocalize", "__name", "removeSlaveFromMaster", "slaves", "slave", "unsetMaster", "unsetFlag", "updates", "shareFlag", "getFlagProperty", "master", "hpSource", "getMaster", "hpUpdate", "options", "userId", "isOriginalUser", "setMaster", "addSlaveToMaster", "data", "refreshActor", "setFlag", "masterId", "hp", "masterHp", "transfertHpData", "from", "to", "getInMemory", "setInMemory", "deleteInMemory", "STANCE_SAVANT", "REPLACERS", "EXTRAS", "stancesOptions", "value", "setup", "deleteCombat", "deleteCombatant", "createCombatant", "renderCharacterSheetPF2e", "getStances", "toggleStance", "isValidStance", "calledIfSetting", "hooks", "createTool", "refreshActorSheets", "__name", "stance", "actor", "stances", "replaced", "replace", "sourceId", "effectUUID", "effect", "img", "name", "itemName", "action", "actorStances", "foundAction", "getItemWithSourceId", "uuid", "sheet", "html", "isPlayedActor", "inCombat", "token", "tab", "options", "template", "render", "subLocalize", "event", "onToggleStance", "target", "canUseStances", "feat", "replacer", "extra", "getStancesEffects", "effects", "already", "create", "other", "more", "x", "addStance", "obj", "combat", "combatant", "getActorFromCombatant", "isOwner", "checkForSavant", "effectID", "hasItemWithSourceId", "info", "openStancesMenu", "localize", "summaryOptions", "value", "setup", "calledIfSetting", "registerCharacterSheetExtraTab", "getData", "addEvents", "unregisterCharacterSheetExtraTab", "refreshActorSheets", "__name", "html", "sheet", "actor", "inputs", "event", "onUsesInputChange", "onUsesInputFocus", "onUsesInputBlur", "onToggleFocusPool", "onSlotsReset", "onItemToChat", "inputPath", "entryId", "change", "points", "onChargesReset", "getSpellcastingTab", "dailies", "entry", "itemId", "rank", "isCharge", "item", "max", "slotLevel", "slot", "castRank", "collection", "focusPool", "pf2eStavesActive", "pf2eDailies", "pf2eDailiesActive", "stavesActive", "chargesPath", "spells", "focuses", "rituals", "hasFocusCantrips", "entries", "data", "slotId", "spell", "entryDc", "entryName", "isFocus", "isInnate", "isPrepared", "isSpontaneous", "isFlexible", "consumable", "charges", "dailiesData", "canPayCost", "group", "slotSpells", "isCantrip", "groupNumber", "spellSlotGroupIdToNumber", "isBroken", "active", "expended", "virtual", "uses", "localizePath", "sort", "getSetting", "a", "b", "localeCompare", "subLocalize", "ordinalString", "SAVES", "REROLL", "DEGREE_OF_SUCCESS", "TEXTEDITOR_ENRICH_HTML", "CHATLOG_ACTIVATE_LISTENERS", "targetOptions", "onSocket", "isGM", "getSetting", "socket", "getChatLogEntryContext", "registerWrapper", "textEditorEnrichHTML", "chatActivateListeners", "onDragStart", "preCreateChatMessage", "renderChatMessage", "message", "html", "latestChatMessages", "createTool", "packet", "userId", "activeGM", "isActiveGM", "updateMessageSave", "updateMessageApplied", "roll3dDice", "__name", "rollData", "targetData", "self", "target", "user", "roll", "synchronize", "INLINE_CHECK_REGEX", "wrapped", "args", "enriched", "onChatMessageDrop", "event", "isBasic", "pf2Dc", "pf2Check", "type", "pf2RollOptions", "pf2Traits", "MODULE", "messageId", "warn", "getFlag", "setFlag", "o", "info", "BASIC_SAVE_REGEX", "dataTransfer", "data", "label", "saves", "x", "joined", "_", "getMessageData", "inMemory", "getInMemory", "localizePath", "canRollSave", "save", "getSaveData", "rollSave", "HEALINGS_REGEX", "isRegenMessage", "healings", "isValidDamageMessage", "isDamageRoll", "updates", "token", "actor", "isRegen", "targets", "getTargets", "rolls", "splashRollIndex", "regularRollIndex", "modifier", "item", "dc", "updateSourceFlag", "acc", "key", "value", "clientEnabled", "deleteInMemory", "renderDamageChatMessage", "refreshMessage", "renderSpellChatMessage", "hasEmbeddedSpell", "bindOnPreCreateSpellDamageChatMessage", "chat", "el", "app", "spell", "msgContent", "cardBtns", "saveBtn", "wrapper", "targetsTooltip", "localize", "targetsBtn", "addTargets", "template", "rowsTemplate", "addHeaderListeners", "damageRows", "buttons", "toggleDamageRow", "expanded", "toggleBtn", "toggleTooltip", "setInMemory", "clonedRows", "action", "uuid", "isOwner", "applied", "isBasicSave", "clones", "index", "onTargetButton", "getRowsElement", "disableSaveListeners", "enableSaveListeners", "listener", "dataAction", "saveEnabled", "pingTarget", "openTargetSheet", "rerollSave", "flag", "targetsFlag", "showDC", "showMods", "showSuccess", "saveLabel", "saveDC", "render", "targetId", "isVisible", "hasPlayerOwner", "isFriendly", "hasSave", "saveFlag", "targetSave", "rerolled", "canReroll", "successLabel", "offset", "result", "adjustment", "subLocalize", "templateSave", "anonymous", "canSeeName", "name", "a", "b", "getTargetFromEvent", "targetUuid", "heroPoints", "icon", "reroll", "isHeroReroll", "keep", "max", "oldRoll", "unevaluatedNewRoll", "newRoll", "keptRoll", "success", "DegreeOfSuccess", "isAuthor", "statistic", "tokens", "targetPromises", "targetPromise", "rollOptions", "skipDefault", "skipDialog", "checkDialog", "dialog", "hookId", "resolve", "__", "msg", "context", "btn", "rollIndex", "toggleOffShieldBlock", "onClickShieldBlock", "applyDamageFromMessage", "onDamageApplied", "tokenId", "moduleFlagUpdate", "templateOptions", "value", "setHook", "createMeasuredTemplate", "createTool", "template", "_", "userId", "user", "localize", "subLocalize", "item", "actor", "self", "data", "render", "html", "result", "alliance", "opposition", "targetsIds", "getTemplateTokens", "token", "targetAlliance", "__name", "unidedOptions", "value", "setup", "preCreateItem", "preUpdateItem", "calledIfSetting", "hooks", "createTool", "__name", "item", "changes", "setupDebounced", "setup", "untargetOptions", "updateCombat", "setHook", "createTool", "enabled", "getSetting", "__name", "_", "data", "user", "localize", "subLocalize", "permaConditionEffect", "actor", "callback", "__name", "html", "type", "condition", "name", "slug", "img", "buttons", "conditions", "withBadge", "content", "render", "a", "b", "setInputs", "hasBadge", "badge", "result", "rule", "source", "registerModule", "FEATURES", "arpOptions", "debugOptions", "effectsOptions", "givethOptions", "heroOptions", "inventoryOptions", "knowledgesOptions", "merchantOptions", "mergeOptions", "nobulkOptions", "shareOptions", "stancesOptions", "summaryOptions", "targetOptions", "templateOptions", "unidedOptions", "untargetOptions", "CONFLICTS", "firstClientSetting", "isGM", "isUserGM", "settings", "feature", "checkFeatureOptions", "worldSettings", "scope", "clientSettings", "setting", "registerSetting", "first", "x", "renderSettingsConfig", "module", "getModule", "permaConditionEffect", "init", "conflicts", "api", "name", "id", "conflictingModule", "conflicting", "ready", "conflict", "warn", "_", "html", "moduleId", "MODULE", "moduleTab", "getSettingSection", "__name", "localize", "hideSettings", "global", "settingIsEnabled"]
}
