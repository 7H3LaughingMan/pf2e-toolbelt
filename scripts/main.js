(()=>{var ge=Object.defineProperty;var o=(e,t)=>ge(e,"name",{value:t,configurable:!0});var g="pf2e-toolbelt";function f(e){return game.settings.get(g,e)}o(f,"getSetting");function b(...e){let[t,n]=e;return t=`${g}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}o(b,"localize");function he(e){return game.i18n.has(`${g}.${e}`,!1)}o(he,"hasLocalization");function ye(e){return`${g}.${e}`}o(ye,"localizePath");function x(e){let t=o((...n)=>b(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>A(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>T(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>be(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>he(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>ye(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:i})=>t(n,i),enumerable:!1,configurable:!1}}),t}o(x,"subLocalize");function w(e,t,n,i){let s=typeof t=="string"?t:"info",r=typeof t=="object"?t:typeof n=="object"?n:void 0,l=typeof t=="boolean"?t:typeof n=="boolean"?n:i??!1;ui.notifications.notify(b(e,r),s,{permanent:l})}o(w,"notify");function A(...e){let[t,n,i]=e;w(t,"warning",n,i)}o(A,"warn");function T(...e){let[t,n,i]=e;w(t,"info",n,i)}o(T,"info");function be(...e){let[t,n,i]=e;w(t,"error",n,i)}o(be,"error");function P(e,t){libWrapper.register(g,e,t)}o(P,"registerWrapper");function p(e,t,n){return e.getFlag(g,t)??n}o(p,"getFlag");function F(e,t,n){return e.setFlag(g,t,n)}o(F,"setFlag");function k(...e){return e=e.filter(t=>typeof t=="string"),`modules/${g}/templates/${e.join("/")}.hbs`}o(k,"templatePath");var ve="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Ee="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Pe="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Re="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",ke=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function q(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{f("arp")&&(P(ve,Ce,"WRAPPER"),P(Ee,Ie,"WRAPPER"),P(Pe,Oe,"WRAPPER"),P(Re,xe,"WRAPPER"))},ready:e=>{e&&f("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),T("arp.forceVariant"))}}}o(q,"registerArp");function M(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}o(M,"isValidActor");function Y(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!ke.includes(e.sourceId)}o(Y,"isValidWeapon");function Ce(e){let t=this.actor;if(!M(t,!0)||!Y(this))return e();let n=t.level,i=this._source.system.traits.value;if(i.includes("alchemical")&&i.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}o(Ce,"onPrepareWeaponData");var Ae={1:35,2:935,3:8935,4:8935},De={striking:65,greaterStriking:1065,majorStriking:31065};function Ie(e){if(e(),!M(this.actor)||this.isSpecific||!Y(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Ae[n]);let i=this.system.strikingRune.value;i&&(t-=De[i]),(n||i)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}o(Ie,"onPrepareWeaponDerivedData");function K(e){return!e.isShield}o(K,"isValidArmor");function Oe(e){let t=this.actor;if(!M(t,!0)||!K(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}o(Oe,"onPrepareArmorData");var Se={1:160,2:1060,3:20560,4:20560},_e={resilient:340,greaterResilient:3440,majorResilient:49440};function xe(e){if(e(),!M(this.actor)||this.isSpecific||!K(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Se[n]);let i=this.system.resiliencyRune.value;i&&(t-=_e[i]),(n||i)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}o(xe,"onPrepareArmorDerivedData");function C(e,t,n=()=>{}){let i=null;return function(s,r=[]){typeof r=="string"&&(r=[r]),s||=r.some(l=>f(l)),s&&!i?i=Hooks.on(e,t):!s&&i&&(Hooks.off(e,i),i=null),n(s)}}o(C,"createHook");var L=C("renderEffectsPanel",$e,Me);function J(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>L(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>L(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{L(!1,["effect-remove","condition-sheet"])}}}o(J,"registerEffectsPanelHelper");function Me(){game.pf2e.effectPanel?.render()}o(Me,"refreshEffectsPanel");function $e(e,t){let n=`<div>${b("effects.remove")}</div>`,i='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',s=t.find(".effect-item[data-item-id]").toArray();for(let r of s){let l=r.dataset.itemId,c=e.actor?.items.get(l);if(c&&(f("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(r.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),r.querySelector(".icon").addEventListener("contextmenu",d=>Te(d,e),!0)),f("condition-sheet")&&c.isOfType("condition"))){let d=r.querySelector(".effect-info > h1");d.insertAdjacentHTML("beforeend",i),d.querySelector('[data-action="edit"]').addEventListener("click",m=>we(m,e))}}}o($e,"renderEffectsPanel");function we(e,t){let n=X(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}o(we,"onConditionSheet");function Te(e,t){if(!e.shiftKey)return;let n=X(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}o(Te,"onRemoveEffect");function X(e,t){let s=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(s)}o(X,"getEffect");var Z=x("knowledges.editLore"),D=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Z("title",this.actor)}get template(){return k("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:p(n,"unspecified")??"",specific:p(n,"specific")??"",i18n:Z})}async _updateObject(t,{unspecified:n,specific:i}){let s=this.object;F(s,"unspecified",n.trim()),F(s,"specific",i.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};o(D,"EditLores");var Q=C("renderNPCSheetPF2e",Fe);function ee(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:Q}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&f("knowledges")&&Q(!0)}}}o(ee,"registerKnowledges");function Fe(e,t){let n=e.actor;Ne(n,t),je(t),He(n,t)}o(Fe,"renderNPCSheetPF2e");function N(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}o(N,"knowledgeSelector");function Le(e){new D(e).render(!0)}o(Le,"editLores");function Ne(e,t){let n=p(e,"unspecified"),i=p(e,"specific");if(!n&&!i)return;let s=e.identificationDCs.lore,r=N(t,"body","");r.find(".identification-skills").last().remove();function l(d,m,h){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:d,dc:m,adjustment:h})}</div>`}o(l,"tag");function c(d,{dc:m,start:h}){let u=d.split(",").filter(E=>E.trim()).map(E=>l(E,m,h)).join("");r.append(u)}o(c,"addTags"),c(n||"Unspecific",s[0]),c(i||"Specific",s[1])}o(Ne,"replaceLores");function He(e,t){N(t,"header","button.edit").on("click",()=>Le(e))}o(He,"addEvents");function je(e){let t=N(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}o(je,"addEditButton");var H=x("merge.multi"),I=class extends Application{constructor(t,n){super(n),this._spell=t}get spell(){return this._spell}get title(){return H("title",this.spell)}get template(){return k("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:H})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){H.error("zero"),this.close();return}let i=this.spell,s=deepClone(i._source.system.damage.value),r=deepClone(i._source.system.heightening)??{};for(let[c,d]of Object.entries(s))for(let m=0;m<n-1;m++){let h=randomID();if(s[h]=d,r.type==="interval"){let u=r.damage[c];u&&(r.damage[h]=u)}else if(r.type==="fixed")for(let[u,E]of Object.entries(r.levels)){let S=E.damage.value[c];S&&(r.levels[u].damage.value[h]=S)}}i.clone({"system.damage.value":s,"system.heightening":r}).rollDamage(t),this.close()}#t(t){t.preventDefault(),this.close()}};o(I,"MultiCast");var Be=/<div class="tags"><span class="tag".+?<\/div>/gm,Ge=/<span class="tag tag_transparent">(.+?)<\/span>/gm,Ue=/(\[[\w,]+\])/,j=C("renderChatMessage",re,We);function ie(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>j(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>j(e,"merge-damage")}],init:e=>{j(!1,["multi-cast","merge-damage"])}}}o(ie,"registerMerge");function We(){let e=ui.chat?.element;if(e)for(let t of ae(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),re(t,n))}}o(We,"updateMessages");function re(e,t){!game.user.isGM&&!e.isAuthor||(f("merge-damage")&&ce(e)?Ve(e,t):f("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&ze(e,t))}o(re,"renderChatMessage");function ze(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let i=t.find(".message-content .chat-card .owner-buttons .spell-button");i.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${b("merge.spell.button")}</button>`),i.find("[data-action=multi-cast]").on("click",async s=>{let r=await fromUuid(n);r&&new I(r).render(!0)})}o(ze,"renderSpell");function Ve(e,t){let n=B(e);if(!n)return;let s=`<span style="position: absolute; right: 0px; bottom: 1px;">
    <button data-action="merge-damage" title="${b("merge.damage.tooltip")}" style="width: 22px; height: 22px; font-size: 10px; line-height: 1px;">
        <i class="fa-duotone fa-merge"></i>
    </button>
</span>`,r=G(e);t.find(".dice-result .dice-total").append(s),t.find("[data-action=merge-damage]").on("click",l=>{l.stopPropagation();for(let c of ae(5,e))if(!(B(c)!==n||G(c)!==r||!ce(c))){qe(l,e,c);return}A("merge.damage.none")})}o(Ve,"renderDamage");async function qe(e,t,n){let i=Ye(t,n),s=Ke(t,n),r=ne(n),l=oe(n),c=G(t),d=B(t);for(let a of ne(t))r.includes(a)||r.push(a);for(let a of oe(t))l.includes(a)||l.push(a);let m=te(t),h=te(n),u=[];function E(a){return u.find(({options:{flavor:y,critRule:R}})=>y===a.flavor&&R===a.critRule)}o(E,"findGroup");for(let a of[].concat(h,m)){let{options:y,total:R,terms:$}=a,z=$[0],V=a.formula.replace(Ue,""),_=E(y);_?(_.terms.push(z),_.total+=R,_.formulas.push(V)):u.push({options:y,formulas:[V],total:R,terms:[z]})}for(let a of u)a.formula=`(${a.formulas.join(" + ")})[${a.options.flavor}]`,a.term=a.terms.length<2?a.terms[0]:se(a.terms);let S={class:"DamageRoll",options:{},dice:[],formula:`{${u.map(({formula:a})=>a).join(", ")}}`,total:u.reduce((a,{total:y})=>a+y,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:u.map(({formula:a})=>a),modifiers:[],rolls:u.map(({options:a,formula:y,total:R,term:$})=>({class:"DamageInstance",options:a,dice:[],formula:y,total:R,terms:[$],evaluated:!0})),results:u.map(({total:a})=>({result:a,active:!0}))}]};ui.chat.element.find(`[data-message-id=${t.id}], [data-message-id=${n.id}]`).remove(),await ChatMessage.deleteDocuments([t.id,n.id]);let me=await renderTemplate(k("merge/merged"),{header:b("merge.merged.header",{name:i}),tags:s,notes:r,modifiers:l});await CONFIG.ChatMessage.documentClass.create({flavor:me,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[g]:{name:i,tags:s,notes:r,modifiers:l,uuid:d,type:"damage-roll",target:c,merged:!0}},rolls:[S]})}o(qe,"mergeDamages");function se(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?se(e):e[0]]}}}o(se,"createTermGroup");function*ae(e,t){let n=game.messages.contents,i=(t?n.findLastIndex(s=>s===t):n.length)-1;for(let s=i;s>=i-e;s--){let r=n[s];if(!r)return;yield r}}o(ae,"chatMessages");function te(e){return p(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}o(te,"getMessageRolls");function B(e){return U(e,"origin.uuid","uuid")}o(B,"getMessageUuid");function ce(e){return U(e,"context.type","type")==="damage-roll"}o(ce,"isDamageRoll");function G(e){return U(e,"context.target.token","target")}o(G,"getMessageTarget");function Ye(e,t){return p(e,"name")??p(t,"name")??e.getFlag("pf2e","strike.name")??e.item.name}o(Ye,"getItemName");function Ke(e,t){return p(e,"tags")??p(t,"tags")??e.flavor.match(Be)?.[0]??""}o(Ke,"getTags");function ne(e){return p(e,"notes")??e.getFlag("pf2e","context.notes").map(({title:t,text:n})=>`<strong>${game.i18n.localize(t)}</strong> ${game.i18n.localize(n)}`)}o(ne,"getMessageNotes");function oe(e){let t=p(e,"modifiers");if(t)return t;t=[];let n;for(;n=Ge.exec(e.flavor);)t.push(n[1]);return t}o(oe,"getMessageModifiers");function U(e,t,n){return e.getFlag("pf2e",t)??p(e,n)}o(U,"getMessageFlag");var Je="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments";function le(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0}],init:()=>{f("nobulk")&&P(Je,Xe,"WRAPPER")}}}o(le,"registerNobulk");function Xe(e,...t){e(...t);let n=this,i=n.inventory.bulk.constructor;Object.defineProperty(n.inventory,"bulk",{get(){let s=new i(n);return s.value=i.computeTotalBulk(n.inventory.filter(r=>!r.isInContainer&&r.system.equipped.carryType!=="dropped"),n.size),s}})}o(Xe,"actorPrepareEmbeddedDocuments");var O=null,v=null;function ue(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:fe}],conflicts:["pf2e-unided"],init:()=>{fe()}}}o(ue,"registerUnided");function fe(e){e??=f("unided"),e==="disabled"?(O&&(Hooks.off("preCreateItem",O),O=null),v&&(Hooks.off("preUpdateItem",v),v=null)):(O||(O=Hooks.on("preCreateItem",Ze)),e==="all"&&!v?v=Hooks.on("preUpdateItem",Qe):e!=="all"&&v&&(Hooks.off("preUpdateItem",v),v=null))}o(fe,"setHooks");function Ze(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}o(Ze,"preCreateItem");function Qe(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}o(Qe,"preUpdateItem");var de=[q(),le(),ee(),ue(),ie(),J()],pe=new Set;Hooks.once("init",()=>{let e=game.data.users.find(n=>n._id===game.data.userId),t=e&&e.role>=CONST.USER_ROLES.GAMEMASTER;for(let n of de){let{settings:i=[],init:s,conflicts:r=[]}=n;for(let l of i){let c=l.name;l.choices&&(l.choices=l.choices.reduce((d,m)=>(d[m]=W(c,`choices.${m}`),d),{})),game.settings.register(g,c,{scope:"world",config:!0,...l,name:W(c,"name"),hint:W(c,"hint")})}if(t)for(let l of r){let c=game.modules.get(l);c?.active&&(n.conflicting=!0,pe.add(c.title))}!n.conflicting&&s&&s(t)}});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of de)!t&&n&&n(e);if(e)for(let t of pe)A("module-conflict",{name:t},!0)});function W(e,t){return`${g}.settings.${e}.${t}`}o(W,"settingPath");})();
//# sourceMappingURL=main.js.map
