(()=>{var Wt=Object.defineProperty;var i=(e,t)=>Wt(e,"name",{value:t,configurable:!0});var h="pf2e-toolbelt";function M(e,t,n){return libWrapper.register(h,e,t,n)}i(M,"registerWrapper");function b(...e){let[t,n]=e;return t=`${h}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}i(b,"localize");function Vt(e){return game.i18n.has(`${h}.${e}`,!1)}i(Vt,"hasLocalization");function Yt(e){return`${h}.${e}`}i(Yt,"localizePath");function S(e){let t=i((...n)=>b(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>v(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>G(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>H(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>Vt(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>Yt(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:o})=>t(n,o),enumerable:!1,configurable:!1}}),t}i(S,"subLocalize");function le(e,t,n,o){let s=typeof t=="string"?t:"info",a=typeof t=="object"?t:typeof n=="object"?n:void 0,r=typeof t=="boolean"?t:typeof n=="boolean"?n:o??!1;ui.notifications.notify(b(e,a),s,{permanent:r})}i(le,"notify");function v(...e){let[t,n,o]=e;le(t,"warning",n,o)}i(v,"warn");function G(...e){let[t,n,o]=e;le(t,"info",n,o)}i(G,"info");function H(...e){let[t,n,o]=e;le(t,"error",n,o)}i(H,"error");function p(e){return game.settings.get(h,e)}i(p,"getSetting");function Ae(e,t){return game.settings.set(h,e,t)}i(Ae,"setSetting");var Kt="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Qt="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Jt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Xt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",Zt=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function Te(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{p("arp")&&(M(Kt,en,"WRAPPER"),M(Qt,on,"WRAPPER"),M(Jt,sn,"WRAPPER"),M(Xt,cn,"WRAPPER"))},ready:e=>{e&&p("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),G("arp.forceVariant"))}}}i(Te,"registerArp");function J(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}i(J,"isValidActor");function Pe(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!Zt.includes(e.sourceId)}i(Pe,"isValidWeapon");function en(e){let t=this.actor;if(!J(t,!0)||!Pe(this))return e();let n=t.level,o=this._source.system.traits.value;if(o.includes("alchemical")&&o.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}i(en,"onPrepareWeaponData");var tn={1:35,2:935,3:8935,4:8935},nn={striking:65,greaterStriking:1065,majorStriking:31065};function on(e){if(e(),!J(this.actor)||this.isSpecific||!Pe(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=tn[n]);let o=this.system.strikingRune.value;o&&(t-=nn[o]),(n||o)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}i(on,"onPrepareWeaponDerivedData");function Oe(e){return!e.isShield}i(Oe,"isValidArmor");function sn(e){let t=this.actor;if(!J(t,!0)||!Oe(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}i(sn,"onPrepareArmorData");var an={1:160,2:1060,3:20560,4:20560},rn={resilient:340,greaterResilient:3440,majorResilient:49440};function cn(e){if(e(),!J(this.actor)||this.isSpecific||!Oe(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=an[n]);let o=this.system.resiliencyRune.value;o&&(t-=rn[o]),(n||o)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}i(cn,"onPrepareArmorDerivedData");function E(e,t,n=()=>{}){let o=null;return function(s,a=[],r=!1){typeof a=="string"&&(a=[a]),s||=a.some(c=>p(c)),s&&!o?o=Hooks.on(e,t):!s&&o&&(Hooks.off(e,o),o=null),r||n(s)}}i(E,"createHook");function X(e,t,n=()=>{}){let o=null;return function(s,a=!1){s==="disabled"&&o?(Hooks.off(e,o),o=null):s!=="disabled"&&!o&&(o=Hooks.on(e,t)),a||n(s)}}i(X,"createChoicesHook");function xe(e,t){let n=Hooks.on(e,t),o=Hooks.events[e].findIndex(s=>s.id===n);if(o!==0){let[s]=Hooks.events[e].splice(o,1);Hooks.events[e].unshift(s)}return n}i(xe,"registerUpstreamHook");var fe=E("renderEffectsPanel",fn,ln);function Me(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>fe(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>fe(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{fe(!1,["effect-remove","condition-sheet"])}}}i(Me,"registerEffectsPanelHelper");function ln(){game.pf2e.effectPanel?.render()}i(ln,"refreshEffectsPanel");function fn(e,t){let n=`<div>${b("effects.remove")}</div>`,o='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',s=t.find(".effect-item[data-item-id]").toArray();for(let a of s){let r=a.dataset.itemId,c=e.actor?.items.get(r);if(c&&(p("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(a.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),a.querySelector(".icon").addEventListener("contextmenu",l=>dn(l,e),!0)),p("condition-sheet")&&c.isOfType("condition"))){let l=a.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",o),l.querySelector('[data-action="edit"]').addEventListener("click",u=>un(u,e))}}}i(fn,"renderEffectsPanel");function un(e,t){let n=Re(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}i(un,"onConditionSheet");function dn(e,t){if(!e.shiftKey)return;let n=Re(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}i(dn,"onRemoveEffect");function Re(e,t){let s=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(s)}i(Re,"getEffect");var z=class extends FormApplication{constructor(t,n,o){super(t,n),this.onSubmitCallback=o}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};i(z,"MoveLootPopup");function ue(){return CONFIG.ChatMessage.documentClass}i(ue,"getChatMessageClass");function*B(e,t){let n=game.messages.contents,o=(t?n.findLastIndex(s=>s===t):n.length)-1;for(let s=o;s>=o-e;s--){let a=n[s];if(!a)return;yield a}}i(B,"latestChatMessages");function R(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}i(R,"chatUUID");function Z(e){game.socket.on(`module.${h}`,e)}i(Z,"socketOn");function ee(e){game.socket.off(`module.${h}`,e)}i(ee,"socketOff");function x(e){game.socket.emit(`module.${h}`,e)}i(x,"socketEmit");function te(){return game.user===game.users.activeGM}i(te,"isActiveGM");function Ue(){return game.users.some(e=>e.active&&e.isGM)}i(Ue,"isGMOnline");function $e(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}i($e,"getCharacterOwner");function mn(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,o)=>n.id>o.id?1:-1),t[0]||null}i(mn,"getActiveOwner");function de(e){return mn(e)===game.user}i(de,"isActiveOwner");function _e(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}i(_e,"getOwner");var ne=!1,q=null;function Ne(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:Le}],conflicts:["pf2e-giveth"],ready:e=>{p("giveth")!=="disabled"&&Le(!0)}}}i(Ne,"registerGiveth");function Le(e){let t=game.user.isGM;e==="disabled"&&ne?(t?ee(He):q&&(Hooks.off("dropCanvasData",q),q=null),ne=!1):e!=="disabled"&&!ne&&(t?Z(He):q||(q=xe("dropCanvasData",pn)),ne=!0)}i(Le,"setup");function He(e){te()&&(e.type==="giveth-condition"?yn(e):e.type==="giveth-effect"?bn(e):vn(e))}i(He,"onSocket");function pn(e,t){if(!Ue())return!0;let n=hn(t);if(!n)return!0;let o=e.tokens.placeables.slice().filter(s=>{if(!s.document.actorLink)return!1;let a=s.actor;if(!Ge(a,t.actorId)||a.isOwner)return!1;let r=s.x+(s.hitArea?.right??0),c=s.y+(s.hitArea?.bottom??0);return t.x>=s.x&&t.y>=s.y&&t.x<=r&&t.y<=c}).sort((s,a)=>a.document.sort-s.document.sort).at(0)?.actor;return o?(gn(n.actor,o,n.item,n.value),!1):!0}i(pn,"onDropCanvasData");function gn(e,t,n,o){let s=e.id,a=t.id,r=!(n instanceof Item);if(!r&&n.isOfType("physical")){let c=n.quantity;if(c<1)return v("giveth.notification.zero");if(c===1)return Fe(s,a,n.id,1,!1);new z(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,u)=>{Fe(s,a,n.id,l,u)}).render(!0)}else{let c=r?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?x({type:"giveth-condition",targetId:a,value:o??1,uuid:c}):x({type:"giveth-effect",targetId:a,uuid:c})}}i(gn,"giveth");function Fe(e,t,n,o,s){x({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:o,stack:s})}i(Fe,"sendPhysicalRequest");function Ge(e,t){return!e||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}i(Ge,"isValidActor");function hn(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let s=e.context?.origin.actor;n=s?fromUuidSync(s):null}if(!Ge(n)||!n.isOwner)return;let o=!(t instanceof Item);if(o&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!o&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}i(hn,"getDetailsFromData");async function yn({targetId:e,uuid:t,value:n}){let o=game.actors.get(e);if(!o)return;let s=await fromUuid(t);s&&o.increaseCondition(s.slug,{min:n})}i(yn,"takethCondition");async function bn({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let o=await fromUuid(t);if(!o)return;let s=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[s])}i(bn,"takethEffect");async function vn({itemId:e,ownerId:t,qty:n,stack:o,targetId:s}){let a=game.actors.get(t),r=game.actors.get(s);if(!a||!r)return;let c=a.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,u=c.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=c.traits.has("invested")?!1:null);let d=await r.addToInventory(u,void 0,o);if(!d||(l<1?c.delete():c.update({"system.quantity":l}),p("giveth")==="no-message"))return;let y=R(d.uuid,d.name,!d.isIdentified);n>1&&(y+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${b("giveth.giveth",{target:r.name})}</h4>`,content:y,speaker:ChatMessage.getSpeaker({actor:a})})}i(vn,"takethPhysical");function D(e,t,n){return e.getFlag(h,t)??n}i(D,"getFlag");function me(e,t,n){return e.setFlag(h,t,n)}i(me,"setFlag");function I(...e){return e=e.filter(t=>typeof t=="string"),`modules/${h}/templates/${e.join("/")}.hbs`}i(I,"templatePath");var je=S("knowledges.editLore"),W=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return je("title",this.actor)}get template(){return I("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:D(n,"unspecified")??"",specific:D(n,"specific")??"",i18n:je})}async _updateObject(t,{unspecified:n,specific:o}){let s=this.object;me(s,"unspecified",n.trim()),me(s,"specific",o.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};i(W,"EditLores");var ze=E("renderNPCSheetPF2e",Cn);function Be(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>ze(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&p("knowledges")&&ze(!0)}}}i(Be,"registerKnowledges");function Cn(e,t){let n=e.actor;wn(n,t),In(t),Sn(n,t)}i(Cn,"renderNPCSheetPF2e");function pe(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}i(pe,"knowledgeSelector");function kn(e){new W(e).render(!0)}i(kn,"editLores");function wn(e,t){let n=D(e,"unspecified"),o=D(e,"specific");if(!n&&!o)return;let s=e.identificationDCs.lore,a=pe(t,"body","");a.find(".identification-skills").last().remove();function r(l,u,d){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:d})}</div>`}i(r,"tag");function c(l,{dc:u,start:d}){let y=l.split(",").filter(g=>g.trim()).map(g=>r(g,u,d)).join("");a.append(y)}i(c,"addTags"),c(n||"Unspecific",s[0]),c(o||"Specific",s[1])}i(wn,"replaceLores");function Sn(e,t){pe(t,"header","button.edit").on("click",()=>kn(e))}i(Sn,"addEvents");function In(e){let t=pe(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}i(In,"addEditButton");var ge=S("merge.multi"),V=class extends Application{constructor(t,n){super(n),this._spell=t}get spell(){return this._spell}get title(){return ge("title",this.spell)}get template(){return I("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:ge})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){ge.error("zero"),this.close();return}let o=this.spell,s=deepClone(o._source.system.damage.value),a=deepClone(o._source.system.heightening)??{};for(let[c,l]of Object.entries(s))for(let u=0;u<n-1;u++){let d=randomID();if(s[d]=l,a.type==="interval"){let y=a.damage[c];y&&(a.damage[d]=y)}else if(a.type==="fixed")for(let[y,g]of Object.entries(a.levels)){let w=g.damage.value[c];w&&(a.levels[y].damage.value[d]=w)}}o.clone({"system.damage.value":s,"system.heightening":a}).rollDamage(t),this.close()}#t(t){t.preventDefault(),this.close()}};i(V,"MultiCast");function oe(e,t){return e.localeCompare(t,game.i18n.lang)}i(oe,"localeCompare");function F(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}i(F,"refreshCharacterSheets");function qe(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let o of e){let s=n.findIndex(a=>o===a);if(s===-1)return!1;n.splice(s,1)}return!0}i(qe,"compareArrays");var Dn=/<div class="tags"><span class="tag".+?<\/div>/gm,En=/<span class="tag tag_transparent">(.+?)<\/span>/gm,An=/(\[[\w,]+\])/,he=E("renderChatMessage",Je,Tn);function Qe(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>he(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>he(e,"merge-damage")}],init:e=>{he(!1,["multi-cast","merge-damage"],!0)}}}i(Qe,"registerMerge");function Tn(){let e=ui.chat?.element;if(e)for(let t of B(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),Je(t,n))}}i(Tn,"updateMessages");function Je(e,t){!game.user.isGM&&!e.isAuthor||(p("merge-damage")&&et(e)?On(e,t):p("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&Pn(e,t))}i(Je,"renderChatMessage");function Pn(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let o=t.find(".message-content .chat-card .owner-buttons .spell-button");o.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${b("merge.spell.button")}</button>`),o.find("[data-action=multi-cast]").on("click",async s=>{let a=await fromUuid(n);a&&new V(a).render(!0)})}i(Pn,"renderSpell");function On(e,t){let n='<span class="pf2e-toolbelt-merge">';if(D(e,"merged")){let r=b("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${r}">`,n+='<i class="fa-duotone fa-split"></i>'}let o=b("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${o}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let s=Ye(e),a=Ke(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",r=>{r.stopPropagation();for(let c of B(5,e))if(!(!et(c)||Ye(c)!==s||Ke(c)!==a)){Mn(r,e,c,{actorUUID:s,targetUUID:a});return}v("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",r=>{r.stopPropagation(),xn(r,e)})}i(On,"renderDamage");async function xn(e,t){let n=D(t,"data").flatMap(o=>o.source);await Xe(t.id),await ue().createDocuments(n)}i(xn,"splitDamages");async function Mn(e,t,n,{actorUUID:o,targetUUID:s}){let a={},r=We(n).concat(We(t));for(let{name:f,notes:m,outcome:C,modifiers:k,tags:A}of r)a[f]??={name:f,tags:A,notes:new Set,results:[]},m.forEach(a[f].notes.add,a[f].notes),a[f].results.some(P=>P.outcome===C&&qe(P.modifiers,k))||a[f].results.push({outcome:C,modifiers:k});let c=Object.values(a).map(f=>(f.label=f.name,f.results.forEach(m=>{m.outcome&&(m.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${m.outcome}`))}),f));c.at(-1).isLastGroup=!0;let l=await renderTemplate(I("merge/merged"),{groups:c,hasMultipleGroups:c.length>1}),u=Ve(t),d=Ve(n),y=[];function g(f){return y.find(({options:{flavor:m,critRule:C}})=>m===f.flavor&&C===f.critRule)}i(g,"findGroup");for(let f of[].concat(d,u)){let{options:m,total:C,terms:k}=f,A=k[0],O=f.formula.replace(An,""),P=g(m);P?(P.terms.push(A),P.total+=C,P.formulas.push(O)):y.push({options:m,formulas:[O],total:C,terms:[A]})}for(let f of y)f.formula=`(${f.formulas.join(" + ")})[${f.options.flavor}]`,f.term=f.terms.length<2?f.terms[0]:Ze(f.terms);let w={class:"DamageRoll",options:{},dice:[],formula:`{${y.map(({formula:f})=>f).join(", ")}}`,total:y.reduce((f,{total:m})=>f+m,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:y.map(({formula:f})=>f),modifiers:[],rolls:y.map(({options:f,formula:m,total:C,term:k})=>({class:"DamageInstance",options:f,dice:[],formula:m,total:C,terms:[k],evaluated:!0})),results:y.map(({total:f})=>({result:f,active:!0}))}]};await Xe(t.id,n.id),await ue().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[h]:{actor:o,target:s,merged:!0,type:"damage-roll",data:r}},rolls:[w]})}i(Mn,"mergeDamages");function We(e){let t=D(e,"data");if(t)return t;let n=e.toObject();return delete n._id,delete n.timestamp,[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,modifiers:Rn(e),tags:e.flavor.match(Dn)?.[0]??"",notes:n.flags.pf2e.context.notes.map(({title:o,text:s})=>`<strong>${game.i18n.localize(o)}</strong> ${game.i18n.localize(s)}`)}]}i(We,"getMessageData");function Xe(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}i(Xe,"removeChatMessages");function Ze(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?Ze(e):e[0]]}}}i(Ze,"createTermGroup");function Ve(e){return D(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}i(Ve,"getMessageRolls");function Ye(e){return D(e,"actor")??e.actor?.uuid}i(Ye,"getActorUUID");function Ke(e){return D(e,"target")??e.target?.actor.uuid}i(Ke,"getTargetUUID");function et(e){return D(e,"type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}i(et,"isDamageRoll");function Rn(e){let t=[],n;for(;n=En.exec(e.flavor);)t.push(n[1]);return t}i(Rn,"getMessageModifiers");var Un="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",$n="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function tt(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{p("nobulk")&&M(Un,Ln,"WRAPPER"),p("nobulk-coins")&&M($n,_n,"WRAPPER")}}}i(tt,"registerNobulk");function _n(e){e(),this.isCoinage&&(this.system.bulk.value=0)}i(_n,"treasurePrepareBaseData");function Ln(e,...t){e(...t);let n=this,o=n.inventory.bulk.constructor,s=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return s||(s=o.computeTotalBulk(this.actor.inventory.filter(a=>!a.isInContainer&&a.system.equipped.carryType!=="dropped"),this.actor.size),s)}})}i(Ln,"actorPrepareEmbeddedDocuments");function nt(e){return e.getFlag("core","sourceId")}i(nt,"getSourceId");function Hn(e,t){let n=nt(e);return n?t.includes(n):!1}i(Hn,"includesSourceId");function ot(e){return Array.isArray(e)?t=>Hn(t,e):t=>nt(t)===e}i(ot,"getItemSourceIdCondition");function it(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}i(it,"getItems");function st(e,t,n){return it(e,n).some(ot(t))}i(st,"hasItemWithSourceId");function ie(e,t,n){return it(e,n).find(ot(t))}i(ie,"getItemWithSourceId");var Fn=E("renderCharacterSheetPF2e",Wn),Nn=E("deleteCombat",Yn),Gn=E("deleteCombatant",dt),jn=E("createCombatant",Kn),zn=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Bn=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),qn=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function rt(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:at},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:ye,toggleStance:ut,isValidStance:ct},ready:e=>{p("stances")&&at(!0)}}}i(rt,"registerStances");function at(e){Fn(e),Nn(e),Gn(e),jn(e)}i(at,"setup");function ct(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}i(ct,"isValidStance");function ye(e){let t=[],n=new Set;for(let{replace:o,sourceId:s,effectUUID:a,effect:r,img:c,name:l,itemName:u,action:d}of lt(e)){o&&n.add(o);let y=d?ie(e,d,"action"):ie(e,s,"feat");t.push({name:l,itemName:u,uuid:s,img:c,effectUUID:a,effectID:r?.id,actionUUID:y.sourceId,actionID:y.id})}return t.filter(({uuid:o})=>!n.has(o))}i(ye,"getStances");async function Wn(e,t){let n=e.actor,o=await ye(n);if(!o.length)return;let s=n.getActiveTokens(!0,!0).some(l=>l.inCombat),a=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),r=a.find(".actions-options"),c=await renderTemplate(I("stances/sheet"),{stances:o,canUseStances:s&&!n.isDead,i18n:S("stances")});r.length?r.after(c):a.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>Vn(l,n))}i(Wn,"renderCharacterSheetPF2e");function Vn(e,t){let n=e.currentTarget,o=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!o)return;let s=n.dataset.effectUuid;ut(t,s)}i(Vn,"onToggleStance");function*lt(e){for(let t of e.itemTypes.feat){let n=t.sourceId,o=Bn.get(n),s=qn.get(n);if(!o&&!s&&!ct(t))continue;let a=o?.effect??s?.effect??t.system.selfEffect.uuid,r=fromUuidSync(a);r&&(yield{name:(o&&fromUuidSync(o.replace)?.name)??t.name,itemName:t.name,replace:o?.replace,extra:s,sourceId:n,effectUUID:a,effect:ie(e,a,"effect"),action:s?.action,img:r.img})}}i(lt,"actorStances");function ft(e){let t=[];for(let{effect:n}of lt(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}i(ft,"getStancesEffects");async function ut(e,t){let n=ft(e),o=n.findIndex(a=>a.uuid===t),s=!1;if(o===-1)s=!0;else{let a=n.filter(c=>c.uuid!==t).length,r=n.filter(c=>c.uuid===t).length>1;(a||r)&&n.splice(o,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(a=>a.id)),s&&be(e,t)}i(ut,"toggleStance");async function be(e,t){let n=await fromUuid(t);if(n){let o=n.toObject();return getProperty(o,"flags.core.sourceId")||setProperty(o,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[o]))[0]?.toMessage(),!0}return!1}i(be,"addStance");function Yn(e){for(let t of e.combatants)dt(t)}i(Yn,"deleteCombat");function dt(e){let t=mt(e);if(t){if(!game.user.isGM&&de(t)){let n=ft(t).map(o=>o.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}F(t)}}i(dt,"deleteCombatant");function Kn(e){let t=mt(e);t&&(!game.user.isGM&&de(t)&&Qn(t),F(t))}i(Kn,"createCombatant");function mt(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}i(mt,"getActorFromCombatant");async function Qn(e){let t=ye(e);if(!(!t.length||t.filter(({effectID:s})=>s).length||!st(e,zn,["feat"])))if(t.length===1){let s=t[0];await be(e,s.effectUUID)&&G("stances.useStance",{stance:s.name})}else Jn(e,t)}i(Qn,"checkForSavant");async function Jn(e,t){let n=S("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(I("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:o=>be(e,o.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}i(Jn,"openStancesMenu");var pt=X("renderCharacterSheetPF2e",Xn,()=>F());function gt(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>pt(e)}],conflicts:["pf2e-spells-summary"],init:e=>{p("summary")!=="disabled"&&pt(!0,!0)}}}i(gt,"registerSpellsSummary");async function Xn(e,t){let n=e.actor;if(!n||n.pack||!n.id||!game.actors.has(n.id))return;let o=Y(t);getProperty(e,`modules.${h}.toggled`)&&o.addClass("toggled"),mo(t).on("click",s=>uo(s,t,e)),await Zn(t,e,n),o.hasClass("toggled")&&o.hasClass("active")&&e._restoreScrollPositions(t)}i(Xn,"renderCharacterSheetPF2e");async function Zn(e,t,n){let o=Y(e),s=await ho(n),a=await renderTemplate(I("summary/sheet"),s);o.append(a),eo(e,t,n)}i(Zn,"addSummaryTab");function eo(e,t,n){let o=go(e),s=o.find(".spell-type .uses .spell-slots-input input");s.on("change",a=>to(a,n)),s.on("focus",no),s.on("blur",oo),o.find(".cast-spell").on("click",a=>co(a,n)),o.find(".item-toggle-prepare").on("click",a=>io(a,n)),o.find(".focus-pips").on("click contextmenu",a=>so(a,n)),o.find(".spell-slots-increment-reset").on("click",a=>ro(a,t,n)),o.find(".item-image").on("click",a=>fo(a,n)),o.find(".item-name > h4").on("click",a=>lo(a,t))}i(eo,"addSummaryEvents");async function to(e,t){e.preventDefault();let{inputPath:n,entryId:o}=$(e.currentTarget).data(),s=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:o,[n]:s}])}i(to,"onUsesInputChange");function no(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}i(no,"onUsesInputFocus");function oo(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}i(oo,"onUsesInputBlur");function io(e,t){e.preventDefault();let{slotLevel:n,slotId:o,entryId:s,expended:a}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(s)?.setSlotExpendedState(n??0,o??0,a!==!0)}i(io,"onTogglePrepare");function so(e,t){e.preventDefault();let n=e.type==="click"?1:-1,o=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":o})}i(so,"onToggleFocusPool");function ao(e,t){po(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}i(ao,"onChargeReset");function ro(e,t,n){e.preventDefault();let{itemId:o,level:s,isCharge:a}=$(e.currentTarget).data();if(!o)return;if(a){ao(t,o);return}let r=n.items.get(o);if(r){if(r.isOfType("spellcastingEntry")){let c=s>=0&&s<=11?`slot${s}`:"slot0",l=r.system.slots?.[c];l&&r.update({[`system.slots.${c}.value`]:l.max})}else if(r.isOfType("spell")){let c=r.system.location.uses?.max;c&&r.update({"system.location.uses.value":c})}}}i(ro,"onSlotsReset");function co(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:o,slotLevel:s,slotId:a,entryId:r}=n.closest(".item").data(),c=t.spellcasting.collections.get(r);if(!c)return;let l=c.get(o);l&&c.entry.cast(l,{slot:a,level:s})}i(co,"onCastSpell");async function lo(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}i(lo,"onToggleSummary");async function fo(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),o=t.items.get(n);!o||o.isOfType("physical")&&!o.isIdentified||await o.toMessage(e)}i(fo,"onItemToChat");function uo(e,t,n){e.preventDefault();let o=Y(t);o.hasClass("active")&&(o.toggleClass("toggled"),o.scrollTop(0),setProperty(n,`modules.${h}.toggled`,o.hasClass("toggled")))}i(uo,"onSpellcastingBtnToggle");function mo(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}i(mo,"getSpellcastingNav");function Y(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}i(Y,"getSpellcastingTab");function po(e){return Y(e).find(".directory-list.spellcastingEntry-list")}i(po,"getSpellcastingOriginalSection");function go(e){return Y(e).find(".directory-list.summary")}i(go,"getSpellcastingSummarySection");async function ho(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,o=[],s=[],a=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,d=l.statistic.dc.value,y=l.name,g=await l.getSheetData(),w=g.isFocusPool,f=l.system?.prepared?.value==="charge",m=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,C={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let k of g.levels){if(!k.active.length||k.uses?.max===0)continue;let A=[],O=k.isCantrip,P=k.active.filter(_=>_&&_.uses?.max!==0),Ee=!O&&f&&!n;for(let _=0;_<P.length;_++){let{spell:L,expended:jt,virtual:zt,uses:Bt,castLevel:qt}=P[_];A.push({name:L.name,img:L.img,range:L.system.range.value||"-",castLevel:qt??L.level,slotId:_,entryId:u,entryDc:d,entryName:y,itemId:L.id,inputId:g.isInnate?L.id:g.id,inputPath:f?"flags.pf2e-staves.charges":g.isInnate?"system.location.uses.value":`system.slots.slot${k.level}.value`,isCharge:f,isActiveCharge:f&&n,isBroken:Ee,isVirtual:zt,isInnate:g.isInnate,isCantrip:O,isFocus:w,isPrepared:g.isPrepared,isSpontaneous:g.isSpontaneous||g.isFlexible,slotLevel:k.level,uses:Bt??(f?C:k.uses),expended:jt??(w&&!O?t.value<=0:!1),action:L.system.time.value,type:f?m?`${h}.summary.staff`:`${h}.summary.charges`:g.isInnate?"PF2E.PreparationTypeInnate":g.isSpontaneous?"PF2E.PreparationTypeSpontaneous":g.isFlexible?"PF2E.SpellFlexibleLabel":w?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:f?0:g.isPrepared?1:w?2:g.isInnate?3:g.isSpontaneous?4:5,noHover:g.isPrepared||O||Ee||w})}if(A.length){if(w)if(O)a=!0;else{s.push(...A);continue}o[k.level]??=[],o[k.level].push(...A)}}})),o.length){let l=p("summary")==="sort"?(u,d)=>u.order===d.order?oe(u.name,d.name):u.order-d.order:(u,d)=>oe(u.name,d.name);o.forEach(u=>u.sort(l))}s.length&&(s.sort((l,u)=>oe(l.name,u.name)),o[12]=s,a=!1);let c=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:d})=>({name:d.name,img:d.img,slotId:u,itemId:d.id,level:d.level,time:d.system.time.value})).filter(Boolean));return{spells:o,rituals:c,focusPool:t,stavesActive:n,hasFocusCantrips:a,isOwner:e.isOwner}}i(ho,"getData");var K=null,U=null;function yt(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:ht}],conflicts:["pf2e-unided"],init:()=>{ht()}}}i(yt,"registerUnided");function ht(e){e??=p("unided"),e==="disabled"?(K&&(Hooks.off("preCreateItem",K),K=null),U&&(Hooks.off("preUpdateItem",U),U=null)):(K||(K=Hooks.on("preCreateItem",yo)),e==="all"&&!U?U=Hooks.on("preUpdateItem",bo):e!=="all"&&U&&(Hooks.off("preUpdateItem",U),U=null))}i(ht,"setHooks");function yo(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}i(yo,"preCreateItem");function bo(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}i(bo,"preUpdateItem");var j=S("hero.templates.trade"),Q=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:j("title"),template:I("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){j.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:T(this.actor),targetActions:this.target?T(this.target):[],i18n:j})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){j.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){j.warn("no-select");return}let o=$e(this.target,!0)??_e(this.target,!0)??game.users.activeGM;if(!o){j.warn("no-user");return}bt({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:o.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};i(Q,"Trade");var se="pf2e-hero-actions",vt=null,Ct=E("renderCharacterSheetPF2e",wo,ko),vo="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",ae="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",Co="systems/pf2e/icons/features/feats/heroic-recovery.webp";function wt(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>Ct(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>F()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[se],api:{createTable:$o,removeHeroActions:No,getHeroActions:T,useHeroAction:At,getHeroActionDetails:re,drawHeroAction:Et,drawHeroActions:It,sendActionToChat:Mt,discardHeroActions:Tt,tradeHeroAction:Dt,getDeckTable:ke,giveHeroActions:zo,createChatMessage:ce},ready:()=>{Ct(!1,"hero")}}}i(wt,"registerHeroActions");function ko(e){e&&!vt?Z(kt):!e&&vt&&ee(kt)}i(ko,"setupSocket");function kt(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;_t(e);break;case"trade-accept":if(!te())return;Ut(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;Ro(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;$t(e.error);break}}i(kt,"onSocket");async function wo(e,t){let n=e.actor;!n||n.pack||!n.id||!game.actors.has(n.id)||(await So(t,n),Io(t,n))}i(wo,"renderCharacterSheetPF2e");async function So(e,t){let n=T(t),o=t.heroPoints.value-n.length,s=t.isOwner,a=S("hero.templates.heroActions"),r=await renderTemplate(I("hero/sheet"),{owner:s,list:n,canUse:o>=0&&s,canDraw:o>0&&s,canTrade:p("hero-trade"),mustDiscard:o<0,diff:Math.abs(o),i18n:(c,{hash:l})=>a(c,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(r)}i(So,"addActionsToSheet");function Io(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",o=>Po(t,o)),n.find("[data-action=expand]").on("click",St),n.find("[data-action=use]").on("click",o=>To(t,o)),n.find("[data-action=display]").on("click",o=>Ao(t,o)),n.find("[data-action=discard]").on("click",Eo),n.find("[data-action=discard-selected]").on("click",()=>Do(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>Dt(t))}i(Io,"addSheetEvents");async function Do(e,t){let o=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(s=>s.dataset.uuid);Tt(e,o)}i(Do,"onClickHeroActionsDiscard");function Eo(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let o=Number(n.attr("data-discard")??"0"),s=n.find(".action.discarded");n.toggleClass("discardable",s.length===o)}i(Eo,"onClickHeroActionDiscard");async function Ao(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Mt(e,n)}i(Ao,"onClickHeroActionDisplay");async function To(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");At(e,n)}i(To,"onClickHeroActionUse");async function Po(e,t){t.preventDefault(),It(e)}i(Po,"onClickHeroActionsDraw");function T(e){return getProperty(e,`flags.${se}.heroActions`)??[]}i(T,"getHeroActions");async function N(e,t){return e.update({[`flags.${se}.heroActions`]:t})}i(N,"setHeroActions");async function St(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let o=t.attr("data-uuid"),s=await re(o);if(!s)return;let a=await TextEditor.enrichHTML(s.description,{async:!0});n.find(".item-description").html(a),n.addClass("loaded")}t.toggleClass("expanded")}i(St,"onClickHeroActionExpand");async function re(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,o=t instanceof JournalEntry?t.pages.contents[0]:t,s=o?.text.content;if(s)return n.uuid===vo&&(s=s.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:o.name,description:s}}i(re,"getHeroActionDetails");async function It(e){if(!e?.isOfType("character")){v("hero.onlyCharacter");return}let t=T(e),n=e.heroPoints.value-t.length,o=[];for(let s=0;s<n;s++){let a=await Et();if(a!==void 0){if(a===null)return;t.push(a),o.push(a)}}o.length&&(N(e,t),ce({actor:e,actions:o,label:s=>b("hero.actions-draw.header",{nb:s}),secret:!0}))}i(It,"drawHeroActions");function ce({actor:e,actions:t,label:n,secret:o=!1}){let{content:s,size:a}=Oo(t);n=typeof n=="function"?n(a):n;let r={flavor:`<h4 class="action">${n}</h4>`,content:s,speaker:ChatMessage.getSpeaker({actor:e})};o&&p("hero-private")&&(r.type=CONST.CHAT_MESSAGE_TYPES.ROLL,r.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(r)}i(ce,"createChatMessage");function Oo(e){let t=e.map(({uuid:n,name:o})=>R(n,o));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}i(Oo,"chatActions");function Dt(e){if(!e?.isOfType("character")){v("hero.onlyCharacter");return}let t=T(e);if(!t||!t.length){v("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){v("hero.no-points",{nb:n.toString()});return}new Q(e).render(!0)}i(Dt,"tradeHeroAction");async function Et(){let e=await ke(),t=S("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(a=>!a.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let o=Lt(n);if(o)return{uuid:o,name:await Pt(n,o)}}i(Et,"drawHeroAction");async function At(e,t){if(!e?.isOfType("character")){v("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return v("hero.use.noPoints");let o=T(e),s=o.findIndex(r=>r.uuid===t);if(s===-1)return;let a=await re(t);a||H("hero.use.noDetails"),o.splice(s,1),a?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${se}.heroActions`]:o}),ChatMessage.create({flavor:`<h4 class="action">${b("hero.actions-use.header")}</h4>`,content:`<h2>${a.name}</h2>${a.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):N(e,o)}i(At,"useHeroAction");async function Tt(e,t){if(!e?.isOfType("character")){v("hero.onlyCharacter");return}t=typeof t=="string"?[t]:t;let n=T(e),o=[];for(let s of t){let a=n.findIndex(r=>r.uuid===s);a!==-1&&(o.push(n[a]),n.splice(a,1))}N(e,n),ce({actor:e,actions:o,label:s=>b("hero.actions-discard.header",{nb:s})})}i(Tt,"discardHeroActions");async function Pt(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}i(Pt,"getLabelfromTableResult");async function Ot(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}i(Ot,"getTableFromUuid");async function xo(){return Ot(ae)}i(xo,"getDefaultCompendiumTable");function xt(){return game.tables.find(e=>e.getFlag("core","sourceId")===ae)}i(xt,"getDefaultWorldTable");async function Mo(){return Ot(p("hero-table"))}i(Mo,"getCustomTable");async function ke(){return await Mo()??xt()??await xo()}i(ke,"getDeckTable");async function Mt(e,t){let n=await re(t);if(!n)return H("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}i(Mt,"sendActionToChat");function bt(e){if(e.receiver.id===game.user.id){Rt(e);return}x({...e,type:"trade-request"})}i(bt,"sendTradeRequest");function Rt(e){if(game.user.isGM){Ut(e);return}x({...e,type:"trade-accept"})}i(Rt,"acceptRequest");async function Ut(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){ve(e);return}let a=T(o),r=T(s),c=a.findIndex(m=>m.uuid===t.uuid),l=r.findIndex(m=>m.uuid===n.uuid);if(c===-1||l===-1){ve(e);return}let u=a.splice(c,1)[0],d=r.splice(l,1)[0];a.push(d),r.push(u),N(o,a),N(s,r);let y=R(u.uuid),g=R(d.uuid),w=S("hero.trade-success"),f=`<div style="line-height: 1.6">${w("offer",{offer:y})}</div>`;f+=`<div style="line-height: 1.6">${w("receive",{receive:g})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${w("header",{name:s.name})}</h4>`,content:f,speaker:ChatMessage.getSpeaker({actor:o})})}i(Ut,"onTradeAccepted");function ve({sender:e,receiver:t},n="trade-error"){let o=new Set([e.id,t.id]);o.has(game.user.id)&&(o.delete(game.user.id),$t(n)),o.size&&x({type:"trade-error",users:Array.from(o),error:n})}i(ve,"sendTradeError");function $t(e){H("hero.trade-error")}i($t,"onTradeError");async function Ro(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){ve(e);return}let a=S("hero.trade-request"),r=`<p>${a("header",{sender:o.name,receiver:s.name})}</p>`;r+=`<p>${a("give",{give:R(t.uuid)})}</p>`,r+=`<p>${a("want",{want:R(n.uuid)})}</p>`,r+=`<p style="margin-bottom: 1em;">${a("accept")}</p>`,await Dialog.confirm({title:a("title"),content:await TextEditor.enrichHTML(r,{async:!0})})?Rt(e):Uo(e)}i(Ro,"onTradeRequest");function Uo(e){if(e.sender.id===game.user.id){_t(e);return}x({...e,type:"trade-reject"})}i(Uo,"rejectRequest");async function _t({receiver:e}){let t=game.actors.get(e.cid);v("hero.trade-rejected",{name:t.name},!0)}i(_t,"onTradeRejected");async function $o(){if(!game.user.isGM){v("hero.notGM");return}let e=S("hero.templates.createTable.choice"),t=I("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:a=>{let r=a.find('.window-content input[name="type"]:checked').val(),c=a.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:r,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-create-table"});s&&(s.type==="default"?Ho(s.unique):_o(s.unique))}i($o,"createTable");async function _o(e){let t=await Lo(e);await Ce(t),t.sheet?.render(!0)}i(_o,"createCustomTable");function Lo(e=!0){let t=we(e);return RollTable.create(t,{temporary:!1})}i(Lo,"createCustomActionsTable");async function Ho(e){let t=S("templates.createTable.default.confirm"),n=await xt();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let s=we(e);return await n.update(s),Ce(n,!0)}n=await Fo(e),await Ce(n)}i(Ho,"createDefaultTable");async function Fo(e=!0){let t=await fromUuid(ae),n=we(e,t);return RollTable.create(n,{temporary:!1})}i(Fo,"createDefautActionsTable");async function Ce(e,t=!1){t&&await e.normalize(),await Ae("hero-table",e.uuid)}i(Ce,"setTable");function we(e=!0,t){let n={name:b("hero.table.name"),replacement:!e,img:Co,description:b("hero.table.description"),flags:{core:{sourceId:ae}}};return t?mergeObject(deepClone(t._source),n):n}i(we,"getTableSource");async function No(){if(!game.user.isGM){v("hero.notGM");return}let e=S("hero.templates.removeActions"),t=I("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:a=>a.find('input[name="actor"]:checked').toArray().map(r=>game.actors.get(r.value)).filter(r=>r)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},o={content:await renderTemplate(t,{actors:game.actors.filter(a=>a.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:a=>{a.on("change",'input[name="all"]',()=>Go(a)),a.on("change",'input[name="actor"]',()=>jo(a))},close:()=>[]},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!s.length){e.warn("noSelection");return}for(let a of s)N(a,[]);e.info("removed")}i(No,"removeHeroActions");function Go(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}i(Go,"removeActionsToggleAll");function jo(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),o=e.find('input[name="all"]');t.length===n.length?(o.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?o.prop("checked",!1).prop("indeterminate",!0):(o.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}i(jo,"removeActionsToggleActor");function Lt(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}i(Lt,"documentUuidFromTableResult");async function zo(e){if(!game.user.isGM){v("hero.notGM");return}let t=S("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await ke();if(!n)return H("hero.table.drawError",!0),null;let o=n.replacement===!1,s=(await Promise.all(n.results.map(async m=>{let C=Lt(m);if(C)return{key:m.id,uuid:C,name:await Pt(m,C),drawn:m.drawn}}))).filter(Boolean),a=I("hero/dialogs/give-action"),r=await renderTemplate(a,{actions:s,isUnique:o,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:m=>({selected:m.find("[name=action]:checked").closest(".action").toArray().map(C=>C.dataset),asDrawn:m.find("[name=drawn]").prop("checked")??!1,withMessage:m.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:r,buttons:c,render:m=>{m.find("[data-action=expand]").on("click",St)},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!u)return;let{selected:d,asDrawn:y,withMessage:g}=u,w=T(e),f=[];for(let{uuid:m,name:C,key:k}of d){if(w.push({uuid:m,name:C}),!y)continue;let A=n.results.get(k);A&&!A.drawn&&f.push(k)}f.length&&await n.updateEmbeddedDocuments("TableResult",f.map(m=>({_id:m,drawn:!0}))),N(e,w),g&&ce({actor:e,actions:d,label:m=>b("hero.actions-give.header",{nb:m}),secret:!0})}i(zo,"giveHeroActions");var Ht=X("renderChatMessage",Nt,Bo);function Ft(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>Ht(e)}],init:e=>{!e&&p("modifiers")!=="disabled"&&Ht(!0,!0)}}}i(Ft,"registerHideModifiers");function Bo(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of B(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),Nt(t,n))}}i(Bo,"updateMessages");function Nt(e,t){let n=e.speaker,o=ChatMessage.getSpeakerActor(n);if(!o||o.hasPlayerOwner)return;let s=t.find(".message-header");p("modifiers")==="traits"&&s.addClass("pf2e-toolbelt-modifiers-traits"),p("modifiers")!=="disabled"&&s.addClass("pf2e-toolbelt-modifiers")}i(Nt,"renderChatMessage");var Ie=[Te(),tt(),Ne(),Be(),yt(),Qe(),Me(),gt(),rt(),wt(),Ft()],Gt=new Set,De=null;Hooks.once("init",()=>{let e=game.data.users.find(r=>r._id===game.data.userId),t=e&&e.role>=CONST.USER_ROLES.GAMEMASTER,n=Ie.flatMap(({settings:r=[]})=>r.map(c=>{let l=c.name;return c.choices&&(c.choices=c.choices.reduce((u,d)=>(u[d]=Se(l,`choices.${d}`),u),{})),c.key=l,c.scope??="world",c.config??=!0,c.name=Se(l,"name"),c.hint=Se(l,"hint"),c})),[o,s]=["world","client"].map(r=>n.filter(c=>c.scope===r));[o,s].forEach(r=>r.forEach(c=>game.settings.register(h,c.key,c))),t&&(De=s[0].key,Hooks.on("renderSettingsConfig",qo));let a=game.modules.get(h);a.api={},Ie.forEach(r=>{let{init:c,conflicts:l=[],api:u,name:d}=r;if(t)for(let y of l){let g=game.modules.get(y);g?.active&&(r.conflicting=!0,Gt.add(g.title))}u&&d&&(a.api[d]=u),!r.conflicting&&c&&c(t)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Ie)!t&&n&&n(e);if(e)for(let t of Gt)v("module-conflict",{name:t},!0)});function Se(e,t){return`${h}.settings.${e}.${t}`}i(Se,"settingPath");function qo(e,t){if(!De)return;t.find(`.tab[data-tab=${h}] [data-setting-id="${h}.${De}"]`).before(`<h3>${b("settings.client")}</h3>`)}i(qo,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
