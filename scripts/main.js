(()=>{var G=Object.defineProperty;var i=(e,n)=>G(e,"name",{value:n,configurable:!0});var u="pf2e-toolbelt";function f(e){return game.settings.get(u,e)}i(f,"getSetting");function R(...e){let[n,t]=e;return n=`${u}.${n}`,t?game.i18n.format(n,t):game.i18n.localize(n)}i(R,"localize");function q(e){return game.i18n.has(`${u}.${e}`,!1)}i(q,"hasLocalization");function z(e){return`${u}.${e}`}i(z,"localizePath");function _(e){let n=i((...t)=>R(`${e}.${t[0]}`,t[1]),"fn");return Object.defineProperties(n,{warn:{value:(...t)=>C(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>O(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>Y(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},has:{value:t=>q(`${e}.${t}`),enumerable:!1,configurable:!1},path:{value:t=>z(`${e}.${t}`),enumerable:!1,configurable:!1},template:{value:(t,{hash:o})=>n(t,o),enumerable:!1,configurable:!1}}),n}i(_,"subLocalize");function A(e,n,t,o){let r=typeof n=="string"?n:"info",l=typeof n=="object"?n:typeof t=="object"?t:void 0,c=typeof n=="boolean"?n:typeof t=="boolean"?t:o??!1;ui.notifications.notify(R(e,l),r,{permanent:c})}i(A,"notify");function C(...e){let[n,t,o]=e;A(n,"warning",t,o)}i(C,"warn");function O(...e){let[n,t,o]=e;A(n,"info",t,o)}i(O,"info");function Y(...e){let[n,t,o]=e;A(n,"error",t,o)}i(Y,"error");function g(e,n){libWrapper.register(u,e,n)}i(g,"registerWrapper");function y(e,n,t){return e.getFlag(u,n)??t}i(y,"getFlag");function I(e,n,t){return e.setFlag(u,n,t)}i(I,"setFlag");function $(...e){return e=e.filter(n=>typeof n=="string"),`modules/${u}/templates/${e.join("/")}`}i($,"templatePath");var K="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",X="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Z="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",J="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",Q=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function T(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{f("arp")&&(g(K,ee,"WRAPPER"),g(X,ie,"WRAPPER"),g(Z,oe,"WRAPPER"),g(J,ce,"WRAPPER"))},ready:e=>{e&&f("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),O("arp.forceVariant"))}}}i(T,"registerArp");function k(e,n=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!n||e.isOfType("character"))}i(k,"isValidActor");function x(e){let n=e._source.system.traits.value;return!n.includes("alchemical")&&!n.includes("bomb")&&!Q.includes(e.sourceId)}i(x,"isValidWeapon");function ee(e){let n=this.actor;if(!k(n,!0)||!x(this))return e();let t=n.level,o=this._source.system.traits.value;if(o.includes("alchemical")&&o.includes("bomb"))return e();this.system.potencyRune.value=t<2?null:t<10?1:t<16?2:3,this.system.strikingRune.value=t<4?null:t<12?"striking":t<19?"greaterStriking":"majorStriking",e()}i(ee,"onPrepareWeaponData");var te={1:35,2:935,3:8935,4:8935},ne={striking:65,greaterStriking:1065,majorStriking:31065};function ie(e){if(e(),!k(this.actor)||this.isSpecific||!x(this))return;let n=this.price.value.goldValue,t=this.system.potencyRune.value;t&&(n-=te[t]);let o=this.system.strikingRune.value;o&&(n-=ne[o]),(t||o)&&!this.system.runes.property.length&&(n+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:n})}i(ie,"onPrepareWeaponDerivedData");function w(e){return!e.isShield}i(w,"isValidArmor");function oe(e){let n=this.actor;if(!k(n,!0)||!w(this))return e();let t=n.level;this.system.potencyRune.value=t<5?null:t<11?1:t<18?2:3,this.system.resiliencyRune.value=t<8?null:t<14?"resilient":t<20?"greaterResilient":"majorResilient",e()}i(oe,"onPrepareArmorData");var re={1:160,2:1060,3:20560,4:20560},se={resilient:340,greaterResilient:3440,majorResilient:49440};function ce(e){if(e(),!k(this.actor)||this.isSpecific||!w(this))return;let n=this.price.value.goldValue,t=this.system.potencyRune.value;t&&(n-=re[t]);let o=this.system.resiliencyRune.value;o&&(n-=se[o]),(t||o)&&!this.system.runes.property.length&&(n+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:n})}i(ce,"onPrepareArmorDerivedData");function N(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:F},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:F}],conflicts:["pf2e-effect-description"],init:()=>{Hooks.on("renderEffectsPanel",ae)}}}i(N,"registerEffectsPanelHelper");function F(){game.pf2e.effectPanel?.render()}i(F,"refreshEffectsPanel");function ae(e,n){let t=f("effect-remove"),o=f("condition-sheet");if(!t&&!o)return;let r=`<div>${R("effects.remove")}</div>`,l='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',c=n.find(".effect-item[data-item-id]").toArray();for(let s of c){let d=s.dataset.itemId,a=e.actor?.items.get(d);if(a&&(t&&!a.isLocked&&a.badge&&a.badge.type==="counter"&&(s.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",r),s.querySelector(".icon").addEventListener("contextmenu",p=>le(p,e),!0)),o&&a.isOfType("condition"))){let p=s.querySelector(".effect-info > h1");p.insertAdjacentHTML("beforeend",l),p.querySelector('[data-action="edit"]').addEventListener("click",b=>fe(b,e))}}}i(ae,"renderEffectsPanel");function fe(e,n){let t=L(e,n);t?.isOfType("condition")&&(e.preventDefault(),t.sheet.render(!0))}i(fe,"onConditionSheet");function le(e,n){if(!e.shiftKey)return;let t=L(e,n);!t||t.isLocked||!t.badge||t.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),t.delete())}i(le,"onRemoveEffect");function L(e,n){let r=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return n.actor?.items.get(r)}i(L,"getEffect");var h=class extends FormApplication{constructor(n,t={}){let o=`npc-edit-lores-${n.id}`;super(n,{...t,id:o})}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:"Edit Lores",template:$("knowledges/lores.hbs"),width:400})}getData(n){let t=this.object;return mergeObject(super.getData(n),{unspecified:y(t,"unspecified")??"",specific:y(t,"specific")??"",i18n:_("knowledges.editLore")})}async _updateObject(n,{unspecified:t,specific:o}){let r=this.object;I(r,"unspecified",t.trim()),I(r,"specific",o.trim())}activateListeners(n){n.find("button.cancel").on("click",this.#e.bind(this))}#e(n){n.preventDefault(),this.close()}};i(h,"EditLores");var P=null;function j(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:H}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&f("knowledges")&&H(!0)}}}i(j,"registerKnowledges");function H(e){e&&!P?P=Hooks.on("renderNPCSheetPF2e",ue):!e&&P&&(Hooks.off("renderNPCSheetPF2e",P),P=null)}i(H,"setHooks");function ue(e,n){let t=e.actor;pe(t,n),ge(n),me(t,n)}i(ue,"renderNPCSheetPF2e");function D(e,n,t){return e.find(`[data-tab="main"] .recall-knowledge ${n==="header"?".section-header":".section-body"} ${t}`)}i(D,"knowledgeSelector");function de(e){new h(e).render(!0)}i(de,"editLores");function pe(e,n){let t=y(e,"unspecified"),o=y(e,"specific");if(!t&&!o)return;let r=e.identificationDCs.lore,l=D(n,"body","");l.find(".identification-skills").last().remove();function c(d,a,p){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:d,dc:a,adjustment:p})}</div>`}i(c,"tag");function s(d,{dc:a,start:p}){let b=d.split(",").filter(v=>v.trim()).map(v=>c(v,a,p)).join("");l.append(b)}i(s,"addTags"),s(t||"Unspecific",r[0]),s(o||"Specific",r[1])}i(pe,"replaceLores");function me(e,n){D(n,"header","button.edit").on("click",()=>de(e))}i(me,"addEvents");function ge(e){let n=D(e,"header","button"),t='<button type="button" class="breakdown edit">Edit</button>';n.before(t)}i(ge,"addEditButton");var ye="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments";function M(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0}],init:()=>{f("nobulk")&&g(ye,he,"WRAPPER")}}}i(M,"registerNobulk");function he(e,...n){e(...n);let t=this,o=t.inventory.bulk.constructor;Object.defineProperty(t.inventory,"bulk",{get(){let r=new o(t);return r.value=o.computeTotalBulk(t.inventory.filter(l=>!l.isInContainer&&l.system.equipped.carryType!=="dropped"),t.size),r}})}i(he,"actorPrepareEmbeddedDocuments");var E=null,m=null;function W(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:B}],conflicts:["pf2e-unided"],init:()=>{B()}}}i(W,"registerUnided");function B(e){e??=f("unided"),e==="disabled"?(E&&(Hooks.off("preCreateItem",E),E=null),m&&(Hooks.off("preUpdateItem",m),m=null)):(E||(E=Hooks.on("preCreateItem",Pe)),e==="all"&&!m?m=Hooks.on("preUpdateItem",Ee):e!=="all"&&m&&(Hooks.off("preUpdateItem",m),m=null))}i(B,"setHooks");function Pe(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}i(Pe,"preCreateItem");function Ee(e,n){!e.isOfType("physical")||!("img"in n)||setProperty(n,"system.identification.unidentified.img",n.img)}i(Ee,"preUpdateItem");var U=[T(),M(),j(),W(),N()],V=new Set;Hooks.once("init",()=>{let e=game.data.users.find(t=>t._id===game.data.userId),n=e&&e.role>=CONST.USER_ROLES.GAMEMASTER;for(let t of U){let{settings:o=[],init:r,conflicts:l=[]}=t;for(let c of o){let s=c.name;c.choices&&(c.choices=c.choices.reduce((d,a)=>(d[a]=S(s,`choices.${a}`),d),{})),game.settings.register(u,s,{scope:"world",config:!0,...c,name:S(s,"name"),hint:S(s,"hint")})}if(n)for(let c of l){let s=game.modules.get(c);s?.active&&(t.conflicting=!0,V.add(s.title))}!t.conflicting&&r&&r(n)}});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:n,ready:t}of U)!n&&t&&t(e);if(e)for(let n of V)C("module-conflict",{name:n},!0)});function S(e,n){return`${u}.settings.${e}.${n}`}i(S,"settingPath");})();
//# sourceMappingURL=main.js.map
