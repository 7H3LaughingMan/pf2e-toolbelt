(()=>{var Re=Object.defineProperty;var o=(e,t)=>Re(e,"name",{value:t,configurable:!0});var h="pf2e-toolbelt";function m(e){return game.settings.get(h,e)}o(m,"getSetting");function I(...e){let[t,n]=e;return t=`${h}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}o(I,"localize");function Oe(e){return game.i18n.has(`${h}.${e}`,!1)}o(Oe,"hasLocalization");function Ae(e){return`${h}.${e}`}o(Ae,"localizePath");function N(e){let t=o((...n)=>I(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>_(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>G(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>Te(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>Oe(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>Ae(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:s})=>t(n,s),enumerable:!1,configurable:!1}}),t}o(N,"subLocalize");function U(e,t,n,s){let i=typeof t=="string"?t:"info",a=typeof t=="object"?t:typeof n=="object"?n:void 0,c=typeof t=="boolean"?t:typeof n=="boolean"?n:s??!1;ui.notifications.notify(I(e,a),i,{permanent:c})}o(U,"notify");function _(...e){let[t,n,s]=e;U(t,"warning",n,s)}o(_,"warn");function G(...e){let[t,n,s]=e;U(t,"info",n,s)}o(G,"info");function Te(...e){let[t,n,s]=e;U(t,"error",n,s)}o(Te,"error");function T(e,t){libWrapper.register(h,e,t)}o(T,"registerWrapper");function v(e,t,n){return e.getFlag(h,t)??n}o(v,"getFlag");function V(e,t,n){return e.setFlag(h,t,n)}o(V,"setFlag");function k(...e){return e=e.filter(t=>typeof t=="string"),`modules/${h}/templates/${e.join("/")}.hbs`}o(k,"templatePath");function B(e,t){return e.localeCompare(t,game.i18n.lang)}o(B,"localeCompare");var xe="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Fe="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",$e="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",_e="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",we=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function Q(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{m("arp")&&(T(xe,Le,"WRAPPER"),T(Fe,Ne,"WRAPPER"),T($e,Be,"WRAPPER"),T(_e,Ge,"WRAPPER"))},ready:e=>{e&&m("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),G("arp.forceVariant"))}}}o(Q,"registerArp");function j(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}o(j,"isValidActor");function ee(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!we.includes(e.sourceId)}o(ee,"isValidWeapon");function Le(e){let t=this.actor;if(!j(t,!0)||!ee(this))return e();let n=t.level,s=this._source.system.traits.value;if(s.includes("alchemical")&&s.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}o(Le,"onPrepareWeaponData");var Me={1:35,2:935,3:8935,4:8935},He={striking:65,greaterStriking:1065,majorStriking:31065};function Ne(e){if(e(),!j(this.actor)||this.isSpecific||!ee(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Me[n]);let s=this.system.strikingRune.value;s&&(t-=He[s]),(n||s)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}o(Ne,"onPrepareWeaponDerivedData");function te(e){return!e.isShield}o(te,"isValidArmor");function Be(e){let t=this.actor;if(!j(t,!0)||!te(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}o(Be,"onPrepareArmorData");var je={1:160,2:1060,3:20560,4:20560},Ue={resilient:340,greaterResilient:3440,majorResilient:49440};function Ge(e){if(e(),!j(this.actor)||this.isSpecific||!te(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=je[n]);let s=this.system.resiliencyRune.value;s&&(t-=Ue[s]),(n||s)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}o(Ge,"onPrepareArmorDerivedData");function x(e,t,n=()=>{}){let s=null;return function(i,a=[]){typeof a=="string"&&(a=[a]),i||=a.some(c=>m(c)),i&&!s?s=Hooks.on(e,t):!i&&s&&(Hooks.off(e,s),s=null),n(i)}}o(x,"createHook");function ne(e,t,n=()=>{}){let s=null;return function(i){i==="disabled"&&s?(Hooks.off(e,s),s=null):i!=="disabled"&&!s&&(s=Hooks.on(e,t)),n(i)}}o(ne,"createChoicesHook");var W=x("renderEffectsPanel",We,Ve);function se(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>W(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>W(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{W(!1,["effect-remove","condition-sheet"])}}}o(se,"registerEffectsPanelHelper");function Ve(){game.pf2e.effectPanel?.render()}o(Ve,"refreshEffectsPanel");function We(e,t){let n=`<div>${I("effects.remove")}</div>`,s='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',i=t.find(".effect-item[data-item-id]").toArray();for(let a of i){let c=a.dataset.itemId,r=e.actor?.items.get(c);if(r&&(m("effect-remove")&&!r.isLocked&&r.badge&&r.badge.type==="counter"&&(a.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),a.querySelector(".icon").addEventListener("contextmenu",l=>qe(l,e),!0)),m("condition-sheet")&&r.isOfType("condition"))){let l=a.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",s),l.querySelector('[data-action="edit"]').addEventListener("click",f=>ze(f,e))}}}o(We,"renderEffectsPanel");function ze(e,t){let n=oe(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}o(ze,"onConditionSheet");function qe(e,t){if(!e.shiftKey)return;let n=oe(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}o(qe,"onRemoveEffect");function oe(e,t){let i=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(i)}o(oe,"getEffect");var ie=N("knowledges.editLore"),w=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return ie("title",this.actor)}get template(){return k("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:v(n,"unspecified")??"",specific:v(n,"specific")??"",i18n:ie})}async _updateObject(t,{unspecified:n,specific:s}){let i=this.object;V(i,"unspecified",n.trim()),V(i,"specific",s.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};o(w,"EditLores");var ae=x("renderNPCSheetPF2e",Ye);function re(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:ae}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&m("knowledges")&&ae(!0)}}}o(re,"registerKnowledges");function Ye(e,t){let n=e.actor;Je(n,t),Ze(t),Xe(n,t)}o(Ye,"renderNPCSheetPF2e");function z(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}o(z,"knowledgeSelector");function Ke(e){new w(e).render(!0)}o(Ke,"editLores");function Je(e,t){let n=v(e,"unspecified"),s=v(e,"specific");if(!n&&!s)return;let i=e.identificationDCs.lore,a=z(t,"body","");a.find(".identification-skills").last().remove();function c(l,f,p){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:f,adjustment:p})}</div>`}o(c,"tag");function r(l,{dc:f,start:p}){let g=l.split(",").filter(d=>d.trim()).map(d=>c(d,f,p)).join("");a.append(g)}o(r,"addTags"),r(n||"Unspecific",i[0]),r(s||"Specific",i[1])}o(Je,"replaceLores");function Xe(e,t){z(t,"header","button.edit").on("click",()=>Ke(e))}o(Xe,"addEvents");function Ze(e){let t=z(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}o(Ze,"addEditButton");var q=N("merge.multi"),L=class extends Application{constructor(t,n){super(n),this._spell=t}get spell(){return this._spell}get title(){return q("title",this.spell)}get template(){return k("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:q})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){q.error("zero"),this.close();return}let s=this.spell,i=deepClone(s._source.system.damage.value),a=deepClone(s._source.system.heightening)??{};for(let[r,l]of Object.entries(i))for(let f=0;f<n-1;f++){let p=randomID();if(i[p]=l,a.type==="interval"){let g=a.damage[r];g&&(a.damage[p]=g)}else if(a.type==="fixed")for(let[g,d]of Object.entries(a.levels)){let b=d.damage.value[r];b&&(a.levels[g].damage.value[p]=b)}}s.clone({"system.damage.value":i,"system.heightening":a}).rollDamage(t),this.close()}#t(t){t.preventDefault(),this.close()}};o(L,"MultiCast");var Qe=/<div class="tags"><span class="tag".+?<\/div>/gm,et=/<span class="tag tag_transparent">(.+?)<\/span>/gm,tt=/(\[[\w,]+\])/,Y=x("renderChatMessage",de,nt);function fe(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>Y(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>Y(e,"merge-damage")}],init:e=>{Y(!1,["multi-cast","merge-damage"])}}}o(fe,"registerMerge");function nt(){let e=ui.chat?.element;if(e)for(let t of me(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),de(t,n))}}o(nt,"updateMessages");function de(e,t){!game.user.isGM&&!e.isAuthor||(m("merge-damage")&&ge(e)?ot(e,t):m("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&st(e,t))}o(de,"renderChatMessage");function st(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let s=t.find(".message-content .chat-card .owner-buttons .spell-button");s.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${I("merge.spell.button")}</button>`),s.find("[data-action=multi-cast]").on("click",async i=>{let a=await fromUuid(n);a&&new L(a).render(!0)})}o(st,"renderSpell");function ot(e,t){let n=K(e);if(!n)return;let i=`<span style="position: absolute; right: 0px; bottom: 1px;">
    <button data-action="merge-damage" title="${I("merge.damage.tooltip")}" style="width: 22px; height: 22px; font-size: 10px; line-height: 1px;">
        <i class="fa-duotone fa-merge"></i>
    </button>
</span>`,a=J(e);t.find(".dice-result .dice-total").append(i),t.find("[data-action=merge-damage]").on("click",c=>{c.stopPropagation();for(let r of me(5,e))if(!(K(r)!==n||J(r)!==a||!ge(r))){it(c,e,r);return}_("merge.damage.none")})}o(ot,"renderDamage");async function it(e,t,n){let s=at(t,n),i=rt(t,n),a=le(n),c=ue(n),r=J(t),l=K(t);for(let u of le(t))a.includes(u)||a.push(u);for(let u of ue(t))c.includes(u)||c.push(u);let f=ce(t),p=ce(n),g=[];function d(u){return g.find(({options:{flavor:P,critRule:y}})=>P===u.flavor&&y===u.critRule)}o(d,"findGroup");for(let u of[].concat(p,f)){let{options:P,total:y,terms:S}=u,C=S[0],F=u.formula.replace(tt,""),R=d(P);R?(R.terms.push(C),R.total+=y,R.formulas.push(F)):g.push({options:P,formulas:[F],total:y,terms:[C]})}for(let u of g)u.formula=`(${u.formulas.join(" + ")})[${u.options.flavor}]`,u.term=u.terms.length<2?u.terms[0]:pe(u.terms);let b={class:"DamageRoll",options:{},dice:[],formula:`{${g.map(({formula:u})=>u).join(", ")}}`,total:g.reduce((u,{total:P})=>u+P,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:g.map(({formula:u})=>u),modifiers:[],rolls:g.map(({options:u,formula:P,total:y,term:S})=>({class:"DamageInstance",options:u,dice:[],formula:P,total:y,terms:[S],evaluated:!0})),results:g.map(({total:u})=>({result:u,active:!0}))}]};ui.chat.element.find(`[data-message-id=${t.id}], [data-message-id=${n.id}]`).remove(),await ChatMessage.deleteDocuments([t.id,n.id]);let E=await renderTemplate(k("merge/merged"),{header:I("merge.merged.header",{name:s}),tags:i,notes:a,modifiers:c});await CONFIG.ChatMessage.documentClass.create({flavor:E,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[h]:{name:s,tags:i,notes:a,modifiers:c,uuid:l,type:"damage-roll",target:r,merged:!0}},rolls:[b]})}o(it,"mergeDamages");function pe(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?pe(e):e[0]]}}}o(pe,"createTermGroup");function*me(e,t){let n=game.messages.contents,s=(t?n.findLastIndex(i=>i===t):n.length)-1;for(let i=s;i>=s-e;i--){let a=n[i];if(!a)return;yield a}}o(me,"chatMessages");function ce(e){return v(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}o(ce,"getMessageRolls");function K(e){return X(e,"origin.uuid","uuid")}o(K,"getMessageUuid");function ge(e){return X(e,"context.type","type")==="damage-roll"}o(ge,"isDamageRoll");function J(e){return X(e,"context.target.token","target")}o(J,"getMessageTarget");function at(e,t){return v(e,"name")??v(t,"name")??e.getFlag("pf2e","strike.name")??e.item.name}o(at,"getItemName");function rt(e,t){return v(e,"tags")??v(t,"tags")??e.flavor.match(Qe)?.[0]??""}o(rt,"getTags");function le(e){return v(e,"notes")??e.getFlag("pf2e","context.notes").map(({title:t,text:n})=>`<strong>${game.i18n.localize(t)}</strong> ${game.i18n.localize(n)}`)}o(le,"getMessageNotes");function ue(e){let t=v(e,"modifiers");if(t)return t;t=[];let n;for(;n=et.exec(e.flavor);)t.push(n[1]);return t}o(ue,"getMessageModifiers");function X(e,t,n){return e.getFlag("pf2e",t)??v(e,n)}o(X,"getMessageFlag");var ct="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments";function he(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0}],init:()=>{m("nobulk")&&T(ct,lt,"WRAPPER")}}}o(he,"registerNobulk");function lt(e,...t){e(...t);let n=this,s=n.inventory.bulk.constructor;Object.defineProperty(n.inventory,"bulk",{get(){let i=new s(n);return i.value=s.computeTotalBulk(n.inventory.filter(a=>!a.isInContainer&&a.system.equipped.carryType!=="dropped"),n.size),i}})}o(lt,"actorPrepareEmbeddedDocuments");var ye=ne("renderCharacterSheetPF2e",ft,ut);function ve(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:ye}],conflicts:["pf2e-spells-summary"],init:e=>{m("summary")&&ye(!0)}}}o(ve,"registerSpellsSummary");function ut(){Object.values(ui.windows).forEach(e=>e instanceof ActorSheet&&e.actor.type==="character"&&e.render())}o(ut,"refreshSheets");async function ft(e,t){let n=e.actor;if(!n||n.pack||!n.id||!n.isOfType("character"))return;let s=M(t);getProperty(e,`modules.${h}.toggled`)&&s.addClass("toggled"),kt(t).on("click",i=>It(i,t,e)),await dt(t,e,n),s.hasClass("toggled")&&s.hasClass("active")&&e._restoreScrollPositions(t)}o(ft,"renderCharacterSheetPF2e");async function dt(e,t,n){let s=M(e),i=await Ot(n),a=await renderTemplate(k("summary/sheet"),i);s.append(a),pt(e,t,n)}o(dt,"addSummaryTab");function pt(e,t,n){let s=Rt(e),i=s.find(".spell-type .uses .spell-slots-input input");i.on("change",a=>mt(a,n)),i.on("focus",gt),i.on("blur",ht),s.find(".cast-spell").on("click",a=>Et(a,n)),s.find(".item-toggle-prepare").on("click",a=>yt(a,n)),s.find(".focus-pips").on("click contextmenu",a=>vt(a,n)),s.find(".spell-slots-increment-reset").on("click",a=>Pt(a,t,n)),s.find(".item-image").on("click",a=>Ct(a,n)),s.find(".item-name > h4").on("click",a=>St(a,t))}o(pt,"addSummaryEvents");async function mt(e,t){e.preventDefault();let{inputPath:n,entryId:s}=$(e.currentTarget).data(),i=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:s,[n]:i}])}o(mt,"onUsesInputChange");function gt(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}o(gt,"onUsesInputFocus");function ht(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}o(ht,"onUsesInputBlur");function yt(e,t){e.preventDefault();let{slotLevel:n,slotId:s,entryId:i,expended:a}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(i)?.setSlotExpendedState(n??0,s??0,a!==!0)}o(yt,"onTogglePrepare");function vt(e,t){e.preventDefault();let n=e.type==="click"?1:-1,s=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":s})}o(vt,"onToggleFocusPool");function bt(e,t){Dt(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}o(bt,"onChargeReset");function Pt(e,t,n){e.preventDefault();let{itemId:s,level:i,isCharge:a}=$(e.currentTarget).data();if(!s)return;if(a){bt(t,s);return}let c=n.items.get(s);if(c){if(c.isOfType("spellcastingEntry")){let r=i>=0&&i<=11?`slot${i}`:"slot0",l=c.system.slots?.[r];l&&c.update({[`system.slots.${r}.value`]:l.max})}else if(c.isOfType("spell")){let r=c.system.location.uses?.max;r&&c.update({"system.location.uses.value":r})}}}o(Pt,"onSlotsReset");function Et(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:s,slotLevel:i,slotId:a,entryId:c}=n.closest(".item").data(),r=t.spellcasting.collections.get(c);if(!r)return;let l=r.get(s);l&&r.entry.cast(l,{slot:a,level:i})}o(Et,"onCastSpell");async function St(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}o(St,"onToggleSummary");async function Ct(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),s=t.items.get(n);!s||s.isOfType("physical")&&!s.isIdentified||await s.toMessage(e)}o(Ct,"onItemToChat");function It(e,t,n){e.preventDefault();let s=M(t);s.hasClass("active")&&(s.toggleClass("toggled"),s.scrollTop(0),setProperty(n,`modules.${h}.toggled`,s.hasClass("toggled")))}o(It,"onSpellcastingBtnToggle");function kt(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}o(kt,"getSpellcastingNav");function M(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}o(M,"getSpellcastingTab");function Dt(e){return M(e).find(".directory-list.spellcastingEntry-list")}o(Dt,"getSpellcastingOriginalSection");function Rt(e){return M(e).find(".directory-list.summary")}o(Rt,"getSpellcastingSummarySection");async function Ot(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,s=[],i=[],a=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let f=l.id,p=l.statistic.dc.value,g=l.name,d=await l.getSheetData(),b=d.isFocusPool,E=l.system?.prepared?.value==="charge",u=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,P={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let y of d.levels){if(!y.active.length||y.uses?.max===0)continue;let S=[],C=y.isCantrip,F=y.active.filter(O=>O&&O.uses?.max!==0),R=!C&&E&&!n;for(let O=0;O<F.length;O++){let{spell:A,expended:Ce,virtual:Ie,uses:ke,castLevel:De}=F[O];S.push({name:A.name,img:A.img,range:A.system.range.value||"-",castLevel:De??A.level,slotId:O,entryId:f,entryDc:p,entryName:g,itemId:A.id,inputId:d.isInnate?A.id:d.id,inputPath:E?"flags.pf2e-staves.charges":d.isInnate?"system.location.uses.value":`system.slots.slot${y.level}.value`,isCharge:E,isActiveCharge:E&&n,isBroken:R,isVirtual:Ie,isInnate:d.isInnate,isCantrip:C,isFocus:b,isPrepared:d.isPrepared,isSpontaneous:d.isSpontaneous||d.isFlexible,slotLevel:y.level,uses:ke??(E?P:y.uses),expended:Ce??(b&&!C?t.value<=0:!1),action:A.system.time.value,type:E?u?`${h}.summary.staff`:`${h}.summary.charges`:d.isInnate?"PF2E.PreparationTypeInnate":d.isSpontaneous?"PF2E.PreparationTypeSpontaneous":d.isFlexible?"PF2E.SpellFlexibleLabel":b?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:E?0:d.isPrepared?1:b?2:d.isInnate?3:d.isSpontaneous?4:5,noHover:d.isPrepared||C||R||b})}if(S.length){if(b)if(C)a=!0;else{i.push(...S);continue}s[y.level]??=[],s[y.level].push(...S)}}})),s.length){let l=m("summary")==="sort"?(f,p)=>f.order===p.order?B(f.name,p.name):f.order-p.order:(f,p)=>B(f.name,p.name);s.forEach(f=>f.sort(l))}i.length&&(i.sort((l,f)=>B(l.name,f.name)),s[12]=i,a=!1);let r=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,f)=>l.active.map(({spell:p})=>({name:p.name,img:p.img,slotId:f,itemId:p.id,level:p.level,time:p.system.time.value})).filter(Boolean));return{spells:s,rituals:r,focusPool:t,stavesActive:n,hasFocusCantrips:a,isOwner:e.isOwner}}o(Ot,"getData");var H=null,D=null;function Pe(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:be}],conflicts:["pf2e-unided"],init:()=>{be()}}}o(Pe,"registerUnided");function be(e){e??=m("unided"),e==="disabled"?(H&&(Hooks.off("preCreateItem",H),H=null),D&&(Hooks.off("preUpdateItem",D),D=null)):(H||(H=Hooks.on("preCreateItem",At)),e==="all"&&!D?D=Hooks.on("preUpdateItem",Tt):e!=="all"&&D&&(Hooks.off("preUpdateItem",D),D=null))}o(be,"setHooks");function At(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}o(At,"preCreateItem");function Tt(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}o(Tt,"preUpdateItem");var Ee=[Q(),he(),re(),Pe(),fe(),se(),ve()],Se=new Set;Hooks.once("init",()=>{let e=game.data.users.find(n=>n._id===game.data.userId),t=e&&e.role>=CONST.USER_ROLES.GAMEMASTER;for(let n of Ee){let{settings:s=[],init:i,conflicts:a=[]}=n;for(let c of s){let r=c.name;c.choices&&(c.choices=c.choices.reduce((l,f)=>(l[f]=Z(r,`choices.${f}`),l),{})),game.settings.register(h,r,{scope:"world",config:!0,...c,name:Z(r,"name"),hint:Z(r,"hint")})}if(t)for(let c of a){let r=game.modules.get(c);r?.active&&(n.conflicting=!0,Se.add(r.title))}!n.conflicting&&i&&i(t)}});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Ee)!t&&n&&n(e);if(e)for(let t of Se)_("module-conflict",{name:t},!0)});function Z(e,t){return`${h}.settings.${e}.${t}`}o(Z,"settingPath");})();
//# sourceMappingURL=main.js.map
