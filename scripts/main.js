(()=>{var bn=Object.defineProperty;var o=(e,t)=>bn(e,"name",{value:t,configurable:!0});var y="pf2e-toolbelt";function R(e,t,n="WRAPPER"){return libWrapper.register(y,e,t,n)}o(R,"registerWrapper");function P(...e){let[t,n]=e;return t=`${y}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}o(P,"localize");function vn(e){return game.i18n.has(`${y}.${e}`,!1)}o(vn,"hasLocalization");function Cn(e){return`${y}.${e}`}o(Cn,"localizePath");function k(e){let t=o((...n)=>P(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>D(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>j(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>G(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>vn(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>Cn(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:a})=>t(n,a),enumerable:!1,configurable:!1}}),t}o(k,"subLocalize");function ke(e,t,n,a){let r=typeof t=="string"?t:"info",s=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:a??!1;ui.notifications.notify(P(e,s),r,{permanent:i})}o(ke,"notify");function D(...e){let[t,n,a]=e;ke(t,"warning",n,a)}o(D,"warn");function j(...e){let[t,n,a]=e;ke(t,"info",n,a)}o(j,"info");function G(...e){let[t,n,a]=e;ke(t,"error",n,a)}o(G,"error");function b(e){return game.settings.get(y,e)}o(b,"getSetting");function Ne(e,t){return game.settings.set(y,e,t)}o(Ne,"setSetting");var Sn="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",kn="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",wn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",En="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",In=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function Ge(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{b("arp")&&(R(Sn,Pn,"WRAPPER"),R(kn,An,"WRAPPER"),R(wn,On,"WRAPPER"),R(En,Rn,"WRAPPER"))},ready:e=>{e&&b("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),j("arp.forceVariant"))}}}o(Ge,"registerArp");function se(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}o(se,"isValidActor");function ze(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!In.includes(e.sourceId)}o(ze,"isValidWeapon");function Pn(e){let t=this.actor;if(!se(t,!0)||!ze(this))return e();let n=t.level,a=this._source.system.traits.value;if(a.includes("alchemical")&&a.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}o(Pn,"onPrepareWeaponData");var Dn={1:35,2:935,3:8935,4:8935},Tn={striking:65,greaterStriking:1065,majorStriking:31065};function An(e){if(e(),!se(this.actor)||this.isSpecific||!ze(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Dn[n]);let a=this.system.strikingRune.value;a&&(t-=Tn[a]);let r=new game.pf2e.Coins({gp:t});(n||a)&&!this.system.runes.property.length&&(r=r.add(this._source.system.price.value)),this.system.price.value=new game.pf2e.Coins(r)}o(An,"onPrepareWeaponDerivedData");function Be(e){return!e.isShield}o(Be,"isValidArmor");function On(e){let t=this.actor;if(!se(t,!0)||!Be(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}o(On,"onPrepareArmorData");var Mn={1:160,2:1060,3:20560,4:20560},xn={resilient:340,greaterResilient:3440,majorResilient:49440};function Rn(e){if(e(),!se(this.actor)||this.isSpecific||!Be(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Mn[n]);let a=this.system.resiliencyRune.value;a&&(t-=xn[a]);let r=new game.pf2e.Coins({gp:t});(n||a)&&!this.system.runes.property.length&&(r=r.add(this._source.system.price.value)),this.system.price.value=new game.pf2e.Coins(r)}o(Rn,"onPrepareArmorDerivedData");function O(e,t,n=()=>{}){let a=null;return function(r,s=[],i=!1){typeof s=="string"&&(s=[s]),r||=s.some(c=>b(c)),r&&!a?a=Hooks.on(e,t):!r&&a&&(Hooks.off(e,a),a=null),i||n(r)}}o(O,"createHook");function ie(e,t,n=()=>{}){let a=null;return function(r,s=!1){r==="disabled"&&a?(Hooks.off(e,a),a=null):r!=="disabled"&&!a&&(a=Hooks.on(e,t)),s||n(r)}}o(ie,"createChoicesHook");function je(e,t){let n=Hooks.on(e,t),a=Hooks.events[e].findIndex(r=>r.id===n);if(a!==0){let[r]=Hooks.events[e].splice(a,1);Hooks.events[e].unshift(r)}return n}o(je,"registerUpstreamHook");var we=O("renderEffectsPanel",Un,$n);function qe(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>we(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>we(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{we(!1,["effect-remove","condition-sheet"])}}}o(qe,"registerEffectsPanelHelper");function $n(){game.pf2e.effectPanel?.render()}o($n,"refreshEffectsPanel");function Un(e,t){let n=`<div>${P("effects.remove")}</div>`,a='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',r=t.find(".effect-item[data-item-id]").toArray();for(let s of r){let i=s.dataset.itemId,c=e.actor?.items.get(i);if(c&&(b("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(s.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),s.querySelector(".icon").addEventListener("contextmenu",l=>Fn(l,e),!0)),b("condition-sheet")&&c.isOfType("condition"))){let l=s.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",a),l.querySelector('[data-action="edit"]').addEventListener("click",u=>Ln(u,e))}}}o(Un,"renderEffectsPanel");function Ln(e,t){let n=We(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}o(Ln,"onConditionSheet");function Fn(e,t){if(!e.shiftKey)return;let n=We(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}o(Fn,"onRemoveEffect");function We(e,t){let r=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(r)}o(We,"getEffect");var K=class extends FormApplication{constructor(t,n,a){super(t,n),this.onSubmitCallback=a}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};o(K,"MoveLootPopup");function M(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}o(M,"isPlayedActor");function Ee(){return CONFIG.ChatMessage.documentClass}o(Ee,"getChatMessageClass");function*Q(e,t){let n=game.messages.contents,a=(t?n.findLastIndex(r=>r===t):n.length)-1;for(let r=a;r>=a-e;r--){let s=n[r];if(!s)return;yield s}}o(Q,"latestChatMessages");function H(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}o(H,"chatUUID");function ce(e){game.socket.on(`module.${y}`,e)}o(ce,"socketOn");function le(e){game.socket.off(`module.${y}`,e)}o(le,"socketOff");function _(e){game.socket.emit(`module.${y}`,e)}o(_,"socketEmit");function fe(){return game.user===game.users.activeGM}o(fe,"isActiveGM");function ue(){let e=game.data.users.find(t=>t._id===game.data.userId);return e&&e.role>=CONST.USER_ROLES.GAMEMASTER}o(ue,"isUserGM");function Ve(){return game.users.some(e=>e.active&&e.isGM)}o(Ve,"isGMOnline");function Ye(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}o(Ye,"getCharacterOwner");function _n(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,a)=>n.id>a.id?1:-1),t[0]||null}o(_n,"getActiveOwner");function Ie(e){return _n(e)===game.user}o(Ie,"isActiveOwner");function Ke(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}o(Ke,"getOwner");var de=!1,J=null;function Ze(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:Qe}],conflicts:["pf2e-giveth"],ready:e=>{b("giveth")!=="disabled"&&Qe(!0)}}}o(Ze,"registerGiveth");function Qe(e){let t=game.user.isGM;e==="disabled"&&de?(t?le(Je):J&&(Hooks.off("dropCanvasData",J),J=null),de=!1):e!=="disabled"&&!de&&(t?ce(Je):J||(J=je("dropCanvasData",Hn)),de=!0)}o(Qe,"setup");function Je(e){fe()&&(e.type==="giveth-condition"?zn(e):e.type==="giveth-effect"?Bn(e):jn(e))}o(Je,"onSocket");function Hn(e,t){if(!Ve())return!0;let n=Gn(t);if(!n)return!0;let a=e.tokens.placeables.slice().filter(r=>{if(!r.document.actorLink)return!1;let s=r.actor;if(!et(s,t.actorId)||s.isOwner)return!1;let i=r.x+(r.hitArea?.right??0),c=r.y+(r.hitArea?.bottom??0);return t.x>=r.x&&t.y>=r.y&&t.x<=i&&t.y<=c}).sort((r,s)=>s.document.sort-r.document.sort).at(0)?.actor;return a?(Nn(n.actor,a,n.item,n.value),!1):!0}o(Hn,"onDropCanvasData");function Nn(e,t,n,a){let r=e.id,s=t.id,i=!(n instanceof Item);if(!i&&n.isOfType("physical")){let c=n.quantity;if(c<1)return D("giveth.notification.zero");if(c===1)return Xe(r,s,n.id,1,!1);new K(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,u)=>{Xe(r,s,n.id,l,u)}).render(!0)}else{let c=i?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?_({type:"giveth-condition",targetId:s,value:a??1,uuid:c}):_({type:"giveth-effect",targetId:s,uuid:c})}}o(Nn,"giveth");function Xe(e,t,n,a,r){_({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:a,stack:r})}o(Xe,"sendPhysicalRequest");function et(e,t){return!M(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}o(et,"isValidActor");function Gn(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let r=e.context?.origin.actor;n=r?fromUuidSync(r):null}if(!et(n)||!n.isOwner)return;let a=!(t instanceof Item);if(a&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!a&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}o(Gn,"getDetailsFromData");async function zn({targetId:e,uuid:t,value:n}){let a=game.actors.get(e);if(!a)return;let r=await fromUuid(t);r&&a.increaseCondition(r.slug,{min:n})}o(zn,"takethCondition");async function Bn({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let a=await fromUuid(t);if(!a)return;let r=a.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[r])}o(Bn,"takethEffect");async function jn({itemId:e,ownerId:t,qty:n,stack:a,targetId:r}){let s=game.actors.get(t),i=game.actors.get(r);if(!s||!i)return;let c=s.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,u=c.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=c.traits.has("invested")?!1:null);let f=await i.addToInventory(u,void 0,a);if(!f||(l<1?c.delete():c.update({"system.quantity":l}),b("giveth")==="no-message"))return;let g=H(f.uuid,f.name,!f.isIdentified);n>1&&(g+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${P("giveth.giveth",{target:i.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:s})})}o(jn,"takethPhysical");function w(...e){return e=e.filter(t=>typeof t=="string"),`modules/${y}/templates/${e.join("/")}.hbs`}o(w,"templatePath");var q=k("hero.templates.trade"),X=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:q("title"),template:w("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){q.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:x(this.actor),targetActions:this.target?x(this.target):[],i18n:q})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){q.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){q.warn("no-select");return}let a=Ye(this.target,!0)??Ke(this.target,!0)??game.users.activeGM;if(!a){q.warn("no-user");return}tt({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:a.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};o(X,"Trade");function me(e,t){return e.localeCompare(t,game.i18n.lang)}o(me,"localeCompare");function z(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}o(z,"refreshCharacterSheets");function Pe(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let a of e){let r=n.findIndex(s=>a===s);if(r===-1)return!1;n.splice(r,1)}return!0}o(Pe,"compareArrays");function nt(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}o(nt,"ordinalString");function pe(e,t){if(typeof e!="object")return!1;for(;e=Reflect.getPrototypeOf(e);)if(e.constructor.name===t)return!0;return!1}o(pe,"isInstanceOf");var ge="pf2e-hero-actions",at=null,ot=O("renderCharacterSheetPF2e",Yn,Vn),qn="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",he="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",Wn="systems/pf2e/icons/features/feats/heroic-recovery.webp";function st(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>ot(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>z()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[ge],api:{createTable:ia,removeHeroActions:da,getHeroActions:x,useHeroAction:ut,getHeroActionDetails:ye,drawHeroAction:ft,drawHeroActions:ct,sendActionToChat:ht,discardHeroActions:dt,tradeHeroAction:lt,getDeckTable:Ae,giveHeroActions:ga,createChatMessage:be},ready:()=>{ot(!1,"hero")}}}o(st,"registerHeroActions");function Vn(e){e&&!at?ce(rt):!e&&at&&le(rt)}o(Vn,"setupSocket");function rt(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;Ct(e);break;case"trade-accept":if(!fe())return;bt(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;ra(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;vt(e.error);break}}o(rt,"onSocket");async function Yn(e,t){let n=e.actor;M(n)&&(await Kn(t,n),Qn(t,n))}o(Yn,"renderCharacterSheetPF2e");async function Kn(e,t){let n=x(t),a=t.heroPoints.value-n.length,r=t.isOwner,s=k("hero.templates.heroActions"),i=await renderTemplate(w("hero/sheet"),{owner:r,list:n,canUse:a>=0&&r,canDraw:a>0&&r,canTrade:b("hero-trade"),mustDiscard:a<0,diff:Math.abs(a),i18n:(c,{hash:l})=>s(c,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(i)}o(Kn,"addActionsToSheet");function Qn(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",a=>ta(t,a)),n.find("[data-action=expand]").on("click",it),n.find("[data-action=use]").on("click",a=>ea(t,a)),n.find("[data-action=display]").on("click",a=>Zn(t,a)),n.find("[data-action=discard]").on("click",Xn),n.find("[data-action=discard-selected]").on("click",()=>Jn(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>lt(t))}o(Qn,"addSheetEvents");async function Jn(e,t){let a=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(r=>r.dataset.uuid);dt(e,a)}o(Jn,"onClickHeroActionsDiscard");function Xn(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let a=Number(n.attr("data-discard")??"0"),r=n.find(".action.discarded");n.toggleClass("discardable",r.length===a)}o(Xn,"onClickHeroActionDiscard");async function Zn(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");ht(e,n)}o(Zn,"onClickHeroActionDisplay");async function ea(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");ut(e,n)}o(ea,"onClickHeroActionUse");async function ta(e,t){t.preventDefault(),ct(e)}o(ta,"onClickHeroActionsDraw");function x(e){return getProperty(e,`flags.${ge}.heroActions`)??[]}o(x,"getHeroActions");async function B(e,t){return e.update({[`flags.${ge}.heroActions`]:t})}o(B,"setHeroActions");async function it(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let a=t.attr("data-uuid"),r=await ye(a);if(!r)return;let s=await TextEditor.enrichHTML(r.description,{async:!0});n.find(".item-description").html(s),n.addClass("loaded")}t.toggleClass("expanded")}o(it,"onClickHeroActionExpand");async function ye(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,a=t instanceof JournalEntry?t.pages.contents[0]:t,r=a?.text.content;if(r)return n.uuid===qn&&(r=r.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:a.name,description:r}}o(ye,"getHeroActionDetails");async function ct(e){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}let t=x(e),n=e.heroPoints.value-t.length,a=[];for(let r=0;r<n;r++){let s=await ft();if(s!==void 0){if(s===null)return;t.push(s),a.push(s)}}a.length&&(B(e,t),be({actor:e,actions:a,label:r=>P("hero.actions-draw.header",{nb:r}),secret:!0}))}o(ct,"drawHeroActions");function be({actor:e,actions:t,label:n,secret:a=!1}){let{content:r,size:s}=na(t);n=typeof n=="function"?n(s):n;let i={flavor:`<h4 class="action">${n}</h4>`,content:r,speaker:ChatMessage.getSpeaker({actor:e})};a&&b("hero-private")&&(i.type=CONST.CHAT_MESSAGE_TYPES.ROLL,i.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(i)}o(be,"createChatMessage");function na(e){let t=e.map(({uuid:n,name:a})=>H(n,a));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}o(na,"chatActions");function lt(e){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}let t=x(e);if(!t||!t.length){D("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){D("hero.no-points",{nb:n.toString()});return}new X(e).render(!0)}o(lt,"tradeHeroAction");async function ft(){let e=await Ae(),t=k("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(s=>!s.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let a=St(n);if(a)return{uuid:a,name:await mt(n,a)}}o(ft,"drawHeroAction");async function ut(e,t){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return D("hero.use.noPoints");let a=x(e),r=a.findIndex(i=>i.uuid===t);if(r===-1)return;let s=await ye(t);s||G("hero.use.noDetails"),a.splice(r,1),s?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${ge}.heroActions`]:a}),ChatMessage.create({flavor:`<h4 class="action">${P("hero.actions-use.header")}</h4>`,content:`<h2>${s.name}</h2>${s.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):B(e,a)}o(ut,"useHeroAction");async function dt(e,t){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}t=typeof t=="string"?[t]:t;let n=x(e),a=[];for(let r of t){let s=n.findIndex(i=>i.uuid===r);s!==-1&&(a.push(n[s]),n.splice(s,1))}B(e,n),be({actor:e,actions:a,label:r=>P("hero.actions-discard.header",{nb:r})})}o(dt,"discardHeroActions");async function mt(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}o(mt,"getLabelfromTableResult");async function pt(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}o(pt,"getTableFromUuid");async function aa(){return pt(he)}o(aa,"getDefaultCompendiumTable");function gt(){return game.tables.find(e=>e.getFlag("core","sourceId")===he)}o(gt,"getDefaultWorldTable");async function oa(){return pt(b("hero-table"))}o(oa,"getCustomTable");async function Ae(){return await oa()??gt()??await aa()}o(Ae,"getDeckTable");async function ht(e,t){let n=await ye(t);if(!n)return G("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}o(ht,"sendActionToChat");function tt(e){if(e.receiver.id===game.user.id){yt(e);return}_({...e,type:"trade-request"})}o(tt,"sendTradeRequest");function yt(e){if(game.user.isGM){bt(e);return}_({...e,type:"trade-accept"})}o(yt,"acceptRequest");async function bt(e){let{sender:t,receiver:n}=e,a=game.actors.get(t.cid),r=game.actors.get(n.cid);if(!a||!r){De(e);return}let s=x(a),i=x(r),c=s.findIndex(p=>p.uuid===t.uuid),l=i.findIndex(p=>p.uuid===n.uuid);if(c===-1||l===-1){De(e);return}let u=s.splice(c,1)[0],f=i.splice(l,1)[0];s.push(f),i.push(u),B(a,s),B(r,i);let g=H(u.uuid),h=H(f.uuid),d=k("hero.trade-success"),m=`<div style="line-height: 1.6">${d("offer",{offer:g})}</div>`;m+=`<div style="line-height: 1.6">${d("receive",{receive:h})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${d("header",{name:r.name})}</h4>`,content:m,speaker:ChatMessage.getSpeaker({actor:a})})}o(bt,"onTradeAccepted");function De({sender:e,receiver:t},n="trade-error"){let a=new Set([e.id,t.id]);a.has(game.user.id)&&(a.delete(game.user.id),vt(n)),a.size&&_({type:"trade-error",users:Array.from(a),error:n})}o(De,"sendTradeError");function vt(e){G("hero.trade-error")}o(vt,"onTradeError");async function ra(e){let{sender:t,receiver:n}=e,a=game.actors.get(t.cid),r=game.actors.get(n.cid);if(!a||!r){De(e);return}let s=k("hero.trade-request"),i=`<p>${s("header",{sender:a.name,receiver:r.name})}</p>`;i+=`<p>${s("give",{give:H(t.uuid)})}</p>`,i+=`<p>${s("want",{want:H(n.uuid)})}</p>`,i+=`<p style="margin-bottom: 1em;">${s("accept")}</p>`,await Dialog.confirm({title:s("title"),content:await TextEditor.enrichHTML(i,{async:!0})})?yt(e):sa(e)}o(ra,"onTradeRequest");function sa(e){if(e.sender.id===game.user.id){Ct(e);return}_({...e,type:"trade-reject"})}o(sa,"rejectRequest");async function Ct({receiver:e}){let t=game.actors.get(e.cid);D("hero.trade-rejected",{name:t.name},!0)}o(Ct,"onTradeRejected");async function ia(){if(!game.user.isGM){D("hero.notGM");return}let e=k("hero.templates.createTable.choice"),t=w("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:s=>{let i=s.find('.window-content input[name="type"]:checked').val(),c=s.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:i,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},a={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},r=await Dialog.wait(a,void 0,{id:"pf2e-hero-actions-create-table"});r&&(r.type==="default"?fa(r.unique):ca(r.unique))}o(ia,"createTable");async function ca(e){let t=await la(e);await Te(t),t.sheet?.render(!0)}o(ca,"createCustomTable");function la(e=!0){let t=Oe(e);return RollTable.create(t,{temporary:!1})}o(la,"createCustomActionsTable");async function fa(e){let t=k("templates.createTable.default.confirm"),n=await gt();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let r=Oe(e);return await n.update(r),Te(n,!0)}n=await ua(e),await Te(n)}o(fa,"createDefaultTable");async function ua(e=!0){let t=await fromUuid(he),n=Oe(e,t);return RollTable.create(n,{temporary:!1})}o(ua,"createDefautActionsTable");async function Te(e,t=!1){t&&await e.normalize(),await Ne("hero-table",e.uuid)}o(Te,"setTable");function Oe(e=!0,t){let n={name:P("hero.table.name"),replacement:!e,img:Wn,description:P("hero.table.description"),flags:{core:{sourceId:he}}};return t?mergeObject(deepClone(t._source),n):n}o(Oe,"getTableSource");async function da(){if(!game.user.isGM){D("hero.notGM");return}let e=k("hero.templates.removeActions"),t=w("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:s=>s.find('input[name="actor"]:checked').toArray().map(i=>game.actors.get(i.value)).filter(i=>i)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},a={content:await renderTemplate(t,{actors:game.actors.filter(s=>s.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:s=>{s.on("change",'input[name="all"]',()=>ma(s)),s.on("change",'input[name="actor"]',()=>pa(s))},close:()=>null},r=await Dialog.wait(a,void 0,{id:"pf2e-hero-actions-remove-actions"});if(r){if(!r.length){e.warn("noSelection");return}for(let s of r)B(s,[]);e.info("removed")}}o(da,"removeHeroActions");function ma(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}o(ma,"removeActionsToggleAll");function pa(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),a=e.find('input[name="all"]');t.length===n.length?(a.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?a.prop("checked",!1).prop("indeterminate",!0):(a.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}o(pa,"removeActionsToggleActor");function St(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}o(St,"documentUuidFromTableResult");async function ga(e){if(!game.user.isGM){D("hero.notGM");return}let t=k("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await Ae();if(!n)return G("hero.table.drawError",!0),null;let a=n.replacement===!1,r=(await Promise.all(n.results.map(async p=>{let v=St(p);if(v)return{key:p.id,uuid:v,name:await mt(p,v),drawn:p.drawn}}))).filter(Boolean),s=w("hero/dialogs/give-action"),i=await renderTemplate(s,{actions:r,isUnique:a,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:p=>({selected:p.find("[name=action]:checked").closest(".action").toArray().map(v=>v.dataset),asDrawn:p.find("[name=drawn]").prop("checked")??!1,withMessage:p.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:i,buttons:c,render:p=>{p.find("[data-action=expand]").on("click",it)},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!u)return;let{selected:f,asDrawn:g,withMessage:h}=u,d=x(e),m=[];for(let{uuid:p,name:v,key:S}of f){if(d.push({uuid:p,name:v}),!g)continue;let T=n.results.get(S);T&&!T.drawn&&m.push(S)}m.length&&await n.updateEmbeddedDocuments("TableResult",m.map(p=>({_id:p,drawn:!0}))),B(e,d),h&&be({actor:e,actions:f,label:p=>P("hero.actions-give.header",{nb:p}),secret:!0})}o(ga,"giveHeroActions");function I(e,t,n){return e.getFlag(y,t)??n}o(I,"getFlag");function Z(e,t,n){return e.setFlag(y,t,n)}o(Z,"setFlag");function kt(e,t){return e.unsetFlag(y,t)}o(kt,"unsetFlag");function wt(e,t,n){return e.updateSource({[`flags.${y}.${t}`]:n})}o(wt,"updateSourceFlag");var Et=k("knowledges.editLore"),ee=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Et("title",this.actor)}get template(){return w("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:I(n,"knowledges.unspecified")??"",specific:I(n,"knowledges.specific")??"",i18n:Et})}async _updateObject(t,{unspecified:n,specific:a}){let r=this.object;Z(r,"knowledges.unspecified",n.trim()),Z(r,"knowledges.specific",a.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};o(ee,"EditLores");var It=O("renderNPCSheetPF2e",ha);function Pt(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>It(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&b("knowledges")&&It(!0)}}}o(Pt,"registerKnowledges");function ha(e,t){let n=e.actor;M(n)&&(ba(n,t),Ca(t),va(n,t))}o(ha,"renderNPCSheetPF2e");function Me(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}o(Me,"knowledgeSelector");function ya(e){new ee(e).render(!0)}o(ya,"editLores");function ba(e,t){let n=I(e,"knowledges.unspecified"),a=I(e,"knowledges.specific");if(!n&&!a)return;let r=e.identificationDCs.lore,s=Me(t,"body","");s.find(".identification-skills").last().remove();function i(l,u,f){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:f})}</div>`}o(i,"tag");function c(l,{dc:u,start:f}){let g=l.split(",").filter(h=>h.trim()).map(h=>i(h,u,f)).join("");s.append(g)}o(c,"addTags"),c(n||"Unspecific",r[0]),c(a||"Specific",r[1])}o(ba,"replaceLores");function va(e,t){Me(t,"header","button.edit").on("click",()=>ya(e))}o(va,"addEvents");function Ca(e){let t=Me(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}o(Ca,"addEditButton");var xe=k("merge.multi"),te=class extends Application{constructor(t,n,a){super(a),this._event=t,this._spell=n}get spell(){return this._spell}get title(){return xe("title",this.spell)}get template(){return w("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:xe})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){xe.error("zero"),this.close();return}let a=this.spell,r=deepClone(a._source.system.damage),s=deepClone(a._source.system.heightening)??{};for(let[c,l]of Object.entries(r))for(let u=0;u<n-1;u++){let f=randomID();if(r[f]=l,s.type==="interval"){let g=s.damage[c];g&&(s.damage[f]=g)}else if(s.type==="fixed")for(let[g,h]of Object.entries(s.levels)){let d=h.damage.value[c];d&&(s.levels[g].damage.value[f]=d)}}a.clone({"system.damage":r,"system.heightening":s}).rollDamage(this._event),this.close()}#t(t){t.preventDefault(),this.close()}};o(te,"MultiCast");var Sa=/(\[[\w,]+\])/,Re=O("renderChatMessage",xt,ka);function Mt(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>Re(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>Re(e,"merge-damage")}],init:e=>{Re(!1,["multi-cast","merge-damage"],!0)}}}o(Mt,"registerMerge");function ka(){let e=ui.chat?.element;if(e)for(let t of Q(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),xt(t,n))}}o(ka,"updateMessages");function xt(e,t){!game.user.isGM&&!e.isAuthor||(b("merge-damage")&&Ut(e)?Ea(e,t):b("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&wa(e,t))}o(xt,"renderChatMessage");function wa(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let a=t.find(".message-content .chat-card .owner-buttons .spell-button");a.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${P("merge.spell.button")}</button>`),a.find("[data-action=multi-cast]").on("click",async r=>{let s=await fromUuid(n);s&&new te(r,s).render(!0)})}o(wa,"renderSpell");function Ea(e,t){let n='<span class="pf2e-toolbelt-merge">';if(I(e,"merge.merged")){let i=P("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${i}">`,n+='<i class="fa-duotone fa-split"></i>'}let a=P("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${a}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let r=At(e),s=Ot(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",i=>{i.stopPropagation();for(let c of Q(5,e))if(!(!Ut(c)||At(c)!==r||!Pe(s,Ot(c)))){Pa(i,e,c,{actorUUID:r,targetUUID:s});return}D("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",i=>{i.stopPropagation(),Ia(i,e)})}o(Ea,"renderDamage");async function Ia(e,t){let n=I(t,"merge.data").flatMap(a=>a.source);await Rt(t.id),await Ee().createDocuments(n)}o(Ia,"splitDamages");async function Pa(e,t,n,{actorUUID:a,targetUUID:r}){let s={},i=Dt(n).concat(Dt(t));for(let{name:d,notes:m,outcome:p,modifiers:v,tags:S}of i)s[d]??={name:d,tags:S,notes:new Set,results:[]},m.forEach(s[d].notes.add,s[d].notes),s[d].results.some(A=>A.outcome===p&&Pe(A.modifiers,v))||s[d].results.push({outcome:p,modifiers:v});let c=Object.values(s).map(d=>(d.label=d.name,d.results.forEach(m=>{m.outcome&&(m.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${m.outcome}`))}),d));c.at(-1).isLastGroup=!0;let l=await renderTemplate(w("merge/merged"),{groups:c,hasMultipleGroups:c.length>1}),u=Tt(t),f=Tt(n),g=[];for(let d of[].concat(f,u)){let{options:m,total:p,terms:v}=d,S=v[0],T=d.formula.replace(Sa,""),A=g.find(({options:{flavor:U,critRule:E}})=>U===m.flavor&&E===m.critRule);A?(A.terms.push(S),A.total+=p,A.formulas.push(T)):g.push({options:m,formulas:[T],total:p,terms:[S]})}for(let d of g)d.formula=`(${d.formulas.join(" + ")})[${d.options.flavor}]`,d.term=d.terms.length<2?d.terms[0]:$t(d.terms);let h={class:"DamageRoll",options:{},dice:[],formula:`{${g.map(({formula:d})=>d).join(", ")}}`,total:g.reduce((d,{total:m})=>d+m,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:g.map(({formula:d})=>d),modifiers:[],rolls:g.map(({options:d,formula:m,total:p,term:v})=>({class:"DamageInstance",options:d,dice:[],formula:m,total:p,terms:[v],evaluated:!0})),results:g.map(({total:d})=>({result:d,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let d=o(m=>{"results"in m?m.results.forEach(p=>p.hidden=!0):(m.term??m).operands?.forEach(p=>d(p))},"setHidden");h.terms[0].rolls.forEach(m=>m.terms.forEach(p=>d(p)))}await Rt(t.id,n.id),await Ee().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[y]:{merge:{actor:a,target:r,merged:!0,type:"damage-roll",data:i}},pf2e:{context:{options:Array.from(new Set(i.flatMap(d=>d.itemTraits)))}}},rolls:[h]})}o(Pa,"mergeDamages");function Dt(e){let t=I(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let a=$(`<div>${e.flavor}</div>`),r=a.find("h4.action + .tags").prop("outerHTML"),s=[];a.find(".tag.tag_transparent").each(function(){s.push(this.innerHTML)});let i=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>c.startsWith("item:")),modifiers:s,tags:r,notes:i}]}o(Dt,"getMessageData");function Rt(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}o(Rt,"removeChatMessages");function $t(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?$t(e):e[0]]}}}o($t,"createTermGroup");function Tt(e){return I(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}o(Tt,"getMessageRolls");function At(e){return I(e,"merge.actor")??e.actor?.uuid}o(At,"getActorUUID");function Ot(e){let t=I(e,"target.targets");if(t)return t.map(({actor:a})=>a).filter(Boolean);let n=I(e,"merge.target")??e.target?.actor.uuid;return n?[n]:[]}o(Ot,"getTargetUUIDs");function Ut(e){return I(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}o(Ut,"isDamageRoll");var Lt=ie("renderChatMessage",_t,Da);function Ft(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>Lt(e)}],init:e=>{!e&&b("modifiers")!=="disabled"&&Lt(!0,!0)}}}o(Ft,"registerHideModifiers");function Da(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of Q(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),_t(t,n))}}o(Da,"updateMessages");function _t(e,t){let n=e.speaker,a=ChatMessage.getSpeakerActor(n);if(!a||a.hasPlayerOwner)return;let r=t.find(".message-header");b("modifiers")==="traits"&&r.addClass("pf2e-toolbelt-modifiers-traits"),b("modifiers")!=="disabled"&&r.addClass("pf2e-toolbelt-modifiers")}o(_t,"renderChatMessage");var Ta="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",Aa="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function Ht(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{b("nobulk")&&R(Ta,Ma,"WRAPPER"),b("nobulk-coins")&&R(Aa,Oa,"WRAPPER")}}}o(Ht,"registerNobulk");function Oa(e){e(),this.isCoinage&&(this.system.bulk.value=0)}o(Oa,"treasurePrepareBaseData");function Ma(e,...t){e(...t);let n=this,a=n.inventory.bulk.constructor,r=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return r||(r=a.computeTotalBulk(this.actor.inventory.filter(s=>!s.isInContainer&&s.system.equipped.carryType!=="dropped"),this.actor.size),r)}})}o(Ma,"actorPrepareEmbeddedDocuments");var xa="CONFIG.Actor.documentClass.prototype.prepareData",Ra="DocumentSheet.prototype._renderInner";function Nt(){return{settings:[{name:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{b("share")!=="disabled"&&(R(xa,Ha,"WRAPPER"),R(Ra,$a,"WRAPPER"),Hooks.on("preUpdateActor",La),Hooks.on("deleteActor",Ua),Hooks.on("updateActor",Fa))}}}o(Nt,"registerShare");async function $a(e,...t){let n=await e(...t);if(!pe(this,"CreatureConfig"))return n;let a=this.actor;if(!M(a)||!a.isOfType("character","npc")||ne(a).size)return n;let r=game.actors.filter(i=>i.id!==a.id&&i.isOwner&&Ce(i)).map(i=>({key:i.id,label:i.name})),s=await renderTemplate(w("share/master"),{masters:r,master:I(a,"share.master"),selectPath:`flags.${y}.share.master`,i18n:k("share.templates.master")});return n.children().last().before(s),n}o($a,"documentSheetRenderInner");function Ua(e){Wt(e);let t=ne(e);Promise.all(t.map(async n=>{zt(n),await kt(n,"share.master")}))}o(Ua,"deleteActor");function La(e,t){let n=getProperty(t,`flags.${y}.share`);if(n?.master){let a=game.actors.get(n.master);if(Ce(a)){let r=deepClone(a._source.system.attributes.hp);setProperty(t,"system.attributes.hp",r)}}else{let a=ve(e),r=getProperty(t,"system.attributes.hp");a&&r&&(a.update({system:{attributes:{hp:r}}},{noHook:!0}),delete t.system.attributes.hp)}}o(La,"preUpdateActor");function Fa(e,t,n,a){let r=game.user.id===a,s=Ga(t);if(s?.master!==void 0){let c=e;if(Wt(c),s.master){let l=game.actors.get(s.master);Ce(l)&&(Gt(c,l),qt(l,c))}else zt(c)}if(!r)return;let i=ne(e);if(i.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(i.map(async u=>await u.update(l,{noHook:!0})))}else Promise.all(i.map(async l=>await _a(l,t)))}}o(Fa,"updateActor");async function _a(e,t){b("share")==="force"?await Z(e,"toggle",!I(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}o(_a,"refreshActor");function Ha(e){e();let t=this,n=I(t,"share.master"),a=n?game.actors.get(n):void 0;if(!Ce(a))return;ve(this)||(Gt(this,a),qt(a,this));let r=this.system.attributes.hp;Object.defineProperty(t.system.attributes,"hp",{get(){let s=a.system.attributes.hp;return Na(s,r),r},enumerable:!0})}o(Ha,"prepareData");function Na(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}o(Na,"transfertHpData");function Ga(e){return getProperty(e,`flags.${y}.share`)}o(Ga,"getShareFlag");function ne(e){return Bt(e,"slaves")??new Collection}o(ne,"getSlaves");function Gt(e,t){jt(e,"master",t)}o(Gt,"setMaster");function zt(e){za(e,"master")}o(zt,"unsetMaster");function ve(e){return Bt(e,"master")}o(ve,"getMaster");function Ce(e){return e&&e.type==="character"&&!ve(e)}o(Ce,"isValidMaster");function Bt(e,t){return getProperty(e,`modules.${y}.share.${t}`)}o(Bt,"getModuleProperty");function jt(e,t,n){setProperty(e,`modules.${y}.share.${t}`,n)}o(jt,"setModuleProperty");function za(e,t){delete e.modules?.[y]?.share?.[t]}o(za,"deleteModuleProperty");function qt(e,t){let n=ne(e);jt(e,"slaves",n.set(t.id,t))}o(qt,"addSlaveToMaster");function Wt(e){let t=ve(e);if(!t)return;ne(t).delete(e.id)}o(Wt,"removeSlaveFromMaster");function Vt(e){return e.getFlag("core","sourceId")}o(Vt,"getSourceId");function Ba(e,t){let n=Vt(e);return n?t.includes(n):!1}o(Ba,"includesSourceId");function Yt(e){return Array.isArray(e)?t=>Ba(t,e):t=>Vt(t)===e}o(Yt,"getItemSourceIdCondition");function Kt(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}o(Kt,"getItems");function Qt(e,t,n){return Kt(e,n).some(Yt(t))}o(Qt,"hasItemWithSourceId");function Se(e,t,n){return Kt(e,n).find(Yt(t))}o(Se,"getItemWithSourceId");var ja=O("renderCharacterSheetPF2e",Ja),qa=O("deleteCombat",Za),Wa=O("deleteCombatant",an),Va=O("createCombatant",eo),Ya=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Ka=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),Qa=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function Xt(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:Jt},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:$e,toggleStance:nn,isValidStance:Zt},ready:e=>{b("stances")&&Jt(!0)}}}o(Xt,"registerStances");function Jt(e){ja(e),qa(e),Wa(e),Va(e)}o(Jt,"setup");function Zt(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}o(Zt,"isValidStance");function $e(e){let t=[],n=new Set;for(let{replace:a,sourceId:r,effectUUID:s,effect:i,img:c,name:l,itemName:u,action:f}of en(e)){a&&n.add(a);let g=f?Se(e,f,"action"):Se(e,r,"feat");t.push({name:l,itemName:u,uuid:r,img:c,effectUUID:s,effectID:i?.id,actionUUID:g.sourceId,actionID:g.id})}return t.filter(({uuid:a})=>!n.has(a))}o($e,"getStances");async function Ja(e,t){let n=e.actor;if(!M(n))return;let a=$e(n);if(!a.length)return;let r=n.getActiveTokens(!0,!0).some(l=>l.inCombat),s=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),i=s.find(".actions-options"),c=await renderTemplate(w("stances/sheet"),{stances:a,canUseStances:r&&!n.isDead,i18n:k("stances")});i.length?i.after(c):s.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>Xa(l,n))}o(Ja,"renderCharacterSheetPF2e");function Xa(e,t){let n=e.currentTarget,a=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!a)return;let r=n.dataset.effectUuid;nn(t,r)}o(Xa,"onToggleStance");function*en(e){for(let t of e.itemTypes.feat){let n=t.sourceId,a=Ka.get(n),r=Qa.get(n);if(!a&&!r&&!Zt(t))continue;let s=a?.effect??r?.effect??t.system.selfEffect.uuid,i=fromUuidSync(s);i&&(yield{name:(a&&fromUuidSync(a.replace)?.name)??t.name,itemName:t.name,replace:a?.replace,extra:r,sourceId:n,effectUUID:s,effect:Se(e,s,"effect"),action:r?.action,img:i.img})}}o(en,"actorStances");function tn(e){let t=[];for(let{effect:n}of en(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}o(tn,"getStancesEffects");async function nn(e,t){let n=tn(e),a=n.findIndex(s=>s.uuid===t),r=!1;if(a===-1)r=!0;else{let s=n.filter(c=>c.uuid!==t).length,i=n.filter(c=>c.uuid===t).length>1;(s||i)&&n.splice(a,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(s=>s.id)),r&&Ue(e,t)}o(nn,"toggleStance");async function Ue(e,t){let n=await fromUuid(t);if(n){let a=n.toObject();return getProperty(a,"flags.core.sourceId")||setProperty(a,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[a]))[0]?.toMessage(),!0}return!1}o(Ue,"addStance");function Za(e){for(let t of e.combatants)an(t)}o(Za,"deleteCombat");function an(e){let t=on(e);if(t){if(!game.user.isGM&&Ie(t)){let n=tn(t).map(a=>a.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}z(t)}}o(an,"deleteCombatant");function eo(e){let t=on(e);t&&(!game.user.isGM&&Ie(t)&&to(t),z(t))}o(eo,"createCombatant");function on(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}o(on,"getActorFromCombatant");async function to(e){let t=$e(e);if(!(!t.length||t.filter(({effectID:r})=>r).length||!Qt(e,Ya,["feat"])))if(t.length===1){let r=t[0];await Ue(e,r.effectUUID)&&j("stances.useStance",{stance:r.name})}else no(e,t)}o(to,"checkForSavant");async function no(e,t){let n=k("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(w("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:a=>Ue(e,a.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}o(no,"openStancesMenu");var rn=ie("renderCharacterSheetPF2e",ao,()=>z());function sn(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>rn(e)}],conflicts:["pf2e-spells-summary"],init:e=>{b("summary")!=="disabled"&&rn(!0,!0)}}}o(sn,"registerSpellsSummary");async function ao(e,t){let n=e.actor;if(!M(n))return;let a=ae(t);getProperty(e,`modules.${y}.toggled`)&&a.addClass("toggled"),bo(t).on("click",r=>yo(r,t,e)),await oo(t,e,n),a.hasClass("toggled")&&a.hasClass("active")&&e._restoreScrollPositions(t)}o(ao,"renderCharacterSheetPF2e");async function oo(e,t,n){let a=ae(e),r=await So(n),s=await renderTemplate(w("summary/sheet"),r);a.append(s),ro(e,t,n)}o(oo,"addSummaryTab");function ro(e,t,n){let a=Co(e),r=a.find(".spell-type .uses .spell-slots-input input");r.on("change",s=>so(s,n)),r.on("focus",io),r.on("blur",co),a.find("[data-action=cast-spell]").on("click",s=>po(s,n)),a.find(".item-toggle-prepare").on("click",s=>lo(s,n)),a.find(".focus-pips").on("click contextmenu",s=>fo(s,n)),a.find(".spell-slots-increment-reset").on("click",s=>mo(s,t,n)),a.find(".item-image").on("click",s=>ho(s,n)),a.find(".item-name > h4").on("click",s=>go(s,t))}o(ro,"addSummaryEvents");async function so(e,t){e.preventDefault();let{inputPath:n,entryId:a}=$(e.currentTarget).data(),r=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:a,[n]:r}])}o(so,"onUsesInputChange");function io(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}o(io,"onUsesInputFocus");function co(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}o(co,"onUsesInputBlur");function lo(e,t){e.preventDefault();let{slotLevel:n,slotId:a,entryId:r,expended:s}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(r)?.setSlotExpendedState(n??0,a??0,s!==!0)}o(lo,"onTogglePrepare");function fo(e,t){e.preventDefault();let n=e.type==="click"?1:-1,a=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":a})}o(fo,"onToggleFocusPool");function uo(e,t){vo(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}o(uo,"onChargeReset");function mo(e,t,n){e.preventDefault();let{itemId:a,level:r,isCharge:s}=$(e.currentTarget).data();if(!a)return;if(s){uo(t,a);return}let i=n.items.get(a);if(i){if(i.isOfType("spellcastingEntry")){let c=r>=0&&r<=11?`slot${r}`:"slot0",l=i.system.slots?.[c];l&&i.update({[`system.slots.${c}.value`]:l.max})}else if(i.isOfType("spell")){let c=i.system.location.uses?.max;c&&i.update({"system.location.uses.value":c})}}}o(mo,"onSlotsReset");function po(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:a,slotLevel:r,slotId:s,entryId:i}=n.closest(".item").data(),c=t.spellcasting.collections.get(i);if(!c)return;let l=c.get(a);l&&c.entry.cast(l,{slot:s,level:r})}o(po,"onCastSpell");async function go(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}o(go,"onToggleSummary");async function ho(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),a=t.items.get(n);!a||a.isOfType("physical")&&!a.isIdentified||await a.toMessage(e)}o(ho,"onItemToChat");function yo(e,t,n){e.preventDefault();let a=ae(t);a.hasClass("active")&&(a.toggleClass("toggled"),a.scrollTop(0),setProperty(n,`modules.${y}.toggled`,a.hasClass("toggled")))}o(yo,"onSpellcastingBtnToggle");function bo(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}o(bo,"getSpellcastingNav");function ae(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}o(ae,"getSpellcastingTab");function vo(e){return ae(e).find(".directory-list.spellcastingEntry-list")}o(vo,"getSpellcastingOriginalSection");function Co(e){return ae(e).find(".directory-list.summary")}o(Co,"getSpellcastingSummarySection");async function So(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,a=[],r=[],s=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,f=l.statistic.dc.value,g=l.name,h=await l.getSheetData(),d=h.isFocusPool,m=l.system?.prepared?.value==="charge",p=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,v={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let S of h.levels){if(!S.active.length||S.uses?.max===0)continue;let T=[],A=S.isCantrip,U=S.active.filter(L=>L&&L.uses?.max!==0),E=!A&&m&&!n;for(let L=0;L<U.length;L++){let{spell:F,expended:re,virtual:C,uses:V,castLevel:Y}=U[L];T.push({name:F.name,img:F.img,range:F.system.range.value||"-",castLevel:Y??F.level,slotId:L,entryId:u,entryDc:f,entryName:g,itemId:F.id,inputId:h.isInnate?F.id:h.id,inputPath:m?"flags.pf2e-staves.charges":h.isInnate?"system.location.uses.value":`system.slots.slot${S.level}.value`,isCharge:m,isActiveCharge:m&&n,isBroken:E,isVirtual:C,isInnate:h.isInnate,isCantrip:A,isFocus:d,isPrepared:h.isPrepared,isSpontaneous:h.isSpontaneous||h.isFlexible,slotLevel:S.level,uses:V??(m?v:S.uses),expended:re??(d&&!A?t.value<=0:!1),action:F.system.time.value,type:m?p?`${y}.summary.staff`:`${y}.summary.charges`:h.isInnate?"PF2E.PreparationTypeInnate":h.isSpontaneous?"PF2E.PreparationTypeSpontaneous":h.isFlexible?"PF2E.SpellFlexibleLabel":d?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:m?0:h.isPrepared?1:d?2:h.isInnate?3:h.isSpontaneous?4:5,noHover:h.isPrepared||A||E||d})}if(T.length){if(d)if(A)s=!0;else{r.push(...T);continue}a[S.level]??=[],a[S.level].push(...T)}}})),a.length){let l=b("summary")==="sort"?(u,f)=>u.order===f.order?me(u.name,f.name):u.order-f.order:(u,f)=>me(u.name,f.name);a.forEach(u=>u.sort(l))}r.length&&(r.sort((l,u)=>me(l.name,u.name)),a[12]=r,s=!1);let c=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:f})=>({name:f.name,img:f.img,slotId:u,itemId:f.id,level:f.level,time:f.system.time.value})).filter(Boolean));return{spells:a,rituals:c,focusPool:t,stavesActive:n,hasFocusCantrips:s,isOwner:e.isOwner,entryRank:l=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:nt(l)})}}o(So,"getData");function ko(e){return Error(`PF2e System | ${e}`)}o(ko,"ErrorPF2e");async function wo({affects:e,origin:t,target:n,item:a,domains:r,options:s}){if(!(t&&n))return[];let[i,c]=e==="target"?[t,n]:[n,t],l=[...s,i.getRollOptions(r),c.getSelfRollOptions(e)].flat(),u=a?a.isOfType("spell")?{spell:a}:{weapon:a}:{};return(await Promise.all(r.flatMap(f=>i.synthetics.ephemeralEffects[f]?.[e]??[]).map(f=>f({test:l,resolvables:u})))).flatMap(f=>f??[])}o(wo,"extractEphemeralEffects");function Eo(e,t){return t.flatMap(n=>(e[n]??[]).map(a=>a.clone()))}o(Eo,"extractNotes");function Io(e,t,n){return t.flatMap(a=>e[a]??[]).flatMap(a=>a(n)??[])}o(Io,"extractDamageDice");async function Po(e,{message:t,multiplier:n,rollIndex:a}){let r=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),s=o(class extends Dialog{activateListeners(i){super.activateListeners(i),i[0].querySelector("input")?.focus()}},"AdjustmentDialog");new s({title:game.i18n.localize("PF2E.UI.shiftModifyDamageTitle"),content:r,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async i=>{let c=(Number(i[0].querySelector("input")?.value)||0)*Math.sign(n);Le(e,{message:t,multiplier:n,addend:c,promptModifier:!1,rollIndex:a})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{ln(t.id)}}).render(!0)}o(Po,"shiftAdjustDamage");async function Le(e,{message:t,multiplier:n=1,addend:a=0,promptModifier:r=!1,rollIndex:s=0}){if(r)return Po(e,{message:t,multiplier:n,rollIndex:s});let i=CONFIG.PF2E.chatDamageButtonShieldToggle,c=t.rolls.at(s);if(!pe(c,"DamageRoll"))throw ko("Unexpected error retrieving damage roll");let l=n<0?n*c.total+a:c.alter(n,a),u=[...t.flags.pf2e.context?.options??[]],f=u.filter(E=>E.startsWith("self:")).map(E=>E.replace(/^self/,"origin")),g=t.item;if(!e.actor)return;u.some(E=>E.startsWith("target"))||u.push(...e.actor.getSelfRollOptions("target"));let h=n>0?"damage-received":"healing-received",d=n>0?await wo({affects:"target",origin:t.actor,target:e.actor,item:t.item,domains:[h],options:u}):[],m=e.actor.getContextualClone(f,d),p=new Set([...u.filter(E=>!/^(?:self|target):/.test(E)),...f,...m.getSelfRollOptions()]),v=t.flags.pf2e.context?.outcome,S=[],T=[];if(typeof l=="number"&&l<0){let E=v==="criticalSuccess",L=(()=>g?.isOfType("spell")?{spell:g}:g?.isOfType("weapon")?{weapon:g}:{})(),F=Io(m.synthetics.damageDice,[h],{resolvables:L,test:p}).filter(C=>(C.critical===null||C.critical===E)&&C.predicate.test(p));for(let C of F){let V=`${C.diceNumber}${C.dieSize}[${C.label}]`,Y=await new Roll(V).evaluate({async:!0});Y._formula=`${C.diceNumber}${C.dieSize}`,await Y.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:C.label,speaker:ChatMessage.getSpeaker({token:e})}),S.push(`${C.label} ${C.diceNumber}${C.dieSize}`),T.push(Y)}T.length&&(l-=T.map(C=>C.total).reduce((C,V)=>C+V));let re=Ao(m.synthetics,[h],{resolvables:L}).filter(C=>(C.critical===null||C.critical===E)&&C.predicate.test(p));l-=Do(re??[]),S.push(...re.filter(C=>C.enabled).map(C=>`${C.label} ${signedInteger(C.modifier)}`))}let A=typeof l=="number"?l!==0:l.total!==0,U=(()=>A?Eo(m.synthetics.rollNotes,[h]).filter(E=>(!v||E.outcome.length===0||E.outcome.includes(v))&&E.predicate.test(p)).map(E=>E.text):[])();await m.applyDamage({damage:l,token:e,item:t.item,skipIWR:n<=0,rollOptions:p,shieldBlockRequest:i,breakdown:S,notes:U}),ln(t.id)}o(Le,"applyDamageFromMessage");function cn(e,t,n){let a=e[t.type];return a===void 0?(t.enabled=!0,e[t.type]=t,t.modifier):n(t,a)?(a.enabled=!1,t.enabled=!0,e[t.type]=t,t.modifier-a.modifier):(t.enabled=!1,0)}o(cn,"applyStacking");function Do(e){let t=0,n={},a={},r=e.filter(i=>i.type==="ability"&&!i.ignored),s=r.reduce((i,c)=>i===null||c.force?c:i.force?i:c.modifier>i.modifier?c:i,null);for(let i of r)i.ignored=i!==s;for(let i of e){if(i.ignored){i.enabled=!1;continue}if(i.type==="untyped"){i.enabled=!0,t+=i.modifier;continue}i.modifier<0?t+=cn(a,i,LOWER_PENALTY):t+=cn(n,i,HIGHER_BONUS)}return t}o(Do,"applyStackingRules");function To(e,t,n){return Array.from(new Set(t.flatMap(r=>e[r]??[]))).filter(r=>[n,null].includes(r.slug))}o(To,"extractModifierAdjustments");function Ao(e,t,n){let{modifierAdjustments:a,modifiers:r}=e,s=Array.from(new Set(t)).flatMap(i=>r[i]??[]).flatMap(i=>i(n)??[]);for(let i of s)i.adjustments=To(a,t,i.slug);return s}o(Ao,"extractModifiers");function ln(e){for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action$=shield-block]`;$(document).find(n).removeClass("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}o(ln,"toggleOffShieldBlock");function Oo(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}o(Oo,"htmlQuery");function fn(e,t,n){let a=o(()=>[e],"getTokens"),r=o(s=>s[0].actor.itemTypes.armor.filter(l=>l.isEquipped&&l.isShield).filter(l=>!l.isBroken),"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:$(n).find("div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let s=a();if(!s.length)return!1;let i=r(s),c=s.length===1&&i.length>1,l=t.classList.contains("shield-activated");return c&&!l?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(s,i,c)=>{let l=a(),u=r(l),f=l.length===1&&u.length>1,g=t.classList.contains("shield-activated");if(f&&!g){let h=c[0],d=Oo(h,"ul.shield-options");if(!d)return c;let m=[];for(let p of u){let v=document.createElement("input");v.classList.add("data"),v.type="radio",v.name="shield-id",v.value=p.id,v.addEventListener("click",()=>{t.dataset.shieldId=v.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,s.close()});let S=document.createElement("span");S.classList.add("label"),S.innerHTML=p.name;let T=document.createElement("span");T.classList.add("tag");let A=game.i18n.localize("PF2E.HardnessLabel");T.innerHTML=`${A}: ${p.hardness}`;let U=document.createElement("li");U.classList.add("item"),U.append(v,S,T),m.push(U)}d.replaceChildren(...m)}return c}}).tooltipster("open")}o(fn,"onClickShieldBlock");var Mo=O("preCreateChatMessage",Ro),xo=O("renderChatMessage",$o);function dn(){return{settings:[{name:"target",type:Boolean,default:!1,onChange:un}],conflicts:[],init:()=>{b("target")&&un(!0)}}}o(dn,"registerTargetTokenHelper");function un(e){Mo(e),ue()&&xo(e)}o(un,"setup");function Ro(e){if(!e.isDamageRoll)return;let t=game.user.targets;t.size<1||wt(e,"target.targets",Array.from(t.map(n=>({token:n.document.uuid,actor:n.actor.uuid}))))}o(Ro,"preCreateChatMessage");async function $o(e,t){let n=I(e,"target.targets")??[];if(!n.length)return;let a=t.find(".message-content"),r=a.find(".damage-application").clone();if(!r.length)return;r.removeClass("damage-application").addClass("target-damage-application"),r.find("button > *:not(.label)").remove();let s=$('<div class="target-helper"></div>');await Promise.all(n.map(async({token:i})=>{let c=await fromUuid(i);if(!c)return;s.append("<hr>"),s.append(`<div class="target-header" data-target-uuid="${i}">
    <span class="name">${c.name}</span>
    <span class="controls">
        <a data-action="ping-target" data-tooltip="COMBAT.PingCombatant">
            <i class="fa-solid fa-fw fa-signal-stream"></i>
        </a>
        <a data-action="open-target-sheet" data-tooltip="PF2E.Actor.Party.Sidebar.OpenSheet">
            <i class="icon fa-solid fa-file"></i>
        </a>
    </span>
</div>`);let l=r.clone();l.find("[data-action]").each(function(){let u=this.dataset.action;this.dataset.action=`target-${u}`}),l.each((u,f)=>{f.dataset.rollIndex=u,f.dataset.targetUuid=i}),s.append(l)})),a.after(s),s.find("button[data-action^=target-]").on("click",i=>Fo(i,e)),s.find("[data-action=ping-target]").on("click",Lo),s.find("[data-action=open-target-sheet]").on("click",Uo)}o($o,"renderChatMessage");async function mn(e){let{targetUuid:t}=e.currentTarget.closest("[data-target-uuid]").dataset;return fromUuid(t)}o(mn,"getTargetFromEvent");async function Uo(e){let t=await mn(e);t&&t.actor.sheet.render(!0)}o(Uo,"openTargetSheet");async function Lo(e){if(!canvas.ready)return;let t=await mn(e);t&&canvas.ping(t.center)}o(Lo,"pingTarget");async function Fo(e,t){let n=e.currentTarget,{rollIndex:a,targetUuid:r}=n.closest("[data-target-uuid]").dataset,s=await fromUuid(r);if(!s)return;let i=n.dataset.action;if(i==="target-shield-block"){fn(s,n,t.element);return}Le(s,{message:t,multiplier:i==="target-apply-healing"?-1:i==="target-half-damage"?.5:i==="target-apply-damage"?1:i==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:a})}o(Fo,"onTargetButton");var oe=null,N=null;function gn(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:pn}],conflicts:["pf2e-unided"],init:()=>{pn()}}}o(gn,"registerUnided");function pn(e){e??=b("unided"),e==="disabled"?(oe&&(Hooks.off("preCreateItem",oe),oe=null),N&&(Hooks.off("preUpdateItem",N),N=null)):(oe||(oe=Hooks.on("preCreateItem",_o)),e==="all"&&!N?N=Hooks.on("preUpdateItem",Ho):e!=="all"&&N&&(Hooks.off("preUpdateItem",N),N=null))}o(pn,"setHooks");function _o(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}o(_o,"preCreateItem");function Ho(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}o(Ho,"preUpdateItem");var W=k("macros.condition");async function hn(e){let t=o((f,g)=>{let h=f.find("[name=condition]"),{name:d,slug:m,img:p}=h.find(":selected").data();return{type:g,slug:m,img:p,name:f.find("[name=name]").val().trim()||W("effect-name",{condition:d}),uuid:h.val(),badge:Number(f.find("[name=badge]").val()||1),unidentified:f.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:W("generate"),callback:f=>t(f,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:W("add"),callback:f=>t(f,"add")}},a=Array.from(game.pf2e.ConditionManager.conditions.values()),r=new Set(a.filter(f=>!!f.badge).map(f=>f.slug)),s=await renderTemplate(w("macros/condition"),{i18n:W,conditions:Array.from(new Set(a.sort((f,g)=>f.name.localeCompare(g.name))))}),i=o(f=>{let{name:g,slug:h}=f.find("[name=condition] :selected").data();f.find("[name=name]").prop("placeholder",W("effect-name",{condition:g}));let d=r.has(h),m=f.find("[name=badge]");m.prop("disabled",!d),d||m.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:s,title:W("title"),close:()=>null,render:f=>{i(f),f.find("[name=condition]").on("change",()=>i(f))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&r.has(c.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let u={name:c.name,type:"effect",img:c.img,system:{rules:[l],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(u):await e.createEmbeddedDocuments("Item",[u])}o(hn,"permaConditionEffect");var _e=[Ge(),Ht(),Ze(),Pt(),gn(),Mt(),qe(),sn(),Xt(),st(),Ft(),Nt(),dn()],yn=new Set,He=null;Hooks.once("init",()=>{let e=ue(),t=_e.flatMap(({settings:s=[]})=>s.map(i=>{let c=i.name;return i.choices&&(i.choices=i.choices.reduce((l,u)=>(l[u]=Fe(c,`choices.${u}`),l),{})),i.key=c,i.scope??="world",i.config??=!0,i.name=Fe(c,"name"),i.hint=Fe(c,"hint"),i})),[n,a]=["world","client"].map(s=>t.filter(i=>i.scope===s));[n,a].forEach(s=>s.forEach(i=>game.settings.register(y,i.key,i))),e&&(He=a[0].key,Hooks.on("renderSettingsConfig",No));let r=game.modules.get(y);r.api={macros:{permaConditionEffect:hn}},_e.forEach(s=>{let{init:i,conflicts:c=[],api:l,name:u}=s;if(e)for(let f of c){let g=game.modules.get(f);g?.active&&(s.conflicting=!0,yn.add(g.title))}l&&u&&(r.api[u]=l),!s.conflicting&&i&&i(e)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of _e)!t&&n&&n(e);if(e)for(let t of yn)D("module-conflict",{name:t},!0)});function Fe(e,t){return`${y}.settings.${e}.${t}`}o(Fe,"settingPath");function No(e,t){if(!He)return;t.find(`.tab[data-tab=${y}] [data-setting-id="${y}.${He}"]`).before(`<h3>${P("settings.client")}</h3>`)}o(No,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
