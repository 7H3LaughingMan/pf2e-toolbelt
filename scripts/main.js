(()=>{var ln=Object.defineProperty;var r=(e,t)=>ln(e,"name",{value:t,configurable:!0});var p="pf2e-toolbelt";function x(e,t,n="WRAPPER"){return libWrapper.register(p,e,t,n)}r(x,"registerWrapper");function k(...e){let[t,n]=e;return t=`${p}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}r(k,"localize");function fn(e){return game.i18n.has(`${p}.${e}`,!1)}r(fn,"hasLocalization");function un(e){return`${p}.${e}`}r(un,"localizePath");function v(e){let t=r((...n)=>k(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>w(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>G(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>H(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>fn(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>un(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:o})=>t(n,o),enumerable:!1,configurable:!1}}),t}r(v,"subLocalize");function he(e,t,n,o){let i=typeof t=="string"?t:"info",s=typeof t=="object"?t:typeof n=="object"?n:void 0,c=typeof t=="boolean"?t:typeof n=="boolean"?n:o??!1;ui.notifications.notify(k(e,s),i,{permanent:c})}r(he,"notify");function w(...e){let[t,n,o]=e;he(t,"warning",n,o)}r(w,"warn");function G(...e){let[t,n,o]=e;he(t,"info",n,o)}r(G,"info");function H(...e){let[t,n,o]=e;he(t,"error",n,o)}r(H,"error");function y(e){return game.settings.get(p,e)}r(y,"getSetting");function Me(e,t){return game.settings.set(p,e,t)}r(Me,"setSetting");var dn="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",mn="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",pn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",gn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",hn=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function Re(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{y("arp")&&(x(dn,yn,"WRAPPER"),x(mn,Cn,"WRAPPER"),x(pn,kn,"WRAPPER"),x(gn,In,"WRAPPER"))},ready:e=>{e&&y("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),G("arp.forceVariant"))}}}r(Re,"registerArp");function ne(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}r(ne,"isValidActor");function Ue(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!hn.includes(e.sourceId)}r(Ue,"isValidWeapon");function yn(e){let t=this.actor;if(!ne(t,!0)||!Ue(this))return e();let n=t.level,o=this._source.system.traits.value;if(o.includes("alchemical")&&o.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}r(yn,"onPrepareWeaponData");var bn={1:35,2:935,3:8935,4:8935},vn={striking:65,greaterStriking:1065,majorStriking:31065};function Cn(e){if(e(),!ne(this.actor)||this.isSpecific||!Ue(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=bn[n]);let o=this.system.strikingRune.value;o&&(t-=vn[o]);let i=new game.pf2e.Coins({gp:t});(n||o)&&!this.system.runes.property.length&&(i=i.add(this._source.system.price.value)),this.system.price.value=new game.pf2e.Coins(i)}r(Cn,"onPrepareWeaponDerivedData");function $e(e){return!e.isShield}r($e,"isValidArmor");function kn(e){let t=this.actor;if(!ne(t,!0)||!$e(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}r(kn,"onPrepareArmorData");var wn={1:160,2:1060,3:20560,4:20560},Sn={resilient:340,greaterResilient:3440,majorResilient:49440};function In(e){if(e(),!ne(this.actor)||this.isSpecific||!$e(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=wn[n]);let o=this.system.resiliencyRune.value;o&&(t-=Sn[o]);let i=new game.pf2e.Coins({gp:t});(n||o)&&!this.system.runes.property.length&&(i=i.add(this._source.system.price.value)),this.system.price.value=new game.pf2e.Coins(i)}r(In,"onPrepareArmorDerivedData");function A(e,t,n=()=>{}){let o=null;return function(i,s=[],c=!1){typeof s=="string"&&(s=[s]),i||=s.some(a=>y(a)),i&&!o?o=Hooks.on(e,t):!i&&o&&(Hooks.off(e,o),o=null),c||n(i)}}r(A,"createHook");function oe(e,t,n=()=>{}){let o=null;return function(i,s=!1){i==="disabled"&&o?(Hooks.off(e,o),o=null):i!=="disabled"&&!o&&(o=Hooks.on(e,t)),s||n(i)}}r(oe,"createChoicesHook");function _e(e,t){let n=Hooks.on(e,t),o=Hooks.events[e].findIndex(i=>i.id===n);if(o!==0){let[i]=Hooks.events[e].splice(o,1);Hooks.events[e].unshift(i)}return n}r(_e,"registerUpstreamHook");var ye=A("renderEffectsPanel",En,Pn);function Le(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>ye(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>ye(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{ye(!1,["effect-remove","condition-sheet"])}}}r(Le,"registerEffectsPanelHelper");function Pn(){game.pf2e.effectPanel?.render()}r(Pn,"refreshEffectsPanel");function En(e,t){let n=`<div>${k("effects.remove")}</div>`,o='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',i=t.find(".effect-item[data-item-id]").toArray();for(let s of i){let c=s.dataset.itemId,a=e.actor?.items.get(c);if(a&&(y("effect-remove")&&!a.isLocked&&a.badge&&a.badge.type==="counter"&&(s.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),s.querySelector(".icon").addEventListener("contextmenu",l=>Dn(l,e),!0)),y("condition-sheet")&&a.isOfType("condition"))){let l=s.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",o),l.querySelector('[data-action="edit"]').addEventListener("click",d=>An(d,e))}}}r(En,"renderEffectsPanel");function An(e,t){let n=He(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}r(An,"onConditionSheet");function Dn(e,t){if(!e.shiftKey)return;let n=He(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}r(Dn,"onRemoveEffect");function He(e,t){let i=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(i)}r(He,"getEffect");var B=class extends FormApplication{constructor(t,n,o){super(t,n),this.onSubmitCallback=o}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};r(B,"MoveLootPopup");function D(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}r(D,"isPlayedActor");function be(){return CONFIG.ChatMessage.documentClass}r(be,"getChatMessageClass");function*W(e,t){let n=game.messages.contents,o=(t?n.findLastIndex(i=>i===t):n.length)-1;for(let i=o;i>=o-e;i--){let s=n[i];if(!s)return;yield s}}r(W,"latestChatMessages");function R(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}r(R,"chatUUID");function re(e){game.socket.on(`module.${p}`,e)}r(re,"socketOn");function ie(e){game.socket.off(`module.${p}`,e)}r(ie,"socketOff");function M(e){game.socket.emit(`module.${p}`,e)}r(M,"socketEmit");function se(){return game.user===game.users.activeGM}r(se,"isActiveGM");function Fe(){return game.users.some(e=>e.active&&e.isGM)}r(Fe,"isGMOnline");function Ne(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}r(Ne,"getCharacterOwner");function Tn(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,o)=>n.id>o.id?1:-1),t[0]||null}r(Tn,"getActiveOwner");function ve(e){return Tn(e)===game.user}r(ve,"isActiveOwner");function Ge(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}r(Ge,"getOwner");var ae=!1,q=null;function We(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:ze}],conflicts:["pf2e-giveth"],ready:e=>{y("giveth")!=="disabled"&&ze(!0)}}}r(We,"registerGiveth");function ze(e){let t=game.user.isGM;e==="disabled"&&ae?(t?ie(je):q&&(Hooks.off("dropCanvasData",q),q=null),ae=!1):e!=="disabled"&&!ae&&(t?re(je):q||(q=_e("dropCanvasData",On)),ae=!0)}r(ze,"setup");function je(e){se()&&(e.type==="giveth-condition"?Rn(e):e.type==="giveth-effect"?Un(e):$n(e))}r(je,"onSocket");function On(e,t){if(!Fe())return!0;let n=Mn(t);if(!n)return!0;let o=e.tokens.placeables.slice().filter(i=>{if(!i.document.actorLink)return!1;let s=i.actor;if(!qe(s,t.actorId)||s.isOwner)return!1;let c=i.x+(i.hitArea?.right??0),a=i.y+(i.hitArea?.bottom??0);return t.x>=i.x&&t.y>=i.y&&t.x<=c&&t.y<=a}).sort((i,s)=>s.document.sort-i.document.sort).at(0)?.actor;return o?(xn(n.actor,o,n.item,n.value),!1):!0}r(On,"onDropCanvasData");function xn(e,t,n,o){let i=e.id,s=t.id,c=!(n instanceof Item);if(!c&&n.isOfType("physical")){let a=n.quantity;if(a<1)return w("giveth.notification.zero");if(a===1)return Be(i,s,n.id,1,!1);new B(e,{maxQuantity:a,lockStack:!1,isPurchase:!1},(l,d)=>{Be(i,s,n.id,l,d)}).render(!0)}else{let a=c?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?M({type:"giveth-condition",targetId:s,value:o??1,uuid:a}):M({type:"giveth-effect",targetId:s,uuid:a})}}r(xn,"giveth");function Be(e,t,n,o,i){M({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:o,stack:i})}r(Be,"sendPhysicalRequest");function qe(e,t){return!D(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}r(qe,"isValidActor");function Mn(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let i=e.context?.origin.actor;n=i?fromUuidSync(i):null}if(!qe(n)||!n.isOwner)return;let o=!(t instanceof Item);if(o&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!o&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}r(Mn,"getDetailsFromData");async function Rn({targetId:e,uuid:t,value:n}){let o=game.actors.get(e);if(!o)return;let i=await fromUuid(t);i&&o.increaseCondition(i.slug,{min:n})}r(Rn,"takethCondition");async function Un({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let o=await fromUuid(t);if(!o)return;let i=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[i])}r(Un,"takethEffect");async function $n({itemId:e,ownerId:t,qty:n,stack:o,targetId:i}){let s=game.actors.get(t),c=game.actors.get(i);if(!s||!c)return;let a=s.items.get(e);if(!a)return;n=Math.min(n,a.quantity);let l=a.quantity-n,d=a.toObject();d.system.quantity=n,d.system.equipped.carryType="worn",a.isOfType("physical")&&"invested"in d.system.equipped&&(d.system.equipped.invested=a.traits.has("invested")?!1:null);let f=await c.addToInventory(d,void 0,o);if(!f||(l<1?a.delete():a.update({"system.quantity":l}),y("giveth")==="no-message"))return;let b=R(f.uuid,f.name,!f.isIdentified);n>1&&(b+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${k("giveth.giveth",{target:c.name})}</h4>`,content:b,speaker:ChatMessage.getSpeaker({actor:s})})}r($n,"takethPhysical");function C(...e){return e=e.filter(t=>typeof t=="string"),`modules/${p}/templates/${e.join("/")}.hbs`}r(C,"templatePath");var z=v("hero.templates.trade"),V=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:z("title"),template:C("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){z.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:T(this.actor),targetActions:this.target?T(this.target):[],i18n:z})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){z.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){z.warn("no-select");return}let o=Ne(this.target,!0)??Ge(this.target,!0)??game.users.activeGM;if(!o){z.warn("no-user");return}Ve({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:o.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};r(V,"Trade");function ce(e,t){return e.localeCompare(t,game.i18n.lang)}r(ce,"localeCompare");function F(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}r(F,"refreshCharacterSheets");function Ye(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let o of e){let i=n.findIndex(s=>o===s);if(i===-1)return!1;n.splice(i,1)}return!0}r(Ye,"compareArrays");function Ke(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}r(Ke,"ordinalString");function Qe(e,t){if(typeof e!="object")return!1;for(;e=Reflect.getPrototypeOf(e);)if(e.constructor.name===t)return!0;return!1}r(Qe,"isInstanceOf");var le="pf2e-hero-actions",Je=null,Xe=A("renderCharacterSheetPF2e",Fn,Hn),_n="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",fe="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",Ln="systems/pf2e/icons/features/feats/heroic-recovery.webp";function et(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>Xe(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>F()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[le],api:{createTable:Xn,removeHeroActions:oo,getHeroActions:T,useHeroAction:it,getHeroActionDetails:ue,drawHeroAction:rt,drawHeroActions:nt,sendActionToChat:ft,discardHeroActions:st,tradeHeroAction:ot,getDeckTable:we,giveHeroActions:so,createChatMessage:de},ready:()=>{Xe(!1,"hero")}}}r(et,"registerHeroActions");function Hn(e){e&&!Je?re(Ze):!e&&Je&&ie(Ze)}r(Hn,"setupSocket");function Ze(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;pt(e);break;case"trade-accept":if(!se())return;dt(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;Qn(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;mt(e.error);break}}r(Ze,"onSocket");async function Fn(e,t){let n=e.actor;D(n)&&(await Nn(t,n),Gn(t,n))}r(Fn,"renderCharacterSheetPF2e");async function Nn(e,t){let n=T(t),o=t.heroPoints.value-n.length,i=t.isOwner,s=v("hero.templates.heroActions"),c=await renderTemplate(C("hero/sheet"),{owner:i,list:n,canUse:o>=0&&i,canDraw:o>0&&i,canTrade:y("hero-trade"),mustDiscard:o<0,diff:Math.abs(o),i18n:(a,{hash:l})=>s(a,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(c)}r(Nn,"addActionsToSheet");function Gn(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",o=>qn(t,o)),n.find("[data-action=expand]").on("click",tt),n.find("[data-action=use]").on("click",o=>Wn(t,o)),n.find("[data-action=display]").on("click",o=>Bn(t,o)),n.find("[data-action=discard]").on("click",jn),n.find("[data-action=discard-selected]").on("click",()=>zn(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>ot(t))}r(Gn,"addSheetEvents");async function zn(e,t){let o=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(i=>i.dataset.uuid);st(e,o)}r(zn,"onClickHeroActionsDiscard");function jn(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let o=Number(n.attr("data-discard")??"0"),i=n.find(".action.discarded");n.toggleClass("discardable",i.length===o)}r(jn,"onClickHeroActionDiscard");async function Bn(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");ft(e,n)}r(Bn,"onClickHeroActionDisplay");async function Wn(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");it(e,n)}r(Wn,"onClickHeroActionUse");async function qn(e,t){t.preventDefault(),nt(e)}r(qn,"onClickHeroActionsDraw");function T(e){return getProperty(e,`flags.${le}.heroActions`)??[]}r(T,"getHeroActions");async function N(e,t){return e.update({[`flags.${le}.heroActions`]:t})}r(N,"setHeroActions");async function tt(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let o=t.attr("data-uuid"),i=await ue(o);if(!i)return;let s=await TextEditor.enrichHTML(i.description,{async:!0});n.find(".item-description").html(s),n.addClass("loaded")}t.toggleClass("expanded")}r(tt,"onClickHeroActionExpand");async function ue(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,o=t instanceof JournalEntry?t.pages.contents[0]:t,i=o?.text.content;if(i)return n.uuid===_n&&(i=i.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:o.name,description:i}}r(ue,"getHeroActionDetails");async function nt(e){if(!e?.isOfType("character")){w("hero.onlyCharacter");return}let t=T(e),n=e.heroPoints.value-t.length,o=[];for(let i=0;i<n;i++){let s=await rt();if(s!==void 0){if(s===null)return;t.push(s),o.push(s)}}o.length&&(N(e,t),de({actor:e,actions:o,label:i=>k("hero.actions-draw.header",{nb:i}),secret:!0}))}r(nt,"drawHeroActions");function de({actor:e,actions:t,label:n,secret:o=!1}){let{content:i,size:s}=Vn(t);n=typeof n=="function"?n(s):n;let c={flavor:`<h4 class="action">${n}</h4>`,content:i,speaker:ChatMessage.getSpeaker({actor:e})};o&&y("hero-private")&&(c.type=CONST.CHAT_MESSAGE_TYPES.ROLL,c.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(c)}r(de,"createChatMessage");function Vn(e){let t=e.map(({uuid:n,name:o})=>R(n,o));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}r(Vn,"chatActions");function ot(e){if(!e?.isOfType("character")){w("hero.onlyCharacter");return}let t=T(e);if(!t||!t.length){w("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){w("hero.no-points",{nb:n.toString()});return}new V(e).render(!0)}r(ot,"tradeHeroAction");async function rt(){let e=await we(),t=v("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(s=>!s.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let o=gt(n);if(o)return{uuid:o,name:await at(n,o)}}r(rt,"drawHeroAction");async function it(e,t){if(!e?.isOfType("character")){w("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return w("hero.use.noPoints");let o=T(e),i=o.findIndex(c=>c.uuid===t);if(i===-1)return;let s=await ue(t);s||H("hero.use.noDetails"),o.splice(i,1),s?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${le}.heroActions`]:o}),ChatMessage.create({flavor:`<h4 class="action">${k("hero.actions-use.header")}</h4>`,content:`<h2>${s.name}</h2>${s.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):N(e,o)}r(it,"useHeroAction");async function st(e,t){if(!e?.isOfType("character")){w("hero.onlyCharacter");return}t=typeof t=="string"?[t]:t;let n=T(e),o=[];for(let i of t){let s=n.findIndex(c=>c.uuid===i);s!==-1&&(o.push(n[s]),n.splice(s,1))}N(e,n),de({actor:e,actions:o,label:i=>k("hero.actions-discard.header",{nb:i})})}r(st,"discardHeroActions");async function at(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}r(at,"getLabelfromTableResult");async function ct(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}r(ct,"getTableFromUuid");async function Yn(){return ct(fe)}r(Yn,"getDefaultCompendiumTable");function lt(){return game.tables.find(e=>e.getFlag("core","sourceId")===fe)}r(lt,"getDefaultWorldTable");async function Kn(){return ct(y("hero-table"))}r(Kn,"getCustomTable");async function we(){return await Kn()??lt()??await Yn()}r(we,"getDeckTable");async function ft(e,t){let n=await ue(t);if(!n)return H("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}r(ft,"sendActionToChat");function Ve(e){if(e.receiver.id===game.user.id){ut(e);return}M({...e,type:"trade-request"})}r(Ve,"sendTradeRequest");function ut(e){if(game.user.isGM){dt(e);return}M({...e,type:"trade-accept"})}r(ut,"acceptRequest");async function dt(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!o||!i){Ce(e);return}let s=T(o),c=T(i),a=s.findIndex(g=>g.uuid===t.uuid),l=c.findIndex(g=>g.uuid===n.uuid);if(a===-1||l===-1){Ce(e);return}let d=s.splice(a,1)[0],f=c.splice(l,1)[0];s.push(f),c.push(d),N(o,s),N(i,c);let b=R(d.uuid),h=R(f.uuid),u=v("hero.trade-success"),m=`<div style="line-height: 1.6">${u("offer",{offer:b})}</div>`;m+=`<div style="line-height: 1.6">${u("receive",{receive:h})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${u("header",{name:i.name})}</h4>`,content:m,speaker:ChatMessage.getSpeaker({actor:o})})}r(dt,"onTradeAccepted");function Ce({sender:e,receiver:t},n="trade-error"){let o=new Set([e.id,t.id]);o.has(game.user.id)&&(o.delete(game.user.id),mt(n)),o.size&&M({type:"trade-error",users:Array.from(o),error:n})}r(Ce,"sendTradeError");function mt(e){H("hero.trade-error")}r(mt,"onTradeError");async function Qn(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!o||!i){Ce(e);return}let s=v("hero.trade-request"),c=`<p>${s("header",{sender:o.name,receiver:i.name})}</p>`;c+=`<p>${s("give",{give:R(t.uuid)})}</p>`,c+=`<p>${s("want",{want:R(n.uuid)})}</p>`,c+=`<p style="margin-bottom: 1em;">${s("accept")}</p>`,await Dialog.confirm({title:s("title"),content:await TextEditor.enrichHTML(c,{async:!0})})?ut(e):Jn(e)}r(Qn,"onTradeRequest");function Jn(e){if(e.sender.id===game.user.id){pt(e);return}M({...e,type:"trade-reject"})}r(Jn,"rejectRequest");async function pt({receiver:e}){let t=game.actors.get(e.cid);w("hero.trade-rejected",{name:t.name},!0)}r(pt,"onTradeRejected");async function Xn(){if(!game.user.isGM){w("hero.notGM");return}let e=v("hero.templates.createTable.choice"),t=C("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:s=>{let c=s.find('.window-content input[name="type"]:checked').val(),a=s.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:c,unique:a}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},i=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-create-table"});i&&(i.type==="default"?to(i.unique):Zn(i.unique))}r(Xn,"createTable");async function Zn(e){let t=await eo(e);await ke(t),t.sheet?.render(!0)}r(Zn,"createCustomTable");function eo(e=!0){let t=Se(e);return RollTable.create(t,{temporary:!1})}r(eo,"createCustomActionsTable");async function to(e){let t=v("templates.createTable.default.confirm"),n=await lt();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let i=Se(e);return await n.update(i),ke(n,!0)}n=await no(e),await ke(n)}r(to,"createDefaultTable");async function no(e=!0){let t=await fromUuid(fe),n=Se(e,t);return RollTable.create(n,{temporary:!1})}r(no,"createDefautActionsTable");async function ke(e,t=!1){t&&await e.normalize(),await Me("hero-table",e.uuid)}r(ke,"setTable");function Se(e=!0,t){let n={name:k("hero.table.name"),replacement:!e,img:Ln,description:k("hero.table.description"),flags:{core:{sourceId:fe}}};return t?mergeObject(deepClone(t._source),n):n}r(Se,"getTableSource");async function oo(){if(!game.user.isGM){w("hero.notGM");return}let e=v("hero.templates.removeActions"),t=C("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:s=>s.find('input[name="actor"]:checked').toArray().map(c=>game.actors.get(c.value)).filter(c=>c)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{actors:game.actors.filter(s=>s.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:s=>{s.on("change",'input[name="all"]',()=>ro(s)),s.on("change",'input[name="actor"]',()=>io(s))},close:()=>null},i=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-remove-actions"});if(i){if(!i.length){e.warn("noSelection");return}for(let s of i)N(s,[]);e.info("removed")}}r(oo,"removeHeroActions");function ro(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}r(ro,"removeActionsToggleAll");function io(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),o=e.find('input[name="all"]');t.length===n.length?(o.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?o.prop("checked",!1).prop("indeterminate",!0):(o.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}r(io,"removeActionsToggleActor");function gt(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}r(gt,"documentUuidFromTableResult");async function so(e){if(!game.user.isGM){w("hero.notGM");return}let t=v("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await we();if(!n)return H("hero.table.drawError",!0),null;let o=n.replacement===!1,i=(await Promise.all(n.results.map(async g=>{let P=gt(g);if(P)return{key:g.id,uuid:P,name:await at(g,P),drawn:g.drawn}}))).filter(Boolean),s=C("hero/dialogs/give-action"),c=await renderTemplate(s,{actions:i,isUnique:o,i18n:t}),a={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:g=>({selected:g.find("[name=action]:checked").closest(".action").toArray().map(P=>P.dataset),asDrawn:g.find("[name=drawn]").prop("checked")??!1,withMessage:g.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:c,buttons:a,render:g=>{g.find("[data-action=expand]").on("click",tt)},close:()=>null},d=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!d)return;let{selected:f,asDrawn:b,withMessage:h}=d,u=T(e),m=[];for(let{uuid:g,name:P,key:I}of f){if(u.push({uuid:g,name:P}),!b)continue;let O=n.results.get(I);O&&!O.drawn&&m.push(I)}m.length&&await n.updateEmbeddedDocuments("TableResult",m.map(g=>({_id:g,drawn:!0}))),N(e,u),h&&de({actor:e,actions:f,label:g=>k("hero.actions-give.header",{nb:g}),secret:!0})}r(so,"giveHeroActions");function S(e,t,n){return e.getFlag(p,t)??n}r(S,"getFlag");function Y(e,t,n){return e.setFlag(p,t,n)}r(Y,"setFlag");function ht(e,t){return e.unsetFlag(p,t)}r(ht,"unsetFlag");var yt=v("knowledges.editLore"),K=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return yt("title",this.actor)}get template(){return C("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:S(n,"unspecified")??"",specific:S(n,"specific")??"",i18n:yt})}async _updateObject(t,{unspecified:n,specific:o}){let i=this.object;Y(i,"unspecified",n.trim()),Y(i,"specific",o.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};r(K,"EditLores");var bt=A("renderNPCSheetPF2e",ao);function vt(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>bt(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&y("knowledges")&&bt(!0)}}}r(vt,"registerKnowledges");function ao(e,t){let n=e.actor;D(n)&&(lo(n,t),uo(t),fo(n,t))}r(ao,"renderNPCSheetPF2e");function Ie(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}r(Ie,"knowledgeSelector");function co(e){new K(e).render(!0)}r(co,"editLores");function lo(e,t){let n=S(e,"unspecified"),o=S(e,"specific");if(!n&&!o)return;let i=e.identificationDCs.lore,s=Ie(t,"body","");s.find(".identification-skills").last().remove();function c(l,d,f){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:d,adjustment:f})}</div>`}r(c,"tag");function a(l,{dc:d,start:f}){let b=l.split(",").filter(h=>h.trim()).map(h=>c(h,d,f)).join("");s.append(b)}r(a,"addTags"),a(n||"Unspecific",i[0]),a(o||"Specific",i[1])}r(lo,"replaceLores");function fo(e,t){Ie(t,"header","button.edit").on("click",()=>co(e))}r(fo,"addEvents");function uo(e){let t=Ie(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}r(uo,"addEditButton");var Pe=v("merge.multi"),Q=class extends Application{constructor(t,n,o){super(o),this._event=t,this._spell=n}get spell(){return this._spell}get title(){return Pe("title",this.spell)}get template(){return C("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:Pe})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){Pe.error("zero"),this.close();return}let o=this.spell,i=deepClone(o._source.system.damage),s=deepClone(o._source.system.heightening)??{};for(let[a,l]of Object.entries(i))for(let d=0;d<n-1;d++){let f=randomID();if(i[f]=l,s.type==="interval"){let b=s.damage[a];b&&(s.damage[f]=b)}else if(s.type==="fixed")for(let[b,h]of Object.entries(s.levels)){let u=h.damage.value[a];u&&(s.levels[b].damage.value[f]=u)}}o.clone({"system.damage":i,"system.heightening":s}).rollDamage(this._event),this.close()}#t(t){t.preventDefault(),this.close()}};r(Q,"MultiCast");var mo=/(\[[\w,]+\])/,Ee=A("renderChatMessage",Pt,po);function It(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>Ee(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>Ee(e,"merge-damage")}],init:e=>{Ee(!1,["multi-cast","merge-damage"],!0)}}}r(It,"registerMerge");function po(){let e=ui.chat?.element;if(e)for(let t of W(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),Pt(t,n))}}r(po,"updateMessages");function Pt(e,t){!game.user.isGM&&!e.isAuthor||(y("merge-damage")&&Dt(e)?ho(e,t):y("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&go(e,t))}r(Pt,"renderChatMessage");function go(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let o=t.find(".message-content .chat-card .owner-buttons .spell-button");o.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${k("merge.spell.button")}</button>`),o.find("[data-action=multi-cast]").on("click",async i=>{let s=await fromUuid(n);s&&new Q(i,s).render(!0)})}r(go,"renderSpell");function ho(e,t){let n='<span class="pf2e-toolbelt-merge">';if(S(e,"merged")){let c=k("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${c}">`,n+='<i class="fa-duotone fa-split"></i>'}let o=k("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${o}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let i=wt(e),s=St(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",c=>{c.stopPropagation();for(let a of W(5,e))if(!(!Dt(a)||wt(a)!==i||St(a)!==s)){bo(c,e,a,{actorUUID:i,targetUUID:s});return}w("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",c=>{c.stopPropagation(),yo(c,e)})}r(ho,"renderDamage");async function yo(e,t){let n=S(t,"data").flatMap(o=>o.source);await Et(t.id),await be().createDocuments(n)}r(yo,"splitDamages");async function bo(e,t,n,{actorUUID:o,targetUUID:i}){let s={},c=Ct(n).concat(Ct(t));for(let{name:u,notes:m,outcome:g,modifiers:P,tags:I}of c)s[u]??={name:u,tags:I,notes:new Set,results:[]},m.forEach(s[u].notes.add,s[u].notes),s[u].results.some(E=>E.outcome===g&&Ye(E.modifiers,P))||s[u].results.push({outcome:g,modifiers:P});let a=Object.values(s).map(u=>(u.label=u.name,u.results.forEach(m=>{m.outcome&&(m.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${m.outcome}`))}),u));a.at(-1).isLastGroup=!0;let l=await renderTemplate(C("merge/merged"),{groups:a,hasMultipleGroups:a.length>1}),d=kt(t),f=kt(n),b=[];for(let u of[].concat(f,d)){let{options:m,total:g,terms:P}=u,I=P[0],O=u.formula.replace(mo,""),E=b.find(({options:{flavor:ee,critRule:te}})=>ee===m.flavor&&te===m.critRule);E?(E.terms.push(I),E.total+=g,E.formulas.push(O)):b.push({options:m,formulas:[O],total:g,terms:[I]})}for(let u of b)u.formula=`(${u.formulas.join(" + ")})[${u.options.flavor}]`,u.term=u.terms.length<2?u.terms[0]:At(u.terms);let h={class:"DamageRoll",options:{},dice:[],formula:`{${b.map(({formula:u})=>u).join(", ")}}`,total:b.reduce((u,{total:m})=>u+m,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:b.map(({formula:u})=>u),modifiers:[],rolls:b.map(({options:u,formula:m,total:g,term:P})=>({class:"DamageInstance",options:u,dice:[],formula:m,total:g,terms:[P],evaluated:!0})),results:b.map(({total:u})=>({result:u,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let u=r(m=>{"results"in m?m.results.forEach(g=>g.hidden=!0):(m.term??m).operands?.forEach(g=>u(g))},"setHidden");h.terms[0].rolls.forEach(m=>m.terms.forEach(g=>u(g)))}await Et(t.id,n.id),await be().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[p]:{actor:o,target:i,merged:!0,type:"damage-roll",data:c},pf2e:{context:{options:Array.from(new Set(c.flatMap(u=>u.itemTraits)))}}},rolls:[h]})}r(bo,"mergeDamages");function Ct(e){let t=S(e,"data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let o=$(`<div>${e.flavor}</div>`),i=o.find("h4.action + .tags").prop("outerHTML"),s=[];o.find(".tag.tag_transparent").each(function(){s.push(this.innerHTML)});let c=n.flags.pf2e.context.notes.map(({title:a,text:l})=>`<strong>${game.i18n.localize(a)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(a=>a.startsWith("item:")),modifiers:s,tags:i,notes:c}]}r(Ct,"getMessageData");function Et(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}r(Et,"removeChatMessages");function At(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?At(e):e[0]]}}}r(At,"createTermGroup");function kt(e){return S(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}r(kt,"getMessageRolls");function wt(e){return S(e,"actor")??e.actor?.uuid}r(wt,"getActorUUID");function St(e){return S(e,"target")??e.target?.actor.uuid}r(St,"getTargetUUID");function Dt(e){return S(e,"type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}r(Dt,"isDamageRoll");var Tt=oe("renderChatMessage",xt,vo);function Ot(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>Tt(e)}],init:e=>{!e&&y("modifiers")!=="disabled"&&Tt(!0,!0)}}}r(Ot,"registerHideModifiers");function vo(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of W(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),xt(t,n))}}r(vo,"updateMessages");function xt(e,t){let n=e.speaker,o=ChatMessage.getSpeakerActor(n);if(!o||o.hasPlayerOwner)return;let i=t.find(".message-header");y("modifiers")==="traits"&&i.addClass("pf2e-toolbelt-modifiers-traits"),y("modifiers")!=="disabled"&&i.addClass("pf2e-toolbelt-modifiers")}r(xt,"renderChatMessage");var Co="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",ko="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function Mt(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{y("nobulk")&&x(Co,So,"WRAPPER"),y("nobulk-coins")&&x(ko,wo,"WRAPPER")}}}r(Mt,"registerNobulk");function wo(e){e(),this.isCoinage&&(this.system.bulk.value=0)}r(wo,"treasurePrepareBaseData");function So(e,...t){e(...t);let n=this,o=n.inventory.bulk.constructor,i=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return i||(i=o.computeTotalBulk(this.actor.inventory.filter(s=>!s.isInContainer&&s.system.equipped.carryType!=="dropped"),this.actor.size),i)}})}r(So,"actorPrepareEmbeddedDocuments");var Io="CONFIG.Actor.documentClass.prototype.prepareData",Po="DocumentSheet.prototype._renderInner";function Rt(){return{settings:[{name:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{y("share")!=="disabled"&&(x(Io,xo,"WRAPPER"),x(Po,Eo,"WRAPPER"),Hooks.on("preUpdateActor",Do),Hooks.on("deleteActor",Ao),Hooks.on("updateActor",To))}}}r(Rt,"registerShare");async function Eo(e,...t){let n=await e(...t);if(!Qe(this,"CreatureConfig"))return n;let o=this.actor;if(!D(o)||!o.isOfType("character","npc")||J(o).size)return n;let i=game.actors.filter(c=>c.id!==o.id&&c.isOwner&&pe(c)).map(c=>({key:c.id,label:c.name})),s=await renderTemplate(C("share/master"),{masters:i,master:S(o,"share.master"),selectPath:`flags.${p}.share.master`,i18n:v("share.templates.master")});return n.children().last().before(s),n}r(Eo,"documentSheetRenderInner");function Ao(e){Ft(e);let t=J(e);Promise.all(t.map(async n=>{$t(n),await ht(n,"share.master")}))}r(Ao,"deleteActor");function Do(e,t){let n=getProperty(t,`flags.${p}.share`);if(n?.master){let o=game.actors.get(n.master);if(pe(o)){let i=deepClone(o._source.system.attributes.hp);setProperty(t,"system.attributes.hp",i)}}else{let o=me(e),i=getProperty(t,"system.attributes.hp");o&&i&&(o.update({system:{attributes:{hp:i}}},{noHook:!0}),delete t.system.attributes.hp)}}r(Do,"preUpdateActor");function To(e,t,n,o){let i=game.user.id===o,s=Ro(t);if(s?.master!==void 0){let a=e;if(Ft(a),s.master){let l=game.actors.get(s.master);pe(l)&&(Ut(a,l),Ht(l,a))}else $t(a)}if(!i)return;let c=J(e);if(c.size){let a=getProperty(t,"system.attributes.hp");if(a){let l={system:{attributes:{hp:a}}};Promise.all(c.map(async d=>await d.update(l,{noHook:!0})))}else Promise.all(c.map(async l=>await Oo(l,t)))}}r(To,"updateActor");async function Oo(e,t){y("share")==="force"?await Y(e,"toggle",!S(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}r(Oo,"refreshActor");function xo(e){e();let t=this,n=S(t,"share.master"),o=n?game.actors.get(n):void 0;if(!pe(o))return;me(this)||(Ut(this,o),Ht(o,this));let i=this.system.attributes.hp;Object.defineProperty(t.system.attributes,"hp",{get(){let s=o.system.attributes.hp;return Mo(s,i),i},enumerable:!0})}r(xo,"prepareData");function Mo(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}r(Mo,"transfertHpData");function Ro(e){return getProperty(e,`flags.${p}.share`)}r(Ro,"getShareFlag");function J(e){return _t(e,"slaves")??new Collection}r(J,"getSlaves");function Ut(e,t){Lt(e,"master",t)}r(Ut,"setMaster");function $t(e){Uo(e,"master")}r($t,"unsetMaster");function me(e){return _t(e,"master")}r(me,"getMaster");function pe(e){return e&&e.type==="character"&&!me(e)}r(pe,"isValidMaster");function _t(e,t){return getProperty(e,`modules.${p}.share.${t}`)}r(_t,"getModuleProperty");function Lt(e,t,n){setProperty(e,`modules.${p}.share.${t}`,n)}r(Lt,"setModuleProperty");function Uo(e,t){delete e.modules?.[p]?.share?.[t]}r(Uo,"deleteModuleProperty");function Ht(e,t){let n=J(e);Lt(e,"slaves",n.set(t.id,t))}r(Ht,"addSlaveToMaster");function Ft(e){let t=me(e);if(!t)return;J(t).delete(e.id)}r(Ft,"removeSlaveFromMaster");function Nt(e){return e.getFlag("core","sourceId")}r(Nt,"getSourceId");function $o(e,t){let n=Nt(e);return n?t.includes(n):!1}r($o,"includesSourceId");function Gt(e){return Array.isArray(e)?t=>$o(t,e):t=>Nt(t)===e}r(Gt,"getItemSourceIdCondition");function zt(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}r(zt,"getItems");function jt(e,t,n){return zt(e,n).some(Gt(t))}r(jt,"hasItemWithSourceId");function ge(e,t,n){return zt(e,n).find(Gt(t))}r(ge,"getItemWithSourceId");var _o=A("renderCharacterSheetPF2e",jo),Lo=A("deleteCombat",Wo),Ho=A("deleteCombatant",Qt),Fo=A("createCombatant",qo),No=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Go=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),zo=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function Wt(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:Bt},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:Ae,toggleStance:Kt,isValidStance:qt},ready:e=>{y("stances")&&Bt(!0)}}}r(Wt,"registerStances");function Bt(e){_o(e),Lo(e),Ho(e),Fo(e)}r(Bt,"setup");function qt(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}r(qt,"isValidStance");function Ae(e){let t=[],n=new Set;for(let{replace:o,sourceId:i,effectUUID:s,effect:c,img:a,name:l,itemName:d,action:f}of Vt(e)){o&&n.add(o);let b=f?ge(e,f,"action"):ge(e,i,"feat");t.push({name:l,itemName:d,uuid:i,img:a,effectUUID:s,effectID:c?.id,actionUUID:b.sourceId,actionID:b.id})}return t.filter(({uuid:o})=>!n.has(o))}r(Ae,"getStances");async function jo(e,t){let n=e.actor;if(!D(n))return;let o=Ae(n);if(!o.length)return;let i=n.getActiveTokens(!0,!0).some(l=>l.inCombat),s=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),c=s.find(".actions-options"),a=await renderTemplate(C("stances/sheet"),{stances:o,canUseStances:i&&!n.isDead,i18n:v("stances")});c.length?c.after(a):s.prepend(a),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>Bo(l,n))}r(jo,"renderCharacterSheetPF2e");function Bo(e,t){let n=e.currentTarget,o=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!o)return;let i=n.dataset.effectUuid;Kt(t,i)}r(Bo,"onToggleStance");function*Vt(e){for(let t of e.itemTypes.feat){let n=t.sourceId,o=Go.get(n),i=zo.get(n);if(!o&&!i&&!qt(t))continue;let s=o?.effect??i?.effect??t.system.selfEffect.uuid,c=fromUuidSync(s);c&&(yield{name:(o&&fromUuidSync(o.replace)?.name)??t.name,itemName:t.name,replace:o?.replace,extra:i,sourceId:n,effectUUID:s,effect:ge(e,s,"effect"),action:i?.action,img:c.img})}}r(Vt,"actorStances");function Yt(e){let t=[];for(let{effect:n}of Vt(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}r(Yt,"getStancesEffects");async function Kt(e,t){let n=Yt(e),o=n.findIndex(s=>s.uuid===t),i=!1;if(o===-1)i=!0;else{let s=n.filter(a=>a.uuid!==t).length,c=n.filter(a=>a.uuid===t).length>1;(s||c)&&n.splice(o,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(s=>s.id)),i&&De(e,t)}r(Kt,"toggleStance");async function De(e,t){let n=await fromUuid(t);if(n){let o=n.toObject();return getProperty(o,"flags.core.sourceId")||setProperty(o,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[o]))[0]?.toMessage(),!0}return!1}r(De,"addStance");function Wo(e){for(let t of e.combatants)Qt(t)}r(Wo,"deleteCombat");function Qt(e){let t=Jt(e);if(t){if(!game.user.isGM&&ve(t)){let n=Yt(t).map(o=>o.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}F(t)}}r(Qt,"deleteCombatant");function qo(e){let t=Jt(e);t&&(!game.user.isGM&&ve(t)&&Vo(t),F(t))}r(qo,"createCombatant");function Jt(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}r(Jt,"getActorFromCombatant");async function Vo(e){let t=Ae(e);if(!(!t.length||t.filter(({effectID:i})=>i).length||!jt(e,No,["feat"])))if(t.length===1){let i=t[0];await De(e,i.effectUUID)&&G("stances.useStance",{stance:i.name})}else Yo(e,t)}r(Vo,"checkForSavant");async function Yo(e,t){let n=v("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(C("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:o=>De(e,o.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}r(Yo,"openStancesMenu");var Xt=oe("renderCharacterSheetPF2e",Ko,()=>F());function Zt(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>Xt(e)}],conflicts:["pf2e-spells-summary"],init:e=>{y("summary")!=="disabled"&&Xt(!0,!0)}}}r(Zt,"registerSpellsSummary");async function Ko(e,t){let n=e.actor;if(!D(n))return;let o=X(t);getProperty(e,`modules.${p}.toggled`)&&o.addClass("toggled"),lr(t).on("click",i=>cr(i,t,e)),await Qo(t,e,n),o.hasClass("toggled")&&o.hasClass("active")&&e._restoreScrollPositions(t)}r(Ko,"renderCharacterSheetPF2e");async function Qo(e,t,n){let o=X(e),i=await dr(n),s=await renderTemplate(C("summary/sheet"),i);o.append(s),Jo(e,t,n)}r(Qo,"addSummaryTab");function Jo(e,t,n){let o=ur(e),i=o.find(".spell-type .uses .spell-slots-input input");i.on("change",s=>Xo(s,n)),i.on("focus",Zo),i.on("blur",er),o.find("[data-action=cast-spell]").on("click",s=>ir(s,n)),o.find(".item-toggle-prepare").on("click",s=>tr(s,n)),o.find(".focus-pips").on("click contextmenu",s=>nr(s,n)),o.find(".spell-slots-increment-reset").on("click",s=>rr(s,t,n)),o.find(".item-image").on("click",s=>ar(s,n)),o.find(".item-name > h4").on("click",s=>sr(s,t))}r(Jo,"addSummaryEvents");async function Xo(e,t){e.preventDefault();let{inputPath:n,entryId:o}=$(e.currentTarget).data(),i=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:o,[n]:i}])}r(Xo,"onUsesInputChange");function Zo(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}r(Zo,"onUsesInputFocus");function er(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}r(er,"onUsesInputBlur");function tr(e,t){e.preventDefault();let{slotLevel:n,slotId:o,entryId:i,expended:s}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(i)?.setSlotExpendedState(n??0,o??0,s!==!0)}r(tr,"onTogglePrepare");function nr(e,t){e.preventDefault();let n=e.type==="click"?1:-1,o=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":o})}r(nr,"onToggleFocusPool");function or(e,t){fr(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}r(or,"onChargeReset");function rr(e,t,n){e.preventDefault();let{itemId:o,level:i,isCharge:s}=$(e.currentTarget).data();if(!o)return;if(s){or(t,o);return}let c=n.items.get(o);if(c){if(c.isOfType("spellcastingEntry")){let a=i>=0&&i<=11?`slot${i}`:"slot0",l=c.system.slots?.[a];l&&c.update({[`system.slots.${a}.value`]:l.max})}else if(c.isOfType("spell")){let a=c.system.location.uses?.max;a&&c.update({"system.location.uses.value":a})}}}r(rr,"onSlotsReset");function ir(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:o,slotLevel:i,slotId:s,entryId:c}=n.closest(".item").data(),a=t.spellcasting.collections.get(c);if(!a)return;let l=a.get(o);l&&a.entry.cast(l,{slot:s,level:i})}r(ir,"onCastSpell");async function sr(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}r(sr,"onToggleSummary");async function ar(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),o=t.items.get(n);!o||o.isOfType("physical")&&!o.isIdentified||await o.toMessage(e)}r(ar,"onItemToChat");function cr(e,t,n){e.preventDefault();let o=X(t);o.hasClass("active")&&(o.toggleClass("toggled"),o.scrollTop(0),setProperty(n,`modules.${p}.toggled`,o.hasClass("toggled")))}r(cr,"onSpellcastingBtnToggle");function lr(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}r(lr,"getSpellcastingNav");function X(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}r(X,"getSpellcastingTab");function fr(e){return X(e).find(".directory-list.spellcastingEntry-list")}r(fr,"getSpellcastingOriginalSection");function ur(e){return X(e).find(".directory-list.summary")}r(ur,"getSpellcastingSummarySection");async function dr(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,o=[],i=[],s=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let d=l.id,f=l.statistic.dc.value,b=l.name,h=await l.getSheetData(),u=h.isFocusPool,m=l.system?.prepared?.value==="charge",g=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,P={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let I of h.levels){if(!I.active.length||I.uses?.max===0)continue;let O=[],E=I.isCantrip,ee=I.active.filter(_=>_&&_.uses?.max!==0),te=!E&&m&&!n;for(let _=0;_<ee.length;_++){let{spell:L,expended:rn,virtual:sn,uses:an,castLevel:cn}=ee[_];O.push({name:L.name,img:L.img,range:L.system.range.value||"-",castLevel:cn??L.level,slotId:_,entryId:d,entryDc:f,entryName:b,itemId:L.id,inputId:h.isInnate?L.id:h.id,inputPath:m?"flags.pf2e-staves.charges":h.isInnate?"system.location.uses.value":`system.slots.slot${I.level}.value`,isCharge:m,isActiveCharge:m&&n,isBroken:te,isVirtual:sn,isInnate:h.isInnate,isCantrip:E,isFocus:u,isPrepared:h.isPrepared,isSpontaneous:h.isSpontaneous||h.isFlexible,slotLevel:I.level,uses:an??(m?P:I.uses),expended:rn??(u&&!E?t.value<=0:!1),action:L.system.time.value,type:m?g?`${p}.summary.staff`:`${p}.summary.charges`:h.isInnate?"PF2E.PreparationTypeInnate":h.isSpontaneous?"PF2E.PreparationTypeSpontaneous":h.isFlexible?"PF2E.SpellFlexibleLabel":u?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:m?0:h.isPrepared?1:u?2:h.isInnate?3:h.isSpontaneous?4:5,noHover:h.isPrepared||E||te||u})}if(O.length){if(u)if(E)s=!0;else{i.push(...O);continue}o[I.level]??=[],o[I.level].push(...O)}}})),o.length){let l=y("summary")==="sort"?(d,f)=>d.order===f.order?ce(d.name,f.name):d.order-f.order:(d,f)=>ce(d.name,f.name);o.forEach(d=>d.sort(l))}i.length&&(i.sort((l,d)=>ce(l.name,d.name)),o[12]=i,s=!1);let a=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,d)=>l.active.map(({spell:f})=>({name:f.name,img:f.img,slotId:d,itemId:f.id,level:f.level,time:f.system.time.value})).filter(Boolean));return{spells:o,rituals:a,focusPool:t,stavesActive:n,hasFocusCantrips:s,isOwner:e.isOwner,entryRank:l=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Ke(l)})}}r(dr,"getData");var Z=null,U=null;function tn(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:en}],conflicts:["pf2e-unided"],init:()=>{en()}}}r(tn,"registerUnided");function en(e){e??=y("unided"),e==="disabled"?(Z&&(Hooks.off("preCreateItem",Z),Z=null),U&&(Hooks.off("preUpdateItem",U),U=null)):(Z||(Z=Hooks.on("preCreateItem",mr)),e==="all"&&!U?U=Hooks.on("preUpdateItem",pr):e!=="all"&&U&&(Hooks.off("preUpdateItem",U),U=null))}r(en,"setHooks");function mr(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}r(mr,"preCreateItem");function pr(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}r(pr,"preUpdateItem");var j=v("macros.condition");async function nn(e){let t=r((f,b)=>{let h=f.find("[name=condition]"),{name:u,slug:m,img:g}=h.find(":selected").data();return{type:b,slug:m,img:g,name:f.find("[name=name]").val().trim()||j("effect-name",{condition:u}),uuid:h.val(),badge:Number(f.find("[name=badge]").val()||1),unidentified:f.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:j("generate"),callback:f=>t(f,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:j("add"),callback:f=>t(f,"add")}},o=Array.from(game.pf2e.ConditionManager.conditions.values()),i=new Set(o.filter(f=>!!f.badge).map(f=>f.slug)),s=await renderTemplate(C("macros/condition"),{i18n:j,conditions:Array.from(new Set(o.sort((f,b)=>f.name.localeCompare(b.name))))}),c=r(f=>{let{name:b,slug:h}=f.find("[name=condition] :selected").data();f.find("[name=name]").prop("placeholder",j("effect-name",{condition:b}));let u=i.has(h),m=f.find("[name=badge]");m.prop("disabled",!u),u||m.val(1)},"setInputs"),a=await Dialog.wait({buttons:n,content:s,title:j("title"),close:()=>null,render:f=>{c(f),f.find("[name=condition]").on("change",()=>c(f))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!a)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:a.uuid};a.badge>1&&i.has(a.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:a.badge}]);let d={name:a.name,type:"effect",img:a.img,system:{rules:[l],unidentified:a.unidentified}};a.type==="generate"||!e?await Item.create(d):await e.createEmbeddedDocuments("Item",[d])}r(nn,"permaConditionEffect");var Oe=[Re(),Mt(),We(),vt(),tn(),It(),Le(),Zt(),Wt(),et(),Ot(),Rt()],on=new Set,xe=null;Hooks.once("init",()=>{let e=game.data.users.find(c=>c._id===game.data.userId),t=e&&e.role>=CONST.USER_ROLES.GAMEMASTER,n=Oe.flatMap(({settings:c=[]})=>c.map(a=>{let l=a.name;return a.choices&&(a.choices=a.choices.reduce((d,f)=>(d[f]=Te(l,`choices.${f}`),d),{})),a.key=l,a.scope??="world",a.config??=!0,a.name=Te(l,"name"),a.hint=Te(l,"hint"),a})),[o,i]=["world","client"].map(c=>n.filter(a=>a.scope===c));[o,i].forEach(c=>c.forEach(a=>game.settings.register(p,a.key,a))),t&&(xe=i[0].key,Hooks.on("renderSettingsConfig",gr));let s=game.modules.get(p);s.api={macros:{permaConditionEffect:nn}},Oe.forEach(c=>{let{init:a,conflicts:l=[],api:d,name:f}=c;if(t)for(let b of l){let h=game.modules.get(b);h?.active&&(c.conflicting=!0,on.add(h.title))}d&&f&&(s.api[f]=d),!c.conflicting&&a&&a(t)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Oe)!t&&n&&n(e);if(e)for(let t of on)w("module-conflict",{name:t},!0)});function Te(e,t){return`${p}.settings.${e}.${t}`}r(Te,"settingPath");function gr(e,t){if(!xe)return;t.find(`.tab[data-tab=${p}] [data-setting-id="${p}.${xe}"]`).before(`<h3>${k("settings.client")}</h3>`)}r(gr,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
