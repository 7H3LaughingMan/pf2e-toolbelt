(()=>{var On=Object.defineProperty;var a=(e,t)=>On(e,"name",{value:t,configurable:!0});var b="pf2e-toolbelt";function R(e,t,n="WRAPPER"){return libWrapper.register(b,e,t,n)}a(R,"registerWrapper");function I(...e){let[t,n]=e;return t=`${b}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}a(I,"localize");function xn(e){return game.i18n.has(`${b}.${e}`,!1)}a(xn,"hasLocalization");function Rn(e){return`${b}.${e}`}a(Rn,"localizePath");function E(e){let t=a((...n)=>I(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>T(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>q(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>z(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>xn(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>Rn(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:o})=>t(n,o),enumerable:!1,configurable:!1}}),t}a(E,"subLocalize");function De(e,t,n,o){let r=typeof t=="string"?t:"info",s=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:o??!1;ui.notifications.notify(I(e,s),r,{permanent:i})}a(De,"notify");function T(...e){let[t,n,o]=e;De(t,"warning",n,o)}a(T,"warn");function q(...e){let[t,n,o]=e;De(t,"info",n,o)}a(q,"info");function z(...e){let[t,n,o]=e;De(t,"error",n,o)}a(z,"error");function y(e){return game.settings.get(b,e)}a(y,"getSetting");function qe(e,t){return game.settings.set(b,e,t)}a(qe,"setSetting");var $n="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Ln="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Fn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Un="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",_n=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function We(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{y("arp")&&(R($n,Hn,"WRAPPER"),R(Ln,zn,"WRAPPER"),R(Fn,Bn,"WRAPPER"),R(Un,Wn,"WRAPPER"))},ready:e=>{e&&y("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),q("arp.forceVariant"))}}}a(We,"registerArp");function fe(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}a(fe,"isValidActor");function Ve(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!_n.includes(e.sourceId)}a(Ve,"isValidWeapon");function Hn(e){let t=this.actor;if(!fe(t,!0)||!Ve(this))return e();let n=t.level,o=this._source.system.traits.value;if(o.includes("alchemical")&&o.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}a(Hn,"onPrepareWeaponData");var Nn={1:35,2:935,3:8935,4:8935},Gn={striking:65,greaterStriking:1065,majorStriking:31065};function zn(e){if(e(),!fe(this.actor)||this.isSpecific||!Ve(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.potencyRune.value;n&&(t.gp-=Nn[n]);let o=this.system.strikingRune.value;o&&(t.gp-=Gn[o]),t=new game.pf2e.Coins(t),(n||o)&&!this.system.runes.property.length&&(t=t.add(this._source.system.price.value)),this.system.price.value=t}a(zn,"onPrepareWeaponDerivedData");function Ye(e){return!e.isShield}a(Ye,"isValidArmor");function Bn(e){let t=this.actor;if(!fe(t,!0)||!Ye(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}a(Bn,"onPrepareArmorData");var jn={1:160,2:1060,3:20560,4:20560},qn={resilient:340,greaterResilient:3440,majorResilient:49440};function Wn(e){if(e(),!fe(this.actor)||this.isSpecific||!Ye(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.potencyRune.value;n&&(t.gp-=jn[n]);let o=this.system.resiliencyRune.value;o&&(t.gp-=qn[o]),t=new game.pf2e.Coins(t),(n||o)&&!this.system.runes.property.length&&(t=t.add(this._source.system.price.value)),this.system.price.value=t}a(Wn,"onPrepareArmorDerivedData");function M(e,t,n=()=>{}){let o=null;return function(r,s=[],i=!1){typeof s=="string"&&(s=[s]),r||=s.some(c=>y(c)),r&&!o?o=Hooks.on(e,t):!r&&o&&(Hooks.off(e,o),o=null),i||n(r)}}a(M,"createHook");function ue(e,t,n=()=>{}){let o=null;return function(r,s=!1){r==="disabled"&&o?(Hooks.off(e,o),o=null):r!=="disabled"&&!o&&(o=Hooks.on(e,t)),s||n(r)}}a(ue,"createChoicesHook");function Ke(e,t){let n=Hooks.on(e,t),o=Hooks.events[e].findIndex(r=>r.id===n);if(o!==0){let[r]=Hooks.events[e].splice(o,1);Hooks.events[e].unshift(r)}return n}a(Ke,"registerUpstreamHook");var Te=M("renderEffectsPanel",Yn,Vn);function Qe(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>Te(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>Te(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{Te(!1,["effect-remove","condition-sheet"])}}}a(Qe,"registerEffectsPanelHelper");function Vn(){game.pf2e.effectPanel?.render()}a(Vn,"refreshEffectsPanel");function Yn(e,t){let n=`<div>${I("effects.remove")}</div>`,o='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',r=t.find(".effect-item[data-item-id]").toArray();for(let s of r){let i=s.dataset.itemId,c=e.actor?.items.get(i);if(c&&(y("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(s.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),s.querySelector(".icon").addEventListener("contextmenu",l=>Qn(l,e),!0)),y("condition-sheet")&&c.isOfType("condition"))){let l=s.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",o),l.querySelector('[data-action="edit"]').addEventListener("click",u=>Kn(u,e))}}}a(Yn,"renderEffectsPanel");function Kn(e,t){let n=Je(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}a(Kn,"onConditionSheet");function Qn(e,t){if(!e.shiftKey)return;let n=Je(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}a(Qn,"onRemoveEffect");function Je(e,t){let r=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(r)}a(Je,"getEffect");var ee=class extends FormApplication{constructor(t,n,o){super(t,n),this.onSubmitCallback=o}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};a(ee,"MoveLootPopup");function O(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}a(O,"isPlayedActor");function w(e,t,n){return e.getFlag(b,t)??n}a(w,"getFlag");function H(e,t,n){return e.setFlag(b,t,n)}a(H,"setFlag");function Xe(e,t){return e.unsetFlag(b,t)}a(Xe,"unsetFlag");function W(e,t,n){return e.updateSource({[`flags.${b}.${t}`]:n})}a(W,"updateSourceFlag");function Pe(){return CONFIG.ChatMessage.documentClass}a(Pe,"getChatMessageClass");function*te(e,t){let n=game.messages.contents,o=(t?n.findLastIndex(r=>r===t):n.length)-1;for(let r=o;r>=o-e;r--){let s=n[r];if(!s)return;yield s}}a(te,"latestChatMessages");function N(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}a(N,"chatUUID");function de(e){let t=e.id,n=w(e,"target.save");n&&Hooks.once("preCreateChatMessage",o=>{W(o,"target.messageId",t),W(o,"target.save",n)})}a(de,"bindOnPreCreateSpellDamageChatMessage");function V(e){game.socket.on(`module.${b}`,e)}a(V,"socketOn");function Y(e){game.socket.off(`module.${b}`,e)}a(Y,"socketOff");function L(e){game.socket.emit(`module.${b}`,e)}a(L,"socketEmit");function K(){return game.user===game.users.activeGM}a(K,"isActiveGM");function pe(){let e=game.data.users.find(t=>t._id===game.data.userId);return e&&e.role>=CONST.USER_ROLES.GAMEMASTER}a(pe,"isUserGM");function Ze(){return game.users.some(e=>e.active&&e.isGM)}a(Ze,"isGMOnline");function et(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}a(et,"getCharacterOwner");function Jn(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,o)=>n.id>o.id?1:-1),t[0]||null}a(Jn,"getActiveOwner");function Ae(e){return Jn(e)===game.user}a(Ae,"isActiveOwner");function tt(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}a(tt,"getOwner");var me=!1,ne=null;function rt(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:nt}],conflicts:["pf2e-giveth"],ready:e=>{y("giveth")!=="disabled"&&nt(!0)}}}a(rt,"registerGiveth");function nt(e){let t=game.user.isGM;e==="disabled"&&me?(t?Y(ot):ne&&(Hooks.off("dropCanvasData",ne),ne=null),me=!1):e!=="disabled"&&!me&&(t?V(ot):ne||(ne=Ke("dropCanvasData",Xn)),me=!0)}a(nt,"setup");function ot(e){K()&&(e.type==="giveth-condition"?to(e):e.type==="giveth-effect"?no(e):oo(e))}a(ot,"onSocket");function Xn(e,t){if(!Ze())return!0;let n=eo(t);if(!n)return!0;let o=e.tokens.placeables.slice().filter(r=>{if(!r.document.actorLink)return!1;let s=r.actor;if(!st(s,t.actorId)||s.isOwner)return!1;let i=r.x+(r.hitArea?.right??0),c=r.y+(r.hitArea?.bottom??0);return t.x>=r.x&&t.y>=r.y&&t.x<=i&&t.y<=c}).sort((r,s)=>s.document.sort-r.document.sort).at(0)?.actor;return o?(Zn(n.actor,o,n.item,n.value),!1):!0}a(Xn,"onDropCanvasData");function Zn(e,t,n,o){let r=e.id,s=t.id,i=!(n instanceof Item);if(!i&&n.isOfType("physical")){let c=n.quantity;if(c<1)return T("giveth.notification.zero");if(c===1)return at(r,s,n.id,1,!1);new ee(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,u)=>{at(r,s,n.id,l,u)}).render(!0)}else{let c=i?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?L({type:"giveth-condition",targetId:s,value:o??1,uuid:c}):L({type:"giveth-effect",targetId:s,uuid:c})}}a(Zn,"giveth");function at(e,t,n,o,r){L({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:o,stack:r})}a(at,"sendPhysicalRequest");function st(e,t){return!O(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}a(st,"isValidActor");function eo(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let r=e.context?.origin.actor;n=r?fromUuidSync(r):null}if(!st(n)||!n.isOwner)return;let o=!(t instanceof Item);if(o&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!o&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}a(eo,"getDetailsFromData");async function to({targetId:e,uuid:t,value:n}){let o=game.actors.get(e);if(!o)return;let r=await fromUuid(t);r&&o.increaseCondition(r.slug,{min:n})}a(to,"takethCondition");async function no({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let o=await fromUuid(t);if(!o)return;let r=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[r])}a(no,"takethEffect");async function oo({itemId:e,ownerId:t,qty:n,stack:o,targetId:r}){let s=game.actors.get(t),i=game.actors.get(r);if(!s||!i)return;let c=s.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,u=c.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=c.traits.has("invested")?!1:null);let f=await i.addToInventory(u,void 0,o);if(!f||(l<1?c.delete():c.update({"system.quantity":l}),y("giveth")==="no-message"))return;let h=N(f.uuid,f.name,!f.isIdentified);n>1&&(h+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${I("giveth.giveth",{target:i.name})}</h4>`,content:h,speaker:ChatMessage.getSpeaker({actor:s})})}a(oo,"takethPhysical");function C(...e){return e=e.filter(t=>typeof t=="string"),`modules/${b}/templates/${e.join("/")}.hbs`}a(C,"templatePath");var Q=E("hero.templates.trade"),oe=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:Q("title"),template:C("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){Q.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:x(this.actor),targetActions:this.target?x(this.target):[],i18n:Q})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){Q.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){Q.warn("no-select");return}let o=et(this.target,!0)??tt(this.target,!0)??game.users.activeGM;if(!o){Q.warn("no-user");return}it({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:o.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};a(oe,"Trade");function ge(e,t){return e.localeCompare(t,game.i18n.lang)}a(ge,"localeCompare");function B(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}a(B,"refreshCharacterSheets");function Me(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let o of e){let r=n.findIndex(s=>o===s);if(r===-1)return!1;n.splice(r,1)}return!0}a(Me,"compareArrays");function ct(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}a(ct,"ordinalString");function he(e,t){if(typeof e!="object")return!1;for(;e=Reflect.getPrototypeOf(e);)if(e.constructor.name===t)return!0;return!1}a(he,"isInstanceOf");function lt(e,t,n){return setProperty(e,`modules.${b}.${t}`,n)}a(lt,"setInMemory");function ft(e,t){return getProperty(e,`modules.${b}.${t}`)}a(ft,"getInMemory");var be="pf2e-hero-actions",ut=M("renderCharacterSheetPF2e",io,so),ao="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",ve="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",ro="systems/pf2e/icons/features/feats/heroic-recovery.webp",ye=!1;function pt(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>ut(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>B()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[be],api:{createTable:So,removeHeroActions:Do,getHeroActions:x,useHeroAction:bt,getHeroActionDetails:ke,drawHeroAction:yt,drawHeroActions:gt,sendActionToChat:Ct,discardHeroActions:vt,tradeHeroAction:ht,getDeckTable:Re,giveHeroActions:Ao,createChatMessage:Se},ready:()=>{ut(!1,"hero")}}}a(pt,"registerHeroActions");function so(e){e&&!ye?(V(dt),ye=!0):!e&&ye&&(Y(dt),ye=!1)}a(so,"setupSocket");function dt(e){switch(e.type){case"hero.trade-reject":if(e.sender.id!==game.user.id)return;Tt(e);break;case"hero.trade-accept":if(!K())return;It(e);break;case"hero.trade-request":if(e.receiver.id!==game.user.id)return;vo(e);break;case"hero.trade-error":if(!e.users.includes(game.user.id))return;Dt(e.error);break}}a(dt,"onSocket");async function io(e,t){let n=e.actor;O(n)&&(await co(t,n),lo(t,n))}a(io,"renderCharacterSheetPF2e");async function co(e,t){let n=x(t),o=t.heroPoints.value-n.length,r=t.isOwner,s=E("hero.templates.heroActions"),i=await renderTemplate(C("hero/sheet"),{owner:r,list:n,canUse:o>=0&&r,canDraw:o>0&&r,canTrade:y("hero-trade"),mustDiscard:o<0,diff:Math.abs(o),i18n:(c,{hash:l})=>s(c,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(i)}a(co,"addActionsToSheet");function lo(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",o=>go(t,o)),n.find("[data-action=expand]").on("click",mt),n.find("[data-action=use]").on("click",o=>mo(t,o)),n.find("[data-action=display]").on("click",o=>po(t,o)),n.find("[data-action=discard]").on("click",uo),n.find("[data-action=discard-selected]").on("click",()=>fo(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>ht(t))}a(lo,"addSheetEvents");async function fo(e,t){let o=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(r=>r.dataset.uuid);vt(e,o)}a(fo,"onClickHeroActionsDiscard");function uo(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let o=Number(n.attr("data-discard")??"0"),r=n.find(".action.discarded");n.toggleClass("discardable",r.length===o)}a(uo,"onClickHeroActionDiscard");async function po(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Ct(e,n)}a(po,"onClickHeroActionDisplay");async function mo(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");bt(e,n)}a(mo,"onClickHeroActionUse");async function go(e,t){t.preventDefault(),gt(e)}a(go,"onClickHeroActionsDraw");function x(e){return getProperty(e,`flags.${be}.heroActions`)??[]}a(x,"getHeroActions");async function j(e,t){return e.update({[`flags.${be}.heroActions`]:t})}a(j,"setHeroActions");async function mt(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let o=t.attr("data-uuid"),r=await ke(o);if(!r)return;let s=await TextEditor.enrichHTML(r.description,{async:!0});n.find(".item-description").html(s),n.addClass("loaded")}t.toggleClass("expanded")}a(mt,"onClickHeroActionExpand");async function ke(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,o=t instanceof JournalEntry?t.pages.contents[0]:t,r=o?.text.content;if(r)return n.uuid===ao&&(r=r.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:o.name,description:r}}a(ke,"getHeroActionDetails");async function gt(e){if(!e?.isOfType("character")){T("hero.onlyCharacter");return}let t=x(e),n=e.heroPoints.value-t.length,o=[];for(let r=0;r<n;r++){let s=await yt();if(s!==void 0){if(s===null)return;t.push(s),o.push(s)}}o.length&&(j(e,t),Se({actor:e,actions:o,label:r=>I("hero.actions-draw.header",{nb:r}),secret:!0}))}a(gt,"drawHeroActions");function Se({actor:e,actions:t,label:n,secret:o=!1}){let{content:r,size:s}=ho(t);n=typeof n=="function"?n(s):n;let i={flavor:`<h4 class="action">${n}</h4>`,content:r,speaker:ChatMessage.getSpeaker({actor:e})};o&&y("hero-private")&&(i.type=CONST.CHAT_MESSAGE_TYPES.ROLL,i.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(i)}a(Se,"createChatMessage");function ho(e){let t=e.map(({uuid:n,name:o})=>N(n,o));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}a(ho,"chatActions");function ht(e){if(!e?.isOfType("character")){T("hero.onlyCharacter");return}let t=x(e);if(!t||!t.length){T("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){T("hero.no-points",{nb:n.toString()});return}new oe(e).render(!0)}a(ht,"tradeHeroAction");async function yt(){let e=await Re(),t=E("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(s=>!s.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let o=Pt(n);if(o)return{uuid:o,name:await kt(n,o)}}a(yt,"drawHeroAction");async function bt(e,t){if(!e?.isOfType("character")){T("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return T("hero.use.noPoints");let o=x(e),r=o.findIndex(i=>i.uuid===t);if(r===-1)return;let s=await ke(t);s||z("hero.use.noDetails"),o.splice(r,1),s?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${be}.heroActions`]:o}),ChatMessage.create({flavor:`<h4 class="action">${I("hero.actions-use.header")}</h4>`,content:`<h2>${s.name}</h2>${s.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):j(e,o)}a(bt,"useHeroAction");async function vt(e,t){if(!e?.isOfType("character")){T("hero.onlyCharacter");return}t=typeof t=="string"?[t]:t;let n=x(e),o=[];for(let r of t){let s=n.findIndex(i=>i.uuid===r);s!==-1&&(o.push(n[s]),n.splice(s,1))}j(e,n),Se({actor:e,actions:o,label:r=>I("hero.actions-discard.header",{nb:r})})}a(vt,"discardHeroActions");async function kt(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}a(kt,"getLabelfromTableResult");async function St(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}a(St,"getTableFromUuid");async function yo(){return St(ve)}a(yo,"getDefaultCompendiumTable");function wt(){return game.tables.find(e=>e.getFlag("core","sourceId")===ve)}a(wt,"getDefaultWorldTable");async function bo(){return St(y("hero-table"))}a(bo,"getCustomTable");async function Re(){return await bo()??wt()??await yo()}a(Re,"getDeckTable");async function Ct(e,t){let n=await ke(t);if(!n)return z("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}a(Ct,"sendActionToChat");function it(e){if(e.receiver.id===game.user.id){Et(e);return}L({...e,type:"hero.trade-request"})}a(it,"sendTradeRequest");function Et(e){if(game.user.isGM){It(e);return}L({...e,type:"hero.trade-accept"})}a(Et,"acceptRequest");async function It(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),r=game.actors.get(n.cid);if(!o||!r){Oe(e);return}let s=x(o),i=x(r),c=s.findIndex(p=>p.uuid===t.uuid),l=i.findIndex(p=>p.uuid===n.uuid);if(c===-1||l===-1){Oe(e);return}let u=s.splice(c,1)[0],f=i.splice(l,1)[0];s.push(f),i.push(u),j(o,s),j(r,i);let h=N(u.uuid),m=N(f.uuid),d=E("hero.trade-success"),g=`<div style="line-height: 1.6">${d("offer",{offer:h})}</div>`;g+=`<div style="line-height: 1.6">${d("receive",{receive:m})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${d("header",{name:r.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:o})})}a(It,"onTradeAccepted");function Oe({sender:e,receiver:t},n="trade-error"){let o=new Set([e.id,t.id]);o.has(game.user.id)&&(o.delete(game.user.id),Dt(n)),o.size&&L({type:"hero.trade-error",users:Array.from(o),error:n})}a(Oe,"sendTradeError");function Dt(e){z("hero.trade-error")}a(Dt,"onTradeError");async function vo(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),r=game.actors.get(n.cid);if(!o||!r){Oe(e);return}let s=E("hero.trade-request"),i=`<p>${s("header",{sender:o.name,receiver:r.name})}</p>`;i+=`<p>${s("give",{give:N(t.uuid)})}</p>`,i+=`<p>${s("want",{want:N(n.uuid)})}</p>`,i+=`<p style="margin-bottom: 1em;">${s("accept")}</p>`,await Dialog.confirm({title:s("title"),content:await TextEditor.enrichHTML(i,{async:!0})})?Et(e):ko(e)}a(vo,"onTradeRequest");function ko(e){if(e.sender.id===game.user.id){Tt(e);return}L({...e,type:"hero.trade-reject"})}a(ko,"rejectRequest");async function Tt({receiver:e}){let t=game.actors.get(e.cid);T("hero.trade-rejected",{name:t.name},!0)}a(Tt,"onTradeRejected");async function So(){if(!game.user.isGM){T("hero.notGM");return}let e=E("hero.templates.createTable.choice"),t=C("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:s=>{let i=s.find('.window-content input[name="type"]:checked').val(),c=s.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:i,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},r=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-create-table"});r&&(r.type==="default"?Eo(r.unique):wo(r.unique))}a(So,"createTable");async function wo(e){let t=await Co(e);await xe(t),t.sheet?.render(!0)}a(wo,"createCustomTable");function Co(e=!0){let t=$e(e);return RollTable.create(t,{temporary:!1})}a(Co,"createCustomActionsTable");async function Eo(e){let t=E("templates.createTable.default.confirm"),n=await wt();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let r=$e(e);return await n.update(r),xe(n,!0)}n=await Io(e),await xe(n)}a(Eo,"createDefaultTable");async function Io(e=!0){let t=await fromUuid(ve),n=$e(e,t);return RollTable.create(n,{temporary:!1})}a(Io,"createDefautActionsTable");async function xe(e,t=!1){t&&await e.normalize(),await qe("hero-table",e.uuid)}a(xe,"setTable");function $e(e=!0,t){let n={name:I("hero.table.name"),replacement:!e,img:ro,description:I("hero.table.description"),flags:{core:{sourceId:ve}}};return t?mergeObject(deepClone(t._source),n):n}a($e,"getTableSource");async function Do(){if(!game.user.isGM){T("hero.notGM");return}let e=E("hero.templates.removeActions"),t=C("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:s=>s.find('input[name="actor"]:checked').toArray().map(i=>game.actors.get(i.value)).filter(i=>i)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{actors:game.actors.filter(s=>s.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:s=>{s.on("change",'input[name="all"]',()=>To(s)),s.on("change",'input[name="actor"]',()=>Po(s))},close:()=>null},r=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-remove-actions"});if(r){if(!r.length){e.warn("noSelection");return}for(let s of r)j(s,[]);e.info("removed")}}a(Do,"removeHeroActions");function To(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}a(To,"removeActionsToggleAll");function Po(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),o=e.find('input[name="all"]');t.length===n.length?(o.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?o.prop("checked",!1).prop("indeterminate",!0):(o.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}a(Po,"removeActionsToggleActor");function Pt(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}a(Pt,"documentUuidFromTableResult");async function Ao(e){if(!game.user.isGM){T("hero.notGM");return}let t=E("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await Re();if(!n)return z("hero.table.drawError",!0),null;let o=n.replacement===!1,r=(await Promise.all(n.results.map(async p=>{let v=Pt(p);if(v)return{key:p.id,uuid:v,name:await kt(p,v),drawn:p.drawn}}))).filter(Boolean),s=C("hero/dialogs/give-action"),i=await renderTemplate(s,{actions:r,isUnique:o,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:p=>({selected:p.find("[name=action]:checked").closest(".action").toArray().map(v=>v.dataset),asDrawn:p.find("[name=drawn]").prop("checked")??!1,withMessage:p.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:i,buttons:c,render:p=>{p.find("[data-action=expand]").on("click",mt)},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!u)return;let{selected:f,asDrawn:h,withMessage:m}=u,d=x(e),g=[];for(let{uuid:p,name:v,key:k}of f){if(d.push({uuid:p,name:v}),!h)continue;let P=n.results.get(k);P&&!P.drawn&&g.push(k)}g.length&&await n.updateEmbeddedDocuments("TableResult",g.map(p=>({_id:p,drawn:!0}))),j(e,d),m&&Se({actor:e,actions:f,label:p=>I("hero.actions-give.header",{nb:p}),secret:!0})}a(Ao,"giveHeroActions");var At=E("knowledges.editLore"),ae=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return At("title",this.actor)}get template(){return C("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:w(n,"knowledges.unspecified")??"",specific:w(n,"knowledges.specific")??"",i18n:At})}async _updateObject(t,{unspecified:n,specific:o}){let r=this.object;H(r,"knowledges.unspecified",n.trim()),H(r,"knowledges.specific",o.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};a(ae,"EditLores");var Mt=M("renderNPCSheetPF2e",Mo);function Ot(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>Mt(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&y("knowledges")&&Mt(!0)}}}a(Ot,"registerKnowledges");function Mo(e,t){let n=e.actor;O(n)&&(xo(n,t),$o(t),Ro(n,t))}a(Mo,"renderNPCSheetPF2e");function Le(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}a(Le,"knowledgeSelector");function Oo(e){new ae(e).render(!0)}a(Oo,"editLores");function xo(e,t){let n=w(e,"knowledges.unspecified"),o=w(e,"knowledges.specific");if(!n&&!o)return;let r=e.identificationDCs.lore,s=Le(t,"body","");s.find(".identification-skills").last().remove();function i(l,u,f){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:f})}</div>`}a(i,"tag");function c(l,{dc:u,start:f}){let h=l.split(",").filter(m=>m.trim()).map(m=>i(m,u,f)).join("");s.append(h)}a(c,"addTags"),c(n||"Unspecific",r[0]),c(o||"Specific",r[1])}a(xo,"replaceLores");function Ro(e,t){Le(t,"header","button.edit").on("click",()=>Oo(e))}a(Ro,"addEvents");function $o(e){let t=Le(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}a($o,"addEditButton");var Fe=E("merge.multi"),re=class extends Application{#e;#t;constructor(t,n,o){super(o),this.#t=t,this.#e=n}get title(){return Fe("title",this.spell)}get template(){return C("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:Fe})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#n.bind(this)),t.find("[data-action=cancel]").on("click",this.#o.bind(this))}async#n(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){Fe.error("zero"),this.close();return}let o=this.#e;if(!o)return;let r=o.item,s=o.actor;if(!s||!r)return;let i=a((l,u)=>{for(let[f,h]of Object.entries(l))for(let m=0;m<n-1;m++){let d=randomID();if(l[d]=h,u.type==="interval"){let g=u.damage[f];g&&(u.damage[d]=g)}else if(u.type==="fixed")for(let[g,p]of Object.entries(u.levels)){let v=p.damage.value[f];v&&(u.levels[g].damage.value[d]=v)}}},"updateSource"),c=deepClone(o.flags.pf2e.casting?.embeddedSpell);if(c){let l=c.system.damage,u=c.system.heightening??={};i(l,u);let f=new CONFIG.Item.documentClass(c,{parent:s});f.trickMagicEntry=r.trickMagicEntry;let h=o.getFlag("pf2e","origin.variant.overlays"),m=o.getFlag("pf2e","origin.castLevel")??r.rank;(f.loadVariant({overlayIds:h,castLevel:m})??f).rollDamage(this.#t)}else{let l=r.toObject(),u=l.system.damage,f=l.system.heightening??{};i(u,f),r.clone({"system.damage":u,"system.heightening":f}).rollDamage(this.#t)}r.damageKinds.size&&de(o),this.close()}#o(t){t.preventDefault(),this.close()}};a(re,"MultiCast");var Lo=/(\[[\w,]+\])/,Ue=M("renderChatMessage",Ut,Fo);function Ft(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>Ue(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>Ue(e,"merge-damage")}],init:e=>{Ue(!1,["multi-cast","merge-damage"],!0)}}}a(Ft,"registerMerge");function Fo(){let e=ui.chat?.element;if(e)for(let t of te(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),Ut(t,n))}}a(Fo,"updateMessages");function Ut(e,t){!game.user.isGM&&!e.isAuthor||(y("merge-damage")&&Nt(e)?_o(e,t):y("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&Uo(e,t))}a(Ut,"renderChatMessage");function Uo(e,t){if(!e.item)return;let o=t.find(".message-content .chat-card .owner-buttons .spell-button");o.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${I("merge.spell.button")}</button>`),o.find("[data-action=multi-cast]").on("click",r=>{new re(r,e).render(!0)})}a(Uo,"renderSpell");function _o(e,t){let n='<span class="pf2e-toolbelt-merge">';if(w(e,"merge.merged")){let i=I("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${i}">`,n+='<i class="fa-duotone fa-split"></i>'}let o=I("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${o}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let r=$t(e),s=Lt(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",i=>{i.stopPropagation();for(let c of te(5,e))if(!(!Nt(c)||$t(c)!==r||!Me(s,Lt(c)))){No(i,e,c,{actorUUID:r,targetUUID:s});return}T("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",i=>{i.stopPropagation(),Ho(i,e)})}a(_o,"renderDamage");async function Ho(e,t){let n=w(t,"merge.data").flatMap(o=>o.source);await _t(t.id),await Pe().createDocuments(n)}a(Ho,"splitDamages");async function No(e,t,n,{actorUUID:o,targetUUID:r}){let s={},i=xt(n).concat(xt(t));for(let{name:d,notes:g,outcome:p,modifiers:v,tags:k}of i)s[d]??={name:d,tags:k,notes:new Set,results:[]},g.forEach(s[d].notes.add,s[d].notes),s[d].results.some(A=>A.outcome===p&&Me(A.modifiers,v))||s[d].results.push({outcome:p,modifiers:v});let c=Object.values(s).map(d=>(d.label=d.name,d.results.forEach(g=>{g.outcome&&(g.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${g.outcome}`))}),d));c.at(-1).isLastGroup=!0;let l=await renderTemplate(C("merge/merged"),{groups:c,hasMultipleGroups:c.length>1}),u=Rt(t),f=Rt(n),h=[];for(let d of[].concat(f,u)){let{options:g,total:p,terms:v}=d,k=v[0],P=d.formula.replace(Lo,""),A=h.find(({options:{flavor:F,critRule:D}})=>F===g.flavor&&D===g.critRule);A?(A.terms.push(k),A.total+=p,A.formulas.push(P)):h.push({options:g,formulas:[P],total:p,terms:[k]})}for(let d of h)d.formula=`(${d.formulas.join(" + ")})[${d.options.flavor}]`,d.term=d.terms.length<2?d.terms[0]:Ht(d.terms);let m={class:"DamageRoll",options:{},dice:[],formula:`{${h.map(({formula:d})=>d).join(", ")}}`,total:h.reduce((d,{total:g})=>d+g,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:h.map(({formula:d})=>d),modifiers:[],rolls:h.map(({options:d,formula:g,total:p,term:v})=>({class:"DamageInstance",options:d,dice:[],formula:g,total:p,terms:[v],evaluated:!0})),results:h.map(({total:d})=>({result:d,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let d=a(g=>{"results"in g?g.results.forEach(p=>p.hidden=!0):(g.term??g).operands?.forEach(p=>d(p))},"setHidden");m.terms[0].rolls.forEach(g=>g.terms.forEach(p=>d(p)))}await _t(t.id,n.id),await Pe().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[b]:{merge:{actor:o,target:r,merged:!0,type:"damage-roll",data:i}},pf2e:{context:{options:Array.from(new Set(i.flatMap(d=>d.itemTraits)))}}},rolls:[m]})}a(No,"mergeDamages");function xt(e){let t=w(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let o=$(`<div>${e.flavor}</div>`),r=o.find("h4.action + .tags").prop("outerHTML"),s=[];o.find(".tag.tag_transparent").each(function(){s.push(this.innerHTML)});let i=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>c.startsWith("item:")),modifiers:s,tags:r,notes:i}]}a(xt,"getMessageData");function _t(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}a(_t,"removeChatMessages");function Ht(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?Ht(e):e[0]]}}}a(Ht,"createTermGroup");function Rt(e){return w(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}a(Rt,"getMessageRolls");function $t(e){return w(e,"merge.actor")??e.actor?.uuid}a($t,"getActorUUID");function Lt(e){let t=w(e,"target.targets");if(t)return t.map(({actor:o})=>o).filter(Boolean);let n=w(e,"merge.target")??e.target?.actor.uuid;return n?[n]:[]}a(Lt,"getTargetUUIDs");function Nt(e){return w(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}a(Nt,"isDamageRoll");var Gt=ue("renderChatMessage",Bt,Go);function zt(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>Gt(e)}],init:e=>{!e&&y("modifiers")!=="disabled"&&Gt(!0,!0)}}}a(zt,"registerHideModifiers");function Go(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of te(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),Bt(t,n))}}a(Go,"updateMessages");function Bt(e,t){let n=e.speaker,o=ChatMessage.getSpeakerActor(n);if(!o||o.hasPlayerOwner)return;let r=t.find(".message-header");y("modifiers")==="traits"&&r.addClass("pf2e-toolbelt-modifiers-traits"),y("modifiers")!=="disabled"&&r.addClass("pf2e-toolbelt-modifiers")}a(Bt,"renderChatMessage");var zo="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",Bo="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function jt(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{y("nobulk")&&R(zo,qo,"WRAPPER"),y("nobulk-coins")&&R(Bo,jo,"WRAPPER")}}}a(jt,"registerNobulk");function jo(e){e(),this.isCoinage&&(this.system.bulk.value=0)}a(jo,"treasurePrepareBaseData");function qo(e,...t){e(...t);let n=this,o=n.inventory.bulk.constructor,r=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return r||(r=o.computeTotalBulk(this.actor.inventory.filter(s=>!s.isInContainer&&s.system.equipped.carryType!=="dropped"),this.actor.size),r)}})}a(qo,"actorPrepareEmbeddedDocuments");var Wo="CONFIG.Actor.documentClass.prototype.prepareData",Vo="DocumentSheet.prototype._renderInner";function qt(){return{settings:[{name:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{y("share")!=="disabled"&&(R(Wo,Zo,"WRAPPER"),R(Vo,Yo,"WRAPPER"),Hooks.on("preUpdateActor",Qo),Hooks.on("deleteActor",Ko),Hooks.on("updateActor",Jo))}}}a(qt,"registerShare");async function Yo(e,...t){let n=await e(...t);if(!he(this,"CreatureConfig"))return n;let o=this.actor;if(!O(o)||!o.isOfType("character","npc")||se(o).size)return n;let r=game.actors.filter(i=>i.id!==o.id&&i.isOwner&&Ce(i)).map(i=>({key:i.id,label:i.name})),s=await renderTemplate(C("share/master"),{masters:r,master:w(o,"share.master"),selectPath:`flags.${b}.share.master`,i18n:E("share.templates.master")});return n.children().last().before(s),n}a(Yo,"documentSheetRenderInner");function Ko(e){Jt(e);let t=se(e);Promise.all(t.map(async n=>{Vt(n),await Xe(n,"share.master")}))}a(Ko,"deleteActor");function Qo(e,t){let n=getProperty(t,`flags.${b}.share`);if(n?.master){let o=game.actors.get(n.master);if(Ce(o)){let r=deepClone(o._source.system.attributes.hp);setProperty(t,"system.attributes.hp",r)}}else{let o=we(e),r=getProperty(t,"system.attributes.hp");o&&r&&(o.update({system:{attributes:{hp:r}}},{noHook:!0}),delete t.system.attributes.hp)}}a(Qo,"preUpdateActor");function Jo(e,t,n,o){let r=game.user.id===o,s=ta(t);if(s?.master!==void 0){let c=e;if(Jt(c),s.master){let l=game.actors.get(s.master);Ce(l)&&(Wt(c,l),Qt(l,c))}else Vt(c)}if(!r)return;let i=se(e);if(i.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(i.map(async u=>await u.update(l,{noHook:!0})))}else Promise.all(i.map(async l=>await Xo(l,t)))}}a(Jo,"updateActor");async function Xo(e,t){y("share")==="force"?await H(e,"toggle",!w(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}a(Xo,"refreshActor");function Zo(e){e();let t=this,n=w(t,"share.master"),o=n?game.actors.get(n):void 0;if(!Ce(o))return;we(this)||(Wt(this,o),Qt(o,this));let r=this.system.attributes.hp;Object.defineProperty(t.system.attributes,"hp",{get(){let s=o.system.attributes.hp;return ea(s,r),r},enumerable:!0})}a(Zo,"prepareData");function ea(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}a(ea,"transfertHpData");function ta(e){return getProperty(e,`flags.${b}.share`)}a(ta,"getShareFlag");function se(e){return Yt(e,"slaves")??new Collection}a(se,"getSlaves");function Wt(e,t){Kt(e,"master",t)}a(Wt,"setMaster");function Vt(e){na(e,"master")}a(Vt,"unsetMaster");function we(e){return Yt(e,"master")}a(we,"getMaster");function Ce(e){return e&&e.type==="character"&&!we(e)}a(Ce,"isValidMaster");function Yt(e,t){return getProperty(e,`modules.${b}.share.${t}`)}a(Yt,"getModuleProperty");function Kt(e,t,n){setProperty(e,`modules.${b}.share.${t}`,n)}a(Kt,"setModuleProperty");function na(e,t){delete e.modules?.[b]?.share?.[t]}a(na,"deleteModuleProperty");function Qt(e,t){let n=se(e);Kt(e,"slaves",n.set(t.id,t))}a(Qt,"addSlaveToMaster");function Jt(e){let t=we(e);if(!t)return;se(t).delete(e.id)}a(Jt,"removeSlaveFromMaster");function Xt(e){return e.getFlag("core","sourceId")}a(Xt,"getSourceId");function oa(e,t){let n=Xt(e);return n?t.includes(n):!1}a(oa,"includesSourceId");function Zt(e){return Array.isArray(e)?t=>oa(t,e):t=>Xt(t)===e}a(Zt,"getItemSourceIdCondition");function en(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}a(en,"getItems");function tn(e,t,n){return en(e,n).some(Zt(t))}a(tn,"hasItemWithSourceId");function Ee(e,t,n){return en(e,n).find(Zt(t))}a(Ee,"getItemWithSourceId");var aa=M("renderCharacterSheetPF2e",ua),ra=M("deleteCombat",pa),sa=M("deleteCombatant",ln),ia=M("createCombatant",ma),ca=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],la=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),fa=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function on(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:nn},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:_e,toggleStance:cn,isValidStance:an},ready:e=>{y("stances")&&nn(!0)}}}a(on,"registerStances");function nn(e){aa(e),ra(e),sa(e),ia(e)}a(nn,"setup");function an(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}a(an,"isValidStance");function _e(e){let t=[],n=new Set;for(let{replace:o,sourceId:r,effectUUID:s,effect:i,img:c,name:l,itemName:u,action:f}of rn(e)){o&&n.add(o);let h=f?Ee(e,f,"action"):Ee(e,r,"feat");t.push({name:l,itemName:u,uuid:r,img:c,effectUUID:s,effectID:i?.id,actionUUID:h.sourceId,actionID:h.id})}return t.filter(({uuid:o})=>!n.has(o))}a(_e,"getStances");async function ua(e,t){let n=e.actor;if(!O(n))return;let o=_e(n);if(!o.length)return;let r=n.getActiveTokens(!0,!0).some(l=>l.inCombat),s=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),i=s.find(".actions-options"),c=await renderTemplate(C("stances/sheet"),{stances:o,canUseStances:r&&!n.isDead,i18n:E("stances")});i.length?i.after(c):s.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>da(l,n))}a(ua,"renderCharacterSheetPF2e");function da(e,t){let n=e.currentTarget,o=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!o)return;let r=n.dataset.effectUuid;cn(t,r)}a(da,"onToggleStance");function*rn(e){for(let t of e.itemTypes.feat){let n=t.sourceId,o=la.get(n),r=fa.get(n);if(!o&&!r&&!an(t))continue;let s=o?.effect??r?.effect??t.system.selfEffect.uuid,i=fromUuidSync(s);i&&(yield{name:(o&&fromUuidSync(o.replace)?.name)??t.name,itemName:t.name,replace:o?.replace,extra:r,sourceId:n,effectUUID:s,effect:Ee(e,s,"effect"),action:r?.action,img:i.img})}}a(rn,"actorStances");function sn(e){let t=[];for(let{effect:n}of rn(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}a(sn,"getStancesEffects");async function cn(e,t){let n=sn(e),o=n.findIndex(s=>s.uuid===t),r=!1;if(o===-1)r=!0;else{let s=n.filter(c=>c.uuid!==t).length,i=n.filter(c=>c.uuid===t).length>1;(s||i)&&n.splice(o,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(s=>s.id)),r&&He(e,t)}a(cn,"toggleStance");async function He(e,t){let n=await fromUuid(t);if(n){let o=n.toObject();return getProperty(o,"flags.core.sourceId")||setProperty(o,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[o]))[0]?.toMessage(),!0}return!1}a(He,"addStance");function pa(e){for(let t of e.combatants)ln(t)}a(pa,"deleteCombat");function ln(e){let t=fn(e);if(t){if(!game.user.isGM&&Ae(t)){let n=sn(t).map(o=>o.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}B(t)}}a(ln,"deleteCombatant");function ma(e){let t=fn(e);t&&(!game.user.isGM&&Ae(t)&&ga(t),B(t))}a(ma,"createCombatant");function fn(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}a(fn,"getActorFromCombatant");async function ga(e){let t=_e(e);if(!(!t.length||t.filter(({effectID:r})=>r).length||!tn(e,ca,["feat"])))if(t.length===1){let r=t[0];await He(e,r.effectUUID)&&q("stances.useStance",{stance:r.name})}else ha(e,t)}a(ga,"checkForSavant");async function ha(e,t){let n=E("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(C("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:o=>He(e,o.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}a(ha,"openStancesMenu");var un=ue("renderCharacterSheetPF2e",ya,()=>B());function dn(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>un(e)}],conflicts:["pf2e-spells-summary"],init:e=>{y("summary")!=="disabled"&&un(!0,!0)}}}a(dn,"registerSpellsSummary");async function ya(e,t){let n=e.actor;if(!O(n))return;let o=ie(t);ft(e,"toggled")&&o.addClass("toggled"),Oa(t).on("click",r=>Ma(r,t,e)),await ba(t,e,n),o.hasClass("toggled")&&o.hasClass("active")&&e._restoreScrollPositions(t)}a(ya,"renderCharacterSheetPF2e");async function ba(e,t,n){let o=ie(e),r=await $a(n),s=await renderTemplate(C("summary/sheet"),r);o.append(s),va(e,t,n)}a(ba,"addSummaryTab");function va(e,t,n){let o=Ra(e),r=o.find(".spell-type .uses .spell-slots-input input");r.on("change",s=>ka(s,n)),r.on("focus",Sa),r.on("blur",wa),o.find("[data-action=cast-spell]").on("click",s=>Ta(s,n)),o.find(".item-toggle-prepare").on("click",s=>Ca(s,n)),o.find(".focus-pips").on("click contextmenu",s=>Ea(s,n)),o.find(".spell-slots-increment-reset").on("click",s=>Da(s,t,n)),o.find(".item-image").on("click",s=>Aa(s,n)),o.find(".item-name > h4").on("click",s=>Pa(s,t))}a(va,"addSummaryEvents");async function ka(e,t){e.preventDefault();let{inputPath:n,entryId:o}=$(e.currentTarget).data(),r=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:o,[n]:r}])}a(ka,"onUsesInputChange");function Sa(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}a(Sa,"onUsesInputFocus");function wa(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}a(wa,"onUsesInputBlur");function Ca(e,t){e.preventDefault();let{slotLevel:n,slotId:o,entryId:r,expended:s}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(r)?.setSlotExpendedState(n??0,o??0,s!==!0)}a(Ca,"onTogglePrepare");function Ea(e,t){e.preventDefault();let n=e.type==="click"?1:-1,o=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":o})}a(Ea,"onToggleFocusPool");function Ia(e,t){xa(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}a(Ia,"onChargeReset");function Da(e,t,n){e.preventDefault();let{itemId:o,level:r,isCharge:s}=$(e.currentTarget).data();if(!o)return;if(s){Ia(t,o);return}let i=n.items.get(o);if(i){if(i.isOfType("spellcastingEntry")){let c=r>=0&&r<=11?`slot${r}`:"slot0",l=i.system.slots?.[c];l&&i.update({[`system.slots.${c}.value`]:l.max})}else if(i.isOfType("spell")){let c=i.system.location.uses?.max;c&&i.update({"system.location.uses.value":c})}}}a(Da,"onSlotsReset");function Ta(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:o,slotLevel:r,slotId:s,entryId:i}=n.closest(".item").data(),c=t.spellcasting.collections.get(i);if(!c)return;let l=c.get(o);l&&c.entry.cast(l,{slot:s,level:r})}a(Ta,"onCastSpell");async function Pa(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}a(Pa,"onToggleSummary");async function Aa(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),o=t.items.get(n);!o||o.isOfType("physical")&&!o.isIdentified||await o.toMessage(e)}a(Aa,"onItemToChat");function Ma(e,t,n){e.preventDefault();let o=ie(t);o.hasClass("active")&&(o.toggleClass("toggled"),o.scrollTop(0),lt(n,"toggled",o.hasClass("toggled")))}a(Ma,"onSpellcastingBtnToggle");function Oa(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}a(Oa,"getSpellcastingNav");function ie(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}a(ie,"getSpellcastingTab");function xa(e){return ie(e).find(".directory-list.spellcastingEntry-list")}a(xa,"getSpellcastingOriginalSection");function Ra(e){return ie(e).find(".directory-list.summary")}a(Ra,"getSpellcastingSummarySection");async function $a(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,o=[],r=[],s=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,f=l.statistic.dc.value,h=l.name,m=await l.getSheetData(),d=m.isFocusPool,g=l.system?.prepared?.value==="charge",p=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,v={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let k of m.levels){if(!k.active.length||k.uses?.max===0)continue;let P=[],A=k.isCantrip,F=k.active.filter(U=>U&&U.uses?.max!==0),D=!A&&g&&!n;for(let U=0;U<F.length;U++){let{spell:_,expended:le,virtual:S,uses:X,castLevel:Z}=F[U];P.push({name:_.name,img:_.img,range:_.system.range.value||"-",castLevel:Z??_.level,slotId:U,entryId:u,entryDc:f,entryName:h,itemId:_.id,inputId:m.isInnate?_.id:m.id,inputPath:g?"flags.pf2e-staves.charges":m.isInnate?"system.location.uses.value":`system.slots.slot${k.level}.value`,isCharge:g,isActiveCharge:g&&n,isBroken:D,isVirtual:S,isInnate:m.isInnate,isCantrip:A,isFocus:d,isPrepared:m.isPrepared,isSpontaneous:m.isSpontaneous||m.isFlexible,slotLevel:k.level,uses:X??(g?v:k.uses),expended:le??(d&&!A?t.value<=0:!1),action:_.system.time.value,type:g?p?`${b}.summary.staff`:`${b}.summary.charges`:m.isInnate?"PF2E.PreparationTypeInnate":m.isSpontaneous?"PF2E.PreparationTypeSpontaneous":m.isFlexible?"PF2E.SpellFlexibleLabel":d?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:g?0:m.isPrepared?1:d?2:m.isInnate?3:m.isSpontaneous?4:5,noHover:m.isPrepared||A||D||d})}if(P.length){if(d)if(A)s=!0;else{r.push(...P);continue}o[k.level]??=[],o[k.level].push(...P)}}})),o.length){let l=y("summary")==="sort"?(u,f)=>u.order===f.order?ge(u.name,f.name):u.order-f.order:(u,f)=>ge(u.name,f.name);o.forEach(u=>u.sort(l))}r.length&&(r.sort((l,u)=>ge(l.name,u.name)),o[12]=r,s=!1);let c=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:f})=>({name:f.name,img:f.img,slotId:u,itemId:f.id,level:f.level,time:f.system.time.value})).filter(Boolean));return{spells:o,rituals:c,focusPool:t,stavesActive:n,hasFocusCantrips:s,isOwner:e.isOwner,entryRank:l=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ct(l)})}}a($a,"getData");function La(e){return Error(`PF2e System | ${e}`)}a(La,"ErrorPF2e");async function Fa({affects:e,origin:t,target:n,item:o,domains:r,options:s}){if(!(t&&n))return[];let[i,c]=e==="target"?[t,n]:[n,t],l=[...s,i.getRollOptions(r),c.getSelfRollOptions(e)].flat(),u=o?o.isOfType("spell")?{spell:o}:{weapon:o}:{};return(await Promise.all(r.flatMap(f=>i.synthetics.ephemeralEffects[f]?.[e]??[]).map(f=>f({test:l,resolvables:u})))).flatMap(f=>f??[])}a(Fa,"extractEphemeralEffects");function Ua(e,t){return t.flatMap(n=>(e[n]??[]).map(o=>o.clone()))}a(Ua,"extractNotes");function _a(e,t,n){return t.flatMap(o=>e[o]??[]).flatMap(o=>o(n)??[])}a(_a,"extractDamageDice");async function Ha(e,{message:t,multiplier:n,rollIndex:o}){let r=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),s=a(class extends Dialog{activateListeners(i){super.activateListeners(i),i[0].querySelector("input")?.focus()}},"AdjustmentDialog");new s({title:game.i18n.localize("PF2E.UI.shiftModifyDamageTitle"),content:r,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async i=>{let c=(Number(i[0].querySelector("input")?.value)||0)*Math.sign(n);Ne(e,{message:t,multiplier:n,addend:c,promptModifier:!1,rollIndex:o})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{mn(t.id)}}).render(!0)}a(Ha,"shiftAdjustDamage");async function Ne(e,{message:t,multiplier:n=1,addend:o=0,promptModifier:r=!1,rollIndex:s=0}){if(r)return Ha(e,{message:t,multiplier:n,rollIndex:s});let i=CONFIG.PF2E.chatDamageButtonShieldToggle,c=t.rolls.at(s);if(!he(c,"DamageRoll"))throw La("Unexpected error retrieving damage roll");let l=n<0?n*c.total+o:c.alter(n,o),u=[...t.flags.pf2e.context?.options??[]],f=u.filter(D=>D.startsWith("self:")).map(D=>D.replace(/^self/,"origin")),h=t.item;if(!e.actor)return;u.some(D=>D.startsWith("target"))||u.push(...e.actor.getSelfRollOptions("target"));let m=n>0?"damage-received":"healing-received",d=n>0?await Fa({affects:"target",origin:t.actor,target:e.actor,item:t.item,domains:[m],options:u}):[],g=e.actor.getContextualClone(f,d),p=new Set([...u.filter(D=>!/^(?:self|target):/.test(D)),...f,...g.getSelfRollOptions()]),v=t.flags.pf2e.context?.outcome,k=[],P=[];if(typeof l=="number"&&l<0){let D=v==="criticalSuccess",U=(()=>h?.isOfType("spell")?{spell:h}:h?.isOfType("weapon")?{weapon:h}:{})(),_=_a(g.synthetics.damageDice,[m],{resolvables:U,test:p}).filter(S=>(S.critical===null||S.critical===D)&&S.predicate.test(p));for(let S of _){let X=`${S.diceNumber}${S.dieSize}[${S.label}]`,Z=await new Roll(X).evaluate({async:!0});Z._formula=`${S.diceNumber}${S.dieSize}`,await Z.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:S.label,speaker:ChatMessage.getSpeaker({token:e})}),k.push(`${S.label} ${S.diceNumber}${S.dieSize}`),P.push(Z)}P.length&&(l-=P.map(S=>S.total).reduce((S,X)=>S+X));let le=za(g.synthetics,[m],{resolvables:U}).filter(S=>(S.critical===null||S.critical===D)&&S.predicate.test(p));l-=Na(le??[]),k.push(...le.filter(S=>S.enabled).map(S=>`${S.label} ${signedInteger(S.modifier)}`))}let A=typeof l=="number"?l!==0:l.total!==0,F=(()=>A?Ua(g.synthetics.rollNotes,[m]).filter(D=>(!v||D.outcome.length===0||D.outcome.includes(v))&&D.predicate.test(p)).map(D=>D.text):[])();await g.applyDamage({damage:l,token:e,item:t.item,skipIWR:n<=0,rollOptions:p,shieldBlockRequest:i,breakdown:k,notes:F}),mn(t.id)}a(Ne,"applyDamageFromMessage");function pn(e,t,n){let o=e[t.type];return o===void 0?(t.enabled=!0,e[t.type]=t,t.modifier):n(t,o)?(o.enabled=!1,t.enabled=!0,e[t.type]=t,t.modifier-o.modifier):(t.enabled=!1,0)}a(pn,"applyStacking");function Na(e){let t=0,n={},o={},r=e.filter(i=>i.type==="ability"&&!i.ignored),s=r.reduce((i,c)=>i===null||c.force?c:i.force?i:c.modifier>i.modifier?c:i,null);for(let i of r)i.ignored=i!==s;for(let i of e){if(i.ignored){i.enabled=!1;continue}if(i.type==="untyped"){i.enabled=!0,t+=i.modifier;continue}i.modifier<0?t+=pn(o,i,LOWER_PENALTY):t+=pn(n,i,HIGHER_BONUS)}return t}a(Na,"applyStackingRules");function Ga(e,t,n){return Array.from(new Set(t.flatMap(r=>e[r]??[]))).filter(r=>[n,null].includes(r.slug))}a(Ga,"extractModifierAdjustments");function za(e,t,n){let{modifierAdjustments:o,modifiers:r}=e,s=Array.from(new Set(t)).flatMap(i=>r[i]??[]).flatMap(i=>i(n)??[]);for(let i of s)i.adjustments=Ga(o,t,i.slug);return s}a(za,"extractModifiers");function mn(e){for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action$=shield-block]`;$(document).find(n).removeClass("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}a(mn,"toggleOffShieldBlock");function Ba(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}a(Ba,"htmlQuery");function gn(e,t,n){let o=a(()=>[e],"getTokens"),r=a(s=>s[0].actor.itemTypes.armor.filter(l=>l.isEquipped&&l.isShield).filter(l=>!l.isBroken),"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:$(n).find("div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let s=o();if(!s.length)return!1;let i=r(s),c=s.length===1&&i.length>1,l=t.classList.contains("shield-activated");return c&&!l?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(s,i,c)=>{let l=o(),u=r(l),f=l.length===1&&u.length>1,h=t.classList.contains("shield-activated");if(f&&!h){let m=c[0],d=Ba(m,"ul.shield-options");if(!d)return c;let g=[];for(let p of u){let v=document.createElement("input");v.classList.add("data"),v.type="radio",v.name="shield-id",v.value=p.id,v.addEventListener("click",()=>{t.dataset.shieldId=v.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,s.close()});let k=document.createElement("span");k.classList.add("label"),k.innerHTML=p.name;let P=document.createElement("span");P.classList.add("tag");let A=game.i18n.localize("PF2E.HardnessLabel");P.innerHTML=`${A}: ${p.hardness}`;let F=document.createElement("li");F.classList.add("item"),F.append(v,k,P),g.push(F)}d.replaceChildren(...g)}return c}}).tooltipster("open")}a(gn,"onClickShieldBlock");function hn(e,{collisionOrigin:t,collisionType:n="move"}={}){if(e=e instanceof MeasuredTemplateDocument?e.object:e,!canvas.scene)return[];let{grid:o,dimensions:r}=canvas;if(!(o&&r))return[];if(!e?.highlightId)return[];let s=o.getHighlightLayer(e.highlightId);if(!s||o.type!==CONST.GRID_TYPES.SQUARE)return[];let i=t??e.center,c=canvas.tokens.quadtree.getObjects(s.getLocalBounds(void 0,!0)),l=[];for(let u of c){let f=u.document,h=[];for(let m=0;m<f.height;m++){let d=Math.floor(u.x/100)*100,p=Math.floor(u.y/100)*100+m*o.size;if(h.push(`${d}.${p}`),f.width>1)for(let v=1;v<f.width;v++)h.push(`${d+v*o.size}.${p}`)}for(let m of h){if(!s.positions.has(m))continue;let[d,g]=m.split(".").map(k=>Number(k)),p={x:d+r.size*.5,y:g+r.size*.5};if(p.x<0||p.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(i,p,{type:n,mode:"any"}))){l.push(u);break}}}return l}a(hn,"getTemplateTokens");var ja={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},qa=["criticalFailure","failure","success","criticalSuccess"],Wa=M("preCreateChatMessage",Ya),kn=M("renderChatMessage",Ka),Sn=M("createMeasuredTemplate",Va),Ie=!1;function wn(){return{settings:[{name:"target",type:Boolean,default:!1,onChange:yn},{name:"target-save",type:Boolean,default:!0},{name:"target-chat",type:Boolean,default:!1,scope:"client",onChange:e=>kn(e&&y("target"))},{name:"target-template",type:Boolean,default:!1,scope:"client",onChange:e=>Sn(e&&y("target"))}],conflicts:[],init:()=>{y("target")&&yn(!0)}}}a(wn,"registerTargetTokenHelper");function yn(e){Wa(e),kn(e),Sn(e&&y("target-template")),pe()&&(e&&!Ie?(V(bn),Ie=!0):!e&&Ie&&(Y(bn),Ie=!1))}a(yn,"setHooks");function bn(e){if(K())switch(e.type){case"target.update-save":Dn(e);break}}a(bn,"onSocket");async function Va(e,t,n){let o=game.user;if(o.id!==n)return;let r=E("target.menu"),s=e.item,i=s?.actor,c=i?i.token??i.getActiveTokens()[0]:void 0,l={title:s?.name||r("title"),content:await renderTemplate(C("target/template-menu"),{i18n:r,noSelf:!c}),buttons:{select:{icon:'<i class="fa-solid fa-bullseye-arrow"></i>',label:r("target"),callback:p=>({targets:p.find("[name=targets]:checked").val(),self:p.find("[name=self]").prop("checked"),neutral:p.find("[name=neutral]").prop("checked")})}},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-toolbelt-target-template",width:260});if(!u)return;let f=i?i.alliance:o.isGM?"opposition":"party",h=f==="party"?"opposition":f==="opposition"?"party":null,m=hn(e);window.toolbeltDebug&&(console.log("pre filter tokens:",m,m.map(p=>p.name)),console.log("alliance:",f),console.log("opposition:",h));let d=m.filter(p=>{let v=p.actor?.isOfType("creature","hazard","vehicle");if(window.toolbeltDebug&&console.log("is valid actor?",p.name,v),!v||(window.toolbeltDebug&&console.log("is token hidden?",p.name,p.document.hidden),p.document.hidden))return!1;if(window.toolbeltDebug&&console.log("is self?",p.name,c&&p===c),c&&p===c)return u.self;let k=p.actor?p.actor.alliance:p.alliance;return window.toolbeltDebug&&console.log("target alliance?",p.name,k),k===null?u.neutral:u.targets==="all"||u.targets==="allies"&&k===f||u.targets==="enemies"&&k===h});window.toolbeltDebug&&console.log("post filter tokens",m,m.map(p=>p.name));let g=d.map(p=>p.id);o.updateTokenTargets(g),o.broadcastActivity({targets:g})}a(Va,"createMeasuredTemplate");function Ya(e){if(e.isDamageRoll){let r=game.user.targets;if(r.size<1)return;W(e,"target.targets",Array.from(r.map(s=>({token:s.document.uuid,actor:s.actor.uuid}))))}let t=e.item;if(t?.type!=="spell")return;let n=t.system.defense?.save;if(!n)return;let o=(()=>t.trickMagicEntry?$(e.content).find("[data-action=spell-save]").data()?.dc:t.spellcasting?.statistic.dc.value)();typeof o=="number"&&W(e,"target.save",{...n,dc:o})}a(Ya,"preCreateChatMessage");async function Ka(e,t){let n=y("target-chat");if(n&&e.isDamageRoll){await Ja(e,t),vn(e);return}let o=e.item;if(!(!o||o.type!=="spell")){if(n&&!o.damageKinds.size){await Qa(e,t,o),vn(e);return}o.trickMagicEntry&&o.system.defense?.save&&t.find("[data-action=spell-damage]").on("click",()=>{de(e)})}}a(Ka,"renderChatMessage");function vn(e){let t=ui.chat;(t.isAtBottom||e.user._id===game.user._id)&&t.scrollBottom({waitImages:!0})}a(vn,"scrollToBottom");async function Qa(e,t,n){let o=await In(e);if(!o)return;let{targets:r,save:s}=o,i=t.find(".message-content"),c=i.find(".card-buttons");if(game.user.isGM||e.isAuthor){let u=c.find("[data-action=spell-save]"),f=$('<div class="pf2e-toolbelt-target-wrapper"></div>'),h=I("target.chat.targets.tooltip"),m=$(`<button class="pf2e-toolbelt-target-targets" title="${h}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);m.on("click",d=>Cn(d,e)),f.append(m),f.append(u),c.prepend(f)}if(n&&n.area&&!n.traits.has("aura")&&canvas.scene?.templates.some(f=>f.message===e&&f.isOwner)&&c.find(".owner-buttons .hidden.small").removeClass("hidden"),!r.length)return;let l=$('<div class="pf2e-toolbelt-target-spell"></div>');r.forEach(({template:u})=>{l.append("<hr>"),l.append(u)}),i.after(l),En(e,l,s)}a(Qa,"renderSpellChatMessage");function Cn(e,t){let n=game.user.targets;H(t,"target.targets",Array.from(n.map(o=>({token:o.document.uuid,actor:o.actor.uuid}))))}a(Cn,"addTargets");async function Ja(e,t){let n=await In(e);if(game.user.isGM||e.isAuthor){let l=I("target.chat.targets.tooltip"),u=$(`<button class="pf2e-toolbelt-target-targets" title="${l}">
        <i class="fa-solid fa-bullseye-arrow"></i>
        </button>`);u.on("click",f=>Cn(f,e)),t.find(".dice-result .dice-total").append(u)}if(!n||!n.targets.length)return;let{targets:o,save:r}=n,s=t.find(".message-content"),i=s.find(".damage-application").clone();if(!i.length)return;i.removeClass("damage-application").addClass("target-damage-application"),i.find("button > *:not(.label)").remove(),i.find("[data-action]").each(function(){let l=this.dataset.action;this.dataset.action=`target-${l}`});let c=$('<div class="pf2e-toolbelt-target-damage"></div>');o.forEach(({uuid:l,template:u,save:f})=>{c.append("<hr>"),c.append(u);let h=i.clone();h.each((m,d)=>{d.dataset.rollIndex=m,d.dataset.targetUuid=l,f&&f.result&&f.basic&&d.classList.add(f.result.success)}),c.append(h)}),s.after(c),En(e,c,r),c.find("button[data-action^=target-]").on("click",l=>tr(l,e))}a(Ja,"renderDamageChatMessage");function En(e,t,n){t.find("[data-action=ping-target]").on("click",er),t.find("[data-action=open-target-sheet]").on("click",Za),t.find("[data-action=roll-save]").on("click",o=>Xa(o,e,n))}a(En,"addHeaderListeners");async function In(e){let t=w(e,"target.targets")??[],n=(()=>{let r=w(e,"target.save");if(r)return{...r,...ja[r.statistic]}})();if(!t.length&&!n)return;if(n){let r=`${game.i18n.localize(n.label)} DC ${n.dc}`;n.tooltip=r}return{targets:(await Promise.all(t.map(async({token:r})=>{let s=await fromUuid(r);if(!s?.isOwner)return;let i=n&&!!s.actor.saves[n.statistic],c=(()=>{if(!i)return;let u=w(e,`target.saves.${s.id}`);if(!u)return;let f=game.i18n.localize(`PF2E.Check.Result.Degree.Check.${u.success}`);return{...u,tooltip:`${tooltip}: ${f} (<i class='fa-solid fa-dice-d20 pf2e-toolbelt-die'></i> ${u.die})`}})(),l=n&&{...n,result:c};return{uuid:r,target:s,save:l,template:await renderTemplate(C("target/row-header"),{name:s.name,uuid:r,save:i&&l})}}))).filter(Boolean),save:n}}a(In,"getMessageData");async function Ge(e){let{targetUuid:t}=e.currentTarget.closest("[data-target-uuid]").dataset;return fromUuid(t)}a(Ge,"getTargetFromEvent");async function Xa(e,t,{dc:n,statistic:o}){let r=await Ge(e),s=(()=>{let m=t.item;if(m)return m;let d=w(t,"target.messageId");if(!d)return;let g=game.messages.get(d);if(g)return g.item})(),i=r?.actor;if(!i)return;let c=i.saves[o];if(!c)return;let l=!game.user.settings.showCheckDialogs,u={dc:{value:n},item:s,origin:i,skipDialog:e.shiftKey?!l:l};y("target-save")||(u.createMessage=!1);let f=await c.check.roll(u),h={type:"target.update-save",target:r.id,value:f.total,die:f.dice[0].total,success:f.degreeOfSuccess};game.user.isGM||t.isAuthor?(h.message=t,Dn(h)):(h.message=t.id,L(h))}a(Xa,"rollSave");function Dn({message:e,target:t,value:n,success:o,die:r}){typeof e=="string"&&(e=game.messages.get(e),!e)||(typeof o=="number"&&(o=qa[o]),H(e,`target.saves.${t}`,{value:n,success:o,die:r}))}a(Dn,"updateMessageSave");async function Za(e){let t=await Ge(e);t&&t.actor?.sheet.render(!0)}a(Za,"openTargetSheet");async function er(e){if(!canvas.ready)return;let t=await Ge(e);t&&canvas.ping(t.center)}a(er,"pingTarget");async function tr(e,t){let n=e.currentTarget,{rollIndex:o,targetUuid:r}=n.closest("[data-target-uuid]").dataset,s=await fromUuid(r);if(!s)return;let i=n.dataset.action;if(i==="target-shield-block"){gn(s,n,t.element);return}Ne(s,{message:t,multiplier:i==="target-apply-healing"?-1:i==="target-half-damage"?.5:i==="target-apply-damage"?1:i==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:o})}a(tr,"onTargetButton");var ce=null,G=null;function Pn(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:Tn}],conflicts:["pf2e-unided"],init:()=>{Tn()}}}a(Pn,"registerUnided");function Tn(e){e??=y("unided"),e==="disabled"?(ce&&(Hooks.off("preCreateItem",ce),ce=null),G&&(Hooks.off("preUpdateItem",G),G=null)):(ce||(ce=Hooks.on("preCreateItem",nr)),e==="all"&&!G?G=Hooks.on("preUpdateItem",or):e!=="all"&&G&&(Hooks.off("preUpdateItem",G),G=null))}a(Tn,"setHooks");function nr(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}a(nr,"preCreateItem");function or(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}a(or,"preUpdateItem");var J=E("macros.condition");async function An(e){let t=a((f,h)=>{let m=f.find("[name=condition]"),{name:d,slug:g,img:p}=m.find(":selected").data();return{type:h,slug:g,img:p,name:f.find("[name=name]").val().trim()||J("effect-name",{condition:d}),uuid:m.val(),badge:Number(f.find("[name=badge]").val()||1),unidentified:f.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:J("generate"),callback:f=>t(f,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:J("add"),callback:f=>t(f,"add")}},o=Array.from(game.pf2e.ConditionManager.conditions.values()),r=new Set(o.filter(f=>!!f.badge).map(f=>f.slug)),s=await renderTemplate(C("macros/condition"),{i18n:J,conditions:Array.from(new Set(o.sort((f,h)=>f.name.localeCompare(h.name))))}),i=a(f=>{let{name:h,slug:m}=f.find("[name=condition] :selected").data();f.find("[name=name]").prop("placeholder",J("effect-name",{condition:h}));let d=r.has(m),g=f.find("[name=badge]");g.prop("disabled",!d),d||g.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:s,title:J("title"),close:()=>null,render:f=>{i(f),f.find("[name=condition]").on("change",()=>i(f))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&r.has(c.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let u={name:c.name,type:"effect",img:c.img,system:{rules:[l],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(u):await e.createEmbeddedDocuments("Item",[u])}a(An,"permaConditionEffect");var Be=[We(),jt(),rt(),Ot(),Pn(),Ft(),Qe(),dn(),on(),pt(),zt(),qt(),wn()],Mn=new Set,je=null;Hooks.once("init",()=>{let e=pe(),t=Be.flatMap(({settings:s=[]})=>s.map(i=>{let c=i.name;return i.choices&&(i.choices=i.choices.reduce((l,u)=>(l[u]=ze(c,`choices.${u}`),l),{})),i.key=c,i.scope??="world",i.config??=!0,i.name=ze(c,"name"),i.hint=ze(c,"hint"),i})),[n,o]=["world","client"].map(s=>t.filter(i=>i.scope===s));[n,o].forEach(s=>s.forEach(i=>game.settings.register(b,i.key,i))),e&&(je=o[0].key,Hooks.on("renderSettingsConfig",ar));let r=game.modules.get(b);r.api={macros:{permaConditionEffect:An}},Be.forEach(s=>{let{init:i,conflicts:c=[],api:l,name:u}=s;if(e)for(let f of c){let h=game.modules.get(f);h?.active&&(s.conflicting=!0,Mn.add(h.title))}l&&u&&(r.api[u]=l),!s.conflicting&&i&&i(e)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Be)!t&&n&&n(e);if(e)for(let t of Mn)T("module-conflict",{name:t},!0)});function ze(e,t){return`${b}.settings.${e}.${t}`}a(ze,"settingPath");function ar(e,t){if(!je)return;t.find(`.tab[data-tab=${b}] [data-setting-id="${b}.${je}"]`).before(`<h3>${I("settings.client")}</h3>`)}a(ar,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
