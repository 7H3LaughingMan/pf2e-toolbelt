(()=>{var dt=Object.defineProperty;var wo=(e,t,n)=>t in e?dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var a=(e,t)=>dt(e,"name",{value:t,configurable:!0});var ie=(e,t,n)=>(wo(e,typeof t!="symbol"?t+"":t,n),n),Eo=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)};var ce=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)};var H=(e,t,n)=>(Eo(e,t,"access private method"),n);var S="pf2e-toolbelt";function _(e,t,n="WRAPPER"){return libWrapper.register(S,e,t,n)}a(_,"registerWrapper");function G(e,t){console.error(`an error occured in the feature '${e}' of the module '${S}' with the wrapper: '${t}'`)}a(G,"wrapperError");function I(...e){let[t,n]=e;return t=`${S}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}a(I,"localize");function Io(e){return game.i18n.has(`${S}.${e}`,!1)}a(Io,"hasLocalization");function To(e){return`${S}.${e}`}a(To,"localizePath");function P(e){let t=a((...n)=>I(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>D(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>X(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>V(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>Io(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>To(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:o})=>t(n,o),enumerable:!1,configurable:!1}}),t}a(P,"subLocalize");function ze(e,t,n,o){let s=typeof t=="string"?t:"info",r=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:o??!1;ui.notifications.notify(I(e,r),s,{permanent:i})}a(ze,"notify");function D(...e){let[t,n,o]=e;ze(t,"warning",n,o)}a(D,"warn");function X(...e){let[t,n,o]=e;ze(t,"info",n,o)}a(X,"info");function V(...e){let[t,n,o]=e;ze(t,"error",n,o)}a(V,"error");function v(e){return game.settings.get(S,e)}a(v,"getSetting");function pt(e,t){return game.settings.set(S,e,t)}a(pt,"setSetting");function we(e){return v(e)!=="disabled"}a(we,"choiceSettingIsEnabled");var gt="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",ht="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",yt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",bt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",mt="handwraps-of-mighty-blows";function vt(){return{settings:[{name:"auto-runes",type:String,default:"disabled",choices:["disabled","force","lower"],requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{let e=v("auto-runes");e!=="disabled"&&(_(gt,Do,"WRAPPER"),_(ht,Mo,"WRAPPER"),_(yt,Ro,"WRAPPER"),_(bt,$o,"WRAPPER"),e==="force"&&Hooks.on("renderPhysicalItemSheetPF2e",Fo))},ready:e=>{e&&we("auto-runes")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),X("arp.forceVariant"))}}}a(vt,"registerArp");function le(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}a(le,"isValidActor");var Ao={1:35,2:935,3:8935,4:8935},Po={1:65,2:1065,3:31065};function St(e){let t=e._source.system.traits.value,n=e._source.system.group,o=e._source.system.category,s=e._source.system.slug;return o==="unarmed"&&s!==mt?!!e.actor.itemTypes.weapon.find(r=>r.slug===mt&&r.category==="unarmed"&&r.isEquipped&&r.isInvested):n!=="shield"&&!t.includes("alchemical")&&!t.includes("bomb")}a(St,"isValidWeapon");function Do(e){try{let t=this.actor;if(!le(t,!0)||!St(this))return e();let n=this._source.system.traits.value;if(n.includes("alchemical")&&n.includes("bomb"))return e();let o=t.level,s=v("auto-runes")==="force",r=o<2?null:o<10?1:o<16?2:3,i=o<4?null:o<12?1:o<19?2:3;(this.system.runes.potency<=r||s)&&(this.system.runes.potency=r),(this.system.runes.striking<=i||s)&&(this.system.runes.striking=i)}catch{G("auto-runes",gt)}e()}a(Do,"onPrepareWeaponData");function Mo(e){e();try{if(!le(this.actor)||this.isSpecific||!St(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=Ao[n]);let o=this.system.runes.striking;o&&(t.gp-=Po[o]),t=new game.pf2e.Coins(t),(n||o)&&!this.system.runes.property.length&&(t=t.add(this._source.system.price.value)),this.system.price.value=t}catch{G("auto-runes",ht)}}a(Mo,"onPrepareWeaponDerivedData");var Oo={1:160,2:1060,3:20560,4:20560},xo={1:340,2:3440,3:49440};function Ct(e){return!0}a(Ct,"isValidArmor");function Ro(e){try{let t=this.actor;if(!le(t,!0)||!Ct(this))return e();let n=t.level,o=v("auto-runes")==="force",s=n<5?null:n<11?1:n<18?2:3,r=n<8?null:n<14?1:n<20?2:3;(this.system.runes.potency<=s||o)&&(this.system.runes.potency=s),(this.system.runes.resilient<=r||o)&&(this.system.runes.resilient=r)}catch{G("auto-runes",yt)}e()}a(Ro,"onPrepareArmorData");function $o(e){e();try{if(!le(this.actor)||this.isSpecific||!Ct(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=Oo[n]);let o=this.system.runes.resilient;o&&(t.gp-=xo[o]),t=new game.pf2e.Coins(t),(n||o)&&!this.system.runes.property.length&&(t=t.add(this._source.system.price.value)),this.system.price.value=t}catch{G("auto-runes",bt)}}a($o,"onPrepareArmorDerivedData");function Fo(e,t){let n=e.item;if(!n||!n.isOfType("weapon","armor")||!le(n.actor,!0))return;let o=["potency","striking","resilient"].map(s=>`[name="system.runes.${s}"]`).join(", ");t.find(`[data-tab=details] fieldset .form-group:has(${o})`).hide()}a(Fo,"renderPhysicalItemSheetPF2e");function M(e,t,n=()=>{}){let o=null;return function(s,r=[],i=!1){typeof r=="string"&&(r=[r]),s||=r.some(c=>v(c)),s&&!o?o=Hooks.on(e,t):!s&&o&&(Hooks.off(e,o),o=null),i||n(s)}}a(M,"createHook");function Z(e,t,n=()=>{}){let o=null;return function(s,r=!1){String(s)==="false"&&(s="disabled"),s==="disabled"&&o?(Hooks.off(e,o),o=null):s!=="disabled"&&!o&&(o=Hooks.on(e,t)),r||n(s)}}a(Z,"createChoicesHook");function kt(e,t){let n=Hooks.on(e,t),o=Hooks.events[e].findIndex(s=>s.id===n);if(o!==0){let[s]=Hooks.events[e].splice(o,1);Hooks.events[e].unshift(s)}return n}a(kt,"registerUpstreamHook");var We=M("renderEffectsPanel",Uo,Lo);function wt(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>We(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>We(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{We(!1,["effect-remove","condition-sheet"])}}}a(wt,"registerEffectsPanelHelper");function Lo(){game.pf2e.effectPanel?.render()}a(Lo,"refreshEffectsPanel");function Uo(e,t){let n=`<div>${I("effects.remove")}</div>`,o='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',s=t.find(".effect-item[data-item-id]").toArray();for(let r of s){let i=r.dataset.itemId,c=e.actor?.items.get(i);if(c&&(v("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(r.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),r.querySelector(".icon").addEventListener("contextmenu",f=>Ho(f,e),!0)),v("condition-sheet")&&c.isOfType("condition"))){let f=r.querySelector(".effect-info > h1");f.insertAdjacentHTML("beforeend",o),f.querySelector('[data-action="edit"]').addEventListener("click",d=>_o(d,e))}}}a(Uo,"renderEffectsPanel");function _o(e,t){let n=Et(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}a(_o,"onConditionSheet");function Ho(e,t){if(!e.shiftKey)return;let n=Et(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}a(Ho,"onRemoveEffect");function Et(e,t){let s=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(s)}a(Et,"getEffect");var fe=class extends FormApplication{constructor(t,n,o){super(t,n),this.onSubmitCallback=o}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};a(fe,"MoveLootPopup");function F(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}a(F,"isPlayedActor");function k(e,t,n){return e.getFlag(S,t)??n}a(k,"getFlag");function j(e,t,n){return e.setFlag(S,t,n)}a(j,"setFlag");function It(e,t){return e.unsetFlag(S,t)}a(It,"unsetFlag");function ue(e,t,n){return e.updateSource({[`flags.${S}.${t}`]:n})}a(ue,"updateSourceFlag");function de(e,t,n){e[`flags.${S}.${t}`]=n}a(de,"moduleFlagUpdate");function qe(){return CONFIG.ChatMessage.documentClass}a(qe,"getChatMessageClass");function*pe(e,t){let n=game.messages.contents,o=(t?n.findLastIndex(s=>s===t):n.length)-1;for(let s=o;s>=o-e;s--){let r=n[s];if(!r)return;yield r}}a(pe,"latestChatMessages");function B(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}a(B,"chatUUID");function Ee(e){let t=e.id,n=k(e,"target.save");n&&Hooks.once("preCreateChatMessage",o=>{ue(o,"target.messageId",t),ue(o,"target.save",n)})}a(Ee,"bindOnPreCreateSpellDamageChatMessage");function ee(e){game.socket.on(`module.${S}`,e)}a(ee,"socketOn");function te(e){game.socket.off(`module.${S}`,e)}a(te,"socketOff");function x(e){game.socket.emit(`module.${S}`,e)}a(x,"socketEmit");function ne(){return game.user===game.users.activeGM}a(ne,"isActiveGM");function Ie(){let e=game.data.users.find(t=>t._id===game.data.userId);return e&&e.role>=CONST.USER_ROLES.GAMEMASTER}a(Ie,"isUserGM");function Tt(){return game.users.some(e=>e.active&&e.isGM)}a(Tt,"isGMOnline");function At(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}a(At,"getCharacterOwner");function No(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,o)=>n.id>o.id?1:-1),t[0]||null}a(No,"getActiveOwner");function Ve(e){return No(e)===game.user}a(Ve,"isActiveOwner");function Pt(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}a(Pt,"getOwner");var Te=!1,me=null;function xt(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:Dt}],conflicts:["pf2e-giveth"],ready:e=>{v("giveth")!=="disabled"&&Dt(!0)}}}a(xt,"registerGiveth");function Dt(e){let t=game.user.isGM;e==="disabled"&&Te?(t?te(Mt):me&&(Hooks.off("dropCanvasData",me),me=null),Te=!1):e!=="disabled"&&!Te&&(t?ee(Mt):me||(me=kt("dropCanvasData",Go)),Te=!0)}a(Dt,"setup");function Mt(e){ne()&&(e.type==="giveth-condition"?zo(e):e.type==="giveth-effect"?Wo(e):qo(e))}a(Mt,"onSocket");function Go(e,t){if(!Tt())return!0;let n=Bo(t);if(!n)return!0;let o=e.tokens.placeables.slice().filter(s=>{if(!s.document.actorLink)return!1;let r=s.actor;if(!Rt(r,t.actorId)||r.isOwner)return!1;let i=s.x+(s.hitArea?.right??0),c=s.y+(s.hitArea?.bottom??0);return t.x>=s.x&&t.y>=s.y&&t.x<=i&&t.y<=c}).sort((s,r)=>r.document.sort-s.document.sort).at(0)?.actor;return o?(jo(n.actor,o,n.item,n.value),!1):!0}a(Go,"onDropCanvasData");function jo(e,t,n,o){let s=e.id,r=t.id,i=!(n instanceof Item);if(!i&&n.isOfType("physical")){let c=n.quantity;if(c<1)return D("giveth.notification.zero");if(c===1)return Ot(s,r,n.id,1,!1);new fe(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(f,d)=>{Ot(s,r,n.id,f,d)}).render(!0)}else{let c=i?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?x({type:"giveth-condition",targetId:r,value:o??1,uuid:c}):x({type:"giveth-effect",targetId:r,uuid:c})}}a(jo,"giveth");function Ot(e,t,n,o,s){x({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:o,stack:s})}a(Ot,"sendPhysicalRequest");function Rt(e,t){return!F(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}a(Rt,"isValidActor");function Bo(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let s=e.context?.origin.actor;n=s?fromUuidSync(s):null}if(!Rt(n)||!n.isOwner)return;let o=!(t instanceof Item);if(o&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!o&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}a(Bo,"getDetailsFromData");async function zo({targetId:e,uuid:t,value:n}){let o=game.actors.get(e);if(!o)return;let s=await fromUuid(t);s&&o.increaseCondition(s.slug,{min:n})}a(zo,"takethCondition");async function Wo({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let o=await fromUuid(t);if(!o)return;let s=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[s])}a(Wo,"takethEffect");async function qo({itemId:e,ownerId:t,qty:n,stack:o,targetId:s}){let r=game.actors.get(t),i=game.actors.get(s);if(!r||!i)return;let c=r.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let f=c.quantity-n,d=c.toObject();d.system.quantity=n,d.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in d.system.equipped&&(d.system.equipped.invested=c.traits.has("invested")?!1:null);let l=await i.addToInventory(d,void 0,o);if(!l||(f<1?c.delete():c.update({"system.quantity":f}),v("giveth")==="no-message"))return;let h=B(l.uuid,l.name,!l.isIdentified);n>1&&(h+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${I("giveth.giveth",{target:i.name})}</h4>`,content:h,speaker:ChatMessage.getSpeaker({actor:r})})}a(qo,"takethPhysical");function T(...e){return e=e.filter(t=>typeof t=="string"),`modules/${S}/templates/${e.join("/")}.hbs`}a(T,"templatePath");var oe=P("hero.templates.trade"),ge=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:oe("title"),template:T("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){oe.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:L(this.actor),targetActions:this.target?L(this.target):[],i18n:oe})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){oe.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){oe.warn("no-select");return}let o=At(this.target,!0)??Pt(this.target,!0)??game.users.activeGM;if(!o){oe.warn("no-user");return}$t({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:o.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};a(ge,"Trade");function Ae(e,t){return e.localeCompare(t,game.i18n.lang)}a(Ae,"localeCompare");function K(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}a(K,"refreshCharacterSheets");function Ke(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let o of e){let s=n.findIndex(r=>o===r);if(s===-1)return!1;n.splice(s,1)}return!0}a(Ke,"compareArrays");function Ft(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}a(Ft,"ordinalString");function Pe(e,t){if(typeof e!="object")return!1;for(;e=Reflect.getPrototypeOf(e);)if(e.constructor.name===t)return!0;return!1}a(Pe,"isInstanceOf");function De(e,t,n){return setProperty(e,`modules.${S}.${t}`,n)}a(De,"setInMemory");function he(e,t){return getProperty(e,`modules.${S}.${t}`)}a(he,"getInMemory");var Oe="pf2e-hero-actions",Lt=M("renderCharacterSheetPF2e",Jo,Yo),Vo="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",xe="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",Ko="systems/pf2e/icons/features/feats/heroic-recovery.webp",Me=!1;function _t(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>Lt(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>K()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[Oe],api:{createTable:la,removeHeroActions:ma,getHeroActions:L,useHeroAction:Bt,getHeroActionDetails:Re,drawHeroAction:jt,drawHeroActions:Nt,sendActionToChat:Kt,discardHeroActions:zt,tradeHeroAction:Gt,getDeckTable:Qe,giveHeroActions:ya,createChatMessage:$e},ready:()=>{Lt(!1,"hero")}}}a(_t,"registerHeroActions");function Yo(e){e&&!Me?(ee(Ut),Me=!0):!e&&Me&&(te(Ut),Me=!1)}a(Yo,"setupSocket");function Ut(e){switch(e.type){case"hero.trade-reject":if(e.sender.id!==game.user.id)return;Xt(e);break;case"hero.trade-accept":if(!ne())return;Jt(e);break;case"hero.trade-request":if(e.receiver.id!==game.user.id)return;ia(e);break;case"hero.trade-error":if(!e.users.includes(game.user.id))return;Qt(e.error);break}}a(Ut,"onSocket");async function Jo(e,t){let n=e.actor;F(n)&&(await Qo(t,n),Xo(t,n))}a(Jo,"renderCharacterSheetPF2e");async function Qo(e,t){let n=L(t),o=t.heroPoints.value-n.length,s=t.isOwner,r=P("hero.templates.heroActions"),i=await renderTemplate(T("hero/sheet"),{owner:s,list:n,canUse:o>=0&&s,canDraw:o>0&&s,canTrade:v("hero-trade"),mustDiscard:o<0,diff:Math.abs(o),i18n:(c,{hash:f})=>r(c,f)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(i)}a(Qo,"addActionsToSheet");function Xo(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",o=>oa(t,o)),n.find("[data-action=expand]").on("click",Ht),n.find("[data-action=use]").on("click",o=>na(t,o)),n.find("[data-action=display]").on("click",o=>ta(t,o)),n.find("[data-action=discard]").on("click",ea),n.find("[data-action=discard-selected]").on("click",()=>Zo(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>Gt(t))}a(Xo,"addSheetEvents");async function Zo(e,t){let o=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(s=>s.dataset.uuid);zt(e,o)}a(Zo,"onClickHeroActionsDiscard");function ea(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let o=Number(n.attr("data-discard")??"0"),s=n.find(".action.discarded");n.toggleClass("discardable",s.length===o)}a(ea,"onClickHeroActionDiscard");async function ta(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Kt(e,n)}a(ta,"onClickHeroActionDisplay");async function na(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Bt(e,n)}a(na,"onClickHeroActionUse");async function oa(e,t){t.preventDefault(),Nt(e)}a(oa,"onClickHeroActionsDraw");function L(e){return getProperty(e,`flags.${Oe}.heroActions`)??[]}a(L,"getHeroActions");async function Y(e,t){return e.update({[`flags.${Oe}.heroActions`]:t})}a(Y,"setHeroActions");async function Ht(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let o=t.attr("data-uuid"),s=await Re(o);if(!s)return;let r=await TextEditor.enrichHTML(s.description,{async:!0});n.find(".item-description").html(r),n.addClass("loaded")}t.toggleClass("expanded")}a(Ht,"onClickHeroActionExpand");async function Re(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,o=t instanceof JournalEntry?t.pages.contents[0]:t,s=o?.text.content;if(s)return n.uuid===Vo&&(s=s.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:o.name,description:s}}a(Re,"getHeroActionDetails");async function Nt(e){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}let t=L(e),n=e.heroPoints.value-t.length,o=[];for(let s=0;s<n;s++){let r=await jt();if(r!==void 0){if(r===null)return;t.push(r),o.push(r)}}o.length&&(Y(e,t),$e({actor:e,actions:o,label:s=>I("hero.actions-draw.header",{nb:s}),secret:!0}))}a(Nt,"drawHeroActions");function $e({actor:e,actions:t,label:n,secret:o=!1}){let{content:s,size:r}=aa(t);n=typeof n=="function"?n(r):n;let i={flavor:`<h4 class="action">${n}</h4>`,content:s,speaker:ChatMessage.getSpeaker({actor:e})};o&&v("hero-private")&&(i.type=CONST.CHAT_MESSAGE_TYPES.ROLL,i.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(i)}a($e,"createChatMessage");function aa(e){let t=e.map(({uuid:n,name:o})=>B(n,o));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}a(aa,"chatActions");function Gt(e){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}let t=L(e);if(!t||!t.length){D("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){D("hero.no-points",{nb:n.toString()});return}new ge(e).render(!0)}a(Gt,"tradeHeroAction");async function jt(){let e=await Qe(),t=P("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(r=>!r.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let o=Zt(n);if(o)return{uuid:o,name:await Wt(n,o)}}a(jt,"drawHeroAction");async function Bt(e,t){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return D("hero.use.noPoints");let o=L(e),s=o.findIndex(i=>i.uuid===t);if(s===-1)return;let r=await Re(t);r||V("hero.use.noDetails"),o.splice(s,1),r?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${Oe}.heroActions`]:o}),ChatMessage.create({flavor:`<h4 class="action">${I("hero.actions-use.header")}</h4>`,content:`<h2>${r.name}</h2>${r.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):Y(e,o)}a(Bt,"useHeroAction");async function zt(e,t){if(!e?.isOfType("character")){D("hero.onlyCharacter");return}t=typeof t=="string"?[t]:t;let n=L(e),o=[];for(let s of t){let r=n.findIndex(i=>i.uuid===s);r!==-1&&(o.push(n[r]),n.splice(r,1))}Y(e,n),$e({actor:e,actions:o,label:s=>I("hero.actions-discard.header",{nb:s})})}a(zt,"discardHeroActions");async function Wt(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}a(Wt,"getLabelfromTableResult");async function qt(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}a(qt,"getTableFromUuid");async function sa(){return qt(xe)}a(sa,"getDefaultCompendiumTable");function Vt(){return game.tables.find(e=>e.getFlag("core","sourceId")===xe)}a(Vt,"getDefaultWorldTable");async function ra(){return qt(v("hero-table"))}a(ra,"getCustomTable");async function Qe(){return await ra()??Vt()??await sa()}a(Qe,"getDeckTable");async function Kt(e,t){let n=await Re(t);if(!n)return V("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}a(Kt,"sendActionToChat");function $t(e){if(e.receiver.id===game.user.id){Yt(e);return}x({...e,type:"hero.trade-request"})}a($t,"sendTradeRequest");function Yt(e){if(game.user.isGM){Jt(e);return}x({...e,type:"hero.trade-accept"})}a(Yt,"acceptRequest");async function Jt(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){Ye(e);return}let r=L(o),i=L(s),c=r.findIndex(p=>p.uuid===t.uuid),f=i.findIndex(p=>p.uuid===n.uuid);if(c===-1||f===-1){Ye(e);return}let d=r.splice(c,1)[0],l=i.splice(f,1)[0];r.push(l),i.push(d),Y(o,r),Y(s,i);let h=B(d.uuid),m=B(l.uuid),y=P("hero.trade-success"),u=`<div style="line-height: 1.6">${y("offer",{offer:h})}</div>`;u+=`<div style="line-height: 1.6">${y("receive",{receive:m})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${y("header",{name:s.name})}</h4>`,content:u,speaker:ChatMessage.getSpeaker({actor:o})})}a(Jt,"onTradeAccepted");function Ye({sender:e,receiver:t},n="trade-error"){let o=new Set([e.id,t.id]);o.has(game.user.id)&&(o.delete(game.user.id),Qt(n)),o.size&&x({type:"hero.trade-error",users:Array.from(o),error:n})}a(Ye,"sendTradeError");function Qt(e){V("hero.trade-error")}a(Qt,"onTradeError");async function ia(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){Ye(e);return}let r=P("hero.trade-request"),i=`<p>${r("header",{sender:o.name,receiver:s.name})}</p>`;i+=`<p>${r("give",{give:B(t.uuid)})}</p>`,i+=`<p>${r("want",{want:B(n.uuid)})}</p>`,i+=`<p style="margin-bottom: 1em;">${r("accept")}</p>`,await Dialog.confirm({title:r("title"),content:await TextEditor.enrichHTML(i,{async:!0})})?Yt(e):ca(e)}a(ia,"onTradeRequest");function ca(e){if(e.sender.id===game.user.id){Xt(e);return}x({...e,type:"hero.trade-reject"})}a(ca,"rejectRequest");async function Xt({receiver:e}){let t=game.actors.get(e.cid);D("hero.trade-rejected",{name:t.name},!0)}a(Xt,"onTradeRejected");async function la(){if(!game.user.isGM){D("hero.notGM");return}let e=P("hero.templates.createTable.choice"),t=T("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:r=>{let i=r.find('.window-content input[name="type"]:checked').val(),c=r.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:i,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-create-table"});s&&(s.type==="default"?da(s.unique):fa(s.unique))}a(la,"createTable");async function fa(e){let t=await ua(e);await Je(t),t.sheet?.render(!0)}a(fa,"createCustomTable");function ua(e=!0){let t=Xe(e);return RollTable.create(t,{temporary:!1})}a(ua,"createCustomActionsTable");async function da(e){let t=P("templates.createTable.default.confirm"),n=await Vt();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let s=Xe(e);return await n.update(s),Je(n,!0)}n=await pa(e),await Je(n)}a(da,"createDefaultTable");async function pa(e=!0){let t=await fromUuid(xe),n=Xe(e,t);return RollTable.create(n,{temporary:!1})}a(pa,"createDefautActionsTable");async function Je(e,t=!1){t&&await e.normalize(),await pt("hero-table",e.uuid)}a(Je,"setTable");function Xe(e=!0,t){let n={name:I("hero.table.name"),replacement:!e,img:Ko,description:I("hero.table.description"),flags:{core:{sourceId:xe}}};return t?mergeObject(deepClone(t._source),n):n}a(Xe,"getTableSource");async function ma(){if(!game.user.isGM){D("hero.notGM");return}let e=P("hero.templates.removeActions"),t=T("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:r=>r.find('input[name="actor"]:checked').toArray().map(i=>game.actors.get(i.value)).filter(i=>i)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{actors:game.actors.filter(r=>r.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:r=>{r.on("change",'input[name="all"]',()=>ga(r)),r.on("change",'input[name="actor"]',()=>ha(r))},close:()=>null},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-remove-actions"});if(s){if(!s.length){e.warn("noSelection");return}for(let r of s)Y(r,[]);e.info("removed")}}a(ma,"removeHeroActions");function ga(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}a(ga,"removeActionsToggleAll");function ha(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),o=e.find('input[name="all"]');t.length===n.length?(o.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?o.prop("checked",!1).prop("indeterminate",!0):(o.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}a(ha,"removeActionsToggleActor");function Zt(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}a(Zt,"documentUuidFromTableResult");async function ya(e){if(!game.user.isGM){D("hero.notGM");return}let t=P("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await Qe();if(!n)return V("hero.table.drawError",!0),null;let o=n.replacement===!1,s=(await Promise.all(n.results.map(async p=>{let g=Zt(p);if(g)return{key:p.id,uuid:g,name:await Wt(p,g),drawn:p.drawn}}))).filter(Boolean),r=T("hero/dialogs/give-action"),i=await renderTemplate(r,{actions:s,isUnique:o,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:p=>({selected:p.find("[name=action]:checked").closest(".action").toArray().map(g=>g.dataset),asDrawn:p.find("[name=drawn]").prop("checked")??!1,withMessage:p.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},f={title:t("title"),content:i,buttons:c,render:p=>{p.find("[data-action=expand]").on("click",Ht)},close:()=>null},d=await Dialog.wait(f,void 0,{id:"pf2e-hero-actions-give-action"});if(!d)return;let{selected:l,asDrawn:h,withMessage:m}=d,y=L(e),u=[];for(let{uuid:p,name:g,key:b}of l){if(y.push({uuid:p,name:g}),!h)continue;let C=n.results.get(b);C&&!C.drawn&&u.push(b)}u.length&&await n.updateEmbeddedDocuments("TableResult",u.map(p=>({_id:p,drawn:!0}))),Y(e,y),m&&$e({actor:e,actions:l,label:p=>I("hero.actions-give.header",{nb:p}),secret:!0})}a(ya,"giveHeroActions");var en=P("knowledges.editLore"),ye=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return en("title",this.actor)}get template(){return T("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:k(n,"knowledges.unspecified")??"",specific:k(n,"knowledges.specific")??"",i18n:en})}async _updateObject(t,{unspecified:n,specific:o}){let s=this.object;j(s,"knowledges.unspecified",n.trim()),j(s,"knowledges.specific",o.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};a(ye,"EditLores");var tn=M("renderNPCSheetPF2e",ba);function nn(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>tn(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&v("knowledges")&&tn(!0)}}}a(nn,"registerKnowledges");function ba(e,t){let n=e.actor;F(n)&&(Sa(n,t),ka(t),Ca(n,t))}a(ba,"renderNPCSheetPF2e");function Ze(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}a(Ze,"knowledgeSelector");function va(e){new ye(e).render(!0)}a(va,"editLores");function Sa(e,t){let n=k(e,"knowledges.unspecified"),o=k(e,"knowledges.specific");if(!n&&!o)return;let s=e.identificationDCs.lore,r=Ze(t,"body","");r.find(".identification-skills").last().remove();function i(f,d,l){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:f,dc:d,adjustment:l})}</div>`}a(i,"tag");function c(f,{dc:d,start:l}){let h=f.split(",").filter(m=>m.trim()).map(m=>i(m,d,l)).join("");r.append(h)}a(c,"addTags"),c(n||"Unspecific",s[0]),c(o||"Specific",s[1])}a(Sa,"replaceLores");function Ca(e,t){Ze(t,"header","button.edit").on("click",()=>va(e))}a(Ca,"addEvents");function ka(e){let t=Ze(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}a(ka,"addEditButton");var et=P("merge.multi"),be=class extends Application{#e;#t;constructor(t,n,o){super(o),this.#t=t,this.#e=n}get title(){return et("title",this.spell)}get template(){return T("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:et})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#n.bind(this)),t.find("[data-action=cancel]").on("click",this.#o.bind(this))}async#n(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){et.error("zero"),this.close();return}let o=this.#e;if(!o)return;let s=o.item,r=o.actor;if(!r||!s)return;let i=a((f,d)=>{for(let[l,h]of Object.entries(f))for(let m=0;m<n-1;m++){let y=randomID();if(f[y]=h,d.type==="interval"){let u=d.damage[l];u&&(d.damage[y]=u)}else if(d.type==="fixed")for(let[u,p]of Object.entries(d.levels)){let g=p.damage.value[l];g&&(d.levels[u].damage.value[y]=g)}}},"updateSource"),c=deepClone(o.flags.pf2e.casting?.embeddedSpell);if(c){let f=c.system.damage,d=c.system.heightening??={};i(f,d);let l=new CONFIG.Item.documentClass(c,{parent:r});l.trickMagicEntry=s.trickMagicEntry;let h=o.getFlag("pf2e","origin.variant.overlays"),m=o.getFlag("pf2e","origin.castLevel")??s.rank;(l.loadVariant({overlayIds:h,castLevel:m})??l).rollDamage(this.#t)}else{let f=s.toObject(),d=f.system.damage,l=f.system.heightening??{};i(d,l),s.clone({"system.damage":d,"system.heightening":l}).rollDamage(this.#t)}s.damageKinds.size&&Ee(o),this.close()}#o(t){t.preventDefault(),this.close()}};a(be,"MultiCast");function on(){return CONFIG.Dice.rolls.find(e=>e.name==="DamageRoll")}a(on,"getDamageRollClass");var tt=M("renderChatMessage",fn,wa);function ln(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>tt(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>tt(e,"merge-damage")}],init:e=>{tt(!1,["multi-cast","merge-damage"],!0)}}}a(ln,"registerMerge");function wa(){let e=ui.chat?.element;if(e)for(let t of pe(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),fn(t,n))}}a(wa,"updateMessages");function fn(e,t){!game.user.isGM&&!e.isAuthor||(v("merge-damage")&&pn(e)?Ia(e,t):v("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&Ea(e,t))}a(fn,"renderChatMessage");function Ea(e,t){if(!e.item)return;let o=t.find(".message-content .chat-card .owner-buttons .spell-button");o.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${I("merge.spell.button")}</button>`),o.find("[data-action=multi-cast]").on("click",s=>{new be(s,e).render(!0)})}a(Ea,"renderSpell");function Ia(e,t){let n='<span class="pf2e-toolbelt-merge">';if(k(e,"merge.merged")){let i=I("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${i}">`,n+='<i class="fa-duotone fa-split"></i>'}let o=I("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${o}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let s=rn(e),r=cn(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",i=>{i.stopPropagation();for(let c of pe(5,e)){let f=cn(c);if(!(!pn(c)||rn(c)!==s||!Ke(r?.map(d=>d.actor).filter(Boolean),f?.map(d=>d.actor).filter(Boolean)))){Aa(i,e,c,{actorUUID:s,targetUUIDs:r});return}}D("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",i=>{i.stopPropagation(),Ta(i,e)})}a(Ia,"renderDamage");async function Ta(e,t){let n=k(t,"merge.data").flatMap(o=>o.source);await un(t.id),await qe().createDocuments(n)}a(Ta,"splitDamages");async function Aa(e,t,n,{actorUUID:o,targetUUIDs:s}){let r={},i=an(n).concat(an(t));for(let{name:u,notes:p,outcome:g,modifiers:b,tags:C}of i)r[u]??={name:u,tags:C,notes:new Set,results:[]},p.forEach(r[u].notes.add,r[u].notes),r[u].results.some(E=>E.outcome===g&&Ke(E.modifiers,b))||r[u].results.push({outcome:g,modifiers:b});let c=Object.values(r).map(u=>(u.label=u.name,u.results.forEach(p=>{p.outcome&&(p.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${p.outcome}`))}),u));c.at(-1).isLastGroup=!0;let f=await renderTemplate(T("merge/merged"),{groups:c,hasMultipleGroups:c.length>1}),d=sn(t),l=sn(n),h=[];for(let u of[].concat(l,d)){let{options:p,total:g,terms:b}=u,C=b[0],O=u.formula.replaceAll(/(\[[\w,]+\])/g,"").replace(/^\(/,"").replace(/\)$/,""),E=h.find(({options:{flavor:A,critRule:R}})=>A===p.flavor&&R===p.critRule);E?(E.terms.push(C),E.total+=g,E.formulas.push(O)):h.push({options:p,formulas:[O],total:g,terms:[C]})}let m=on();for(let u of h){if(u.options.flavor.includes("persistent")){let{index:p}=u.formulas.reduce((g,b,C)=>{let O=new m(b).expectedValue;return O>g.value&&(g={value:O,index:C}),g},{value:0,index:-1});u.formulas=[u.formulas[p]],u.terms=[u.terms[p]]}u.formula=`(${u.formulas.join(" + ")})[${u.options.flavor}]`,u.term=u.terms.length<2?u.terms[0]:dn(u.terms)}let y={class:"DamageRoll",options:{},dice:[],formula:`{${h.map(({formula:u})=>u).join(", ")}}`,total:h.reduce((u,{total:p})=>u+p,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:h.map(({formula:u})=>u),modifiers:[],rolls:h.map(({options:u,formula:p,total:g,term:b})=>({class:"DamageInstance",options:u,dice:[],formula:p,total:g,terms:[b],evaluated:!0})),results:h.map(({total:u})=>({result:u,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let u=a(p=>{"results"in p?p.results.forEach(g=>g.hidden=!0):(p.term??p).operands?.forEach(g=>u(g))},"setHidden");y.terms[0].rolls.forEach(p=>p.terms.forEach(g=>u(g)))}await un(t.id,n.id),await qe().create({flavor:f,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[S]:{merge:{actor:o,targets:s,merged:!0,type:"damage-roll",data:i},target:{targets:s}},pf2e:{context:{options:Array.from(new Set(i.flatMap(u=>u.itemTraits)))}}},rolls:[y]})}a(Aa,"mergeDamages");function an(e){let t=k(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let o=$(`<div>${e.flavor}</div>`),s=o.find("h4.action + .tags").prop("outerHTML"),r=[];o.find(".tag.tag_transparent").each(function(){r.push(this.innerHTML)});let i=n.flags.pf2e.context.notes.map(({title:c,text:f})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(f)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>c.startsWith("item:")),modifiers:r,tags:s,notes:i}]}a(an,"getMessageData");function un(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}a(un,"removeChatMessages");function dn(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?dn(e):e[0]]}}}a(dn,"createTermGroup");function sn(e){return k(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}a(sn,"getMessageRolls");function rn(e){return k(e,"merge.actor")??e.actor?.uuid}a(rn,"getActorUUID");function cn(e){let t=k(e,"target.targets");if(t)return t;let n=k(e,"merge.targets")??e.getFlag("pf2e","target");return Array.isArray(n)?n:n?[n]:[]}a(cn,"getTargetUUIDs");function pn(e){return k(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}a(pn,"isDamageRoll");var mn=Z("renderChatMessage",hn,Pa);function gn(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>mn(e)}],init:e=>{!e&&v("modifiers")!=="disabled"&&mn(!0,!0)}}}a(gn,"registerHideModifiers");function Pa(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of pe(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),hn(t,n))}}a(Pa,"updateMessages");function hn(e,t){let n=e.speaker,o=ChatMessage.getSpeakerActor(n);if(!o||o.hasPlayerOwner)return;let s=t.find(".message-header");v("modifiers")==="traits"&&s.addClass("pf2e-toolbelt-modifiers-traits"),v("modifiers")!=="disabled"&&s.addClass("pf2e-toolbelt-modifiers")}a(hn,"renderChatMessage");var yn="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",bn="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function vn(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{v("nobulk")&&_(yn,Ma,"WRAPPER"),v("nobulk-coins")&&_(bn,Da,"WRAPPER")}}}a(vn,"registerNobulk");function Da(e){e();try{this.isCoinage&&(this.system.bulk.value=0)}catch{G("nobulk",bn)}}a(Da,"treasurePrepareBaseData");function Ma(e,...t){e(...t);try{let n=this,o=n.inventory.bulk.constructor,s=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return s||(s=o.computeTotalBulk(this.actor.inventory.filter(r=>!r.isInContainer&&r.system.equipped.carryType!=="dropped"),this.actor.size),s)}})}catch{G("nobulk",yn)}}a(Ma,"actorPrepareEmbeddedDocuments");var Oa="CONFIG.Actor.documentClass.prototype.prepareData",xa="DocumentSheet.prototype._renderInner";function Sn(){return{settings:[{name:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{v("share")!=="disabled"&&(_(Oa,_a,"WRAPPER"),_(xa,Ra,"WRAPPER"),Hooks.on("preUpdateActor",Fa),Hooks.on("deleteActor",$a),Hooks.on("updateActor",La))}}}a(Sn,"registerShare");async function Ra(e,...t){let n=await e(...t);if(!Pe(this,"CreatureConfig"))return n;let o=this.actor;if(!F(o)||!o.isOfType("character","npc")||ve(o).size)return n;let s=game.actors.filter(i=>i.id!==o.id&&i.isOwner&&Le(i)).map(i=>({key:i.id,label:i.name})),r=await renderTemplate(T("share/master"),{masters:s,master:k(o,"share.master"),selectPath:`flags.${S}.share.master`,i18n:P("share.templates.master")});return n.children().last().before(r),n}a(Ra,"documentSheetRenderInner");function $a(e){Tn(e);let t=ve(e);Promise.all(t.map(async n=>{kn(n),await It(n,"share.master")}))}a($a,"deleteActor");function Fa(e,t){let n=getProperty(t,`flags.${S}.share`);if(n?.master){let o=game.actors.get(n.master);if(Le(o)){let s=deepClone(o._source.system.attributes.hp);setProperty(t,"system.attributes.hp",s)}}else{let o=Fe(e),s=getProperty(t,"system.attributes.hp");o&&s&&(o.update({system:{attributes:{hp:s}}},{noHook:!0}),delete t.system.attributes.hp)}}a(Fa,"preUpdateActor");function La(e,t,n,o){let s=game.user.id===o,r=Na(t);if(r?.master!==void 0){let c=e;if(Tn(c),r.master){let f=game.actors.get(r.master);Le(f)&&(Cn(c,f),In(f,c))}else kn(c)}if(!s)return;let i=ve(e);if(i.size){let c=getProperty(t,"system.attributes.hp");if(c){let f={system:{attributes:{hp:c}}};Promise.all(i.map(async d=>await d.update(f,{noHook:!0})))}else Promise.all(i.map(async f=>await Ua(f,t)))}}a(La,"updateActor");async function Ua(e,t){v("share")==="force"?await j(e,"toggle",!k(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}a(Ua,"refreshActor");function _a(e){e();let t=this,n=k(t,"share.master"),o=n?game.actors.get(n):void 0;if(!Le(o))return;Fe(this)||(Cn(this,o),In(o,this));let s=this.system.attributes.hp;Object.defineProperty(t.system.attributes,"hp",{get(){let r=o.system.attributes.hp;return Ha(r,s),s},enumerable:!0})}a(_a,"prepareData");function Ha(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}a(Ha,"transfertHpData");function Na(e){return getProperty(e,`flags.${S}.share`)}a(Na,"getShareFlag");function ve(e){return wn(e,"slaves")??new Collection}a(ve,"getSlaves");function Cn(e,t){En(e,"master",t)}a(Cn,"setMaster");function kn(e){Ga(e,"master")}a(kn,"unsetMaster");function Fe(e){return wn(e,"master")}a(Fe,"getMaster");function Le(e){return e&&e.type==="character"&&!Fe(e)}a(Le,"isValidMaster");function wn(e,t){return getProperty(e,`modules.${S}.share.${t}`)}a(wn,"getModuleProperty");function En(e,t,n){setProperty(e,`modules.${S}.share.${t}`,n)}a(En,"setModuleProperty");function Ga(e,t){delete e.modules?.[S]?.share?.[t]}a(Ga,"deleteModuleProperty");function In(e,t){let n=ve(e);En(e,"slaves",n.set(t.id,t))}a(In,"addSlaveToMaster");function Tn(e){let t=Fe(e);if(!t)return;ve(t).delete(e.id)}a(Tn,"removeSlaveFromMaster");function An(e){return e.getFlag("core","sourceId")}a(An,"getSourceId");function ja(e,t){let n=An(e);return n?t.includes(n):!1}a(ja,"includesSourceId");function Pn(e){return Array.isArray(e)?t=>ja(t,e):t=>An(t)===e}a(Pn,"getItemSourceIdCondition");function Dn(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}a(Dn,"getItems");function Mn(e,t,n){return Dn(e,n).some(Pn(t))}a(Mn,"hasItemWithSourceId");function Ue(e,t,n){return Dn(e,n).find(Pn(t))}a(Ue,"getItemWithSourceId");var Ba=M("renderCharacterSheetPF2e",Ja),za=M("deleteCombat",Xa),Wa=M("deleteCombatant",Un),qa=M("createCombatant",Za),Va=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Ka=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),Ya=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function xn(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:On},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:nt,toggleStance:Ln,isValidStance:Rn},ready:e=>{v("stances")&&On(!0)}}}a(xn,"registerStances");function On(e){Ba(e),za(e),Wa(e),qa(e)}a(On,"setup");function Rn(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}a(Rn,"isValidStance");function nt(e){let t=[],n=new Set;for(let{replace:o,sourceId:s,effectUUID:r,effect:i,img:c,name:f,itemName:d,action:l}of $n(e)){o&&n.add(o);let h=l?Ue(e,l,"action"):Ue(e,s,"feat");t.push({name:f,itemName:d,uuid:s,img:c,effectUUID:r,effectID:i?.id,actionUUID:h.sourceId,actionID:h.id})}return t.filter(({uuid:o})=>!n.has(o))}a(nt,"getStances");async function Ja(e,t){let n=e.actor;if(!F(n))return;let o=nt(n);if(!o.length)return;let s=n.getActiveTokens(!0,!0).some(f=>f.inCombat),r=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),i=r.find(".actions-options"),c=await renderTemplate(T("stances/sheet"),{stances:o,canUseStances:s&&!n.isDead,i18n:P("stances")});i.length?i.after(c):r.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",f=>Qa(f,n))}a(Ja,"renderCharacterSheetPF2e");function Qa(e,t){let n=e.currentTarget,o=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!o)return;let s=n.dataset.effectUuid;Ln(t,s)}a(Qa,"onToggleStance");function*$n(e){for(let t of e.itemTypes.feat){let n=t.sourceId,o=Ka.get(n),s=Ya.get(n);if(!o&&!s&&!Rn(t))continue;let r=o?.effect??s?.effect??t.system.selfEffect.uuid,i=fromUuidSync(r);i&&(yield{name:(o&&fromUuidSync(o.replace)?.name)??t.name,itemName:t.name,replace:o?.replace,extra:s,sourceId:n,effectUUID:r,effect:Ue(e,r,"effect"),action:s?.action,img:i.img})}}a($n,"actorStances");function Fn(e){let t=[];for(let{effect:n}of $n(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}a(Fn,"getStancesEffects");async function Ln(e,t){let n=Fn(e),o=n.findIndex(r=>r.uuid===t),s=!1;if(o===-1)s=!0;else{let r=n.filter(c=>c.uuid!==t).length,i=n.filter(c=>c.uuid===t).length>1;(r||i)&&n.splice(o,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(r=>r.id)),s&&ot(e,t)}a(Ln,"toggleStance");async function ot(e,t){let n=await fromUuid(t);if(n){let o=n.toObject();return getProperty(o,"flags.core.sourceId")||setProperty(o,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[o]))[0]?.toMessage(),!0}return!1}a(ot,"addStance");function Xa(e){for(let t of e.combatants)Un(t)}a(Xa,"deleteCombat");function Un(e){let t=_n(e);if(t){if(!game.user.isGM&&Ve(t)){let n=Fn(t).map(o=>o.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}K(t)}}a(Un,"deleteCombatant");function Za(e){let t=_n(e);t&&(!game.user.isGM&&Ve(t)&&es(t),K(t))}a(Za,"createCombatant");function _n(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}a(_n,"getActorFromCombatant");async function es(e){let t=nt(e);if(!(!t.length||t.filter(({effectID:s})=>s).length||!Mn(e,Va,["feat"])))if(t.length===1){let s=t[0];await ot(e,s.effectUUID)&&X("stances.useStance",{stance:s.name})}else ts(e,t)}a(es,"checkForSavant");async function ts(e,t){let n=P("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(T("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:o=>ot(e,o.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}a(ts,"openStancesMenu");var Hn=Z("renderCharacterSheetPF2e",ns,()=>K());function Nn(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>Hn(e)}],conflicts:["pf2e-spells-summary"],init:e=>{v("summary")!=="disabled"&&Hn(!0,!0)}}}a(Nn,"registerSpellsSummary");async function ns(e,t){let n=e.actor;if(!F(n))return;let o=Se(t);he(e,"toggled")&&o.addClass("toggled"),gs(t).on("click",s=>ms(s,t,e)),await os(t,e,n),o.hasClass("toggled")&&o.hasClass("active")&&e._restoreScrollPositions(t)}a(ns,"renderCharacterSheetPF2e");async function os(e,t,n){let o=Se(e),s=await bs(n),r=await renderTemplate(T("summary/sheet"),s);o.append(r),as(e,t,n)}a(os,"addSummaryTab");function as(e,t,n){let o=ys(e),s=o.find(".spell-type .uses .spell-slots-input input");s.on("change",r=>ss(r,n)),s.on("focus",rs),s.on("blur",is),o.find("[data-action=cast-spell]").on("click",r=>ds(r,n)),o.find(".item-toggle-prepare").on("click",r=>cs(r,n)),o.find(".focus-pips").on("click contextmenu",r=>ls(r,n)),o.find(".spell-slots-increment-reset").on("click",r=>us(r,t,n)),o.find(".item-image").on("click",r=>ps(r,n))}a(as,"addSummaryEvents");async function ss(e,t){e.preventDefault();let{inputPath:n,entryId:o}=$(e.currentTarget).data(),s=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:o,[n]:s}])}a(ss,"onUsesInputChange");function rs(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}a(rs,"onUsesInputFocus");function is(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}a(is,"onUsesInputBlur");function cs(e,t){e.preventDefault();let{slotLevel:n,slotId:o,entryId:s,expended:r}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(s)?.setSlotExpendedState(n??0,o??0,r!==!0)}a(cs,"onTogglePrepare");function ls(e,t){e.preventDefault();let n=e.type==="click"?1:-1,o=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":o})}a(ls,"onToggleFocusPool");function fs(e,t,n){if(game.modules.get("pf2e-staves")?.active){hs(e.element).find(`.item-container.spellcasting-entry[data-item-id=${n}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click();return}let o=game.modules.get("pf2e-dailies");if(!o?.active)return;let s=t.spellcasting.get(n);o.api.updateEntryCharges(s,9999)}a(fs,"onChargesReset");function us(e,t,n){e.preventDefault();let{itemId:o,level:s,isCharge:r}=$(e.currentTarget).data();if(!o)return;if(r){fs(t,n,o);return}let i=n.items.get(o);if(i){if(i.isOfType("spellcastingEntry")){let c=s>=0&&s<=11?`slot${s}`:"slot0",f=i.system.slots?.[c];f&&i.update({[`system.slots.${c}.value`]:f.max})}else if(i.isOfType("spell")){let c=i.system.location.uses?.max;c&&i.update({"system.location.uses.value":c})}}}a(us,"onSlotsReset");function ds(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:o,slotLevel:s,slotId:r,entryId:i}=n.closest(".item").data(),c=t.spellcasting.collections.get(i);if(!c)return;let f=c.get(o);f&&c.entry.cast(f,{slot:r,level:s})}a(ds,"onCastSpell");async function ps(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id");t.items.get(n).toMessage(e)}a(ps,"onItemToChat");function ms(e,t,n){e.preventDefault();let o=Se(t);o.hasClass("active")&&(o.toggleClass("toggled"),o.scrollTop(0),De(n,"toggled",o.hasClass("toggled")))}a(ms,"onSpellcastingBtnToggle");function gs(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}a(gs,"getSpellcastingNav");function Se(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}a(Se,"getSpellcastingTab");function hs(e){return Se(e).find(".directory-list.spellcastingEntry-list")}a(hs,"getSpellcastingOriginalSection");function ys(e){return Se(e).find(".directory-list.summary")}a(ys,"getSpellcastingSummarySection");async function bs(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,o=game.modules.get("pf2e-dailies"),s=o?.active,r=n||s&&isNewerVersion(o.version,"2.14.0"),i=n?"flags.pf2e-staves.charges":s?"flags.pf2e-dailies.staff.charges":"",c=[],f=[],d=!1;if(await Promise.all(e.spellcasting.regular.map(async m=>{let y=m.id,u=m.statistic.dc.value,p=m.name,g=await m.getSheetData(),b=g.isFocusPool,C=m.system?.prepared?.value==="charge",O=(()=>{if(!C)return;let E=s&&o.api.getSpellcastingEntryStaffData(m),{charges:A,max:R,canPayCost:Q}=E??getProperty(m,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:A,max:R,noMax:!0,canPayCost:Q??(()=>!0)}})();for(let E of g.levels){if(!E.active.length||E.uses?.max===0)continue;let A=[],R=E.isCantrip,Q=!R&&C&&!r;for(let q=0;q<E.active.length;q++){let w=E.active[q];if(!w||w.uses?.max===0)continue;let{spell:U,expended:re,virtual:So,uses:Co,castLevel:ko}=w;A.push({name:U.name,img:U.img,range:U.system.range.value||"-",castLevel:ko??U.level,slotId:q,entryId:y,entryDc:u,entryName:p,itemId:U.id,inputId:g.isInnate?U.id:g.id,inputPath:C?i:g.isInnate?"system.location.uses.value":`system.slots.slot${E.level}.value`,isCharge:C,isActiveCharge:C&&r,isBroken:Q,isVirtual:So,isInnate:g.isInnate,isCantrip:R,isFocus:b,isPrepared:g.isPrepared,isSpontaneous:g.isSpontaneous||g.isFlexible,slotLevel:E.level,uses:Co??(C?O:E.uses),expended:C?!O.canPayCost(E.level):re??(b&&!R?t.value<=0:!1),action:U.system.time.value,type:C?`${S}.summary.staff`:g.isInnate?"PF2E.PreparationTypeInnate":g.isSpontaneous?"PF2E.PreparationTypeSpontaneous":g.isFlexible?"PF2E.SpellFlexibleLabel":b?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:C?0:g.isPrepared?1:b?2:g.isInnate?3:g.isSpontaneous?4:5,noHover:g.isPrepared||R||Q||b})}if(A.length){if(b)if(R)d=!0;else{f.push(...A);continue}c[E.level]??=[],c[E.level].push(...A)}}})),c.length){let m=v("summary")==="sort"?(y,u)=>y.order===u.order?Ae(y.name,u.name):y.order-u.order:(y,u)=>Ae(y.name,u.name);c.forEach(y=>y.sort(m))}f.length&&(f.sort((m,y)=>Ae(m.name,y.name)),c[12]=f,d=!1);let h=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((m,y)=>m.active.map(({spell:u})=>({name:u.name,img:u.img,slotId:y,itemId:u.id,level:u.level,time:u.system.time.value})).filter(Boolean));return{spells:c,rituals:h,focusPool:t,hasFocusCantrips:d,isOwner:e.isOwner,entryRank:m=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Ft(m)})}}a(bs,"getData");function jn(e){let t=0,n={},o={},s=e.filter(i=>i.type==="ability"&&!i.ignored),r=s.reduce((i,c)=>i===null||c.force?c:i.force?i:c.modifier>i.modifier?c:i,null);for(let i of s)i.ignored=i!==r;for(let i of e){if(i.ignored){i.enabled=!1;continue}if(i.type==="untyped"){i.enabled=!0,t+=i.modifier;continue}i.modifier<0?t+=Gn(o,i,LOWER_PENALTY):t+=Gn(n,i,HIGHER_BONUS)}return t}a(jn,"applyStackingRules");function Gn(e,t,n){let o=e[t.type];return o===void 0?(t.enabled=!0,e[t.type]=t,t.modifier):n(t,o)?(o.enabled=!1,t.enabled=!0,e[t.type]=t,t.modifier-o.modifier):(t.enabled=!1,0)}a(Gn,"applyStacking");function at(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}a(at,"htmlQuery");function Bn(e){return Error(`PF2e System | ${e}`)}a(Bn,"ErrorPF2e");var vs;function zn(e,{emptyStringZero:t=!1,zeroIsNegative:n=!1}={}){if(e===0&&t)return"";let o=vs??=new Intl.NumberFormat(game.i18n.lang,{maximumFractionDigits:0,signDisplay:"always"}),s=n&&e===0?-0:e;return o.format(s)}a(zn,"signedInteger");async function Wn({affects:e,origin:t,target:n,item:o,domains:s,options:r}){if(!(t&&n))return[];let[i,c]=e==="target"?[t,n]:[n,t],f=[...r,i.getRollOptions(s),c.getSelfRollOptions(e)].flat(),d=o?o.isOfType("spell")?{spell:o}:{weapon:o}:{};return(await Promise.all(s.flatMap(l=>i.synthetics.ephemeralEffects[l]?.[e]??[]).map(l=>l({test:f,resolvables:d})))).flatMap(l=>l??[])}a(Wn,"extractEphemeralEffects");function qn(e,t){return t.flatMap(n=>(e[n]??[]).map(o=>o.clone()))}a(qn,"extractNotes");function Vn(e,t,n){return t.flatMap(o=>e[o]??[]).flatMap(o=>o(n)??[])}a(Vn,"extractDamageDice");function Kn(e,t,n){let{modifierAdjustments:o,modifiers:s}=e,r=Array.from(new Set(t)).flatMap(i=>s[i]??[]).flatMap(i=>i(n)??[]);for(let i of r)i.adjustments=Ss(o,t,i.slug);return r}a(Kn,"extractModifiers");function Ss(e,t,n){return Array.from(new Set(t.flatMap(s=>e[s]??[]))).filter(s=>[n,null].includes(s.slug))}a(Ss,"extractModifierAdjustments");async function st(e,{message:t,multiplier:n=1,addend:o=0,promptModifier:s=!1,rollIndex:r=0}){if(s)return Cs(e,{message:t,multiplier:n,rollIndex:r});let i=CONFIG.PF2E.chatDamageButtonShieldToggle,c=t.rolls.at(r);if(!Pe(c,"DamageRoll"))throw Bn("Unexpected error retrieving damage roll");let f=n<0?n*c.total+o:c.alter(n,o),d=[...t.flags.pf2e.context?.options??[]],l=d.filter(A=>A.startsWith("self:")).map(A=>A.replace(/^self/,"origin")),h=t.item;if(!e.actor)return;d.some(A=>A.startsWith("target"))||d.push(...e.actor.getSelfRollOptions("target"));let m=n>0?"damage-received":"healing-received",y=n>0?await Wn({affects:"target",origin:t.actor,target:e.actor,item:t.item,domains:[m],options:d}):[],u=e.actor.getContextualClone(l,y),p=new Set([...d.filter(A=>!/^(?:self|target):/.test(A)),...l,...u.getSelfRollOptions()]),g=t.flags.pf2e.context?.outcome,b=[],C=[];if(typeof f=="number"&&f<0){let A=g==="criticalSuccess",R=(()=>h?.isOfType("spell")?{spell:h}:h?.isOfType("weapon")?{weapon:h}:{})(),Q=Vn(u.synthetics.damageDice,[m],{resolvables:R,test:p}).filter(w=>(w.critical===null||w.critical===A)&&w.predicate.test(p));for(let w of Q){let U=`${w.diceNumber}${w.dieSize}[${w.label}]`,re=await new Roll(U).evaluate({async:!0});re._formula=`${w.diceNumber}${w.dieSize}`,await re.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:w.label,speaker:ChatMessage.getSpeaker({token:e})}),b.push(`${w.label} ${w.diceNumber}${w.dieSize}`),C.push(re)}C.length&&(f-=C.map(w=>w.total).reduce((w,U)=>w+U));let q=Kn(u.synthetics,[m],{resolvables:R}).filter(w=>(w.critical===null||w.critical===A)&&w.predicate.test(p));f-=jn(q??[]),b.push(...q.filter(w=>w.enabled).map(w=>`${w.label} ${zn(w.modifier)}`))}let O=typeof f=="number"?f!==0:f.total!==0,E=(()=>O?qn(u.synthetics.rollNotes,[m]).filter(A=>(!g||A.outcome.length===0||A.outcome.includes(g))&&A.predicate.test(p)).map(A=>A.text):[])();await u.applyDamage({damage:f,token:e,item:t.item,skipIWR:n<=0,rollOptions:p,shieldBlockRequest:i,breakdown:b,notes:E}),Jn(t.id),Qn(t,e.id,r)}a(st,"applyDamageFromMessage");function Yn(e,t,n){let o=a(()=>[e],"getTokens"),s=a(r=>r[0]?.actor?.itemTypes.shield.filter(c=>c.isEquipped&&!c.isBroken&&!c.isDestroyed)??[],"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:$(n).find("div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let r=o();if(!r.length)return!1;let i=s(r),c=r.length===1&&i.length>1,f=t.classList.contains("shield-activated");return c&&!f?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(r,i,c)=>{let f=o(),d=s(f),l=f.length===1&&d.length>1,h=t.classList.contains("shield-activated");if(l&&!h){let m=c[0],y=at(m,"ul.shield-options");if(!y)return c;let u=[];for(let p of d){let g=document.createElement("input");g.classList.add("data"),g.type="radio",g.name="shield-id",g.value=p.id,g.addEventListener("click",()=>{t.dataset.shieldId=g.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,r.close()});let b=document.createElement("span");b.classList.add("label"),b.innerHTML=p.name;let C=document.createElement("span");C.classList.add("tag");let O=game.i18n.localize("PF2E.HardnessLabel");C.innerHTML=`${O}: ${p.hardness}`;let E=document.createElement("li");E.classList.add("item"),E.append(g,b,C),u.push(E)}y.replaceChildren(...u)}return c}}).tooltipster("open")}a(Yn,"onClickShieldBlock");function Jn(e){for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action=shield-block]`;at(document.body,n)?.classList.remove("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}a(Jn,"toggleOffShieldBlock");async function Cs(e,{message:t,multiplier:n,rollIndex:o}){let s=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),r=a(class extends Dialog{activateListeners(c){super.activateListeners(c),c[0].querySelector("input")?.focus()}},"AdjustmentDialog"),i=n<0;new r({title:game.i18n.localize(i?"PF2E.UI.shiftModifyHealingTitle":"PF2E.UI.shiftModifyDamageTitle"),content:s,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async c=>{let f=(Number(c[0].querySelector("input")?.value)||0)*Math.sign(n);st(e,{message:t,multiplier:n,addend:f,promptModifier:!1,rollIndex:o})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{Jn(t.id)}}).render(!0)}a(Cs,"shiftAdjustDamage");var _e={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},Xn=["criticalFailure","failure","success","criticalSuccess"],Ne,Zn,ae,He,J,Ce,Ge,eo,z=class{constructor(t,n,o=null){ce(this,Ne);ce(this,ae);ce(this,J);ce(this,Ge);t instanceof Roll?(this.dieResult=(t.isDeterministic?t.terms.find(s=>s instanceof NumericTerm):t.dice.find(s=>s instanceof Die&&s.faces===20))?.total??1,this.rollTotal=t.total):(this.dieResult=t.dieValue,this.rollTotal=t.dieValue+t.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=H(this,Ge,eo).call(this),this.adjustment=H(this,Ne,Zn).call(this,this.unadjusted,o),this.value=this.adjustment?H(this,ae,He).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},N=z;a(N,"DegreeOfSuccess"),Ne=new WeakSet,Zn=a(function(t,n){if(!n)return null;for(let o of["all",...Xn]){let{label:s,amount:r}=n[o]??{};if(r&&s&&!(t===z.CRITICAL_SUCCESS&&r===_e.INCREASE)&&!(t===z.CRITICAL_FAILURE&&r===_e.LOWER)&&(o==="all"||Xn.indexOf(o)===t))return{label:s,amount:r}}return null},"#getDegreeAdjustment"),ae=new WeakSet,He=a(function(t,n){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+t,0,3)}},"#adjustDegreeOfSuccess"),J=new WeakSet,Ce=a(function(t){return this.dieResult===20?H(this,ae,He).call(this,_e.INCREASE,t):this.dieResult===1?H(this,ae,He).call(this,_e.LOWER,t):t},"#adjustDegreeByDieValue"),Ge=new WeakSet,eo=a(function(){let t=this.dc.value;return this.rollTotal-t>=10?H(this,J,Ce).call(this,z.CRITICAL_SUCCESS):t-this.rollTotal>=10?H(this,J,Ce).call(this,z.CRITICAL_FAILURE):this.rollTotal>=t?H(this,J,Ce).call(this,z.SUCCESS):H(this,J,Ce).call(this,z.FAILURE)},"#calculateDegreeOfSuccess"),ie(N,"CRITICAL_FAILURE",0),ie(N,"FAILURE",1),ie(N,"SUCCESS",2),ie(N,"CRITICAL_SUCCESS",3);function to(e,{collisionOrigin:t,collisionType:n="move"}={}){if(e=e instanceof MeasuredTemplateDocument?e.object:e,!canvas.scene)return[];let{grid:o,dimensions:s}=canvas;if(!(o&&s))return[];if(!e?.highlightId)return[];let r=o.getHighlightLayer(e.highlightId);if(!r||o.type!==CONST.GRID_TYPES.SQUARE)return[];let i=t??e.center,c=canvas.tokens.quadtree.getObjects(r.getLocalBounds(void 0,!0)),f=o.size,d=[];for(let l of c){let h=l.document,m=[];for(let y=0;y<h.height;y++){let u=Math.floor(l.x/f)*f,g=Math.floor(l.y/f)*f+y*f;if(m.push(`${u}.${g}`),h.width>1)for(let b=1;b<h.width;b++)m.push(`${u+b*f}.${g}`)}for(let y of m){if(!r.positions.has(y))continue;let[u,p]=y.split(".").map(C=>Number(C)),g={x:u+s.size*.5,y:p+s.size*.5};if(g.x<0||g.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(i,g,{type:n,mode:"any"}))){d.push(l);break}}}return d}a(to,"getTemplateTokens");var ks={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},rt={hero:{icon:"fa-solid fa-hospital-symbol",reroll:"PF2E.RerollMenu.HeroPoint",rerolled:"PF2E.RerollMenu.MessageHeroPoint"},new:{icon:"fa-solid fa-dice",reroll:"PF2E.RerollMenu.KeepNew",rerolled:"PF2E.RerollMenu.MessageKeep.new"},lower:{icon:"fa-solid fa-dice-one",reroll:"PF2E.RerollMenu.KeepLower",rerolled:"PF2E.RerollMenu.MessageKeep.lower"},higher:{icon:"fa-solid fa-dice-six",reroll:"PF2E.RerollMenu.KeepHigher",rerolled:"PF2E.RerollMenu.MessageKeep.higher"}},ws=["criticalFailure","failure","success","criticalSuccess"],Es=M("preCreateChatMessage",As),ro=Z("renderChatMessage",Ps),io=M("createMeasuredTemplate",Is),je=!1;function co(){return{settings:[{name:"target",type:Boolean,default:!1,onChange:no},{name:"target-client",type:String,default:"disabled",choices:["disabled","small","big"],scope:"client",onChange:e=>ro(e&&v("target"))},{name:"target-template",type:Boolean,default:!1,scope:"client",onChange:e=>io(e&&v("target"))}],conflicts:[],init:()=>{v("target")&&no(!0)}}}a(co,"registerTargetTokenHelper");function no(e){Es(e),ro(e),io(e&&v("target-template")),Ie()&&(e&&!je?(ee(oo),je=!0):!e&&je&&(te(oo),je=!1))}a(no,"setHooks");function oo(e){if(ne())switch(e.type){case"target.update-save":it(e);break;case"target.update-applied":mo(e);break}}a(oo,"onSocket");async function Is(e,t,n){let o=game.user;if(o.id!==n)return;let s=P("target.menu"),r=e.item,i=r?.actor,c=i?i.token??i.getActiveTokens()[0]:void 0,f={title:r?.name||s("title"),content:await renderTemplate(T("target/template-menu"),{i18n:s,noSelf:!c}),buttons:{select:{icon:'<i class="fa-solid fa-bullseye-arrow"></i>',label:s("target"),callback:p=>({targets:p.find("[name=targets]:checked").val(),self:p.find("[name=self]").prop("checked"),neutral:p.find("[name=neutral]").prop("checked")})}},close:()=>null},d=await Dialog.wait(f,void 0,{id:"pf2e-toolbelt-target-template",width:260});if(!d)return;let l=i?i.alliance:o.isGM?"opposition":"party",h=l==="party"?"opposition":l==="opposition"?"party":null,u=to(e).filter(p=>{if(!p.actor?.isOfType("creature","hazard","vehicle")||p.document.hidden)return!1;if(c&&p===c)return d.self;let b=p.actor?p.actor.alliance:p.alliance;return b===null?d.neutral:d.targets==="all"||d.targets==="allies"&&b===l||d.targets==="enemies"&&b===h}).map(p=>p.id);o.updateTokenTargets(u),o.broadcastActivity({targets:u})}a(Is,"createMeasuredTemplate");var ao;function Ts(e){return ao??=(()=>{let t=[game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage"),game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage")];return new RegExp(`^<div>(${t.join("|")})</div>`)})(),ao.test(e.flavor)}a(Ts,"isRegenMessage");function lo(e){return!e.rolls[0].options.evaluatePersistent}a(lo,"isValidDamageMessage");function As(e){let t=e.isDamageRoll,n=[];if(!(t&&!lo(e))){if(t&&!k(e,"target")){let o=e.token,s=o?.actor,r=Ts(e),i=r?s?[{token:o.uuid,actor:s.uuid}]:[]:Array.from(game.user.targets.map(c=>({token:c.document.uuid,actor:c.actor.uuid})));if(n.push(["targets",i]),r&&n.push(["isRegen",!0]),e.rolls.length===2){let c=e.rolls.filter(l=>l.options),f=c.findIndex(l=>l.options.splashOnly),d=c.findIndex(l=>!l.options.splashOnly&&l.options.damage?.modifiers.some(h=>h.damageCategory==="splash"));f!==-1&&d!==-1&&n.push(["splashIndex",f])}}if(t||e.getFlag("pf2e","context.type")==="spell-cast"){let o=e.item,s=o&&o.type==="spell"&&o.system.defense?.save;if(s){let r=(()=>o.trickMagicEntry?$(e.content).find("[data-action=spell-save]").data()?.dc:o.spellcasting?.statistic.dc.value)();typeof r=="number"&&n.push(["save",{...s,dc:r}])}}n.length&&ue(e,"target",n.reduce((o,[s,r])=>(o[s]=r,o),{}))}}a(As,"preCreateChatMessage");async function Ps(e,t){let n=we("target-client");if(n&&e.isDamageRoll){if(!lo(e))return;await Ms(e,t),so(e);return}let o=e.item;if(!(!o||o.type!=="spell")){if(n&&!o.damageKinds.size){await Ds(e,t,o),so(e);return}o.trickMagicEntry&&o.system.defense?.save&&t.find("[data-action=spell-damage]").on("click",()=>{Ee(e)})}}a(Ps,"renderChatMessage");function so(e){Promise.all([ui.chat,ui.chat._popout].map(async t=>{let n=t?.element[0]?.querySelector("#chat-log");!n||!t.isAtBottom&&e.user._id!==game.user._id||(await t._waitForImages(),n.scrollTop=n.scrollHeight)}));for(let t of Object.values(e.apps))t instanceof ChatPopout&&t.rendered&&t.setPosition()}a(so,"refreshMessage");async function Ds(e,t,n){let o=await po(e);if(!o)return;let{targets:s,save:r}=o,i=t.find(".message-content"),c=i.find(".card-buttons");if(game.user.isGM||e.isAuthor){let d=c.find("[data-action=spell-save]"),l=$('<div class="pf2e-toolbelt-target-wrapper"></div>'),h=I("target.chat.targets.tooltip"),m=$(`<button class="pf2e-toolbelt-target-targets" title="${h}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);m.on("click",y=>fo(y,e)),l.append(m),l.append(d),c.prepend(l)}if(n&&n.area&&!n.traits.has("aura")&&canvas.scene?.templates.some(l=>l.message===e&&l.isOwner)&&c.find(".owner-buttons .hidden.small").removeClass("hidden"),!s.length)return;let f=$('<div class="pf2e-toolbelt-target-spell"></div>');s.forEach(({template:d})=>{f.append("<hr>"),f.append(d)}),i.after(f),uo(e,f,r)}a(Ds,"renderSpellChatMessage");function fo(e,t){e.stopPropagation();let n=game.user.targets;j(t,"target.targets",Array.from(n.map(o=>({token:o.document.uuid,actor:o.actor.uuid}))))}a(fo,"addTargets");async function Ms(e,t){let n=await po(e),o=t.find(".message-content"),s=o.find(".damage-application"),r=s.clone(),i=$('<div class="pf2e-toolbelt-target-buttons"></div>');if(n?.targets.length&&s.length){let l=a(()=>{let y=!!he(e,"target.expanded");m.toggleClass("collapse",y),s.toggleClass("hidden",!y)},"toggleDamageRow"),h=I("target.chat.toggle.tooltip"),m=$(`<button class="toggle" title="${h}">
    <i class="fa-solid fa-plus expand"></i>
    <i class="fa-solid fa-minus collapse"></i>
</button>`);l(),m.on("click",y=>{y.stopPropagation(),De(e,"target.expanded",!he(e,"target.expanded")),l()}),i.append(m)}if(n?.isRegen!==!0&&(game.user.isGM||e.isAuthor)){let l=I("target.chat.targets.tooltip"),h=$(`<button class="targets" title="${l}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);h.on("click",m=>fo(m,e)),i.append(h)}if(t.find(".dice-result .dice-total").append(i),!n?.targets.length)return;let{targets:c,save:f}=n;if(!r.length)return;r.removeClass("damage-application").addClass("target-damage-application"),v("target-client")!=="big"&&r.find("button").addClass("small"),r.find("[data-action]").each(function(){let l=this.dataset.action;this.dataset.action=`target-${l}`});let d=$('<div class="pf2e-toolbelt-target-damage"></div>');c.forEach(({uuid:l,template:h,save:m,applied:y={}})=>{let u=!!(m&&m.result&&m.basic),p=r.clone();d.append("<hr>"),d.append(h),p.each((g,b)=>{b.dataset.rollIndex=g,b.dataset.targetUuid=l,b.classList.toggle("applied",!!y[g]||u&&m.result.success==="criticalSuccess"),u&&b.classList.add(m.result.success)}),d.append(p)}),o.after(d),uo(e,d,f),d.find("button[data-action^=target-]").on("click",l=>Fs(l,e))}a(Ms,"renderDamageChatMessage");function uo(e,t,n){t.find("[data-action=ping-target]").on("click",$s),t.find("[data-action=open-target-sheet]").on("click",Rs),t.find("[data-action=roll-save]").on("click",o=>xs(o,e,n)),t.find("[data-action=reroll-save]").on("click",o=>Os(o,e,n))}a(uo,"addHeaderListeners");async function po(e){let t=k(e,"target.targets")??[],n=game.user.isGM||game.settings.get("pf2e","metagame_showDC"),o=(()=>{let r=k(e,"target.save");if(r)return{...r,...ks[r.statistic]}})();if(!t.length&&!o)return;if(o){let r=game.i18n.format("PF2E.SavingThrowWithName",{saveName:game.i18n.localize(o.label)}),i=n?I("target.chat.save.dcWithValue",{dc:o.dc}):"";o.tooltipLabel=`${r} ${i}`,o.tooltip=await renderTemplate(T("target/save-tooltip"),{check:o.tooltipLabel})}return{targets:(await Promise.all(t.map(async({token:r})=>{let i=await fromUuid(r);if(!i?.isOwner)return;let c=i.id,f=i.actor,d=o&&!!f?.saves[o.statistic],l=await(async()=>{if(!d)return;let m=k(e,`target.saves.${c}`);if(!m)return;let y=m.rerolled,u=d&&!y,p=game.i18n.localize(`PF2E.Check.Result.Degree.Check.${m.success}`),g=m.value-o.dc;return{...m,canReroll:u,tooltip:await renderTemplate(T("target/save-tooltip"),{i18n:P("target.chat.save"),check:o.tooltipLabel,result:I(`target.chat.save.result.${n?"withOffset":"withoutOffset"}`,{success:p,offset:g>=0?`+${g}`:g,die:`<i class="fa-solid fa-dice-d20"></i> ${m.die}`}),modifiers:m.modifiers,canReroll:u,rerolled:rt[y]})}})(),h=o&&{...o,result:l};return{uuid:r,target:i,save:h,applied:k(e,`target.applied.${c}`),template:await renderTemplate(T("target/row-header"),{name:i.name,uuid:r,save:d&&h,canReroll:l?.canReroll,rerolled:rt[l?.rerolled]})}}))).filter(Boolean),save:o,isRegen:k(e,"target.isRegen")}}a(po,"getMessageData");async function Be(e){let{targetUuid:t}=e.currentTarget.closest("[data-target-uuid]").dataset;return fromUuid(t)}a(Be,"getTargetFromEvent");async function Os(e,t,{dc:n}){let o=await Be(e),s=o?.actor;if(!s)return;let r=k(t,`target.saves.${o.id}`);if(!r?.roll||r.rerolled)return;let i=s.isOfType("character")?s.heroPoints.value:0,c=Object.entries(rt).map(([b,{icon:C,reroll:O}])=>{if(b==="hero"&&!i)return;let E=game.i18n.localize(O);return`<label><input type="radio" name="reroll" value="${b}"><i class="${C}"></i> ${E}</label>`}).filter(Boolean).join(""),f={yes:{icon:'<i class="fa-solid fa-rotate rotate"></i>',label:"reroll",callback:b=>b.find("[name=reroll]:checked").val()??null},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:"cancel",callback:()=>null}},d=await Dialog.wait({title:`${o.name} - ${I("target.chat.save.reroll.confirm.title")}`,content:c,buttons:f,close:()=>null},{id:`pf2e-toolbelt-target-save-reroll-dialog-${o.id}`});if(!d)return;let l=d==="hero",h=l?"new":d;if(l){let{value:b,max:C}=s.heroPoints;if(b<1){D("target.chat.save.reroll.noPoints");return}await s.update({"system.resources.heroPoints.value":Math.clamped(b-1,0,C)})}let m=Roll.fromJSON(r.roll),y=m.clone();y.options.isReroll=!0,Hooks.callAll("pf2e.preReroll",Roll.fromJSON(r.roll),y,l,h);let u=await y.evaluate({async:!0});Hooks.callAll("pf2e.reroll",Roll.fromJSON(r.roll),u,l,h);let p=h==="higher"&&m.total>u.total||h==="lower"&&m.total<u.total?m:u;if(p===u){let b=new N(u,n,r.dosAdjustments);p.options.degreeOfSuccess=b.value}let g={type:"target.update-save",target:o.id,data:{value:p.total,die:p.dice[0].total,success:p.degreeOfSuccess,roll:JSON.stringify(p.toJSON()),dosAdjustments:deepClone(r.dosAdjustments),modifiers:deepClone(r.modifiers),rerolled:d}};p.options.keeleyAdd10&&g.data.modifiers.push({label:I("target.chat.save.reroll.keeley"),modifier:10}),game.user.isGM||t.isAuthor?(g.message=t,it(g)):(g.message=t.id,x(g))}a(Os,"rerollSave");async function xs(e,t,{dc:n,statistic:o}){let s=await Be(e),r=s?.actor;if(!r)return;let i=r.saves[o];if(!i)return;let c=(()=>{let l=t.item;if(l)return l;let h=k(t,"target.messageId");if(!h)return;let m=game.messages.get(h);if(m)return m.item})(),f=!game.user.settings.showCheckDialogs,d={type:"target.update-save",target:s.id};i.check.roll({dc:{value:n},item:c,origin:r,skipDialog:e.shiftKey?!f:f,createMessage:!1,callback:(l,h,m)=>{d.data={value:l.total,die:l.dice[0].total,success:l.degreeOfSuccess,roll:JSON.stringify(l.toJSON()),dosAdjustments:m.getFlag("pf2e","context.dosAdjustments"),modifiers:m.getFlag("pf2e","modifiers").filter(y=>y.enabled).map(({label:y,modifier:u})=>({label:y,modifier:u}))},game.user.isGM||t.isAuthor?(d.message=t,it(d)):(d.message=t.id,x(d))}})}a(xs,"rollSave");function it({message:e,target:t,data:n}){typeof e=="string"&&(e=game.messages.get(e),!e)||(typeof n.success=="number"&&(n.success=ws[n.success]),j(e,`target.saves.${t}`,deepClone(n)))}a(it,"updateMessageSave");async function Rs(e){let t=await Be(e);t&&t.actor?.sheet.render(!0)}a(Rs,"openTargetSheet");async function $s(e){if(!canvas.ready)return;let t=await Be(e);t&&canvas.ping(t.center)}a($s,"pingTarget");async function Fs(e,t){let n=e.currentTarget,{rollIndex:o,targetUuid:s}=n.closest("[data-target-uuid]").dataset,r=await fromUuid(s);if(!r)return;let i=n.dataset.action;if(i==="target-shield-block"){Yn(r,n,t.element);return}st(r,{message:t,multiplier:i==="target-apply-healing"?-1:i==="target-half-damage"?.5:i==="target-apply-damage"?1:i==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:Number(o)})}a(Fs,"onTargetButton");function Qn(e,t,n){let o={};de(o,`target.applied.${t}.${n}`,!0);let s=k(e,"target.splashIndex");if(s!==void 0){let r=s===0?1:0;if(n===s)de(o,`target.applied.${t}.${r}`,!0);else{de(o,`target.applied.${t}.${s}`,!0);let i=k(e,"target.targets")??[];for(let c of i){let f=c.token?.split(".").at(-1);f!==t&&de(o,`target.applied.${f}.${r}`,!0)}}}game.user.isGM||e.isAuthor?mo({message:e,updates:o}):x({type:"target.update-applied",message:e.id,updates:o})}a(Qn,"onDamageApplied");function mo({message:e,updates:t}){typeof e=="string"&&(e=game.messages.get(e),!e)||e.update(t)}a(mo,"updateMessageApplied");var ke=null,W=null;function ho(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:go}],conflicts:["pf2e-unided"],init:()=>{go()}}}a(ho,"registerUnided");function go(e){e??=v("unided"),e==="disabled"?(ke&&(Hooks.off("preCreateItem",ke),ke=null),W&&(Hooks.off("preUpdateItem",W),W=null)):(ke||(ke=Hooks.on("preCreateItem",Ls)),e==="all"&&!W?W=Hooks.on("preUpdateItem",Us):e!=="all"&&W&&(Hooks.off("preUpdateItem",W),W=null))}a(go,"setHooks");function Ls(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}a(Ls,"preCreateItem");function Us(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}a(Us,"preUpdateItem");var _s=M("updateCombat",Hs);function yo(){return{settings:[{name:"force-untarget",type:Boolean,default:!1,onChange:ct},{name:"untarget",type:Boolean,default:!1,scope:"client",onChange:ct}],init:()=>{ct()}}}a(yo,"registerUntarget");function ct(){_s(v("force-untarget")||v("untarget"))}a(ct,"setup");function Hs(e,t){if(!("turn"in t)&&!("round"in t))return;let n=game.user;n.updateTokenTargets(),n.broadcastActivity({targets:[]})}a(Hs,"updateCombat");var se=P("macros.condition");async function bo(e){let t=a((l,h)=>{let m=l.find("[name=condition]"),{name:y,slug:u,img:p}=m.find(":selected").data();return{type:h,slug:u,img:p,name:l.find("[name=name]").val().trim()||se("effect-name",{condition:y}),uuid:m.val(),badge:Number(l.find("[name=badge]").val()||1),unidentified:l.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:se("generate"),callback:l=>t(l,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:se("add"),callback:l=>t(l,"add")}},o=Array.from(game.pf2e.ConditionManager.conditions.values()),s=new Set(o.filter(l=>!!l.badge).map(l=>l.slug)),r=await renderTemplate(T("macros/condition"),{i18n:se,conditions:Array.from(new Set(o.sort((l,h)=>l.name.localeCompare(h.name))))}),i=a(l=>{let{name:h,slug:m}=l.find("[name=condition] :selected").data();l.find("[name=name]").prop("placeholder",se("effect-name",{condition:h}));let y=s.has(m),u=l.find("[name=badge]");u.prop("disabled",!y),y||u.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:r,title:se("title"),close:()=>null,render:l=>{i(l),l.find("[name=condition]").on("change",()=>i(l))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let f={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&s.has(c.slug)&&(f.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let d={name:c.name,type:"effect",img:c.img,system:{rules:[f],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(d):await e.createEmbeddedDocuments("Item",[d])}a(bo,"permaConditionEffect");var ft=[vt(),vn(),xt(),nn(),ho(),ln(),wt(),Nn(),xn(),_t(),gn(),Sn(),co(),yo()],vo=new Set,ut=null;Hooks.once("init",()=>{let e=Ie(),t=ft.flatMap(({settings:r=[]})=>r.map(i=>{let c=i.name;return i.choices&&(i.choices=i.choices.reduce((f,d)=>(f[d]=lt(c,`choices.${d}`),f),{})),i.key=c,i.scope??="world",i.config??=!0,i.name=lt(c,"name"),i.hint=lt(c,"hint"),i})),[n,o]=["world","client"].map(r=>t.filter(i=>i.scope===r));[n,o].forEach(r=>r.forEach(i=>game.settings.register(S,i.key,i))),e&&(ut=o[0].key,Hooks.on("renderSettingsConfig",Ns));let s=game.modules.get(S);s.api={macros:{permaConditionEffect:bo}},ft.forEach(r=>{let{init:i,conflicts:c=[],api:f,name:d}=r;if(e)for(let l of c){let h=game.modules.get(l);h?.active&&(r.conflicting=!0,vo.add(h.title))}f&&d&&(s.api[d]=f),!r.conflicting&&i&&i(e)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of ft)!t&&n&&n(e);if(e)for(let t of vo)D("module-conflict",{name:t},!0)});function lt(e,t){return`${S}.settings.${e}.${t}`}a(lt,"settingPath");function Ns(e,t){if(!ut)return;t.find(`.tab[data-tab=${S}] [data-setting-id="${S}.${ut}"]`).before(`<h3>${I("settings.client")}</h3>`)}a(Ns,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
