(()=>{var ct=Object.defineProperty;var Xn=(e,t,n)=>t in e?ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var o=(e,t)=>ct(e,"name",{value:t,configurable:!0});var re=(e,t,n)=>(Xn(e,typeof t!="symbol"?t+"":t,n),n),Zn=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)};var ie=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)};var _=(e,t,n)=>(Zn(e,t,"access private method"),n);var S="pf2e-toolbelt";function L(e,t,n="WRAPPER"){return libWrapper.register(S,e,t,n)}o(L,"registerWrapper");function w(...e){let[t,n]=e;return t=`${S}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}o(w,"localize");function ea(e){return game.i18n.has(`${S}.${e}`,!1)}o(ea,"hasLocalization");function ta(e){return`${S}.${e}`}o(ta,"localizePath");function T(e){let t=o((...n)=>w(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>P(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>J(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>W(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>ea(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>ta(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:a})=>t(n,a),enumerable:!1,configurable:!1}}),t}o(T,"subLocalize");function Ge(e,t,n,a){let s=typeof t=="string"?t:"info",r=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:a??!1;ui.notifications.notify(w(e,r),s,{permanent:i})}o(Ge,"notify");function P(...e){let[t,n,a]=e;Ge(t,"warning",n,a)}o(P,"warn");function J(...e){let[t,n,a]=e;Ge(t,"info",n,a)}o(J,"info");function W(...e){let[t,n,a]=e;Ge(t,"error",n,a)}o(W,"error");function v(e){return game.settings.get(S,e)}o(v,"getSetting");function lt(e,t){return game.settings.set(S,e,t)}o(lt,"setSetting");var na="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",aa="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",oa="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",sa="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",ra=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function ft(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{v("arp")&&(L(na,ia,"WRAPPER"),L(aa,fa,"WRAPPER"),L(oa,ua,"WRAPPER"),L(sa,ma,"WRAPPER"))},ready:e=>{e&&v("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),J("arp.forceVariant"))}}}o(ft,"registerArp");function Ce(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}o(Ce,"isValidActor");function ut(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!ra.includes(e.sourceId)}o(ut,"isValidWeapon");function ia(e){let t=this.actor;if(!Ce(t,!0)||!ut(this))return e();let n=t.level,a=this._source.system.traits.value;if(a.includes("alchemical")&&a.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}o(ia,"onPrepareWeaponData");var ca={1:35,2:935,3:8935,4:8935},la={striking:65,greaterStriking:1065,majorStriking:31065};function fa(e){if(e(),!Ce(this.actor)||this.isSpecific||!ut(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.potencyRune.value;n&&(t.gp-=ca[n]);let a=this.system.strikingRune.value;a&&(t.gp-=la[a]),t=new game.pf2e.Coins(t),(n||a)&&!this.system.runes.property.length&&(t=t.add(this._source.system.price.value)),this.system.price.value=t}o(fa,"onPrepareWeaponDerivedData");function dt(e){return!e.isShield}o(dt,"isValidArmor");function ua(e){let t=this.actor;if(!Ce(t,!0)||!dt(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}o(ua,"onPrepareArmorData");var da={1:160,2:1060,3:20560,4:20560},pa={resilient:340,greaterResilient:3440,majorResilient:49440};function ma(e){if(e(),!Ce(this.actor)||this.isSpecific||!dt(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.potencyRune.value;n&&(t.gp-=da[n]);let a=this.system.resiliencyRune.value;a&&(t.gp-=pa[a]),t=new game.pf2e.Coins(t),(n||a)&&!this.system.runes.property.length&&(t=t.add(this._source.system.price.value)),this.system.price.value=t}o(ma,"onPrepareArmorDerivedData");function O(e,t,n=()=>{}){let a=null;return function(s,r=[],i=!1){typeof r=="string"&&(r=[r]),s||=r.some(c=>v(c)),s&&!a?a=Hooks.on(e,t):!s&&a&&(Hooks.off(e,a),a=null),i||n(s)}}o(O,"createHook");function Q(e,t,n=()=>{}){let a=null;return function(s,r=!1){s==="disabled"&&a?(Hooks.off(e,a),a=null):s!=="disabled"&&!a&&(a=Hooks.on(e,t)),r||n(s)}}o(Q,"createChoicesHook");function pt(e,t){let n=Hooks.on(e,t),a=Hooks.events[e].findIndex(s=>s.id===n);if(a!==0){let[s]=Hooks.events[e].splice(a,1);Hooks.events[e].unshift(s)}return n}o(pt,"registerUpstreamHook");var Be=O("renderEffectsPanel",ha,ga);function mt(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>Be(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>Be(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{Be(!1,["effect-remove","condition-sheet"])}}}o(mt,"registerEffectsPanelHelper");function ga(){game.pf2e.effectPanel?.render()}o(ga,"refreshEffectsPanel");function ha(e,t){let n=`<div>${w("effects.remove")}</div>`,a='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',s=t.find(".effect-item[data-item-id]").toArray();for(let r of s){let i=r.dataset.itemId,c=e.actor?.items.get(i);if(c&&(v("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(r.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),r.querySelector(".icon").addEventListener("contextmenu",l=>ba(l,e),!0)),v("condition-sheet")&&c.isOfType("condition"))){let l=r.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",a),l.querySelector('[data-action="edit"]').addEventListener("click",u=>ya(u,e))}}}o(ha,"renderEffectsPanel");function ya(e,t){let n=gt(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}o(ya,"onConditionSheet");function ba(e,t){if(!e.shiftKey)return;let n=gt(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}o(ba,"onRemoveEffect");function gt(e,t){let s=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(s)}o(gt,"getEffect");var ce=class extends FormApplication{constructor(t,n,a){super(t,n),this.onSubmitCallback=a}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};o(ce,"MoveLootPopup");function x(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}o(x,"isPlayedActor");function C(e,t,n){return e.getFlag(S,t)??n}o(C,"getFlag");function j(e,t,n){return e.setFlag(S,t,n)}o(j,"setFlag");function ht(e,t){return e.unsetFlag(S,t)}o(ht,"unsetFlag");function q(e,t,n){return e.updateSource({[`flags.${S}.${t}`]:n})}o(q,"updateSourceFlag");function le(e,t,n){e[`flags.${S}.${t}`]=n}o(le,"moduleFlagUpdate");function ze(){return CONFIG.ChatMessage.documentClass}o(ze,"getChatMessageClass");function*fe(e,t){let n=game.messages.contents,a=(t?n.findLastIndex(s=>s===t):n.length)-1;for(let s=a;s>=a-e;s--){let r=n[s];if(!r)return;yield r}}o(fe,"latestChatMessages");function G(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}o(G,"chatUUID");function ke(e){let t=e.id,n=C(e,"target.save");n&&Hooks.once("preCreateChatMessage",a=>{q(a,"target.messageId",t),q(a,"target.save",n)})}o(ke,"bindOnPreCreateSpellDamageChatMessage");function X(e){game.socket.on(`module.${S}`,e)}o(X,"socketOn");function Z(e){game.socket.off(`module.${S}`,e)}o(Z,"socketOff");function M(e){game.socket.emit(`module.${S}`,e)}o(M,"socketEmit");function ee(){return game.user===game.users.activeGM}o(ee,"isActiveGM");function we(){let e=game.data.users.find(t=>t._id===game.data.userId);return e&&e.role>=CONST.USER_ROLES.GAMEMASTER}o(we,"isUserGM");function yt(){return game.users.some(e=>e.active&&e.isGM)}o(yt,"isGMOnline");function bt(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}o(bt,"getCharacterOwner");function va(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,a)=>n.id>a.id?1:-1),t[0]||null}o(va,"getActiveOwner");function We(e){return va(e)===game.user}o(We,"isActiveOwner");function vt(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}o(vt,"getOwner");var Ee=!1,ue=null;function wt(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:St}],conflicts:["pf2e-giveth"],ready:e=>{v("giveth")!=="disabled"&&St(!0)}}}o(wt,"registerGiveth");function St(e){let t=game.user.isGM;e==="disabled"&&Ee?(t?Z(Ct):ue&&(Hooks.off("dropCanvasData",ue),ue=null),Ee=!1):e!=="disabled"&&!Ee&&(t?X(Ct):ue||(ue=pt("dropCanvasData",Sa)),Ee=!0)}o(St,"setup");function Ct(e){ee()&&(e.type==="giveth-condition"?wa(e):e.type==="giveth-effect"?Ea(e):Ia(e))}o(Ct,"onSocket");function Sa(e,t){if(!yt())return!0;let n=ka(t);if(!n)return!0;let a=e.tokens.placeables.slice().filter(s=>{if(!s.document.actorLink)return!1;let r=s.actor;if(!Et(r,t.actorId)||r.isOwner)return!1;let i=s.x+(s.hitArea?.right??0),c=s.y+(s.hitArea?.bottom??0);return t.x>=s.x&&t.y>=s.y&&t.x<=i&&t.y<=c}).sort((s,r)=>r.document.sort-s.document.sort).at(0)?.actor;return a?(Ca(n.actor,a,n.item,n.value),!1):!0}o(Sa,"onDropCanvasData");function Ca(e,t,n,a){let s=e.id,r=t.id,i=!(n instanceof Item);if(!i&&n.isOfType("physical")){let c=n.quantity;if(c<1)return P("giveth.notification.zero");if(c===1)return kt(s,r,n.id,1,!1);new ce(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,u)=>{kt(s,r,n.id,l,u)}).render(!0)}else{let c=i?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?M({type:"giveth-condition",targetId:r,value:a??1,uuid:c}):M({type:"giveth-effect",targetId:r,uuid:c})}}o(Ca,"giveth");function kt(e,t,n,a,s){M({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:a,stack:s})}o(kt,"sendPhysicalRequest");function Et(e,t){return!x(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}o(Et,"isValidActor");function ka(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let s=e.context?.origin.actor;n=s?fromUuidSync(s):null}if(!Et(n)||!n.isOwner)return;let a=!(t instanceof Item);if(a&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!a&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}o(ka,"getDetailsFromData");async function wa({targetId:e,uuid:t,value:n}){let a=game.actors.get(e);if(!a)return;let s=await fromUuid(t);s&&a.increaseCondition(s.slug,{min:n})}o(wa,"takethCondition");async function Ea({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let a=await fromUuid(t);if(!a)return;let s=a.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[s])}o(Ea,"takethEffect");async function Ia({itemId:e,ownerId:t,qty:n,stack:a,targetId:s}){let r=game.actors.get(t),i=game.actors.get(s);if(!r||!i)return;let c=r.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,u=c.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=c.traits.has("invested")?!1:null);let f=await i.addToInventory(u,void 0,a);if(!f||(l<1?c.delete():c.update({"system.quantity":l}),v("giveth")==="no-message"))return;let h=G(f.uuid,f.name,!f.isIdentified);n>1&&(h+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${w("giveth.giveth",{target:i.name})}</h4>`,content:h,speaker:ChatMessage.getSpeaker({actor:r})})}o(Ia,"takethPhysical");function I(...e){return e=e.filter(t=>typeof t=="string"),`modules/${S}/templates/${e.join("/")}.hbs`}o(I,"templatePath");var te=T("hero.templates.trade"),de=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:te("title"),template:I("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){te.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:F(this.actor),targetActions:this.target?F(this.target):[],i18n:te})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){te.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){te.warn("no-select");return}let a=bt(this.target,!0)??vt(this.target,!0)??game.users.activeGM;if(!a){te.warn("no-user");return}It({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:a.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};o(de,"Trade");function Ie(e,t){return e.localeCompare(t,game.i18n.lang)}o(Ie,"localeCompare");function V(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}o(V,"refreshCharacterSheets");function qe(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let a of e){let s=n.findIndex(r=>a===r);if(s===-1)return!1;n.splice(s,1)}return!0}o(qe,"compareArrays");function Tt(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}o(Tt,"ordinalString");function Te(e,t){if(typeof e!="object")return!1;for(;e=Reflect.getPrototypeOf(e);)if(e.constructor.name===t)return!0;return!1}o(Te,"isInstanceOf");function Ae(e,t,n){return setProperty(e,`modules.${S}.${t}`,n)}o(Ae,"setInMemory");function pe(e,t){return getProperty(e,`modules.${S}.${t}`)}o(pe,"getInMemory");var De="pf2e-hero-actions",At=O("renderCharacterSheetPF2e",Da,Pa),Ta="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",Oe="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",Aa="systems/pf2e/icons/features/feats/heroic-recovery.webp",Pe=!1;function Dt(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>At(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>V()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[De],api:{createTable:Ga,removeHeroActions:Va,getHeroActions:F,useHeroAction:$t,getHeroActionDetails:Me,drawHeroAction:xt,drawHeroActions:Mt,sendActionToChat:Ht,discardHeroActions:Ft,tradeHeroAction:Rt,getDeckTable:Ye,giveHeroActions:Ja,createChatMessage:Re},ready:()=>{At(!1,"hero")}}}o(Dt,"registerHeroActions");function Pa(e){e&&!Pe?(X(Pt),Pe=!0):!e&&Pe&&(Z(Pt),Pe=!1)}o(Pa,"setupSocket");function Pt(e){switch(e.type){case"hero.trade-reject":if(e.sender.id!==game.user.id)return;Bt(e);break;case"hero.trade-accept":if(!ee())return;jt(e);break;case"hero.trade-request":if(e.receiver.id!==game.user.id)return;Na(e);break;case"hero.trade-error":if(!e.users.includes(game.user.id))return;Gt(e.error);break}}o(Pt,"onSocket");async function Da(e,t){let n=e.actor;x(n)&&(await Oa(t,n),Ma(t,n))}o(Da,"renderCharacterSheetPF2e");async function Oa(e,t){let n=F(t),a=t.heroPoints.value-n.length,s=t.isOwner,r=T("hero.templates.heroActions"),i=await renderTemplate(I("hero/sheet"),{owner:s,list:n,canUse:a>=0&&s,canDraw:a>0&&s,canTrade:v("hero-trade"),mustDiscard:a<0,diff:Math.abs(a),i18n:(c,{hash:l})=>r(c,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(i)}o(Oa,"addActionsToSheet");function Ma(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",a=>La(t,a)),n.find("[data-action=expand]").on("click",Ot),n.find("[data-action=use]").on("click",a=>Fa(t,a)),n.find("[data-action=display]").on("click",a=>$a(t,a)),n.find("[data-action=discard]").on("click",xa),n.find("[data-action=discard-selected]").on("click",()=>Ra(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>Rt(t))}o(Ma,"addSheetEvents");async function Ra(e,t){let a=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(s=>s.dataset.uuid);Ft(e,a)}o(Ra,"onClickHeroActionsDiscard");function xa(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let a=Number(n.attr("data-discard")??"0"),s=n.find(".action.discarded");n.toggleClass("discardable",s.length===a)}o(xa,"onClickHeroActionDiscard");async function $a(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Ht(e,n)}o($a,"onClickHeroActionDisplay");async function Fa(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");$t(e,n)}o(Fa,"onClickHeroActionUse");async function La(e,t){t.preventDefault(),Mt(e)}o(La,"onClickHeroActionsDraw");function F(e){return getProperty(e,`flags.${De}.heroActions`)??[]}o(F,"getHeroActions");async function K(e,t){return e.update({[`flags.${De}.heroActions`]:t})}o(K,"setHeroActions");async function Ot(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let a=t.attr("data-uuid"),s=await Me(a);if(!s)return;let r=await TextEditor.enrichHTML(s.description,{async:!0});n.find(".item-description").html(r),n.addClass("loaded")}t.toggleClass("expanded")}o(Ot,"onClickHeroActionExpand");async function Me(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,a=t instanceof JournalEntry?t.pages.contents[0]:t,s=a?.text.content;if(s)return n.uuid===Ta&&(s=s.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:a.name,description:s}}o(Me,"getHeroActionDetails");async function Mt(e){if(!e?.isOfType("character")){P("hero.onlyCharacter");return}let t=F(e),n=e.heroPoints.value-t.length,a=[];for(let s=0;s<n;s++){let r=await xt();if(r!==void 0){if(r===null)return;t.push(r),a.push(r)}}a.length&&(K(e,t),Re({actor:e,actions:a,label:s=>w("hero.actions-draw.header",{nb:s}),secret:!0}))}o(Mt,"drawHeroActions");function Re({actor:e,actions:t,label:n,secret:a=!1}){let{content:s,size:r}=Ua(t);n=typeof n=="function"?n(r):n;let i={flavor:`<h4 class="action">${n}</h4>`,content:s,speaker:ChatMessage.getSpeaker({actor:e})};a&&v("hero-private")&&(i.type=CONST.CHAT_MESSAGE_TYPES.ROLL,i.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(i)}o(Re,"createChatMessage");function Ua(e){let t=e.map(({uuid:n,name:a})=>G(n,a));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}o(Ua,"chatActions");function Rt(e){if(!e?.isOfType("character")){P("hero.onlyCharacter");return}let t=F(e);if(!t||!t.length){P("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){P("hero.no-points",{nb:n.toString()});return}new de(e).render(!0)}o(Rt,"tradeHeroAction");async function xt(){let e=await Ye(),t=T("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(r=>!r.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let a=zt(n);if(a)return{uuid:a,name:await Lt(n,a)}}o(xt,"drawHeroAction");async function $t(e,t){if(!e?.isOfType("character")){P("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return P("hero.use.noPoints");let a=F(e),s=a.findIndex(i=>i.uuid===t);if(s===-1)return;let r=await Me(t);r||W("hero.use.noDetails"),a.splice(s,1),r?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${De}.heroActions`]:a}),ChatMessage.create({flavor:`<h4 class="action">${w("hero.actions-use.header")}</h4>`,content:`<h2>${r.name}</h2>${r.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):K(e,a)}o($t,"useHeroAction");async function Ft(e,t){if(!e?.isOfType("character")){P("hero.onlyCharacter");return}t=typeof t=="string"?[t]:t;let n=F(e),a=[];for(let s of t){let r=n.findIndex(i=>i.uuid===s);r!==-1&&(a.push(n[r]),n.splice(r,1))}K(e,n),Re({actor:e,actions:a,label:s=>w("hero.actions-discard.header",{nb:s})})}o(Ft,"discardHeroActions");async function Lt(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}o(Lt,"getLabelfromTableResult");async function Ut(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}o(Ut,"getTableFromUuid");async function _a(){return Ut(Oe)}o(_a,"getDefaultCompendiumTable");function _t(){return game.tables.find(e=>e.getFlag("core","sourceId")===Oe)}o(_t,"getDefaultWorldTable");async function Ha(){return Ut(v("hero-table"))}o(Ha,"getCustomTable");async function Ye(){return await Ha()??_t()??await _a()}o(Ye,"getDeckTable");async function Ht(e,t){let n=await Me(t);if(!n)return W("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}o(Ht,"sendActionToChat");function It(e){if(e.receiver.id===game.user.id){Nt(e);return}M({...e,type:"hero.trade-request"})}o(It,"sendTradeRequest");function Nt(e){if(game.user.isGM){jt(e);return}M({...e,type:"hero.trade-accept"})}o(Nt,"acceptRequest");async function jt(e){let{sender:t,receiver:n}=e,a=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!a||!s){Ve(e);return}let r=F(a),i=F(s),c=r.findIndex(m=>m.uuid===t.uuid),l=i.findIndex(m=>m.uuid===n.uuid);if(c===-1||l===-1){Ve(e);return}let u=r.splice(c,1)[0],f=i.splice(l,1)[0];r.push(f),i.push(u),K(a,r),K(s,i);let h=G(u.uuid),p=G(f.uuid),d=T("hero.trade-success"),g=`<div style="line-height: 1.6">${d("offer",{offer:h})}</div>`;g+=`<div style="line-height: 1.6">${d("receive",{receive:p})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${d("header",{name:s.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:a})})}o(jt,"onTradeAccepted");function Ve({sender:e,receiver:t},n="trade-error"){let a=new Set([e.id,t.id]);a.has(game.user.id)&&(a.delete(game.user.id),Gt(n)),a.size&&M({type:"hero.trade-error",users:Array.from(a),error:n})}o(Ve,"sendTradeError");function Gt(e){W("hero.trade-error")}o(Gt,"onTradeError");async function Na(e){let{sender:t,receiver:n}=e,a=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!a||!s){Ve(e);return}let r=T("hero.trade-request"),i=`<p>${r("header",{sender:a.name,receiver:s.name})}</p>`;i+=`<p>${r("give",{give:G(t.uuid)})}</p>`,i+=`<p>${r("want",{want:G(n.uuid)})}</p>`,i+=`<p style="margin-bottom: 1em;">${r("accept")}</p>`,await Dialog.confirm({title:r("title"),content:await TextEditor.enrichHTML(i,{async:!0})})?Nt(e):ja(e)}o(Na,"onTradeRequest");function ja(e){if(e.sender.id===game.user.id){Bt(e);return}M({...e,type:"hero.trade-reject"})}o(ja,"rejectRequest");async function Bt({receiver:e}){let t=game.actors.get(e.cid);P("hero.trade-rejected",{name:t.name},!0)}o(Bt,"onTradeRejected");async function Ga(){if(!game.user.isGM){P("hero.notGM");return}let e=T("hero.templates.createTable.choice"),t=I("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:r=>{let i=r.find('.window-content input[name="type"]:checked').val(),c=r.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:i,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},a={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},s=await Dialog.wait(a,void 0,{id:"pf2e-hero-actions-create-table"});s&&(s.type==="default"?Wa(s.unique):Ba(s.unique))}o(Ga,"createTable");async function Ba(e){let t=await za(e);await Ke(t),t.sheet?.render(!0)}o(Ba,"createCustomTable");function za(e=!0){let t=Je(e);return RollTable.create(t,{temporary:!1})}o(za,"createCustomActionsTable");async function Wa(e){let t=T("templates.createTable.default.confirm"),n=await _t();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let s=Je(e);return await n.update(s),Ke(n,!0)}n=await qa(e),await Ke(n)}o(Wa,"createDefaultTable");async function qa(e=!0){let t=await fromUuid(Oe),n=Je(e,t);return RollTable.create(n,{temporary:!1})}o(qa,"createDefautActionsTable");async function Ke(e,t=!1){t&&await e.normalize(),await lt("hero-table",e.uuid)}o(Ke,"setTable");function Je(e=!0,t){let n={name:w("hero.table.name"),replacement:!e,img:Aa,description:w("hero.table.description"),flags:{core:{sourceId:Oe}}};return t?mergeObject(deepClone(t._source),n):n}o(Je,"getTableSource");async function Va(){if(!game.user.isGM){P("hero.notGM");return}let e=T("hero.templates.removeActions"),t=I("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:r=>r.find('input[name="actor"]:checked').toArray().map(i=>game.actors.get(i.value)).filter(i=>i)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},a={content:await renderTemplate(t,{actors:game.actors.filter(r=>r.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:r=>{r.on("change",'input[name="all"]',()=>Ka(r)),r.on("change",'input[name="actor"]',()=>Ya(r))},close:()=>null},s=await Dialog.wait(a,void 0,{id:"pf2e-hero-actions-remove-actions"});if(s){if(!s.length){e.warn("noSelection");return}for(let r of s)K(r,[]);e.info("removed")}}o(Va,"removeHeroActions");function Ka(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}o(Ka,"removeActionsToggleAll");function Ya(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),a=e.find('input[name="all"]');t.length===n.length?(a.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?a.prop("checked",!1).prop("indeterminate",!0):(a.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}o(Ya,"removeActionsToggleActor");function zt(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}o(zt,"documentUuidFromTableResult");async function Ja(e){if(!game.user.isGM){P("hero.notGM");return}let t=T("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await Ye();if(!n)return W("hero.table.drawError",!0),null;let a=n.replacement===!1,s=(await Promise.all(n.results.map(async m=>{let y=zt(m);if(y)return{key:m.id,uuid:y,name:await Lt(m,y),drawn:m.drawn}}))).filter(Boolean),r=I("hero/dialogs/give-action"),i=await renderTemplate(r,{actions:s,isUnique:a,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:m=>({selected:m.find("[name=action]:checked").closest(".action").toArray().map(y=>y.dataset),asDrawn:m.find("[name=drawn]").prop("checked")??!1,withMessage:m.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:i,buttons:c,render:m=>{m.find("[data-action=expand]").on("click",Ot)},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!u)return;let{selected:f,asDrawn:h,withMessage:p}=u,d=F(e),g=[];for(let{uuid:m,name:y,key:b}of f){if(d.push({uuid:m,name:y}),!h)continue;let E=n.results.get(b);E&&!E.drawn&&g.push(b)}g.length&&await n.updateEmbeddedDocuments("TableResult",g.map(m=>({_id:m,drawn:!0}))),K(e,d),p&&Re({actor:e,actions:f,label:m=>w("hero.actions-give.header",{nb:m}),secret:!0})}o(Ja,"giveHeroActions");var Wt=T("knowledges.editLore"),me=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Wt("title",this.actor)}get template(){return I("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:C(n,"knowledges.unspecified")??"",specific:C(n,"knowledges.specific")??"",i18n:Wt})}async _updateObject(t,{unspecified:n,specific:a}){let s=this.object;j(s,"knowledges.unspecified",n.trim()),j(s,"knowledges.specific",a.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};o(me,"EditLores");var qt=O("renderNPCSheetPF2e",Qa);function Vt(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>qt(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&v("knowledges")&&qt(!0)}}}o(Vt,"registerKnowledges");function Qa(e,t){let n=e.actor;x(n)&&(Za(n,t),to(t),eo(n,t))}o(Qa,"renderNPCSheetPF2e");function Qe(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}o(Qe,"knowledgeSelector");function Xa(e){new me(e).render(!0)}o(Xa,"editLores");function Za(e,t){let n=C(e,"knowledges.unspecified"),a=C(e,"knowledges.specific");if(!n&&!a)return;let s=e.identificationDCs.lore,r=Qe(t,"body","");r.find(".identification-skills").last().remove();function i(l,u,f){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:f})}</div>`}o(i,"tag");function c(l,{dc:u,start:f}){let h=l.split(",").filter(p=>p.trim()).map(p=>i(p,u,f)).join("");r.append(h)}o(c,"addTags"),c(n||"Unspecific",s[0]),c(a||"Specific",s[1])}o(Za,"replaceLores");function eo(e,t){Qe(t,"header","button.edit").on("click",()=>Xa(e))}o(eo,"addEvents");function to(e){let t=Qe(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}o(to,"addEditButton");var Xe=T("merge.multi"),ge=class extends Application{#e;#t;constructor(t,n,a){super(a),this.#t=t,this.#e=n}get title(){return Xe("title",this.spell)}get template(){return I("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:Xe})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#n.bind(this)),t.find("[data-action=cancel]").on("click",this.#a.bind(this))}async#n(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){Xe.error("zero"),this.close();return}let a=this.#e;if(!a)return;let s=a.item,r=a.actor;if(!r||!s)return;let i=o((l,u)=>{for(let[f,h]of Object.entries(l))for(let p=0;p<n-1;p++){let d=randomID();if(l[d]=h,u.type==="interval"){let g=u.damage[f];g&&(u.damage[d]=g)}else if(u.type==="fixed")for(let[g,m]of Object.entries(u.levels)){let y=m.damage.value[f];y&&(u.levels[g].damage.value[d]=y)}}},"updateSource"),c=deepClone(a.flags.pf2e.casting?.embeddedSpell);if(c){let l=c.system.damage,u=c.system.heightening??={};i(l,u);let f=new CONFIG.Item.documentClass(c,{parent:r});f.trickMagicEntry=s.trickMagicEntry;let h=a.getFlag("pf2e","origin.variant.overlays"),p=a.getFlag("pf2e","origin.castLevel")??s.rank;(f.loadVariant({overlayIds:h,castLevel:p})??f).rollDamage(this.#t)}else{let l=s.toObject(),u=l.system.damage,f=l.system.heightening??{};i(u,f),s.clone({"system.damage":u,"system.heightening":f}).rollDamage(this.#t)}s.damageKinds.size&&ke(a),this.close()}#a(t){t.preventDefault(),this.close()}};o(ge,"MultiCast");var Ze=O("renderChatMessage",Zt,no);function Xt(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>Ze(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>Ze(e,"merge-damage")}],init:e=>{Ze(!1,["multi-cast","merge-damage"],!0)}}}o(Xt,"registerMerge");function no(){let e=ui.chat?.element;if(e)for(let t of fe(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),Zt(t,n))}}o(no,"updateMessages");function Zt(e,t){!game.user.isGM&&!e.isAuthor||(v("merge-damage")&&an(e)?oo(e,t):v("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&ao(e,t))}o(Zt,"renderChatMessage");function ao(e,t){if(!e.item)return;let a=t.find(".message-content .chat-card .owner-buttons .spell-button");a.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${w("merge.spell.button")}</button>`),a.find("[data-action=multi-cast]").on("click",s=>{new ge(s,e).render(!0)})}o(ao,"renderSpell");function oo(e,t){let n='<span class="pf2e-toolbelt-merge">';if(C(e,"merge.merged")){let i=w("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${i}">`,n+='<i class="fa-duotone fa-split"></i>'}let a=w("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${a}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let s=Jt(e),r=Qt(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",i=>{i.stopPropagation();for(let c of fe(5,e)){let l=Qt(c);if(!(!an(c)||Jt(c)!==s||!qe(r?.map(u=>u.actor).filter(Boolean),l?.map(u=>u.actor).filter(Boolean)))){ro(i,e,c,{actorUUID:s,targetUUIDs:r});return}}P("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",i=>{i.stopPropagation(),so(i,e)})}o(oo,"renderDamage");async function so(e,t){let n=C(t,"merge.data").flatMap(a=>a.source);await tn(t.id),await ze().createDocuments(n)}o(so,"splitDamages");async function ro(e,t,n,{actorUUID:a,targetUUIDs:s}){let r={},i=Kt(n).concat(Kt(t));for(let{name:d,notes:g,outcome:m,modifiers:y,tags:b}of i)r[d]??={name:d,tags:b,notes:new Set,results:[]},g.forEach(r[d].notes.add,r[d].notes),r[d].results.some(A=>A.outcome===m&&qe(A.modifiers,y))||r[d].results.push({outcome:m,modifiers:y});let c=Object.values(r).map(d=>(d.label=d.name,d.results.forEach(g=>{g.outcome&&(g.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${g.outcome}`))}),d));c.at(-1).isLastGroup=!0;let l=await renderTemplate(I("merge/merged"),{groups:c,hasMultipleGroups:c.length>1}),u=Yt(t),f=Yt(n),h=[];for(let d of[].concat(f,u)){let{options:g,total:m,terms:y}=d,b=y[0],E=d.formula.replaceAll(/(\[[\w,]+\])/g,"").replace(/^\(/,"").replace(/\)$/,""),A=h.find(({options:{flavor:R,critRule:D}})=>R===g.flavor&&D===g.critRule);A?(A.terms.push(b),A.total+=m,A.formulas.push(E)):h.push({options:g,formulas:[E],total:m,terms:[b]})}for(let d of h){if(d.options.flavor.includes("persistent")){let{index:g}=d.formulas.reduce((m,y,b)=>{let E=en(y),A=new Roll(E).evaluate({async:!1}).total;return A>m.value&&(m={value:A,index:b}),m},{value:0,index:-1});d.formulas=[d.formulas[g]],d.terms=[d.terms[g]]}d.formula=`(${d.formulas.join(" + ")})[${d.options.flavor}]`,d.term=d.terms.length<2?d.terms[0]:nn(d.terms)}let p={class:"DamageRoll",options:{},dice:[],formula:`{${h.map(({formula:d})=>d).join(", ")}}`,total:h.reduce((d,{total:g})=>d+g,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:h.map(({formula:d})=>d),modifiers:[],rolls:h.map(({options:d,formula:g,total:m,term:y})=>({class:"DamageInstance",options:d,dice:[],formula:g,total:m,terms:[y],evaluated:!0})),results:h.map(({total:d})=>({result:d,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let d=o(g=>{"results"in g?g.results.forEach(m=>m.hidden=!0):(g.term??g).operands?.forEach(m=>d(m))},"setHidden");p.terms[0].rolls.forEach(g=>g.terms.forEach(m=>d(m)))}await tn(t.id,n.id),await ze().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[S]:{merge:{actor:a,targets:s,merged:!0,type:"damage-roll",data:i},target:{targets:s}},pf2e:{context:{options:Array.from(new Set(i.flatMap(d=>d.itemTraits)))}}},rolls:[p]})}o(ro,"mergeDamages");function en(e){return new Roll(e).terms.reduce((a,s)=>{if(s instanceof Die){let r=s.number*(s.faces+1)/2;a.push(r)}else if(s instanceof OperatorTerm)a.push(s.operator);else if(s instanceof NumericTerm)a.push(s.number);else if(s instanceof ParentheticalTerm){let r=en(s.term);a.push(`(${r})`)}return a},[]).join(" ")}o(en,"getMeansFormula");function Kt(e){let t=C(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let a=$(`<div>${e.flavor}</div>`),s=a.find("h4.action + .tags").prop("outerHTML"),r=[];a.find(".tag.tag_transparent").each(function(){r.push(this.innerHTML)});let i=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>c.startsWith("item:")),modifiers:r,tags:s,notes:i}]}o(Kt,"getMessageData");function tn(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}o(tn,"removeChatMessages");function nn(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?nn(e):e[0]]}}}o(nn,"createTermGroup");function Yt(e){return C(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}o(Yt,"getMessageRolls");function Jt(e){return C(e,"merge.actor")??e.actor?.uuid}o(Jt,"getActorUUID");function Qt(e){let t=C(e,"target.targets");if(t)return t;let n=C(e,"merge.targets")??e.getFlag("pf2e","target");return Array.isArray(n)?n:n?[n]:[]}o(Qt,"getTargetUUIDs");function an(e){return C(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}o(an,"isDamageRoll");var on=Q("renderChatMessage",rn,io);function sn(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>on(e)}],init:e=>{!e&&v("modifiers")!=="disabled"&&on(!0,!0)}}}o(sn,"registerHideModifiers");function io(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of fe(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),rn(t,n))}}o(io,"updateMessages");function rn(e,t){let n=e.speaker,a=ChatMessage.getSpeakerActor(n);if(!a||a.hasPlayerOwner)return;let s=t.find(".message-header");v("modifiers")==="traits"&&s.addClass("pf2e-toolbelt-modifiers-traits"),v("modifiers")!=="disabled"&&s.addClass("pf2e-toolbelt-modifiers")}o(rn,"renderChatMessage");var co="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",lo="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function cn(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{v("nobulk")&&L(co,uo,"WRAPPER"),v("nobulk-coins")&&L(lo,fo,"WRAPPER")}}}o(cn,"registerNobulk");function fo(e){e(),this.isCoinage&&(this.system.bulk.value=0)}o(fo,"treasurePrepareBaseData");function uo(e,...t){e(...t);let n=this,a=n.inventory.bulk.constructor,s=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return s||(s=a.computeTotalBulk(this.actor.inventory.filter(r=>!r.isInContainer&&r.system.equipped.carryType!=="dropped"),this.actor.size),s)}})}o(uo,"actorPrepareEmbeddedDocuments");var po="CONFIG.Actor.documentClass.prototype.prepareData",mo="DocumentSheet.prototype._renderInner";function ln(){return{settings:[{name:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{v("share")!=="disabled"&&(L(po,So,"WRAPPER"),L(mo,go,"WRAPPER"),Hooks.on("preUpdateActor",yo),Hooks.on("deleteActor",ho),Hooks.on("updateActor",bo))}}}o(ln,"registerShare");async function go(e,...t){let n=await e(...t);if(!Te(this,"CreatureConfig"))return n;let a=this.actor;if(!x(a)||!a.isOfType("character","npc")||he(a).size)return n;let s=game.actors.filter(i=>i.id!==a.id&&i.isOwner&&$e(i)).map(i=>({key:i.id,label:i.name})),r=await renderTemplate(I("share/master"),{masters:s,master:C(a,"share.master"),selectPath:`flags.${S}.share.master`,i18n:T("share.templates.master")});return n.children().last().before(r),n}o(go,"documentSheetRenderInner");function ho(e){gn(e);let t=he(e);Promise.all(t.map(async n=>{un(n),await ht(n,"share.master")}))}o(ho,"deleteActor");function yo(e,t){let n=getProperty(t,`flags.${S}.share`);if(n?.master){let a=game.actors.get(n.master);if($e(a)){let s=deepClone(a._source.system.attributes.hp);setProperty(t,"system.attributes.hp",s)}}else{let a=xe(e),s=getProperty(t,"system.attributes.hp");a&&s&&(a.update({system:{attributes:{hp:s}}},{noHook:!0}),delete t.system.attributes.hp)}}o(yo,"preUpdateActor");function bo(e,t,n,a){let s=game.user.id===a,r=ko(t);if(r?.master!==void 0){let c=e;if(gn(c),r.master){let l=game.actors.get(r.master);$e(l)&&(fn(c,l),mn(l,c))}else un(c)}if(!s)return;let i=he(e);if(i.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(i.map(async u=>await u.update(l,{noHook:!0})))}else Promise.all(i.map(async l=>await vo(l,t)))}}o(bo,"updateActor");async function vo(e,t){v("share")==="force"?await j(e,"toggle",!C(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}o(vo,"refreshActor");function So(e){e();let t=this,n=C(t,"share.master"),a=n?game.actors.get(n):void 0;if(!$e(a))return;xe(this)||(fn(this,a),mn(a,this));let s=this.system.attributes.hp;Object.defineProperty(t.system.attributes,"hp",{get(){let r=a.system.attributes.hp;return Co(r,s),s},enumerable:!0})}o(So,"prepareData");function Co(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}o(Co,"transfertHpData");function ko(e){return getProperty(e,`flags.${S}.share`)}o(ko,"getShareFlag");function he(e){return dn(e,"slaves")??new Collection}o(he,"getSlaves");function fn(e,t){pn(e,"master",t)}o(fn,"setMaster");function un(e){wo(e,"master")}o(un,"unsetMaster");function xe(e){return dn(e,"master")}o(xe,"getMaster");function $e(e){return e&&e.type==="character"&&!xe(e)}o($e,"isValidMaster");function dn(e,t){return getProperty(e,`modules.${S}.share.${t}`)}o(dn,"getModuleProperty");function pn(e,t,n){setProperty(e,`modules.${S}.share.${t}`,n)}o(pn,"setModuleProperty");function wo(e,t){delete e.modules?.[S]?.share?.[t]}o(wo,"deleteModuleProperty");function mn(e,t){let n=he(e);pn(e,"slaves",n.set(t.id,t))}o(mn,"addSlaveToMaster");function gn(e){let t=xe(e);if(!t)return;he(t).delete(e.id)}o(gn,"removeSlaveFromMaster");function hn(e){return e.getFlag("core","sourceId")}o(hn,"getSourceId");function Eo(e,t){let n=hn(e);return n?t.includes(n):!1}o(Eo,"includesSourceId");function yn(e){return Array.isArray(e)?t=>Eo(t,e):t=>hn(t)===e}o(yn,"getItemSourceIdCondition");function bn(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}o(bn,"getItems");function vn(e,t,n){return bn(e,n).some(yn(t))}o(vn,"hasItemWithSourceId");function Fe(e,t,n){return bn(e,n).find(yn(t))}o(Fe,"getItemWithSourceId");var Io=O("renderCharacterSheetPF2e",Ro),To=O("deleteCombat",$o),Ao=O("deleteCombatant",Tn),Po=O("createCombatant",Fo),Do=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Oo=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),Mo=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function Cn(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:Sn},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:et,toggleStance:In,isValidStance:kn},ready:e=>{v("stances")&&Sn(!0)}}}o(Cn,"registerStances");function Sn(e){Io(e),To(e),Ao(e),Po(e)}o(Sn,"setup");function kn(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}o(kn,"isValidStance");function et(e){let t=[],n=new Set;for(let{replace:a,sourceId:s,effectUUID:r,effect:i,img:c,name:l,itemName:u,action:f}of wn(e)){a&&n.add(a);let h=f?Fe(e,f,"action"):Fe(e,s,"feat");t.push({name:l,itemName:u,uuid:s,img:c,effectUUID:r,effectID:i?.id,actionUUID:h.sourceId,actionID:h.id})}return t.filter(({uuid:a})=>!n.has(a))}o(et,"getStances");async function Ro(e,t){let n=e.actor;if(!x(n))return;let a=et(n);if(!a.length)return;let s=n.getActiveTokens(!0,!0).some(l=>l.inCombat),r=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),i=r.find(".actions-options"),c=await renderTemplate(I("stances/sheet"),{stances:a,canUseStances:s&&!n.isDead,i18n:T("stances")});i.length?i.after(c):r.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>xo(l,n))}o(Ro,"renderCharacterSheetPF2e");function xo(e,t){let n=e.currentTarget,a=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!a)return;let s=n.dataset.effectUuid;In(t,s)}o(xo,"onToggleStance");function*wn(e){for(let t of e.itemTypes.feat){let n=t.sourceId,a=Oo.get(n),s=Mo.get(n);if(!a&&!s&&!kn(t))continue;let r=a?.effect??s?.effect??t.system.selfEffect.uuid,i=fromUuidSync(r);i&&(yield{name:(a&&fromUuidSync(a.replace)?.name)??t.name,itemName:t.name,replace:a?.replace,extra:s,sourceId:n,effectUUID:r,effect:Fe(e,r,"effect"),action:s?.action,img:i.img})}}o(wn,"actorStances");function En(e){let t=[];for(let{effect:n}of wn(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}o(En,"getStancesEffects");async function In(e,t){let n=En(e),a=n.findIndex(r=>r.uuid===t),s=!1;if(a===-1)s=!0;else{let r=n.filter(c=>c.uuid!==t).length,i=n.filter(c=>c.uuid===t).length>1;(r||i)&&n.splice(a,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(r=>r.id)),s&&tt(e,t)}o(In,"toggleStance");async function tt(e,t){let n=await fromUuid(t);if(n){let a=n.toObject();return getProperty(a,"flags.core.sourceId")||setProperty(a,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[a]))[0]?.toMessage(),!0}return!1}o(tt,"addStance");function $o(e){for(let t of e.combatants)Tn(t)}o($o,"deleteCombat");function Tn(e){let t=An(e);if(t){if(!game.user.isGM&&We(t)){let n=En(t).map(a=>a.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}V(t)}}o(Tn,"deleteCombatant");function Fo(e){let t=An(e);t&&(!game.user.isGM&&We(t)&&Lo(t),V(t))}o(Fo,"createCombatant");function An(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}o(An,"getActorFromCombatant");async function Lo(e){let t=et(e);if(!(!t.length||t.filter(({effectID:s})=>s).length||!vn(e,Do,["feat"])))if(t.length===1){let s=t[0];await tt(e,s.effectUUID)&&J("stances.useStance",{stance:s.name})}else Uo(e,t)}o(Lo,"checkForSavant");async function Uo(e,t){let n=T("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(I("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:a=>tt(e,a.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}o(Uo,"openStancesMenu");var Pn=Q("renderCharacterSheetPF2e",_o,()=>V());function Dn(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>Pn(e)}],conflicts:["pf2e-spells-summary"],init:e=>{v("summary")!=="disabled"&&Pn(!0,!0)}}}o(Dn,"registerSpellsSummary");async function _o(e,t){let n=e.actor;if(!x(n))return;let a=ye(t);pe(e,"toggled")&&a.addClass("toggled"),Xo(t).on("click",s=>Qo(s,t,e)),await Ho(t,e,n),a.hasClass("toggled")&&a.hasClass("active")&&e._restoreScrollPositions(t)}o(_o,"renderCharacterSheetPF2e");async function Ho(e,t,n){let a=ye(e),s=await ts(n),r=await renderTemplate(I("summary/sheet"),s);a.append(r),No(e,t,n)}o(Ho,"addSummaryTab");function No(e,t,n){let a=es(e),s=a.find(".spell-type .uses .spell-slots-input input");s.on("change",r=>jo(r,n)),s.on("focus",Go),s.on("blur",Bo),a.find("[data-action=cast-spell]").on("click",r=>Ko(r,n)),a.find(".item-toggle-prepare").on("click",r=>zo(r,n)),a.find(".focus-pips").on("click contextmenu",r=>Wo(r,n)),a.find(".spell-slots-increment-reset").on("click",r=>Vo(r,t,n)),a.find(".item-image").on("click",r=>Jo(r,n)),a.find(".item-name > h4").on("click",r=>Yo(r,t))}o(No,"addSummaryEvents");async function jo(e,t){e.preventDefault();let{inputPath:n,entryId:a}=$(e.currentTarget).data(),s=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:a,[n]:s}])}o(jo,"onUsesInputChange");function Go(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}o(Go,"onUsesInputFocus");function Bo(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}o(Bo,"onUsesInputBlur");function zo(e,t){e.preventDefault();let{slotLevel:n,slotId:a,entryId:s,expended:r}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(s)?.setSlotExpendedState(n??0,a??0,r!==!0)}o(zo,"onTogglePrepare");function Wo(e,t){e.preventDefault();let n=e.type==="click"?1:-1,a=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":a})}o(Wo,"onToggleFocusPool");function qo(e,t){Zo(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}o(qo,"onChargeReset");function Vo(e,t,n){e.preventDefault();let{itemId:a,level:s,isCharge:r}=$(e.currentTarget).data();if(!a)return;if(r){qo(t,a);return}let i=n.items.get(a);if(i){if(i.isOfType("spellcastingEntry")){let c=s>=0&&s<=11?`slot${s}`:"slot0",l=i.system.slots?.[c];l&&i.update({[`system.slots.${c}.value`]:l.max})}else if(i.isOfType("spell")){let c=i.system.location.uses?.max;c&&i.update({"system.location.uses.value":c})}}}o(Vo,"onSlotsReset");function Ko(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:a,slotLevel:s,slotId:r,entryId:i}=n.closest(".item").data(),c=t.spellcasting.collections.get(i);if(!c)return;let l=c.get(a);l&&c.entry.cast(l,{slot:r,level:s})}o(Ko,"onCastSpell");async function Yo(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}o(Yo,"onToggleSummary");async function Jo(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),a=t.items.get(n);!a||a.isOfType("physical")&&!a.isIdentified||await a.toMessage(e)}o(Jo,"onItemToChat");function Qo(e,t,n){e.preventDefault();let a=ye(t);a.hasClass("active")&&(a.toggleClass("toggled"),a.scrollTop(0),Ae(n,"toggled",a.hasClass("toggled")))}o(Qo,"onSpellcastingBtnToggle");function Xo(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}o(Xo,"getSpellcastingNav");function ye(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}o(ye,"getSpellcastingTab");function Zo(e){return ye(e).find(".directory-list.spellcastingEntry-list")}o(Zo,"getSpellcastingOriginalSection");function es(e){return ye(e).find(".directory-list.summary")}o(es,"getSpellcastingSummarySection");async function ts(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,a=[],s=[],r=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,f=l.statistic.dc.value,h=l.name,p=await l.getSheetData(),d=p.isFocusPool,g=l.system?.prepared?.value==="charge",m=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,y={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let b of p.levels){if(!b.active.length||b.uses?.max===0)continue;let E=[],A=b.isCantrip,R=b.active.filter(U=>U&&U.uses?.max!==0),D=!A&&g&&!n;for(let U=0;U<R.length;U++){let{spell:H,expended:Se,virtual:k,uses:oe,castLevel:se}=R[U];E.push({name:H.name,img:H.img,range:H.system.range.value||"-",castLevel:se??H.level,slotId:U,entryId:u,entryDc:f,entryName:h,itemId:H.id,inputId:p.isInnate?H.id:p.id,inputPath:g?"flags.pf2e-staves.charges":p.isInnate?"system.location.uses.value":`system.slots.slot${b.level}.value`,isCharge:g,isActiveCharge:g&&n,isBroken:D,isVirtual:k,isInnate:p.isInnate,isCantrip:A,isFocus:d,isPrepared:p.isPrepared,isSpontaneous:p.isSpontaneous||p.isFlexible,slotLevel:b.level,uses:oe??(g?y:b.uses),expended:Se??(d&&!A?t.value<=0:!1),action:H.system.time.value,type:g?m?`${S}.summary.staff`:`${S}.summary.charges`:p.isInnate?"PF2E.PreparationTypeInnate":p.isSpontaneous?"PF2E.PreparationTypeSpontaneous":p.isFlexible?"PF2E.SpellFlexibleLabel":d?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:g?0:p.isPrepared?1:d?2:p.isInnate?3:p.isSpontaneous?4:5,noHover:p.isPrepared||A||D||d})}if(E.length){if(d)if(A)r=!0;else{s.push(...E);continue}a[b.level]??=[],a[b.level].push(...E)}}})),a.length){let l=v("summary")==="sort"?(u,f)=>u.order===f.order?Ie(u.name,f.name):u.order-f.order:(u,f)=>Ie(u.name,f.name);a.forEach(u=>u.sort(l))}s.length&&(s.sort((l,u)=>Ie(l.name,u.name)),a[12]=s,r=!1);let c=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:f})=>({name:f.name,img:f.img,slotId:u,itemId:f.id,level:f.level,time:f.system.time.value})).filter(Boolean));return{spells:a,rituals:c,focusPool:t,stavesActive:n,hasFocusCantrips:r,isOwner:e.isOwner,entryRank:l=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Tt(l)})}}o(ts,"getData");function ns(e){return Error(`PF2e System | ${e}`)}o(ns,"ErrorPF2e");var Le={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},On=["criticalFailure","failure","success","criticalSuccess"],_e,Rn,ne,Ue,Y,be,He,xn,B=class{constructor(t,n,a=null){ie(this,_e);ie(this,ne);ie(this,Y);ie(this,He);t instanceof Roll?(this.dieResult=(t.isDeterministic?t.terms.find(s=>s instanceof NumericTerm):t.dice.find(s=>s instanceof Die&&s.faces===20))?.total??1,this.rollTotal=t.total):(this.dieResult=t.dieValue,this.rollTotal=t.dieValue+t.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=_(this,He,xn).call(this),this.adjustment=_(this,_e,Rn).call(this,this.unadjusted,a),this.value=this.adjustment?_(this,ne,Ue).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},N=B;o(N,"DegreeOfSuccess"),_e=new WeakSet,Rn=o(function(t,n){if(!n)return null;for(let a of["all",...On]){let{label:s,amount:r}=n[a]??{};if(r&&s&&!(t===B.CRITICAL_SUCCESS&&r===Le.INCREASE)&&!(t===B.CRITICAL_FAILURE&&r===Le.LOWER)&&(a==="all"||On.indexOf(a)===t))return{label:s,amount:r}}return null},"#getDegreeAdjustment"),ne=new WeakSet,Ue=o(function(t,n){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+t,0,3)}},"#adjustDegreeOfSuccess"),Y=new WeakSet,be=o(function(t){return this.dieResult===20?_(this,ne,Ue).call(this,Le.INCREASE,t):this.dieResult===1?_(this,ne,Ue).call(this,Le.LOWER,t):t},"#adjustDegreeByDieValue"),He=new WeakSet,xn=o(function(){let t=this.dc.value;return this.rollTotal-t>=10?_(this,Y,be).call(this,B.CRITICAL_SUCCESS):t-this.rollTotal>=10?_(this,Y,be).call(this,B.CRITICAL_FAILURE):this.rollTotal>=t?_(this,Y,be).call(this,B.SUCCESS):_(this,Y,be).call(this,B.FAILURE)},"#calculateDegreeOfSuccess"),re(N,"CRITICAL_FAILURE",0),re(N,"FAILURE",1),re(N,"SUCCESS",2),re(N,"CRITICAL_SUCCESS",3);async function as({affects:e,origin:t,target:n,item:a,domains:s,options:r}){if(!(t&&n))return[];let[i,c]=e==="target"?[t,n]:[n,t],l=[...r,i.getRollOptions(s),c.getSelfRollOptions(e)].flat(),u=a?a.isOfType("spell")?{spell:a}:{weapon:a}:{};return(await Promise.all(s.flatMap(f=>i.synthetics.ephemeralEffects[f]?.[e]??[]).map(f=>f({test:l,resolvables:u})))).flatMap(f=>f??[])}o(as,"extractEphemeralEffects");function os(e,t){return t.flatMap(n=>(e[n]??[]).map(a=>a.clone()))}o(os,"extractNotes");function ss(e,t,n){return t.flatMap(a=>e[a]??[]).flatMap(a=>a(n)??[])}o(ss,"extractDamageDice");async function rs(e,{message:t,multiplier:n,rollIndex:a}){let s=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),r=o(class extends Dialog{activateListeners(i){super.activateListeners(i),i[0].querySelector("input")?.focus()}},"AdjustmentDialog");new r({title:game.i18n.localize("PF2E.UI.shiftModifyDamageTitle"),content:s,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async i=>{let c=(Number(i[0].querySelector("input")?.value)||0)*Math.sign(n);nt(e,{message:t,multiplier:n,addend:c,promptModifier:!1,rollIndex:a})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{$n(t.id)}}).render(!0)}o(rs,"shiftAdjustDamage");async function nt(e,{message:t,multiplier:n=1,addend:a=0,promptModifier:s=!1,rollIndex:r=0}){if(s)return rs(e,{message:t,multiplier:n,rollIndex:r});let i=CONFIG.PF2E.chatDamageButtonShieldToggle,c=t.rolls.at(r);if(!Te(c,"DamageRoll"))throw ns("Unexpected error retrieving damage roll");let l=n<0?n*c.total+a:c.alter(n,a),u=[...t.flags.pf2e.context?.options??[]],f=u.filter(D=>D.startsWith("self:")).map(D=>D.replace(/^self/,"origin")),h=t.item;if(!e.actor)return;u.some(D=>D.startsWith("target"))||u.push(...e.actor.getSelfRollOptions("target"));let p=n>0?"damage-received":"healing-received",d=n>0?await as({affects:"target",origin:t.actor,target:e.actor,item:t.item,domains:[p],options:u}):[],g=e.actor.getContextualClone(f,d),m=new Set([...u.filter(D=>!/^(?:self|target):/.test(D)),...f,...g.getSelfRollOptions()]),y=t.flags.pf2e.context?.outcome,b=[],E=[];if(typeof l=="number"&&l<0){let D=y==="criticalSuccess",U=(()=>h?.isOfType("spell")?{spell:h}:h?.isOfType("weapon")?{weapon:h}:{})(),H=ss(g.synthetics.damageDice,[p],{resolvables:U,test:m}).filter(k=>(k.critical===null||k.critical===D)&&k.predicate.test(m));for(let k of H){let oe=`${k.diceNumber}${k.dieSize}[${k.label}]`,se=await new Roll(oe).evaluate({async:!0});se._formula=`${k.diceNumber}${k.dieSize}`,await se.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:k.label,speaker:ChatMessage.getSpeaker({token:e})}),b.push(`${k.label} ${k.diceNumber}${k.dieSize}`),E.push(se)}E.length&&(l-=E.map(k=>k.total).reduce((k,oe)=>k+oe));let Se=ls(g.synthetics,[p],{resolvables:U}).filter(k=>(k.critical===null||k.critical===D)&&k.predicate.test(m));l-=is(Se??[]),b.push(...Se.filter(k=>k.enabled).map(k=>`${k.label} ${signedInteger(k.modifier)}`))}let A=typeof l=="number"?l!==0:l.total!==0,R=(()=>A?os(g.synthetics.rollNotes,[p]).filter(D=>(!y||D.outcome.length===0||D.outcome.includes(y))&&D.predicate.test(m)).map(D=>D.text):[])();await g.applyDamage({damage:l,token:e,item:t.item,skipIWR:n<=0,rollOptions:m,shieldBlockRequest:i,breakdown:b,notes:R}),$n(t.id),Ln(t,e.id,r)}o(nt,"applyDamageFromMessage");function Mn(e,t,n){let a=e[t.type];return a===void 0?(t.enabled=!0,e[t.type]=t,t.modifier):n(t,a)?(a.enabled=!1,t.enabled=!0,e[t.type]=t,t.modifier-a.modifier):(t.enabled=!1,0)}o(Mn,"applyStacking");function is(e){let t=0,n={},a={},s=e.filter(i=>i.type==="ability"&&!i.ignored),r=s.reduce((i,c)=>i===null||c.force?c:i.force?i:c.modifier>i.modifier?c:i,null);for(let i of s)i.ignored=i!==r;for(let i of e){if(i.ignored){i.enabled=!1;continue}if(i.type==="untyped"){i.enabled=!0,t+=i.modifier;continue}i.modifier<0?t+=Mn(a,i,LOWER_PENALTY):t+=Mn(n,i,HIGHER_BONUS)}return t}o(is,"applyStackingRules");function cs(e,t,n){return Array.from(new Set(t.flatMap(s=>e[s]??[]))).filter(s=>[n,null].includes(s.slug))}o(cs,"extractModifierAdjustments");function ls(e,t,n){let{modifierAdjustments:a,modifiers:s}=e,r=Array.from(new Set(t)).flatMap(i=>s[i]??[]).flatMap(i=>i(n)??[]);for(let i of r)i.adjustments=cs(a,t,i.slug);return r}o(ls,"extractModifiers");function $n(e){for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action$=shield-block]`;$(document).find(n).removeClass("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}o($n,"toggleOffShieldBlock");function fs(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}o(fs,"htmlQuery");function Fn(e,t,n){let a=o(()=>[e],"getTokens"),s=o(r=>r[0].actor.itemTypes.armor.filter(l=>l.isEquipped&&l.isShield).filter(l=>!l.isBroken),"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:$(n).find("div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let r=a();if(!r.length)return!1;let i=s(r),c=r.length===1&&i.length>1,l=t.classList.contains("shield-activated");return c&&!l?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(r,i,c)=>{let l=a(),u=s(l),f=l.length===1&&u.length>1,h=t.classList.contains("shield-activated");if(f&&!h){let p=c[0],d=fs(p,"ul.shield-options");if(!d)return c;let g=[];for(let m of u){let y=document.createElement("input");y.classList.add("data"),y.type="radio",y.name="shield-id",y.value=m.id,y.addEventListener("click",()=>{t.dataset.shieldId=y.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,r.close()});let b=document.createElement("span");b.classList.add("label"),b.innerHTML=m.name;let E=document.createElement("span");E.classList.add("tag");let A=game.i18n.localize("PF2E.HardnessLabel");E.innerHTML=`${A}: ${m.hardness}`;let R=document.createElement("li");R.classList.add("item"),R.append(y,b,E),g.push(R)}d.replaceChildren(...g)}return c}}).tooltipster("open")}o(Fn,"onClickShieldBlock");function Un(e,{collisionOrigin:t,collisionType:n="move"}={}){if(e=e instanceof MeasuredTemplateDocument?e.object:e,!canvas.scene)return[];let{grid:a,dimensions:s}=canvas;if(!(a&&s))return[];if(!e?.highlightId)return[];let r=a.getHighlightLayer(e.highlightId);if(!r||a.type!==CONST.GRID_TYPES.SQUARE)return[];let i=t??e.center,c=canvas.tokens.quadtree.getObjects(r.getLocalBounds(void 0,!0)),l=a.size,u=[];for(let f of c){let h=f.document,p=[];for(let d=0;d<h.height;d++){let g=Math.floor(f.x/l)*l,y=Math.floor(f.y/l)*l+d*l;if(p.push(`${g}.${y}`),h.width>1)for(let b=1;b<h.width;b++)p.push(`${g+b*l}.${y}`)}for(let d of p){if(!r.positions.has(d))continue;let[g,m]=d.split(".").map(E=>Number(E)),y={x:g+s.size*.5,y:m+s.size*.5};if(y.x<0||y.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(i,y,{type:n,mode:"any"}))){u.push(f);break}}}return u}o(Un,"getTemplateTokens");var us={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},at={hero:{icon:"fa-solid fa-hospital-symbol",reroll:"PF2E.RerollMenu.HeroPoint",rerolled:"PF2E.RerollMenu.MessageHeroPoint"},new:{icon:"fa-solid fa-dice",reroll:"PF2E.RerollMenu.KeepNew",rerolled:"PF2E.RerollMenu.MessageKeep.new"},lower:{icon:"fa-solid fa-dice-one",reroll:"PF2E.RerollMenu.KeepLower",rerolled:"PF2E.RerollMenu.MessageKeep.lower"},higher:{icon:"fa-solid fa-dice-six",reroll:"PF2E.RerollMenu.KeepHigher",rerolled:"PF2E.RerollMenu.MessageKeep.higher"}},ds=["criticalFailure","failure","success","criticalSuccess"],ps=O("preCreateChatMessage",gs),jn=Q("renderChatMessage",hs),Gn=O("createMeasuredTemplate",ms),Ne=!1;function Bn(){return{settings:[{name:"target",type:Boolean,default:!1,onChange:_n},{name:"target-chat",type:String,default:"disabled",choices:["disabled","small","big"],scope:"client",onChange:e=>jn(e&&v("target"))},{name:"target-template",type:Boolean,default:!1,scope:"client",onChange:e=>Gn(e&&v("target"))}],conflicts:[],init:()=>{v("target")&&_n(!0)}}}o(Bn,"registerTargetTokenHelper");function _n(e){ps(e),jn(e),Gn(e&&v("target-template")),we()&&(e&&!Ne?(X(Hn),Ne=!0):!e&&Ne&&(Z(Hn),Ne=!1))}o(_n,"setHooks");function Hn(e){if(ee())switch(e.type){case"target.update-save":ot(e);break;case"target.update-applied":Vn(e);break}}o(Hn,"onSocket");async function ms(e,t,n){let a=game.user;if(a.id!==n)return;let s=T("target.menu"),r=e.item,i=r?.actor,c=i?i.token??i.getActiveTokens()[0]:void 0,l={title:r?.name||s("title"),content:await renderTemplate(I("target/template-menu"),{i18n:s,noSelf:!c}),buttons:{select:{icon:'<i class="fa-solid fa-bullseye-arrow"></i>',label:s("target"),callback:m=>({targets:m.find("[name=targets]:checked").val(),self:m.find("[name=self]").prop("checked"),neutral:m.find("[name=neutral]").prop("checked")})}},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-toolbelt-target-template",width:260});if(!u)return;let f=i?i.alliance:a.isGM?"opposition":"party",h=f==="party"?"opposition":f==="opposition"?"party":null,g=Un(e).filter(m=>{if(!m.actor?.isOfType("creature","hazard","vehicle")||m.document.hidden)return!1;if(c&&m===c)return u.self;let b=m.actor?m.actor.alliance:m.alliance;return b===null?u.neutral:u.targets==="all"||u.targets==="allies"&&b===f||u.targets==="enemies"&&b===h}).map(m=>m.id);a.updateTokenTargets(g),a.broadcastActivity({targets:g})}o(ms,"createMeasuredTemplate");function gs(e){let t=e.isDamageRoll;if(t){if(!C(e,"target.targets")){let r=game.user.targets;r.size&&q(e,"target.targets",Array.from(r.map(i=>({token:i.document.uuid,actor:i.actor.uuid}))))}if(e.rolls.length===2){let r=e.rolls.findIndex(c=>c.options?.splashOnly),i=e.rolls.findIndex(c=>!c.options?.splashOnly&&c.options?.damage?.modifiers.some(l=>l.damageCategory==="splash"));r!==-1&&i!==-1&&q(e,"target.splashIndex",r)}}if(!t&&e.getFlag("pf2e","context.type")!=="spell-cast")return;let n=e.item;if(n?.type!=="spell")return;let a=n.system.defense?.save;if(!a)return;let s=(()=>n.trickMagicEntry?$(e.content).find("[data-action=spell-save]").data()?.dc:n.spellcasting?.statistic.dc.value)();typeof s=="number"&&q(e,"target.save",{...a,dc:s})}o(gs,"preCreateChatMessage");async function hs(e,t){let n=v("target-chat")!=="disabled";if(n&&e.isDamageRoll){await bs(e,t),Nn(e);return}let a=e.item;if(!(!a||a.type!=="spell")){if(n&&!a.damageKinds.size){await ys(e,t,a),Nn(e);return}a.trickMagicEntry&&a.system.defense?.save&&t.find("[data-action=spell-damage]").on("click",()=>{ke(e)})}}o(hs,"renderChatMessage");function Nn(e){Promise.all([ui.chat,ui.chat._popout].map(async t=>{let n=t?.element[0]?.querySelector("#chat-log");!n||!t.isAtBottom&&e.user._id!==game.user._id||(await t._waitForImages(),n.scrollTop=n.scrollHeight)}));for(let t of Object.values(e.apps))t instanceof ChatPopout&&t.rendered&&t.setPosition()}o(Nn,"refreshMessage");async function ys(e,t,n){let a=await qn(e);if(!a)return;let{targets:s,save:r}=a,i=t.find(".message-content"),c=i.find(".card-buttons");if(game.user.isGM||e.isAuthor){let u=c.find("[data-action=spell-save]"),f=$('<div class="pf2e-toolbelt-target-wrapper"></div>'),h=w("target.chat.targets.tooltip"),p=$(`<button class="pf2e-toolbelt-target-targets" title="${h}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);p.on("click",d=>zn(d,e)),f.append(p),f.append(u),c.prepend(f)}if(n&&n.area&&!n.traits.has("aura")&&canvas.scene?.templates.some(f=>f.message===e&&f.isOwner)&&c.find(".owner-buttons .hidden.small").removeClass("hidden"),!s.length)return;let l=$('<div class="pf2e-toolbelt-target-spell"></div>');s.forEach(({template:u})=>{l.append("<hr>"),l.append(u)}),i.after(l),Wn(e,l,r)}o(ys,"renderSpellChatMessage");function zn(e,t){e.stopPropagation();let n=game.user.targets;j(t,"target.targets",Array.from(n.map(a=>({token:a.document.uuid,actor:a.actor.uuid}))))}o(zn,"addTargets");async function bs(e,t){let n=await qn(e),a=t.find(".message-content"),s=a.find(".damage-application"),r=s.clone(),i=$('<div class="pf2e-toolbelt-target-buttons"></div>');if(n?.targets.length&&s.length){let f=o(()=>{let d=!!pe(e,"target.expanded");p.toggleClass("collapse",d),s.toggleClass("hidden",!d)},"toggleDamageRow"),h=w("target.chat.toggle.tooltip"),p=$(`<button class="toggle" title="${h}">
    <i class="fa-solid fa-plus expand"></i>
    <i class="fa-solid fa-minus collapse"></i>
</button>`);f(),p.on("click",d=>{d.stopPropagation(),Ae(e,"target.expanded",!pe(e,"target.expanded")),f()}),i.append(p)}if(game.user.isGM||e.isAuthor){let f=w("target.chat.targets.tooltip"),h=$(`<button class="targets" title="${f}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);h.on("click",p=>zn(p,e)),i.append(h)}if(t.find(".dice-result .dice-total").append(i),!n?.targets.length)return;let{targets:c,save:l}=n;if(!r.length)return;r.removeClass("damage-application").addClass("target-damage-application"),v("target-chat")!=="big"&&r.find("button").addClass("small"),r.find("[data-action]").each(function(){let f=this.dataset.action;this.dataset.action=`target-${f}`});let u=$('<div class="pf2e-toolbelt-target-damage"></div>');c.forEach(({uuid:f,template:h,save:p,applied:d={}})=>{let g=!!(p&&p.result&&p.basic),m=r.clone();u.append("<hr>"),u.append(h),m.each((y,b)=>{b.dataset.rollIndex=y,b.dataset.targetUuid=f,b.classList.toggle("applied",!!d[y]||g&&p.result.success==="criticalSuccess"),g&&b.classList.add(p.result.success)}),u.append(m)}),a.after(u),Wn(e,u,l),u.find("button[data-action^=target-]").on("click",f=>ws(f,e))}o(bs,"renderDamageChatMessage");function Wn(e,t,n){t.find("[data-action=ping-target]").on("click",ks),t.find("[data-action=open-target-sheet]").on("click",Cs),t.find("[data-action=roll-save]").on("click",a=>Ss(a,e,n)),t.find("[data-action=reroll-save]").on("click",a=>vs(a,e,n))}o(Wn,"addHeaderListeners");async function qn(e){let t=C(e,"target.targets")??[],n=game.user.isGM||game.settings.get("pf2e","metagame_showDC"),a=(()=>{let r=C(e,"target.save");if(r)return{...r,...us[r.statistic]}})();if(!t.length&&!a)return;if(a){let r=game.i18n.format("PF2E.SavingThrowWithName",{saveName:game.i18n.localize(a.label)}),i=n?w("target.chat.save.dcWithValue",{dc:a.dc}):"";a.tooltipLabel=`${r} ${i}`,a.tooltip=await renderTemplate(I("target/save-tooltip"),{check:a.tooltipLabel})}return{targets:(await Promise.all(t.map(async({token:r})=>{let i=await fromUuid(r);if(!i?.isOwner)return;let c=i.id,l=i.actor,u=a&&!!l?.saves[a.statistic],f=await(async()=>{if(!u)return;let p=C(e,`target.saves.${c}`);if(!p)return;let d=p.rerolled,g=u&&!d,m=game.i18n.localize(`PF2E.Check.Result.Degree.Check.${p.success}`),y=p.value-a.dc;return{...p,canReroll:g,tooltip:await renderTemplate(I("target/save-tooltip"),{i18n:T("target.chat.save"),check:a.tooltipLabel,result:w(`target.chat.save.result.${n?"withOffset":"withoutOffset"}`,{success:m,offset:y>=0?`+${y}`:y,die:`<i class="fa-solid fa-dice-d20"></i> ${p.die}`}),modifiers:p.modifiers,canReroll:g,rerolled:at[d]})}})(),h=a&&{...a,result:f};return{uuid:r,target:i,save:h,applied:C(e,`target.applied.${c}`),template:await renderTemplate(I("target/row-header"),{name:i.name,uuid:r,save:u&&h,canReroll:f?.canReroll,rerolled:at[f?.rerolled]})}}))).filter(Boolean),save:a}}o(qn,"getMessageData");async function je(e){let{targetUuid:t}=e.currentTarget.closest("[data-target-uuid]").dataset;return fromUuid(t)}o(je,"getTargetFromEvent");async function vs(e,t,{dc:n}){let a=await je(e),s=a?.actor;if(!s)return;let r=C(t,`target.saves.${a.id}`);if(!r?.roll||r.rerolled)return;let i=s.isOfType("character")?s.heroPoints.value:0,c=Object.entries(at).map(([b,{icon:E,reroll:A}])=>{if(b==="hero"&&!i)return;let R=game.i18n.localize(A);return`<label><input type="radio" name="reroll" value="${b}"><i class="${E}"></i> ${R}</label>`}).filter(Boolean).join(""),l={yes:{icon:'<i class="fa-solid fa-rotate rotate"></i>',label:"reroll",callback:b=>b.find("[name=reroll]:checked").val()??null},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:"cancel",callback:()=>null}},u=await Dialog.wait({title:`${a.name} - ${w("target.chat.save.reroll.confirm.title")}`,content:c,buttons:l,close:()=>null},{id:`pf2e-toolbelt-target-save-reroll-dialog-${a.id}`});if(!u)return;let f=u==="hero",h=f?"new":u;if(f){let{value:b,max:E}=s.heroPoints;if(b<1){P("target.chat.save.reroll.noPoints");return}await s.update({"system.resources.heroPoints.value":Math.clamped(b-1,0,E)})}let p=Roll.fromJSON(r.roll),d=p.clone();d.options.isReroll=!0,Hooks.callAll("pf2e.preReroll",Roll.fromJSON(r.roll),d,f,h);let g=await d.evaluate({async:!0});Hooks.callAll("pf2e.reroll",Roll.fromJSON(r.roll),g,f,h);let m=h==="higher"&&p.total>g.total||h==="lower"&&p.total<g.total?p:g;if(m===g){let b=new N(g,n,r.dosAdjustments);m.options.degreeOfSuccess=b.value}let y={type:"target.update-save",target:a.id,data:{value:m.total,die:m.dice[0].total,success:m.degreeOfSuccess,roll:JSON.stringify(m.toJSON()),dosAdjustments:deepClone(r.dosAdjustments),modifiers:deepClone(r.modifiers),rerolled:u}};m.options.keeleyAdd10&&y.data.modifiers.push({label:w("target.chat.save.reroll.keeley"),modifier:10}),game.user.isGM||t.isAuthor?(y.message=t,ot(y)):(y.message=t.id,M(y))}o(vs,"rerollSave");async function Ss(e,t,{dc:n,statistic:a}){let s=await je(e),r=s?.actor;if(!r)return;let i=r.saves[a];if(!i)return;let c=(()=>{let f=t.item;if(f)return f;let h=C(t,"target.messageId");if(!h)return;let p=game.messages.get(h);if(p)return p.item})(),l=!game.user.settings.showCheckDialogs,u={type:"target.update-save",target:s.id};i.check.roll({dc:{value:n},item:c,origin:r,skipDialog:e.shiftKey?!l:l,createMessage:!1,callback:(f,h,p)=>{u.data={value:f.total,die:f.dice[0].total,success:f.degreeOfSuccess,roll:JSON.stringify(f.toJSON()),dosAdjustments:p.getFlag("pf2e","context.dosAdjustments"),modifiers:p.getFlag("pf2e","modifiers").filter(d=>d.enabled).map(({label:d,modifier:g})=>({label:d,modifier:g}))},game.user.isGM||t.isAuthor?(u.message=t,ot(u)):(u.message=t.id,M(u))}})}o(Ss,"rollSave");function ot({message:e,target:t,data:n}){typeof e=="string"&&(e=game.messages.get(e),!e)||(typeof n.success=="number"&&(n.success=ds[n.success]),j(e,`target.saves.${t}`,deepClone(n)))}o(ot,"updateMessageSave");async function Cs(e){let t=await je(e);t&&t.actor?.sheet.render(!0)}o(Cs,"openTargetSheet");async function ks(e){if(!canvas.ready)return;let t=await je(e);t&&canvas.ping(t.center)}o(ks,"pingTarget");async function ws(e,t){let n=e.currentTarget,{rollIndex:a,targetUuid:s}=n.closest("[data-target-uuid]").dataset,r=await fromUuid(s);if(!r)return;let i=n.dataset.action;if(i==="target-shield-block"){Fn(r,n,t.element);return}nt(r,{message:t,multiplier:i==="target-apply-healing"?-1:i==="target-half-damage"?.5:i==="target-apply-damage"?1:i==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:Number(a)})}o(ws,"onTargetButton");function Ln(e,t,n){let a={};le(a,`target.applied.${t}.${n}`,!0);let s=C(e,"target.splashIndex");if(s!==void 0){let r=s===0?1:0;if(n===s)le(a,`target.applied.${t}.${r}`,!0);else{le(a,`target.applied.${t}.${s}`,!0);let i=C(e,"target.targets")??[];for(let c of i){let l=c.token?.split(".").at(-1);l!==t&&le(a,`target.applied.${l}.${r}`,!0)}}}game.user.isGM||e.isAuthor?Vn({message:e,updates:a}):M({type:"target.update-applied",message:e.id,updates:a})}o(Ln,"onDamageApplied");function Vn({message:e,updates:t}){typeof e=="string"&&(e=game.messages.get(e),!e)||e.update(t)}o(Vn,"updateMessageApplied");var ve=null,z=null;function Yn(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:Kn}],conflicts:["pf2e-unided"],init:()=>{Kn()}}}o(Yn,"registerUnided");function Kn(e){e??=v("unided"),e==="disabled"?(ve&&(Hooks.off("preCreateItem",ve),ve=null),z&&(Hooks.off("preUpdateItem",z),z=null)):(ve||(ve=Hooks.on("preCreateItem",Es)),e==="all"&&!z?z=Hooks.on("preUpdateItem",Is):e!=="all"&&z&&(Hooks.off("preUpdateItem",z),z=null))}o(Kn,"setHooks");function Es(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}o(Es,"preCreateItem");function Is(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}o(Is,"preUpdateItem");var ae=T("macros.condition");async function Jn(e){let t=o((f,h)=>{let p=f.find("[name=condition]"),{name:d,slug:g,img:m}=p.find(":selected").data();return{type:h,slug:g,img:m,name:f.find("[name=name]").val().trim()||ae("effect-name",{condition:d}),uuid:p.val(),badge:Number(f.find("[name=badge]").val()||1),unidentified:f.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:ae("generate"),callback:f=>t(f,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:ae("add"),callback:f=>t(f,"add")}},a=Array.from(game.pf2e.ConditionManager.conditions.values()),s=new Set(a.filter(f=>!!f.badge).map(f=>f.slug)),r=await renderTemplate(I("macros/condition"),{i18n:ae,conditions:Array.from(new Set(a.sort((f,h)=>f.name.localeCompare(h.name))))}),i=o(f=>{let{name:h,slug:p}=f.find("[name=condition] :selected").data();f.find("[name=name]").prop("placeholder",ae("effect-name",{condition:h}));let d=s.has(p),g=f.find("[name=badge]");g.prop("disabled",!d),d||g.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:r,title:ae("title"),close:()=>null,render:f=>{i(f),f.find("[name=condition]").on("change",()=>i(f))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&s.has(c.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let u={name:c.name,type:"effect",img:c.img,system:{rules:[l],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(u):await e.createEmbeddedDocuments("Item",[u])}o(Jn,"permaConditionEffect");var rt=[ft(),cn(),wt(),Vt(),Yn(),Xt(),mt(),Dn(),Cn(),Dt(),sn(),ln(),Bn()],Qn=new Set,it=null;Hooks.once("init",()=>{let e=we(),t=rt.flatMap(({settings:r=[]})=>r.map(i=>{let c=i.name;return i.choices&&(i.choices=i.choices.reduce((l,u)=>(l[u]=st(c,`choices.${u}`),l),{})),i.key=c,i.scope??="world",i.config??=!0,i.name=st(c,"name"),i.hint=st(c,"hint"),i})),[n,a]=["world","client"].map(r=>t.filter(i=>i.scope===r));[n,a].forEach(r=>r.forEach(i=>game.settings.register(S,i.key,i))),e&&(it=a[0].key,Hooks.on("renderSettingsConfig",Ts));let s=game.modules.get(S);s.api={macros:{permaConditionEffect:Jn}},rt.forEach(r=>{let{init:i,conflicts:c=[],api:l,name:u}=r;if(e)for(let f of c){let h=game.modules.get(f);h?.active&&(r.conflicting=!0,Qn.add(h.title))}l&&u&&(s.api[u]=l),!r.conflicting&&i&&i(e)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of rt)!t&&n&&n(e);if(e)for(let t of Qn)P("module-conflict",{name:t},!0)});function st(e,t){return`${S}.settings.${e}.${t}`}o(st,"settingPath");function Ts(e,t){if(!it)return;t.find(`.tab[data-tab=${S}] [data-setting-id="${S}.${it}"]`).before(`<h3>${w("settings.client")}</h3>`)}o(Ts,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
