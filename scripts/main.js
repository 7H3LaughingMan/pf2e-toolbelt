(()=>{var Gt=Object.defineProperty;var i=(e,t)=>Gt(e,"name",{value:t,configurable:!0});var p="pf2e-toolbelt";function R(e,t,n){return libWrapper.register(p,e,t,n)}i(R,"registerWrapper");function k(...e){let[t,n]=e;return t=`${p}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}i(k,"localize");function zt(e){return game.i18n.has(`${p}.${e}`,!1)}i(zt,"hasLocalization");function Bt(e){return`${p}.${e}`}i(Bt,"localizePath");function b(e){let t=i((...n)=>k(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>w(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>F(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>N(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>zt(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>Bt(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:o})=>t(n,o),enumerable:!1,configurable:!1}}),t}i(b,"subLocalize");function ce(e,t,n,o){let s=typeof t=="string"?t:"info",a=typeof t=="object"?t:typeof n=="object"?n:void 0,c=typeof t=="boolean"?t:typeof n=="boolean"?n:o??!1;ui.notifications.notify(k(e,a),s,{permanent:c})}i(ce,"notify");function w(...e){let[t,n,o]=e;ce(t,"warning",n,o)}i(w,"warn");function F(...e){let[t,n,o]=e;ce(t,"info",n,o)}i(F,"info");function N(...e){let[t,n,o]=e;ce(t,"error",n,o)}i(N,"error");function m(e){return game.settings.get(p,e)}i(m,"getSetting");function De(e,t){return game.settings.set(p,e,t)}i(De,"setSetting");var qt="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Wt="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Vt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Yt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",Kt=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function Ee(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{m("arp")&&(R(qt,Qt,"WRAPPER"),R(Wt,Zt,"WRAPPER"),R(Vt,en,"WRAPPER"),R(Yt,on,"WRAPPER"))},ready:e=>{e&&m("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),F("arp.forceVariant"))}}}i(Ee,"registerArp");function J(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}i(J,"isValidActor");function Ae(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!Kt.includes(e.sourceId)}i(Ae,"isValidWeapon");function Qt(e){let t=this.actor;if(!J(t,!0)||!Ae(this))return e();let n=t.level,o=this._source.system.traits.value;if(o.includes("alchemical")&&o.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}i(Qt,"onPrepareWeaponData");var Jt={1:35,2:935,3:8935,4:8935},Xt={striking:65,greaterStriking:1065,majorStriking:31065};function Zt(e){if(e(),!J(this.actor)||this.isSpecific||!Ae(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Jt[n]);let o=this.system.strikingRune.value;o&&(t-=Xt[o]),(n||o)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}i(Zt,"onPrepareWeaponDerivedData");function Te(e){return!e.isShield}i(Te,"isValidArmor");function en(e){let t=this.actor;if(!J(t,!0)||!Te(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}i(en,"onPrepareArmorData");var tn={1:160,2:1060,3:20560,4:20560},nn={resilient:340,greaterResilient:3440,majorResilient:49440};function on(e){if(e(),!J(this.actor)||this.isSpecific||!Te(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=tn[n]);let o=this.system.resiliencyRune.value;o&&(t-=nn[o]),(n||o)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}i(on,"onPrepareArmorDerivedData");function D(e,t,n=()=>{}){let o=null;return function(s,a=[],c=!1){typeof a=="string"&&(a=[a]),s||=a.some(r=>m(r)),s&&!o?o=Hooks.on(e,t):!s&&o&&(Hooks.off(e,o),o=null),c||n(s)}}i(D,"createHook");function X(e,t,n=()=>{}){let o=null;return function(s,a=!1){s==="disabled"&&o?(Hooks.off(e,o),o=null):s!=="disabled"&&!o&&(o=Hooks.on(e,t)),a||n(s)}}i(X,"createChoicesHook");function Pe(e,t){let n=Hooks.on(e,t),o=Hooks.events[e].findIndex(s=>s.id===n);if(o!==0){let[s]=Hooks.events[e].splice(o,1);Hooks.events[e].unshift(s)}return n}i(Pe,"registerUpstreamHook");var le=D("renderEffectsPanel",an,sn);function Oe(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>le(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>le(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{le(!1,["effect-remove","condition-sheet"])}}}i(Oe,"registerEffectsPanelHelper");function sn(){game.pf2e.effectPanel?.render()}i(sn,"refreshEffectsPanel");function an(e,t){let n=`<div>${k("effects.remove")}</div>`,o='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',s=t.find(".effect-item[data-item-id]").toArray();for(let a of s){let c=a.dataset.itemId,r=e.actor?.items.get(c);if(r&&(m("effect-remove")&&!r.isLocked&&r.badge&&r.badge.type==="counter"&&(a.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),a.querySelector(".icon").addEventListener("contextmenu",l=>cn(l,e),!0)),m("condition-sheet")&&r.isOfType("condition"))){let l=a.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",o),l.querySelector('[data-action="edit"]').addEventListener("click",u=>rn(u,e))}}}i(an,"renderEffectsPanel");function rn(e,t){let n=xe(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}i(rn,"onConditionSheet");function cn(e,t){if(!e.shiftKey)return;let n=xe(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}i(cn,"onRemoveEffect");function xe(e,t){let s=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(s)}i(xe,"getEffect");var z=class extends FormApplication{constructor(t,n,o){super(t,n),this.onSubmitCallback=o}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};i(z,"MoveLootPopup");function fe(){return CONFIG.ChatMessage.documentClass}i(fe,"getChatMessageClass");function*B(e,t){let n=game.messages.contents,o=(t?n.findLastIndex(s=>s===t):n.length)-1;for(let s=o;s>=o-e;s--){let a=n[s];if(!a)return;yield a}}i(B,"latestChatMessages");function M(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}i(M,"chatUUID");function Z(e){game.socket.on(`module.${p}`,e)}i(Z,"socketOn");function ee(e){game.socket.off(`module.${p}`,e)}i(ee,"socketOff");function x(e){game.socket.emit(`module.${p}`,e)}i(x,"socketEmit");function te(){return game.user===game.users.activeGM}i(te,"isActiveGM");function Re(){return game.users.some(e=>e.active&&e.isGM)}i(Re,"isGMOnline");function Me(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}i(Me,"getCharacterOwner");function ln(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,o)=>n.id>o.id?1:-1),t[0]||null}i(ln,"getActiveOwner");function ue(e){return ln(e)===game.user}i(ue,"isActiveOwner");function Ue(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}i(Ue,"getOwner");var ne=!1,q=null;function He(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:$e}],conflicts:["pf2e-giveth"],ready:e=>{m("giveth")!=="disabled"&&$e(!0)}}}i(He,"registerGiveth");function $e(e){let t=game.user.isGM;e==="disabled"&&ne?(t?ee(_e):q&&(Hooks.off("dropCanvasData",q),q=null),ne=!1):e!=="disabled"&&!ne&&(t?Z(_e):q||(q=Pe("dropCanvasData",fn)),ne=!0)}i($e,"setup");function _e(e){te()&&(e.type==="giveth-condition"?mn(e):e.type==="giveth-effect"?pn(e):gn(e))}i(_e,"onSocket");function fn(e,t){if(!Re())return!0;let n=dn(t);if(!n)return!0;let o=e.tokens.placeables.slice().filter(s=>{if(!s.document.actorLink)return!1;let a=s.actor;if(!Fe(a,t.actorId)||a.isOwner)return!1;let c=s.x+(s.hitArea?.right??0),r=s.y+(s.hitArea?.bottom??0);return t.x>=s.x&&t.y>=s.y&&t.x<=c&&t.y<=r}).sort((s,a)=>a.document.sort-s.document.sort).at(0)?.actor;return o?(un(n.actor,o,n.item,n.value),!1):!0}i(fn,"onDropCanvasData");function un(e,t,n,o){let s=e.id,a=t.id,c=!(n instanceof Item);if(!c&&n.isOfType("physical")){let r=n.quantity;if(r<1)return w("giveth.notification.zero");if(r===1)return Le(s,a,n.id,1,!1);new z(e,{maxQuantity:r,lockStack:!1,isPurchase:!1},(l,u)=>{Le(s,a,n.id,l,u)}).render(!0)}else{let r=c?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?x({type:"giveth-condition",targetId:a,value:o??1,uuid:r}):x({type:"giveth-effect",targetId:a,uuid:r})}}i(un,"giveth");function Le(e,t,n,o,s){x({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:o,stack:s})}i(Le,"sendPhysicalRequest");function Fe(e,t){return!e||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}i(Fe,"isValidActor");function dn(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let s=e.context?.origin.actor;n=s?fromUuidSync(s):null}if(!Fe(n)||!n.isOwner)return;let o=!(t instanceof Item);if(o&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!o&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}i(dn,"getDetailsFromData");async function mn({targetId:e,uuid:t,value:n}){let o=game.actors.get(e);if(!o)return;let s=await fromUuid(t);s&&o.increaseCondition(s.slug,{min:n})}i(mn,"takethCondition");async function pn({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let o=await fromUuid(t);if(!o)return;let s=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[s])}i(pn,"takethEffect");async function gn({itemId:e,ownerId:t,qty:n,stack:o,targetId:s}){let a=game.actors.get(t),c=game.actors.get(s);if(!a||!c)return;let r=a.items.get(e);if(!r)return;n=Math.min(n,r.quantity);let l=r.quantity-n,u=r.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",r.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=r.traits.has("invested")?!1:null);let d=await c.addToInventory(u,void 0,o);if(!d||(l<1?r.delete():r.update({"system.quantity":l}),m("giveth")==="no-message"))return;let h=M(d.uuid,d.name,!d.isIdentified);n>1&&(h+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${k("giveth.giveth",{target:c.name})}</h4>`,content:h,speaker:ChatMessage.getSpeaker({actor:a})})}i(gn,"takethPhysical");function I(e,t,n){return e.getFlag(p,t)??n}i(I,"getFlag");function de(e,t,n){return e.setFlag(p,t,n)}i(de,"setFlag");function v(...e){return e=e.filter(t=>typeof t=="string"),`modules/${p}/templates/${e.join("/")}.hbs`}i(v,"templatePath");var Ne=b("knowledges.editLore"),W=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Ne("title",this.actor)}get template(){return v("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:I(n,"unspecified")??"",specific:I(n,"specific")??"",i18n:Ne})}async _updateObject(t,{unspecified:n,specific:o}){let s=this.object;de(s,"unspecified",n.trim()),de(s,"specific",o.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};i(W,"EditLores");var je=D("renderNPCSheetPF2e",hn);function Ge(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>je(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&m("knowledges")&&je(!0)}}}i(Ge,"registerKnowledges");function hn(e,t){let n=e.actor;bn(n,t),Cn(t),vn(n,t)}i(hn,"renderNPCSheetPF2e");function me(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}i(me,"knowledgeSelector");function yn(e){new W(e).render(!0)}i(yn,"editLores");function bn(e,t){let n=I(e,"unspecified"),o=I(e,"specific");if(!n&&!o)return;let s=e.identificationDCs.lore,a=me(t,"body","");a.find(".identification-skills").last().remove();function c(l,u,d){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:d})}</div>`}i(c,"tag");function r(l,{dc:u,start:d}){let h=l.split(",").filter(g=>g.trim()).map(g=>c(g,u,d)).join("");a.append(h)}i(r,"addTags"),r(n||"Unspecific",s[0]),r(o||"Specific",s[1])}i(bn,"replaceLores");function vn(e,t){me(t,"header","button.edit").on("click",()=>yn(e))}i(vn,"addEvents");function Cn(e){let t=me(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}i(Cn,"addEditButton");var pe=b("merge.multi"),V=class extends Application{constructor(t,n){super(n),this._spell=t}get spell(){return this._spell}get title(){return pe("title",this.spell)}get template(){return v("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:pe})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){pe.error("zero"),this.close();return}let o=this.spell,s=deepClone(o._source.system.damage.value),a=deepClone(o._source.system.heightening)??{};for(let[r,l]of Object.entries(s))for(let u=0;u<n-1;u++){let d=randomID();if(s[d]=l,a.type==="interval"){let h=a.damage[r];h&&(a.damage[d]=h)}else if(a.type==="fixed")for(let[h,g]of Object.entries(a.levels)){let S=g.damage.value[r];S&&(a.levels[h].damage.value[d]=S)}}o.clone({"system.damage.value":s,"system.heightening":a}).rollDamage(t),this.close()}#t(t){t.preventDefault(),this.close()}};i(V,"MultiCast");function oe(e,t){return e.localeCompare(t,game.i18n.lang)}i(oe,"localeCompare");function H(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}i(H,"refreshCharacterSheets");function ze(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let o of e){let s=n.findIndex(a=>o===a);if(s===-1)return!1;n.splice(s,1)}return!0}i(ze,"compareArrays");var Sn=/<div class="tags"><span class="tag".+?<\/div>/gm,kn=/<span class="tag tag_transparent">(.+?)<\/span>/gm,In=/(\[[\w,]+\])/,ge=D("renderChatMessage",Ke,wn);function Ye(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>ge(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>ge(e,"merge-damage")}],init:e=>{ge(!1,["multi-cast","merge-damage"],!0)}}}i(Ye,"registerMerge");function wn(){let e=ui.chat?.element;if(e)for(let t of B(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),Ke(t,n))}}i(wn,"updateMessages");function Ke(e,t){!game.user.isGM&&!e.isAuthor||(m("merge-damage")&&Xe(e)?En(e,t):m("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&Dn(e,t))}i(Ke,"renderChatMessage");function Dn(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let o=t.find(".message-content .chat-card .owner-buttons .spell-button");o.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${localize("merge.spell.button")}</button>`),o.find("[data-action=multi-cast]").on("click",async s=>{let a=await fromUuid(n);a&&new V(a).render(!0)})}i(Dn,"renderSpell");function En(e,t){let n='<span class="pf2e-toolbelt-merge">';if(I(e,"merged")){let c=localize("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${c}">`,n+='<i class="fa-duotone fa-split"></i>'}let o=localize("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${o}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let s=We(e),a=Ve(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",c=>{c.stopPropagation();for(let r of B(5,e))if(!(!Xe(r)||We(r)!==s||Ve(r)!==a)){Tn(c,e,r,{actorUUID:s,targetUUID:a});return}w("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",c=>{c.stopPropagation(),An(c,e)})}i(En,"renderDamage");async function An(e,t){let n=I(t,"data").flatMap(o=>o.source);await Qe(t.id),await fe().createDocuments(n)}i(An,"splitDamages");async function Tn(e,t,n,{actorUUID:o,targetUUID:s}){let a={},c=Be(n).concat(Be(t));for(let{name:f,notes:y,outcome:E,modifiers:C,tags:P}of c)a[f]??={name:f,tags:P,notes:new Set,results:[]},y.forEach(a[f].notes.add,a[f].notes),a[f].results.some(T=>T.outcome===E&&ze(T.modifiers,C))||a[f].results.push({outcome:E,modifiers:C});let r=Object.values(a).map(f=>(f.label=f.name,f.results.forEach(y=>{y.outcome&&(y.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${y.outcome}`))}),f));r.at(-1).isLastGroup=!0;let l=await renderTemplate(v("merge/merged"),{groups:r,hasMultipleGroups:r.length>1}),u=qe(t),d=qe(n),h=[];function g(f){return h.find(({options:{flavor:y,critRule:E}})=>y===f.flavor&&E===f.critRule)}i(g,"findGroup");for(let f of[].concat(d,u)){let{options:y,total:E,terms:C}=f,P=C[0],O=f.formula.replace(In,""),T=g(y);T?(T.terms.push(P),T.total+=E,T.formulas.push(O)):h.push({options:y,formulas:[O],total:E,terms:[P]})}for(let f of h)f.formula=`(${f.formulas.join(" + ")})[${f.options.flavor}]`,f.term=f.terms.length<2?f.terms[0]:Je(f.terms);let S={class:"DamageRoll",options:{},dice:[],formula:`{${h.map(({formula:f})=>f).join(", ")}}`,total:h.reduce((f,{total:y})=>f+y,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:h.map(({formula:f})=>f),modifiers:[],rolls:h.map(({options:f,formula:y,total:E,term:C})=>({class:"DamageInstance",options:f,dice:[],formula:y,total:E,terms:[C],evaluated:!0})),results:h.map(({total:f})=>({result:f,active:!0}))}]};await Qe(t.id,n.id),await fe().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[p]:{actor:o,target:s,merged:!0,type:"damage-roll",data:c}},rolls:[S]})}i(Tn,"mergeDamages");function Be(e){let t=I(e,"data");if(t)return t;let n=e.toObject();return delete n._id,delete n.timestamp,[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,modifiers:Pn(e),tags:e.flavor.match(Sn)?.[0]??"",notes:n.flags.pf2e.context.notes.map(({title:o,text:s})=>`<strong>${game.i18n.localize(o)}</strong> ${game.i18n.localize(s)}`)}]}i(Be,"getMessageData");function Qe(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}i(Qe,"removeChatMessages");function Je(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?Je(e):e[0]]}}}i(Je,"createTermGroup");function qe(e){return I(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}i(qe,"getMessageRolls");function We(e){return I(e,"actor")??e.actor?.uuid}i(We,"getActorUUID");function Ve(e){return I(e,"target")??e.target?.actor.uuid}i(Ve,"getTargetUUID");function Xe(e){return I(e,"type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}i(Xe,"isDamageRoll");function Pn(e){let t=[],n;for(;n=kn.exec(e.flavor);)t.push(n[1]);return t}i(Pn,"getMessageModifiers");var On="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",xn="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function Ze(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{m("nobulk")&&R(On,Mn,"WRAPPER"),m("nobulk-coins")&&R(xn,Rn,"WRAPPER")}}}i(Ze,"registerNobulk");function Rn(e){e(),this.isCoinage&&(this.system.bulk.value=0)}i(Rn,"treasurePrepareBaseData");function Mn(e,...t){e(...t);let n=this,o=n.inventory.bulk.constructor,s=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return s||(s=o.computeTotalBulk(this.actor.inventory.filter(a=>!a.isInContainer&&a.system.equipped.carryType!=="dropped"),this.actor.size),s)}})}i(Mn,"actorPrepareEmbeddedDocuments");function et(e){return e.getFlag("core","sourceId")}i(et,"getSourceId");function Un(e,t){let n=et(e);return n?t.includes(n):!1}i(Un,"includesSourceId");function tt(e){return Array.isArray(e)?t=>Un(t,e):t=>et(t)===e}i(tt,"getItemSourceIdCondition");function nt(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}i(nt,"getItems");function ot(e,t,n){return nt(e,n).some(tt(t))}i(ot,"hasItemWithSourceId");function ie(e,t,n){return nt(e,n).find(tt(t))}i(ie,"getItemWithSourceId");var $n=D("renderCharacterSheetPF2e",Gn),_n=D("deleteCombat",Bn),Ln=D("deleteCombatant",ft),Hn=D("createCombatant",qn),Fn=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Nn=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),jn=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function st(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:it},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:he,toggleStance:lt,isValidStance:at},ready:e=>{m("stances")&&it(!0)}}}i(st,"registerStances");function it(e){$n(e),_n(e),Ln(e),Hn(e)}i(it,"setup");function at(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}i(at,"isValidStance");function he(e){let t=[],n=new Set;for(let{replace:o,sourceId:s,effectUUID:a,effect:c,img:r,name:l,itemName:u,action:d}of rt(e)){o&&n.add(o);let h=d?ie(e,d,"action"):ie(e,s,"feat");t.push({name:l,itemName:u,uuid:s,img:r,effectUUID:a,effectID:c?.id,actionUUID:h.sourceId,actionID:h.id})}return t.filter(({uuid:o})=>!n.has(o))}i(he,"getStances");async function Gn(e,t){let n=e.actor,o=await he(n);if(!o.length)return;let s=n.getActiveTokens(!0,!0).some(l=>l.inCombat),a=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),c=a.find(".actions-options"),r=await renderTemplate(v("stances/sheet"),{stances:o,canUseStances:s&&!n.isDead,i18n:b("stances")});c.length?c.after(r):a.prepend(r),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>zn(l,n))}i(Gn,"renderCharacterSheetPF2e");function zn(e,t){let n=e.currentTarget,o=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!o)return;let s=n.dataset.effectUuid;lt(t,s)}i(zn,"onToggleStance");function*rt(e){for(let t of e.itemTypes.feat){let n=t.sourceId,o=Nn.get(n),s=jn.get(n);if(!o&&!s&&!at(t))continue;let a=o?.effect??s?.effect??t.system.selfEffect.uuid,c=fromUuidSync(a);c&&(yield{name:(o&&fromUuidSync(o.replace)?.name)??t.name,itemName:t.name,replace:o?.replace,extra:s,sourceId:n,effectUUID:a,effect:ie(e,a,"effect"),action:s?.action,img:c.img})}}i(rt,"actorStances");function ct(e){let t=[];for(let{effect:n}of rt(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}i(ct,"getStancesEffects");async function lt(e,t){let n=ct(e),o=n.findIndex(a=>a.uuid===t),s=!1;if(o===-1)s=!0;else{let a=n.filter(r=>r.uuid!==t).length,c=n.filter(r=>r.uuid===t).length>1;(a||c)&&n.splice(o,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(a=>a.id)),s&&ye(e,t)}i(lt,"toggleStance");async function ye(e,t){let n=await fromUuid(t);if(n){let o=n.toObject();return getProperty(o,"flags.core.sourceId")||setProperty(o,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[o]))[0]?.toMessage(),!0}return!1}i(ye,"addStance");function Bn(e){for(let t of e.combatants)ft(t)}i(Bn,"deleteCombat");function ft(e){let t=ut(e);if(t){if(!game.user.isGM&&ue(t)){let n=ct(t).map(o=>o.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}H(t)}}i(ft,"deleteCombatant");function qn(e){let t=ut(e);t&&(!game.user.isGM&&ue(t)&&Wn(t),H(t))}i(qn,"createCombatant");function ut(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}i(ut,"getActorFromCombatant");async function Wn(e){let t=he(e);if(!(!t.length||t.filter(({effectID:s})=>s).length||!ot(e,Fn,["feat"])))if(t.length===1){let s=t[0];await ye(e,s.effectUUID)&&F("stances.useStance",{stance:s.name})}else Vn(e,t)}i(Wn,"checkForSavant");async function Vn(e,t){let n=b("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(v("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:o=>ye(e,o.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}i(Vn,"openStancesMenu");var dt=X("renderCharacterSheetPF2e",Yn,()=>H());function mt(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>dt(e)}],conflicts:["pf2e-spells-summary"],init:e=>{m("summary")!=="disabled"&&dt(!0,!0)}}}i(mt,"registerSpellsSummary");async function Yn(e,t){let n=e.actor;if(!n||n.pack||!n.id||!game.actors.has(n.id))return;let o=Y(t);getProperty(e,`modules.${p}.toggled`)&&o.addClass("toggled"),co(t).on("click",s=>ro(s,t,e)),await Kn(t,e,n),o.hasClass("toggled")&&o.hasClass("active")&&e._restoreScrollPositions(t)}i(Yn,"renderCharacterSheetPF2e");async function Kn(e,t,n){let o=Y(e),s=await uo(n),a=await renderTemplate(v("summary/sheet"),s);o.append(a),Qn(e,t,n)}i(Kn,"addSummaryTab");function Qn(e,t,n){let o=fo(e),s=o.find(".spell-type .uses .spell-slots-input input");s.on("change",a=>Jn(a,n)),s.on("focus",Xn),s.on("blur",Zn),o.find(".cast-spell").on("click",a=>io(a,n)),o.find(".item-toggle-prepare").on("click",a=>eo(a,n)),o.find(".focus-pips").on("click contextmenu",a=>to(a,n)),o.find(".spell-slots-increment-reset").on("click",a=>oo(a,t,n)),o.find(".item-image").on("click",a=>ao(a,n)),o.find(".item-name > h4").on("click",a=>so(a,t))}i(Qn,"addSummaryEvents");async function Jn(e,t){e.preventDefault();let{inputPath:n,entryId:o}=$(e.currentTarget).data(),s=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:o,[n]:s}])}i(Jn,"onUsesInputChange");function Xn(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}i(Xn,"onUsesInputFocus");function Zn(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}i(Zn,"onUsesInputBlur");function eo(e,t){e.preventDefault();let{slotLevel:n,slotId:o,entryId:s,expended:a}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(s)?.setSlotExpendedState(n??0,o??0,a!==!0)}i(eo,"onTogglePrepare");function to(e,t){e.preventDefault();let n=e.type==="click"?1:-1,o=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":o})}i(to,"onToggleFocusPool");function no(e,t){lo(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}i(no,"onChargeReset");function oo(e,t,n){e.preventDefault();let{itemId:o,level:s,isCharge:a}=$(e.currentTarget).data();if(!o)return;if(a){no(t,o);return}let c=n.items.get(o);if(c){if(c.isOfType("spellcastingEntry")){let r=s>=0&&s<=11?`slot${s}`:"slot0",l=c.system.slots?.[r];l&&c.update({[`system.slots.${r}.value`]:l.max})}else if(c.isOfType("spell")){let r=c.system.location.uses?.max;r&&c.update({"system.location.uses.value":r})}}}i(oo,"onSlotsReset");function io(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:o,slotLevel:s,slotId:a,entryId:c}=n.closest(".item").data(),r=t.spellcasting.collections.get(c);if(!r)return;let l=r.get(o);l&&r.entry.cast(l,{slot:a,level:s})}i(io,"onCastSpell");async function so(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}i(so,"onToggleSummary");async function ao(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),o=t.items.get(n);!o||o.isOfType("physical")&&!o.isIdentified||await o.toMessage(e)}i(ao,"onItemToChat");function ro(e,t,n){e.preventDefault();let o=Y(t);o.hasClass("active")&&(o.toggleClass("toggled"),o.scrollTop(0),setProperty(n,`modules.${p}.toggled`,o.hasClass("toggled")))}i(ro,"onSpellcastingBtnToggle");function co(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}i(co,"getSpellcastingNav");function Y(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}i(Y,"getSpellcastingTab");function lo(e){return Y(e).find(".directory-list.spellcastingEntry-list")}i(lo,"getSpellcastingOriginalSection");function fo(e){return Y(e).find(".directory-list.summary")}i(fo,"getSpellcastingSummarySection");async function uo(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,o=[],s=[],a=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,d=l.statistic.dc.value,h=l.name,g=await l.getSheetData(),S=g.isFocusPool,f=l.system?.prepared?.value==="charge",y=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,E={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let C of g.levels){if(!C.active.length||C.uses?.max===0)continue;let P=[],O=C.isCantrip,T=C.active.filter(_=>_&&_.uses?.max!==0),we=!O&&f&&!n;for(let _=0;_<T.length;_++){let{spell:L,expended:Ht,virtual:Ft,uses:Nt,castLevel:jt}=T[_];P.push({name:L.name,img:L.img,range:L.system.range.value||"-",castLevel:jt??L.level,slotId:_,entryId:u,entryDc:d,entryName:h,itemId:L.id,inputId:g.isInnate?L.id:g.id,inputPath:f?"flags.pf2e-staves.charges":g.isInnate?"system.location.uses.value":`system.slots.slot${C.level}.value`,isCharge:f,isActiveCharge:f&&n,isBroken:we,isVirtual:Ft,isInnate:g.isInnate,isCantrip:O,isFocus:S,isPrepared:g.isPrepared,isSpontaneous:g.isSpontaneous||g.isFlexible,slotLevel:C.level,uses:Nt??(f?E:C.uses),expended:Ht??(S&&!O?t.value<=0:!1),action:L.system.time.value,type:f?y?`${p}.summary.staff`:`${p}.summary.charges`:g.isInnate?"PF2E.PreparationTypeInnate":g.isSpontaneous?"PF2E.PreparationTypeSpontaneous":g.isFlexible?"PF2E.SpellFlexibleLabel":S?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:f?0:g.isPrepared?1:S?2:g.isInnate?3:g.isSpontaneous?4:5,noHover:g.isPrepared||O||we||S})}if(P.length){if(S)if(O)a=!0;else{s.push(...P);continue}o[C.level]??=[],o[C.level].push(...P)}}})),o.length){let l=m("summary")==="sort"?(u,d)=>u.order===d.order?oe(u.name,d.name):u.order-d.order:(u,d)=>oe(u.name,d.name);o.forEach(u=>u.sort(l))}s.length&&(s.sort((l,u)=>oe(l.name,u.name)),o[12]=s,a=!1);let r=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:d})=>({name:d.name,img:d.img,slotId:u,itemId:d.id,level:d.level,time:d.system.time.value})).filter(Boolean));return{spells:o,rituals:r,focusPool:t,stavesActive:n,hasFocusCantrips:a,isOwner:e.isOwner}}i(uo,"getData");var K=null,U=null;function gt(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:pt}],conflicts:["pf2e-unided"],init:()=>{pt()}}}i(gt,"registerUnided");function pt(e){e??=m("unided"),e==="disabled"?(K&&(Hooks.off("preCreateItem",K),K=null),U&&(Hooks.off("preUpdateItem",U),U=null)):(K||(K=Hooks.on("preCreateItem",mo)),e==="all"&&!U?U=Hooks.on("preUpdateItem",po):e!=="all"&&U&&(Hooks.off("preUpdateItem",U),U=null))}i(pt,"setHooks");function mo(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}i(mo,"preCreateItem");function po(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}i(po,"preUpdateItem");var j=b("hero.templates.trade"),Q=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:j("title"),template:v("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){j.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:A(this.actor),targetActions:this.target?A(this.target):[],i18n:j})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){j.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){j.warn("no-select");return}let o=Me(this.target,!0)??Ue(this.target,!0)??game.users.activeGM;if(!o){j.warn("no-user");return}ht({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:o.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};i(Q,"Trade");var se="pf2e-hero-actions",yt=null,bt=D("renderCharacterSheetPF2e",bo,yo),go="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",ae="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",ho="systems/pf2e/icons/features/feats/heroic-recovery.webp";function Ct(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>bt(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>H()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[se],api:{createTable:Mo,removeHeroActions:Ho,getHeroActions:A,useHeroAction:Dt,getHeroActionDetails:re,drawHeroAction:wt,drawHeroActions:St,sendActionToChat:Pt,discardHeroActions:Et,tradeHeroAction:It},ready:()=>{bt(!1,"hero")}}}i(Ct,"registerHeroActions");function yo(e){e&&!yt?Z(vt):!e&&yt&&ee(vt)}i(yo,"setupSocket");function vt(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;Mt(e);break;case"trade-accept":if(!te())return;xt(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;xo(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;Rt(e.error);break}}i(vt,"onSocket");async function bo(e,t){let n=e.actor;!n||n.pack||!n.id||!game.actors.has(n.id)||(await vo(t,n),Co(t,n))}i(bo,"renderCharacterSheetPF2e");async function vo(e,t){let n=A(t),o=t.heroPoints.value-n.length,s=t.isOwner,a=b("hero.templates.heroActions"),c=await renderTemplate(v("hero/sheet"),{owner:s,list:n,canUse:o>=0&&s,canDraw:o>0&&s,canTrade:m("hero-trade"),mustDiscard:o<0,diff:Math.abs(o),i18n:(r,{hash:l})=>a(r,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(c)}i(vo,"addActionsToSheet");function Co(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",o=>Do(t,o)),n.find("[data-action=expand]").on("click",Eo),n.find("[data-action=use]").on("click",o=>wo(t,o)),n.find("[data-action=display]").on("click",o=>Io(t,o)),n.find("[data-action=discard]").on("click",ko),n.find("[data-action=discard-selected]").on("click",()=>So(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>It(t))}i(Co,"addSheetEvents");async function So(e,t){let o=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(s=>s.dataset.uuid);Et(e,o)}i(So,"onClickHeroActionsDiscard");function ko(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let o=Number(n.attr("data-discard")??"0"),s=n.find(".action.discarded");n.toggleClass("discardable",s.length===o)}i(ko,"onClickHeroActionDiscard");async function Io(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Pt(e,n)}i(Io,"onClickHeroActionDisplay");async function wo(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Dt(e,n)}i(wo,"onClickHeroActionUse");async function Do(e,t){t.preventDefault(),St(e)}i(Do,"onClickHeroActionsDraw");function A(e){return getProperty(e,`flags.${se}.heroActions`)??[]}i(A,"getHeroActions");function G(e,t){return e.update({[`flags.${se}.heroActions`]:t})}i(G,"setHeroActions");async function Eo(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let o=t.attr("data-uuid"),s=await re(o);if(!s)return;let a=await TextEditor.enrichHTML(s.description,{async:!0});n.find(".item-description").html(a),n.addClass("loaded")}t.toggleClass("expanded")}i(Eo,"onClickHeroActionExpand");async function re(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,o=t instanceof JournalEntry?t.pages.contents[0]:t,s=o?.text.content;if(s)return n.uuid===go&&(s=s.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:o.name,description:s}}i(re,"getHeroActionDetails");async function St(e){let t=A(e),n=e.heroPoints.value-t.length,o=[];for(let r=0;r<n;r++){let l=await wt();if(l!==void 0){if(l===null)return;t.push(l),o.push(l)}}if(!o.length)return;G(e,t);let{content:s,size:a}=kt(o),c={flavor:`<h4 class="action">${k("hero.actions-draw.header",{nb:a})}</h4>`,content:s,speaker:ChatMessage.getSpeaker({actor:e})};m("hero-private")&&(c.type=CONST.CHAT_MESSAGE_TYPES.ROLL,c.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(c)}i(St,"drawHeroActions");function kt(e){let t=e.map(({uuid:n,name:o})=>M(n,o));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}i(kt,"chatActions");function It(e){let t=A(e);if(!t||!t.length){w("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){w("hero.no-points",{nb:n.toString()});return}new Q(e).render(!0)}i(It,"tradeHeroAction");async function wt(){let e=await Oo(),t=b("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(a=>!a.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let o=jo(n);if(o)return{uuid:o,name:await Ao(n,o)}}i(wt,"drawHeroAction");async function Dt(e,t){let n=e.heroPoints.value;if(n<1)return w("hero.use.noPoints");let o=A(e),s=o.findIndex(c=>c.uuid===t);if(s===-1)return;let a=await re(t);a||N("hero.use.noDetails"),o.splice(s,1),a?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${se}.heroActions`]:o}),ChatMessage.create({flavor:`<h4 class="action">${k("hero.actions-use.header")}</h4>`,content:`<h2>${a.name}</h2>${a.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):G(e,o)}i(Dt,"useHeroAction");async function Et(e,t){t=typeof t=="string"?[t]:t;let n=A(e),o=[];for(let c of t){let r=n.findIndex(l=>l.uuid===c);r!==-1&&(o.push(n[r]),n.splice(r,1))}G(e,n);let{content:s,size:a}=kt(o);ChatMessage.create({flavor:`<h4 class="action">${k("hero.actions-discard.header",{nb:a})}</h4>`,content:s,speaker:ChatMessage.getSpeaker({actor:e})})}i(Et,"discardHeroActions");async function Ao(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}i(Ao,"getLabelfromTableResult");async function At(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}i(At,"getTableFromUuid");async function To(){return At(ae)}i(To,"getDefaultCompendiumTable");function Tt(){return game.tables.find(e=>e.getFlag("core","sourceId")===ae)}i(Tt,"getDefaultWorldTable");async function Po(){return At(m("hero-table"))}i(Po,"getCustomTable");async function Oo(){return await Po()??Tt()??await To()}i(Oo,"getDeckTable");async function Pt(e,t){let n=await re(t);if(!n)return N("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}i(Pt,"sendActionToChat");function ht(e){if(e.receiver.id===game.user.id){Ot(e);return}x({...e,type:"trade-request"})}i(ht,"sendTradeRequest");function Ot(e){if(game.user.isGM){xt(e);return}x({...e,type:"trade-accept"})}i(Ot,"acceptRequest");async function xt(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){be(e);return}let a=A(o),c=A(s),r=a.findIndex(y=>y.uuid===t.uuid),l=c.findIndex(y=>y.uuid===n.uuid);if(r===-1||l===-1){be(e);return}let u=a.splice(r,1)[0],d=c.splice(l,1)[0];a.push(d),c.push(u),G(o,a),G(s,c);let h=M(u.uuid),g=M(d.uuid),S=b("hero.trade-success"),f=`<div style="line-height: 1.6">${S("offer",{offer:h})}</div>`;f+=`<div style="line-height: 1.6">${S("receive",{receive:g})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${S("header",{name:s.name})}</h4>`,content:f,speaker:ChatMessage.getSpeaker({actor:o})})}i(xt,"onTradeAccepted");function be({sender:e,receiver:t},n="trade-error"){let o=new Set([e.id,t.id]);o.has(game.user.id)&&(o.delete(game.user.id),Rt(n)),o.size&&x({type:"trade-error",users:Array.from(o),error:n})}i(be,"sendTradeError");function Rt(e){N("hero.trade-error")}i(Rt,"onTradeError");async function xo(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){be(e);return}let a=b("hero.trade-request"),c=`<p>${a("header",{sender:o.name,receiver:s.name})}</p>`;c+=`<p>${a("give",{give:M(t.uuid)})}</p>`,c+=`<p>${a("want",{want:M(n.uuid)})}</p>`,c+=`<p style="margin-bottom: 1em;">${a("accept")}</p>`,await Dialog.confirm({title:a("title"),content:await TextEditor.enrichHTML(c,{async:!0})})?Ot(e):Ro(e)}i(xo,"onTradeRequest");function Ro(e){if(e.sender.id===game.user.id){Mt(e);return}x({...e,type:"trade-reject"})}i(Ro,"rejectRequest");async function Mt({receiver:e}){let t=game.actors.get(e.cid);w("hero.trade-rejected",{name:t.name},!0)}i(Mt,"onTradeRejected");async function Mo(){let e=b("hero.templates.createTable.choice"),t=v("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:a=>{let c=a.find('.window-content input[name="type"]:checked').val(),r=a.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:c,unique:r}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-create-table"});s&&(s.type==="default"?_o(s.unique):Uo(s.unique))}i(Mo,"createTable");async function Uo(e){let t=await $o(e);await ve(t),t.sheet?.render(!0)}i(Uo,"createCustomTable");function $o(e=!0){let t=Ce(e);return RollTable.create(t,{temporary:!1})}i($o,"createCustomActionsTable");async function _o(e){let t=b("templates.createTable.default.confirm"),n=await Tt();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let s=Ce(e);return await n.update(s),ve(n,!0)}n=await Lo(e),await ve(n)}i(_o,"createDefaultTable");async function Lo(e=!0){let t=await fromUuid(ae),n=Ce(e,t);return RollTable.create(n,{temporary:!1})}i(Lo,"createDefautActionsTable");async function ve(e,t=!1){t&&await e.normalize(),await De("hero-table",e.uuid)}i(ve,"setTable");function Ce(e=!0,t){let n={name:k("hero.table.name"),replacement:!e,img:ho,description:k("hero.table.description"),flags:{core:{sourceId:ae}}};return t?mergeObject(deepClone(t._source),n):n}i(Ce,"getTableSource");async function Ho(){let e=b("hero.templates.removeActions"),t=v("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:a=>a.find('input[name="actor"]:checked').toArray().map(c=>game.actors.get(c.value)).filter(c=>c)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},o={content:await renderTemplate(t,{actors:game.actors.filter(a=>a.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:a=>{a.on("change",'input[name="all"]',()=>Fo(a)),a.on("change",'input[name="actor"]',()=>No(a))},close:()=>[]},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!s.length){e.warn("noSelection");return}for(let a of s)G(a,[]);e.info("removed")}i(Ho,"removeHeroActions");function Fo(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}i(Fo,"removeActionsToggleAll");function No(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),o=e.find('input[name="all"]');t.length===n.length?(o.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?o.prop("checked",!1).prop("indeterminate",!0):(o.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}i(No,"removeActionsToggleActor");function jo(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}i(jo,"documentUuidFromTableResult");var Ut=X("renderChatMessage",_t,Go);function $t(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>Ut(e)}],init:e=>{!e&&m("modifiers")!=="disabled"&&Ut(!0,!0)}}}i($t,"registerHideModifiers");function Go(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of B(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),_t(t,n))}}i(Go,"updateMessages");function _t(e,t){let n=e.speaker,o=ChatMessage.getSpeakerActor(n);if(!o||o.hasPlayerOwner)return;let s=t.find(".message-header");m("modifiers")==="traits"&&s.addClass("pf2e-toolbelt-modifiers-traits"),m("modifiers")!=="disabled"&&s.addClass("pf2e-toolbelt-modifiers")}i(_t,"renderChatMessage");var ke=[Ee(),Ze(),He(),Ge(),gt(),Ye(),Oe(),mt(),st(),Ct(),$t()],Lt=new Set,Ie=null;Hooks.once("init",()=>{let e=game.data.users.find(c=>c._id===game.data.userId),t=e&&e.role>=CONST.USER_ROLES.GAMEMASTER,n=ke.flatMap(({settings:c=[]})=>c.map(r=>{let l=r.name;return r.choices&&(r.choices=r.choices.reduce((u,d)=>(u[d]=Se(l,`choices.${d}`),u),{})),r.key=l,r.scope??="world",r.config??=!0,r.name=Se(l,"name"),r.hint=Se(l,"hint"),r})),[o,s]=["world","client"].map(c=>n.filter(r=>r.scope===c));[o,s].forEach(c=>c.forEach(r=>game.settings.register(p,r.key,r))),t&&(Ie=s[0].key,Hooks.on("renderSettingsConfig",zo));let a=game.modules.get(p);a.api={},ke.forEach(c=>{let{init:r,conflicts:l=[],api:u,name:d}=c;if(t)for(let h of l){let g=game.modules.get(h);g?.active&&(c.conflicting=!0,Lt.add(g.title))}u&&d&&(a.api[d]=u),!c.conflicting&&r&&r(t)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of ke)!t&&n&&n(e);if(e)for(let t of Lt)w("module-conflict",{name:t},!0)});function Se(e,t){return`${p}.settings.${e}.${t}`}i(Se,"settingPath");function zo(e,t){if(!Ie)return;t.find(`.tab[data-tab=${p}] [data-setting-id="${p}.${Ie}"]`).before(`<h3>${k("settings.client")}</h3>`)}i(zo,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
