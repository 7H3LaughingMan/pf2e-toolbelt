(()=>{var an=Object.defineProperty;var r=(e,t)=>an(e,"name",{value:t,configurable:!0});var m="pf2e-toolbelt";function x(e,t,n="WRAPPER"){return libWrapper.register(m,e,t,n)}r(x,"registerWrapper");function v(...e){let[t,n]=e;return t=`${m}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}r(v,"localize");function cn(e){return game.i18n.has(`${m}.${e}`,!1)}r(cn,"hasLocalization");function ln(e){return`${m}.${e}`}r(ln,"localizePath");function C(e){let t=r((...n)=>v(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>k(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>G(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>H(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>cn(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>ln(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:o})=>t(n,o),enumerable:!1,configurable:!1}}),t}r(C,"subLocalize");function ge(e,t,n,o){let s=typeof t=="string"?t:"info",i=typeof t=="object"?t:typeof n=="object"?n:void 0,a=typeof t=="boolean"?t:typeof n=="boolean"?n:o??!1;ui.notifications.notify(v(e,i),s,{permanent:a})}r(ge,"notify");function k(...e){let[t,n,o]=e;ge(t,"warning",n,o)}r(k,"warn");function G(...e){let[t,n,o]=e;ge(t,"info",n,o)}r(G,"info");function H(...e){let[t,n,o]=e;ge(t,"error",n,o)}r(H,"error");function p(e){return game.settings.get(m,e)}r(p,"getSetting");function xe(e,t){return game.settings.set(m,e,t)}r(xe,"setSetting");var fn="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",un="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",dn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",mn="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",pn=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function Re(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{p("arp")&&(x(fn,gn,"WRAPPER"),x(un,bn,"WRAPPER"),x(dn,vn,"WRAPPER"),x(mn,Sn,"WRAPPER"))},ready:e=>{e&&p("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),G("arp.forceVariant"))}}}r(Re,"registerArp");function te(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}r(te,"isValidActor");function Me(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!pn.includes(e.sourceId)}r(Me,"isValidWeapon");function gn(e){let t=this.actor;if(!te(t,!0)||!Me(this))return e();let n=t.level,o=this._source.system.traits.value;if(o.includes("alchemical")&&o.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}r(gn,"onPrepareWeaponData");var hn={1:35,2:935,3:8935,4:8935},yn={striking:65,greaterStriking:1065,majorStriking:31065};function bn(e){if(e(),!te(this.actor)||this.isSpecific||!Me(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=hn[n]);let o=this.system.strikingRune.value;o&&(t-=yn[o]),(n||o)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}r(bn,"onPrepareWeaponDerivedData");function Ue(e){return!e.isShield}r(Ue,"isValidArmor");function vn(e){let t=this.actor;if(!te(t,!0)||!Ue(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}r(vn,"onPrepareArmorData");var Cn={1:160,2:1060,3:20560,4:20560},kn={resilient:340,greaterResilient:3440,majorResilient:49440};function Sn(e){if(e(),!te(this.actor)||this.isSpecific||!Ue(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Cn[n]);let o=this.system.resiliencyRune.value;o&&(t-=kn[o]),(n||o)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}r(Sn,"onPrepareArmorDerivedData");function A(e,t,n=()=>{}){let o=null;return function(s,i=[],a=!1){typeof i=="string"&&(i=[i]),s||=i.some(c=>p(c)),s&&!o?o=Hooks.on(e,t):!s&&o&&(Hooks.off(e,o),o=null),a||n(s)}}r(A,"createHook");function ne(e,t,n=()=>{}){let o=null;return function(s,i=!1){s==="disabled"&&o?(Hooks.off(e,o),o=null):s!=="disabled"&&!o&&(o=Hooks.on(e,t)),i||n(s)}}r(ne,"createChoicesHook");function $e(e,t){let n=Hooks.on(e,t),o=Hooks.events[e].findIndex(s=>s.id===n);if(o!==0){let[s]=Hooks.events[e].splice(o,1);Hooks.events[e].unshift(s)}return n}r($e,"registerUpstreamHook");var he=A("renderEffectsPanel",In,wn);function _e(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>he(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>he(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{he(!1,["effect-remove","condition-sheet"])}}}r(_e,"registerEffectsPanelHelper");function wn(){game.pf2e.effectPanel?.render()}r(wn,"refreshEffectsPanel");function In(e,t){let n=`<div>${v("effects.remove")}</div>`,o='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',s=t.find(".effect-item[data-item-id]").toArray();for(let i of s){let a=i.dataset.itemId,c=e.actor?.items.get(a);if(c&&(p("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(i.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),i.querySelector(".icon").addEventListener("contextmenu",l=>En(l,e),!0)),p("condition-sheet")&&c.isOfType("condition"))){let l=i.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",o),l.querySelector('[data-action="edit"]').addEventListener("click",u=>Pn(u,e))}}}r(In,"renderEffectsPanel");function Pn(e,t){let n=Le(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}r(Pn,"onConditionSheet");function En(e,t){if(!e.shiftKey)return;let n=Le(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}r(En,"onRemoveEffect");function Le(e,t){let s=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(s)}r(Le,"getEffect");var z=class extends FormApplication{constructor(t,n,o){super(t,n),this.onSubmitCallback=o}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};r(z,"MoveLootPopup");function D(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}r(D,"isPlayedActor");function ye(){return CONFIG.ChatMessage.documentClass}r(ye,"getChatMessageClass");function*B(e,t){let n=game.messages.contents,o=(t?n.findLastIndex(s=>s===t):n.length)-1;for(let s=o;s>=o-e;s--){let i=n[s];if(!i)return;yield i}}r(B,"latestChatMessages");function M(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}r(M,"chatUUID");function oe(e){game.socket.on(`module.${m}`,e)}r(oe,"socketOn");function re(e){game.socket.off(`module.${m}`,e)}r(re,"socketOff");function R(e){game.socket.emit(`module.${m}`,e)}r(R,"socketEmit");function se(){return game.user===game.users.activeGM}r(se,"isActiveGM");function He(){return game.users.some(e=>e.active&&e.isGM)}r(He,"isGMOnline");function Fe(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}r(Fe,"getCharacterOwner");function An(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,o)=>n.id>o.id?1:-1),t[0]||null}r(An,"getActiveOwner");function be(e){return An(e)===game.user}r(be,"isActiveOwner");function Ne(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}r(Ne,"getOwner");var ie=!1,W=null;function Be(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:Ge}],conflicts:["pf2e-giveth"],ready:e=>{p("giveth")!=="disabled"&&Ge(!0)}}}r(Be,"registerGiveth");function Ge(e){let t=game.user.isGM;e==="disabled"&&ie?(t?re(je):W&&(Hooks.off("dropCanvasData",W),W=null),ie=!1):e!=="disabled"&&!ie&&(t?oe(je):W||(W=$e("dropCanvasData",Dn)),ie=!0)}r(Ge,"setup");function je(e){se()&&(e.type==="giveth-condition"?xn(e):e.type==="giveth-effect"?Rn(e):Mn(e))}r(je,"onSocket");function Dn(e,t){if(!He())return!0;let n=On(t);if(!n)return!0;let o=e.tokens.placeables.slice().filter(s=>{if(!s.document.actorLink)return!1;let i=s.actor;if(!We(i,t.actorId)||i.isOwner)return!1;let a=s.x+(s.hitArea?.right??0),c=s.y+(s.hitArea?.bottom??0);return t.x>=s.x&&t.y>=s.y&&t.x<=a&&t.y<=c}).sort((s,i)=>i.document.sort-s.document.sort).at(0)?.actor;return o?(Tn(n.actor,o,n.item,n.value),!1):!0}r(Dn,"onDropCanvasData");function Tn(e,t,n,o){let s=e.id,i=t.id,a=!(n instanceof Item);if(!a&&n.isOfType("physical")){let c=n.quantity;if(c<1)return k("giveth.notification.zero");if(c===1)return ze(s,i,n.id,1,!1);new z(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,u)=>{ze(s,i,n.id,l,u)}).render(!0)}else{let c=a?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?R({type:"giveth-condition",targetId:i,value:o??1,uuid:c}):R({type:"giveth-effect",targetId:i,uuid:c})}}r(Tn,"giveth");function ze(e,t,n,o,s){R({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:o,stack:s})}r(ze,"sendPhysicalRequest");function We(e,t){return!D(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}r(We,"isValidActor");function On(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let s=e.context?.origin.actor;n=s?fromUuidSync(s):null}if(!We(n)||!n.isOwner)return;let o=!(t instanceof Item);if(o&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!o&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}r(On,"getDetailsFromData");async function xn({targetId:e,uuid:t,value:n}){let o=game.actors.get(e);if(!o)return;let s=await fromUuid(t);s&&o.increaseCondition(s.slug,{min:n})}r(xn,"takethCondition");async function Rn({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let o=await fromUuid(t);if(!o)return;let s=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[s])}r(Rn,"takethEffect");async function Mn({itemId:e,ownerId:t,qty:n,stack:o,targetId:s}){let i=game.actors.get(t),a=game.actors.get(s);if(!i||!a)return;let c=i.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,u=c.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=c.traits.has("invested")?!1:null);let d=await a.addToInventory(u,void 0,o);if(!d||(l<1?c.delete():c.update({"system.quantity":l}),p("giveth")==="no-message"))return;let b=M(d.uuid,d.name,!d.isIdentified);n>1&&(b+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${v("giveth.giveth",{target:a.name})}</h4>`,content:b,speaker:ChatMessage.getSpeaker({actor:i})})}r(Mn,"takethPhysical");function S(...e){return e=e.filter(t=>typeof t=="string"),`modules/${m}/templates/${e.join("/")}.hbs`}r(S,"templatePath");var j=C("hero.templates.trade"),q=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:j("title"),template:S("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){j.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:T(this.actor),targetActions:this.target?T(this.target):[],i18n:j})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){j.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){j.warn("no-select");return}let o=Fe(this.target,!0)??Ne(this.target,!0)??game.users.activeGM;if(!o){j.warn("no-user");return}qe({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:o.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};r(q,"Trade");function ae(e,t){return e.localeCompare(t,game.i18n.lang)}r(ae,"localeCompare");function F(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}r(F,"refreshCharacterSheets");function Ve(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let o of e){let s=n.findIndex(i=>o===i);if(s===-1)return!1;n.splice(s,1)}return!0}r(Ve,"compareArrays");function Ye(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}r(Ye,"ordinalString");function Ke(e,t){if(typeof e!="object")return!1;for(;e=Reflect.getPrototypeOf(e);)if(e.constructor.name===t)return!0;return!1}r(Ke,"isInstanceOf");var ce="pf2e-hero-actions",Qe=null,Je=A("renderCharacterSheetPF2e",Ln,_n),Un="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",le="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",$n="systems/pf2e/icons/features/feats/heroic-recovery.webp";function Ze(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>Je(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>F()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[ce],api:{createTable:Qn,removeHeroActions:to,getHeroActions:T,useHeroAction:rt,getHeroActionDetails:fe,drawHeroAction:ot,drawHeroActions:tt,sendActionToChat:lt,discardHeroActions:st,tradeHeroAction:nt,getDeckTable:ke,giveHeroActions:ro,createChatMessage:ue},ready:()=>{Je(!1,"hero")}}}r(Ze,"registerHeroActions");function _n(e){e&&!Qe?oe(Xe):!e&&Qe&&re(Xe)}r(_n,"setupSocket");function Xe(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;mt(e);break;case"trade-accept":if(!se())return;ut(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;Yn(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;dt(e.error);break}}r(Xe,"onSocket");async function Ln(e,t){let n=e.actor;D(n)&&(await Hn(t,n),Fn(t,n))}r(Ln,"renderCharacterSheetPF2e");async function Hn(e,t){let n=T(t),o=t.heroPoints.value-n.length,s=t.isOwner,i=C("hero.templates.heroActions"),a=await renderTemplate(S("hero/sheet"),{owner:s,list:n,canUse:o>=0&&s,canDraw:o>0&&s,canTrade:p("hero-trade"),mustDiscard:o<0,diff:Math.abs(o),i18n:(c,{hash:l})=>i(c,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(a)}r(Hn,"addActionsToSheet");function Fn(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",o=>Bn(t,o)),n.find("[data-action=expand]").on("click",et),n.find("[data-action=use]").on("click",o=>zn(t,o)),n.find("[data-action=display]").on("click",o=>jn(t,o)),n.find("[data-action=discard]").on("click",Gn),n.find("[data-action=discard-selected]").on("click",()=>Nn(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>nt(t))}r(Fn,"addSheetEvents");async function Nn(e,t){let o=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(s=>s.dataset.uuid);st(e,o)}r(Nn,"onClickHeroActionsDiscard");function Gn(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let o=Number(n.attr("data-discard")??"0"),s=n.find(".action.discarded");n.toggleClass("discardable",s.length===o)}r(Gn,"onClickHeroActionDiscard");async function jn(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");lt(e,n)}r(jn,"onClickHeroActionDisplay");async function zn(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");rt(e,n)}r(zn,"onClickHeroActionUse");async function Bn(e,t){t.preventDefault(),tt(e)}r(Bn,"onClickHeroActionsDraw");function T(e){return getProperty(e,`flags.${ce}.heroActions`)??[]}r(T,"getHeroActions");async function N(e,t){return e.update({[`flags.${ce}.heroActions`]:t})}r(N,"setHeroActions");async function et(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let o=t.attr("data-uuid"),s=await fe(o);if(!s)return;let i=await TextEditor.enrichHTML(s.description,{async:!0});n.find(".item-description").html(i),n.addClass("loaded")}t.toggleClass("expanded")}r(et,"onClickHeroActionExpand");async function fe(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,o=t instanceof JournalEntry?t.pages.contents[0]:t,s=o?.text.content;if(s)return n.uuid===Un&&(s=s.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:o.name,description:s}}r(fe,"getHeroActionDetails");async function tt(e){if(!e?.isOfType("character")){k("hero.onlyCharacter");return}let t=T(e),n=e.heroPoints.value-t.length,o=[];for(let s=0;s<n;s++){let i=await ot();if(i!==void 0){if(i===null)return;t.push(i),o.push(i)}}o.length&&(N(e,t),ue({actor:e,actions:o,label:s=>v("hero.actions-draw.header",{nb:s}),secret:!0}))}r(tt,"drawHeroActions");function ue({actor:e,actions:t,label:n,secret:o=!1}){let{content:s,size:i}=Wn(t);n=typeof n=="function"?n(i):n;let a={flavor:`<h4 class="action">${n}</h4>`,content:s,speaker:ChatMessage.getSpeaker({actor:e})};o&&p("hero-private")&&(a.type=CONST.CHAT_MESSAGE_TYPES.ROLL,a.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(a)}r(ue,"createChatMessage");function Wn(e){let t=e.map(({uuid:n,name:o})=>M(n,o));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}r(Wn,"chatActions");function nt(e){if(!e?.isOfType("character")){k("hero.onlyCharacter");return}let t=T(e);if(!t||!t.length){k("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){k("hero.no-points",{nb:n.toString()});return}new q(e).render(!0)}r(nt,"tradeHeroAction");async function ot(){let e=await ke(),t=C("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(i=>!i.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let o=pt(n);if(o)return{uuid:o,name:await it(n,o)}}r(ot,"drawHeroAction");async function rt(e,t){if(!e?.isOfType("character")){k("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return k("hero.use.noPoints");let o=T(e),s=o.findIndex(a=>a.uuid===t);if(s===-1)return;let i=await fe(t);i||H("hero.use.noDetails"),o.splice(s,1),i?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${ce}.heroActions`]:o}),ChatMessage.create({flavor:`<h4 class="action">${v("hero.actions-use.header")}</h4>`,content:`<h2>${i.name}</h2>${i.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):N(e,o)}r(rt,"useHeroAction");async function st(e,t){if(!e?.isOfType("character")){k("hero.onlyCharacter");return}t=typeof t=="string"?[t]:t;let n=T(e),o=[];for(let s of t){let i=n.findIndex(a=>a.uuid===s);i!==-1&&(o.push(n[i]),n.splice(i,1))}N(e,n),ue({actor:e,actions:o,label:s=>v("hero.actions-discard.header",{nb:s})})}r(st,"discardHeroActions");async function it(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}r(it,"getLabelfromTableResult");async function at(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}r(at,"getTableFromUuid");async function qn(){return at(le)}r(qn,"getDefaultCompendiumTable");function ct(){return game.tables.find(e=>e.getFlag("core","sourceId")===le)}r(ct,"getDefaultWorldTable");async function Vn(){return at(p("hero-table"))}r(Vn,"getCustomTable");async function ke(){return await Vn()??ct()??await qn()}r(ke,"getDeckTable");async function lt(e,t){let n=await fe(t);if(!n)return H("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}r(lt,"sendActionToChat");function qe(e){if(e.receiver.id===game.user.id){ft(e);return}R({...e,type:"trade-request"})}r(qe,"sendTradeRequest");function ft(e){if(game.user.isGM){ut(e);return}R({...e,type:"trade-accept"})}r(ft,"acceptRequest");async function ut(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){ve(e);return}let i=T(o),a=T(s),c=i.findIndex(g=>g.uuid===t.uuid),l=a.findIndex(g=>g.uuid===n.uuid);if(c===-1||l===-1){ve(e);return}let u=i.splice(c,1)[0],d=a.splice(l,1)[0];i.push(d),a.push(u),N(o,i),N(s,a);let b=M(u.uuid),y=M(d.uuid),f=C("hero.trade-success"),h=`<div style="line-height: 1.6">${f("offer",{offer:b})}</div>`;h+=`<div style="line-height: 1.6">${f("receive",{receive:y})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${f("header",{name:s.name})}</h4>`,content:h,speaker:ChatMessage.getSpeaker({actor:o})})}r(ut,"onTradeAccepted");function ve({sender:e,receiver:t},n="trade-error"){let o=new Set([e.id,t.id]);o.has(game.user.id)&&(o.delete(game.user.id),dt(n)),o.size&&R({type:"trade-error",users:Array.from(o),error:n})}r(ve,"sendTradeError");function dt(e){H("hero.trade-error")}r(dt,"onTradeError");async function Yn(e){let{sender:t,receiver:n}=e,o=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!o||!s){ve(e);return}let i=C("hero.trade-request"),a=`<p>${i("header",{sender:o.name,receiver:s.name})}</p>`;a+=`<p>${i("give",{give:M(t.uuid)})}</p>`,a+=`<p>${i("want",{want:M(n.uuid)})}</p>`,a+=`<p style="margin-bottom: 1em;">${i("accept")}</p>`,await Dialog.confirm({title:i("title"),content:await TextEditor.enrichHTML(a,{async:!0})})?ft(e):Kn(e)}r(Yn,"onTradeRequest");function Kn(e){if(e.sender.id===game.user.id){mt(e);return}R({...e,type:"trade-reject"})}r(Kn,"rejectRequest");async function mt({receiver:e}){let t=game.actors.get(e.cid);k("hero.trade-rejected",{name:t.name},!0)}r(mt,"onTradeRejected");async function Qn(){if(!game.user.isGM){k("hero.notGM");return}let e=C("hero.templates.createTable.choice"),t=S("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:i=>{let a=i.find('.window-content input[name="type"]:checked').val(),c=i.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:a,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},o={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-create-table"});s&&(s.type==="default"?Zn(s.unique):Jn(s.unique))}r(Qn,"createTable");async function Jn(e){let t=await Xn(e);await Ce(t),t.sheet?.render(!0)}r(Jn,"createCustomTable");function Xn(e=!0){let t=Se(e);return RollTable.create(t,{temporary:!1})}r(Xn,"createCustomActionsTable");async function Zn(e){let t=C("templates.createTable.default.confirm"),n=await ct();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let s=Se(e);return await n.update(s),Ce(n,!0)}n=await eo(e),await Ce(n)}r(Zn,"createDefaultTable");async function eo(e=!0){let t=await fromUuid(le),n=Se(e,t);return RollTable.create(n,{temporary:!1})}r(eo,"createDefautActionsTable");async function Ce(e,t=!1){t&&await e.normalize(),await xe("hero-table",e.uuid)}r(Ce,"setTable");function Se(e=!0,t){let n={name:v("hero.table.name"),replacement:!e,img:$n,description:v("hero.table.description"),flags:{core:{sourceId:le}}};return t?mergeObject(deepClone(t._source),n):n}r(Se,"getTableSource");async function to(){if(!game.user.isGM){k("hero.notGM");return}let e=C("hero.templates.removeActions"),t=S("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:i=>i.find('input[name="actor"]:checked').toArray().map(a=>game.actors.get(a.value)).filter(a=>a)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},o={content:await renderTemplate(t,{actors:game.actors.filter(i=>i.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:i=>{i.on("change",'input[name="all"]',()=>no(i)),i.on("change",'input[name="actor"]',()=>oo(i))},close:()=>[]},s=await Dialog.wait(o,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!s.length){e.warn("noSelection");return}for(let i of s)N(i,[]);e.info("removed")}r(to,"removeHeroActions");function no(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}r(no,"removeActionsToggleAll");function oo(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),o=e.find('input[name="all"]');t.length===n.length?(o.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?o.prop("checked",!1).prop("indeterminate",!0):(o.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}r(oo,"removeActionsToggleActor");function pt(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}r(pt,"documentUuidFromTableResult");async function ro(e){if(!game.user.isGM){k("hero.notGM");return}let t=C("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await ke();if(!n)return H("hero.table.drawError",!0),null;let o=n.replacement===!1,s=(await Promise.all(n.results.map(async g=>{let P=pt(g);if(P)return{key:g.id,uuid:P,name:await it(g,P),drawn:g.drawn}}))).filter(Boolean),i=S("hero/dialogs/give-action"),a=await renderTemplate(i,{actions:s,isUnique:o,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:g=>({selected:g.find("[name=action]:checked").closest(".action").toArray().map(P=>P.dataset),asDrawn:g.find("[name=drawn]").prop("checked")??!1,withMessage:g.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:a,buttons:c,render:g=>{g.find("[data-action=expand]").on("click",et)},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!u)return;let{selected:d,asDrawn:b,withMessage:y}=u,f=T(e),h=[];for(let{uuid:g,name:P,key:I}of d){if(f.push({uuid:g,name:P}),!b)continue;let O=n.results.get(I);O&&!O.drawn&&h.push(I)}h.length&&await n.updateEmbeddedDocuments("TableResult",h.map(g=>({_id:g,drawn:!0}))),N(e,f),y&&ue({actor:e,actions:d,label:g=>v("hero.actions-give.header",{nb:g}),secret:!0})}r(ro,"giveHeroActions");function w(e,t,n){return e.getFlag(m,t)??n}r(w,"getFlag");function V(e,t,n){return e.setFlag(m,t,n)}r(V,"setFlag");function gt(e,t){return e.unsetFlag(m,t)}r(gt,"unsetFlag");var ht=C("knowledges.editLore"),Y=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return ht("title",this.actor)}get template(){return S("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:w(n,"unspecified")??"",specific:w(n,"specific")??"",i18n:ht})}async _updateObject(t,{unspecified:n,specific:o}){let s=this.object;V(s,"unspecified",n.trim()),V(s,"specific",o.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};r(Y,"EditLores");var yt=A("renderNPCSheetPF2e",so);function bt(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>yt(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&p("knowledges")&&yt(!0)}}}r(bt,"registerKnowledges");function so(e,t){let n=e.actor;D(n)&&(ao(n,t),lo(t),co(n,t))}r(so,"renderNPCSheetPF2e");function we(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}r(we,"knowledgeSelector");function io(e){new Y(e).render(!0)}r(io,"editLores");function ao(e,t){let n=w(e,"unspecified"),o=w(e,"specific");if(!n&&!o)return;let s=e.identificationDCs.lore,i=we(t,"body","");i.find(".identification-skills").last().remove();function a(l,u,d){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:d})}</div>`}r(a,"tag");function c(l,{dc:u,start:d}){let b=l.split(",").filter(y=>y.trim()).map(y=>a(y,u,d)).join("");i.append(b)}r(c,"addTags"),c(n||"Unspecific",s[0]),c(o||"Specific",s[1])}r(ao,"replaceLores");function co(e,t){we(t,"header","button.edit").on("click",()=>io(e))}r(co,"addEvents");function lo(e){let t=we(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}r(lo,"addEditButton");var Ie=C("merge.multi"),K=class extends Application{constructor(t,n){super(n),this._spell=t}get spell(){return this._spell}get title(){return Ie("title",this.spell)}get template(){return S("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:Ie})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){Ie.error("zero"),this.close();return}let o=this.spell,s=deepClone(o._source.system.damage.value),i=deepClone(o._source.system.heightening)??{};for(let[c,l]of Object.entries(s))for(let u=0;u<n-1;u++){let d=randomID();if(s[d]=l,i.type==="interval"){let b=i.damage[c];b&&(i.damage[d]=b)}else if(i.type==="fixed")for(let[b,y]of Object.entries(i.levels)){let f=y.damage.value[c];f&&(i.levels[b].damage.value[d]=f)}}o.clone({"system.damage.value":s,"system.heightening":i}).rollDamage(t),this.close()}#t(t){t.preventDefault(),this.close()}};r(K,"MultiCast");var fo=/(\[[\w,]+\])/,Pe=A("renderChatMessage",It,uo);function wt(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>Pe(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>Pe(e,"merge-damage")}],init:e=>{Pe(!1,["multi-cast","merge-damage"],!0)}}}r(wt,"registerMerge");function uo(){let e=ui.chat?.element;if(e)for(let t of B(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),It(t,n))}}r(uo,"updateMessages");function It(e,t){!game.user.isGM&&!e.isAuthor||(p("merge-damage")&&At(e)?po(e,t):p("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&mo(e,t))}r(It,"renderChatMessage");function mo(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let o=t.find(".message-content .chat-card .owner-buttons .spell-button");o.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${v("merge.spell.button")}</button>`),o.find("[data-action=multi-cast]").on("click",async s=>{let i=await fromUuid(n);i&&new K(i).render(!0)})}r(mo,"renderSpell");function po(e,t){let n='<span class="pf2e-toolbelt-merge">';if(w(e,"merged")){let a=v("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${a}">`,n+='<i class="fa-duotone fa-split"></i>'}let o=v("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${o}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let s=kt(e),i=St(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",a=>{a.stopPropagation();for(let c of B(5,e))if(!(!At(c)||kt(c)!==s||St(c)!==i)){ho(a,e,c,{actorUUID:s,targetUUID:i});return}k("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",a=>{a.stopPropagation(),go(a,e)})}r(po,"renderDamage");async function go(e,t){let n=w(t,"data").flatMap(o=>o.source);await Pt(t.id),await ye().createDocuments(n)}r(go,"splitDamages");async function ho(e,t,n,{actorUUID:o,targetUUID:s}){let i={},a=vt(n).concat(vt(t));for(let{name:f,notes:h,outcome:g,modifiers:P,tags:I}of a)i[f]??={name:f,tags:I,notes:new Set,results:[]},h.forEach(i[f].notes.add,i[f].notes),i[f].results.some(E=>E.outcome===g&&Ve(E.modifiers,P))||i[f].results.push({outcome:g,modifiers:P});let c=Object.values(i).map(f=>(f.label=f.name,f.results.forEach(h=>{h.outcome&&(h.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${h.outcome}`))}),f));c.at(-1).isLastGroup=!0;let l=await renderTemplate(S("merge/merged"),{groups:c,hasMultipleGroups:c.length>1}),u=Ct(t),d=Ct(n),b=[];for(let f of[].concat(d,u)){let{options:h,total:g,terms:P}=f,I=P[0],O=f.formula.replace(fo,""),E=b.find(({options:{flavor:Z,critRule:ee}})=>Z===h.flavor&&ee===h.critRule);E?(E.terms.push(I),E.total+=g,E.formulas.push(O)):b.push({options:h,formulas:[O],total:g,terms:[I]})}for(let f of b)f.formula=`(${f.formulas.join(" + ")})[${f.options.flavor}]`,f.term=f.terms.length<2?f.terms[0]:Et(f.terms);let y={class:"DamageRoll",options:{},dice:[],formula:`{${b.map(({formula:f})=>f).join(", ")}}`,total:b.reduce((f,{total:h})=>f+h,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:b.map(({formula:f})=>f),modifiers:[],rolls:b.map(({options:f,formula:h,total:g,term:P})=>({class:"DamageInstance",options:f,dice:[],formula:h,total:g,terms:[P],evaluated:!0})),results:b.map(({total:f})=>({result:f,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let f=r(h=>{"results"in h?h.results.forEach(g=>g.hidden=!0):(h.term??h).operands?.forEach(g=>f(g))},"setHidden");y.terms[0].rolls.forEach(h=>h.terms.forEach(g=>f(g)))}await Pt(t.id,n.id),await ye().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[m]:{actor:o,target:s,merged:!0,type:"damage-roll",data:a}},rolls:[y]})}r(ho,"mergeDamages");function vt(e){let t=w(e,"data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let o=$(`<div>${e.flavor}</div>`),s=o.find("h4.action + .tags").prop("outerHTML"),i=[];o.find(".tag.tag_transparent").each(function(){i.push(this.innerHTML)});let a=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,modifiers:i,tags:s,notes:a}]}r(vt,"getMessageData");function Pt(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}r(Pt,"removeChatMessages");function Et(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?Et(e):e[0]]}}}r(Et,"createTermGroup");function Ct(e){return w(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}r(Ct,"getMessageRolls");function kt(e){return w(e,"actor")??e.actor?.uuid}r(kt,"getActorUUID");function St(e){return w(e,"target")??e.target?.actor.uuid}r(St,"getTargetUUID");function At(e){return w(e,"type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}r(At,"isDamageRoll");var Dt=ne("renderChatMessage",Ot,yo);function Tt(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>Dt(e)}],init:e=>{!e&&p("modifiers")!=="disabled"&&Dt(!0,!0)}}}r(Tt,"registerHideModifiers");function yo(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of B(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),Ot(t,n))}}r(yo,"updateMessages");function Ot(e,t){let n=e.speaker,o=ChatMessage.getSpeakerActor(n);if(!o||o.hasPlayerOwner)return;let s=t.find(".message-header");p("modifiers")==="traits"&&s.addClass("pf2e-toolbelt-modifiers-traits"),p("modifiers")!=="disabled"&&s.addClass("pf2e-toolbelt-modifiers")}r(Ot,"renderChatMessage");var bo="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",vo="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function xt(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{p("nobulk")&&x(bo,ko,"WRAPPER"),p("nobulk-coins")&&x(vo,Co,"WRAPPER")}}}r(xt,"registerNobulk");function Co(e){e(),this.isCoinage&&(this.system.bulk.value=0)}r(Co,"treasurePrepareBaseData");function ko(e,...t){e(...t);let n=this,o=n.inventory.bulk.constructor,s=null;Object.defineProperty(n.inventory.bulk,"value",{get(){return s||(s=o.computeTotalBulk(this.actor.inventory.filter(i=>!i.isInContainer&&i.system.equipped.carryType!=="dropped"),this.actor.size),s)}})}r(ko,"actorPrepareEmbeddedDocuments");var So="CONFIG.Actor.documentClass.prototype.prepareData",wo="DocumentSheet.prototype._renderInner";function Rt(){return{settings:[{name:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{p("share")!=="disabled"&&(x(So,To,"WRAPPER"),x(wo,Io,"WRAPPER"),Hooks.on("preUpdateActor",Eo),Hooks.on("deleteActor",Po),Hooks.on("updateActor",Ao))}}}r(Rt,"registerShare");async function Io(e,...t){let n=await e(...t);if(!Ke(this,"CreatureConfig"))return n;let o=this.actor;if(!D(o)||!o.isOfType("character","npc")||Q(o).size)return n;let s=game.actors.filter(a=>a.id!==o.id&&a.isOwner&&me(a)).map(a=>({key:a.id,label:a.name})),i=await renderTemplate(S("share/master"),{masters:s,master:w(o,"share.master"),selectPath:`flags.${m}.share.master`,i18n:C("share.templates.master")});return n.children().last().before(i),n}r(Io,"documentSheetRenderInner");function Po(e){Ht(e);let t=Q(e);Promise.all(t.map(async n=>{Ut(n),await gt(n,"share.master")}))}r(Po,"deleteActor");function Eo(e,t){let n=getProperty(t,`flags.${m}.share`);if(n?.master){let o=game.actors.get(n.master);if(me(o)){let s=deepClone(o._source.system.attributes.hp);setProperty(t,"system.attributes.hp",s)}}else{let o=de(e),s=getProperty(t,"system.attributes.hp");o&&s&&(o.update({system:{attributes:{hp:s}}},{noHook:!0}),delete t.system.attributes.hp)}}r(Eo,"preUpdateActor");function Ao(e,t,n,o){let s=game.user.id===o,i=xo(t);if(i?.master!==void 0){let c=e;if(Ht(c),i.master){let l=game.actors.get(i.master);me(l)&&(Mt(c,l),Lt(l,c))}else Ut(c)}if(!s)return;let a=Q(e);if(a.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(a.map(async u=>await u.update(l,{noHook:!0})))}else Promise.all(a.map(async l=>await Do(l,t)))}}r(Ao,"updateActor");async function Do(e,t){p("share")==="force"?await V(e,"toggle",!w(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}r(Do,"refreshActor");function To(e){e();let t=this,n=w(t,"share.master"),o=n?game.actors.get(n):void 0;if(!me(o))return;de(this)||(Mt(this,o),Lt(o,this));let s=this.system.attributes.hp;Object.defineProperty(t.system.attributes,"hp",{get(){let i=o.system.attributes.hp;return Oo(i,s),s},enumerable:!0})}r(To,"prepareData");function Oo(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}r(Oo,"transfertHpData");function xo(e){return getProperty(e,`flags.${m}.share`)}r(xo,"getShareFlag");function Q(e){return $t(e,"slaves")??new Collection}r(Q,"getSlaves");function Mt(e,t){_t(e,"master",t)}r(Mt,"setMaster");function Ut(e){Ro(e,"master")}r(Ut,"unsetMaster");function de(e){return $t(e,"master")}r(de,"getMaster");function me(e){return e&&e.type==="character"&&!de(e)}r(me,"isValidMaster");function $t(e,t){return getProperty(e,`modules.${m}.share.${t}`)}r($t,"getModuleProperty");function _t(e,t,n){setProperty(e,`modules.${m}.share.${t}`,n)}r(_t,"setModuleProperty");function Ro(e,t){delete e.modules?.[m]?.share?.[t]}r(Ro,"deleteModuleProperty");function Lt(e,t){let n=Q(e);_t(e,"slaves",n.set(t.id,t))}r(Lt,"addSlaveToMaster");function Ht(e){let t=de(e);if(!t)return;Q(t).delete(e.id)}r(Ht,"removeSlaveFromMaster");function Ft(e){return e.getFlag("core","sourceId")}r(Ft,"getSourceId");function Mo(e,t){let n=Ft(e);return n?t.includes(n):!1}r(Mo,"includesSourceId");function Nt(e){return Array.isArray(e)?t=>Mo(t,e):t=>Ft(t)===e}r(Nt,"getItemSourceIdCondition");function Gt(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}r(Gt,"getItems");function jt(e,t,n){return Gt(e,n).some(Nt(t))}r(jt,"hasItemWithSourceId");function pe(e,t,n){return Gt(e,n).find(Nt(t))}r(pe,"getItemWithSourceId");var Uo=A("renderCharacterSheetPF2e",Go),$o=A("deleteCombat",zo),_o=A("deleteCombatant",Kt),Lo=A("createCombatant",Bo),Ho=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Fo=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),No=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function Bt(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:zt},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:Ee,toggleStance:Yt,isValidStance:Wt},ready:e=>{p("stances")&&zt(!0)}}}r(Bt,"registerStances");function zt(e){Uo(e),$o(e),_o(e),Lo(e)}r(zt,"setup");function Wt(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}r(Wt,"isValidStance");function Ee(e){let t=[],n=new Set;for(let{replace:o,sourceId:s,effectUUID:i,effect:a,img:c,name:l,itemName:u,action:d}of qt(e)){o&&n.add(o);let b=d?pe(e,d,"action"):pe(e,s,"feat");t.push({name:l,itemName:u,uuid:s,img:c,effectUUID:i,effectID:a?.id,actionUUID:b.sourceId,actionID:b.id})}return t.filter(({uuid:o})=>!n.has(o))}r(Ee,"getStances");async function Go(e,t){let n=e.actor;if(!D(n))return;let o=Ee(n);if(!o.length)return;let s=n.getActiveTokens(!0,!0).some(l=>l.inCombat),i=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),a=i.find(".actions-options"),c=await renderTemplate(S("stances/sheet"),{stances:o,canUseStances:s&&!n.isDead,i18n:C("stances")});a.length?a.after(c):i.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>jo(l,n))}r(Go,"renderCharacterSheetPF2e");function jo(e,t){let n=e.currentTarget,o=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!o)return;let s=n.dataset.effectUuid;Yt(t,s)}r(jo,"onToggleStance");function*qt(e){for(let t of e.itemTypes.feat){let n=t.sourceId,o=Fo.get(n),s=No.get(n);if(!o&&!s&&!Wt(t))continue;let i=o?.effect??s?.effect??t.system.selfEffect.uuid,a=fromUuidSync(i);a&&(yield{name:(o&&fromUuidSync(o.replace)?.name)??t.name,itemName:t.name,replace:o?.replace,extra:s,sourceId:n,effectUUID:i,effect:pe(e,i,"effect"),action:s?.action,img:a.img})}}r(qt,"actorStances");function Vt(e){let t=[];for(let{effect:n}of qt(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}r(Vt,"getStancesEffects");async function Yt(e,t){let n=Vt(e),o=n.findIndex(i=>i.uuid===t),s=!1;if(o===-1)s=!0;else{let i=n.filter(c=>c.uuid!==t).length,a=n.filter(c=>c.uuid===t).length>1;(i||a)&&n.splice(o,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(i=>i.id)),s&&Ae(e,t)}r(Yt,"toggleStance");async function Ae(e,t){let n=await fromUuid(t);if(n){let o=n.toObject();return getProperty(o,"flags.core.sourceId")||setProperty(o,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[o]))[0]?.toMessage(),!0}return!1}r(Ae,"addStance");function zo(e){for(let t of e.combatants)Kt(t)}r(zo,"deleteCombat");function Kt(e){let t=Qt(e);if(t){if(!game.user.isGM&&be(t)){let n=Vt(t).map(o=>o.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}F(t)}}r(Kt,"deleteCombatant");function Bo(e){let t=Qt(e);t&&(!game.user.isGM&&be(t)&&Wo(t),F(t))}r(Bo,"createCombatant");function Qt(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}r(Qt,"getActorFromCombatant");async function Wo(e){let t=Ee(e);if(!(!t.length||t.filter(({effectID:s})=>s).length||!jt(e,Ho,["feat"])))if(t.length===1){let s=t[0];await Ae(e,s.effectUUID)&&G("stances.useStance",{stance:s.name})}else qo(e,t)}r(Wo,"checkForSavant");async function qo(e,t){let n=C("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(S("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:o=>Ae(e,o.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}r(qo,"openStancesMenu");var Jt=ne("renderCharacterSheetPF2e",Vo,()=>F());function Xt(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>Jt(e)}],conflicts:["pf2e-spells-summary"],init:e=>{p("summary")!=="disabled"&&Jt(!0,!0)}}}r(Xt,"registerSpellsSummary");async function Vo(e,t){let n=e.actor;if(!D(n))return;let o=J(t);getProperty(e,`modules.${m}.toggled`)&&o.addClass("toggled"),ar(t).on("click",s=>ir(s,t,e)),await Yo(t,e,n),o.hasClass("toggled")&&o.hasClass("active")&&e._restoreScrollPositions(t)}r(Vo,"renderCharacterSheetPF2e");async function Yo(e,t,n){let o=J(e),s=await fr(n),i=await renderTemplate(S("summary/sheet"),s);o.append(i),Ko(e,t,n)}r(Yo,"addSummaryTab");function Ko(e,t,n){let o=lr(e),s=o.find(".spell-type .uses .spell-slots-input input");s.on("change",i=>Qo(i,n)),s.on("focus",Jo),s.on("blur",Xo),o.find(".cast-spell").on("click",i=>or(i,n)),o.find(".item-toggle-prepare").on("click",i=>Zo(i,n)),o.find(".focus-pips").on("click contextmenu",i=>er(i,n)),o.find(".spell-slots-increment-reset").on("click",i=>nr(i,t,n)),o.find(".item-image").on("click",i=>sr(i,n)),o.find(".item-name > h4").on("click",i=>rr(i,t))}r(Ko,"addSummaryEvents");async function Qo(e,t){e.preventDefault();let{inputPath:n,entryId:o}=$(e.currentTarget).data(),s=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:o,[n]:s}])}r(Qo,"onUsesInputChange");function Jo(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}r(Jo,"onUsesInputFocus");function Xo(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}r(Xo,"onUsesInputBlur");function Zo(e,t){e.preventDefault();let{slotLevel:n,slotId:o,entryId:s,expended:i}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(s)?.setSlotExpendedState(n??0,o??0,i!==!0)}r(Zo,"onTogglePrepare");function er(e,t){e.preventDefault();let n=e.type==="click"?1:-1,o=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":o})}r(er,"onToggleFocusPool");function tr(e,t){cr(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}r(tr,"onChargeReset");function nr(e,t,n){e.preventDefault();let{itemId:o,level:s,isCharge:i}=$(e.currentTarget).data();if(!o)return;if(i){tr(t,o);return}let a=n.items.get(o);if(a){if(a.isOfType("spellcastingEntry")){let c=s>=0&&s<=11?`slot${s}`:"slot0",l=a.system.slots?.[c];l&&a.update({[`system.slots.${c}.value`]:l.max})}else if(a.isOfType("spell")){let c=a.system.location.uses?.max;c&&a.update({"system.location.uses.value":c})}}}r(nr,"onSlotsReset");function or(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:o,slotLevel:s,slotId:i,entryId:a}=n.closest(".item").data(),c=t.spellcasting.collections.get(a);if(!c)return;let l=c.get(o);l&&c.entry.cast(l,{slot:i,level:s})}r(or,"onCastSpell");async function rr(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}r(rr,"onToggleSummary");async function sr(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),o=t.items.get(n);!o||o.isOfType("physical")&&!o.isIdentified||await o.toMessage(e)}r(sr,"onItemToChat");function ir(e,t,n){e.preventDefault();let o=J(t);o.hasClass("active")&&(o.toggleClass("toggled"),o.scrollTop(0),setProperty(n,`modules.${m}.toggled`,o.hasClass("toggled")))}r(ir,"onSpellcastingBtnToggle");function ar(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}r(ar,"getSpellcastingNav");function J(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}r(J,"getSpellcastingTab");function cr(e){return J(e).find(".directory-list.spellcastingEntry-list")}r(cr,"getSpellcastingOriginalSection");function lr(e){return J(e).find(".directory-list.summary")}r(lr,"getSpellcastingSummarySection");async function fr(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,o=[],s=[],i=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,d=l.statistic.dc.value,b=l.name,y=await l.getSheetData(),f=y.isFocusPool,h=l.system?.prepared?.value==="charge",g=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,P={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let I of y.levels){if(!I.active.length||I.uses?.max===0)continue;let O=[],E=I.isCantrip,Z=I.active.filter(_=>_&&_.uses?.max!==0),ee=!E&&h&&!n;for(let _=0;_<Z.length;_++){let{spell:L,expended:nn,virtual:on,uses:rn,castLevel:sn}=Z[_];O.push({name:L.name,img:L.img,range:L.system.range.value||"-",castLevel:sn??L.level,slotId:_,entryId:u,entryDc:d,entryName:b,itemId:L.id,inputId:y.isInnate?L.id:y.id,inputPath:h?"flags.pf2e-staves.charges":y.isInnate?"system.location.uses.value":`system.slots.slot${I.level}.value`,isCharge:h,isActiveCharge:h&&n,isBroken:ee,isVirtual:on,isInnate:y.isInnate,isCantrip:E,isFocus:f,isPrepared:y.isPrepared,isSpontaneous:y.isSpontaneous||y.isFlexible,slotLevel:I.level,uses:rn??(h?P:I.uses),expended:nn??(f&&!E?t.value<=0:!1),action:L.system.time.value,type:h?g?`${m}.summary.staff`:`${m}.summary.charges`:y.isInnate?"PF2E.PreparationTypeInnate":y.isSpontaneous?"PF2E.PreparationTypeSpontaneous":y.isFlexible?"PF2E.SpellFlexibleLabel":f?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:h?0:y.isPrepared?1:f?2:y.isInnate?3:y.isSpontaneous?4:5,noHover:y.isPrepared||E||ee||f})}if(O.length){if(f)if(E)i=!0;else{s.push(...O);continue}o[I.level]??=[],o[I.level].push(...O)}}})),o.length){let l=p("summary")==="sort"?(u,d)=>u.order===d.order?ae(u.name,d.name):u.order-d.order:(u,d)=>ae(u.name,d.name);o.forEach(u=>u.sort(l))}s.length&&(s.sort((l,u)=>ae(l.name,u.name)),o[12]=s,i=!1);let c=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:d})=>({name:d.name,img:d.img,slotId:u,itemId:d.id,level:d.level,time:d.system.time.value})).filter(Boolean));return{spells:o,rituals:c,focusPool:t,stavesActive:n,hasFocusCantrips:i,isOwner:e.isOwner,entryRank:l=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Ye(l)})}}r(fr,"getData");var X=null,U=null;function en(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:Zt}],conflicts:["pf2e-unided"],init:()=>{Zt()}}}r(en,"registerUnided");function Zt(e){e??=p("unided"),e==="disabled"?(X&&(Hooks.off("preCreateItem",X),X=null),U&&(Hooks.off("preUpdateItem",U),U=null)):(X||(X=Hooks.on("preCreateItem",ur)),e==="all"&&!U?U=Hooks.on("preUpdateItem",dr):e!=="all"&&U&&(Hooks.off("preUpdateItem",U),U=null))}r(Zt,"setHooks");function ur(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}r(ur,"preCreateItem");function dr(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}r(dr,"preUpdateItem");var Te=[Re(),xt(),Be(),bt(),en(),wt(),_e(),Xt(),Bt(),Ze(),Tt(),Rt()],tn=new Set,Oe=null;Hooks.once("init",()=>{let e=game.data.users.find(a=>a._id===game.data.userId),t=e&&e.role>=CONST.USER_ROLES.GAMEMASTER,n=Te.flatMap(({settings:a=[]})=>a.map(c=>{let l=c.name;return c.choices&&(c.choices=c.choices.reduce((u,d)=>(u[d]=De(l,`choices.${d}`),u),{})),c.key=l,c.scope??="world",c.config??=!0,c.name=De(l,"name"),c.hint=De(l,"hint"),c})),[o,s]=["world","client"].map(a=>n.filter(c=>c.scope===a));[o,s].forEach(a=>a.forEach(c=>game.settings.register(m,c.key,c))),t&&(Oe=s[0].key,Hooks.on("renderSettingsConfig",mr));let i=game.modules.get(m);i.api={},Te.forEach(a=>{let{init:c,conflicts:l=[],api:u,name:d}=a;if(t)for(let b of l){let y=game.modules.get(b);y?.active&&(a.conflicting=!0,tn.add(y.title))}u&&d&&(i.api[d]=u),!a.conflicting&&c&&c(t)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Te)!t&&n&&n(e);if(e)for(let t of tn)k("module-conflict",{name:t},!0)});function De(e,t){return`${m}.settings.${e}.${t}`}r(De,"settingPath");function mr(e,t){if(!Oe)return;t.find(`.tab[data-tab=${m}] [data-setting-id="${m}.${Oe}"]`).before(`<h3>${v("settings.client")}</h3>`)}r(mr,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
