(()=>{var je=Object.defineProperty;var o=(e,n)=>je(e,"name",{value:n,configurable:!0});var h="pf2e-toolbelt";function m(e){return game.settings.get(h,e)}o(m,"getSetting");function k(...e){let[n,t]=e;return n=`${h}.${n}`,t?game.i18n.format(n,t):game.i18n.localize(n)}o(k,"localize");function Be(e){return game.i18n.has(`${h}.${e}`,!1)}o(Be,"hasLocalization");function ze(e){return`${h}.${e}`}o(ze,"localizePath");function G(e){let n=o((...t)=>k(`${e}.${t[0]}`,t[1]),"fn");return Object.defineProperties(n,{warn:{value:(...t)=>w(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>q(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>Ve(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},has:{value:t=>Be(`${e}.${t}`),enumerable:!1,configurable:!1},path:{value:t=>ze(`${e}.${t}`),enumerable:!1,configurable:!1},template:{value:(t,{hash:s})=>n(t,s),enumerable:!1,configurable:!1}}),n}o(G,"subLocalize");function W(e,n,t,s){let i=typeof n=="string"?n:"info",a=typeof n=="object"?n:typeof t=="object"?t:void 0,c=typeof n=="boolean"?n:typeof t=="boolean"?t:s??!1;ui.notifications.notify(k(e,a),i,{permanent:c})}o(W,"notify");function w(...e){let[n,t,s]=e;W(n,"warning",t,s)}o(w,"warn");function q(...e){let[n,t,s]=e;W(n,"info",t,s)}o(q,"info");function Ve(...e){let[n,t,s]=e;W(n,"error",t,s)}o(Ve,"error");function A(e,n){libWrapper.register(h,e,n)}o(A,"registerWrapper");function v(e,n,t){return e.getFlag(h,n)??t}o(v,"getFlag");function Y(e,n,t){return e.setFlag(h,n,t)}o(Y,"setFlag");function C(...e){return e=e.filter(n=>typeof n=="string"),`modules/${h}/templates/${e.join("/")}.hbs`}o(C,"templatePath");function j(e,n){return e.localeCompare(n,game.i18n.lang)}o(j,"localeCompare");function se(e){game.socket.on(`module.${h}`,e)}o(se,"socketOn");function oe(e){game.socket.off(`module.${h}`,e)}o(oe,"socketOff");function B(e){game.socket.emit(`module.${h}`,e)}o(B,"socketEmit");function ie(){return game.user===game.users.activeGM}o(ie,"isActiveGM");function ae(e,n){let t=Hooks.on(e,n),s=Hooks.events[e].findIndex(i=>i.id===t);if(s!==0){let[i]=Hooks.events[e].splice(s,1);Hooks.events[e].unshift(i)}return t}o(ae,"registerUpstreamHook");function re(){return game.users.some(e=>e.active&&e.isGM)}o(re,"isGMOnline");function ce(e,n,t=!1){return t?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${n}</span>`:`@UUID[${e}]{${n}}`}o(ce,"chatUUID");var We="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",qe="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Ye="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Qe="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",Ke=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function le(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{m("arp")&&(A(We,Xe,"WRAPPER"),A(qe,et,"WRAPPER"),A(Ye,tt,"WRAPPER"),A(Qe,ot,"WRAPPER"))},ready:e=>{e&&m("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),q("arp.forceVariant"))}}}o(le,"registerArp");function z(e,n=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!n||e.isOfType("character"))}o(z,"isValidActor");function ue(e){let n=e._source.system.traits.value;return!n.includes("alchemical")&&!n.includes("bomb")&&!Ke.includes(e.sourceId)}o(ue,"isValidWeapon");function Xe(e){let n=this.actor;if(!z(n,!0)||!ue(this))return e();let t=n.level,s=this._source.system.traits.value;if(s.includes("alchemical")&&s.includes("bomb"))return e();this.system.potencyRune.value=t<2?null:t<10?1:t<16?2:3,this.system.strikingRune.value=t<4?null:t<12?"striking":t<19?"greaterStriking":"majorStriking",e()}o(Xe,"onPrepareWeaponData");var Je={1:35,2:935,3:8935,4:8935},Ze={striking:65,greaterStriking:1065,majorStriking:31065};function et(e){if(e(),!z(this.actor)||this.isSpecific||!ue(this))return;let n=this.price.value.goldValue,t=this.system.potencyRune.value;t&&(n-=Je[t]);let s=this.system.strikingRune.value;s&&(n-=Ze[s]),(t||s)&&!this.system.runes.property.length&&(n+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:n})}o(et,"onPrepareWeaponDerivedData");function fe(e){return!e.isShield}o(fe,"isValidArmor");function tt(e){let n=this.actor;if(!z(n,!0)||!fe(this))return e();let t=n.level;this.system.potencyRune.value=t<5?null:t<11?1:t<18?2:3,this.system.resiliencyRune.value=t<8?null:t<14?"resilient":t<20?"greaterResilient":"majorResilient",e()}o(tt,"onPrepareArmorData");var nt={1:160,2:1060,3:20560,4:20560},st={resilient:340,greaterResilient:3440,majorResilient:49440};function ot(e){if(e(),!z(this.actor)||this.isSpecific||!fe(this))return;let n=this.price.value.goldValue,t=this.system.potencyRune.value;t&&(n-=nt[t]);let s=this.system.resiliencyRune.value;s&&(n-=st[s]),(t||s)&&!this.system.runes.property.length&&(n+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:n})}o(ot,"onPrepareArmorDerivedData");function T(e,n,t=()=>{}){let s=null;return function(i,a=[]){typeof a=="string"&&(a=[a]),i||=a.some(c=>m(c)),i&&!s?s=Hooks.on(e,n):!i&&s&&(Hooks.off(e,s),s=null),t(i)}}o(T,"createHook");function de(e,n,t=()=>{}){let s=null;return function(i){i==="disabled"&&s?(Hooks.off(e,s),s=null):i!=="disabled"&&!s&&(s=Hooks.on(e,n)),t(i)}}o(de,"createChoicesHook");var Q=T("renderEffectsPanel",at,it);function pe(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>Q(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>Q(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{Q(!1,["effect-remove","condition-sheet"])}}}o(pe,"registerEffectsPanelHelper");function it(){game.pf2e.effectPanel?.render()}o(it,"refreshEffectsPanel");function at(e,n){let t=`<div>${k("effects.remove")}</div>`,s='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',i=n.find(".effect-item[data-item-id]").toArray();for(let a of i){let c=a.dataset.itemId,r=e.actor?.items.get(c);if(r&&(m("effect-remove")&&!r.isLocked&&r.badge&&r.badge.type==="counter"&&(a.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",t),a.querySelector(".icon").addEventListener("contextmenu",l=>ct(l,e),!0)),m("condition-sheet")&&r.isOfType("condition"))){let l=a.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",s),l.querySelector('[data-action="edit"]').addEventListener("click",u=>rt(u,e))}}}o(at,"renderEffectsPanel");function rt(e,n){let t=me(e,n);t?.isOfType("condition")&&(e.preventDefault(),t.sheet.render(!0))}o(rt,"onConditionSheet");function ct(e,n){if(!e.shiftKey)return;let t=me(e,n);!t||t.isLocked||!t.badge||t.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),t.delete())}o(ct,"onRemoveEffect");function me(e,n){let i=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return n.actor?.items.get(i)}o(me,"getEffect");var M=class extends FormApplication{constructor(n,t,s){super(n,t),this.onSubmitCallback=s}async getData(){let[n,t]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:n,buttonLabel:t}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(n,t){this.onSubmitCallback(t.quantity,t.newStack)}};o(M,"MoveLootPopup");var V=!1,_=null;function ve(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:ge}],conflicts:["pf2e-giveth"],ready:e=>{m("giveth")!=="disabled"&&ge(!0)}}}o(ve,"registerGiveth");function ge(e){let n=game.user.isGM;e==="disabled"&&V?(n?oe(he):_&&(Hooks.off("dropCanvasData",_),_=null),V=!1):e!=="disabled"&&!V&&(n?se(he):_||(_=ae("dropCanvasData",lt)),V=!0)}o(ge,"setup");function he(e){ie()&&(e.type==="giveth-condition"?dt(e):e.type==="giveth-effect"?pt(e):mt(e))}o(he,"onSocket");function lt(e,n){if(!re())return!0;let t=ft(n);if(!t)return!0;let s=e.tokens.placeables.slice().filter(i=>{if(!i.document.actorLink)return!1;let a=i.actor;if(!be(a,n.actorId)||a.isOwner)return!1;let c=i.x+(i.hitArea?.right??0),r=i.y+(i.hitArea?.bottom??0);return n.x>=i.x&&n.y>=i.y&&n.x<=c&&n.y<=r}).sort((i,a)=>a.document.sort-i.document.sort).at(0)?.actor;return s?(ut(t.actor,s,t.item,t.value),!1):!0}o(lt,"onDropCanvasData");function ut(e,n,t,s){let i=e.id,a=n.id,c=!(t instanceof Item);if(!c&&t.isOfType("physical")){let r=t.quantity;if(r<1)return w("giveth.notification.zero");if(r===1)return ye(i,a,t.id,1,!1);new M(e,{maxQuantity:r,lockStack:!1,isPurchase:!1},(l,u)=>{ye(i,a,t.id,l,u)}).render(!0)}else{let r=c?`Compendium.${t.pack}.${t._id}`:t.uuid;t.type==="condition"?B({type:"giveth-condition",targetId:a,value:s??1,uuid:r}):B({type:"giveth-effect",targetId:a,uuid:r})}}o(ut,"giveth");function ye(e,n,t,s,i){B({type:"giveth-physical",ownerId:e,targetId:n,itemId:t,qty:s,stack:i})}o(ye,"sendPhysicalRequest");function be(e,n){return!e||n&&e.id===n?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}o(be,"isValidActor");function ft(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let n=fromUuidSync(e.uuid);if(!n)return;let t=n.actor;if(!t){let i=e.context?.origin.actor;t=i?fromUuidSync(i):null}if(!be(t)||!t.isOwner)return;let s=!(n instanceof Item);if(s&&n.pack&&["effect","condition"].includes(n.type))return{actor:t,item:n,value:e.value};if(!s&&n.isOfType("physical","effect"))return{actor:t,item:n,value:e.value}}o(ft,"getDetailsFromData");async function dt({targetId:e,uuid:n,value:t}){let s=game.actors.get(e);if(!s)return;let i=await fromUuid(n);i&&s.increaseCondition(i.slug,{min:t})}o(dt,"takethCondition");async function pt({targetId:e,uuid:n}){let t=game.actors.get(e);if(!t)return;let s=await fromUuid(n);if(!s)return;let i=s.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();t.createEmbeddedDocuments("Item",[i])}o(pt,"takethEffect");async function mt({itemId:e,ownerId:n,qty:t,stack:s,targetId:i}){let a=game.actors.get(n),c=game.actors.get(i);if(!a||!c)return;let r=a.items.get(e);if(!r)return;t=Math.min(t,r.quantity);let l=r.quantity-t,u=r.toObject();u.system.quantity=t,u.system.equipped.carryType="worn",r.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=r.traits.has("invested")?!1:null);let d=await c.addToInventory(u,void 0,s);if(!d||(l<1?r.delete():r.update({"system.quantity":l}),m("giveth")==="no-message"))return;let g=ce(d.uuid,d.name,!d.isIdentified);t>1&&(g+=` x${t}`),ChatMessage.create({flavor:`<h4 class="action">${k("giveth.giveth",{target:c.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:a})})}o(mt,"takethPhysical");var Pe=G("knowledges.editLore"),L=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Pe("title",this.actor)}get template(){return C("knowledges/lores")}getData(n){let t=this.actor;return mergeObject(super.getData(n),{unspecified:v(t,"unspecified")??"",specific:v(t,"specific")??"",i18n:Pe})}async _updateObject(n,{unspecified:t,specific:s}){let i=this.object;Y(i,"unspecified",t.trim()),Y(i,"specific",s.trim())}activateListeners(n){n.find("button.cancel").on("click",this.#e.bind(this))}#e(n){n.preventDefault(),this.close()}};o(L,"EditLores");var ke=T("renderNPCSheetPF2e",gt);function Se(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:ke}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&m("knowledges")&&ke(!0)}}}o(Se,"registerKnowledges");function gt(e,n){let t=e.actor;yt(t,n),bt(n),vt(t,n)}o(gt,"renderNPCSheetPF2e");function K(e,n,t){return e.find(`[data-tab="main"] .recall-knowledge ${n==="header"?".section-header":".section-body"} ${t}`)}o(K,"knowledgeSelector");function ht(e){new L(e).render(!0)}o(ht,"editLores");function yt(e,n){let t=v(e,"unspecified"),s=v(e,"specific");if(!t&&!s)return;let i=e.identificationDCs.lore,a=K(n,"body","");a.find(".identification-skills").last().remove();function c(l,u,d){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:d})}</div>`}o(c,"tag");function r(l,{dc:u,start:d}){let g=l.split(",").filter(p=>p.trim()).map(p=>c(p,u,d)).join("");a.append(g)}o(r,"addTags"),r(t||"Unspecific",i[0]),r(s||"Specific",i[1])}o(yt,"replaceLores");function vt(e,n){K(n,"header","button.edit").on("click",()=>ht(e))}o(vt,"addEvents");function bt(e){let n=K(e,"header","button"),t='<button type="button" class="breakdown edit">Edit</button>';n.before(t)}o(bt,"addEditButton");var X=G("merge.multi"),H=class extends Application{constructor(n,t){super(t),this._spell=n}get spell(){return this._spell}get title(){return X("title",this.spell)}get template(){return C("merge/multi")}getData(n){return mergeObject(super.getData(n),{i18n:X})}activateListeners(n){n.find("[data-action=cast]").on("click",this.#e.bind(this)),n.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(n){n.preventDefault();let t=this.element.find("[name=multi]").val();if(t<1){X.error("zero"),this.close();return}let s=this.spell,i=deepClone(s._source.system.damage.value),a=deepClone(s._source.system.heightening)??{};for(let[r,l]of Object.entries(i))for(let u=0;u<t-1;u++){let d=randomID();if(i[d]=l,a.type==="interval"){let g=a.damage[r];g&&(a.damage[d]=g)}else if(a.type==="fixed")for(let[g,p]of Object.entries(a.levels)){let b=p.damage.value[r];b&&(a.levels[g].damage.value[d]=b)}}s.clone({"system.damage.value":i,"system.heightening":a}).rollDamage(n),this.close()}#t(n){n.preventDefault(),this.close()}};o(H,"MultiCast");var Pt=/<div class="tags"><span class="tag".+?<\/div>/gm,kt=/<span class="tag tag_transparent">(.+?)<\/span>/gm,St=/(\[[\w,]+\])/,J=T("renderChatMessage",De,It);function xe(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>J(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>J(e,"merge-damage")}],init:e=>{J(!1,["multi-cast","merge-damage"])}}}o(xe,"registerMerge");function It(){let e=ui.chat?.element;if(e)for(let n of Re(10)){let t=e.find(`[data-message-id=${n.id}]`);t.length&&(t.find("[data-action=multi-cast]").remove(),t.find("[data-action=merge-damage]").remove(),De(n,t))}}o(It,"updateMessages");function De(e,n){!game.user.isGM&&!e.isAuthor||(m("merge-damage")&&we(e)?Ct(e,n):m("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&Et(e,n))}o(De,"renderChatMessage");function Et(e,n){let t=e.getFlag("pf2e","origin.uuid");if(!t)return;let s=n.find(".message-content .chat-card .owner-buttons .spell-button");s.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${k("merge.spell.button")}</button>`),s.find("[data-action=multi-cast]").on("click",async i=>{let a=await fromUuid(t);a&&new H(a).render(!0)})}o(Et,"renderSpell");function Ct(e,n){let t=Z(e);if(!t)return;let i=`<span style="position: absolute; right: 0px; bottom: 1px;">
    <button data-action="merge-damage" title="${k("merge.damage.tooltip")}" style="width: 22px; height: 22px; font-size: 10px; line-height: 1px;">
        <i class="fa-duotone fa-merge"></i>
    </button>
</span>`,a=ee(e);n.find(".dice-result .dice-total").append(i),n.find("[data-action=merge-damage]").on("click",c=>{c.stopPropagation();for(let r of Re(5,e))if(!(Z(r)!==t||ee(r)!==a||!we(r))){xt(c,e,r);return}w("merge.damage.none")})}o(Ct,"renderDamage");async function xt(e,n,t){let s=Dt(n,t),i=Ot(n,t),a=Ee(t),c=Ce(t),r=ee(n),l=Z(n);for(let f of Ee(n))a.includes(f)||a.push(f);for(let f of Ce(n))c.includes(f)||c.push(f);let u=Ie(n),d=Ie(t),g=[];function p(f){return g.find(({options:{flavor:P,critRule:y}})=>P===f.flavor&&y===f.critRule)}o(p,"findGroup");for(let f of[].concat(d,u)){let{options:P,total:y,terms:I}=f,E=I[0],F=f.formula.replace(St,""),D=p(P);D?(D.terms.push(E),D.total+=y,D.formulas.push(F)):g.push({options:P,formulas:[F],total:y,terms:[E]})}for(let f of g)f.formula=`(${f.formulas.join(" + ")})[${f.options.flavor}]`,f.term=f.terms.length<2?f.terms[0]:Oe(f.terms);let b={class:"DamageRoll",options:{},dice:[],formula:`{${g.map(({formula:f})=>f).join(", ")}}`,total:g.reduce((f,{total:P})=>f+P,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:g.map(({formula:f})=>f),modifiers:[],rolls:g.map(({options:f,formula:P,total:y,term:I})=>({class:"DamageInstance",options:f,dice:[],formula:P,total:y,terms:[I],evaluated:!0})),results:g.map(({total:f})=>({result:f,active:!0}))}]};ui.chat.element.find(`[data-message-id=${n.id}], [data-message-id=${t.id}]`).remove(),await ChatMessage.deleteDocuments([n.id,t.id]);let S=await renderTemplate(C("merge/merged"),{header:k("merge.merged.header",{name:s}),tags:i,notes:a,modifiers:c});await CONFIG.ChatMessage.documentClass.create({flavor:S,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:n.speaker,flags:{[h]:{name:s,tags:i,notes:a,modifiers:c,uuid:l,type:"damage-roll",target:r,merged:!0}},rolls:[b]})}o(xt,"mergeDamages");function Oe(e){let n=deepClone(e[0].options);return e.map(t=>(t.options={},t)),{class:"Grouping",options:n,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?Oe(e):e[0]]}}}o(Oe,"createTermGroup");function*Re(e,n){let t=game.messages.contents,s=(n?t.findLastIndex(i=>i===n):t.length)-1;for(let i=s;i>=s-e;i--){let a=t[i];if(!a)return;yield a}}o(Re,"chatMessages");function Ie(e){return v(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}o(Ie,"getMessageRolls");function Z(e){return te(e,"origin.uuid","uuid")}o(Z,"getMessageUuid");function we(e){return te(e,"context.type","type")==="damage-roll"}o(we,"isDamageRoll");function ee(e){return te(e,"context.target.token","target")}o(ee,"getMessageTarget");function Dt(e,n){return v(e,"name")??v(n,"name")??e.getFlag("pf2e","strike.name")??e.item.name}o(Dt,"getItemName");function Ot(e,n){return v(e,"tags")??v(n,"tags")??e.flavor.match(Pt)?.[0]??""}o(Ot,"getTags");function Ee(e){return v(e,"notes")??e.getFlag("pf2e","context.notes").map(({title:n,text:t})=>`<strong>${game.i18n.localize(n)}</strong> ${game.i18n.localize(t)}`)}o(Ee,"getMessageNotes");function Ce(e){let n=v(e,"modifiers");if(n)return n;n=[];let t;for(;t=kt.exec(e.flavor);)n.push(t[1]);return n}o(Ce,"getMessageModifiers");function te(e,n,t){return e.getFlag("pf2e",n)??v(e,t)}o(te,"getMessageFlag");var Rt="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments";function Ae(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0}],init:()=>{m("nobulk")&&A(Rt,wt,"WRAPPER")}}}o(Ae,"registerNobulk");function wt(e,...n){e(...n);let t=this,s=t.inventory.bulk.constructor;Object.defineProperty(t.inventory,"bulk",{get(){let i=new s(t);return i.value=s.computeTotalBulk(t.inventory.filter(a=>!a.isInContainer&&a.system.equipped.carryType!=="dropped"),t.size),i}})}o(wt,"actorPrepareEmbeddedDocuments");var Te=de("renderCharacterSheetPF2e",Tt,At);function $e(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:Te}],conflicts:["pf2e-spells-summary"],init:e=>{m("summary")!=="disabled"&&Te(!0)}}}o($e,"registerSpellsSummary");function At(){Object.values(ui.windows).forEach(e=>e instanceof ActorSheet&&e.actor.type==="character"&&e.render())}o(At,"refreshSheets");async function Tt(e,n){let t=e.actor;if(!t||t.pack||!t.id||!t.isOfType("character"))return;let s=U(n);getProperty(e,`modules.${h}.toggled`)&&s.addClass("toggled"),Wt(n).on("click",i=>Vt(i,n,e)),await $t(n,e,t),s.hasClass("toggled")&&s.hasClass("active")&&e._restoreScrollPositions(n)}o(Tt,"renderCharacterSheetPF2e");async function $t(e,n,t){let s=U(e),i=await Qt(t),a=await renderTemplate(C("summary/sheet"),i);s.append(a),Ft(e,n,t)}o($t,"addSummaryTab");function Ft(e,n,t){let s=Yt(e),i=s.find(".spell-type .uses .spell-slots-input input");i.on("change",a=>Mt(a,t)),i.on("focus",_t),i.on("blur",Lt),s.find(".cast-spell").on("click",a=>jt(a,t)),s.find(".item-toggle-prepare").on("click",a=>Ht(a,t)),s.find(".focus-pips").on("click contextmenu",a=>Ut(a,t)),s.find(".spell-slots-increment-reset").on("click",a=>Gt(a,n,t)),s.find(".item-image").on("click",a=>zt(a,t)),s.find(".item-name > h4").on("click",a=>Bt(a,n))}o(Ft,"addSummaryEvents");async function Mt(e,n){e.preventDefault();let{inputPath:t,entryId:s}=$(e.currentTarget).data(),i=e.currentTarget.valueAsNumber;n.updateEmbeddedDocuments("Item",[{_id:s,[t]:i}])}o(Mt,"onUsesInputChange");function _t(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}o(_t,"onUsesInputFocus");function Lt(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}o(Lt,"onUsesInputBlur");function Ht(e,n){e.preventDefault();let{slotLevel:t,slotId:s,entryId:i,expended:a}=$(e.currentTarget).closest(".item").data();n.spellcasting.collections.get(i)?.setSlotExpendedState(t??0,s??0,a!==!0)}o(Ht,"onTogglePrepare");function Ut(e,n){e.preventDefault();let t=e.type==="click"?1:-1,s=(n.system.resources.focus?.value??0)+t;n.update({"system.resources.focus.value":s})}o(Ut,"onToggleFocusPool");function Nt(e,n){qt(e.element).find(`.item-container.spellcasting-entry[data-item-id=${n}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}o(Nt,"onChargeReset");function Gt(e,n,t){e.preventDefault();let{itemId:s,level:i,isCharge:a}=$(e.currentTarget).data();if(!s)return;if(a){Nt(n,s);return}let c=t.items.get(s);if(c){if(c.isOfType("spellcastingEntry")){let r=i>=0&&i<=11?`slot${i}`:"slot0",l=c.system.slots?.[r];l&&c.update({[`system.slots.${r}.value`]:l.max})}else if(c.isOfType("spell")){let r=c.system.location.uses?.max;r&&c.update({"system.location.uses.value":r})}}}o(Gt,"onSlotsReset");function jt(e,n){e.preventDefault();let t=$(e.currentTarget);if(t.prop("disabled"))return;let{itemId:s,slotLevel:i,slotId:a,entryId:c}=t.closest(".item").data(),r=n.spellcasting.collections.get(c);if(!r)return;let l=r.get(s);l&&r.entry.cast(l,{slot:a,level:i})}o(jt,"onCastSpell");async function Bt(e,n){let t=e.currentTarget.closest(".item");await n.itemRenderer.toggleSummary(t)}o(Bt,"onToggleSummary");async function zt(e,n){let t=$(e.currentTarget).closest(".item").attr("data-item-id"),s=n.items.get(t);!s||s.isOfType("physical")&&!s.isIdentified||await s.toMessage(e)}o(zt,"onItemToChat");function Vt(e,n,t){e.preventDefault();let s=U(n);s.hasClass("active")&&(s.toggleClass("toggled"),s.scrollTop(0),setProperty(t,`modules.${h}.toggled`,s.hasClass("toggled")))}o(Vt,"onSpellcastingBtnToggle");function Wt(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}o(Wt,"getSpellcastingNav");function U(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}o(U,"getSpellcastingTab");function qt(e){return U(e).find(".directory-list.spellcastingEntry-list")}o(qt,"getSpellcastingOriginalSection");function Yt(e){return U(e).find(".directory-list.summary")}o(Yt,"getSpellcastingSummarySection");async function Qt(e){let n=e.system.resources.focus??{value:0,max:0},t=game.modules.get("pf2e-staves")?.active,s=[],i=[],a=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,d=l.statistic.dc.value,g=l.name,p=await l.getSheetData(),b=p.isFocusPool,S=l.system?.prepared?.value==="charge",f=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,P={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let y of p.levels){if(!y.active.length||y.uses?.max===0)continue;let I=[],E=y.isCantrip,F=y.active.filter(O=>O&&O.uses?.max!==0),D=!E&&S&&!t;for(let O=0;O<F.length;O++){let{spell:R,expended:He,virtual:Ue,uses:Ne,castLevel:Ge}=F[O];I.push({name:R.name,img:R.img,range:R.system.range.value||"-",castLevel:Ge??R.level,slotId:O,entryId:u,entryDc:d,entryName:g,itemId:R.id,inputId:p.isInnate?R.id:p.id,inputPath:S?"flags.pf2e-staves.charges":p.isInnate?"system.location.uses.value":`system.slots.slot${y.level}.value`,isCharge:S,isActiveCharge:S&&t,isBroken:D,isVirtual:Ue,isInnate:p.isInnate,isCantrip:E,isFocus:b,isPrepared:p.isPrepared,isSpontaneous:p.isSpontaneous||p.isFlexible,slotLevel:y.level,uses:Ne??(S?P:y.uses),expended:He??(b&&!E?n.value<=0:!1),action:R.system.time.value,type:S?f?`${h}.summary.staff`:`${h}.summary.charges`:p.isInnate?"PF2E.PreparationTypeInnate":p.isSpontaneous?"PF2E.PreparationTypeSpontaneous":p.isFlexible?"PF2E.SpellFlexibleLabel":b?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:S?0:p.isPrepared?1:b?2:p.isInnate?3:p.isSpontaneous?4:5,noHover:p.isPrepared||E||D||b})}if(I.length){if(b)if(E)a=!0;else{i.push(...I);continue}s[y.level]??=[],s[y.level].push(...I)}}})),s.length){let l=m("summary")==="sort"?(u,d)=>u.order===d.order?j(u.name,d.name):u.order-d.order:(u,d)=>j(u.name,d.name);s.forEach(u=>u.sort(l))}i.length&&(i.sort((l,u)=>j(l.name,u.name)),s[12]=i,a=!1);let r=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:d})=>({name:d.name,img:d.img,slotId:u,itemId:d.id,level:d.level,time:d.system.time.value})).filter(Boolean));return{spells:s,rituals:r,focusPool:n,stavesActive:t,hasFocusCantrips:a,isOwner:e.isOwner}}o(Qt,"getData");var N=null,x=null;function Me(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:Fe}],conflicts:["pf2e-unided"],init:()=>{Fe()}}}o(Me,"registerUnided");function Fe(e){e??=m("unided"),e==="disabled"?(N&&(Hooks.off("preCreateItem",N),N=null),x&&(Hooks.off("preUpdateItem",x),x=null)):(N||(N=Hooks.on("preCreateItem",Kt)),e==="all"&&!x?x=Hooks.on("preUpdateItem",Xt):e!=="all"&&x&&(Hooks.off("preUpdateItem",x),x=null))}o(Fe,"setHooks");function Kt(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}o(Kt,"preCreateItem");function Xt(e,n){!e.isOfType("physical")||!("img"in n)||setProperty(n,"system.identification.unidentified.img",n.img)}o(Xt,"preUpdateItem");var _e=[le(),Ae(),ve(),Se(),Me(),xe(),pe(),$e()],Le=new Set;Hooks.once("init",()=>{let e=game.data.users.find(t=>t._id===game.data.userId),n=e&&e.role>=CONST.USER_ROLES.GAMEMASTER;for(let t of _e){let{settings:s=[],init:i,conflicts:a=[]}=t;for(let c of s){let r=c.name;c.choices&&(c.choices=c.choices.reduce((l,u)=>(l[u]=ne(r,`choices.${u}`),l),{})),game.settings.register(h,r,{scope:"world",config:!0,...c,name:ne(r,"name"),hint:ne(r,"hint")})}if(n)for(let c of a){let r=game.modules.get(c);r?.active&&(t.conflicting=!0,Le.add(r.title))}!t.conflicting&&i&&i(n)}});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:n,ready:t}of _e)!n&&t&&t(e);if(e)for(let n of Le)w("module-conflict",{name:n},!0)});function ne(e,n){return`${h}.settings.${e}.${n}`}o(ne,"settingPath");})();
//# sourceMappingURL=main.js.map
