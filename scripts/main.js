(()=>{var gi=Object.defineProperty;var a=(e,t)=>gi(e,"name",{value:t,configurable:!0});function un(e){let t=a(r=>r.active&&!r.isGM,"isValidUser"),n=game.users.filter(r=>t(r)&&r.character===e);return n.length||(n=game.users.filter(r=>t(r)&&doc.testUserPermission(r,"OWNER"))),n.sort((r,s)=>r.id>s.id?1:-1),n[0]||null}a(un,"getOwner");function fn(e){return un(e)===game.user}a(fn,"isOwner");function dn(e){return e.token?.name??e.prototypeToken?.name??e.name}a(dn,"getHighestName");function Ge(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}a(Ge,"refreshCharacterSheets");function*Ve(e,t){let n=ui.chat?.element;if(!n)return;let r=game.messages.contents,s=(t?r.findLastIndex(i=>i===t):r.length)-1;for(let i=s;i>=s-e;i--){let o=r[i];if(!o)return;let c=n.find(`[data-message-id=${o.id}]`);c.length&&(yield{message:o,html:c})}}a(Ve,"latestChatMessages");function xe(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}a(xe,"chatUUID");function cr(e){return!!(e.getFlag("pf2e","casting.embeddedSpell")||e.item?.trickMagicEntry)}a(cr,"hasEmbeddedSpell");function fe(e,...t){return getProperty(e,`modules.${F.id}.${t.join(".")}`)}a(fe,"getInMemory");function de(e,...t){let n=t.splice(-1)[0];return setProperty(e,`modules.${F.id}.${t.join(".")}`,n)}a(de,"setInMemory");function ut(e,...t){let n=["modules",F.id,...t],r=n.pop(),s=e;for(let i of n)if(s=s[i],!s)return!0;return delete s[r]}a(ut,"deleteInMemory");function lr(e,t,n){let r={};for(let s of e){let i=Array.isArray(s)?s[n??0]:typeof s=="object"&&n!=null?s[n]:s;r[i]=t(s)}return r}a(lr,"arrayToObject");function mn(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let r of e){let s=n.findIndex(i=>r===i);if(s===-1)return!1;n.splice(s,1)}return!0}a(mn,"compareArrays");function ft(e){return e!==void 0&&e!==-1}a(ft,"indexIsValid");function dt(e){return Array.from(e.parentElement.children).indexOf(e)}a(dt,"getElementIndex");function ur(e,t,n,r){let s=n-e,i=r-t;return Math.sqrt(s*s+i*i)}a(ur,"calculateDistanceBetweenPoints");function pt(e,t){if(typeof e!="object")return!1;let n=Reflect.getPrototypeOf(e);for(;n;){if(n.constructor.name===t)return!0;n=Reflect.getPrototypeOf(n)}return!1}a(pt,"isInstanceOf");function $e(e,...t){return(Array.isArray(t[0])?t[0]:t).filter(r=>typeof r=="string").join(e)}a($e,"joinStr");function Se(...e){return`flags.${F.id}.${$e(".",e)}`}a(Se,"flagPath");function P(e,...t){return e.getFlag(F.id,t.join("."))}a(P,"getFlag");function gn(e,...t){return getProperty(e,Se(...t))}a(gn,"getFlagProperty");function ae(e,...t){let n=t.splice(-1)[0];return e.setFlag(F.id,t.join("."),n)}a(ae,"setFlag");function fr(e,...t){return e.unsetFlag(F.id,t.join("."))}a(fr,"unsetFlag");function We(e,...t){let n=t.splice(-1)[0];return e.updateSource({[Se(...t)]:n})}a(We,"updateSourceFlag");function Ye(e,...t){let n=t.splice(-1)[0];e[Se(...t)]=n}a(Ye,"moduleFlagUpdate");function z(...e){let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:{},n=ue(...e);return renderTemplate(n,t)}a(z,"render");function ue(...e){return`modules/${F.id}/templates/${$e("/",e)}.hbs`}a(ue,"templatePath");function dr(e,t){let n=Hooks.on(e,t),r=Hooks.events[e].findIndex(s=>s.id===n);if(r!==0){let[s]=Hooks.events[e].splice(r,1);Hooks.events[e].unshift(s)}return n}a(dr,"registerUpstreamHook");function pr(e){return e.getFlag("core","sourceId")}a(pr,"getSourceId");function hi(e,t){let n=pr(e);return n?t.includes(n):!1}a(hi,"includesSourceId");function mr(e){return Array.isArray(e)?t=>hi(t,e):t=>pr(t)===e}a(mr,"getItemSourceIdCondition");function gr(e,t=[]){let n=typeof t=="string"?[t]:t;return n.length?n.flatMap(r=>e.itemTypes[r]):e.items}a(gr,"getItems");function hr(e,t,n){return gr(e,n).some(mr(t))}a(hr,"hasItemWithSourceId");function mt(e,t,n){return gr(e,n).find(mr(t))}a(mt,"getItemWithSourceId");function Z(e,t,n="WRAPPER"){return libWrapper.register(F.id,e,t,n)}a(Z,"registerWrapper");function yr(e){libWrapper.unregister(F.id,e)}a(yr,"unregisterWrapper");function N(...e){e.unshift(F.id);let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:void 0;return game.i18n[t?"format":"localize"]($e(".",e),t)}a(N,"localize");function yi(...e){return game.i18n.has(`${F.id}.${e.join(".")}`,!1)}a(yi,"hasLocalization");function Ke(...e){return`${F.id}.${e.join(".")}`}a(Ke,"localizePath");function H(e){let t=a((...n)=>N(e,...n),"fn");return Object.defineProperties(t,{warn:{value:(n,r,s)=>K(`${e}.${n}`,r,s),enumerable:!1,configurable:!1},info:{value:(n,r,s)=>Ne(`${e}.${n}`,r,s),enumerable:!1,configurable:!1},error:{value:(n,r,s)=>we(`${e}.${n}`,r,s),enumerable:!1,configurable:!1},has:{value:n=>yi(e,n),enumerable:!1,configurable:!1},path:{value:n=>Ke(e,n),enumerable:!1,configurable:!1},template:{value:(n,{hash:r})=>t(n,r),enumerable:!1,configurable:!1},i18n:{get(){return{i18n:this.template,i18Path:this.path}},enumerable:!1,configurable:!1}}),t}a(H,"subLocalize");function gt(e,t){return e.localeCompare(t,game.i18n.lang)}a(gt,"localeCompare");var vi={0:"F",free:"F",1:"1",2:"2",3:"3","1 or 2":"1/2","1 to 3":"1 - 3","2 or 3":"2/3","2 rounds":"3,3",reaction:"R"};function vr(e){if(!e&&e!==0)return"";let t=typeof e!="object"?e:e.type==="action"?e.value:e.type,n=String(t??"").toLowerCase().trim();return vi[n]?.replace("-","\u2013")??""}a(vr,"getActionGlyph");function hn(e,t,n,r){let s=typeof t=="string"?t:"info",i=typeof t=="object"?t:typeof n=="object"?n:void 0,o=typeof t=="boolean"?t:typeof n=="boolean"?n:r??!1;ui.notifications.notify(N(e,i),s,{permanent:o})}a(hn,"notify");function K(e,t,n){hn(e,"warning",t,n)}a(K,"warn");function Ne(e,t,n){hn(e,"info",t,n)}a(Ne,"info");function we(e,t,n){hn(e,"error",t,n)}a(we,"error");function br(e){e.key??=e.name,Array.isArray(e.choices)&&(e.choices=lr(e.choices,t=>yn(e.key,`choices.${t}`))),e.name??=yn(e.key,"name"),e.hint??=yn(e.key,"hint"),e.scope??="world",e.config??=!0,game.settings.register(F.id,e.key,e)}a(br,"registerSetting");function yn(e,t){return`${F.id}.settings.${e}.${t}`}a(yn,"settingPath");function T(e){return game.settings.get(F.id,e)}a(T,"getSetting");function Sr(e,t){return game.settings.set(F.id,e,t)}a(Sr,"setSetting");function wr(e){game.socket.on(`module.${F.id}`,e)}a(wr,"socketOn");function pn(e){game.socket.emit(`module.${F.id}`,e)}a(pn,"socketEmit");function bi(){return game.user??game.data.users.find(e=>e._id===game.data.userId)}a(bi,"getUser");function Er(){let e=bi();return e&&e.role>=CONST.USER_ROLES.ASSISTANT}a(Er,"isUserGM");function ht(){return game.user===game.users.activeGM}a(ht,"isActiveGM");function xr(){return game.users.some(e=>e.active&&e.isGM)}a(xr,"isGMOnline");var vn=null,F={get id(){if(!vn)throw new Error("Module id needs to be registered.");return vn},error(e){throw new Error(`[${this.id}] ${e}`)}};function Cr(e){vn=e}a(Cr,"registerModule");function kr(e){return game.modules.get(e??F.id)}a(kr,"getModule");var Si=a((e,t)=>e.modifier>=t.modifier,"HIGHER_BONUS"),wi=a((e,t)=>e.modifier<=t.modifier,"LOWER_PENALTY");function Dr(e){let t=0,n={},r={},s=e.filter(o=>o.type==="ability"&&!o.ignored),i=s.reduce((o,c)=>o===null||c.force?c:o.force?o:c.modifier>o.modifier?c:o,null);for(let o of s)o.ignored=o!==i;for(let o of e){if(o.ignored){o.enabled=!1;continue}if(o.type==="untyped"){o.enabled=!0,t+=o.modifier;continue}o.modifier<0?t+=Ir(r,o,wi):t+=Ir(n,o,Si)}return t}a(Dr,"applyStackingRules");function Ir(e,t,n){let r=e[t.type];return r===void 0?(t.enabled=!0,e[t.type]=t,t.modifier):n(t,r)?(r.enabled=!1,t.enabled=!0,e[t.type]=t,t.modifier-r.modifier):(t.enabled=!1,0)}a(Ir,"applyStacking");function Ar(e){let t=Or(e);return Promise.all(t.currentIndex.flatMap(async({uuid:n})=>(await fromUuid(n))?.toObject()))}a(Ar,"getTabResults");function Tr(){return game.pf2e.compendiumBrowser}a(Tr,"getBrowser");function Me(e){return game.pf2e.compendiumBrowser.tabs[e]}a(Me,"getBrowserTab");function Pr(e,t){let n=Or(e),r=typeof t=="object"?t:t===!0&&n.isInitialized?n.filterData:void 0;return game.pf2e.compendiumBrowser.openTab(n.tabName,r)}a(Pr,"openBrowserTab");function Or(e){return typeof e=="string"?Me(e):e}a(Or,"tabFromTabOrTabName");var he;function bn({collapsed:e=!1,mergeWith:t}={}){let n=Me("equipment"),r=a(s=>{let i=deepClone(s);if(e){for(let[o,c]of Object.entries(i))if(!(o==="order"||o==="search"))for(let l of Object.values(c))"isExpanded"in l&&(l.isExpanded=!1)}if(typeof t=="object"){mergeObject(i,t);for(let o of Object.values(i.checkboxes))if(o.selected.length){o.isExpanded=!0;for(let c of o.selected)o.options[c].selected=!0}for(let o of["ranges","sliders"]){let c=s[o];for(let[l,d]of Object.entries(i[o])){let u=c[l];objectsEqual(d.values,u.values)||(d.isExpanded=!0)}}}return i},"returned");return n.defaultFilterData?r(n.defaultFilterData):(he||(he=n.prepareFilterData(),he.checkboxes.armorTypes.options=n.generateCheckboxOptions(CONFIG.PF2E.armorCategories),mergeObject(he.checkboxes.armorTypes.options,n.generateCheckboxOptions(CONFIG.PF2E.armorGroups)),he.checkboxes.weaponTypes.options=n.generateCheckboxOptions(CONFIG.PF2E.weaponCategories),mergeObject(he.checkboxes.weaponTypes.options,n.generateCheckboxOptions(CONFIG.PF2E.weaponGroups)),he.multiselects.traits.options=n.generateMultiselectOptions({...CONFIG.PF2E.armorTraits,...CONFIG.PF2E.consumableTraits,...CONFIG.PF2E.equipmentTraits,...CONFIG.PF2E.shieldTraits,...CONFIG.PF2E.weaponTraits}),he.checkboxes.itemTypes.options=n.generateCheckboxOptions({weapon:"TYPES.Item.weapon",shield:"TYPES.Item.shield",armor:"TYPES.Item.armor",equipment:"TYPES.Item.equipment",consumable:"TYPES.Item.consumable",treasure:"TYPES.Item.treasure",backpack:"TYPES.Item.backpack",kit:"TYPES.Item.kit"}),he.checkboxes.rarity.options=n.generateCheckboxOptions(CONFIG.PF2E.rarityTraits,!1)),r(he))}a(bn,"getEquipmentTabData");function yt(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}a(yt,"htmlQuery");function Rr(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}a(Rr,"ordinalString");function vt(e){return Error(`PF2e System | ${e}`)}a(vt,"ErrorPF2e");var Mr;function Fr(e,{emptyStringZero:t=!1,zeroIsNegative:n=!1}={}){if(e===0&&t)return"";Mr??=new Intl.NumberFormat(game.i18n.lang,{maximumFractionDigits:0,signDisplay:"always"});let r=n&&e===0?-0:e;return Mr.format(r)}a(Fr,"signedInteger");async function Lr({affects:e,origin:t,target:n,item:r,domains:s,options:i}){if(!(t&&n))return[];let[o,c]=e==="target"?[t,n]:[n,t],l=[...i,o.getRollOptions(s),c.getSelfRollOptions(e)].flat(),d=r?r.isOfType("spell")?{spell:r}:{weapon:r}:{};return(await Promise.all(s.flatMap(u=>o.synthetics.ephemeralEffects[u]?.[e]??[]).map(u=>u({test:l,resolvables:d})))).flatMap(u=>u??[])}a(Lr,"extractEphemeralEffects");function Hr(e,t){return t.flatMap(n=>(e[n]??[]).map(r=>r.clone()))}a(Hr,"extractNotes");function Ur(e,t,n){return t.flatMap(r=>e[r]??[]).flatMap(r=>r(n)??[])}a(Ur,"extractDamageDice");function $r(e,t,n){let{modifierAdjustments:r,modifiers:s}=e,i=Array.from(new Set(t)).flatMap(o=>s[o]??[]).flatMap(o=>o(n)??[]);for(let o of i)o.adjustments=Ei(r,t,o.slug);return i}a($r,"extractModifiers");function Ei(e,t,n){return Array.from(new Set(t.flatMap(s=>e[s]??[]))).filter(s=>[n,null].includes(s.slug))}a(Ei,"extractModifierAdjustments");async function Sn({message:e,multiplier:t=1,addend:n=0,promptModifier:r=!1,rollIndex:s=0,tokens:i,onDamageApplied:o}){if(r)return xi({message:e,multiplier:t,rollIndex:s,tokens:i,onDamageApplied:o});if(i??=yt(ui.chat.element[0],`li.chat-message[data-message-id="${e.id}"]`)?.dataset.actorIsTarget&&e.token?[e.token]:game.user.getActiveTokens(),i.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}let c=CONFIG.PF2E.chatDamageButtonShieldToggle,l=e.rolls.at(s);if(!pt(l,"DamageRoll"))throw vt("Unexpected error retrieving damage roll");let d=t<0?t*l.total+n:l.alter(t,n),u=[...e.flags.pf2e.context?.options??[]],p=u.filter(g=>g.startsWith("self:")).map(g=>g.replace(/^self/,"origin")),m=e.item,v=m?.isOfType("affliction","condition","effect")?m.getRollOptions("item"):[];for(let g of i){if(!g.actor)continue;u.some(Q=>Q.startsWith("target"))||u.push(...g.actor.getSelfRollOptions("target"));let y=t>0?"damage-received":"healing-received",w=t>0?await Lr({affects:"target",origin:e.actor,target:g.actor,item:e.item,domains:[y],options:u}):[],E=g.actor.getContextualClone(p,w),x=new Set([...u.filter(Q=>!/^(?:self|target):/.test(Q)),...v,...p,...E.getSelfRollOptions()]),C=e.flags.pf2e.context?.outcome,M=[],L=[];if(typeof d=="number"&&d<0){let Q=C==="criticalSuccess",j=m?.isOfType("spell")?{spell:m}:m?.isOfType("weapon")?{weapon:m}:{},oe=Ur(E.synthetics.damageDice,[y],{resolvables:j,test:x}).filter(R=>(R.critical===null||R.critical===Q)&&R.predicate.test(x));for(let R of oe){let ve=`${R.diceNumber}${R.dieSize}[${R.label}]`,be=await new Roll(ve).evaluate({async:!0});be._formula=`${R.diceNumber}${R.dieSize}`,await be.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:R.label,speaker:ChatMessage.getSpeaker({token:g})}),M.push(`${R.label} ${R.diceNumber}${R.dieSize}`),L.push(be)}L.length&&(d-=L.map(R=>R.total).reduce((R,ve)=>R+ve));let V=$r(E.synthetics,[y],{resolvables:j}).filter(R=>(R.critical===null||R.critical===Q)&&R.predicate.test(x));d-=Dr(V??[]),M.push(...V.filter(R=>R.enabled).map(R=>`${R.label} ${Fr(R.modifier)}`))}let ne=(typeof d=="number"?d!==0:d.total!==0)?Hr(E.synthetics.rollNotes,[y]).filter(Q=>(!C||Q.outcome.length===0||Q.outcome.includes(C))&&Q.predicate.test(x)):[];await E.applyDamage({damage:d,token:g,item:e.item,skipIWR:t<=0,rollOptions:x,shieldBlockRequest:c,breakdown:M,notes:ne})}bt(e.id),o?.(e,i,s)}a(Sn,"applyDamageFromMessage");function Nr(e,t,n){let r=a(()=>[e],"getTokens"),s=a(i=>i[0]?.actor?.itemTypes.shield.filter(c=>c.isEquipped&&!c.isBroken&&!c.isDestroyed)??[],"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:yt(n,"div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let i=r();if(!i.length)return!1;let o=s(i),c=i.length===1&&o.length>1,l=t.classList.contains("shield-activated");return c&&!l?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(i,o,c)=>{let l=r(),d=s(l),u=l.length===1&&d.length>1,p=t.classList.contains("shield-activated");if(u&&!p){let m=yt(c,"ul.shield-options");if(!m)return $(c);let v=d.map(g=>{let y=document.createElement("input");y.classList.add("data"),y.type="radio",y.name="shield-id",y.value=g.id,y.addEventListener("click",()=>{t.dataset.shieldId=y.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,i.close()});let w=document.createElement("span");w.classList.add("label"),w.innerHTML=g.name;let E=document.createElement("span");E.classList.add("tag");let x=game.i18n.localize("PF2E.HardnessLabel");E.innerHTML=`${x}: ${g.hardness}`;let C=document.createElement("li");return C.classList.add("item"),C.append(y,w,E),C});m.replaceChildren(...v)}return $(c)}}).tooltipster("open")}a(Nr,"onClickShieldBlock");function bt(e){console.trace("toggleOffShieldBlock");for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action$=shield-block]`;for(let r of document.body.querySelectorAll(n))r?.classList.remove("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}a(bt,"toggleOffShieldBlock");async function xi({message:e,multiplier:t,rollIndex:n,tokens:r,onDamageApplied:s}){let i=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),o=class extends Dialog{static{a(this,"AdjustmentDialog")}activateListeners(l){super.activateListeners(l),l[0].querySelector("input")?.focus()}},c=t<0;new o({title:game.i18n.localize(c?"PF2E.UI.shiftModifyHealingTitle":"PF2E.UI.shiftModifyDamageTitle"),content:i,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async l=>{let d=(Number(l[0].querySelector("input")?.value)||0)*Math.sign(t);Sn({message:e,multiplier:t,addend:d,promptModifier:!1,rollIndex:n,tokens:r,onDamageApplied:s})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{bt(e.id)}}).render(!0)}a(xi,"shiftAdjustDamage");function _r(){return CONFIG.Dice.rolls.find(e=>e.name==="DamageRoll")}a(_r,"getDamageRollClass");var St="handwraps-of-mighty-blows";function wn(e){return e.traits.has("invested")}a(wn,"canBeInvested");function qr(e){return e.system.equipped.inSlot!=null}a(qr,"hasWornSlot");function Ci(e){return e.system.usage.type==="worn"&&e.system.equipped.inSlot}a(Ci,"isWornAs");function En(e){return e.isInvested||Ci(e)}a(En,"isInvestedOrWornAs");function wt(e){return e.system.usage.type==="held"}a(wt,"isHeld");function Et(e){return wt(e)&&e.system.usage.value==="held-in-two-hands"}a(Et,"isTwoHanded");function jr(e){return wt(e)&&e.system.usage.value==="held-in-one-hand"}a(jr,"isOneHanded");function ki(e,t){let n=e.system.usage;return n.type==="worn"&&n.where?t:void 0}a(ki,"inSlotValue");function Ii(e,t){let n=t??!e.system.equipped.invested;return e.traits.has("invested")?n:void 0}a(Ii,"toggleInvestedValue");function xt(e,{carryType:t="worn",handsHeld:n=0,inSlot:r,invested:s,containerId:i}){let o={_id:e.id,system:{equipped:{carryType:t,handsHeld:n,inSlot:ki(e,r),invested:Ii(e,s)}}};return i!==void 0&&(o.system.containerId=i),o}a(xt,"itemCarryUpdate");function Ct(e){return e.isOfType("weapon")&&e.slug===St&&e.category==="unarmed"}a(Ct,"isHandwrapsOfMightyBlows");function xn(e,t=1,n=1){let r=game.pf2e.Coins.fromPrice(e.price,t);return n===1?r:r.scale(n)}a(xn,"calculateItemPrice");function Br(e){if(e==="cantrips")return 0;let t=Number(e??NaN);return t.between(0,10)?t:null}a(Br,"spellSlotGroupIdToNumber");var kt={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},zr=["criticalFailure","failure","success","criticalSuccess"],It=class e{static{a(this,"DegreeOfSuccess")}constructor(t,n,r=null){t instanceof Roll?(this.dieResult=(t.isDeterministic?t.terms.find(s=>s instanceof NumericTerm):t.dice.find(s=>s instanceof Die&&s.faces===20))?.total??1,this.rollTotal=t.total):(this.dieResult=t.dieValue,this.rollTotal=t.dieValue+t.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=this.#r(),this.adjustment=this.#e(this.unadjusted,r),this.value=this.adjustment?this.#t(this.adjustment.amount,this.unadjusted):this.unadjusted}static CRITICAL_FAILURE=0;static FAILURE=1;static SUCCESS=2;static CRITICAL_SUCCESS=3;#e(t,n){if(!n)return null;for(let r of["all",...zr]){let{label:s,amount:i}=n[r]??{};if(i&&s&&!(t===e.CRITICAL_SUCCESS&&i===kt.INCREASE)&&!(t===e.CRITICAL_FAILURE&&i===kt.LOWER)&&(r==="all"||zr.indexOf(r)===t))return{label:s,amount:i}}return null}#t(t,n){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+t,0,3)}}#n(t){return this.dieResult===20?this.#t(kt.INCREASE,t):this.dieResult===1?this.#t(kt.LOWER,t):t}#r(){let t=this.dc.value;return this.rollTotal-t>=10?this.#n(e.CRITICAL_SUCCESS):t-this.rollTotal>=10?this.#n(e.CRITICAL_FAILURE):this.rollTotal>=t?this.#n(e.SUCCESS):this.#n(e.FAILURE)}};function Gr(e,{collisionOrigin:t,collisionType:n="move"}={}){let r=e instanceof MeasuredTemplateDocument?e.object:e;if(!canvas.scene)return[];let{grid:s,dimensions:i}=canvas;if(!(s&&i))return[];if(!r?.highlightId)return[];let o=s.getHighlightLayer(r.highlightId);if(!o||s.type!==CONST.GRID_TYPES.SQUARE)return[];let c=t??r.center,l=canvas.tokens.quadtree.getObjects(o.getLocalBounds(void 0,!0)),d=s.size,u=[];for(let p of l){let m=p.document,v=[];for(let g=0;g<m.height;g++){let y=Math.floor(p.x/d)*d,E=Math.floor(p.y/d)*d+g*d;if(v.push(`${y}.${E}`),m.width>1)for(let x=1;x<m.width;x++)v.push(`${y+x*d}.${E}`)}for(let g of v){if(!o.positions.has(g))continue;let[y,w]=g.split(".").map(C=>Number(C)),E={x:y+i.size*.5,y:w+i.size*.5};if(E.x<0||E.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,E,{type:n,mode:"any"}))){u.push(p);break}}}return u}a(Gr,"getTemplateTokens");function Ee(e,t){console.error(`an error occured in the feature '${e}' of the module '${F.id}' with the wrapper: '${t}'`)}a(Ee,"wrapperError");async function Cn(e,{user:t=game.user,synchronize:n=!0}={}){if(game.modules.get("dice-so-nice")?.active)return game.dice3d.showForRoll(e,t,n)}a(Cn,"roll3dDice");var Vr="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Wr="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Yr="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Kr="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData";function Qr(){return{settings:[{key:"auto-runes",type:String,default:"disabled",choices:["disabled","force","lower"],requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{let e=T("auto-runes");e!=="disabled"&&(Z(Vr,Pi,"WRAPPER"),Z(Wr,Oi,"WRAPPER"),Z(Yr,Fi,"WRAPPER"),Z(Kr,Li,"WRAPPER"),e==="force"&&Hooks.on("renderPhysicalItemSheetPF2e",Hi))},ready:e=>{e&&T("auto-runes")!=="disabled"&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),Ne("arp.forceVariant"))}}}a(Qr,"registerArp");function Qe(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}a(Qe,"isValidActor");var Di={1:35,2:935,3:8935,4:8935},Ai={1:65,2:1065,3:31065};function Ti(e){return["shield-boss","shield-spikes"].includes(e._source.system.baseItem)}a(Ti,"isShieldWeapon");function Xr(e){let t=e._source.system.traits.value,{group:n,category:r,slug:s}=e._source.system;return r==="unarmed"&&s!==St?!!e.actor.itemTypes.weapon.find(i=>i.slug===St&&i._source.system.category==="unarmed"&&i._source.system.equipped.carryType==="worn"&&i._source.system.equipped.inSlot===!0&&i._source.system.equipped.invested===!0&&i._source.system.identification.status==="identified"):(n!=="shield"||Ti(e))&&!t.includes("alchemical")&&!t.includes("bomb")}a(Xr,"isValidWeapon");function Pi(e){try{let t=this.actor;if(!Qe(t,!0)||!Xr(this))return e();let n=this._source.system.traits.value;if(n.includes("alchemical")&&n.includes("bomb"))return e();let r=t.level,s=T("auto-runes")==="force",i=r<2?null:r<10?1:r<16?2:3,o=r<4?null:r<12?1:r<19?2:3;(this.system.runes.potency<=i||s)&&(this.system.runes.potency=i),(this.system.runes.striking<=o||s)&&(this.system.runes.striking=o)}catch{Ee("auto-runes",Vr)}e()}a(Pi,"onPrepareWeaponData");function Oi(e){e();try{if(!Qe(this.actor)||this.isSpecific||!Xr(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=Di[n]);let r=this.system.runes.striking;r&&(t.gp-=Ai[r]),t=new game.pf2e.Coins(t),(n||r)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{Ee("auto-runes",Wr)}}a(Oi,"onPrepareWeaponDerivedData");var Mi={1:160,2:1060,3:20560,4:20560},Ri={1:340,2:3440,3:49440};function Jr(e){return!0}a(Jr,"isValidArmor");function Fi(e){try{let t=this.actor;if(!Qe(t,!0)||!Jr(this))return e();let n=t.level,r=T("auto-runes")==="force",s=n<5?null:n<11?1:n<18?2:3,i=n<8?null:n<14?1:n<20?2:3;(this.system.runes.potency<=s||r)&&(this.system.runes.potency=s),(this.system.runes.resilient<=i||r)&&(this.system.runes.resilient=i)}catch{Ee("auto-runes",Yr)}e()}a(Fi,"onPrepareArmorData");function Li(e){e();try{if(!Qe(this.actor)||this.isSpecific||!Jr(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=Mi[n]);let r=this.system.runes.resilient;r&&(t.gp-=Ri[r]),t=new game.pf2e.Coins(t),(n||r)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{Ee("auto-runes",Kr)}}a(Li,"onPrepareArmorDerivedData");function Hi(e,t){let n=e.item;if(!n||!n.isOfType("weapon","armor")||!Qe(n.actor,!0))return;let r=["potency","striking","resilient"].map(s=>`[name="system.runes.${s}"]`).join(", ");t.find(`[data-tab=details] fieldset .form-group:has(${r})`).hide()}a(Hi,"renderPhysicalItemSheetPF2e");function G(e,t,n=()=>{}){let r=null;return(s,i=[],o=!1)=>{let l=s||(typeof i=="string"?[i]:i).some(d=>T(d));l&&!r?r=Hooks.on(e,t):!l&&r&&(Hooks.off(e,r),r=null),o||n(l)}}a(G,"createHook");function Zr(e,t,n=()=>{}){let r=null;return(s,i=!1)=>{s==="disabled"&&r?(Hooks.off(e,r),r=null):s!=="disabled"&&!r&&(r=Hooks.on(e,t)),i||n(s)}}a(Zr,"createChoicesHook");var Ui=G("renderApplication",kn),$i=G("renderActorSheet",kn),Ni=G("renderItemSheet",kn);function ta(){return{settings:[{key:"debug",type:Boolean,default:!1,config:!1,scope:"client",onChange:e=>ea(e)}],init:()=>{ea()}}}a(ta,"registerDebug");function ea(e){let t=e??T("debug");Ui(t),$i(t),Ni(t)}a(ea,"setup");function kn(e,t){let n=t.find(".document-id-link")[0];n&&n.addEventListener("click",r=>{if(!r.shiftKey)return;let s=e.object;if(!s)return;r.preventDefault(),r.stopPropagation();let i=s.type,o=2,c=i;for(;window[c];)c=`${i}${o++}`;window[c]=s,console.log(c,s)},!0)}a(kn,"onRender");var In=G("renderEffectsPanel",qi,_i);function na(){return{settings:[{key:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>In(e,"condition-sheet")},{key:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>In(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{In(!1,["effect-remove","condition-sheet"])}}}a(na,"registerEffectsPanelHelper");function _i(){game.pf2e.effectPanel?.render()}a(_i,"refreshEffectsPanel");function qi(e,t){let n=`<div>${N("effects.remove")}</div>`,r='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',s=t.find(".effect-item[data-item-id]").toArray();for(let i of s){let o=i.dataset.itemId,c=e.actor?.items.get(o);if(c&&(T("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(i.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),i.querySelector(".icon").addEventListener("contextmenu",l=>Bi(l,e),!0)),T("condition-sheet")&&c.isOfType("condition"))){let l=i.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",r),l.querySelector('[data-action="edit"]').addEventListener("click",d=>ji(d,e))}}}a(qi,"renderEffectsPanel");function ji(e,t){let n=ra(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}a(ji,"onConditionSheet");function Bi(e,t){if(!e.shiftKey)return;let n=ra(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}a(Bi,"onRemoveEffect");function ra(e,t){let s=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(s)}a(ra,"getEffect");var ce={wrapperIds:[],tabs:new Collection},Dt={wrapperIds:[],listeners:new Map},aa="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",zi="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner",Gi="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render",Vi="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners";function le(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}a(le,"isPlayedActor");function sa(e,t){Dt.wrapperIds.length||(Dt.wrapperIds=[Z(aa,Wi,"WRAPPER")]),Dt.listeners.set(e,t)}a(sa,"registerActorPreparedEmbeddedDocuments");function At(e){ce.wrapperIds.length||(ce.wrapperIds=[Z(Gi,Yi),Z(zi,Ki),Z(Vi,Qi)]),ce.tabs.set(e.tabName,e)}a(At,"registerCharacterSheetExtraTab");function Tt(e){if(ce.tabs.delete(e),ce.wrapperIds.length&&!ce.tabs.size){for(let t of ce.wrapperIds)yr(t);ce.wrapperIds=[]}}a(Tt,"unregisterCharacterSheetExtraTab");function Wi(e,...t){e(...t);for(let[n,r]of Dt.listeners)try{r.call(this)}catch{wrapperError(n,aa)}}a(Wi,"actorPrepareEmbeddedDocuments");async function Yi(e,...t){let n={};for(let{tabName:r}of ce.tabs){let i=Ce(this.element,r).find(".alternate")[0];i&&(n[r]=i.scrollTop)}await e(...t);for(let{tabName:r}of ce.tabs){if(!n[r])continue;let o=Ce(this.element,r).find(".alternate")[0];o.scrollTop=n[r]}}a(Yi,"characterSheetRender");async function Ki(e,t){let n=await e(t),r=this.actor;if(!ce.tabs.size||!le(r))return n;let s=this.element;for(let{tabName:i,getData:o,templateFolder:c,onRender:l}of ce.tabs){let d=Ce(n,i),u=await o(r,this,Ce(s,i)),p=await z(c,u);l&&await l(r,this,n),fe(this,`${i}.toggled`)&&d.addClass("toggled"),d.children(":last").before(p)}return n}a(Ki,"characterSheetInnerRender");function Qi(e,t){e(t);let n=this.actor;if(!(!ce.tabs.size||!le(n)))for(let{tabName:r,addEvents:s}of ce.tabs){t.find(`nav.sheet-navigation .item[data-tab=${r}]`).on("click",o=>Xi(o,t,this,r));let i=Ce(t,r);s(i.find("> .alternate"),this,n,t)}}a(Qi,"characterSheetActiveListeners");function Ce(e,t){return e.find(`section.sheet-body .sheet-content > .tab[data-tab=${t}]`)}a(Ce,"getCharacterSheetTab");function Xi(e,t,n,r){e.preventDefault();let s=Ce(t,r);s.hasClass("active")&&(s.toggleClass("toggled"),s.scrollTop(0),de(n,`${r}.toggled`,s.hasClass("toggled")))}a(Xi,"onCharacterSheetTabBtnToggle");var Pt=class extends FormApplication{static{a(this,"MoveLootPopup")}constructor(t,n,r){super(t,n),this.onSubmitCallback=r}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};var Re={};function ia(e,t){if(!e.key||game.user.id===t)return;let r=Re[e.key];r?.active&&r.listener(e,t)}a(ia,"onSocket");function ke(e,t){return Re[e]&&F.error(`a socket listener with the key '${e}' has already been registered`),Re[e]={listener:t,active:!1},{emit:n=>{n.key=e,pn(n)},activate:()=>{Re[e].active=!0},disable:()=>{Re[e].active=!1},toggle:n=>{Re[e].active=n??!Re[e].active}}}a(ke,"registerSocket");var Ot=!1,Xe=null,Je=ke("giveth",Ji);function la(){return{settings:[{key:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:oa}],conflicts:["pf2e-giveth"],ready:e=>{T("giveth")!=="disabled"&&oa(!0)}}}a(la,"registerGiveth");function oa(e){let t=game.user.isGM;e==="disabled"&&Ot?(t?Je.disable():Xe&&(Hooks.off("dropCanvasData",Xe),Xe=null),Ot=!1):e!=="disabled"&&!Ot&&(t?Je.activate():Xe||(Xe=dr("dropCanvasData",Zi)),Ot=!0)}a(oa,"setup");function Ji(e){e.type==="giveth-condition"?no(e):e.type==="giveth-effect"?ro(e):ao(e)}a(Ji,"onSocket");function Zi(e,t){if(!xr())return!0;let n=to(t);if(!n)return!0;let r=e.tokens.placeables.slice().filter(s=>{if(!s.document.actorLink)return!1;let i=s.actor;if(!ua(i,t.actorId)||i.isOwner)return!1;let o=s.x+(s.hitArea?.right??0),c=s.y+(s.hitArea?.bottom??0);return t.x>=s.x&&t.y>=s.y&&t.x<=o&&t.y<=c}).sort((s,i)=>i.document.sort-s.document.sort).at(0)?.actor;return r?(eo(n.actor,r,n.item,n.value),!1):!0}a(Zi,"onDropCanvasData");function eo(e,t,n,r){let s=e.id,i=t.id,o=!(n instanceof Item);if(!o&&n.isOfType("physical")){let c=n.quantity;if(c<1)return K("giveth.notification.zero");if(c===1)return ca(s,i,n.id,1,!1);new Pt(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,d)=>{ca(s,i,n.id,l,d)}).render(!0)}else{let c=o?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?Je.emit({type:"giveth-condition",targetId:i,value:r??1,uuid:c}):Je.emit({type:"giveth-effect",targetId:i,uuid:c})}}a(eo,"giveth");function ca(e,t,n,r,s){Je.emit({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:r,stack:s})}a(ca,"sendPhysicalRequest");function ua(e,t){return!le(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}a(ua,"isValidActor");function to(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let s=e.context?.origin.actor;n=s?fromUuidSync(s):null}if(!ua(n)||!n.isOwner)return;let r=!(t instanceof Item);if(r&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!r&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}a(to,"getDetailsFromData");async function no({targetId:e,uuid:t,value:n}){let r=game.actors.get(e);if(!r)return;let s=await fromUuid(t);s&&r.increaseCondition(s.slug,{min:n})}a(no,"takethCondition");async function ro({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let r=await fromUuid(t);if(!r)return;let s=r.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[s])}a(ro,"takethEffect");async function ao({itemId:e,ownerId:t,qty:n,stack:r,targetId:s}){let i=game.actors.get(t),o=game.actors.get(s);if(!i||!o)return;let c=i.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,d=c.toObject();d.system.quantity=n,d.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in d.system.equipped&&(d.system.equipped.invested=c.traits.has("invested")?!1:null);let u=await o.addToInventory(d,void 0,r);if(!u||(l<1?c.delete():c.update({"system.quantity":l}),T("giveth")==="no-message"))return;let p=xe(u.uuid,u.name,!u.isIdentified);n>1&&(p+=` x${n}`);let m=N("giveth.giveth",{target:o.name});ChatMessage.create({flavor:`<h4 class="action">${m}</h4>`,content:p,speaker:ChatMessage.getSpeaker({actor:i})})}a(ao,"takethPhysical");var _e=H("hero.templates.trade"),Mt=class extends Application{static{a(this,"Trade")}constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(Application.defaultOptions,{title:_e("title"),template:ue("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){_e.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:pe(this.actor),targetActions:this.target?pe(this.target):[],i18n:_e.template})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){_e.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){_e.warn("no-select");return}let r=un(this.target)??game.users.activeGM;if(!r){_e.warn("no-user");return}fa({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:r.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};var Rt="pf2e-hero-actions",Ze=ke("hero-action",co),da=G("renderCharacterSheetPF2e",lo,oo),so="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",Ft="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",io="systems/pf2e/icons/features/feats/heroic-recovery.webp";function pa(){return{name:"heroActions",settings:[{key:"hero",type:Boolean,default:!1,onChange:e=>da(e)},{key:"hero-table",type:String,default:""},{key:"hero-trade",type:Boolean,default:!1,onChange:()=>Ge()},{key:"hero-private",type:Boolean,default:!1}],conflicts:[Rt],api:{createTable:xo,removeHeroActions:Ao,getHeroActions:pe,useHeroAction:va,getHeroActionDetails:Lt,drawHeroAction:ya,drawHeroActions:ga,sendActionToChat:xa,discardHeroActions:ba,tradeHeroAction:ha,getDeckTable:Tn,giveHeroActions:Oo,createChatMessage:Ht},ready:()=>{da(!1,"hero")}}}a(pa,"registerHeroActions");function oo(e){Ze.toggle(e)}a(oo,"setupSocket");function co(e){switch(e.type){case"hero.trade-reject":if(e.sender.id!==game.user.id)return;Da(e);break;case"hero.trade-accept":if(!ht())return;ka(e);break;case"hero.trade-request":if(e.receiver.id!==game.user.id)return;wo(e);break;case"hero.trade-error":if(!e.users.includes(game.user.id))return;Ia(e.error);break}}a(co,"onSocket");async function lo(e,t){let n=e.actor;le(n)&&(await uo(t,n),fo(t,n))}a(lo,"renderCharacterSheetPF2e");async function uo(e,t){let n=pe(t),r=t.heroPoints.value-n.length,s=t.isOwner,i=H("hero.templates.heroActions"),o=await z("hero/sheet",{owner:s,list:n,canUse:r>=0&&s,canDraw:r>0&&s,canTrade:T("hero-trade"),mustDiscard:r<0,diff:Math.abs(r),i18n:i.template});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(o)}a(uo,"addActionsToSheet");function fo(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",r=>yo(t,r)),n.find("[data-action=expand]").on("click",ma),n.find("[data-action=use]").on("click",r=>ho(t,r)),n.find("[data-action=display]").on("click",r=>go(t,r)),n.find("[data-action=discard]").on("click",mo),n.find("[data-action=discard-selected]").on("click",()=>po(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>ha(t))}a(fo,"addSheetEvents");async function po(e,t){let r=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(s=>s.dataset.uuid);ba(e,r)}a(po,"onClickHeroActionsDiscard");function mo(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let r=Number(n.attr("data-discard")??"0"),s=n.find(".action.discarded");n.toggleClass("discardable",s.length===r)}a(mo,"onClickHeroActionDiscard");async function go(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");xa(e,n)}a(go,"onClickHeroActionDisplay");async function ho(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");va(e,n)}a(ho,"onClickHeroActionUse");async function yo(e,t){t.preventDefault(),ga(e)}a(yo,"onClickHeroActionsDraw");function pe(e){return getProperty(e,`flags.${Rt}.heroActions`)??[]}a(pe,"getHeroActions");async function Fe(e,t){return e.update({[`flags.${Rt}.heroActions`]:t})}a(Fe,"setHeroActions");async function ma(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let r=t.attr("data-uuid"),s=await Lt(r);if(!s)return;let i=await TextEditor.enrichHTML(s.description,{async:!0});n.find(".item-description").html(i),n.addClass("loaded")}t.toggleClass("expanded")}a(ma,"onClickHeroActionExpand");async function Lt(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,r=t instanceof JournalEntry?t.pages.contents[0]:t,s=r?.text.content;if(s)return n.uuid===so&&(s=s.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:r.name,description:s}}a(Lt,"getHeroActionDetails");async function ga(e){if(!e?.isOfType("character")){K("hero.onlyCharacter");return}let t=pe(e),n=e.heroPoints.value-t.length,r=[];for(let s=0;s<n;s++){let i=await ya();if(i!==void 0){if(i===null)return;t.push(i),r.push(i)}}r.length&&(Fe(e,t),Ht({actor:e,actions:r,label:s=>N("hero.actions-draw.header",{nb:s}),secret:!0}))}a(ga,"drawHeroActions");function Ht({actor:e,actions:t,label:n,secret:r=!1}){let{content:s,size:i}=vo(t);n=typeof n=="function"?n(i):n;let o={flavor:`<h4 class="action">${n}</h4>`,content:s,speaker:ChatMessage.getSpeaker({actor:e})};r&&T("hero-private")&&(o.type=CONST.CHAT_MESSAGE_TYPES.ROLL,o.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(o)}a(Ht,"createChatMessage");function vo(e){let t=e.map(({uuid:n,name:r})=>xe(n,r));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}a(vo,"chatActions");function ha(e){if(!e?.isOfType("character")){K("hero.onlyCharacter");return}let t=pe(e);if(!t||!t.length){K("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){K("hero.no-points",{nb:n.toString()});return}new Mt(e).render(!0)}a(ha,"tradeHeroAction");async function ya(){let e=await Tn(),t=H("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(i=>!i.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let r=Aa(n);if(r)return{uuid:r,name:await Sa(n,r)}}a(ya,"drawHeroAction");async function va(e,t){if(!e?.isOfType("character")){K("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return K("hero.use.noPoints");let r=pe(e),s=r.findIndex(o=>o.uuid===t);if(s===-1)return;let i=await Lt(t);i||we("hero.use.noDetails"),r.splice(s,1),i?(e.update({"system.resources.heroPoints.value":n-1,[`flags.${Rt}.heroActions`]:r}),ChatMessage.create({flavor:`<h4 class="action">${N("hero.actions-use.header")}</h4>`,content:`<h2>${i.name}</h2>${i.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):Fe(e,r)}a(va,"useHeroAction");async function ba(e,t){if(!e?.isOfType("character")){K("hero.onlyCharacter");return}let n=typeof t=="string"?[t]:t,r=pe(e),s=[];for(let i of n){let o=r.findIndex(c=>c.uuid===i);o!==-1&&(s.push(r[o]),r.splice(o,1))}Fe(e,r),Ht({actor:e,actions:s,label:i=>N("hero.actions-discard.header",{nb:i})})}a(ba,"discardHeroActions");async function Sa(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}a(Sa,"getLabelfromTableResult");async function wa(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}a(wa,"getTableFromUuid");async function bo(){return wa(Ft)}a(bo,"getDefaultCompendiumTable");function Ea(){return game.tables.find(e=>e.getFlag("core","sourceId")===Ft)}a(Ea,"getDefaultWorldTable");async function So(){return wa(T("hero-table"))}a(So,"getCustomTable");async function Tn(){return await So()??Ea()??await bo()}a(Tn,"getDeckTable");async function xa(e,t){let n=await Lt(t);if(!n)return we("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}a(xa,"sendActionToChat");function fa(e){if(e.receiver.id===game.user.id){Ca(e);return}Ze.emit({...e,type:"hero.trade-request"})}a(fa,"sendTradeRequest");function Ca(e){if(game.user.isGM){ka(e);return}Ze.emit({...e,type:"hero.trade-accept"})}a(Ca,"acceptRequest");async function ka(e){let{sender:t,receiver:n}=e,r=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!r||!s){Dn(e);return}let i=pe(r),o=pe(s),c=i.findIndex(y=>y.uuid===t.uuid),l=o.findIndex(y=>y.uuid===n.uuid);if(c===-1||l===-1){Dn(e);return}let d=i.splice(c,1)[0],u=o.splice(l,1)[0];i.push(u),o.push(d),Fe(r,i),Fe(s,o);let p=xe(d.uuid),m=xe(u.uuid),v=H("hero.trade-success"),g=`<div style="line-height: 1.6">${v("offer",{offer:p})}</div>`;g+=`<div style="line-height: 1.6">${v("receive",{receive:m})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${v("header",{name:s.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:r})})}a(ka,"onTradeAccepted");function Dn({sender:e,receiver:t},n="trade-error"){let r=new Set([e.id,t.id]);r.has(game.user.id)&&(r.delete(game.user.id),Ia(n)),r.size&&Ze.emit({type:"hero.trade-error",users:Array.from(r),error:n})}a(Dn,"sendTradeError");function Ia(e){we("hero.trade-error")}a(Ia,"onTradeError");async function wo(e){let{sender:t,receiver:n}=e,r=game.actors.get(t.cid),s=game.actors.get(n.cid);if(!r||!s){Dn(e);return}let i=H("hero.trade-request"),o=`<p>${i("header",{sender:r.name,receiver:s.name})}</p>`;o+=`<p>${i("give",{give:xe(t.uuid)})}</p>`,o+=`<p>${i("want",{want:xe(n.uuid)})}</p>`,o+=`<p style="margin-bottom: 1em;">${i("accept")}</p>`,await Dialog.confirm({title:i("title"),content:await TextEditor.enrichHTML(o,{async:!0})})?Ca(e):Eo(e)}a(wo,"onTradeRequest");function Eo(e){if(e.sender.id===game.user.id){Da(e);return}Ze.emit({...e,type:"hero.trade-reject"})}a(Eo,"rejectRequest");async function Da({receiver:e}){let t=game.actors.get(e.cid);K("hero.trade-rejected",{name:t.name},!0)}a(Da,"onTradeRejected");async function xo(){if(!game.user.isGM){K("hero.notGM");return}let e=H("hero.templates.createTable.choice"),t=ue("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:i=>{let o=i.find('.window-content input[name="type"]:checked').val(),c=i.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:o,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},r={content:await renderTemplate(t,{i18n:e.template}),title:e("title"),buttons:n,default:"yes",close:()=>null},s=await Dialog.wait(r,void 0,{id:"pf2e-hero-actions-create-table"});s&&(s.type==="default"?Io(s.unique):Co(s.unique))}a(xo,"createTable");async function Co(e){let t=await ko(e);await An(t),t.sheet?.render(!0)}a(Co,"createCustomTable");function ko(e=!0){let t=Pn(e);return RollTable.create(t,{temporary:!1})}a(ko,"createCustomActionsTable");async function Io(e){let t=H("templates.createTable.default.confirm"),n=await Ea();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let s=Pn(e);return await n.update(s),An(n,!0)}n=await Do(e),await An(n)}a(Io,"createDefaultTable");async function Do(e=!0){let t=await fromUuid(Ft),n=Pn(e,t);return RollTable.create(n,{temporary:!1})}a(Do,"createDefautActionsTable");async function An(e,t=!1){t&&await e.normalize(),await Sr("hero-table",e.uuid)}a(An,"setTable");function Pn(e,t){let n={name:N("hero.table.name"),replacement:!(e??!0),img:io,description:N("hero.table.description"),flags:{core:{sourceId:Ft}}};return t?mergeObject(deepClone(t._source),n):n}a(Pn,"getTableSource");async function Ao(){if(!game.user.isGM){K("hero.notGM");return}let e=H("hero.templates.removeActions"),t=ue("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:i=>i.find('input[name="actor"]:checked').toArray().map(o=>game.actors.get(o.value)).filter(o=>o)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},r={content:await renderTemplate(t,{actors:game.actors.filter(i=>i.type==="character"),i18n:e.template}),title:e("title"),buttons:n,default:"yes",render:i=>{i.on("change",'input[name="all"]',()=>To(i)),i.on("change",'input[name="actor"]',()=>Po(i))},close:()=>null},s=await Dialog.wait(r,void 0,{id:"pf2e-hero-actions-remove-actions"});if(s){if(!s.length){e.warn("noSelection");return}for(let i of s)Fe(i,[]);e.info("removed")}}a(Ao,"removeHeroActions");function To(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}a(To,"removeActionsToggleAll");function Po(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),r=e.find('input[name="all"]');t.length===n.length?(r.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?r.prop("checked",!1).prop("indeterminate",!0):(r.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}a(Po,"removeActionsToggleActor");function Aa(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}a(Aa,"documentUuidFromTableResult");async function Oo(e){if(!game.user.isGM){K("hero.notGM");return}let t=H("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await Tn();if(!n)return we("hero.table.drawError",!0),null;let r=n.replacement===!1,s=(await Promise.all(n.results.map(async y=>{let w=Aa(y);if(w)return{key:y.id,uuid:w,name:await Sa(y,w),drawn:y.drawn}}))).filter(Boolean),i=ue("hero/dialogs/give-action"),o=await renderTemplate(i,{actions:s,isUnique:r,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:y=>({selected:y.find("[name=action]:checked").closest(".action").toArray().map(w=>w.dataset),asDrawn:y.find("[name=drawn]").prop("checked")??!1,withMessage:y.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:o,buttons:c,render:y=>{y.find("[data-action=expand]").on("click",ma)},close:()=>null},d=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!d)return;let{selected:u,asDrawn:p,withMessage:m}=d,v=pe(e),g=[];for(let{uuid:y,name:w,key:E}of u){if(v.push({uuid:y,name:w}),!p)continue;let x=n.results.get(E);x&&!x.drawn&&g.push(E)}g.length&&await n.updateEmbeddedDocuments("TableResult",g.map(y=>({_id:y,drawn:!0}))),Fe(e,v),m&&Ht({actor:e,actions:u,label:y=>N("hero.actions-give.header",{nb:y}),secret:!0})}a(Oo,"giveHeroActions");var A=null,Mo=0;function Ta(e,t){for(let[n,r]of Object.entries(t))for(let s of r){let i=e[s];!i||typeof i===n||(e[i]=void 0)}}a(Ta,"cleanOptions");function Pa(e){if(e.element instanceof HTMLElement){Ta(e,{string:["draggedClass","group","selector","filter","identifier"],number:["triggerDistance"],boolean:["cancelOnRightClick"],function:["onCancel","onDragEnd","onDragStart"]}),e.triggerDistance??=6,e.cancelOnRightClick??=!0,e.cursorImage??={},e.cursorImage.id=typeof e.cursorImage.id=="string"?e.cursorImage.id:"",e.cursorImage.img=typeof e.cursorImage.img=="function"?e.cursorImage.img:void 0,e.droppables??=[];for(let t=e.droppables.length-1;t>=0;t--){let n=e.droppables[t];if(!(n.element instanceof HTMLElement)){e.droppables.splice(t,1);continue}Ta(n,{string:["selector","overClass","filter"],boolean:["purgeOnLeave"],function:["onDragEnter","onDragLeave","onDragOver","onDrop"]})}e.element.addEventListener("mousedown",t=>Fo(t,e))}}a(Pa,"makeDraggable");async function Ro(e){A&&(A.canceled=!0,A.dragging&&A.draggable.ghost&&A.draggable.ghost.reset(),A.dragging&&A.options.onCancel&&await A.options.onCancel(e,A.draggable),Ma(),await Oa(e))}a(Ro,"onDragCancel");async function Oa(e){A&&(A.dragging&&A.options.onDragEnd&&await A.options.onDragEnd(e,A.draggable,{canceled:A.canceled,dropped:A.dropped}),window.removeEventListener("mousemove",Ra),window.removeEventListener("mouseup",Fa),A=null)}a(Oa,"onDragEnd");function Ma(){if(A){A.draggable.classList.purge(),A.draggable.ghost?.classList.purge(),A.cursorElement?.remove();for(let{classList:e}of Object.values(A.hovered))e.purge()}}a(Ma,"cleanUp");function Fo(e,t){if(e.button===2&&A?.dragging&&A.options.cancelOnRightClick){Ro(e);return}if(e.button)return;let n=et(e.target,t.element,t);if(!n)return;let r,s=dt(n),i=n.parentElement,o=On(n);A={canceled:!1,dragging:!1,dropped:!1,options:t,group:t.group,draggable:{identifier:t.identifier,element:n,triggeringElement:e.target,x:e.clientX,y:e.clientY,parent:i,index:s,classList:o,get ghost(){if(r)return t.ghostClass&&r.classList.add(t.ghostClass),r;let{element:c=n.cloneNode(!0),index:l=1/0}=t.createGhost?.(n,s)??{},d=On(c);return t.draggedClass&&c!==n&&c.classList.remove(t.draggedClass),t.ghostClass&&d.add(t.ghostClass),r={element:c,classList:d,index:l,reset:()=>{if(c.remove(),c===n){let u=i.children[s];i.insertBefore(n,u),r.index=s,t.ghostClass&&d.remove(t.ghostClass)}else r.index=1/0}},r},resetPosition:()=>{n.remove(),i.children[s].before(n)}},droppables:t.droppables.map(c=>({...c,id:Mo++})),hovered:{}},window.addEventListener("mousemove",Ra),window.addEventListener("mouseup",Fa)}a(Fo,"onMouseDown");async function Ra(e){if(!A)return;if(A.dragging){Ho(e);return}let{clientX:t,clientY:n}=e,{draggable:r}=A;ur(r.x,r.y,t,n)>A.options.triggerDistance&&await Lo(e)}a(Ra,"onMouseMove");async function Fa(e){if(!(e.button||!A)){if(A.dragging){let t=!1;Ma(),await Promise.all(Object.values(A.hovered).map(async n=>{if(!n.droppable.onDrop)return;await n.droppable.onDrop(e,A.draggable,{classList:n.classList,element:n.element,triggeringElement:n.triggeringElement})&&(t=!0)})),A.dropped=t}await Oa(e)}}a(Fa,"onMouseUp");async function Lo(e){if(!A.dragging){if(A.dragging=!0,A.options.cursorImage.img){let t=A.options.cursorImage.img(A.draggable.element);t instanceof HTMLElement?A.cursorElement=t:(A.cursorElement=new Image,A.cursorElement.src=typeof t=="string"?t:"")}else A.cursorElement=A.draggable.element.cloneNode(!0);A.cursorElement.id=A.options.cursorImage.id,A.options.draggedClass&&A.draggable.classList.add(A.options.draggedClass),document.body.appendChild(A.cursorElement),await A.options.onDragStart?.(e,A.draggable)}}a(Lo,"onDragStart");async function Ho(e){if(!A)return;let{clientX:t,clientY:n}=e,r=A.cursorElement,s=r.offsetWidth/2,i=r.offsetHeight/2;r.style.left=`${t-s}px`,r.style.top=`${n-i}px`,await Promise.all(A.droppables.map(async o=>{let c=et(e.target,o.element,{selector:o.selector,filter:o.filter}),l=A.hovered[o.id];if(l&&(!c||l.element!==c)&&await o.onDragLeave?.(e,A.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target})!==!1&&(delete A.hovered[o.id],o.purgeOnLeave?l.classList.purge():o.overClass&&l.classList.remove(o.overClass)),!!c)if(l)o.onDragOver&&await o.onDragOver(e,A.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target});else{let d=On(c);await o.onDragEnter?.(e,A.draggable,{classList:d,element:c,triggeringElement:e.target})!==!1&&(o.overClass&&d.add(o.overClass),A.hovered[o.id]={id:o.id,classList:d,droppable:o,element:c,triggeringElement:e.target})}}))}a(Ho,"onDragMove");function On(e){return new class extends Set{add(t){e.classList.add(t),super.add(t)}remove(t){e.classList.remove(t),super.delete(t)}toggle(t,n){n??!e.classList.contains(t)?this.add(t):this.remove(t)}contains(t){return this.has(t)}purge(){e.classList.remove(...this)}}}a(On,"newClassList");function et(e,t,{selector:n,filter:r}={}){if(!t.contains(e))return;if(!n&&!r)return t;let s,i=e;for(;;){if(r&&i.matches(r))return;if(!s&&n&&i.matches(n)&&(s=i),i===t)break;i=i.parentElement}return n?s:t}a(et,"closestInside");var Uo=G("closeCharacterSheetPF2e",No),Rn=!1;function Ha(){return{settings:[{key:"inventory",type:Boolean,default:!1,scope:"client",onChange:e=>La(e)}],ready:e=>{La()}}}a(Ha,"registerInventory");var Mn,$o=["platinum-pieces","gold-pieces","silver-pieces","copper-pieces"];function La(e){let t=e??T("inventory");t?At({tabName:"inventory",templateFolder:"inventory/sheet",getData:qo,addEvents:jo,onRender:_o}):Tt("inventory"),Uo(t)}a(La,"setup");function No(e,t){let n=e.actor;if(!le(n)||!fe(e,"inventory.requireSave"))return;let r=Ce(t,"inventory")[0],s=Ua(r);s&&ae(n,"inventory",s)}a(No,"closeCharacterSheetPF2e");function _o(e,t,n){let r=n.find("> aside");r.css("position","relative"),r.append("<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>")}a(_o,"onRender");function Ua(e){if(!e)return;let t=e.querySelector(":scope > .alternate"),n=t.querySelector("[data-area='equipped']"),r=a(o=>n.querySelector(`[data-equipped-slot='${o}']`).querySelector("[data-item-id]")?.dataset.itemId??null,"equippedItemId"),s=a(o=>{let c={},l=o.querySelectorAll(":scope > [data-item-id]");for(let d=0;d<l.length;d++){let u=l[d];c[u.dataset.itemId]=d}return c},"itemIds"),i={};for(let o of t.querySelectorAll("[data-area='items-grid']")){let c=o.dataset.tabId;i[c]=s(o)}return{equipped:{hands:[r("left-hand"),r("right-hand")],armor:[r("armor")],others:s(n)},tabs:i}}a(Ua,"getCurrentData");async function qo(e,t,n){let r=P(e,"inventory"),s=Ua(n[0])??r??{equipped:{hands:[null,null],armor:[null],others:{}},tabs:{}};r||de(t,"inventory.requireSave",!0);let i=new Collection,o={},c=new Set,l={hands:[null,null],armor:[null],others:[]};function d(p){let m=p?.id,v=i.get(m);return v||(v={id:m,item:p,parent:p?.container,containers:[],matrix:[],parents:[]},i.set(m,v),v)}a(d,"getTab");for(let p of e.inventory){if(p.isOfType("treasure")&&p.system.stackGroup==="coins"&&$o.includes(p.slug))continue;let m=p.id,v=p.container,g=d(v),y=a(C=>{o[g.id]??=[],o[g.id].push(C)},"addOrphan");if(p.isOfType("backpack")){g.containers.push(p),c.add(p),d(p);continue}let w=p.handsHeld,E=l.hands.filter(Boolean).length;if(w===2&&E===0){s.equipped.hands[0]===m?l.hands=[p,p]:y(p);continue}if(w===1&&E<=1){let C=s.equipped.hands.indexOf(m);ft(C)?l.hands[C]=p:y(p);continue}if(!l.armor[0]&&p.isOfType("armor")&&p.isEquipped){s.equipped.armor[0]===m?l.armor[0]=p:y(p);continue}if((p.isOfType("equipment")||Ct(p))&&En(p)){let C=s.equipped.others[m];ft(C)?l.others[C]=p:y(p);continue}let x=s.tabs[g.id]?.[m];if(ft(x)){g.matrix[x]=p;continue}y(p)}for(let p of i){let m=o[p.id];if(m){for(let v of m){let g=v.handsHeld,y=l.hands.filter(Boolean).length;if(y===0&&g===2){l.hands=[v,v];continue}if(y<=1&&g===1){let w=l.hands[0]?1:0;l.hands[w]=v;continue}if(!l.armor[0]&&v.isOfType("armor")&&v.isEquipped){l.armor[0]=v;continue}if((v.isOfType("equipment")||Ct(v))&&En(v)){l.others.push(v);continue}p.matrix.push(v)}p.matrix=p.matrix.filter(Boolean)}}for(let p of i){let m=p.parent;for(;m;)p.parents.push(m),m=m.container;p.parents.reverse();let v=[p.containers,p.parents,p.item].flat();p.trailings=c.filter(g=>!v.includes(g))}i.size||d(void 0),l.others=l.others.filter(Boolean);let u=fe(t,"inventory.activeTab");return{tabs:Array.from(i.values()),equipped:l,actor:e,selectedTab:i.get(u)?.id,containerBulk:p=>{let m=p.capacity;return`${m.value.toString()} / ${m.max.toString()}`}}}a(qo,"getData");function jo(e,t,n,r){let s=e.find("[data-tab-id]");for(let c of e.find("[data-container-id]"))c.addEventListener("click",l=>{let d=c.dataset.containerId;s.removeClass("active"),s.filter(`[data-tab-id=${d}]`).addClass("active"),de(t,"inventory.activeTab",d)});let i=r.find("#pf2e-toobelt-inventory-item-details")[0],o=e.find("[data-item-id], [data-container-id]");for(let c of o)c.addEventListener("mouseenter",l=>Bo(l,n,c,i)),c.addEventListener("mouseleave",l=>{i.classList.add("hidden")});n.isOwner&&(Mn=randomID(),Pa({element:e[0],selector:"[data-item-id]",filter:"input",draggedClass:"dragged",ghostClass:"ghost",identifier:Mn,cursorImage:{id:"pf2e-toolbelt-inventory-cursor-image",img:c=>c.dataset.itemImg},createGhost:Vo,onDragStart:()=>zo(i),onDragEnd:(c,l,d)=>Go(t,d),droppables:[Xo(e,t),Qo(e,t),Ko(e,t),Yo(e,t),Wo(e,t)]}))}a(jo,"addEvents");async function Bo(e,t,n,r){if(Rn)return;let s=n.dataset.details;if(!s){let i=He(t,n);if(!i)return;s=await z("inventory/details",{item:i}),n.dataset.details=s}r.innerHTML=s,r.classList.remove("hidden")}a(Bo,"onItemDetails");function zo(e){Rn=!0,e.classList.add("hidden")}a(zo,"onDragStart");function Go(e,{dropped:t,canceled:n}){Rn=!1,!(n||!t)&&de(e,"inventory.requireSave",!0)}a(Go,"onDragEnd");function Vo(e,t){return e.parentElement.dataset.area==="items-grid"?{element:e,index:t}:void 0}a(Vo,"createGhost");function Ut(e){return e.identifier===Mn?!0:(we("inventory.identifier.error"),!1)}a(Ut,"checkIdentifier");function Wo(e,t){function n(s,i,o){if(o.element===i.element||o.element===i.ghost)return;let c=i.ghost,l=dt(o.element),d=c.index>=l?o.element:o.element.nextElementSibling;o.element.parentElement.insertBefore(c.element,d),c.index=l}a(n,"onDragEnter");function r(s,i,o){let c=o.element.parentElement;!c||et(o.triggeringElement,c,{selector:"[data-item-id]"})||!c.parentElement.contains(o.triggeringElement)||(c.appendChild(i.ghost.element),i.ghost.index=1/0)}return a(r,"onDragLeave"),{element:e[0],selector:"[data-area='items-grid'] [data-item-id]",onDragEnter:n,onDragLeave:r}}a(Wo,"itemsGridDroppable");function Yo(e,t){let n=t.actor;function r(o,c,l){et(l.triggeringElement,l.element,{selector:"[data-item-id]"})||l.element.querySelector("[data-area='items-grid']").appendChild(c.ghost.element)}a(r,"onDragEnter");function s(o,c,l){c.ghost.reset()}a(s,"onDragLeave");async function i(o,c,l){if(!Ut(c))return!1;let d=He(n,c);if(!d)return!1;let u=[];return c.element===c.ghost.element?(c.ghost.classList.purge(),$a(c.element)):(Le({html:e,updates:u,item:d,...c,target:c.ghost.element}),Fn(e,n),c.ghost.reset()),await n.updateEmbeddedDocuments("Item",u),!0}return a(i,"onDrop"),{element:e[0],selector:"[data-area='items-list']",onDragEnter:r,onDragLeave:s,onDrop:i}}a(Yo,"itemsListDroppable");function Ko(e,t){let n=t.actor,r=e.find("[data-equipped-slot=right-hand]")[0];function s(d,u){let p=u.element.dataset.equippedSlot;if(p===d.parent.dataset.equippedSlot||u.element.querySelector("[data-two-hands]"))return{canDrop:void 0};let m=He(n,d);if(!m)return{canDrop:!1};let v=p==="armor"?m.isOfType("armor"):!0;return{item:m,slot:p,canDrop:v}}a(s,"getData");function i({updates:d,item:u,element:p,drop:m,noTwoHand:v=!1,noUpdate:g=!1}){let y=m instanceof HTMLElement?m:m.element,w=y.dataset.equippedSlot,E=p instanceof HTMLElement?p:p.element,x=jr(u),C=Et(u),M=wn(u);y.appendChild(E);let L=a((q,ne,Q,j)=>{g||d.push(xt(u,{carryType:q,handsHeld:ne,inSlot:Q,invested:j,containerId:null})),E.classList.toggle("invested",M&&j)},"move");if(w==="armor"){L("worn",0,!0,!0);return}if(w==="right-hand"){L("held",1,!1,x);return}L("held",C&&!v?2:1,!1,wt(u)&&(!C||!v))}a(i,"moveItemToSlot");function o(d){let p=(d instanceof HTMLElement?d:d.element).querySelector("[data-item-id]"),m=He(n,p);return{element:p,item:m}}a(o,"getSlottedItem");function c(d,u,p){let{canDrop:m}=s(u,p);m!==void 0&&(p.classList.toggle("valid",m),p.classList.toggle("invalid",!m))}a(c,"onDragEnter");async function l(d,u,p){if(!Ut(u))return!1;let{item:m,canDrop:v,slot:g}=s(u,p);if(!v)return!1;let y=[],w=o(p),E=u.parent.dataset.area,x=u.parent.dataset.equippedSlot,C=Et(m),M=!1;if(E==="equipped")w.item&&Le({html:e,updates:y,...w});else if(E==="items-grid"){if(g==="left-hand"&&C){let L=o(r);L.item&&Le({html:e,updates:y,...L})}w.item&&Le({html:e,updates:y,...w,target:u.element})}else g==="armor"?w.item&&i({updates:y,...w,drop:u.parent}):x==="armor"?w.item&&(w.item.isOfType("armor")?i({updates:y,...w,drop:u.parent}):Le({html:e,updates:y,...w})):g==="right-hand"?(M=!0,w.item&&i({updates:y,...w,drop:u.parent,noUpdate:!0,noTwoHand:!0})):w.item&&(C?Le({html:e,updates:y,...w}):(i({updates:y,...w,drop:u.parent,noUpdate:!0}),M=!0));return i({updates:y,item:m,element:u,drop:p,noUpdate:M}),(g==="left-hand"||x==="left-hand")&&Fn(e,n),await n.updateEmbeddedDocuments("Item",y),!0}return a(l,"onDrop"),{element:e.find("[data-area=equipped] .main-items")[0],selector:"[data-equipped-slot]",purgeOnLeave:!0,onDragEnter:c,onDrop:l}}a(Ko,"largeEquipmentDroppable");function Qo(e,t){let n=t.actor;function r(o,c){if(o.parent===c.element)return{canDrop:void 0};let l=He(n,o);if(!l.isIdentified||!(l.isOfType("equipment")||Ct(l)))return{canDrop:!1};let d=wn(l),u=qr(l);return!d&&!u?{canDrop:!1}:{canDrop:!0,item:l,canInvest:d}}a(r,"getData");function s(o,c,l){let{canDrop:d,canInvest:u}=r(c,l);d!==void 0&&(l.classList.add("show"),l.classList.toggle("add-forbidden",!d),l.classList.toggle("add-invest",d&&u),l.classList.toggle("add-equip",d&&!u))}a(s,"onDragEnter");async function i(o,c,l){if(!Ut(c))return!1;let{canDrop:d,canInvest:u,item:p}=r(c,l);return d?(l.element.appendChild(c.element),c.element.classList.toggle("invested",u),await n.updateEmbeddedDocuments("Item",[xt(p,{containerId:null,inSlot:!0,invested:!0})]),!0):!1}return a(i,"onDrop"),{element:e.find("[data-area=equipped]")[0],filter:".main-items",purgeOnLeave:!0,onDragEnter:s,onDrop:i}}a(Qo,"otherEquipmentDroppable");function Xo(e,t){let n=t.actor;function r(o,c){let l=He(n,o);if(!l)return{canDrop:!1};let d=c.element.dataset.containerId;if(d==="undefined")return{item:l,canDrop:!0};let u=n.items.get(d);if(!u)return{canDrop:!1};let p=u.capacity,m=p.max.minus(p.value);return{item:l,container:u,canDrop:m.value>=l.bulk.value}}a(r,"getData");function s(o,c,l){let{canDrop:d}=r(c,l);l.classList.toggle("valid",d),l.classList.toggle("invalid",!d)}a(s,"onDragEnter");async function i(o,c,l){if(!Ut(c))return!1;let{canDrop:d,item:u,container:p}=r(c,l);if(!d)return!1;let m=Le({html:e,updates:[],item:u,element:c,target:p});return c.parent.dataset.equippedSlot==="left-hand"&&Fn(e,n),await n.updateEmbeddedDocuments("Item",m),!0}return a(i,"onDrop"),{element:e[0],selector:"[data-container-id]",filter:".back",purgeOnLeave:!0,onDragEnter:s,onDrop:i}}a(Xo,"containersDroppable");function $a(e){e.classList.remove("invested"),e.querySelector(".vignette.hands")?.remove()}a($a,"cleanContainerItem");function Le({html:e,updates:t,item:n,element:r,target:s}){let i=s instanceof HTMLElement,o=r instanceof HTMLElement?r:r.element,c=i?s.closest("[data-tab-id]").dataset.tabId:s instanceof Item?s.id:s;return $a(o),i?s.before(o):e.find(`.container-tab[data-tab-id=${c}] [data-area=items-grid]`).append(o),c=[void 0,"undefined"].includes(c)?null:c,t.push(xt(n,{containerId:c,inSlot:!1,invested:!1,carryType:c?"stowed":"worn",handsHeld:0})),t}a(Le,"moveItemToContainer");function Fn(e,t){let n=e.find("[data-area='equipped'] .main-items")[0],r=n.querySelector("[data-equipped-slot='left-hand']"),s=n.querySelector("[data-equipped-slot='right-hand']"),i=r.querySelector("[data-item-id]"),o=s.querySelector(".item:not(.fake)"),c=He(t,i),l=!!c&&Et(c);if(!l&&o?.dataset.twoHands)o.remove();else if(l&&!o){let d=i.cloneNode(!0);d.dataset.twoHands="true",s.appendChild(d)}}a(Fn,"checkForTwoHandedSlots");function He(e,t){if(!t)return;let n=t instanceof HTMLElement?t:t.element,{itemId:r,containerId:s}=n.dataset,i=r??s;if(i)return e.items.get(i)}a(He,"getItemFromElement");var Na=H("knowledges.editLore"),$t=class extends FormApplication{static{a(this,"EditLores")}get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Na("title",this.actor)}get template(){return ue("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:P(n,"knowledges.unspecified")??"",specific:P(n,"knowledges.specific")??"",i18n:Na.template})}async _updateObject(t,{unspecified:n,specific:r}){let s=this.object;ae(s,"knowledges.unspecified",n.trim()),ae(s,"knowledges.specific",r.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};var _a=G("renderNPCSheetPF2e",Jo);function qa(){return{settings:[{key:"knowledges",type:Boolean,default:!1,onChange:e=>_a(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&T("knowledges")&&_a(!0)}}}a(qa,"registerKnowledges");function Jo(e,t){let n=e.actor;le(n)&&(ec(n,t),nc(t),tc(n,t))}a(Jo,"renderNPCSheetPF2e");function Ln(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}a(Ln,"knowledgeSelector");function Zo(e){new $t(e).render(!0)}a(Zo,"editLores");function ec(e,t){let n=P(e,"knowledges.unspecified"),r=P(e,"knowledges.specific");if(!n&&!r)return;let s=e.identificationDCs.lore,i=Ln(t,"body","");i.find(".identification-skills").last().remove();function o(l,d,u){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:d,adjustment:u})}</div>`}a(o,"tag");function c(l,{dc:d,start:u}){let p=l.split(",").filter(m=>m.trim()).map(m=>o(m,d,u)).join("");i.append(p)}a(c,"addTags"),c(n||"Unspecific",s[0]),c(r||"Specific",s[1])}a(ec,"replaceLores");function tc(e,t){Ln(t,"header","button.edit").on("click",()=>Zo(e))}a(tc,"addEvents");function nc(e){let t=Ln(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}a(nc,"addEditButton");var De;(function(e){e.Range="range",e.Steps="steps",e.Positions="positions",e.Count="count",e.Values="values"})(De||(De={}));var ie;(function(e){e[e.None=-1]="None",e[e.NoValue=0]="NoValue",e[e.LargeValue=1]="LargeValue",e[e.SmallValue=2]="SmallValue"})(ie||(ie={}));function rc(e){return _t(e)&&typeof e.from=="function"}a(rc,"isValidFormatter");function _t(e){return typeof e=="object"&&typeof e.to=="function"}a(_t,"isValidPartialFormatter");function ja(e){e.parentElement.removeChild(e)}a(ja,"removeElement");function Hn(e){return e!=null}a(Hn,"isSet");function Ba(e){e.preventDefault()}a(Ba,"preventDefault");function ac(e){return e.filter(function(t){return this[t]?!1:this[t]=!0},{})}a(ac,"unique");function sc(e,t){return Math.round(e/t)*t}a(sc,"closest");function ic(e,t){var n=e.getBoundingClientRect(),r=e.ownerDocument,s=r.documentElement,i=Wa(r);return/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)&&(i.x=0),t?n.top+i.y-s.clientTop:n.left+i.x-s.clientLeft}a(ic,"offset");function ye(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}a(ye,"isNumeric");function za(e,t,n){n>0&&(se(e,t),setTimeout(function(){Nt(e,t)},n))}a(za,"addClassFor");function Ga(e){return Math.max(Math.min(e,100),0)}a(Ga,"limit");function qt(e){return Array.isArray(e)?e:[e]}a(qt,"asArray");function oc(e){e=String(e);var t=e.split(".");return t.length>1?t[1].length:0}a(oc,"countDecimals");function se(e,t){e.classList&&!/\s/.test(t)?e.classList.add(t):e.className+=" "+t}a(se,"addClass");function Nt(e,t){e.classList&&!/\s/.test(t)?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")}a(Nt,"removeClass");function cc(e,t){return e.classList?e.classList.contains(t):new RegExp("\\b"+t+"\\b").test(e.className)}a(cc,"hasClass");function Wa(e){var t=window.pageXOffset!==void 0,n=(e.compatMode||"")==="CSS1Compat",r=t?window.pageXOffset:n?e.documentElement.scrollLeft:e.body.scrollLeft,s=t?window.pageYOffset:n?e.documentElement.scrollTop:e.body.scrollTop;return{x:r,y:s}}a(Wa,"getPageOffset");function lc(){return window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"}}a(lc,"getActions");function uc(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,t)}catch{}return e}a(uc,"getSupportsPassive");function fc(){return window.CSS&&CSS.supports&&CSS.supports("touch-action","none")}a(fc,"getSupportsTouchActionNone");function $n(e,t){return 100/(t-e)}a($n,"subRangeRatio");function Un(e,t,n){return t*100/(e[n+1]-e[n])}a(Un,"fromPercentage");function dc(e,t){return Un(e,e[0]<0?t+Math.abs(e[0]):t-e[0],0)}a(dc,"toPercentage");function pc(e,t){return t*(e[1]-e[0])/100+e[0]}a(pc,"isPercentage");function tt(e,t){for(var n=1;e>=t[n];)n+=1;return n}a(tt,"getJ");function mc(e,t,n){if(n>=e.slice(-1)[0])return 100;var r=tt(n,e),s=e[r-1],i=e[r],o=t[r-1],c=t[r];return o+dc([s,i],n)/$n(o,c)}a(mc,"toStepping");function gc(e,t,n){if(n>=100)return e.slice(-1)[0];var r=tt(n,t),s=e[r-1],i=e[r],o=t[r-1],c=t[r];return pc([s,i],(n-o)*$n(o,c))}a(gc,"fromStepping");function hc(e,t,n,r){if(r===100)return r;var s=tt(r,e),i=e[s-1],o=e[s];return n?r-i>(o-i)/2?o:i:t[s-1]?e[s-1]+sc(r-e[s-1],t[s-1]):r}a(hc,"getStep");var Ya=function(){function e(t,n,r){this.xPct=[],this.xVal=[],this.xSteps=[],this.xNumSteps=[],this.xHighestCompleteStep=[],this.xSteps=[r||!1],this.xNumSteps=[!1],this.snap=n;var s,i=[];for(Object.keys(t).forEach(function(o){i.push([qt(t[o]),o])}),i.sort(function(o,c){return o[0][0]-c[0][0]}),s=0;s<i.length;s++)this.handleEntryPoint(i[s][1],i[s][0]);for(this.xNumSteps=this.xSteps.slice(0),s=0;s<this.xNumSteps.length;s++)this.handleStepPoint(s,this.xNumSteps[s])}return a(e,"Spectrum"),e.prototype.getDistance=function(t){for(var n=[],r=0;r<this.xNumSteps.length-1;r++)n[r]=Un(this.xVal,t,r);return n},e.prototype.getAbsoluteDistance=function(t,n,r){var s=0;if(t<this.xPct[this.xPct.length-1])for(;t>this.xPct[s+1];)s++;else t===this.xPct[this.xPct.length-1]&&(s=this.xPct.length-2);!r&&t===this.xPct[s+1]&&s++,n===null&&(n=[]);var i,o=1,c=n[s],l=0,d=0,u=0,p=0;for(r?i=(t-this.xPct[s])/(this.xPct[s+1]-this.xPct[s]):i=(this.xPct[s+1]-t)/(this.xPct[s+1]-this.xPct[s]);c>0;)l=this.xPct[s+1+p]-this.xPct[s+p],n[s+p]*o+100-i*100>100?(d=l*i,o=(c-100*i)/n[s+p],i=1):(d=n[s+p]*l/100*o,o=0),r?(u=u-d,this.xPct.length+p>=1&&p--):(u=u+d,this.xPct.length-p>=1&&p++),c=n[s+p]*o;return t+u},e.prototype.toStepping=function(t){return t=mc(this.xVal,this.xPct,t),t},e.prototype.fromStepping=function(t){return gc(this.xVal,this.xPct,t)},e.prototype.getStep=function(t){return t=hc(this.xPct,this.xSteps,this.snap,t),t},e.prototype.getDefaultStep=function(t,n,r){var s=tt(t,this.xPct);return(t===100||n&&t===this.xPct[s-1])&&(s=Math.max(s-1,1)),(this.xVal[s]-this.xVal[s-1])/r},e.prototype.getNearbySteps=function(t){var n=tt(t,this.xPct);return{stepBefore:{startValue:this.xVal[n-2],step:this.xNumSteps[n-2],highestStep:this.xHighestCompleteStep[n-2]},thisStep:{startValue:this.xVal[n-1],step:this.xNumSteps[n-1],highestStep:this.xHighestCompleteStep[n-1]},stepAfter:{startValue:this.xVal[n],step:this.xNumSteps[n],highestStep:this.xHighestCompleteStep[n]}}},e.prototype.countStepDecimals=function(){var t=this.xNumSteps.map(oc);return Math.max.apply(null,t)},e.prototype.hasNoSize=function(){return this.xVal[0]===this.xVal[this.xVal.length-1]},e.prototype.convert=function(t){return this.getStep(this.toStepping(t))},e.prototype.handleEntryPoint=function(t,n){var r;if(t==="min"?r=0:t==="max"?r=100:r=parseFloat(t),!ye(r)||!ye(n[0]))throw new Error("noUiSlider: 'range' value isn't numeric.");this.xPct.push(r),this.xVal.push(n[0]);var s=Number(n[1]);r?this.xSteps.push(isNaN(s)?!1:s):isNaN(s)||(this.xSteps[0]=s),this.xHighestCompleteStep.push(0)},e.prototype.handleStepPoint=function(t,n){if(n){if(this.xVal[t]===this.xVal[t+1]){this.xSteps[t]=this.xHighestCompleteStep[t]=this.xVal[t];return}this.xSteps[t]=Un([this.xVal[t],this.xVal[t+1]],n,0)/$n(this.xPct[t],this.xPct[t+1]);var r=(this.xVal[t+1]-this.xVal[t])/this.xNumSteps[t],s=Math.ceil(Number(r.toFixed(3))-1),i=this.xVal[t]+this.xNumSteps[t]*s;this.xHighestCompleteStep[t]=i}},e}(),Va={to:function(e){return e===void 0?"":e.toFixed(2)},from:Number},Ka={target:"target",base:"base",origin:"origin",handle:"handle",handleLower:"handle-lower",handleUpper:"handle-upper",touchArea:"touch-area",horizontal:"horizontal",vertical:"vertical",background:"background",connect:"connect",connects:"connects",ltr:"ltr",rtl:"rtl",textDirectionLtr:"txt-dir-ltr",textDirectionRtl:"txt-dir-rtl",draggable:"draggable",drag:"state-drag",tap:"state-tap",active:"active",tooltip:"tooltip",pips:"pips",pipsHorizontal:"pips-horizontal",pipsVertical:"pips-vertical",marker:"marker",markerHorizontal:"marker-horizontal",markerVertical:"marker-vertical",markerNormal:"marker-normal",markerLarge:"marker-large",markerSub:"marker-sub",value:"value",valueHorizontal:"value-horizontal",valueVertical:"value-vertical",valueNormal:"value-normal",valueLarge:"value-large",valueSub:"value-sub"},Ie={tooltips:".__tooltips",aria:".__aria"};function yc(e,t){if(!ye(t))throw new Error("noUiSlider: 'step' is not numeric.");e.singleStep=t}a(yc,"testStep");function vc(e,t){if(!ye(t))throw new Error("noUiSlider: 'keyboardPageMultiplier' is not numeric.");e.keyboardPageMultiplier=t}a(vc,"testKeyboardPageMultiplier");function bc(e,t){if(!ye(t))throw new Error("noUiSlider: 'keyboardMultiplier' is not numeric.");e.keyboardMultiplier=t}a(bc,"testKeyboardMultiplier");function Sc(e,t){if(!ye(t))throw new Error("noUiSlider: 'keyboardDefaultStep' is not numeric.");e.keyboardDefaultStep=t}a(Sc,"testKeyboardDefaultStep");function wc(e,t){if(typeof t!="object"||Array.isArray(t))throw new Error("noUiSlider: 'range' is not an object.");if(t.min===void 0||t.max===void 0)throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");e.spectrum=new Ya(t,e.snap||!1,e.singleStep)}a(wc,"testRange");function Ec(e,t){if(t=qt(t),!Array.isArray(t)||!t.length)throw new Error("noUiSlider: 'start' option is incorrect.");e.handles=t.length,e.start=t}a(Ec,"testStart");function xc(e,t){if(typeof t!="boolean")throw new Error("noUiSlider: 'snap' option must be a boolean.");e.snap=t}a(xc,"testSnap");function Cc(e,t){if(typeof t!="boolean")throw new Error("noUiSlider: 'animate' option must be a boolean.");e.animate=t}a(Cc,"testAnimate");function kc(e,t){if(typeof t!="number")throw new Error("noUiSlider: 'animationDuration' option must be a number.");e.animationDuration=t}a(kc,"testAnimationDuration");function Ic(e,t){var n=[!1],r;if(t==="lower"?t=[!0,!1]:t==="upper"&&(t=[!1,!0]),t===!0||t===!1){for(r=1;r<e.handles;r++)n.push(t);n.push(!1)}else{if(!Array.isArray(t)||!t.length||t.length!==e.handles+1)throw new Error("noUiSlider: 'connect' option doesn't match handle count.");n=t}e.connect=n}a(Ic,"testConnect");function Dc(e,t){switch(t){case"horizontal":e.ort=0;break;case"vertical":e.ort=1;break;default:throw new Error("noUiSlider: 'orientation' option is invalid.")}}a(Dc,"testOrientation");function Qa(e,t){if(!ye(t))throw new Error("noUiSlider: 'margin' option must be numeric.");t!==0&&(e.margin=e.spectrum.getDistance(t))}a(Qa,"testMargin");function Ac(e,t){if(!ye(t))throw new Error("noUiSlider: 'limit' option must be numeric.");if(e.limit=e.spectrum.getDistance(t),!e.limit||e.handles<2)throw new Error("noUiSlider: 'limit' option is only supported on linear sliders with 2 or more handles.")}a(Ac,"testLimit");function Tc(e,t){var n;if(!ye(t)&&!Array.isArray(t))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(Array.isArray(t)&&!(t.length===2||ye(t[0])||ye(t[1])))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(t!==0){for(Array.isArray(t)||(t=[t,t]),e.padding=[e.spectrum.getDistance(t[0]),e.spectrum.getDistance(t[1])],n=0;n<e.spectrum.xNumSteps.length-1;n++)if(e.padding[0][n]<0||e.padding[1][n]<0)throw new Error("noUiSlider: 'padding' option must be a positive number(s).");var r=t[0]+t[1],s=e.spectrum.xVal[0],i=e.spectrum.xVal[e.spectrum.xVal.length-1];if(r/(i-s)>1)throw new Error("noUiSlider: 'padding' option must not exceed 100% of the range.")}}a(Tc,"testPadding");function Pc(e,t){switch(t){case"ltr":e.dir=0;break;case"rtl":e.dir=1;break;default:throw new Error("noUiSlider: 'direction' option was not recognized.")}}a(Pc,"testDirection");function Oc(e,t){if(typeof t!="string")throw new Error("noUiSlider: 'behaviour' must be a string containing options.");var n=t.indexOf("tap")>=0,r=t.indexOf("drag")>=0,s=t.indexOf("fixed")>=0,i=t.indexOf("snap")>=0,o=t.indexOf("hover")>=0,c=t.indexOf("unconstrained")>=0,l=t.indexOf("drag-all")>=0,d=t.indexOf("smooth-steps")>=0;if(s){if(e.handles!==2)throw new Error("noUiSlider: 'fixed' behaviour must be used with 2 handles");Qa(e,e.start[1]-e.start[0])}if(c&&(e.margin||e.limit))throw new Error("noUiSlider: 'unconstrained' behaviour cannot be used with margin or limit");e.events={tap:n||i,drag:r,dragAll:l,smoothSteps:d,fixed:s,snap:i,hover:o,unconstrained:c}}a(Oc,"testBehaviour");function Mc(e,t){if(t!==!1)if(t===!0||_t(t)){e.tooltips=[];for(var n=0;n<e.handles;n++)e.tooltips.push(t)}else{if(t=qt(t),t.length!==e.handles)throw new Error("noUiSlider: must pass a formatter for all handles.");t.forEach(function(r){if(typeof r!="boolean"&&!_t(r))throw new Error("noUiSlider: 'tooltips' must be passed a formatter or 'false'.")}),e.tooltips=t}}a(Mc,"testTooltips");function Rc(e,t){if(t.length!==e.handles)throw new Error("noUiSlider: must pass a attributes for all handles.");e.handleAttributes=t}a(Rc,"testHandleAttributes");function Fc(e,t){if(!_t(t))throw new Error("noUiSlider: 'ariaFormat' requires 'to' method.");e.ariaFormat=t}a(Fc,"testAriaFormat");function Lc(e,t){if(!rc(t))throw new Error("noUiSlider: 'format' requires 'to' and 'from' methods.");e.format=t}a(Lc,"testFormat");function Hc(e,t){if(typeof t!="boolean")throw new Error("noUiSlider: 'keyboardSupport' option must be a boolean.");e.keyboardSupport=t}a(Hc,"testKeyboardSupport");function Uc(e,t){e.documentElement=t}a(Uc,"testDocumentElement");function $c(e,t){if(typeof t!="string"&&t!==!1)throw new Error("noUiSlider: 'cssPrefix' must be a string or `false`.");e.cssPrefix=t}a($c,"testCssPrefix");function Nc(e,t){if(typeof t!="object")throw new Error("noUiSlider: 'cssClasses' must be an object.");typeof e.cssPrefix=="string"?(e.cssClasses={},Object.keys(t).forEach(function(n){e.cssClasses[n]=e.cssPrefix+t[n]})):e.cssClasses=t}a(Nc,"testCssClasses");function Xa(e){var t={margin:null,limit:null,padding:null,animate:!0,animationDuration:300,ariaFormat:Va,format:Va},n={step:{r:!1,t:yc},keyboardPageMultiplier:{r:!1,t:vc},keyboardMultiplier:{r:!1,t:bc},keyboardDefaultStep:{r:!1,t:Sc},start:{r:!0,t:Ec},connect:{r:!0,t:Ic},direction:{r:!0,t:Pc},snap:{r:!1,t:xc},animate:{r:!1,t:Cc},animationDuration:{r:!1,t:kc},range:{r:!0,t:wc},orientation:{r:!1,t:Dc},margin:{r:!1,t:Qa},limit:{r:!1,t:Ac},padding:{r:!1,t:Tc},behaviour:{r:!0,t:Oc},ariaFormat:{r:!1,t:Fc},format:{r:!1,t:Lc},tooltips:{r:!1,t:Mc},keyboardSupport:{r:!0,t:Hc},documentElement:{r:!1,t:Uc},cssPrefix:{r:!0,t:$c},cssClasses:{r:!0,t:Nc},handleAttributes:{r:!1,t:Rc}},r={connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal",keyboardSupport:!0,cssPrefix:"noUi-",cssClasses:Ka,keyboardPageMultiplier:5,keyboardMultiplier:1,keyboardDefaultStep:10};e.format&&!e.ariaFormat&&(e.ariaFormat=e.format),Object.keys(n).forEach(function(l){if(!Hn(e[l])&&r[l]===void 0){if(n[l].r)throw new Error("noUiSlider: '"+l+"' is required.");return}n[l].t(t,Hn(e[l])?e[l]:r[l])}),t.pips=e.pips;var s=document.createElement("div"),i=s.style.msTransform!==void 0,o=s.style.transform!==void 0;t.transformRule=o?"transform":i?"msTransform":"webkitTransform";var c=[["left","top"],["right","bottom"]];return t.style=c[t.dir][t.ort],t}a(Xa,"testOptions");function _c(e,t,n){var r=lc(),s=fc(),i=s&&uc(),o=e,c,l,d,u,p,m=t.spectrum,v=[],g=[],y=[],w=0,E={},x=e.ownerDocument,C=t.documentElement||x.documentElement,M=x.body,L=x.dir==="rtl"||t.ort===1?0:100;function q(f,h){var b=x.createElement("div");return h&&se(b,h),f.appendChild(b),b}a(q,"addNodeTo");function ne(f,h){var b=q(f,t.cssClasses.origin),S=q(b,t.cssClasses.handle);if(q(S,t.cssClasses.touchArea),S.setAttribute("data-handle",String(h)),t.keyboardSupport&&(S.setAttribute("tabindex","0"),S.addEventListener("keydown",function(k){return ai(k,h)})),t.handleAttributes!==void 0){var I=t.handleAttributes[h];Object.keys(I).forEach(function(k){S.setAttribute(k,I[k])})}return S.setAttribute("role","slider"),S.setAttribute("aria-orientation",t.ort?"vertical":"horizontal"),h===0?se(S,t.cssClasses.handleLower):h===t.handles-1&&se(S,t.cssClasses.handleUpper),b.handle=S,b}a(ne,"addOrigin");function Q(f,h){return h?q(f,t.cssClasses.connect):!1}a(Q,"addConnect");function j(f,h){var b=q(h,t.cssClasses.connects);l=[],d=[],d.push(Q(b,f[0]));for(var S=0;S<t.handles;S++)l.push(ne(h,S)),y[S]=S,d.push(Q(b,f[S+1]))}a(j,"addElements");function oe(f){se(f,t.cssClasses.target),t.dir===0?se(f,t.cssClasses.ltr):se(f,t.cssClasses.rtl),t.ort===0?se(f,t.cssClasses.horizontal):se(f,t.cssClasses.vertical);var h=getComputedStyle(f).direction;return h==="rtl"?se(f,t.cssClasses.textDirectionRtl):se(f,t.cssClasses.textDirectionLtr),q(f,t.cssClasses.base)}a(oe,"addSlider");function V(f,h){return!t.tooltips||!t.tooltips[h]?!1:q(f.firstChild,t.cssClasses.tooltip)}a(V,"addTooltip");function R(){return o.hasAttribute("disabled")}a(R,"isSliderDisabled");function ve(f){var h=l[f];return h.hasAttribute("disabled")}a(ve,"isHandleDisabled");function be(f){f!=null?(l[f].setAttribute("disabled",""),l[f].handle.removeAttribute("tabindex")):(o.setAttribute("disabled",""),l.forEach(function(h){h.handle.removeAttribute("tabindex")}))}a(be,"disable");function Be(f){f!=null?(l[f].removeAttribute("disabled"),l[f].handle.setAttribute("tabindex","0")):(o.removeAttribute("disabled"),l.forEach(function(h){h.removeAttribute("disabled"),h.handle.setAttribute("tabindex","0")}))}a(Be,"enable");function ge(){p&&(ze("update"+Ie.tooltips),p.forEach(function(f){f&&ja(f)}),p=null)}a(ge,"removeTooltips");function st(){ge(),p=l.map(V),nn("update"+Ie.tooltips,function(f,h,b){if(!(!p||!t.tooltips)&&p[h]!==!1){var S=f[h];t.tooltips[h]!==!0&&(S=t.tooltips[h].to(b[h])),p[h].innerHTML=S}})}a(st,"tooltips");function Qt(){ze("update"+Ie.aria),nn("update"+Ie.aria,function(f,h,b,S,I){y.forEach(function(k){var O=l[k],D=ot(g,k,0,!0,!0,!0),B=ot(g,k,100,!0,!0,!0),_=I[k],W=String(t.ariaFormat.to(b[k]));D=m.fromStepping(D).toFixed(1),B=m.fromStepping(B).toFixed(1),_=m.fromStepping(_).toFixed(1),O.children[0].setAttribute("aria-valuemin",D),O.children[0].setAttribute("aria-valuemax",B),O.children[0].setAttribute("aria-valuenow",_),O.children[0].setAttribute("aria-valuetext",W)})})}a(Qt,"aria");function Xt(f){if(f.mode===De.Range||f.mode===De.Steps)return m.xVal;if(f.mode===De.Count){if(f.values<2)throw new Error("noUiSlider: 'values' (>= 2) required for mode 'count'.");for(var h=f.values-1,b=100/h,S=[];h--;)S[h]=h*b;return S.push(100),it(S,f.stepped)}return f.mode===De.Positions?it(f.values,f.stepped):f.mode===De.Values?f.stepped?f.values.map(function(I){return m.fromStepping(m.getStep(m.toStepping(I)))}):f.values:[]}a(Xt,"getGroup");function it(f,h){return f.map(function(b){return m.fromStepping(h?m.getStep(b):b)})}a(it,"mapToRange");function Qs(f){function h(_,W){return Number((_+W).toFixed(7))}a(h,"safeIncrement");var b=Xt(f),S={},I=m.xVal[0],k=m.xVal[m.xVal.length-1],O=!1,D=!1,B=0;return b=ac(b.slice().sort(function(_,W){return _-W})),b[0]!==I&&(b.unshift(I),O=!0),b[b.length-1]!==k&&(b.push(k),D=!0),b.forEach(function(_,W){var Y,U,J,re=_,ee=b[W+1],te,sn,on,cn,sr,ln,ir,or=f.mode===De.Steps;for(or&&(Y=m.xNumSteps[W]),Y||(Y=ee-re),ee===void 0&&(ee=re),Y=Math.max(Y,1e-7),U=re;U<=ee;U=h(U,Y)){for(te=m.toStepping(U),sn=te-B,sr=sn/(f.density||1),ln=Math.round(sr),ir=sn/ln,J=1;J<=ln;J+=1)on=B+J*ir,S[on.toFixed(5)]=[m.fromStepping(on),0];cn=b.indexOf(U)>-1?ie.LargeValue:or?ie.SmallValue:ie.NoValue,!W&&O&&U!==ee&&(cn=0),U===ee&&D||(S[te.toFixed(5)]=[U,cn]),B=te}}),S}a(Qs,"generateSpread");function Xs(f,h,b){var S,I,k=x.createElement("div"),O=(S={},S[ie.None]="",S[ie.NoValue]=t.cssClasses.valueNormal,S[ie.LargeValue]=t.cssClasses.valueLarge,S[ie.SmallValue]=t.cssClasses.valueSub,S),D=(I={},I[ie.None]="",I[ie.NoValue]=t.cssClasses.markerNormal,I[ie.LargeValue]=t.cssClasses.markerLarge,I[ie.SmallValue]=t.cssClasses.markerSub,I),B=[t.cssClasses.valueHorizontal,t.cssClasses.valueVertical],_=[t.cssClasses.markerHorizontal,t.cssClasses.markerVertical];se(k,t.cssClasses.pips),se(k,t.ort===0?t.cssClasses.pipsHorizontal:t.cssClasses.pipsVertical);function W(U,J){var re=J===t.cssClasses.value,ee=re?B:_,te=re?O:D;return J+" "+ee[t.ort]+" "+te[U]}a(W,"getClasses");function Y(U,J,re){if(re=h?h(J,re):re,re!==ie.None){var ee=q(k,!1);ee.className=W(re,t.cssClasses.marker),ee.style[t.style]=U+"%",re>ie.NoValue&&(ee=q(k,!1),ee.className=W(re,t.cssClasses.value),ee.setAttribute("data-value",String(J)),ee.style[t.style]=U+"%",ee.innerHTML=String(b.to(J)))}}return a(Y,"addSpread"),Object.keys(f).forEach(function(U){Y(U,f[U][0],f[U][1])}),k}a(Xs,"addMarking");function Jt(){u&&(ja(u),u=null)}a(Jt,"removePips");function Zt(f){Jt();var h=Qs(f),b=f.filter,S=f.format||{to:function(I){return String(Math.round(I))}};return u=o.appendChild(Xs(h,b,S)),u}a(Zt,"pips");function Xn(){var f=c.getBoundingClientRect(),h="offset"+["Width","Height"][t.ort];return t.ort===0?f.width||c[h]:f.height||c[h]}a(Xn,"baseSize");function Pe(f,h,b,S){var I=a(function(O){var D=Js(O,S.pageOffset,S.target||h);if(!D||R()&&!S.doNotReject||cc(o,t.cssClasses.tap)&&!S.doNotReject||f===r.start&&D.buttons!==void 0&&D.buttons>1||S.hover&&D.buttons)return!1;i||D.preventDefault(),D.calcPoint=D.points[t.ort],b(D,S)},"method"),k=[];return f.split(" ").forEach(function(O){h.addEventListener(O,I,i?{passive:!0}:!1),k.push([O,I])}),k}a(Pe,"attachEvent");function Js(f,h,b){var S=f.type.indexOf("touch")===0,I=f.type.indexOf("mouse")===0,k=f.type.indexOf("pointer")===0,O=0,D=0;if(f.type.indexOf("MSPointer")===0&&(k=!0),f.type==="mousedown"&&!f.buttons&&!f.touches)return!1;if(S){var B=a(function(Y){var U=Y.target;return U===b||b.contains(U)||f.composed&&f.composedPath().shift()===b},"isTouchOnTarget");if(f.type==="touchstart"){var _=Array.prototype.filter.call(f.touches,B);if(_.length>1)return!1;O=_[0].pageX,D=_[0].pageY}else{var W=Array.prototype.find.call(f.changedTouches,B);if(!W)return!1;O=W.pageX,D=W.pageY}}return h=h||Wa(x),(I||k)&&(O=f.clientX+h.x,D=f.clientY+h.y),f.pageOffset=h,f.points=[O,D],f.cursor=I||k,f}a(Js,"fixEvent");function Jn(f){var h=f-ic(c,t.ort),b=h*100/Xn();return b=Ga(b),t.dir?100-b:b}a(Jn,"calcPointToPercentage");function Zs(f){var h=100,b=!1;return l.forEach(function(S,I){if(!ve(I)){var k=g[I],O=Math.abs(k-f),D=O===100&&h===100,B=O<h,_=O<=h&&f>k;(B||_||D)&&(b=I,h=O)}}),b}a(Zs,"getClosestHandle");function ei(f,h){f.type==="mouseout"&&f.target.nodeName==="HTML"&&f.relatedTarget===null&&en(f,h)}a(ei,"documentLeave");function ti(f,h){if(navigator.appVersion.indexOf("MSIE 9")===-1&&f.buttons===0&&h.buttonsProperty!==0)return en(f,h);var b=(t.dir?-1:1)*(f.calcPoint-h.startCalcPoint),S=b*100/h.baseSize;Zn(b>0,S,h.locations,h.handleNumbers,h.connect)}a(ti,"eventMove");function en(f,h){h.handle&&(Nt(h.handle,t.cssClasses.active),w-=1),h.listeners.forEach(function(b){C.removeEventListener(b[0],b[1])}),w===0&&(Nt(o,t.cssClasses.drag),an(),f.cursor&&(M.style.cursor="",M.removeEventListener("selectstart",Ba))),t.events.smoothSteps&&(h.handleNumbers.forEach(function(b){Oe(b,g[b],!0,!0,!1,!1)}),h.handleNumbers.forEach(function(b){X("update",b)})),h.handleNumbers.forEach(function(b){X("change",b),X("set",b),X("end",b)})}a(en,"eventEnd");function tn(f,h){if(!h.handleNumbers.some(ve)){var b;if(h.handleNumbers.length===1){var S=l[h.handleNumbers[0]];b=S.children[0],w+=1,se(b,t.cssClasses.active)}f.stopPropagation();var I=[],k=Pe(r.move,C,ti,{target:f.target,handle:b,connect:h.connect,listeners:I,startCalcPoint:f.calcPoint,baseSize:Xn(),pageOffset:f.pageOffset,handleNumbers:h.handleNumbers,buttonsProperty:f.buttons,locations:g.slice()}),O=Pe(r.end,C,en,{target:f.target,handle:b,listeners:I,doNotReject:!0,handleNumbers:h.handleNumbers}),D=Pe("mouseout",C,ei,{target:f.target,handle:b,listeners:I,doNotReject:!0,handleNumbers:h.handleNumbers});I.push.apply(I,k.concat(O,D)),f.cursor&&(M.style.cursor=getComputedStyle(f.target).cursor,l.length>1&&se(o,t.cssClasses.drag),M.addEventListener("selectstart",Ba,!1)),h.handleNumbers.forEach(function(B){X("start",B)})}}a(tn,"eventStart");function ni(f){f.stopPropagation();var h=Jn(f.calcPoint),b=Zs(h);b!==!1&&(t.events.snap||za(o,t.cssClasses.tap,t.animationDuration),Oe(b,h,!0,!0),an(),X("slide",b,!0),X("update",b,!0),t.events.snap?tn(f,{handleNumbers:[b]}):(X("change",b,!0),X("set",b,!0)))}a(ni,"eventTap");function ri(f){var h=Jn(f.calcPoint),b=m.getStep(h),S=m.fromStepping(b);Object.keys(E).forEach(function(I){I.split(".")[0]==="hover"&&E[I].forEach(function(k){k.call(lt,S)})})}a(ri,"eventHover");function ai(f,h){if(R()||ve(h))return!1;var b=["Left","Right"],S=["Down","Up"],I=["PageDown","PageUp"],k=["Home","End"];t.dir&&!t.ort?b.reverse():t.ort&&!t.dir&&(S.reverse(),I.reverse());var O=f.key.replace("Arrow",""),D=O===I[0],B=O===I[1],_=O===S[0]||O===b[0]||D,W=O===S[1]||O===b[1]||B,Y=O===k[0],U=O===k[1];if(!_&&!W&&!Y&&!U)return!0;f.preventDefault();var J;if(W||_){var re=_?0:1,ee=ar(h),te=ee[re];if(te===null)return!1;te===!1&&(te=m.getDefaultStep(g[h],_,t.keyboardDefaultStep)),B||D?te*=t.keyboardPageMultiplier:te*=t.keyboardMultiplier,te=Math.max(te,1e-7),te=(_?-1:1)*te,J=v[h]+te}else U?J=t.spectrum.xVal[t.spectrum.xVal.length-1]:J=t.spectrum.xVal[0];return Oe(h,m.toStepping(J),!0,!0),X("slide",h),X("update",h),X("change",h),X("set",h),!1}a(ai,"eventKeydown");function si(f){f.fixed||l.forEach(function(h,b){Pe(r.start,h.children[0],tn,{handleNumbers:[b]})}),f.tap&&Pe(r.start,c,ni,{}),f.hover&&Pe(r.move,c,ri,{hover:!0}),f.drag&&d.forEach(function(h,b){if(!(h===!1||b===0||b===d.length-1)){var S=l[b-1],I=l[b],k=[h],O=[S,I],D=[b-1,b];se(h,t.cssClasses.draggable),f.fixed&&(k.push(S.children[0]),k.push(I.children[0])),f.dragAll&&(O=l,D=y),k.forEach(function(B){Pe(r.start,B,tn,{handles:O,handleNumbers:D,connect:h})})}})}a(si,"bindSliderEvents");function nn(f,h){E[f]=E[f]||[],E[f].push(h),f.split(".")[0]==="update"&&l.forEach(function(b,S){X("update",S)})}a(nn,"bindEvent");function ii(f){return f===Ie.aria||f===Ie.tooltips}a(ii,"isInternalNamespace");function ze(f){var h=f&&f.split(".")[0],b=h?f.substring(h.length):f;Object.keys(E).forEach(function(S){var I=S.split(".")[0],k=S.substring(I.length);(!h||h===I)&&(!b||b===k)&&(!ii(k)||b===k)&&delete E[S]})}a(ze,"removeEvent");function X(f,h,b){Object.keys(E).forEach(function(S){var I=S.split(".")[0];f===I&&E[S].forEach(function(k){k.call(lt,v.map(t.format.to),h,v.slice(),b||!1,g.slice(),lt)})})}a(X,"fireEvent");function ot(f,h,b,S,I,k,O){var D;return l.length>1&&!t.events.unconstrained&&(S&&h>0&&(D=m.getAbsoluteDistance(f[h-1],t.margin,!1),b=Math.max(b,D)),I&&h<l.length-1&&(D=m.getAbsoluteDistance(f[h+1],t.margin,!0),b=Math.min(b,D))),l.length>1&&t.limit&&(S&&h>0&&(D=m.getAbsoluteDistance(f[h-1],t.limit,!1),b=Math.min(b,D)),I&&h<l.length-1&&(D=m.getAbsoluteDistance(f[h+1],t.limit,!0),b=Math.max(b,D))),t.padding&&(h===0&&(D=m.getAbsoluteDistance(0,t.padding[0],!1),b=Math.max(b,D)),h===l.length-1&&(D=m.getAbsoluteDistance(100,t.padding[1],!0),b=Math.min(b,D))),O||(b=m.getStep(b)),b=Ga(b),b===f[h]&&!k?!1:b}a(ot,"checkHandlePosition");function rn(f,h){var b=t.ort;return(b?h:f)+", "+(b?f:h)}a(rn,"inRuleOrder");function Zn(f,h,b,S,I){var k=b.slice(),O=S[0],D=t.events.smoothSteps,B=[!f,f],_=[f,!f];S=S.slice(),f&&S.reverse(),S.length>1?S.forEach(function(Y,U){var J=ot(k,Y,k[Y]+h,B[U],_[U],!1,D);J===!1?h=0:(h=J-k[Y],k[Y]=J)}):B=_=[!0];var W=!1;S.forEach(function(Y,U){W=Oe(Y,b[Y]+h,B[U],_[U],!1,D)||W}),W&&(S.forEach(function(Y){X("update",Y),X("slide",Y)}),I!=null&&X("drag",O))}a(Zn,"moveHandles");function er(f,h){return t.dir?100-f-h:f}a(er,"transformDirection");function oi(f,h){g[f]=h,v[f]=m.fromStepping(h);var b=er(h,0)-L,S="translate("+rn(b+"%","0")+")";l[f].style[t.transformRule]=S,tr(f),tr(f+1)}a(oi,"updateHandlePosition");function an(){y.forEach(function(f){var h=g[f]>50?-1:1,b=3+(l.length+h*f);l[f].style.zIndex=String(b)})}a(an,"setZindex");function Oe(f,h,b,S,I,k){return I||(h=ot(g,f,h,b,S,!1,k)),h===!1?!1:(oi(f,h),!0)}a(Oe,"setHandle");function tr(f){if(d[f]){var h=0,b=100;f!==0&&(h=g[f-1]),f!==d.length-1&&(b=g[f]);var S=b-h,I="translate("+rn(er(h,S)+"%","0")+")",k="scale("+rn(S/100,"1")+")";d[f].style[t.transformRule]=I+" "+k}}a(tr,"updateConnect");function nr(f,h){return f===null||f===!1||f===void 0||(typeof f=="number"&&(f=String(f)),f=t.format.from(f),f!==!1&&(f=m.toStepping(f)),f===!1||isNaN(f))?g[h]:f}a(nr,"resolveToValue");function ct(f,h,b){var S=qt(f),I=g[0]===void 0;h=h===void 0?!0:h,t.animate&&!I&&za(o,t.cssClasses.tap,t.animationDuration),y.forEach(function(D){Oe(D,nr(S[D],D),!0,!1,b)});var k=y.length===1?0:1;if(I&&m.hasNoSize()&&(b=!0,g[0]=0,y.length>1)){var O=100/(y.length-1);y.forEach(function(D){g[D]=D*O})}for(;k<y.length;++k)y.forEach(function(D){Oe(D,g[D],!0,!0,b)});an(),y.forEach(function(D){X("update",D),S[D]!==null&&h&&X("set",D)})}a(ct,"valueSet");function ci(f){ct(t.start,f)}a(ci,"valueReset");function li(f,h,b,S){if(f=Number(f),!(f>=0&&f<y.length))throw new Error("noUiSlider: invalid handle number, got: "+f);Oe(f,nr(h,f),!0,!0,S),X("update",f),b&&X("set",f)}a(li,"valueSetHandle");function rr(f){if(f===void 0&&(f=!1),f)return v.length===1?v[0]:v.slice(0);var h=v.map(t.format.to);return h.length===1?h[0]:h}a(rr,"valueGet");function fi(){for(ze(Ie.aria),ze(Ie.tooltips),Object.keys(t.cssClasses).forEach(function(f){Nt(o,t.cssClasses[f])});o.firstChild;)o.removeChild(o.firstChild);delete o.noUiSlider}a(fi,"destroy");function ar(f){var h=g[f],b=m.getNearbySteps(h),S=v[f],I=b.thisStep.step,k=null;if(t.snap)return[S-b.stepBefore.startValue||null,b.stepAfter.startValue-S||null];I!==!1&&S+I>b.stepAfter.startValue&&(I=b.stepAfter.startValue-S),S>b.thisStep.startValue?k=b.thisStep.step:b.stepBefore.step===!1?k=!1:k=S-b.stepBefore.highestStep,h===100?I=null:h===0&&(k=null);var O=m.countStepDecimals();return I!==null&&I!==!1&&(I=Number(I.toFixed(O))),k!==null&&k!==!1&&(k=Number(k.toFixed(O))),[k,I]}a(ar,"getNextStepsForHandle");function di(){return y.map(ar)}a(di,"getNextSteps");function pi(f,h){var b=rr(),S=["margin","limit","padding","range","animate","snap","step","format","pips","tooltips"];S.forEach(function(k){f[k]!==void 0&&(n[k]=f[k])});var I=Xa(n);S.forEach(function(k){f[k]!==void 0&&(t[k]=I[k])}),m=I.spectrum,t.margin=I.margin,t.limit=I.limit,t.padding=I.padding,t.pips?Zt(t.pips):Jt(),t.tooltips?st():ge(),g=[],ct(Hn(f.start)?f.start:b,h)}a(pi,"updateOptions");function mi(){c=oe(o),j(t.connect,c),si(t.events),ct(t.start),t.pips&&Zt(t.pips),t.tooltips&&st(),Qt()}a(mi,"setupSlider"),mi();var lt={destroy:fi,steps:di,on:nn,off:ze,get:rr,set:ct,setHandle:li,reset:ci,disable:be,enable:Be,__moveHandles:function(f,h,b){Zn(f,h,g,b)},options:n,updateOptions:pi,target:o,removePips:Jt,removeTooltips:ge,getPositions:function(){return g.slice()},getTooltips:function(){return p},getOrigins:function(){return l},pips:Zt};return lt}a(_c,"scope");function qc(e,t){if(!e||!e.nodeName)throw new Error("noUiSlider: create requires a single element, got: "+e);if(e.noUiSlider)throw new Error("noUiSlider: Slider was already initialized.");var n=Xa(t),r=_c(e,n,t);return e.noUiSlider=r,r}a(qc,"initialize");var Ja={__spectrum:Ya,cssClasses:Ka,create:qc};var Ae=H("merchant.buy"),nt=class extends Application{static{a(this,"BuyItems")}constructor(t,n={}){super(n),this.actor=t,this.defaultData=bn({collapsed:!0}),this.defaultData.name="",this.editing=null,this.tabs={equipment:{filterData:deepClone(this.defaultData),isOfType:(...r)=>r.includes("equipment")}},this.activeTab="equipment",this.navigationTab={active:"equipment"},this.expanded={}}get id(){return`pf2e-toolbelt-buy-${this.actor.id}`}get title(){return Ae("title",this.actor)}get template(){return ue("merchant/buy")}get tab(){return this.tabs.equipment}get filters(){return P(this.actor,"merchant.filters")??[]}async setFilters(t,n=!1){n&&this.resetFilters(),await ae(this.actor,"merchant.filters",t),this.render()}render(t,n){return this.actor.apps[this.appId]=this,super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId]}async getData(t){let n=this.filters,r=P(this.actor,"merchant.buyRatio"),s=P(this.actor,"merchant.buyPurse"),i=a(c=>{let l=jt(c);return l<0?"":Math.floor(l)},"formatPurse"),o=a(c=>{let l=[],d=a((m,v)=>{let g=this.defaultData[m][v];return{defaultData:g,title:game.i18n.localize(g.label)}},"getDefaultData"),u=Object.entries(c.checkboxes??{});for(let[m,{selected:v}]of u){let{title:g,defaultData:y}=d("checkboxes",m),w=v.map(E=>y.options[E].label).join(", ");l.push({title:g,row:w})}let p=Object.entries(c.multiselects??{});for(let[m,{selected:v,conjunction:g}]of p){let{title:y}=d("multiselects",m),w=v.map(({label:E,not:x})=>x?`<s>${E}</s>`:E).join(", ");l.push({title:`${y} (${g})`,row:w})}for(let m of["ranges","sliders"]){let v=Object.entries(c[m]??{});for(let[g,{values:y}]of v){let{title:w}=d(m,g),E=y.inputMin??y.min,x=y.inputMax??y.max,C=`${E} - ${x}`;l.push({title:w,row:C})}}return l.map(({title:m,row:v})=>`<div><strong>${m}: </strong>${v}</div>`).join("")},"getSummary");return{...this.tabs.equipment,...Ae.i18n,filters:n.map(c=>({...c,summary:o(c),expanded:this.expanded[c.id],name:this.getFilterName(c),purse:i(c.purse),priceRatio:Ue("buy",c.priceRatio)})),defaultFilter:{id:"",name:Ae("default.label"),purse:i(s),priceRatio:Ue("buy",r),buyAll:Nn(this.actor)},priceRatio:qe}}async activateListeners(t){let n=this.tab.filterData,r=t.find(".control-area");r.find("[id]").removeAttr("id"),r.find("[data-filter-name='source']").remove();let s=r.find(".sortcontainer");s.children().remove();let i=await z("merchant/extra",{value:n.name,editing:this.editing,...Ae.i18n});s.append(i),s.find("[name=filter-name]").on("change",u=>{n.name=u.currentTarget.value.trim()}),s.find("button").on("click",u=>{u.preventDefault();let{action:p}=u.currentTarget.dataset;switch(p){case"reset-filter":this.resetFilters();break;case"save-filter":this.saveFilter();break}});let o=r.find(".filtercontainer:not([data-filter-type=multiselects])");for(let u of o){let{filterType:p,filterName:m}=u.dataset,v=n[p][m],g=u.querySelector(".title");g.querySelector("button")?.remove();let y=g.nextElementSibling;if(g.addEventListener("click",()=>{y.style.display=v.isExpanded?"none":"",v.isExpanded=!v.isExpanded}),y.style.display=v.isExpanded?"":"none",u.setAttribute("data-buy-filter-type",p),u.setAttribute("data-buy-filter-name",m),u.removeAttribute("data-filter-type"),u.removeAttribute("data-filter-name"),p==="sliders"){let w=y.querySelector("[class^=slider-]"),E=Ja.create(w,{range:{min:v.values.lowerLimit,max:v.values.upperLimit},start:[v.values.min,v.values.max],tooltips:{to(M){return Math.floor(M).toString()}},connect:[!1,!0,!1],behaviour:"snap",step:v.values.step}),x=w.previousElementSibling,C=w.nextElementSibling;E.on("change",M=>{let[L,q]=M.map(ne=>Number(ne));v.values.min=L,v.values.max=q,x.textContent=L,C.textContent=q})}else if(p==="ranges"){let w=y.querySelector("input[name^=lowerBound]"),E=y.querySelector("input[name^=upperBound]");for(let x of[w,E])x.addEventListener("change",()=>{let C=w.value??"",M=E.value??"",L=this.parseRangeFilterInput(m,C,M);v.values=L,v.changed=!0,w.value=L.inputMin,E.value=L.inputMax})}else if(p==="checkboxes"){let w=u.querySelectorAll("input[type=checkbox]");for(let E of w)E.addEventListener("click",()=>{let x=E.name,C=v.options[x];C.selected=!C.selected,C.selected?v.selected.push(x):v.selected=v.selected.filter(M=>M!==x)})}}t.find("input[type=text], input[type=search], input[type=number]").on("keyup",u=>{u.key==="Enter"&&u.currentTarget.blur()}),Tr().activateListeners.call(this,t);let c=t.find(".filters .filter"),l=a(u=>{let p=u.currentTarget.closest("[data-filter-id]");return{filterElement:p,filterId:p.dataset.filterId}},"getFilterId");c.find("[data-action]").on("click",u=>{u.preventDefault();let{filterId:p,filterElement:m}=l(u),{direction:v,action:g}=u.currentTarget.dataset;switch(g){case"delete-filter":this.deleteFilter(p);break;case"move-filter":this.moveFilterPosition(p,v);break;case"edit-filter":this.editFilter(p);break;case"toggle-summary":this.toggleFilterSummary(m,p);break}});let d=a((u,p,m)=>{if(!u){ae(this.actor,`merchant.${p}`,m);return}let v=this.filters.slice(),g=v.find(y=>y.id===u);g&&(g[p]=m,this.setFilters(v))},"setFilterValue");c.find("[name=price-ratio]").on("change",u=>{let{filterId:p}=l(u),m=u.currentTarget.valueAsNumber,v=Ue("buy",m);d(p,p?"priceRatio":"buyRatio",v)}),c.find("[name=purse]").on("change",u=>{let{filterId:p}=l(u),m=u.currentTarget.value,v=jt(m);d(p,p?"purse":"buyPurse",v)}),c.find("[name=buy-all]").on("change",u=>{let p=u.currentTarget.checked;ae(this.actor,"merchant.buyAll",p)})}toggleFilterSummary(t,n){let r=this.expanded[n];this.expanded[n]=!r,t.classList.toggle("expanded",!r)}editFilter(t){let n=this.filters.find(s=>s.id===t);if(!n)return;let r=bn({collapsed:!0,mergeWith:deepClone(n)});this.tab.filterData=r,this.editing=t,this.render()}deleteFilter(t,n=!1){let r=this.filters.slice(),s=r.findIndex(o=>o.id===t);if(s===-1)return;let i=a(()=>{r.splice(s,1),this.setFilters(r,this.editing===t)},"deleteIt");if(n){i();return}Dialog.confirm({title:Ae("delete.title"),content:Ae("delete.content",{name:r[s].name}),yes:()=>{r.findIndex(c=>c.id===t)!==-1&&i()}})}moveFilterPosition(t,n){let r=this.filters.slice();if(r.length<2)return;let s=r.findIndex(c=>c.id===t);if(s===-1||n==="up"&&s===0||n==="down"&&s===r.length-1)return;let i=n==="down"?s+1:s-1,o=r.splice(s,1)[0];r.splice(i,0,o),this.setFilters(r)}parseRangeFilterInput(t,n,r){let s=Me("equipment"),i=this.defaultData.ranges[t].values,o=n.trim()||i.inputMin,c=r.trim()||i.inputMax,l=s.parseRangeFilterInput(t,o,c);return l.max<l.min&&(l.max=l.min,l.inputMax=l.inputMin),l}resetFilters(){this.editing=null,this.tab.filterData=deepClone(this.defaultData),this.render(!1,{force:!0})}static compareItemWithFilter(t,n){let r=Me("equipment"),{checkboxes:s={},multiselects:i={},ranges:o={},sliders:c={}}=n;return!(c.level&&(t.level<c.level.values.min||t.level>c.level.values.max)||o.price&&(t.priceInCopper<o.price.values.min||t.priceInCopper>o.price.values.max)||s.itemTypes?.selected.length>0&&!s.itemTypes.selected.includes(t.type)||s.armorTypes?.selected.length>0&&!r.arrayIncludes(s.armorTypes.selected,[t.category,t.group])||s.weaponTypes?.selected.length>0&&!r.arrayIncludes(s.weaponTypes.selected,[t.category,t.group])||i.traits&&!r.filterTraits([...t.traits],i.traits.selected,i.traits.conjunction)||s.source?.selected.length>0&&!s.source.selected.includes(t.source)||s.rarity?.selected.length>0&&!s.rarity.selected.includes(t.rarity))}getFilterName(t){return t.name||`filter-${t.id}`}extractFilterData(){let t=this.defaultData,n=this.tab.filterData,r={};for(let s of["checkboxes","multiselects"])for(let[i,o]of Object.entries(n[s])){if(!o.selected.length)continue;let c=`${s}.${i}`;setProperty(r,`${c}.selected`,o.selected),s==="multiselects"&&setProperty(r,`${c}.conjunction`,o.conjunction)}for(let s of["ranges","sliders"]){let i=t[s];for(let[o,c]of Object.entries(n[s])){let l=i[o];objectsEqual(c.values,l.values)||setProperty(r,`${s}.${o}.values`,c.values)}}if(!isEmpty(r))return r.name=n.name.trim(),r.id=n.id??randomID(),r.priceRatio=n.priceRatio,r.purse=n.purse,r}saveFilter(){let t=this.extractFilterData();if(!t){Ae.warn("empty");return}let n=this.filters.slice();if(this.editing){let r=n.findIndex(s=>s.id===this.editing);if(r===-1)return;n[r]=t}else n.push(t);Ae.info(this.editing?"saved":"created",{name:this.getFilterName(t)}),this.setFilters(n,!0)}};var es=ke("merchant",zc),me=H("merchant"),ts="CONFIG.Item.documentClass.prototype.prepareDerivedData",jc="CONFIG.PF2E.Actor.documentClasses.loot.prototype.transferItemToActor",Bc="CONFIG.Actor.documentClass.prototype.transferItemToActor",Za=100,qe={min:.1,max:5,step:.1,buy:.5,sell:1};function ns(){return{settings:[{key:"merchant",type:Boolean,default:!1,requiresReload:!0}],init:e=>{T("merchant")&&(Hooks.on("renderLootSheetPF2e",Gc),e&&es.activate(),Z(ts,Vc,"WRAPPER"),Z(jc,Wc,"OVERRIDE"),Z(Bc,Yc,"MIXED"))}}}a(ns,"registerMerchant");function zc(e,t){switch(e.type){case"buy-deal":as(e,t);break}}a(zc,"onSocket");async function Gc(e,t){let n=e.actor;if(!n?.isMerchant)return;let r=game.user.isGM,{noCoins:s=!1,buyItems:i=!1,priceRatio:o=1,infiniteStocks:c=!1,infiniteItems:l={}}=P(n,"merchant")??{};if(r){let p=await z("merchant/sheet",{noCoins:s,buyItems:i,infiniteStocks:c,priceRatio:{...qe,value:Ue("sell",o)},actorUUID:n.uuid,...me.i18n,flagPath:g=>Se("merchant",g)}),m=t.find(".sheet-sidebar");m.find(".editor").before(p);let v=m.find(".better-merchant");v.find("[data-action=pull-from-browser]").on("click",g=>Qc(g,n)),v.find("[data-action=open-equipment-tab]").on("click",g=>_n()),v.find("[data-action=open-buy-settings]").on("click",g=>Xc(g,n))}let d=t.find(".content .sheet-body [data-item-types]").filter("[data-item-types!=treasure]"),u=c;if(c&&r)d.find(".quantity a").remove();else if(!c){let p=d.find("[data-item-id]"),m=me.path("infinite-item.tooltip");for(let v of p){let g=v.dataset.itemId,y=!!l[g];if(r){let w=$(`<a data-action="toggle-infinite-item" data-tooltip="${m}">
	<i class="${y?"fa-solid":"fa-duotone"} fa-infinity"></i>
</a>`)[0];if(v.querySelector(".item-controls").prepend(w),y)for(let E of v.querySelectorAll(".quantity a"))E.remove();w.addEventListener("click",E=>{let x=`merchant.infiniteItems.${g}`,C=P(n,x)??!1;ae(n,x,!C)})}y&&(u=!0)}}u&&(t.find(".content .sheet-body .coinage .wealth h3:last span").html("-"),t.find(".content .sheet-body .total-bulk span").html(game.i18n.format("PF2E.Actor.Inventory.TotalBulk",{bulk:"-"})))}a(Gc,"renderLootSheetPF2e");function Vc(e){e();try{if(!this.isOfType("physical")||this.isOfType("treasure"))return;let t=this.actor;if(!t?.isMerchant)return;let n=P(t,"merchant");if(!n)return;let{priceRatio:r,infiniteStocks:s,infiniteItems:i={}}=n;if(r!==1){let c=Ue("sell",r);this.system.price.value=this.system.price.value.scale(c)}(()=>{if(typeof s=="boolean"&&s)return!0;let c=i[this.id];return typeof c=="boolean"&&c})()&&(this.system.quantity=9999)}catch{Ee("merchant",ts)}}a(Vc,"itemPrepareDerivedData");async function Wc(...e){let[t,n,r]=e,s=Actor.implementation.prototype;if(!(this.isOwner&&t.isOwner))return s.transferItemToActor.apply(this,e);if(this.isMerchant&&n.isOfType("physical")){let i=game.pf2e.Coins.fromPrice(n.price,r);if(await t.inventory.removeCoins(i))return P(this,"merchant.noCoins")||await n.actor.inventory.addCoins(i),s.transferItemToActor.apply(this,e);if(this.isLoot)throw vt("Loot transfer failed");return null}return s.transferItemToActor.apply(this,e)}a(Wc,"lootTranferItemToActor");function rs(e){return P(e,"merchant.filters")?.slice()??[]}a(rs,"getFilters");function Nn(e){return P(e,"merchant.buyAll")??!0}a(Nn,"getBuyAll");function Bt(e,t){let n=e instanceof Actor,r=jt(n?P(e,"merchant.buyPurse"):e.purse),s=Ue("buy",n?P(e,"merchant.buyRatio"):e.priceRatio),i=t.scale(s),o=r<0,c=i.goldValue;return{price:i,ratio:s,purse:r,goldValue:c,isInfinite:o,canAfford:o||r>=c}}a(Bt,"createPurse");async function Yc(e,...t){let[n,r,s=1,i,o]=t;if(!n.isOfType("loot")||!n.isMerchant||!P(n,"merchant.buyItems"))return e(...t);let c=this.hasPlayerOwner;switch(this.type){case"character":case"party":break;case"loot":if(!c||this.isMerchant)return e(...t);break;case"npc":if(!c)return e(...t);break;default:return e(...t)}let l=n.name,d=Math.min(s,r.quantity),u=xn(r,d);if(!Bt(n,u).canAfford){me.info("buy.poor.total",{actor:l});return}let m=!1,v=null,g=rs(n);for(let y of g)if(nt.compareItemWithFilter(r,y)){if(!Bt(y,u).canAfford){m=!0;continue}v=y.id;break}if(!v&&!Nn(n)){me.info(m?"buy.poor.filter":"buy.refuse",{actor:l});return}as({buyer:n,seller:this,item:r,quantity:s,containerId:i,newStack:o,filter:v})}a(Yc,"actorTranferItemToActor");async function as(e,t){let n=a(async(x,C)=>x instanceof C?x:await fromUuid(x),"getDocument"),r=a(x=>{throw me.error("An error occured while making a deal (F12 for more details in the console)."),new Error(x)},"errorMsg"),s=await n(e.buyer,Actor),i=await n(e.seller,Actor),o=await n(e.item,Item);if(!s||!i||!o){let x=["buyer","seller","item"].map(C=>`${C}: ${e[C].uuid??e[C]}`).join(", ");r(`Missing actors or item to finish processing the buy deal, ${x}.`)}if(!s.isOwner||!i.isOwner){es.emit({...e,type:"buy-deal",buyer:s.uuid,seller:i.uuid,item:o.uuid});return}let c=Math.min(e.quantity,o.quantity),l=xn(o,c),d=rs(s),u=d.find(x=>x.id===e.filter),p=Bt(s,l),m=u?Bt(u,l):void 0,v=a((x,C)=>{r(`${s.uuid} can't buy ${c} x ${o.uuid}, the ${x} gold purse doesn't have enough founds, need: ${goldPrice}, has: ${C}.`)},"purseError");p.canAfford||v("total",p),m&&!m.canAfford&&v("filter",u.purse);let g=m??p,y=o.quantity-c;await i.inventory.addCoins(g.price),y<1?await o.delete():await o.update({"system.quantity":y});let w={};p.isInfinite||(w[Se("merchant.buyPurse")]=p.purse-g.goldValue),m&&!m.isInfinite&&(u.purse=m.purse-g.goldValue,w[Se("merchant.filters")]=d),isEmpty(w)||await s.update(w);let E=o.toObject();E.system.quantity=c,E.system.equipped.carryType="worn","invested"in E.system.equipped&&(E.system.equipped.invested=o.traits.has("invested")?!1:null),await s.addToInventory(E,e.container,e.newStack),Kc(s,i,o,c,t,g.goldValue)}a(as,"makeBuyDeal");async function Kc(e,t,n,r,s,i){let o=dn(e),c={user:s??game.user.id,speaker:ChatMessage.getSpeaker({actor:e,alias:o}),flavor:await renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:"PF2E.Actions.Interact.Title",subtitle:me("sold.subtitle"),glyph:vr(1)},traits:[{name:"manipulate",label:CONFIG.PF2E.featTraits.manipulate,description:CONFIG.PF2E.traitsDescriptions.manipulate}]}),content:me("sold.message",{buyer:o,quantity:r,item:n.name,seller:dn(t),price:parseFloat(i.toFixed(2))}),type:CONST.CHAT_MESSAGE_TYPES.EMOTE};ChatMessage.implementation.create(c)}a(Kc,"createBuyMessage");function _n(){Pr("equipment",!0)}a(_n,"openEquipmentTab");function Qc(e,t){let n=Me("equipment");if(!n.isInitialized){me.warn("browser.noTab"),_n();return}let r=n.currentIndex.length;if(r>Za){me.error("browser.limit",{limit:Za}),_n();return}let s=t.name,i=me("browser.dialogMsg",{nb:r,name:s});Dialog.confirm({content:`<div style="margin-bottom: 0.5em;">${i}</div>`,title:`${s} - ${me("browser.pull")}`,yes:async o=>{me.info("browser.wait");let c=(await Ar(n)).filter(Boolean);t.createEmbeddedDocuments("Item",c)}})}a(Qc,"pullFromBrowser");function Xc(e,t){new nt(t).render(!0)}a(Xc,"openBuySettings");function Ue(e,t){return Number.isNumeric(t)?Math.clamped(t,qe.min,qe.max):qe[e]}a(Ue,"clampPriceRatio");function jt(e){return Number.isNumeric(e)?Math.max(e,-1):-1}a(jt,"clampPurse");function zt(e){let t=e.id,n=P(e,"target.save");n&&Hooks.once("preCreateChatMessage",r=>{We(r,"target.messageId",t),We(r,"target.save",n)})}a(zt,"bindOnPreCreateSpellDamageChatMessage");var qn=H("merge.multi"),Gt=class extends Application{static{a(this,"MultiCast")}#e;#t;constructor(t,n,r){super(r),this.#t=t,this.#e=n}get title(){return qn("title",this.#e.item)}get template(){return ue("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:qn.template})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#n.bind(this)),t.find("[data-action=cancel]").on("click",this.#r.bind(this))}async#n(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){qn.error("zero"),this.close();return}let r=this.#e;if(!r)return;let s=r.item,i=r.actor;if(!i||!s)return;let o=a((l,d)=>{for(let[u,p]of Object.entries(l))for(let m=0;m<n-1;m++){let v=randomID();if(l[v]=p,d.type==="interval"){let g=d.damage[u];g&&(d.damage[v]=g)}else if(d.type==="fixed")for(let g of Object.values(d.levels)){let y=g.damage[u];y&&(g.damage[v]=y)}}},"updateSource"),c=deepClone(r.flags.pf2e.casting?.embeddedSpell);if(c){let l=c.system.damage;c.system.heightening??={};let d=c.system.heightening;o(l,d);let u=new Item.implementation(c,{parent:i});u.trickMagicEntry=s.trickMagicEntry;let p=r.getFlag("pf2e","origin.variant.overlays"),m=r.getFlag("pf2e","origin.castRank")??s.rank;(u.loadVariant({overlayIds:p,castRank:m})??u).rollDamage(this.#t)}else{let l=s.toObject(),d=l.system.damage,u=l.system.heightening??{};o(d,u),s.clone({"system.damage":d,"system.heightening":u}).rollDamage(this.#t)}s.damageKinds.size&&zt(r),this.close()}#r(t){t.preventDefault(),this.close()}};var jn=G("renderChatMessage",us,Jc);function ls(){return{settings:[{key:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>jn(e,"multi-cast")},{key:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>jn(e,"merge-damage")}],init:e=>{jn(!1,["multi-cast","merge-damage"],!0)}}}a(ls,"registerMerge");function Jc(){for(let{message:e,html:t}of Ve(10))t.find("[data-action=multi-cast]").remove(),t.find("[data-action=merge-damage]").remove(),us(e,t)}a(Jc,"updateMessages");function us(e,t){!game.user.isGM&&!e.isAuthor||(T("merge-damage")&&ps(e)?el(e,t):T("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&Zc(e,t))}a(us,"renderChatMessage");function Zc(e,t){if(!e.item)return;let r=t.find(".message-content .chat-card .owner-buttons .spell-button");r.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${N("merge.spell.button")}</button>`),r.find("[data-action=multi-cast]").on("click",s=>{new Gt(s,e).render(!0)})}a(Zc,"renderSpell");function el(e,t){let n='<span class="pf2e-toolbelt-merge">';if(P(e,"merge.merged")){let o=N("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${o}">`,n+='<i class="fa-duotone fa-split"></i>'}let r=N("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${r}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let s=os(e),i=cs(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",o=>{o.stopPropagation();for(let{message:c}of Ve(5,e)){let l=cs(c);if(!(!ps(c)||os(c)!==s||!mn(i?.map(d=>d.actor).filter(Boolean),l?.map(d=>d.actor).filter(Boolean)))){nl(o,e,c,{actorUUID:s,targetUUIDs:i});return}}K("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",o=>{o.stopPropagation(),tl(o,e)})}a(el,"renderDamage");async function tl(e,t){let n=P(t,"merge.data").flatMap(r=>r.source);await fs(t.id),await ChatMessage.implementation.createDocuments(n)}a(tl,"splitDamages");async function nl(e,t,n,{actorUUID:r,targetUUIDs:s}){let i={},o=ss(n).concat(ss(t));for(let{name:g,notes:y,outcome:w,modifiers:E,tags:x}of o){i[g]??={name:g,tags:x,notes:new Set,results:[]};for(let M of y)i[g].notes.add(M);i[g].results.some(M=>M.outcome===w&&mn(M.modifiers,E))||i[g].results.push({outcome:w,modifiers:E})}let c=Object.values(i).map(g=>{g.label=g.name;for(let y of g.results)y.outcome&&(y.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${y.outcome}`));return g});c.at(-1).isLastGroup=!0;let l=await z("merge/merged",{groups:c,hasMultipleGroups:c.length>1}),d=is(t),u=is(n),p=[];for(let g of[].concat(u,d)){let{options:y,total:w,terms:E}=g,x=E[0],C=g.formula.replaceAll(/(\[[\w,-]+\])/g,"").replace(/^\(/,"").replace(/\)$/,""),M=p.find(({options:{flavor:L,critRule:q}})=>L===y.flavor&&q===y.critRule);M?(M.terms.push(x),M.total+=w,M.formulas.push(C)):p.push({options:y,formulas:[C],total:w,terms:[x]})}let m=_r();for(let g of p){if(g.options.flavor.includes("persistent")){let{index:y}=g.formulas.reduce((w,E,x)=>{let C=new m(E).expectedValue;return C<=w.value?w:{value:C,index:x}},{value:0,index:-1});g.formulas=[g.formulas[y]],g.terms=[g.terms[y]]}g.formula=`(${g.formulas.join(" + ")})[${g.options.flavor}]`,g.term=g.terms.length<2?g.terms[0]:ds(g.terms)}let v={class:"DamageRoll",options:{},dice:[],formula:`{${p.map(({formula:g})=>g).join(", ")}}`,total:p.reduce((g,{total:y})=>g+y,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:p.map(({formula:g})=>g),modifiers:[],rolls:p.map(({options:g,formula:y,total:w,term:E})=>({class:"DamageInstance",options:g,dice:[],formula:y,total:w,terms:[E],evaluated:!0})),results:p.map(({total:g})=>({result:g,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let g=a(y=>{if("results"in y)for(let w of y.results)w.hidden=!0;else{let w=(y.term??y).operands??[];for(let E of w)g(E)}},"setHidden");for(let y of v.terms[0].rolls)for(let w of y.terms)g(w)}await fs(t.id,n.id),await ChatMessage.implementation.create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[F.id]:{merge:{actor:r,targets:s,merged:!0,type:"damage-roll",data:o},target:{targets:s}},pf2e:{context:{options:Array.from(new Set(o.flatMap(g=>g.itemTraits)))}}},rolls:[v]})}a(nl,"mergeDamages");function ss(e){let t=P(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let r=$(`<div>${e.flavor}</div>`),s=r.find("h4.action + .tags").prop("outerHTML"),i=[];r.find(".tag.tag_transparent").each(function(){i.push(this.innerHTML)});let o=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>/^(item|self):/.test(c)),modifiers:i,tags:s,notes:o}]}a(ss,"getMessageData");function fs(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}a(fs,"removeChatMessages");function ds(e){let t=deepClone(e[0].options);for(let n of e)n.options={};return{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?ds(e):e[0]]}}}a(ds,"createTermGroup");function is(e){return P(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}a(is,"getMessageRolls");function os(e){return P(e,"merge.actor")??e.actor?.uuid}a(os,"getActorUUID");function cs(e){let t=P(e,"target.targets");if(t)return t;let n=P(e,"merge.targets")??e.getFlag("pf2e","target");return Array.isArray(n)?n:n?[n]:[]}a(cs,"getTargetUUIDs");function ps(e){return P(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}a(ps,"isDamageRoll");var ms="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function gs(){return{settings:[{key:"nobulk",type:Boolean,default:!1,requiresReload:!0},{key:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{T("nobulk")&&sa("nobulk",al),T("nobulk-coins")&&Z(ms,rl,"WRAPPER")}}}a(gs,"registerNobulk");function rl(e){e();try{this.isCoinage&&(this.system.bulk.value=0)}catch{Ee("nobulk",ms)}}a(rl,"treasurePrepareBaseData");function al(){let e=this.inventory.bulk.constructor,t=null;Object.defineProperty(this.inventory.bulk,"value",{get(){return t||(t=e.computeTotalBulk(this.actor.inventory.filter(n=>!n.isInContainer&&n.system.equipped.carryType!=="dropped"),this.actor.size),t)}})}a(al,"actorPrepareEmbeddedDocuments");var sl="CONFIG.Actor.documentClass.prototype.prepareData",il="DocumentSheet.prototype._renderInner";function hs(){return{settings:[{key:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{T("share")!=="disabled"&&(Z(sl,dl,"WRAPPER"),Z(il,ol,"WRAPPER"),Hooks.on("preUpdateActor",ll),Hooks.on("deleteActor",cl),Hooks.on("updateActor",ul))}}}a(hs,"registerShare");async function ol(e,...t){let n=await e(...t);if(!pt(this,"CreatureConfig"))return n;let r=this.actor;if(!le(r)||!r.isOfType("character","npc")||rt(r).size)return n;let s=game.actors.filter(o=>o.id!==r.id&&o.isOwner&&Wt(o)).map(o=>({key:o.id,label:o.name})),i=await z("share/master",{masters:s,master:P(r,"share.master"),selectPath:Se("share.master"),i18n:H("share.templates.master")});return n.children().last().before(i),n}a(ol,"documentSheetRenderInner");function cl(e){Ss(e);let t=rt(e);Promise.all(t.map(async n=>{vs(n),await fr(n,"share.master")}))}a(cl,"deleteActor");function ll(e,t){let n=gn(t,"share");if(n?.master){let r=game.actors.get(n.master);if(Wt(r)){let s=deepClone(r._source.system.attributes.hp);setProperty(t,"system.attributes.hp",s)}}else{let r=Vt(e),s=getProperty(t,"system.attributes.hp");r&&s&&(r.update({system:{attributes:{hp:s}}},{noHook:!0}),delete t.system.attributes.hp)}}a(ll,"preUpdateActor");function ul(e,t,n,r){let s=game.user.id===r,i=gn(t,"share");if(i?.master!==void 0){let c=e;if(Ss(c),i.master){let l=game.actors.get(i.master);Wt(l)&&(ys(c,l),bs(l,c))}else vs(c)}if(!s)return;let o=rt(e);if(o.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(o.map(async d=>await d.update(l,{noHook:!0})))}else Promise.all(o.map(async l=>await fl(l,t)))}}a(ul,"updateActor");async function fl(e,t){T("share")==="force"?await ae(e,"toggle",!P(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}a(fl,"refreshActor");function dl(e){e();let t=P(this,"share.master"),n=t?game.actors.get(t):void 0;if(!Wt(n))return;Vt(this)||(ys(this,n),bs(n,this));let r=this.system.attributes.hp;Object.defineProperty(this.system.attributes,"hp",{get(){let s=n.system.attributes.hp;return pl(s,r),r},enumerable:!0})}a(dl,"prepareData");function pl(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}a(pl,"transfertHpData");function rt(e){return fe(e,"share.slaves")??new Collection}a(rt,"getSlaves");function ys(e,t){return de(e,"share.master",t)}a(ys,"setMaster");function vs(e){return ut(e,"share.master")}a(vs,"unsetMaster");function Vt(e){return fe(e,"share.master")}a(Vt,"getMaster");function Wt(e){return e&&e.type==="character"&&!Vt(e)}a(Wt,"isValidMaster");function bs(e,t){let n=rt(e);return de(e,"share.slaves",n.set(t.id,t))}a(bs,"addSlaveToMaster");function Ss(e){let t=Vt(e);if(!t)return;rt(t).delete(e.id)}a(Ss,"removeSlaveFromMaster");var ml=G("renderCharacterSheetPF2e",wl),gl=G("deleteCombat",xl),hl=G("deleteCombatant",Ds),yl=G("createCombatant",Cl),vl=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],bl=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),Sl=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function Es(){return{name:"stances",settings:[{key:"stances",type:Boolean,default:!1,scope:"client",onChange:ws}],conflicts:["pf2e-stances"],api:{getStances:Bn,toggleStance:Is,isValidStance:xs},ready:e=>{T("stances")&&ws(!0)}}}a(Es,"registerStances");function ws(e){ml(e),gl(e),hl(e),yl(e)}a(ws,"setup");function xs(e){return e?.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}a(xs,"isValidStance");function Bn(e){let t=[],n=new Set;for(let{replace:r,sourceId:s,effectUUID:i,effect:o,img:c,name:l,itemName:d,action:u}of Cs(e)){r&&n.add(r);let p=u?mt(e,u,"action"):mt(e,s,"feat");t.push({name:l,itemName:d,uuid:s,img:c,effectUUID:i,effectID:o?.id,actionUUID:p.sourceId,actionID:p.id})}return t.filter(({uuid:r})=>!n.has(r))}a(Bn,"getStances");async function wl(e,t){let n=e.actor;if(!le(n))return;let r=Bn(n);if(!r.length)return;let s=n.getActiveTokens(!0,!0).some(l=>l.inCombat),i=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),o=i.find(".actions-options"),c=await z("stances/sheet",{stances:r,canUseStances:s&&!n.isDead,i18n:H("stances")});o.length?o.after(c):i.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>El(l,n))}a(wl,"renderCharacterSheetPF2e");function El(e,t){let n=e.currentTarget,r=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!r)return;let s=n.dataset.effectUuid;Is(t,s)}a(El,"onToggleStance");function*Cs(e){for(let t of e.itemTypes.feat){let n=t.sourceId,r=bl.get(n),s=Sl.get(n);if(!r&&!s&&!xs(t))continue;let i=r?.effect??s?.effect??t.system.selfEffect.uuid,o=fromUuidSync(i);o&&(yield{name:(r&&fromUuidSync(r.replace)?.name)??t.name,itemName:t.name,replace:r?.replace,extra:s,sourceId:n,effectUUID:i,effect:mt(e,i,"effect"),action:s?.action,img:o.img})}}a(Cs,"actorStances");function ks(e){let t=[];for(let{effect:n}of Cs(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}a(ks,"getStancesEffects");async function Is(e,t){let n=ks(e),r=n.findIndex(i=>i.uuid===t),s=!1;if(r===-1)s=!0;else{let i=n.filter(c=>c.uuid!==t).length,o=n.filter(c=>c.uuid===t).length>1;(i||o)&&n.splice(r,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(i=>i.id)),s&&zn(e,t)}a(Is,"toggleStance");async function zn(e,t){let n=await fromUuid(t);if(n){let r=n.toObject();return getProperty(r,"flags.core.sourceId")||setProperty(r,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[r]))[0]?.toMessage(),!0}return!1}a(zn,"addStance");function xl(e){for(let t of e.combatants)Ds(t)}a(xl,"deleteCombat");function Ds(e){let t=As(e);if(t){if(!game.user.isGM&&fn(t)){let n=ks(t).map(r=>r.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}Ge(t)}}a(Ds,"deleteCombatant");function Cl(e){let t=As(e);t&&(!game.user.isGM&&fn(t)&&kl(t),Ge(t))}a(Cl,"createCombatant");function As(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}a(As,"getActorFromCombatant");async function kl(e){let t=Bn(e);if(!(!t.length||t.filter(({effectID:s})=>s).length||!hr(e,vl,["feat"])))if(t.length===1){let s=t[0];await zn(e,s.effectUUID)&&Ne("stances.useStance",{stance:s.name})}else Il(e,t)}a(kl,"checkForSavant");async function Il(e,t){let n=H("stances.menu");new Dialog({title:n("title"),content:await z("stances/menu",{stances:t,i18n:n.template}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:r=>zn(e,r.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}a(Il,"openStancesMenu");function Ps(){return{settings:[{key:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>Ts(e)}],conflicts:["pf2e-spells-summary"],ready:e=>{Ts()}}}a(Ps,"registerSpellsSummary");function Ts(e){(e??T("summary"))!=="disabled"?At({tabName:"spellcasting",templateFolder:"summary/sheet",getData:Hl,addEvents:Dl}):Tt("spellcasting")}a(Ts,"setup");function Dl(e,t,n){let r=e.find(".spell-type .uses .spell-slots-input input");r.on("change",s=>Al(s,n)),r.on("focus",Tl),r.on("blur",Pl),e.find(".focus-pips").on("click contextmenu",s=>Ol(s,n)),e.find(".spell-slots-increment-reset").on("click",s=>Rl(s,t,n)),e.find(".item-image").on("click",s=>Fl(s,n))}a(Dl,"addEvents");async function Al(e,t){e.preventDefault();let{inputPath:n,entryId:r}=$(e.currentTarget).data(),s=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:r,[n]:s}])}a(Al,"onUsesInputChange");function Tl(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}a(Tl,"onUsesInputFocus");function Pl(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}a(Pl,"onUsesInputBlur");function Ol(e,t){e.preventDefault();let n=e.type==="click"?1:-1,r=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":r})}a(Ol,"onToggleFocusPool");function Ml(e,t,n){if(game.modules.get("pf2e-staves")?.active){Ll(e.element).find(".directory-list.spellcastingEntry-list").find(`.item-container.spellcasting-entry[data-item-id=${n}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click();return}let r=game.modules.get("pf2e-dailies");if(!r?.active)return;let s=t.spellcasting.get(n);r.api.updateEntryCharges(s,9999)}a(Ml,"onChargesReset");function Rl(e,t,n){e.preventDefault();let{itemId:r,rank:s,isCharge:i}=$(e.currentTarget).data();if(!r)return;if(i){Ml(t,n,r);return}let o=n.items.get(r);if(o){if(o.isOfType("consumable")){let c=o.system.uses?.max;c&&o.update({"system.uses.value":c})}else if(o.isOfType("spellcastingEntry")){let c=s>=0&&s<=11?`slot${s}`:"slot0",l=o.system.slots?.[c];l&&o.update({[`system.slots.${c}.value`]:l.max})}else if(o.isOfType("spell")){let c=o.system.location.uses?.max;c&&o.update({"system.location.uses.value":c})}}}a(Rl,"onSlotsReset");async function Fl(e,t){let{entryId:n,itemId:r,castRank:s}=e.currentTarget.closest(".item").dataset,i=t.spellcasting.collections.get(n);if(!i)return;i.get(r)?.toMessage(e,{data:{castRank:Number(s??NaN)}})}a(Fl,"onItemToChat");function Ll(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}a(Ll,"getSpellcastingTab");async function Hl(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,r=game.modules.get("pf2e-dailies"),s=r?.active,i=n||s&&isNewerVersion(r.version,"2.14.0"),o=n?"flags.pf2e-staves.charges":s?"flags.pf2e-dailies.staff.charges":"",c=[],l=[],d,u=!1,p=await Promise.all(e.spellcasting.collections.map(async m=>({entry:m.entry,data:await m.entry.getSheetData({spells:m})})));for(let{entry:m,data:v}of p){if(v.isRitual){d=v.groups.flatMap((j,oe)=>j.active.map(({spell:V})=>({name:V.name,img:V.img,slotId:oe,itemId:V.id,rank:V.rank,time:V.system.time.value})).filter(Boolean));continue}let g=v.id,y=v.statistic.dc.value,w=v.name,E=v.isFocusPool,x=m.system?.prepared?.value==="charge",C=v.isInnate,M=v.isPrepared,L=v.isSpontaneous,q=v.isFlexible,ne=(()=>{if(v.category!=="items")return;let j=m.id.split("-")[0];return e.items.get(j)})(),Q=(()=>{if(!x)return;let j=s&&r.api.getSpellcastingEntryStaffData(m),{charges:oe,max:V,canPayCost:R}=j??getProperty(m,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:oe,max:V,noMax:!0,canPayCost:R??(()=>!0)}})();for(let j of v.groups){if(!j.active.length||j.uses?.max===0)continue;let oe=[],V=j.id==="cantrips",R=Br(j.id),ve=!V&&x&&!i;for(let be=0;be<j.active.length;be++){let Be=j.active[be];if(!Be||Be.uses?.max===0)continue;let{spell:ge,expended:st,virtual:Qt,uses:Xt,castRank:it}=Be;oe.push({name:ge.name,img:ge.img,range:ge.system.range.value||"-",castRank:it??ge.rank,slotId:be,entryId:g,entryDc:y,entryName:w,itemId:ge.id,inputId:C?ge.id:v.id,inputPath:ne?"system.uses.value":x?o:C?"system.location.uses.value":`system.slots.slot${R}.value`,isCharge:x,isActiveCharge:x&&i,isBroken:ve,isVirtual:Qt,isInnate:C,isCantrip:V,isFocus:E,isPrepared:M,isSpontaneous:L||q,groupId:j.id,consumable:ne,uses:ne?ne.system.uses:x?Q:Xt??j.uses,expended:x&&!V?!Q.canPayCost(R):st??(E&&!V?t.value<=0:!1),action:ge.system.time.value,type:ne?`PF2E.Item.Consumable.Category.${ne.category}`:x?Ke("summary.staff"):C?"PF2E.PreparationTypeInnate":L?"PF2E.PreparationTypeSpontaneous":q?"PF2E.SpellFlexibleLabel":E?"PF2E.TraitFocus":"PF2E.SpellPreparedLabel",order:x?0:M?1:E?2:C?3:L?4:5,noHover:M||V||ve||E})}if(oe.length){if(E)if(V)u=!0;else{l.push(...oe);continue}c[R]??=[],c[R].push(...oe)}}}if(c.length){let m=T("summary")==="sort"?(v,g)=>v.order===g.order?gt(v.name,g.name):v.order-g.order:(v,g)=>gt(v.name,g.name);for(let v of c)v&&v.sort(m)}return l.length&&(l.sort((m,v)=>gt(m.name,v.name)),c[12]=l,u=!1),{spells:c,rituals:d,focusPool:t,hasFocusCantrips:u,isOwner:e.isOwner,i18n:H("summary"),entryRank:m=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Rr(m)})}}a(Hl,"getData");var Ul={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Gn={hero:{icon:"fa-solid fa-hospital-symbol",reroll:"PF2E.RerollMenu.HeroPoint",rerolled:"PF2E.RerollMenu.MessageHeroPoint"},new:{icon:"fa-solid fa-dice",reroll:"PF2E.RerollMenu.KeepNew",rerolled:"PF2E.RerollMenu.MessageKeep.new"},lower:{icon:"fa-solid fa-dice-one",reroll:"PF2E.RerollMenu.KeepLower",rerolled:"PF2E.RerollMenu.MessageKeep.lower"},higher:{icon:"fa-solid fa-dice-six",reroll:"PF2E.RerollMenu.KeepHigher",rerolled:"PF2E.RerollMenu.MessageKeep.higher"}},$l=["criticalFailure","failure","success","criticalSuccess"],Nl=G("preCreateChatMessage",Gl),Rs=Zr("renderChatMessage",Us),Fs=G("createMeasuredTemplate",Bl),Yt=ke("target",ql);function Ls(){return{settings:[{key:"target",type:Boolean,default:!1,requiresReload:!0},{key:"target-client",type:String,default:"disabled",choices:["disabled","small","big"],scope:"client",onChange:e=>Rs(e&&T("target"))},{key:"target-template",type:Boolean,default:!1,scope:"client",onChange:e=>Fs(e&&T("target"))}],conflicts:[],init:e=>{!e||!T("target")||Hooks.on("getChatLogEntryContext",jl)},ready:e=>{if(T("target")){_l(e);for(let{message:t,html:n}of Ve(10))Us(t,n)}}}}a(Ls,"registerTargetTokenHelper");function _l(e){Nl(!0),Rs(!0),Fs(T("target-template")),e&&Yt.activate()}a(_l,"setHooks");function ql(e){if(ht())switch(e.type){case"target.update-save":Wn(e);break;case"target.update-applied":zs(e);break}}a(ql,"onSocket");function jl(e,t){let n=a(r=>{let s=r.data("messageId"),i=game.messages.get(s);if(!i)return;let o=fe(i,"target");if(o)return{message:i,inMemory:o}},"getMessageData");t.unshift({icon:'<i class="fa-solid fa-dice-d20"></i>',name:Ke("target.chat.context.saves.name"),condition:r=>!!n(r)?.inMemory.canRollSave?.length,callback:r=>{let{inMemory:s,message:i}=n(r)??{},o=s.canRollSave;if(!o?.length)return;let c=qs(i);c&&Bs({target:r.find(".pf2e-toolbelt-target-damage")[0]},i,c,o)}})}a(jl,"getChatLogEntryContext");async function Bl(e,t,n){let r=game.user;if(r.id!==n)return;let s=H("target.menu"),i=e.item,o=e.actor,c=o?o.token??o.getActiveTokens()[0]:void 0,l={title:i?.name||s("title"),content:await z("target/template-menu",{i18n:s.template,noSelf:!c}),buttons:{select:{icon:'<i class="fa-solid fa-bullseye-arrow"></i>',label:s("target"),callback:y=>({targets:y.find("[name=targets]:checked").val(),self:y.find("[name=self]").prop("checked"),neutral:y.find("[name=neutral]").prop("checked")})}},close:()=>null},d=await Dialog.wait(l,void 0,{id:"pf2e-toolbelt-target-template",width:260});if(!d)return;let u=o?o.alliance:r.isGM?"opposition":"party",p=u==="party"?"opposition":u==="opposition"?"party":null,g=Gr(e).filter(y=>{if(!y.actor?.isOfType("creature","hazard","vehicle")||y.document.hidden)return!1;if(c&&y===c)return d.self;let E=y.actor?y.actor.alliance:y.alliance;return E===null?d.neutral:d.targets==="all"||d.targets==="allies"&&E===u||d.targets==="enemies"&&E===p}).map(y=>y.id);r.updateTokenTargets(g),r.broadcastActivity({targets:g})}a(Bl,"createMeasuredTemplate");var Os;function zl(e){return Os??=(()=>{let t=[game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage"),game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage")];return new RegExp(`^<div>(${t.join("|")})</div>`)})(),Os.test(e.flavor)}a(zl,"isRegenMessage");function Hs(e){return!e.rolls[0].options.evaluatePersistent}a(Hs,"isValidDamageMessage");function Gl(e){let t=e.isDamageRoll,n=[];if(!(t&&!Hs(e))){if(t&&!P(e,"target")){let r=e.token,s=r?.actor,i=zl(e),o=i?s?[{token:r.uuid,actor:s.uuid}]:[]:Array.from(game.user.targets.map(c=>({token:c.document.uuid,actor:c.actor.uuid})));if(n.push(["targets",o]),i&&n.push(["isRegen",!0]),e.rolls.length===2){let c=e.rolls.filter(u=>u.options),l=c.findIndex(u=>u.options.splashOnly),d=c.findIndex(u=>!u.options.splashOnly&&u.options.damage?.modifiers.some(p=>p.damageCategory==="splash"));l!==-1&&d!==-1&&n.push(["splashIndex",l])}}if(t||e.getFlag("pf2e","context.type")==="spell-cast"){let r=e.item,s=r&&r.type==="spell"&&r.system.defense?.save;if(s){let i=r.spellcasting?.statistic.dc.value;typeof i=="number"&&n.push(["save",{...s,dc:i}])}}n.length&&We(e,"target",n.reduce((r,[s,i])=>(r[s]=i,r),{}))}}a(Gl,"preCreateChatMessage");async function Us(e,t){let n=T("target-client")!=="disabled";if(ut(e,"target.canRollSave"),n&&e.isDamageRoll){if(!Hs(e))return;await Wl(e,t),Ms(e);return}let r=e.item;if(!(!r||r.type!=="spell")){if(n&&!r.damageKinds.size){await Vl(e,t,r),Ms(e);return}r.system.defense?.save&&cr(e)&&t.find("[data-action=spell-damage]").on("click",()=>{zt(e)})}}a(Us,"renderChatMessage");function Ms(e){Promise.all([ui.chat,ui.chat._popout].map(async t=>{let n=t?.element[0]?.querySelector("#chat-log");!n||!t.isAtBottom&&e.user._id!==game.user._id||(await t._waitForImages(),n.scrollTop=n.scrollHeight)}));for(let t of Object.values(e.apps))t instanceof ChatPopout&&t.rendered&&t.setPosition()}a(Ms,"refreshMessage");async function Vl(e,t,n){let r=await js(e);if(!r)return;let{targets:s,save:i}=r,o=t.find(".message-content"),c=o.find(".card-buttons");if(game.user.isGM||e.isAuthor){let d=c.find("[data-action=spell-save]"),u=$('<div class="pf2e-toolbelt-target-wrapper"></div>'),p=N("target.chat.targets.tooltip"),m=$(`<button class="pf2e-toolbelt-target-targets" title="${p}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);m.on("click",v=>$s(v,e)),u.append(m),u.append(d),c.prepend(u)}if(n?.area&&!n.traits.has("aura")&&canvas.scene?.templates.some(u=>u.message===e&&u.isOwner)&&c.find(".owner-buttons .hidden.small").removeClass("hidden"),!s.length)return;let l=$('<div class="pf2e-toolbelt-target-spell"></div>');for(let{template:d}of s)l.append("<hr>"),l.append(d);o.after(l),_s(e,l,i)}a(Vl,"renderSpellChatMessage");function $s(e,t){e.stopPropagation();let n=game.user.targets;ae(t,"target.targets",Array.from(n.map(r=>({token:r.document.uuid,actor:r.actor.uuid}))))}a($s,"addTargets");async function Wl(e,t){let n=await js(e),r=t.find(".message-content"),s=r.find(".damage-application"),i=$('<div class="pf2e-toolbelt-target-buttons"></div>');if(n?.targets.length&&s.length){let u=a(()=>{let v=!!fe(e,"target.expanded");m.toggleClass("collapse",v),s.toggleClass("hidden",!v)},"toggleDamageRow"),p=N("target.chat.toggle.tooltip"),m=$(`<button class="toggle" title="${p}">
    <i class="fa-solid fa-plus expand"></i>
    <i class="fa-solid fa-minus collapse"></i>
</button>`);u(),m.on("click",v=>{v.stopPropagation(),de(e,"target.expanded",!fe(e,"target.expanded")),u()}),i.append(m)}if(n?.isRegen!==!0&&(game.user.isGM||e.isAuthor)){let u=N("target.chat.targets.tooltip"),p=$(`<button class="targets" title="${u}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);p.on("click",m=>$s(m,e)),i.append(p)}if(t.find(".dice-result .dice-total").append(i),!n?.targets.length)return;let o=s.clone();if(!o.length)return;o.removeClass("damage-application").addClass("target-damage-application"),T("target-client")!=="big"&&o.find("button").addClass("small"),o.find("[data-action]").each(function(){let u=this.dataset.action;this.dataset.action=`target-${u}`});let{targets:c,save:l}=n,d=$('<div class="pf2e-toolbelt-target-damage"></div>');for(let{uuid:u,template:p,save:m,isOwner:v,applied:g={}}of c){if(d.append("<hr>"),d.append(p),!v)continue;let y=!!(m?.result&&m.basic),w=o.clone();w.each((E,x)=>{x.dataset.rollIndex=E,x.dataset.targetUuid=u,x.classList.toggle("applied",!!g[E]||y&&m.result.success==="criticalSuccess"),y&&x.classList.add(m.result.success)}),d.append(w)}r.after(d),_s(e,d,l),d.find("button[data-action^=target-]").on("click",u=>Jl(u,e))}a(Wl,"renderDamageChatMessage");function Vn(e){return e.target?.closest(".pf2e-toolbelt-target-damage")}a(Vn,"getRowsElement");function Ns(e){Vn(e)?.classList.add("disable-saves")}a(Ns,"disableSaveListeners");function Yl(e){Vn(e)?.classList.remove("disable-saves")}a(Yl,"enableSaveListeners");function _s(e,t,n){let r=a(s=>{let i=s.target.closest("[data-action]");if(!i)return;let o=i.dataset.action,c=a(()=>!Vn(s)?.classList.contains("disable-saves"),"saveEnabled");switch(o){case"ping-target":{Xl(s);break}case"open-target-sheet":{Ql(s);break}case"roll-save":{c()&&Bs(s,e,n);break}case"reroll-save":{c()&&Kl(s,e,n);break}}},"listener");t.on("click",r)}a(_s,"addHeaderListeners");function qs(e){let t=P(e,"target.save");if(t)return{...t,...Ul[t.statistic]}}a(qs,"getSaveData");async function js(e){let t=game.user.isGM,n=P(e,"target.targets")??[],r=t||game.settings.get("pf2e","metagame_showDC"),s=t||game.settings.get("pf2e","metagame_showBreakdowns"),i=t||game.settings.get("pf2e","metagame_showResults"),o=qs(e);if(!n.length&&!o)return;if(o){let d=game.i18n.format("PF2E.SavingThrowWithName",{saveName:game.i18n.localize(o.label)}),u=r?N("target.chat.save.dcWithValue",{dc:o.dc}):"";o.tooltipLabel=`${d} ${u}`,o.tooltip=await z("target/save-tooltip",{check:o.tooltipLabel})}let c=[],l=(await Promise.all(n.map(async({token:d})=>{let u=await fromUuid(d),p=u.id,m=u.actor;if(!m)return;let v=!m.hasCondition("undetected");if(!t&&!v)return;let g=m.isOwner,y=m.hasPlayerOwner,w=g||y,E=o&&!!m?.saves[o.statistic],x=P(e,`target.saves.${p}`);E&&!y&&!x&&c.push(d);let C=await(async()=>{if(!E||!x)return;let Q=x.rerolled,j=E&&g&&!Q,oe=game.i18n.localize(`PF2E.Check.Result.Degree.Check.${x.success}`),V=x.value-o.dc,R=w||i?N(`target.chat.save.result.${r?"withOffset":w?"withoutOffsetWithDie":"withoutOffset"}`,{success:oe,offset:V>=0?`+${V}`:V,die:`<i class="fa-solid fa-dice-d20"></i> ${x.die}`}):void 0;return{...x,canReroll:j,tooltip:await z("target/save-tooltip",{i18n:H("target.chat.save"),check:o.tooltipLabel,result:R,modifiers:w||s?x.modifiers:[],canReroll:j,rerolled:Gn[Q]})}})(),M=o&&{...o,result:C},L=game.modules.get("anonymous"),q=t?!0:L?.active?L.api.playersSeeName(u.actor):!game.pf2e.settings.tokens.nameVisibility||u.playersCanSeeName,ne=q?u.name:L?.active?L.api.getName(u.actor):N("unnamed");return{isOwner:g,canSeeName:q,hasPlayerOwner:y,uuid:d,target:u,save:M,applied:P(e,`target.applied.${p}`),template:await z("target/row-header",{name:ne,isGM:t,isOwner:g,hasPlayerOwner:y,isHidden:!v,uuid:d,showSuccess:w||i,save:E&&M,canReroll:C?.canReroll,rerolled:Gn[C?.rerolled],i18n:H("target.chat.row")})}}))).filter(Boolean);return de(e,"target.canRollSave",c),t?l.sort((d,u)=>d.hasPlayerOwner-u.hasPlayerOwner):l.sort((d,u)=>!d.isOwner&&!u.isOwner?u.hasPlayerOwner-d.hasPlayerOwner:u.isOwner-d.isOwner),{targets:l,save:o,isRegen:P(e,"target.isRegen")}}a(js,"getMessageData");async function Kt(e){let{targetUuid:t}=e.target.closest("[data-target-uuid]").dataset;return fromUuid(t)}a(Kt,"getTargetFromEvent");async function Kl(e,t,{dc:n}){let r=await Kt(e),s=r?.actor;if(!s)return;let i=P(t,`target.saves.${r.id}`);if(!i?.roll||i.rerolled)return;let o=s.isOfType("character")?s.heroPoints.value:0,c=Object.entries(Gn).map(([C,{icon:M,reroll:L}])=>{if(C==="hero"&&!o)return;let q=game.i18n.localize(L);return`<label><input type="radio" name="reroll" value="${C}"><i class="${M}"></i> ${q}</label>`}).filter(Boolean).join(""),l={yes:{icon:'<i class="fa-solid fa-rotate rotate"></i>',label:"reroll",callback:C=>C.find("[name=reroll]:checked").val()??null},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:"cancel",callback:()=>null}};Ns(e);let d=await Dialog.wait({title:`${r.name} - ${N("target.chat.save.reroll.confirm.title")}`,content:c,buttons:l,close:()=>null},{id:`pf2e-toolbelt-target-save-reroll-dialog-${r.id}`});if(!d){Yl(e);return}let u=d==="hero",p=u?"new":d;if(u){let{value:C,max:M}=s.heroPoints;if(C<1){K("target.chat.save.reroll.noPoints");return}await s.update({"system.resources.heroPoints.value":Math.clamped(C-1,0,M)})}let m=Roll.fromJSON(i.roll),v=m.clone();v.options.isReroll=!0,Hooks.callAll("pf2e.preReroll",Roll.fromJSON(i.roll),v,u,p);let g=await v.evaluate({async:!0});await Cn(g),Hooks.callAll("pf2e.reroll",Roll.fromJSON(i.roll),g,u,p);let y=p==="higher"&&m.total>g.total||p==="lower"&&m.total<g.total?m:g;if(y===g){let C=new It(g,n,i.dosAdjustments);y.options.degreeOfSuccess=C.value}let w=game.user.isGM||t.isAuthor,E={value:y.total,die:y.dice[0].total,success:y.degreeOfSuccess,roll:JSON.stringify(y.toJSON()),dosAdjustments:deepClone(i.dosAdjustments),modifiers:deepClone(i.modifiers),rerolled:d};y.options.keeleyAdd10&&E.modifiers.push({label:N("target.chat.save.reroll.keeley"),modifier:10});let x={type:"target.update-save",message:w?t:t.id,targets:[{target:r.id,data:E}]};game.user.isGM||t.isAuthor?Wn(x):Yt.emit(x)}a(Kl,"rerollSave");async function Bs(e,t,{dc:n,statistic:r},s){let i=game.user.isGM||t.isAuthor,o=Array.isArray(s)?s.map(l=>fromUuid(l)):[Kt(e)],c={type:"target.update-save",message:i?t:t.id,targets:[]};Ns(e),await Promise.all(o.map(async l=>{let d=await l,u=d?.actor;if(!u)return;let p=u.saves[r];if(!p)return;let m=(()=>{let g=t.item;if(g)return g;let y=P(t,"target.messageId");if(!y)return;let w=game.messages.get(y);if(w)return w.item})(),v=!game.user.settings.showCheckDialogs;return new Promise(g=>{p.check.roll({dc:{value:n},item:m,origin:u,skipDialog:e.shiftKey?!v:v,createMessage:!1,callback:async(y,w,E)=>{await Cn(y);let x={value:y.total,die:y.dice[0].total,success:y.degreeOfSuccess,roll:JSON.stringify(y.toJSON()),dosAdjustments:E.getFlag("pf2e","context.dosAdjustments"),modifiers:E.getFlag("pf2e","modifiers").filter(C=>C.enabled).map(({label:C,modifier:M})=>({label:C,modifier:M}))};c.targets.push({data:x,target:d.id}),g()}})})})),i?Wn(c):Yt.emit(c)}a(Bs,"rollSave");async function Wn({targets:e,message:t}){if(typeof t=="string"&&(t=game.messages.get(t),!t))return;let n={};for(let{data:r,target:s}of e)typeof r.success=="number"&&(r.success=$l[r.success]),n[s]=deepClone(r);await ae(t,"target.saves",n)}a(Wn,"updateMessageSave");async function Ql(e){let t=await Kt(e);t&&t.actor?.sheet.render(!0)}a(Ql,"openTargetSheet");async function Xl(e){if(!canvas.ready)return;let t=await Kt(e);t&&canvas.ping(t.center)}a(Xl,"pingTarget");async function Jl(e,t){let n=e.currentTarget,{rollIndex:r,targetUuid:s}=n.closest("[data-target-uuid]").dataset,i=await fromUuid(s);if(!i)return;let o=n.dataset.action;if(o==="target-shield-block"){let l=t.id;n.classList.contains("shield-activated")||bt(l),requestAnimationFrame(()=>{Nr(i,n,t.element)});return}Sn({message:t,multiplier:o==="target-apply-healing"?-1:o==="target-half-damage"?.5:o==="target-apply-damage"?1:o==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:Number(r),tokens:[i],onDamageApplied:Zl})}a(Jl,"onTargetButton");function Zl(e,t,n){let r={};for(let s of t){let i=s.id;Ye(r,`target.applied.${i}.${n}`,!0);let o=P(e,"target.splashIndex");if(o!==void 0){let c=o===0?1:0;if(n===o)Ye(r,`target.applied.${i}.${c}`,!0);else{Ye(r,`target.applied.${i}.${o}`,!0);let l=P(e,"target.targets")??[];for(let d of l){let u=d.token?.split(".").at(-1);u!==i&&Ye(r,`target.applied.${u}.${c}`,!0)}}}}game.user.isGM||e.isAuthor?zs({message:e,updates:r}):Yt.emit({type:"target.update-applied",message:e.id,updates:r})}a(Zl,"onDamageApplied");function zs({message:e,updates:t}){typeof e=="string"&&(e=game.messages.get(e),!e)||e.update(t)}a(zs,"updateMessageApplied");var at=null,Te=null;function Vs(){return{settings:[{key:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:Gs}],conflicts:["pf2e-unided"],init:()=>{Gs()}}}a(Vs,"registerUnided");function Gs(e){let t=e??T("unided");t==="disabled"?(at&&(Hooks.off("preCreateItem",at),at=null),Te&&(Hooks.off("preUpdateItem",Te),Te=null)):(at||(at=Hooks.on("preCreateItem",eu)),t==="all"&&!Te?Te=Hooks.on("preUpdateItem",tu):t!=="all"&&Te&&(Hooks.off("preUpdateItem",Te),Te=null))}a(Gs,"setHooks");function eu(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}a(eu,"preCreateItem");function tu(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}a(tu,"preUpdateItem");var nu=G("updateCombat",ru);function Ws(){return{settings:[{key:"force-untarget",type:Boolean,default:!1,onChange:Yn},{key:"untarget",type:Boolean,default:!1,scope:"client",onChange:Yn}],init:()=>{Yn()}}}a(Ws,"registerUntarget");function Yn(){nu(T("force-untarget")||T("untarget"))}a(Yn,"setup");function ru(e,t){if(!("turn"in t)&&!("round"in t))return;let n=game.user;n.updateTokenTargets(),n.broadcastActivity({targets:[]})}a(ru,"updateCombat");var je=H("macros.condition");async function Ys(e){let t=a((u,p)=>{let m=u.find("[name=condition]"),{name:v,slug:g,img:y}=m.find(":selected").data();return{type:p,slug:g,img:y,name:u.find("[name=name]").val().trim()||je("effect-name",{condition:v}),uuid:m.val(),badge:Number(u.find("[name=badge]").val()||1),unidentified:u.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:je("generate"),callback:u=>t(u,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:je("add"),callback:u=>t(u,"add")}},r=Array.from(game.pf2e.ConditionManager.conditions.values()),s=new Set(r.filter(u=>!!u.badge).map(u=>u.slug)),i=await z("macros/condition",{i18n:je.template,conditions:Array.from(new Set(r.sort((u,p)=>u.name.localeCompare(p.name))))}),o=a(u=>{let{name:p,slug:m}=u.find("[name=condition] :selected").data();u.find("[name=name]").prop("placeholder",je("effect-name",{condition:p}));let v=s.has(m),g=u.find("[name=badge]");g.prop("disabled",!v),v||g.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:i,title:je("title"),close:()=>null,render:u=>{o(u),u.find("[name=condition]").on("change",()=>o(u))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&s.has(c.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let d={name:c.name,type:"effect",img:c.img,system:{rules:[l],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(d):await e.createEmbeddedDocuments("Item",[d])}a(Ys,"permaConditionEffect");Cr("pf2e-toolbelt");var Kn=[Qr(),gs(),Ls(),la(),qa(),Vs(),ls(),na(),Ps(),Es(),pa(),hs(),Ws(),Ha(),ta(),ns()],Ks=new Set,Qn=null;Hooks.once("init",()=>{let e=Er(),t=Kn.flatMap(({settings:i})=>i??[]),n=t.filter(({scope:i})=>!i||i==="world"),r=t.filter(({scope:i})=>i==="client");for(let i of[n,r].flat())br(i);e&&(Qn=r[0].key,Hooks.on("renderSettingsConfig",au));let s=kr();s.api={macros:{permaConditionEffect:Ys}};for(let i of Kn){let{init:o,conflicts:c=[],api:l,name:d,socket:u}=i;if(e)for(let p of c){let m=game.modules.get(p);m?.active&&(i.conflicting=!0,Ks.add(m.title))}l&&d&&(s.api[d]=l),!i.conflicting&&o&&o(e)}wr(ia)});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Kn)!t&&n&&n(e);if(e)for(let t of Ks)K("module-conflict",{name:t},!0)});function au(e,t){if(!Qn)return;let n=F.id;t.find(`.tab[data-tab=${n}] [data-setting-id="${n}.${Qn}"]`).before(`<h3>${N("settings.client")}</h3>`)}a(au,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
