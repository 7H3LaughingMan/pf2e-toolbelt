(()=>{var Zr=Object.defineProperty;var o=(e,t)=>Zr(e,"name",{value:t,configurable:!0});var be="handwraps-of-mighty-blows";function Tt(e){return e.getFlag("core","sourceId")}o(Tt,"getSourceId");function eo(e,t){let n=Tt(e);return n?t.includes(n):!1}o(eo,"includesSourceId");function xt(e){return Array.isArray(e)?t=>eo(t,e):t=>Tt(t)===e}o(xt,"getItemSourceIdCondition");function At(e,t=[]){let n=typeof t=="string"?[t]:t;return n.length?n.flatMap(r=>e.itemTypes[r]):e.items}o(At,"getItems");function Pt(e,t,n){return At(e,n).some(xt(t))}o(Pt,"hasItemWithSourceId");function ve(e,t,n){return At(e,n).find(xt(t))}o(ve,"getItemWithSourceId");function Xe(e){return e.traits.has("invested")}o(Xe,"canBeInvested");function Ot(e){return e.system.equipped.inSlot!=null}o(Ot,"hasWornSlot");function to(e){return e.system.usage.type==="worn"&&e.system.equipped.inSlot}o(to,"isWornAs");function Ze(e){return e.isInvested||to(e)}o(Ze,"isInvestedOrWornAs");function Se(e){return e.isOfType("weapon")&&e.slug===be&&e.category==="unarmed"}o(Se,"isHandwrapsOfMightyBlows");function Ce(e){return e.system.usage.type==="held"}o(Ce,"isHeld");function we(e){return Ce(e)&&e.system.usage.value==="held-in-two-hands"}o(we,"isTwoHanded");function Mt(e){return Ce(e)&&e.system.usage.value==="held-in-one-hand"}o(Mt,"isOneHanded");function no(e,t){let n=e.system.usage;return n.type==="worn"&&n.where?t:void 0}o(no,"inSlotValue");function ro(e,t){let n=t??!e.system.equipped.invested;return e.traits.has("invested")?n:void 0}o(ro,"toggleInvestedValue");function Ee(e,{carryType:t="worn",handsHeld:n=0,inSlot:r,invested:a,containerId:s}){let i={_id:e.id,system:{equipped:{carryType:t,handsHeld:n,inSlot:no(e,r),invested:ro(e,a)}}};return s!==void 0&&(i.system.containerId=s),i}o(Ee,"itemCarryUpdate");var C="pf2e-toolbelt";function L(e,t,n="WRAPPER"){return libWrapper.register(C,e,t,n)}o(L,"registerWrapper");function Rt(e){libWrapper.unregister(C,e)}o(Rt,"unregisterWrapper");function W(e,t){console.error(`an error occured in the feature '${e}' of the module '${C}' with the wrapper: '${t}'`)}o(W,"wrapperError");function x(...e){let[t,n]=e;return t=`${C}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}o(x,"localize");function oo(e){return game.i18n.has(`${C}.${e}`,!1)}o(oo,"hasLocalization");function ao(e){return`${C}.${e}`}o(ao,"localizePath");function A(e){let t=o((...n)=>x(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>O(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>te(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>B(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>oo(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>ao(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:r})=>t(n,r),enumerable:!1,configurable:!1}}),t}o(A,"subLocalize");function et(e,t,n,r){let a=typeof t=="string"?t:"info",s=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:r??!1;ui.notifications.notify(x(e,s),a,{permanent:i})}o(et,"notify");function O(...e){let[t,n,r]=e;et(t,"warning",n,r)}o(O,"warn");function te(...e){let[t,n,r]=e;et(t,"info",n,r)}o(te,"info");function B(...e){let[t,n,r]=e;et(t,"error",n,r)}o(B,"error");function S(e){return game.settings.get(C,e)}o(S,"getSetting");function Lt(e,t){return game.settings.set(C,e,t)}o(Lt,"setSetting");function Ie(e){return S(e)!=="disabled"}o(Ie,"choiceSettingIsEnabled");var $t="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Ft="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Ht="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Ut="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData";function _t(){return{settings:[{name:"auto-runes",type:String,default:"disabled",choices:["disabled","force","lower"],requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{let e=S("auto-runes");e!=="disabled"&&(L($t,lo,"WRAPPER"),L(Ft,uo,"WRAPPER"),L(Ht,mo,"WRAPPER"),L(Ut,go,"WRAPPER"),e==="force"&&Hooks.on("renderPhysicalItemSheetPF2e",ho))},ready:e=>{e&&Ie("auto-runes")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),te("arp.forceVariant"))}}}o(_t,"registerArp");function le(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}o(le,"isValidActor");var so={1:35,2:935,3:8935,4:8935},io={1:65,2:1065,3:31065};function co(e){return["shield-boss","shield-spikes"].includes(e._source.system.baseItem)}o(co,"isShieldWeapon");function Nt(e){let t=e._source.system.traits.value,{group:n,category:r,slug:a}=e._source.system;return r==="unarmed"&&a!==be?!!e.actor.itemTypes.weapon.find(s=>s.slug===be&&s.category==="unarmed"&&s.isEquipped&&s.isInvested):(n!=="shield"||co(e))&&!t.includes("alchemical")&&!t.includes("bomb")}o(Nt,"isValidWeapon");function lo(e){try{let t=this.actor;if(!le(t,!0)||!Nt(this))return e();let n=this._source.system.traits.value;if(n.includes("alchemical")&&n.includes("bomb"))return e();let r=t.level,a=S("auto-runes")==="force",s=r<2?null:r<10?1:r<16?2:3,i=r<4?null:r<12?1:r<19?2:3;(this.system.runes.potency<=s||a)&&(this.system.runes.potency=s),(this.system.runes.striking<=i||a)&&(this.system.runes.striking=i)}catch{W("auto-runes",$t)}e()}o(lo,"onPrepareWeaponData");function uo(e){e();try{if(!le(this.actor)||this.isSpecific||!Nt(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=so[n]);let r=this.system.runes.striking;r&&(t.gp-=io[r]),t=new game.pf2e.Coins(t),(n||r)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{W("auto-runes",Ft)}}o(uo,"onPrepareWeaponDerivedData");var fo={1:160,2:1060,3:20560,4:20560},po={1:340,2:3440,3:49440};function qt(e){return!0}o(qt,"isValidArmor");function mo(e){try{let t=this.actor;if(!le(t,!0)||!qt(this))return e();let n=t.level,r=S("auto-runes")==="force",a=n<5?null:n<11?1:n<18?2:3,s=n<8?null:n<14?1:n<20?2:3;(this.system.runes.potency<=a||r)&&(this.system.runes.potency=a),(this.system.runes.resilient<=s||r)&&(this.system.runes.resilient=s)}catch{W("auto-runes",Ht)}e()}o(mo,"onPrepareArmorData");function go(e){e();try{if(!le(this.actor)||this.isSpecific||!qt(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=fo[n]);let r=this.system.runes.resilient;r&&(t.gp-=po[r]),t=new game.pf2e.Coins(t),(n||r)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{W("auto-runes",Ut)}}o(go,"onPrepareArmorDerivedData");function ho(e,t){let n=e.item;if(!n||!n.isOfType("weapon","armor")||!le(n.actor,!0))return;let r=["potency","striking","resilient"].map(a=>`[name="system.runes.${a}"]`).join(", ");t.find(`[data-tab=details] fieldset .form-group:has(${r})`).hide()}o(ho,"renderPhysicalItemSheetPF2e");function P(e,t,n=()=>{}){let r=null;return(a,s=[],i=!1)=>{let l=a||(typeof s=="string"?[s]:s).some(u=>S(u));l&&!r?r=Hooks.on(e,t):!l&&r&&(Hooks.off(e,r),r=null),i||n(l)}}o(P,"createHook");function ke(e,t,n=()=>{}){let r=null;return(a,s=!1)=>{a==="disabled"&&r?(Hooks.off(e,r),r=null):a!=="disabled"&&!r&&(r=Hooks.on(e,t)),s||n(a)}}o(ke,"createChoicesHook");function Gt(e,t){let n=Hooks.on(e,t),r=Hooks.events[e].findIndex(a=>a.id===n);if(r!==0){let[a]=Hooks.events[e].splice(r,1);Hooks.events[e].unshift(a)}return n}o(Gt,"registerUpstreamHook");var yo=P("renderApplication",tt),bo=P("renderActorSheet",tt),vo=P("renderItemSheet",tt);function jt(){return{settings:[{name:"debug",type:Boolean,default:!1,config:!1,scope:"client",onChange:e=>Bt(e)}],init:()=>{Bt()}}}o(jt,"registerDebug");function Bt(e){let t=e??S("debug");yo(t),bo(t),vo(t)}o(Bt,"setup");function tt(e,t){let n=t.find(".document-id-link")[0];n&&n.addEventListener("click",r=>{if(!r.shiftKey)return;let a=e.object;if(!a)return;r.preventDefault(),r.stopPropagation();let s=a.type,i=2,c=s;for(;window[c];)c=`${s}${i++}`;window[c]=a,console.log(c,a)},!0)}o(tt,"onRender");var nt=P("renderEffectsPanel",Co,So);function zt(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>nt(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>nt(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{nt(!1,["effect-remove","condition-sheet"])}}}o(zt,"registerEffectsPanelHelper");function So(){game.pf2e.effectPanel?.render()}o(So,"refreshEffectsPanel");function Co(e,t){let n=`<div>${x("effects.remove")}</div>`,r='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',a=t.find(".effect-item[data-item-id]").toArray();for(let s of a){let i=s.dataset.itemId,c=e.actor?.items.get(i);if(c&&(S("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(s.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),s.querySelector(".icon").addEventListener("contextmenu",l=>Eo(l,e),!0)),S("condition-sheet")&&c.isOfType("condition"))){let l=s.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",r),l.querySelector('[data-action="edit"]').addEventListener("click",u=>wo(u,e))}}}o(Co,"renderEffectsPanel");function wo(e,t){let n=Wt(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}o(wo,"onConditionSheet");function Eo(e,t){if(!e.shiftKey)return;let n=Wt(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}o(Eo,"onRemoveEffect");function Wt(e,t){let a=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(a)}o(Wt,"getEffect");var De=class extends FormApplication{static{o(this,"MoveLootPopup")}constructor(t,n,r){super(t,n),this.onSubmitCallback=r}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};function Te(e,t){return e.localeCompare(t,game.i18n.lang)}o(Te,"localeCompare");function ue(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}o(ue,"refreshCharacterSheets");function rt(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let r of e){let a=n.findIndex(s=>r===s);if(a===-1)return!1;n.splice(a,1)}return!0}o(rt,"compareArrays");function Vt(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}o(Vt,"ordinalString");function xe(e,t){if(typeof e!="object")return!1;let n=Reflect.getPrototypeOf(e);for(;n;){if(n.constructor.name===t)return!0;n=Reflect.getPrototypeOf(n)}return!1}o(xe,"isInstanceOf");function j(e,t,n){return setProperty(e,`modules.${C}.${t}`,n)}o(j,"setInMemory");function z(e,t){return getProperty(e,`modules.${C}.${t}`)}o(z,"getInMemory");function Kt(e,t){let n=`modules.${C}.${t}`.split("."),r=n.pop(),a=e;for(let s of n)if(a=a[s],!a)return!0;return delete a[r]}o(Kt,"deleteInMemory");function Yt(e,t,n,r){let a=n-e,s=r-t;return Math.sqrt(a*a+s*s)}o(Yt,"calculateDistanceBetweenPoints");function Ae(e){return Array.from(e.parentElement.children).indexOf(e)}o(Ae,"getElementIndex");function Pe(e){return e!==void 0&&e!==-1}o(Pe,"indexIsValid");function T(...e){let t=e.filter(n=>typeof n=="string").join("/");return`modules/${C}/templates/${t}.hbs`}o(T,"templatePath");var H={wrapperIds:[],tabs:new Collection},Io="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner",ko="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render",Do="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners";function U(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}o(U,"isPlayedActor");function Oe(e){H.wrapperIds.length||(H.wrapperIds=[L(ko,To),L(Io,xo),L(Do,Ao)]),H.tabs.set(e.tabName,e)}o(Oe,"registerCharacterSheetExtraTab");function Me(e){if(H.tabs.delete(e),H.wrapperIds.length&&!H.tabs.size){for(let t of H.wrapperIds)Rt(t);H.wrapperIds=[]}}o(Me,"unregisterCharacterSheetExtraTab");async function To(e,...t){let n={};for(let{tabName:r}of H.tabs){let s=V(this.element,r).find(".alternate")[0];s&&(n[r]=s.scrollTop)}await e(...t);for(let{tabName:r}of H.tabs){if(!n[r])continue;let i=V(this.element,r).find(".alternate")[0];i.scrollTop=n[r]}}o(To,"characterSheetRender");async function xo(e,t){let n=await e(t),r=this.actor;if(!H.tabs.size||!U(r))return n;let a=this.element;for(let{tabName:s,getData:i,templateFolder:c,onRender:l}of H.tabs){let u=V(n,s),f=await i(r,this,V(a,s)),d=await renderTemplate(T(c),f);l&&await l(r,this,n),z(this,`${s}.toggled`)&&u.addClass("toggled"),u.children(":last").before(d)}return n}o(xo,"characterSheetInnerRender");function Ao(e,t){e(t);let n=this.actor;if(!(!H.tabs.size||!U(n)))for(let{tabName:r,addEvents:a}of H.tabs){t.find(`nav.sheet-navigation .item[data-tab=${r}]`).on("click",i=>Po(i,t,this,r));let s=V(t,r);a(s.find("> .alternate"),this,n,t)}}o(Ao,"characterSheetActiveListeners");function V(e,t){return e.find(`section.sheet-body .sheet-content > .tab[data-tab=${t}]`)}o(V,"getCharacterSheetTab");function Po(e,t,n,r){e.preventDefault();let a=V(t,r);a.hasClass("active")&&(a.toggleClass("toggled"),a.scrollTop(0),j(n,`${r}.toggled`,a.hasClass("toggled")))}o(Po,"onCharacterSheetTabBtnToggle");function k(e,t,n){return e.getFlag(C,t)??n}o(k,"getFlag");function q(e,t,n){return e.setFlag(C,t,n)}o(q,"setFlag");function Jt(e,t){return e.unsetFlag(C,t)}o(Jt,"unsetFlag");function fe(e,t,n){return e.updateSource({[`flags.${C}.${t}`]:n})}o(fe,"updateSourceFlag");function de(e,t,n){e[`flags.${C}.${t}`]=n}o(de,"moduleFlagUpdate");function ot(){return CONFIG.ChatMessage.documentClass}o(ot,"getChatMessageClass");function*pe(e,t){let n=game.messages.contents,r=(t?n.findLastIndex(a=>a===t):n.length)-1;for(let a=r;a>=r-e;a--){let s=n[a];if(!s)return;yield s}}o(pe,"latestChatMessages");function K(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}o(K,"chatUUID");function Re(e){let t=e.id,n=k(e,"target.save");n&&Hooks.once("preCreateChatMessage",r=>{fe(r,"target.messageId",t),fe(r,"target.save",n)})}o(Re,"bindOnPreCreateSpellDamageChatMessage");function ne(e){game.socket.on(`module.${C}`,e)}o(ne,"socketOn");function re(e){game.socket.off(`module.${C}`,e)}o(re,"socketOff");function _(e){game.socket.emit(`module.${C}`,e)}o(_,"socketEmit");function oe(){return game.user===game.users.activeGM}o(oe,"isActiveGM");function Le(){let e=game.data.users.find(t=>t._id===game.data.userId);return e&&e.role>=CONST.USER_ROLES.GAMEMASTER}o(Le,"isUserGM");function Qt(){return game.users.some(e=>e.active&&e.isGM)}o(Qt,"isGMOnline");function Xt(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}o(Xt,"getCharacterOwner");function Oo(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,r)=>n.id>r.id?1:-1),t[0]||null}o(Oo,"getActiveOwner");function at(e){return Oo(e)===game.user}o(at,"isActiveOwner");function Zt(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}o(Zt,"getOwner");var $e=!1,me=null;function rn(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:en}],conflicts:["pf2e-giveth"],ready:e=>{S("giveth")!=="disabled"&&en(!0)}}}o(rn,"registerGiveth");function en(e){let t=game.user.isGM;e==="disabled"&&$e?(t?re(tn):me&&(Hooks.off("dropCanvasData",me),me=null),$e=!1):e!=="disabled"&&!$e&&(t?ne(tn):me||(me=Gt("dropCanvasData",Mo)),$e=!0)}o(en,"setup");function tn(e){oe()&&(e.type==="giveth-condition"?$o(e):e.type==="giveth-effect"?Fo(e):Ho(e))}o(tn,"onSocket");function Mo(e,t){if(!Qt())return!0;let n=Lo(t);if(!n)return!0;let r=e.tokens.placeables.slice().filter(a=>{if(!a.document.actorLink)return!1;let s=a.actor;if(!on(s,t.actorId)||s.isOwner)return!1;let i=a.x+(a.hitArea?.right??0),c=a.y+(a.hitArea?.bottom??0);return t.x>=a.x&&t.y>=a.y&&t.x<=i&&t.y<=c}).sort((a,s)=>s.document.sort-a.document.sort).at(0)?.actor;return r?(Ro(n.actor,r,n.item,n.value),!1):!0}o(Mo,"onDropCanvasData");function Ro(e,t,n,r){let a=e.id,s=t.id,i=!(n instanceof Item);if(!i&&n.isOfType("physical")){let c=n.quantity;if(c<1)return O("giveth.notification.zero");if(c===1)return nn(a,s,n.id,1,!1);new De(e,{maxQuantity:c,lockStack:!1,isPurchase:!1},(l,u)=>{nn(a,s,n.id,l,u)}).render(!0)}else{let c=i?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?_({type:"giveth-condition",targetId:s,value:r??1,uuid:c}):_({type:"giveth-effect",targetId:s,uuid:c})}}o(Ro,"giveth");function nn(e,t,n,r,a){_({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:r,stack:a})}o(nn,"sendPhysicalRequest");function on(e,t){return!U(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}o(on,"isValidActor");function Lo(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let a=e.context?.origin.actor;n=a?fromUuidSync(a):null}if(!on(n)||!n.isOwner)return;let r=!(t instanceof Item);if(r&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!r&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}o(Lo,"getDetailsFromData");async function $o({targetId:e,uuid:t,value:n}){let r=game.actors.get(e);if(!r)return;let a=await fromUuid(t);a&&r.increaseCondition(a.slug,{min:n})}o($o,"takethCondition");async function Fo({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let r=await fromUuid(t);if(!r)return;let a=r.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[a])}o(Fo,"takethEffect");async function Ho({itemId:e,ownerId:t,qty:n,stack:r,targetId:a}){let s=game.actors.get(t),i=game.actors.get(a);if(!s||!i)return;let c=s.items.get(e);if(!c)return;n=Math.min(n,c.quantity);let l=c.quantity-n,u=c.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",c.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=c.traits.has("invested")?!1:null);let f=await i.addToInventory(u,void 0,r);if(!f||(l<1?c.delete():c.update({"system.quantity":l}),S("giveth")==="no-message"))return;let d=K(f.uuid,f.name,!f.isIdentified);n>1&&(d+=` x${n}`);let m=x("giveth.giveth",{target:i.name});ChatMessage.create({flavor:`<h4 class="action">${m}</h4>`,content:d,speaker:ChatMessage.getSpeaker({actor:s})})}o(Ho,"takethPhysical");var ae=A("hero.templates.trade"),Fe=class extends Application{static{o(this,"Trade")}constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(Application.defaultOptions,{title:ae("title"),template:T("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){ae.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:N(this.actor),targetActions:this.target?N(this.target):[],i18n:ae})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#e.bind(this)),t.find('[data-action="trade"]').on("click",this.#t.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#t(){if(!this.target){ae.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){ae.warn("no-select");return}let r=Xt(this.target,!0)??Zt(this.target,!0)??game.users.activeGM;if(!r){ae.warn("no-user");return}an({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:r.id,cid:this.target.id,uuid:n}}),this.close()}async#e(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};var Ue="pf2e-hero-actions",sn=P("renderCharacterSheetPF2e",qo,No),Uo="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",_e="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",_o="systems/pf2e/icons/features/feats/heroic-recovery.webp",He=!1;function ln(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>sn(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>ue()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[Ue],api:{createTable:ea,removeHeroActions:aa,getHeroActions:N,useHeroAction:mn,getHeroActionDetails:Ne,drawHeroAction:pn,drawHeroActions:fn,sendActionToChat:vn,discardHeroActions:gn,tradeHeroAction:dn,getDeckTable:ct,giveHeroActions:ca,createChatMessage:qe},ready:()=>{sn(!1,"hero")}}}o(ln,"registerHeroActions");function No(e){e&&!He?(ne(cn),He=!0):!e&&He&&(re(cn),He=!1)}o(No,"setupSocket");function cn(e){switch(e.type){case"hero.trade-reject":if(e.sender.id!==game.user.id)return;En(e);break;case"hero.trade-accept":if(!oe())return;Cn(e);break;case"hero.trade-request":if(e.receiver.id!==game.user.id)return;Xo(e);break;case"hero.trade-error":if(!e.users.includes(game.user.id))return;wn(e.error);break}}o(cn,"onSocket");async function qo(e,t){let n=e.actor;U(n)&&(await Go(t,n),Bo(t,n))}o(qo,"renderCharacterSheetPF2e");async function Go(e,t){let n=N(t),r=t.heroPoints.value-n.length,a=t.isOwner,s=A("hero.templates.heroActions"),i=await renderTemplate(T("hero/sheet"),{owner:a,list:n,canUse:r>=0&&a,canDraw:r>0&&a,canTrade:S("hero-trade"),mustDiscard:r<0,diff:Math.abs(r),i18n:(c,{hash:l})=>s(c,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(i)}o(Go,"addActionsToSheet");function Bo(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",r=>Ko(t,r)),n.find("[data-action=expand]").on("click",un),n.find("[data-action=use]").on("click",r=>Vo(t,r)),n.find("[data-action=display]").on("click",r=>Wo(t,r)),n.find("[data-action=discard]").on("click",zo),n.find("[data-action=discard-selected]").on("click",()=>jo(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>dn(t))}o(Bo,"addSheetEvents");async function jo(e,t){let r=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(a=>a.dataset.uuid);gn(e,r)}o(jo,"onClickHeroActionsDiscard");function zo(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let r=Number(n.attr("data-discard")??"0"),a=n.find(".action.discarded");n.toggleClass("discardable",a.length===r)}o(zo,"onClickHeroActionDiscard");async function Wo(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");vn(e,n)}o(Wo,"onClickHeroActionDisplay");async function Vo(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");mn(e,n)}o(Vo,"onClickHeroActionUse");async function Ko(e,t){t.preventDefault(),fn(e)}o(Ko,"onClickHeroActionsDraw");function N(e){return getProperty(e,`flags.${Ue}.heroActions`)??[]}o(N,"getHeroActions");async function Q(e,t){return e.update({[`flags.${Ue}.heroActions`]:t})}o(Q,"setHeroActions");async function un(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let r=t.attr("data-uuid"),a=await Ne(r);if(!a)return;let s=await TextEditor.enrichHTML(a.description,{async:!0});n.find(".item-description").html(s),n.addClass("loaded")}t.toggleClass("expanded")}o(un,"onClickHeroActionExpand");async function Ne(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,r=t instanceof JournalEntry?t.pages.contents[0]:t,a=r?.text.content;if(a)return n.uuid===Uo&&(a=a.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:r.name,description:a}}o(Ne,"getHeroActionDetails");async function fn(e){if(!e?.isOfType("character")){O("hero.onlyCharacter");return}let t=N(e),n=e.heroPoints.value-t.length,r=[];for(let a=0;a<n;a++){let s=await pn();if(s!==void 0){if(s===null)return;t.push(s),r.push(s)}}r.length&&(Q(e,t),qe({actor:e,actions:r,label:a=>x("hero.actions-draw.header",{nb:a}),secret:!0}))}o(fn,"drawHeroActions");function qe({actor:e,actions:t,label:n,secret:r=!1}){let{content:a,size:s}=Yo(t);n=typeof n=="function"?n(s):n;let i={flavor:`<h4 class="action">${n}</h4>`,content:a,speaker:ChatMessage.getSpeaker({actor:e})};r&&S("hero-private")&&(i.type=CONST.CHAT_MESSAGE_TYPES.ROLL,i.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(i)}o(qe,"createChatMessage");function Yo(e){let t=e.map(({uuid:n,name:r})=>K(n,r));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}o(Yo,"chatActions");function dn(e){if(!e?.isOfType("character")){O("hero.onlyCharacter");return}let t=N(e);if(!t||!t.length){O("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){O("hero.no-points",{nb:n.toString()});return}new Fe(e).render(!0)}o(dn,"tradeHeroAction");async function pn(){let e=await ct(),t=A("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(s=>!s.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let r=In(n);if(r)return{uuid:r,name:await hn(n,r)}}o(pn,"drawHeroAction");async function mn(e,t){if(!e?.isOfType("character")){O("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return O("hero.use.noPoints");let r=N(e),a=r.findIndex(i=>i.uuid===t);if(a===-1)return;let s=await Ne(t);s||B("hero.use.noDetails"),r.splice(a,1),s?(e.update({"system.resources.heroPoints.value":n-1,[`flags.${Ue}.heroActions`]:r}),ChatMessage.create({flavor:`<h4 class="action">${x("hero.actions-use.header")}</h4>`,content:`<h2>${s.name}</h2>${s.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):Q(e,r)}o(mn,"useHeroAction");async function gn(e,t){if(!e?.isOfType("character")){O("hero.onlyCharacter");return}let n=typeof t=="string"?[t]:t,r=N(e),a=[];for(let s of n){let i=r.findIndex(c=>c.uuid===s);i!==-1&&(a.push(r[i]),r.splice(i,1))}Q(e,r),qe({actor:e,actions:a,label:s=>x("hero.actions-discard.header",{nb:s})})}o(gn,"discardHeroActions");async function hn(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}o(hn,"getLabelfromTableResult");async function yn(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}o(yn,"getTableFromUuid");async function Jo(){return yn(_e)}o(Jo,"getDefaultCompendiumTable");function bn(){return game.tables.find(e=>e.getFlag("core","sourceId")===_e)}o(bn,"getDefaultWorldTable");async function Qo(){return yn(S("hero-table"))}o(Qo,"getCustomTable");async function ct(){return await Qo()??bn()??await Jo()}o(ct,"getDeckTable");async function vn(e,t){let n=await Ne(t);if(!n)return B("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}o(vn,"sendActionToChat");function an(e){if(e.receiver.id===game.user.id){Sn(e);return}_({...e,type:"hero.trade-request"})}o(an,"sendTradeRequest");function Sn(e){if(game.user.isGM){Cn(e);return}_({...e,type:"hero.trade-accept"})}o(Sn,"acceptRequest");async function Cn(e){let{sender:t,receiver:n}=e,r=game.actors.get(t.cid),a=game.actors.get(n.cid);if(!r||!a){st(e);return}let s=N(r),i=N(a),c=s.findIndex(g=>g.uuid===t.uuid),l=i.findIndex(g=>g.uuid===n.uuid);if(c===-1||l===-1){st(e);return}let u=s.splice(c,1)[0],f=i.splice(l,1)[0];s.push(f),i.push(u),Q(r,s),Q(a,i);let d=K(u.uuid),m=K(f.uuid),h=A("hero.trade-success"),p=`<div style="line-height: 1.6">${h("offer",{offer:d})}</div>`;p+=`<div style="line-height: 1.6">${h("receive",{receive:m})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${h("header",{name:a.name})}</h4>`,content:p,speaker:ChatMessage.getSpeaker({actor:r})})}o(Cn,"onTradeAccepted");function st({sender:e,receiver:t},n="trade-error"){let r=new Set([e.id,t.id]);r.has(game.user.id)&&(r.delete(game.user.id),wn(n)),r.size&&_({type:"hero.trade-error",users:Array.from(r),error:n})}o(st,"sendTradeError");function wn(e){B("hero.trade-error")}o(wn,"onTradeError");async function Xo(e){let{sender:t,receiver:n}=e,r=game.actors.get(t.cid),a=game.actors.get(n.cid);if(!r||!a){st(e);return}let s=A("hero.trade-request"),i=`<p>${s("header",{sender:r.name,receiver:a.name})}</p>`;i+=`<p>${s("give",{give:K(t.uuid)})}</p>`,i+=`<p>${s("want",{want:K(n.uuid)})}</p>`,i+=`<p style="margin-bottom: 1em;">${s("accept")}</p>`,await Dialog.confirm({title:s("title"),content:await TextEditor.enrichHTML(i,{async:!0})})?Sn(e):Zo(e)}o(Xo,"onTradeRequest");function Zo(e){if(e.sender.id===game.user.id){En(e);return}_({...e,type:"hero.trade-reject"})}o(Zo,"rejectRequest");async function En({receiver:e}){let t=game.actors.get(e.cid);O("hero.trade-rejected",{name:t.name},!0)}o(En,"onTradeRejected");async function ea(){if(!game.user.isGM){O("hero.notGM");return}let e=A("hero.templates.createTable.choice"),t=T("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:s=>{let i=s.find('.window-content input[name="type"]:checked').val(),c=s.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:i,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},r={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},a=await Dialog.wait(r,void 0,{id:"pf2e-hero-actions-create-table"});a&&(a.type==="default"?ra(a.unique):ta(a.unique))}o(ea,"createTable");async function ta(e){let t=await na(e);await it(t),t.sheet?.render(!0)}o(ta,"createCustomTable");function na(e=!0){let t=lt(e);return RollTable.create(t,{temporary:!1})}o(na,"createCustomActionsTable");async function ra(e){let t=A("templates.createTable.default.confirm"),n=await bn();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let a=lt(e);return await n.update(a),it(n,!0)}n=await oa(e),await it(n)}o(ra,"createDefaultTable");async function oa(e=!0){let t=await fromUuid(_e),n=lt(e,t);return RollTable.create(n,{temporary:!1})}o(oa,"createDefautActionsTable");async function it(e,t=!1){t&&await e.normalize(),await Lt("hero-table",e.uuid)}o(it,"setTable");function lt(e,t){let n={name:x("hero.table.name"),replacement:!(e??!0),img:_o,description:x("hero.table.description"),flags:{core:{sourceId:_e}}};return t?mergeObject(deepClone(t._source),n):n}o(lt,"getTableSource");async function aa(){if(!game.user.isGM){O("hero.notGM");return}let e=A("hero.templates.removeActions"),t=T("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:s=>s.find('input[name="actor"]:checked').toArray().map(i=>game.actors.get(i.value)).filter(i=>i)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},r={content:await renderTemplate(t,{actors:game.actors.filter(s=>s.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:s=>{s.on("change",'input[name="all"]',()=>sa(s)),s.on("change",'input[name="actor"]',()=>ia(s))},close:()=>null},a=await Dialog.wait(r,void 0,{id:"pf2e-hero-actions-remove-actions"});if(a){if(!a.length){e.warn("noSelection");return}for(let s of a)Q(s,[]);e.info("removed")}}o(aa,"removeHeroActions");function sa(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}o(sa,"removeActionsToggleAll");function ia(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),r=e.find('input[name="all"]');t.length===n.length?(r.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?r.prop("checked",!1).prop("indeterminate",!0):(r.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}o(ia,"removeActionsToggleActor");function In(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}o(In,"documentUuidFromTableResult");async function ca(e){if(!game.user.isGM){O("hero.notGM");return}let t=A("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await ct();if(!n)return B("hero.table.drawError",!0),null;let r=n.replacement===!1,a=(await Promise.all(n.results.map(async g=>{let y=In(g);if(y)return{key:g.id,uuid:y,name:await hn(g,y),drawn:g.drawn}}))).filter(Boolean),s=T("hero/dialogs/give-action"),i=await renderTemplate(s,{actions:a,isUnique:r,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:g=>({selected:g.find("[name=action]:checked").closest(".action").toArray().map(y=>y.dataset),asDrawn:g.find("[name=drawn]").prop("checked")??!1,withMessage:g.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:i,buttons:c,render:g=>{g.find("[data-action=expand]").on("click",un)},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!u)return;let{selected:f,asDrawn:d,withMessage:m}=u,h=N(e),p=[];for(let{uuid:g,name:y,key:b}of f){if(h.push({uuid:g,name:y}),!d)continue;let w=n.results.get(b);w&&!w.drawn&&p.push(b)}p.length&&await n.updateEmbeddedDocuments("TableResult",p.map(g=>({_id:g,drawn:!0}))),Q(e,h),m&&qe({actor:e,actions:f,label:g=>x("hero.actions-give.header",{nb:g}),secret:!0})}o(ca,"giveHeroActions");var v=null,la=0;function kn(e,t){for(let[n,r]of Object.entries(t))for(let a of r){let s=e[a];!s||typeof s===n||(e[s]=void 0)}}o(kn,"cleanOptions");function Dn(e){if(e.element instanceof HTMLElement){kn(e,{string:["draggedClass","group","selector","filter","identifier"],number:["triggerDistance"],boolean:["cancelOnRightClick"],function:["onCancel","onDragEnd","onDragStart"]}),e.triggerDistance??=6,e.cancelOnRightClick??=!0,e.cursorImage??={},e.cursorImage.id=typeof e.cursorImage.id=="string"?e.cursorImage.id:"",e.cursorImage.img=typeof e.cursorImage.img=="function"?e.cursorImage.img:void 0,e.droppables??=[];for(let t=e.droppables.length-1;t>=0;t--){let n=e.droppables[t];if(!(n.element instanceof HTMLElement)){e.droppables.splice(t,1);continue}kn(n,{string:["selector","overClass","filter"],boolean:["purgeOnLeave"],function:["onDragEnter","onDragLeave","onDragOver","onDrop"]})}e.element.addEventListener("mousedown",t=>fa(t,e))}}o(Dn,"makeDraggable");async function ua(e){v&&(v.canceled=!0,v.dragging&&v.draggable.ghost&&v.draggable.ghost.reset(),v.dragging&&v.options.onCancel&&await v.options.onCancel(e,v.draggable),xn(),await Tn(e))}o(ua,"onDragCancel");async function Tn(e){v&&(v.dragging&&v.options.onDragEnd&&await v.options.onDragEnd(e,v.draggable,{canceled:v.canceled,dropped:v.dropped}),window.removeEventListener("mousemove",An),window.removeEventListener("mouseup",Pn),v=null)}o(Tn,"onDragEnd");function xn(){if(v){v.draggable.classList.purge(),v.draggable.ghost?.classList.purge(),v.cursorElement?.remove();for(let{classList:e}of Object.values(v.hovered))e.purge()}}o(xn,"cleanUp");function fa(e,t){if(e.button===2&&v?.dragging&&v.options.cancelOnRightClick){ua(e);return}if(e.button)return;let n=ge(e.target,t.element,t);if(!n)return;let r,a=Ae(n),s=n.parentElement,i=ut(n);v={canceled:!1,dragging:!1,dropped:!1,options:t,group:t.group,draggable:{identifier:t.identifier,element:n,triggeringElement:e.target,x:e.clientX,y:e.clientY,parent:s,index:a,classList:i,get ghost(){if(r)return t.ghostClass&&r.classList.add(t.ghostClass),r;let{element:c=n.cloneNode(!0),index:l=1/0}=t.createGhost?.(n,a)??{},u=ut(c);return t.draggedClass&&c!==n&&c.classList.remove(t.draggedClass),t.ghostClass&&u.add(t.ghostClass),r={element:c,classList:u,index:l,reset:()=>{if(c.remove(),c===n){let f=s.children[a];s.insertBefore(n,f),r.index=a,t.ghostClass&&u.remove(t.ghostClass)}else r.index=1/0}},r},resetPosition:()=>{n.remove(),s.children[a].before(n)}},droppables:t.droppables.map(c=>({...c,id:la++})),hovered:{}},window.addEventListener("mousemove",An),window.addEventListener("mouseup",Pn)}o(fa,"onMouseDown");async function An(e){if(!v)return;if(v.dragging){pa(e);return}let{clientX:t,clientY:n}=e,{draggable:r}=v;Yt(r.x,r.y,t,n)>v.options.triggerDistance&&await da(e)}o(An,"onMouseMove");async function Pn(e){if(!(e.button||!v)){if(v.dragging){let t=!1;xn(),await Promise.all(Object.values(v.hovered).map(async n=>{if(!n.droppable.onDrop)return;await n.droppable.onDrop(e,v.draggable,{classList:n.classList,element:n.element,triggeringElement:n.triggeringElement})&&(t=!0)})),v.dropped=t}await Tn(e)}}o(Pn,"onMouseUp");async function da(e){if(!v.dragging){if(v.dragging=!0,v.options.cursorImage.img){let t=v.options.cursorImage.img(v.draggable.element);t instanceof HTMLElement?v.cursorElement=t:(v.cursorElement=new Image,v.cursorElement.src=typeof t=="string"?t:"")}else v.cursorElement=v.draggable.element.cloneNode(!0);v.cursorElement.id=v.options.cursorImage.id,v.options.draggedClass&&v.draggable.classList.add(v.options.draggedClass),document.body.appendChild(v.cursorElement),await v.options.onDragStart?.(e,v.draggable)}}o(da,"onDragStart");async function pa(e){if(!v)return;let{clientX:t,clientY:n}=e,r=v.cursorElement,a=r.offsetWidth/2,s=r.offsetHeight/2;r.style.left=`${t-a}px`,r.style.top=`${n-s}px`,await Promise.all(v.droppables.map(async i=>{let c=ge(e.target,i.element,{selector:i.selector,filter:i.filter}),l=v.hovered[i.id];if(l&&(!c||l.element!==c)&&await i.onDragLeave?.(e,v.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target})!==!1&&(delete v.hovered[i.id],i.purgeOnLeave?l.classList.purge():i.overClass&&l.classList.remove(i.overClass)),!!c)if(l)i.onDragOver&&await i.onDragOver(e,v.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target});else{let u=ut(c);await i.onDragEnter?.(e,v.draggable,{classList:u,element:c,triggeringElement:e.target})!==!1&&(i.overClass&&u.add(i.overClass),v.hovered[i.id]={id:i.id,classList:u,droppable:i,element:c,triggeringElement:e.target})}}))}o(pa,"onDragMove");function ut(e){return new class extends Set{add(t){e.classList.add(t),super.add(t)}remove(t){e.classList.remove(t),super.delete(t)}toggle(t,n){n??!e.classList.contains(t)?this.add(t):this.remove(t)}contains(t){return this.has(t)}purge(){e.classList.remove(...this)}}}o(ut,"newClassList");function ge(e,t,{selector:n,filter:r}={}){if(!t.contains(e))return;if(!n&&!r)return t;let a,s=e;for(;;){if(r&&s.matches(r))return;if(!a&&n&&s.matches(n)&&(a=s),s===t)break;s=s.parentElement}return n?a:t}o(ge,"closestInside");var ma=P("closeCharacterSheetPF2e",ha),dt=!1;function Mn(){return{settings:[{name:"inventory",type:Boolean,default:!1,scope:"client",onChange:e=>On(e)}],ready:e=>{On()}}}o(Mn,"registerInventory");var ft,ga=["platinum-pieces","gold-pieces","silver-pieces","copper-pieces"];function On(e){let t=e??S("inventory");t?Oe({tabName:"inventory",templateFolder:"inventory/sheet",getData:ba,addEvents:va,onRender:ya}):Me("inventory"),ma(t)}o(On,"setup");function ha(e,t){let n=e.actor;if(!U(n)||!z(e,"inventory.requireSave"))return;let r=V(t,"inventory")[0],a=Rn(r);a&&q(n,"inventory",a)}o(ha,"closeCharacterSheetPF2e");function ya(e,t,n){let r=n.find("> aside");r.css("position","relative"),r.append("<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>")}o(ya,"onRender");function Rn(e){if(!e)return;let t=e.querySelector(":scope > .alternate"),n=t.querySelector("[data-area='equipped']"),r=o(i=>n.querySelector(`[data-equipped-slot='${i}']`).querySelector("[data-item-id]")?.dataset.itemId??null,"equippedItemId"),a=o(i=>{let c={},l=i.querySelectorAll(":scope > [data-item-id]");for(let u=0;u<l.length;u++){let f=l[u];c[f.dataset.itemId]=u}return c},"itemIds"),s={};for(let i of t.querySelectorAll("[data-area='items-grid']")){let c=i.dataset.tabId;s[c]=a(i)}return{equipped:{hands:[r("left-hand"),r("right-hand")],armor:[r("armor")],others:a(n)},tabs:s}}o(Rn,"getCurrentData");async function ba(e,t,n){let r=k(e,"inventory"),a=Rn(n[0])??r??{equipped:{hands:[null,null],armor:[null],others:{}},tabs:{}};r||j(t,"inventory.requireSave",!0);let s=new Collection,i={},c=new Set,l={hands:[null,null],armor:[null],others:[]};function u(d){let m=d?.id,h=s.get(m);return h||(h={id:m,item:d,parent:d?.container,containers:[],matrix:[],parents:[]},s.set(m,h),h)}o(u,"getTab");for(let d of e.inventory){if(d.isOfType("treasure")&&d.system.stackGroup==="coins"&&ga.includes(d.slug))continue;let m=d.id,h=d.container,p=u(h),g=o(E=>{i[p.id]??=[],i[p.id].push(E)},"addOrphan");if(d.isOfType("backpack")){p.containers.push(d),c.add(d),u(d);continue}let y=d.handsHeld,b=l.hands.filter(Boolean).length;if(y===2&&b===0){a.equipped.hands[0]===m?l.hands=[d,d]:g(d);continue}if(y===1&&b<=1){let E=a.equipped.hands.indexOf(m);Pe(E)?l.hands[E]=d:g(d);continue}if(!l.armor[0]&&d.isOfType("armor")&&d.isEquipped){a.equipped.armor[0]===m?l.armor[0]=d:g(d);continue}if((d.isOfType("equipment")||Se(d))&&Ze(d)){let E=a.equipped.others[m];Pe(E)?l.others[E]=d:g(d);continue}let w=a.tabs[p.id]?.[m];if(Pe(w)){p.matrix[w]=d;continue}g(d)}for(let d of s){let m=i[d.id];if(m){for(let h of m){let p=h.handsHeld,g=l.hands.filter(Boolean).length;if(g===0&&p===2){l.hands=[h,h];continue}if(g<=1&&p===1){let y=l.hands[0]?1:0;l.hands[y]=h;continue}if(!l.armor[0]&&h.isOfType("armor")&&h.isEquipped){l.armor[0]=h;continue}if((h.isOfType("equipment")||Se(h))&&Ze(h)){l.others.push(h);continue}d.matrix.push(h)}d.matrix=d.matrix.filter(Boolean)}}for(let d of s){let m=d.parent;for(;m;)d.parents.push(m),m=m.container;d.parents.reverse();let h=[d.containers,d.parents,d.item].flat();d.trailings=c.filter(p=>!h.includes(p))}s.size||u(void 0),l.others=l.others.filter(Boolean);let f=z(t,"inventory.activeTab");return{tabs:Array.from(s.values()),equipped:l,actor:e,selectedTab:s.get(f)?.id,containerBulk:d=>{let m=d.capacity;return`${m.value.toString()} / ${m.max.toString()}`}}}o(ba,"getData");function va(e,t,n,r){let a=e.find("[data-tab-id]");for(let c of e.find("[data-container-id]"))c.addEventListener("click",l=>{let u=c.dataset.containerId;a.removeClass("active"),a.filter(`[data-tab-id=${u}]`).addClass("active"),j(t,"inventory.activeTab",u)});let s=r.find("#pf2e-toobelt-inventory-item-details")[0],i=e.find("[data-item-id], [data-container-id]");for(let c of i)c.addEventListener("mouseenter",l=>Sa(l,n,c,s)),c.addEventListener("mouseleave",l=>{s.classList.add("hidden")});n.isOwner&&(ft=randomID(),Dn({element:e[0],selector:"[data-item-id]",filter:"input",draggedClass:"dragged",ghostClass:"ghost",identifier:ft,cursorImage:{id:"pf2e-toolbelt-inventory-cursor-image",img:c=>c.dataset.itemImg},createGhost:Ea,onDragStart:()=>Ca(s),onDragEnd:(c,l,u)=>wa(t,u),droppables:[xa(e,t),Ta(e,t),Da(e,t),ka(e,t),Ia(e,t)]}))}o(va,"addEvents");async function Sa(e,t,n,r){if(dt)return;let a=n.dataset.details;if(!a){let s=Z(t,n);if(!s)return;a=await renderTemplate(T("inventory/details"),{item:s}),n.dataset.details=a}r.innerHTML=a,r.classList.remove("hidden")}o(Sa,"onItemDetails");function Ca(e){dt=!0,e.classList.add("hidden")}o(Ca,"onDragStart");function wa(e,{dropped:t,canceled:n}){dt=!1,!(n||!t)&&j(e,"inventory.requireSave",!0)}o(wa,"onDragEnd");function Ea(e,t){return e.parentElement.dataset.area==="items-grid"?{element:e,index:t}:void 0}o(Ea,"createGhost");function Ge(e){return e.identifier===ft?!0:(B("inventory.identifier.error"),!1)}o(Ge,"checkIdentifier");function Ia(e,t){function n(a,s,i){if(i.element===s.element||i.element===s.ghost)return;let c=s.ghost,l=Ae(i.element),u=c.index>=l?i.element:i.element.nextElementSibling;i.element.parentElement.insertBefore(c.element,u),c.index=l}o(n,"onDragEnter");function r(a,s,i){let c=i.element.parentElement;!c||ge(i.triggeringElement,c,{selector:"[data-item-id]"})||!c.parentElement.contains(i.triggeringElement)||(c.appendChild(s.ghost.element),s.ghost.index=1/0)}return o(r,"onDragLeave"),{element:e[0],selector:"[data-area='items-grid'] [data-item-id]",onDragEnter:n,onDragLeave:r}}o(Ia,"itemsGridDroppable");function ka(e,t){let n=t.actor;function r(i,c,l){ge(l.triggeringElement,l.element,{selector:"[data-item-id]"})||l.element.querySelector("[data-area='items-grid']").appendChild(c.ghost.element)}o(r,"onDragEnter");function a(i,c,l){c.ghost.reset()}o(a,"onDragLeave");async function s(i,c,l){if(!Ge(c))return!1;let u=Z(n,c);if(!u)return!1;let f=[];return c.element===c.ghost.element?(c.ghost.classList.purge(),Ln(c.element)):(X({html:e,updates:f,item:u,...c,target:c.ghost.element}),pt(e,n),c.ghost.reset()),await n.updateEmbeddedDocuments("Item",f),!0}return o(s,"onDrop"),{element:e[0],selector:"[data-area='items-list']",onDragEnter:r,onDragLeave:a,onDrop:s}}o(ka,"itemsListDroppable");function Da(e,t){let n=t.actor,r=e.find("[data-equipped-slot=right-hand]")[0];function a(u,f){let d=f.element.dataset.equippedSlot;if(d===u.parent.dataset.equippedSlot||f.element.querySelector("[data-two-hands]"))return{canDrop:void 0};let m=Z(n,u);if(!m)return{canDrop:!1};let h=d==="armor"?m.isOfType("armor"):!0;return{item:m,slot:d,canDrop:h}}o(a,"getData");function s({updates:u,item:f,element:d,drop:m,noTwoHand:h=!1,noUpdate:p=!1}){let g=m instanceof HTMLElement?m:m.element,y=g.dataset.equippedSlot,b=d instanceof HTMLElement?d:d.element,w=Mt(f),E=we(f),D=Xe(f);g.appendChild(b);let R=o((F,M,J,G)=>{p||u.push(Ee(f,{carryType:F,handsHeld:M,inSlot:J,invested:G,containerId:null})),b.classList.toggle("invested",D&&G)},"move");if(y==="armor"){R("worn",0,!0,!0);return}if(y==="right-hand"){R("held",1,!1,w);return}R("held",E&&!h?2:1,!1,Ce(f)&&(!E||!h))}o(s,"moveItemToSlot");function i(u){let d=(u instanceof HTMLElement?u:u.element).querySelector("[data-item-id]"),m=Z(n,d);return{element:d,item:m}}o(i,"getSlottedItem");function c(u,f,d){let{canDrop:m}=a(f,d);m!==void 0&&(d.classList.toggle("valid",m),d.classList.toggle("invalid",!m))}o(c,"onDragEnter");async function l(u,f,d){if(!Ge(f))return!1;let{item:m,canDrop:h,slot:p}=a(f,d);if(!h)return!1;let g=[],y=i(d),b=f.parent.dataset.area,w=f.parent.dataset.equippedSlot,E=we(m),D=!1;if(b==="equipped")y.item&&X({html:e,updates:g,...y});else if(b==="items-grid"){if(p==="left-hand"&&E){let R=i(r);R.item&&X({html:e,updates:g,...R})}y.item&&X({html:e,updates:g,...y,target:f.element})}else p==="armor"?y.item&&s({updates:g,...y,drop:f.parent}):w==="armor"?y.item&&(y.item.isOfType("armor")?s({updates:g,...y,drop:f.parent}):X({html:e,updates:g,...y})):p==="right-hand"?(D=!0,y.item&&s({updates:g,...y,drop:f.parent,noUpdate:!0,noTwoHand:!0})):y.item&&(E?X({html:e,updates:g,...y}):(s({updates:g,...y,drop:f.parent,noUpdate:!0}),D=!0));return s({updates:g,item:m,element:f,drop:d,noUpdate:D}),(p==="left-hand"||w==="left-hand")&&pt(e,n),await n.updateEmbeddedDocuments("Item",g),!0}return o(l,"onDrop"),{element:e.find("[data-area=equipped] .main-items")[0],selector:"[data-equipped-slot]",purgeOnLeave:!0,onDragEnter:c,onDrop:l}}o(Da,"largeEquipmentDroppable");function Ta(e,t){let n=t.actor;function r(i,c){if(i.parent===c.element)return{canDrop:void 0};let l=Z(n,i);if(!l.isIdentified||!(l.isOfType("equipment")||Se(l)))return{canDrop:!1};let u=Xe(l),f=Ot(l);return!u&&!f?{canDrop:!1}:{canDrop:!0,item:l,canInvest:u}}o(r,"getData");function a(i,c,l){let{canDrop:u,canInvest:f}=r(c,l);u!==void 0&&(l.classList.add("show"),l.classList.toggle("add-forbidden",!u),l.classList.toggle("add-invest",u&&f),l.classList.toggle("add-equip",u&&!f))}o(a,"onDragEnter");async function s(i,c,l){if(!Ge(c))return!1;let{canDrop:u,canInvest:f,item:d}=r(c,l);return u?(l.element.appendChild(c.element),c.element.classList.toggle("invested",f),await n.updateEmbeddedDocuments("Item",[Ee(d,{containerId:null,inSlot:!0,invested:!0})]),!0):!1}return o(s,"onDrop"),{element:e.find("[data-area=equipped]")[0],filter:".main-items",purgeOnLeave:!0,onDragEnter:a,onDrop:s}}o(Ta,"otherEquipmentDroppable");function xa(e,t){let n=t.actor;function r(i,c){let l=Z(n,i);if(!l)return{canDrop:!1};let u=c.element.dataset.containerId;if(u==="undefined")return{item:l,canDrop:!0};let f=n.items.get(u);if(!f)return{canDrop:!1};let d=f.capacity,m=d.max.minus(d.value);return{item:l,container:f,canDrop:m.value>=l.bulk.value}}o(r,"getData");function a(i,c,l){let{canDrop:u}=r(c,l);l.classList.toggle("valid",u),l.classList.toggle("invalid",!u)}o(a,"onDragEnter");async function s(i,c,l){if(!Ge(c))return!1;let{canDrop:u,item:f,container:d}=r(c,l);if(!u)return!1;let m=X({html:e,updates:[],item:f,element:c,target:d});return c.parent.dataset.equippedSlot==="left-hand"&&pt(e,n),await n.updateEmbeddedDocuments("Item",m),!0}return o(s,"onDrop"),{element:e[0],selector:"[data-container-id]",filter:".back",purgeOnLeave:!0,onDragEnter:a,onDrop:s}}o(xa,"containersDroppable");function Ln(e){e.classList.remove("invested"),e.querySelector(".vignette.hands")?.remove()}o(Ln,"cleanContainerItem");function X({html:e,updates:t,item:n,element:r,target:a}){let s=a instanceof HTMLElement,i=r instanceof HTMLElement?r:r.element,c=s?a.closest("[data-tab-id]").dataset.tabId:a instanceof Item?a.id:a;return Ln(i),s?a.before(i):e.find(`.container-tab[data-tab-id=${c}] [data-area=items-grid]`).append(i),c=[void 0,"undefined"].includes(c)?null:c,t.push(Ee(n,{containerId:c,inSlot:!1,invested:!1,carryType:c?"stowed":"worn",handsHeld:0})),t}o(X,"moveItemToContainer");function pt(e,t){let n=e.find("[data-area='equipped'] .main-items")[0],r=n.querySelector("[data-equipped-slot='left-hand']"),a=n.querySelector("[data-equipped-slot='right-hand']"),s=r.querySelector("[data-item-id]"),i=a.querySelector(".item:not(.fake)"),c=Z(t,s),l=!!c&&we(c);if(!l&&i?.dataset.twoHands)i.remove();else if(l&&!i){let u=s.cloneNode(!0);u.dataset.twoHands="true",a.appendChild(u)}}o(pt,"checkForTwoHandedSlots");function Z(e,t){if(!t)return;let n=t instanceof HTMLElement?t:t.element,{itemId:r,containerId:a}=n.dataset,s=r??a;if(s)return e.items.get(s)}o(Z,"getItemFromElement");var $n=A("knowledges.editLore"),Be=class extends FormApplication{static{o(this,"EditLores")}get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return $n("title",this.actor)}get template(){return T("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:k(n,"knowledges.unspecified")??"",specific:k(n,"knowledges.specific")??"",i18n:$n})}async _updateObject(t,{unspecified:n,specific:r}){let a=this.object;q(a,"knowledges.unspecified",n.trim()),q(a,"knowledges.specific",r.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#t.bind(this))}#t(t){t.preventDefault(),this.close()}};var Fn=P("renderNPCSheetPF2e",Aa);function Hn(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>Fn(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&S("knowledges")&&Fn(!0)}}}o(Hn,"registerKnowledges");function Aa(e,t){let n=e.actor;U(n)&&(Oa(n,t),Ra(t),Ma(n,t))}o(Aa,"renderNPCSheetPF2e");function mt(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}o(mt,"knowledgeSelector");function Pa(e){new Be(e).render(!0)}o(Pa,"editLores");function Oa(e,t){let n=k(e,"knowledges.unspecified"),r=k(e,"knowledges.specific");if(!n&&!r)return;let a=e.identificationDCs.lore,s=mt(t,"body","");s.find(".identification-skills").last().remove();function i(l,u,f){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:f})}</div>`}o(i,"tag");function c(l,{dc:u,start:f}){let d=l.split(",").filter(m=>m.trim()).map(m=>i(m,u,f)).join("");s.append(d)}o(c,"addTags"),c(n||"Unspecific",a[0]),c(r||"Specific",a[1])}o(Oa,"replaceLores");function Ma(e,t){mt(t,"header","button.edit").on("click",()=>Pa(e))}o(Ma,"addEvents");function Ra(e){let t=mt(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}o(Ra,"addEditButton");var gt=A("merge.multi"),je=class extends Application{static{o(this,"MultiCast")}#t;#e;constructor(t,n,r){super(r),this.#e=t,this.#t=n}get title(){return gt("title",this.spell)}get template(){return T("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:gt})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#n.bind(this)),t.find("[data-action=cancel]").on("click",this.#r.bind(this))}async#n(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){gt.error("zero"),this.close();return}let r=this.#t;if(!r)return;let a=r.item,s=r.actor;if(!s||!a)return;let i=o((l,u)=>{for(let[f,d]of Object.entries(l))for(let m=0;m<n-1;m++){let h=randomID();if(l[h]=d,u.type==="interval"){let p=u.damage[f];p&&(u.damage[h]=p)}else if(u.type==="fixed")for(let p of Object.values(u.levels)){let g=p.damage[f];g&&(p.damage[h]=g)}}},"updateSource"),c=deepClone(r.flags.pf2e.casting?.embeddedSpell);if(c){let l=c.system.damage;c.system.heightening??={};let u=c.system.heightening;i(l,u);let f=new Item.implementation(c,{parent:s});f.trickMagicEntry=a.trickMagicEntry;let d=r.getFlag("pf2e","origin.variant.overlays"),m=r.getFlag("pf2e","origin.castRank")??a.rank;(f.loadVariant({overlayIds:d,castRank:m})??f).rollDamage(this.#e)}else{let l=a.toObject(),u=l.system.damage,f=l.system.heightening??{};i(u,f),a.clone({"system.damage":u,"system.heightening":f}).rollDamage(this.#e)}a.damageKinds.size&&Re(r),this.close()}#r(t){t.preventDefault(),this.close()}};function Un(){return CONFIG.Dice.rolls.find(e=>e.name==="DamageRoll")}o(Un,"getDamageRollClass");var ht=P("renderChatMessage",jn,La);function Bn(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>ht(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>ht(e,"merge-damage")}],init:e=>{ht(!1,["multi-cast","merge-damage"],!0)}}}o(Bn,"registerMerge");function La(){let e=ui.chat?.element;if(e)for(let t of pe(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),jn(t,n))}}o(La,"updateMessages");function jn(e,t){!game.user.isGM&&!e.isAuthor||(S("merge-damage")&&Vn(e)?Fa(e,t):S("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&$a(e,t))}o(jn,"renderChatMessage");function $a(e,t){if(!e.item)return;let r=t.find(".message-content .chat-card .owner-buttons .spell-button");r.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${x("merge.spell.button")}</button>`),r.find("[data-action=multi-cast]").on("click",a=>{new je(a,e).render(!0)})}o($a,"renderSpell");function Fa(e,t){let n='<span class="pf2e-toolbelt-merge">';if(k(e,"merge.merged")){let i=x("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${i}">`,n+='<i class="fa-duotone fa-split"></i>'}let r=x("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${r}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let a=qn(e),s=Gn(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",i=>{i.stopPropagation();for(let c of pe(5,e)){let l=Gn(c);if(!(!Vn(c)||qn(c)!==a||!rt(s?.map(u=>u.actor).filter(Boolean),l?.map(u=>u.actor).filter(Boolean)))){Ua(i,e,c,{actorUUID:a,targetUUIDs:s});return}}O("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",i=>{i.stopPropagation(),Ha(i,e)})}o(Fa,"renderDamage");async function Ha(e,t){let n=k(t,"merge.data").flatMap(r=>r.source);await zn(t.id),await ot().createDocuments(n)}o(Ha,"splitDamages");async function Ua(e,t,n,{actorUUID:r,targetUUIDs:a}){let s={},i=_n(n).concat(_n(t));for(let{name:p,notes:g,outcome:y,modifiers:b,tags:w}of i){s[p]??={name:p,tags:w,notes:new Set,results:[]};for(let D of g)s[p].notes.add(D);s[p].results.some(D=>D.outcome===y&&rt(D.modifiers,b))||s[p].results.push({outcome:y,modifiers:b})}let c=Object.values(s).map(p=>{p.label=p.name;for(let g of p.results)g.outcome&&(g.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${g.outcome}`));return p});c.at(-1).isLastGroup=!0;let l=await renderTemplate(T("merge/merged"),{groups:c,hasMultipleGroups:c.length>1}),u=Nn(t),f=Nn(n),d=[];for(let p of[].concat(f,u)){let{options:g,total:y,terms:b}=p,w=b[0],E=p.formula.replaceAll(/(\[[\w,-]+\])/g,"").replace(/^\(/,"").replace(/\)$/,""),D=d.find(({options:{flavor:R,critRule:F}})=>R===g.flavor&&F===g.critRule);D?(D.terms.push(w),D.total+=y,D.formulas.push(E)):d.push({options:g,formulas:[E],total:y,terms:[w]})}let m=Un();for(let p of d){if(p.options.flavor.includes("persistent")){let{index:g}=p.formulas.reduce((y,b,w)=>{let E=new m(b).expectedValue;return E<=y.value?y:{value:E,index:w}},{value:0,index:-1});p.formulas=[p.formulas[g]],p.terms=[p.terms[g]]}p.formula=`(${p.formulas.join(" + ")})[${p.options.flavor}]`,p.term=p.terms.length<2?p.terms[0]:Wn(p.terms)}let h={class:"DamageRoll",options:{},dice:[],formula:`{${d.map(({formula:p})=>p).join(", ")}}`,total:d.reduce((p,{total:g})=>p+g,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:d.map(({formula:p})=>p),modifiers:[],rolls:d.map(({options:p,formula:g,total:y,term:b})=>({class:"DamageInstance",options:p,dice:[],formula:g,total:y,terms:[b],evaluated:!0})),results:d.map(({total:p})=>({result:p,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let p=o(g=>{if("results"in g)for(let y of g.results)y.hidden=!0;else{let y=(g.term??g).operands??[];for(let b of y)p(b)}},"setHidden");for(let g of h.terms[0].rolls)for(let y of g.terms)p(y)}await zn(t.id,n.id),await ot().create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[C]:{merge:{actor:r,targets:a,merged:!0,type:"damage-roll",data:i},target:{targets:a}},pf2e:{context:{options:Array.from(new Set(i.flatMap(p=>p.itemTraits)))}}},rolls:[h]})}o(Ua,"mergeDamages");function _n(e){let t=k(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let r=$(`<div>${e.flavor}</div>`),a=r.find("h4.action + .tags").prop("outerHTML"),s=[];r.find(".tag.tag_transparent").each(function(){s.push(this.innerHTML)});let i=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>c.startsWith("item:")),modifiers:s,tags:a,notes:i}]}o(_n,"getMessageData");function zn(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}o(zn,"removeChatMessages");function Wn(e){let t=deepClone(e[0].options);for(let n of e)n.options={};return{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?Wn(e):e[0]]}}}o(Wn,"createTermGroup");function Nn(e){return k(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}o(Nn,"getMessageRolls");function qn(e){return k(e,"merge.actor")??e.actor?.uuid}o(qn,"getActorUUID");function Gn(e){let t=k(e,"target.targets");if(t)return t;let n=k(e,"merge.targets")??e.getFlag("pf2e","target");return Array.isArray(n)?n:n?[n]:[]}o(Gn,"getTargetUUIDs");function Vn(e){return k(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}o(Vn,"isDamageRoll");var Kn=ke("renderChatMessage",Jn,_a);function Yn(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>Kn(e)}],init:e=>{!e&&S("modifiers")!=="disabled"&&Kn(!0,!0)}}}o(Yn,"registerHideModifiers");function _a(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of pe(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),Jn(t,n))}}o(_a,"updateMessages");function Jn(e,t){let n=e.speaker,r=ChatMessage.getSpeakerActor(n);if(!r||r.hasPlayerOwner)return;let a=t.find(".message-header");S("modifiers")==="traits"&&a.addClass("pf2e-toolbelt-modifiers-traits"),S("modifiers")!=="disabled"&&a.addClass("pf2e-toolbelt-modifiers")}o(Jn,"renderChatMessage");var Qn="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",Xn="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData";function Zn(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0},{name:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{S("nobulk")&&L(Qn,qa,"WRAPPER"),S("nobulk-coins")&&L(Xn,Na,"WRAPPER")}}}o(Zn,"registerNobulk");function Na(e){e();try{this.isCoinage&&(this.system.bulk.value=0)}catch{W("nobulk",Xn)}}o(Na,"treasurePrepareBaseData");function qa(e,...t){e(...t);try{let n=this.inventory.bulk.constructor,r=null;Object.defineProperty(this.inventory.bulk,"value",{get(){return r||(r=n.computeTotalBulk(this.actor.inventory.filter(a=>!a.isInContainer&&a.system.equipped.carryType!=="dropped"),this.actor.size),r)}})}catch{W("nobulk",Qn)}}o(qa,"actorPrepareEmbeddedDocuments");var Ga="CONFIG.Actor.documentClass.prototype.prepareData",Ba="DocumentSheet.prototype._renderInner";function er(){return{settings:[{name:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{S("share")!=="disabled"&&(L(Ga,Ya,"WRAPPER"),L(Ba,ja,"WRAPPER"),Hooks.on("preUpdateActor",Wa),Hooks.on("deleteActor",za),Hooks.on("updateActor",Va))}}}o(er,"registerShare");async function ja(e,...t){let n=await e(...t);if(!xe(this,"CreatureConfig"))return n;let r=this.actor;if(!U(r)||!r.isOfType("character","npc")||he(r).size)return n;let a=game.actors.filter(i=>i.id!==r.id&&i.isOwner&&We(i)).map(i=>({key:i.id,label:i.name})),s=await renderTemplate(T("share/master"),{masters:a,master:k(r,"share.master"),selectPath:`flags.${C}.share.master`,i18n:A("share.templates.master")});return n.children().last().before(s),n}o(ja,"documentSheetRenderInner");function za(e){sr(e);let t=he(e);Promise.all(t.map(async n=>{nr(n),await Jt(n,"share.master")}))}o(za,"deleteActor");function Wa(e,t){let n=getProperty(t,`flags.${C}.share`);if(n?.master){let r=game.actors.get(n.master);if(We(r)){let a=deepClone(r._source.system.attributes.hp);setProperty(t,"system.attributes.hp",a)}}else{let r=ze(e),a=getProperty(t,"system.attributes.hp");r&&a&&(r.update({system:{attributes:{hp:a}}},{noHook:!0}),delete t.system.attributes.hp)}}o(Wa,"preUpdateActor");function Va(e,t,n,r){let a=game.user.id===r,s=Qa(t);if(s?.master!==void 0){let c=e;if(sr(c),s.master){let l=game.actors.get(s.master);We(l)&&(tr(c,l),ar(l,c))}else nr(c)}if(!a)return;let i=he(e);if(i.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(i.map(async u=>await u.update(l,{noHook:!0})))}else Promise.all(i.map(async l=>await Ka(l,t)))}}o(Va,"updateActor");async function Ka(e,t){S("share")==="force"?await q(e,"toggle",!k(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}o(Ka,"refreshActor");function Ya(e){e();let t=k(this,"share.master"),n=t?game.actors.get(t):void 0;if(!We(n))return;ze(this)||(tr(this,n),ar(n,this));let r=this.system.attributes.hp;Object.defineProperty(this.system.attributes,"hp",{get(){let a=n.system.attributes.hp;return Ja(a,r),r},enumerable:!0})}o(Ya,"prepareData");function Ja(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}o(Ja,"transfertHpData");function Qa(e){return getProperty(e,`flags.${C}.share`)}o(Qa,"getShareFlag");function he(e){return rr(e,"slaves")??new Collection}o(he,"getSlaves");function tr(e,t){or(e,"master",t)}o(tr,"setMaster");function nr(e){Xa(e,"master")}o(nr,"unsetMaster");function ze(e){return rr(e,"master")}o(ze,"getMaster");function We(e){return e&&e.type==="character"&&!ze(e)}o(We,"isValidMaster");function rr(e,t){return getProperty(e,`modules.${C}.share.${t}`)}o(rr,"getModuleProperty");function or(e,t,n){setProperty(e,`modules.${C}.share.${t}`,n)}o(or,"setModuleProperty");function Xa(e,t){delete e.modules?.[C]?.share?.[t]}o(Xa,"deleteModuleProperty");function ar(e,t){let n=he(e);or(e,"slaves",n.set(t.id,t))}o(ar,"addSlaveToMaster");function sr(e){let t=ze(e);if(!t)return;he(t).delete(e.id)}o(sr,"removeSlaveFromMaster");var Za=P("renderCharacterSheetPF2e",ss),es=P("deleteCombat",cs),ts=P("deleteCombatant",pr),ns=P("createCombatant",ls),rs=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],os=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),as=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]);function cr(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:ir},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:yt,toggleStance:dr,isValidStance:lr},ready:e=>{S("stances")&&ir(!0)}}}o(cr,"registerStances");function ir(e){Za(e),es(e),ts(e),ns(e)}o(ir,"setup");function lr(e){return e?.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}o(lr,"isValidStance");function yt(e){let t=[],n=new Set;for(let{replace:r,sourceId:a,effectUUID:s,effect:i,img:c,name:l,itemName:u,action:f}of ur(e)){r&&n.add(r);let d=f?ve(e,f,"action"):ve(e,a,"feat");t.push({name:l,itemName:u,uuid:a,img:c,effectUUID:s,effectID:i?.id,actionUUID:d.sourceId,actionID:d.id})}return t.filter(({uuid:r})=>!n.has(r))}o(yt,"getStances");async function ss(e,t){let n=e.actor;if(!U(n))return;let r=yt(n);if(!r.length)return;let a=n.getActiveTokens(!0,!0).some(l=>l.inCombat),s=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),i=s.find(".actions-options"),c=await renderTemplate(T("stances/sheet"),{stances:r,canUseStances:a&&!n.isDead,i18n:A("stances")});i.length?i.after(c):s.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>is(l,n))}o(ss,"renderCharacterSheetPF2e");function is(e,t){let n=e.currentTarget,r=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!r)return;let a=n.dataset.effectUuid;dr(t,a)}o(is,"onToggleStance");function*ur(e){for(let t of e.itemTypes.feat){let n=t.sourceId,r=os.get(n),a=as.get(n);if(!r&&!a&&!lr(t))continue;let s=r?.effect??a?.effect??t.system.selfEffect.uuid,i=fromUuidSync(s);i&&(yield{name:(r&&fromUuidSync(r.replace)?.name)??t.name,itemName:t.name,replace:r?.replace,extra:a,sourceId:n,effectUUID:s,effect:ve(e,s,"effect"),action:a?.action,img:i.img})}}o(ur,"actorStances");function fr(e){let t=[];for(let{effect:n}of ur(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}o(fr,"getStancesEffects");async function dr(e,t){let n=fr(e),r=n.findIndex(s=>s.uuid===t),a=!1;if(r===-1)a=!0;else{let s=n.filter(c=>c.uuid!==t).length,i=n.filter(c=>c.uuid===t).length>1;(s||i)&&n.splice(r,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(s=>s.id)),a&&bt(e,t)}o(dr,"toggleStance");async function bt(e,t){let n=await fromUuid(t);if(n){let r=n.toObject();return getProperty(r,"flags.core.sourceId")||setProperty(r,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[r]))[0]?.toMessage(),!0}return!1}o(bt,"addStance");function cs(e){for(let t of e.combatants)pr(t)}o(cs,"deleteCombat");function pr(e){let t=mr(e);if(t){if(!game.user.isGM&&at(t)){let n=fr(t).map(r=>r.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}ue(t)}}o(pr,"deleteCombatant");function ls(e){let t=mr(e);t&&(!game.user.isGM&&at(t)&&us(t),ue(t))}o(ls,"createCombatant");function mr(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}o(mr,"getActorFromCombatant");async function us(e){let t=yt(e);if(!(!t.length||t.filter(({effectID:a})=>a).length||!Pt(e,rs,["feat"])))if(t.length===1){let a=t[0];await bt(e,a.effectUUID)&&te("stances.useStance",{stance:a.name})}else fs(e,t)}o(us,"checkForSavant");async function fs(e,t){let n=A("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(T("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:r=>bt(e,r.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}o(fs,"openStancesMenu");function hr(e){return Error(`PF2e System | ${e}`)}o(hr,"ErrorPF2e");var gr;function yr(e,{emptyStringZero:t=!1,zeroIsNegative:n=!1}={}){if(e===0&&t)return"";gr??=new Intl.NumberFormat(game.i18n.lang,{maximumFractionDigits:0,signDisplay:"always"});let r=n&&e===0?-0:e;return gr.format(r)}o(yr,"signedInteger");function br(e){if(e==="cantrips")return 0;let t=Number(e??NaN);return t.between(0,10)?t:null}o(br,"spellSlotGroupIdToNumber");function Sr(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>vr(e)}],conflicts:["pf2e-spells-summary"],ready:e=>{vr()}}}o(Sr,"registerSpellsSummary");function vr(e){(e??S("summary"))!=="disabled"?Oe({tabName:"spellcasting",templateFolder:"summary/sheet",getData:Cs,addEvents:ds}):Me("spellcasting")}o(vr,"setup");function ds(e,t,n){let r=e.find(".spell-type .uses .spell-slots-input input");r.on("change",a=>ps(a,n)),r.on("focus",ms),r.on("blur",gs),e.find(".focus-pips").on("click contextmenu",a=>hs(a,n)),e.find(".spell-slots-increment-reset").on("click",a=>bs(a,t,n)),e.find(".item-image").on("click",a=>vs(a,n))}o(ds,"addEvents");async function ps(e,t){e.preventDefault();let{inputPath:n,entryId:r}=$(e.currentTarget).data(),a=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:r,[n]:a}])}o(ps,"onUsesInputChange");function ms(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}o(ms,"onUsesInputFocus");function gs(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}o(gs,"onUsesInputBlur");function hs(e,t){e.preventDefault();let n=e.type==="click"?1:-1,r=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":r})}o(hs,"onToggleFocusPool");function ys(e,t,n){if(game.modules.get("pf2e-staves")?.active){Ss(e.element).find(".directory-list.spellcastingEntry-list").find(`.item-container.spellcasting-entry[data-item-id=${n}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click();return}let r=game.modules.get("pf2e-dailies");if(!r?.active)return;let a=t.spellcasting.get(n);r.api.updateEntryCharges(a,9999)}o(ys,"onChargesReset");function bs(e,t,n){e.preventDefault();let{itemId:r,rank:a,isCharge:s}=$(e.currentTarget).data();if(!r)return;if(s){ys(t,n,r);return}let i=n.items.get(r);if(i){if(i.isOfType("spellcastingEntry")){let c=a>=0&&a<=11?`slot${a}`:"slot0",l=i.system.slots?.[c];l&&i.update({[`system.slots.${c}.value`]:l.max})}else if(i.isOfType("spell")){let c=i.system.location.uses?.max;c&&i.update({"system.location.uses.value":c})}}}o(bs,"onSlotsReset");async function vs(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id");t.items.get(n).toMessage(e)}o(vs,"onItemToChat");function Ss(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}o(Ss,"getSpellcastingTab");async function Cs(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,r=game.modules.get("pf2e-dailies"),a=r?.active,s=n||a&&isNewerVersion(r.version,"2.14.0"),i=n?"flags.pf2e-staves.charges":a?"flags.pf2e-dailies.staff.charges":"",c=[],l=[],u=!1;if(await Promise.all(e.spellcasting.regular.map(async m=>{let h=m.id,p=m.statistic.dc.value,g=m.name,y=await m.getSheetData(),b=y.isFocusPool,w=m.system?.prepared?.value==="charge",E=(()=>{if(!w)return;let D=a&&r.api.getSpellcastingEntryStaffData(m),{charges:R,max:F,canPayCost:M}=D??getProperty(m,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:R,max:F,noMax:!0,canPayCost:M??(()=>!0)}})();for(let D of y.groups){if(!D.active.length||D.uses?.max===0)continue;let R=[],F=D.id==="cantrips",M=br(D.id),J=!F&&w&&!s;for(let G=0;G<D.active.length;G++){let ee=D.active[G];if(!ee||ee.uses?.max===0)continue;let{spell:I,expended:ie,virtual:ce,uses:Qr,castRank:Xr}=ee;R.push({name:I.name,img:I.img,range:I.system.range.value||"-",castRank:Xr??I.rank,slotId:G,entryId:h,entryDc:p,entryName:g,itemId:I.id,inputId:y.isInnate?I.id:y.id,inputPath:w?i:y.isInnate?"system.location.uses.value":`system.slots.slot${M}.value`,isCharge:w,isActiveCharge:w&&s,isBroken:J,isVirtual:ce,isInnate:y.isInnate,isCantrip:F,isFocus:b,isPrepared:y.isPrepared,isSpontaneous:y.isSpontaneous||y.isFlexible,groupId:D.id,uses:Qr??(w?E:D.uses),expended:w&&!F?!E.canPayCost(M):ie??(b&&!F?t.value<=0:!1),action:I.system.time.value,type:w?`${C}.summary.staff`:y.isInnate?"PF2E.PreparationTypeInnate":y.isSpontaneous?"PF2E.PreparationTypeSpontaneous":y.isFlexible?"PF2E.SpellFlexibleLabel":b?"PF2E.TraitFocus":"PF2E.SpellPreparedLabel",order:w?0:y.isPrepared?1:b?2:y.isInnate?3:y.isSpontaneous?4:5,noHover:y.isPrepared||F||J||b})}if(R.length){if(b)if(F)u=!0;else{l.push(...R);continue}c[M]??=[],c[M].push(...R)}}})),c.length){let m=S("summary")==="sort"?(h,p)=>h.order===p.order?Te(h.name,p.name):h.order-p.order:(h,p)=>Te(h.name,p.name);for(let h of c)h&&h.sort(m)}l.length&&(l.sort((m,h)=>Te(m.name,h.name)),c[12]=l,u=!1);let d=(await e.spellcasting.ritual?.getSheetData())?.groups.flatMap((m,h)=>m.active.map(({spell:p})=>({name:p.name,img:p.img,slotId:h,itemId:p.id,rank:p.rank,time:p.system.time.value})).filter(Boolean));return{spells:c,rituals:d,focusPool:t,hasFocusCantrips:u,isOwner:e.isOwner,i18n:A("summary"),entryRank:m=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Vt(m)})}}o(Cs,"getData");async function vt(e,{user:t=game.user,synchronize:n=!0}={}){if(game.modules.get("dice-so-nice")?.active)return game.dice3d.showForRoll(e,t,n)}o(vt,"roll3dDice");function wr(e){let t=0,n={},r={},a=e.filter(i=>i.type==="ability"&&!i.ignored),s=a.reduce((i,c)=>i===null||c.force?c:i.force?i:c.modifier>i.modifier?c:i,null);for(let i of a)i.ignored=i!==s;for(let i of e){if(i.ignored){i.enabled=!1;continue}if(i.type==="untyped"){i.enabled=!0,t+=i.modifier;continue}i.modifier<0?t+=Cr(r,i,LOWER_PENALTY):t+=Cr(n,i,HIGHER_BONUS)}return t}o(wr,"applyStackingRules");function Cr(e,t,n){let r=e[t.type];return r===void 0?(t.enabled=!0,e[t.type]=t,t.modifier):n(t,r)?(r.enabled=!1,t.enabled=!0,e[t.type]=t,t.modifier-r.modifier):(t.enabled=!1,0)}o(Cr,"applyStacking");function Ve(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}o(Ve,"htmlQuery");async function Er({affects:e,origin:t,target:n,item:r,domains:a,options:s}){if(!(t&&n))return[];let[i,c]=e==="target"?[t,n]:[n,t],l=[...s,i.getRollOptions(a),c.getSelfRollOptions(e)].flat(),u=r?r.isOfType("spell")?{spell:r}:{weapon:r}:{};return(await Promise.all(a.flatMap(f=>i.synthetics.ephemeralEffects[f]?.[e]??[]).map(f=>f({test:l,resolvables:u})))).flatMap(f=>f??[])}o(Er,"extractEphemeralEffects");function Ir(e,t){return t.flatMap(n=>(e[n]??[]).map(r=>r.clone()))}o(Ir,"extractNotes");function kr(e,t,n){return t.flatMap(r=>e[r]??[]).flatMap(r=>r(n)??[])}o(kr,"extractDamageDice");function Dr(e,t,n){let{modifierAdjustments:r,modifiers:a}=e,s=Array.from(new Set(t)).flatMap(i=>a[i]??[]).flatMap(i=>i(n)??[]);for(let i of s)i.adjustments=ws(r,t,i.slug);return s}o(Dr,"extractModifiers");function ws(e,t,n){return Array.from(new Set(t.flatMap(a=>e[a]??[]))).filter(a=>[n,null].includes(a.slug))}o(ws,"extractModifierAdjustments");async function St(e,{message:t,multiplier:n=1,addend:r=0,promptModifier:a=!1,rollIndex:s=0}){if(a)return Es(t,n,s);let i=[e];if(i.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}let c=CONFIG.PF2E.chatDamageButtonShieldToggle,l=t.rolls.at(s);if(!xe(l,"DamageRoll"))throw hr("Unexpected error retrieving damage roll");let u=n<0?n*l.total+r:l.alter(n,r),f=[...t.flags.pf2e.context?.options??[]],d=f.filter(h=>h.startsWith("self:")).map(h=>h.replace(/^self/,"origin")),m=t.item;for(let h of i){if(!h.actor)continue;f.some(M=>M.startsWith("target"))||f.push(...h.actor.getSelfRollOptions("target"));let p=n>0?"damage-received":"healing-received",g=n>0?await Er({affects:"target",origin:t.actor,target:h.actor,item:t.item,domains:[p],options:f}):[],y=h.actor.getContextualClone(d,g),b=new Set([...f.filter(M=>!/^(?:self|target):/.test(M)),...d,...y.getSelfRollOptions()]),w=t.flags.pf2e.context?.outcome,E=[],D=[];if(typeof u=="number"&&u<0){let M=w==="criticalSuccess",J=m?.isOfType("spell")?{spell:m}:m?.isOfType("weapon")?{weapon:m}:{},G=kr(y.synthetics.damageDice,[p],{resolvables:J,test:b}).filter(I=>(I.critical===null||I.critical===M)&&I.predicate.test(b));for(let I of G){let ie=`${I.diceNumber}${I.dieSize}[${I.label}]`,ce=await new Roll(ie).evaluate({async:!0});ce._formula=`${I.diceNumber}${I.dieSize}`,await ce.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:I.label,speaker:ChatMessage.getSpeaker({token:h})}),E.push(`${I.label} ${I.diceNumber}${I.dieSize}`),D.push(ce)}D.length&&(u-=D.map(I=>I.total).reduce((I,ie)=>I+ie));let ee=Dr(y.synthetics,[p],{resolvables:J}).filter(I=>(I.critical===null||I.critical===M)&&I.predicate.test(b));u-=wr(ee??[]),E.push(...ee.filter(I=>I.enabled).map(I=>`${I.label} ${yr(I.modifier)}`))}let F=(typeof u=="number"?u!==0:u.total!==0)?Ir(y.synthetics.rollNotes,[p]).filter(M=>(!w||M.outcome.length===0||M.outcome.includes(w))&&M.predicate.test(b)):[];await y.applyDamage({damage:u,token:h,item:t.item,skipIWR:n<=0,rollOptions:b,shieldBlockRequest:c,breakdown:E,notes:F})}xr(t.id),Ar(t,e.id,s)}o(St,"applyDamageFromMessage");function Tr(e,t,n){let r=o(()=>[e],"getTokens"),a=o(s=>s[0]?.actor?.itemTypes.shield.filter(c=>c.isEquipped&&!c.isBroken&&!c.isDestroyed)??[],"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:Ve(n,"div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let s=r();if(!s.length)return!1;let i=a(s),c=s.length===1&&i.length>1,l=t.classList.contains("shield-activated");return c&&!l?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(s,i,c)=>{let l=r(),u=a(l),f=l.length===1&&u.length>1,d=t.classList.contains("shield-activated");if(f&&!d){let m=Ve(c,"ul.shield-options");if(!m)return $(c);let h=u.map(p=>{let g=document.createElement("input");g.classList.add("data"),g.type="radio",g.name="shield-id",g.value=p.id,g.addEventListener("click",()=>{t.dataset.shieldId=g.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,s.close()});let y=document.createElement("span");y.classList.add("label"),y.innerHTML=p.name;let b=document.createElement("span");b.classList.add("tag");let w=game.i18n.localize("PF2E.HardnessLabel");b.innerHTML=`${w}: ${p.hardness}`;let E=document.createElement("li");return E.classList.add("item"),E.append(g,y,b),E});m.replaceChildren(...h)}return $(c)}}).tooltipster("open")}o(Tr,"onClickShieldBlock");function xr(e){for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action=shield-block]`;Ve(document.body,n)?.classList.remove("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}o(xr,"toggleOffShieldBlock");async function Es(e,{message:t,multiplier:n,rollIndex:r}){let a=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),s=class extends Dialog{static{o(this,"AdjustmentDialog")}activateListeners(c){super.activateListeners(c),c[0].querySelector("input")?.focus()}},i=n<0;new s({title:game.i18n.localize(i?"PF2E.UI.shiftModifyHealingTitle":"PF2E.UI.shiftModifyDamageTitle"),content:a,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async c=>{let l=(Number(c[0].querySelector("input")?.value)||0)*Math.sign(n);St(e,{message:t,multiplier:n,addend:l,promptModifier:!1,rollIndex:r})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{xr(t.id)}}).render(!0)}o(Es,"shiftAdjustDamage");var Ke={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},Pr=["criticalFailure","failure","success","criticalSuccess"],Ye=class e{static{o(this,"DegreeOfSuccess")}constructor(t,n,r=null){t instanceof Roll?(this.dieResult=(t.isDeterministic?t.terms.find(a=>a instanceof NumericTerm):t.dice.find(a=>a instanceof Die&&a.faces===20))?.total??1,this.rollTotal=t.total):(this.dieResult=t.dieValue,this.rollTotal=t.dieValue+t.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=this.#r(),this.adjustment=this.#t(this.unadjusted,r),this.value=this.adjustment?this.#e(this.adjustment.amount,this.unadjusted):this.unadjusted}static CRITICAL_FAILURE=0;static FAILURE=1;static SUCCESS=2;static CRITICAL_SUCCESS=3;#t(t,n){if(!n)return null;for(let r of["all",...Pr]){let{label:a,amount:s}=n[r]??{};if(s&&a&&!(t===e.CRITICAL_SUCCESS&&s===Ke.INCREASE)&&!(t===e.CRITICAL_FAILURE&&s===Ke.LOWER)&&(r==="all"||Pr.indexOf(r)===t))return{label:a,amount:s}}return null}#e(t,n){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+t,0,3)}}#n(t){return this.dieResult===20?this.#e(Ke.INCREASE,t):this.dieResult===1?this.#e(Ke.LOWER,t):t}#r(){let t=this.dc.value;return this.rollTotal-t>=10?this.#n(e.CRITICAL_SUCCESS):t-this.rollTotal>=10?this.#n(e.CRITICAL_FAILURE):this.rollTotal>=t?this.#n(e.SUCCESS):this.#n(e.FAILURE)}};function Or(e,{collisionOrigin:t,collisionType:n="move"}={}){let r=e instanceof MeasuredTemplateDocument?e.object:e;if(!canvas.scene)return[];let{grid:a,dimensions:s}=canvas;if(!(a&&s))return[];if(!r?.highlightId)return[];let i=a.getHighlightLayer(r.highlightId);if(!i||a.type!==CONST.GRID_TYPES.SQUARE)return[];let c=t??r.center,l=canvas.tokens.quadtree.getObjects(i.getLocalBounds(void 0,!0)),u=a.size,f=[];for(let d of l){let m=d.document,h=[];for(let p=0;p<m.height;p++){let g=Math.floor(d.x/u)*u,b=Math.floor(d.y/u)*u+p*u;if(h.push(`${g}.${b}`),m.width>1)for(let w=1;w<m.width;w++)h.push(`${g+w*u}.${b}`)}for(let p of h){if(!i.positions.has(p))continue;let[g,y]=p.split(".").map(E=>Number(E)),b={x:g+s.size*.5,y:y+s.size*.5};if(b.x<0||b.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,b,{type:n,mode:"any"}))){f.push(d);break}}}return f}o(Or,"getTemplateTokens");var Is={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},Ct={hero:{icon:"fa-solid fa-hospital-symbol",reroll:"PF2E.RerollMenu.HeroPoint",rerolled:"PF2E.RerollMenu.MessageHeroPoint"},new:{icon:"fa-solid fa-dice",reroll:"PF2E.RerollMenu.KeepNew",rerolled:"PF2E.RerollMenu.MessageKeep.new"},lower:{icon:"fa-solid fa-dice-one",reroll:"PF2E.RerollMenu.KeepLower",rerolled:"PF2E.RerollMenu.MessageKeep.lower"},higher:{icon:"fa-solid fa-dice-six",reroll:"PF2E.RerollMenu.KeepHigher",rerolled:"PF2E.RerollMenu.MessageKeep.higher"}},ks=["criticalFailure","failure","success","criticalSuccess"],Ds=P("preCreateChatMessage",As),Fr=ke("renderChatMessage",Ps),Hr=P("createMeasuredTemplate",Ts),Je=!1;function Ur(){return{settings:[{name:"target",type:Boolean,default:!1,onChange:Mr},{name:"target-client",type:String,default:"disabled",choices:["disabled","small","big"],scope:"client",onChange:e=>Fr(e&&S("target"))},{name:"target-template",type:Boolean,default:!1,scope:"client",onChange:e=>Hr(e&&S("target"))}],conflicts:[],init:()=>{S("target")&&Mr(!0)}}}o(Ur,"registerTargetTokenHelper");function Mr(e){Ds(e),Fr(e),Hr(e&&S("target-template")),Le()&&(e&&!Je?(ne(Rr),Je=!0):!e&&Je&&(re(Rr),Je=!1))}o(Mr,"setHooks");function Rr(e){if(oe())switch(e.type){case"target.update-save":wt(e);break;case"target.update-applied":zr(e);break}}o(Rr,"onSocket");async function Ts(e,t,n){let r=game.user;if(r.id!==n)return;let a=A("target.menu"),s=e.item,i=e.actor,c=i?i.token??i.getActiveTokens()[0]:void 0,l={title:s?.name||a("title"),content:await renderTemplate(T("target/template-menu"),{i18n:a,noSelf:!c}),buttons:{select:{icon:'<i class="fa-solid fa-bullseye-arrow"></i>',label:a("target"),callback:g=>({targets:g.find("[name=targets]:checked").val(),self:g.find("[name=self]").prop("checked"),neutral:g.find("[name=neutral]").prop("checked")})}},close:()=>null},u=await Dialog.wait(l,void 0,{id:"pf2e-toolbelt-target-template",width:260});if(!u)return;let f=i?i.alliance:r.isGM?"opposition":"party",d=f==="party"?"opposition":f==="opposition"?"party":null,p=Or(e).filter(g=>{if(!g.actor?.isOfType("creature","hazard","vehicle")||g.document.hidden)return!1;if(c&&g===c)return u.self;let b=g.actor?g.actor.alliance:g.alliance;return b===null?u.neutral:u.targets==="all"||u.targets==="allies"&&b===f||u.targets==="enemies"&&b===d}).map(g=>g.id);r.updateTokenTargets(p),r.broadcastActivity({targets:p})}o(Ts,"createMeasuredTemplate");var Lr;function xs(e){return Lr??=(()=>{let t=[game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage"),game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage")];return new RegExp(`^<div>(${t.join("|")})</div>`)})(),Lr.test(e.flavor)}o(xs,"isRegenMessage");function _r(e){return!e.rolls[0].options.evaluatePersistent}o(_r,"isValidDamageMessage");function As(e){let t=e.isDamageRoll,n=[];if(!(t&&!_r(e))){if(t&&!k(e,"target")){let r=e.token,a=r?.actor,s=xs(e),i=s?a?[{token:r.uuid,actor:a.uuid}]:[]:Array.from(game.user.targets.map(c=>({token:c.document.uuid,actor:c.actor.uuid})));if(n.push(["targets",i]),s&&n.push(["isRegen",!0]),e.rolls.length===2){let c=e.rolls.filter(f=>f.options),l=c.findIndex(f=>f.options.splashOnly),u=c.findIndex(f=>!f.options.splashOnly&&f.options.damage?.modifiers.some(d=>d.damageCategory==="splash"));l!==-1&&u!==-1&&n.push(["splashIndex",l])}}if(t||e.getFlag("pf2e","context.type")==="spell-cast"){let r=e.item,a=r&&r.type==="spell"&&r.system.defense?.save;if(a){let s=r.trickMagicEntry?$(e.content).find("[data-action=spell-save]").data()?.dc:r.spellcasting?.statistic.dc.value;typeof s=="number"&&n.push(["save",{...a,dc:s}])}}n.length&&fe(e,"target",n.reduce((r,[a,s])=>(r[a]=s,r),{}))}}o(As,"preCreateChatMessage");async function Ps(e,t){let n=Ie("target-client");if(n&&e.isDamageRoll){if(!_r(e))return;await Ms(e,t),$r(e);return}let r=e.item;if(!(!r||r.type!=="spell")){if(n&&!r.damageKinds.size){await Os(e,t,r),$r(e);return}r.trickMagicEntry&&r.system.defense?.save&&t.find("[data-action=spell-damage]").on("click",()=>{Re(e)})}}o(Ps,"renderChatMessage");function $r(e){Promise.all([ui.chat,ui.chat._popout].map(async t=>{let n=t?.element[0]?.querySelector("#chat-log");!n||!t.isAtBottom&&e.user._id!==game.user._id||(await t._waitForImages(),n.scrollTop=n.scrollHeight)}));for(let t of Object.values(e.apps))t instanceof ChatPopout&&t.rendered&&t.setPosition()}o($r,"refreshMessage");async function Os(e,t,n){let r=await Gr(e);if(!r)return;let{targets:a,save:s}=r,i=t.find(".message-content"),c=i.find(".card-buttons");if(game.user.isGM||e.isAuthor){let u=c.find("[data-action=spell-save]"),f=$('<div class="pf2e-toolbelt-target-wrapper"></div>'),d=x("target.chat.targets.tooltip"),m=$(`<button class="pf2e-toolbelt-target-targets" title="${d}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);m.on("click",h=>Nr(h,e)),f.append(m),f.append(u),c.prepend(f)}if(n?.area&&!n.traits.has("aura")&&canvas.scene?.templates.some(f=>f.message===e&&f.isOwner)&&c.find(".owner-buttons .hidden.small").removeClass("hidden"),!a.length)return;let l=$('<div class="pf2e-toolbelt-target-spell"></div>');for(let{template:u}of a)l.append("<hr>"),l.append(u);i.after(l),qr(e,l,s)}o(Os,"renderSpellChatMessage");function Nr(e,t){e.stopPropagation();let n=game.user.targets;q(t,"target.targets",Array.from(n.map(r=>({token:r.document.uuid,actor:r.actor.uuid}))))}o(Nr,"addTargets");async function Ms(e,t){let n=await Gr(e),r=t.find(".message-content"),a=r.find(".damage-application"),s=a.clone(),i=$('<div class="pf2e-toolbelt-target-buttons"></div>');if(n?.targets.length&&a.length){let f=o(()=>{let h=!!z(e,"target.expanded");m.toggleClass("collapse",h),a.toggleClass("hidden",!h)},"toggleDamageRow"),d=x("target.chat.toggle.tooltip"),m=$(`<button class="toggle" title="${d}">
    <i class="fa-solid fa-plus expand"></i>
    <i class="fa-solid fa-minus collapse"></i>
</button>`);f(),m.on("click",h=>{h.stopPropagation(),j(e,"target.expanded",!z(e,"target.expanded")),f()}),i.append(m)}if(n?.isRegen!==!0&&(game.user.isGM||e.isAuthor)){let f=x("target.chat.targets.tooltip"),d=$(`<button class="targets" title="${f}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);d.on("click",m=>Nr(m,e)),i.append(d)}if(t.find(".dice-result .dice-total").append(i),!n?.targets.length)return;let{targets:c,save:l}=n;if(!s.length)return;s.removeClass("damage-application").addClass("target-damage-application"),S("target-client")!=="big"&&s.find("button").addClass("small"),s.find("[data-action]").each(function(){let f=this.dataset.action;this.dataset.action=`target-${f}`});let u=$('<div class="pf2e-toolbelt-target-damage"></div>');for(let{uuid:f,template:d,save:m,applied:h={}}of c){let p=!!(m?.result&&m.basic),g=s.clone();u.append("<hr>"),u.append(d),g.each((y,b)=>{b.dataset.rollIndex=y,b.dataset.targetUuid=f,b.classList.toggle("applied",!!h[y]||p&&m.result.success==="criticalSuccess"),p&&b.classList.add(m.result.success)}),u.append(g)}r.after(u),qr(e,u,l),u.find("button[data-action^=target-]").on("click",f=>Hs(f,e))}o(Ms,"renderDamageChatMessage");function qr(e,t,n){t.find("[data-action=ping-target]").on("click",Fs),t.find("[data-action=open-target-sheet]").on("click",$s),t.find("[data-action=roll-save]").on("click",r=>Ls(r,e,n)),t.find("[data-action=reroll-save]").on("click",r=>Rs(r,e,n))}o(qr,"addHeaderListeners");async function Gr(e){let t=k(e,"target.targets")??[],n=game.user.isGM||game.settings.get("pf2e","metagame_showDC"),r=(()=>{let s=k(e,"target.save");if(s)return{...s,...Is[s.statistic]}})();if(!t.length&&!r)return;if(r){let s=game.i18n.format("PF2E.SavingThrowWithName",{saveName:game.i18n.localize(r.label)}),i=n?x("target.chat.save.dcWithValue",{dc:r.dc}):"";r.tooltipLabel=`${s} ${i}`,r.tooltip=await renderTemplate(T("target/save-tooltip"),{check:r.tooltipLabel})}return{targets:(await Promise.all(t.map(async({token:s})=>{let i=await fromUuid(s);if(!i?.isOwner)return;let c=i.id,l=i.actor,u=r&&!!l?.saves[r.statistic],f=await(async()=>{if(!u)return;let m=k(e,`target.saves.${c}`);if(!m)return;let h=m.rerolled,p=u&&!h,g=game.i18n.localize(`PF2E.Check.Result.Degree.Check.${m.success}`),y=m.value-r.dc;return{...m,canReroll:p,tooltip:await renderTemplate(T("target/save-tooltip"),{i18n:A("target.chat.save"),check:r.tooltipLabel,result:x(`target.chat.save.result.${n?"withOffset":"withoutOffset"}`,{success:g,offset:y>=0?`+${y}`:y,die:`<i class="fa-solid fa-dice-d20"></i> ${m.die}`}),modifiers:m.modifiers,canReroll:p,rerolled:Ct[h]})}})(),d=r&&{...r,result:f};return{uuid:s,target:i,save:d,applied:k(e,`target.applied.${c}`),template:await renderTemplate(T("target/row-header"),{name:i.name,uuid:s,save:u&&d,canReroll:f?.canReroll,rerolled:Ct[f?.rerolled],i18n:A("target.chat.row")})}}))).filter(Boolean),save:r,isRegen:k(e,"target.isRegen")}}o(Gr,"getMessageData");async function Qe(e){let{targetUuid:t}=e.currentTarget.closest("[data-target-uuid]").dataset;return fromUuid(t)}o(Qe,"getTargetFromEvent");function Br(e,t){return z(e,`target.save.${t.id}`)}o(Br,"isRollingSave");function jr(e,t){j(e,`target.save.${t.id}`,!0)}o(jr,"setRollingSave");async function Rs(e,t,{dc:n}){let r=await Qe(e),a=r?.actor;if(!a||Br(t,r))return;let s=k(t,`target.saves.${r.id}`);if(!s?.roll||s.rerolled)return;let i=a.isOfType("character")?a.heroPoints.value:0,c=Object.entries(Ct).map(([b,{icon:w,reroll:E}])=>{if(b==="hero"&&!i)return;let D=game.i18n.localize(E);return`<label><input type="radio" name="reroll" value="${b}"><i class="${w}"></i> ${D}</label>`}).filter(Boolean).join(""),l={yes:{icon:'<i class="fa-solid fa-rotate rotate"></i>',label:"reroll",callback:b=>b.find("[name=reroll]:checked").val()??null},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:"cancel",callback:()=>null}},u=await Dialog.wait({title:`${r.name} - ${x("target.chat.save.reroll.confirm.title")}`,content:c,buttons:l,close:()=>null},{id:`pf2e-toolbelt-target-save-reroll-dialog-${r.id}`});if(!u)return;let f=u==="hero",d=f?"new":u;if(f){let{value:b,max:w}=a.heroPoints;if(b<1){O("target.chat.save.reroll.noPoints");return}await a.update({"system.resources.heroPoints.value":Math.clamped(b-1,0,w)})}jr(t,r);let m=Roll.fromJSON(s.roll),h=m.clone();h.options.isReroll=!0,Hooks.callAll("pf2e.preReroll",Roll.fromJSON(s.roll),h,f,d);let p=await h.evaluate({async:!0});await vt(p),Hooks.callAll("pf2e.reroll",Roll.fromJSON(s.roll),p,f,d);let g=d==="higher"&&m.total>p.total||d==="lower"&&m.total<p.total?m:p;if(g===p){let b=new Ye(p,n,s.dosAdjustments);g.options.degreeOfSuccess=b.value}let y={type:"target.update-save",target:r.id,data:{value:g.total,die:g.dice[0].total,success:g.degreeOfSuccess,roll:JSON.stringify(g.toJSON()),dosAdjustments:deepClone(s.dosAdjustments),modifiers:deepClone(s.modifiers),rerolled:u}};g.options.keeleyAdd10&&y.data.modifiers.push({label:x("target.chat.save.reroll.keeley"),modifier:10}),game.user.isGM||t.isAuthor?(y.message=t,wt(y)):(y.message=t.id,_(y))}o(Rs,"rerollSave");async function Ls(e,t,{dc:n,statistic:r}){let a=await Qe(e),s=a?.actor;if(!s||Br(t,a))return;let i=s.saves[r];if(!i)return;jr(t,a);let c=(()=>{let f=t.item;if(f)return f;let d=k(t,"target.messageId");if(!d)return;let m=game.messages.get(d);if(m)return m.item})(),l=!game.user.settings.showCheckDialogs,u={type:"target.update-save",target:a.id};i.check.roll({dc:{value:n},item:c,origin:s,skipDialog:e.shiftKey?!l:l,createMessage:!1,callback:async(f,d,m)=>{await vt(f),u.data={value:f.total,die:f.dice[0].total,success:f.degreeOfSuccess,roll:JSON.stringify(f.toJSON()),dosAdjustments:m.getFlag("pf2e","context.dosAdjustments"),modifiers:m.getFlag("pf2e","modifiers").filter(h=>h.enabled).map(({label:h,modifier:p})=>({label:h,modifier:p}))},game.user.isGM||t.isAuthor?(u.message=t,wt(u)):(u.message=t.id,_(u))}})}o(Ls,"rollSave");async function wt({message:e,target:t,data:n}){typeof e=="string"&&(e=game.messages.get(e),!e)||(typeof n.success=="number"&&(n.success=ks[n.success]),await q(e,`target.saves.${t}`,deepClone(n)),Kt(e,`target.save.${t}`))}o(wt,"updateMessageSave");async function $s(e){let t=await Qe(e);t&&t.actor?.sheet.render(!0)}o($s,"openTargetSheet");async function Fs(e){if(!canvas.ready)return;let t=await Qe(e);t&&canvas.ping(t.center)}o(Fs,"pingTarget");async function Hs(e,t){let n=e.currentTarget,{rollIndex:r,targetUuid:a}=n.closest("[data-target-uuid]").dataset,s=await fromUuid(a);if(!s)return;let i=n.dataset.action;if(i==="target-shield-block"){Tr(s,n,t.element);return}St(s,{message:t,multiplier:i==="target-apply-healing"?-1:i==="target-half-damage"?.5:i==="target-apply-damage"?1:i==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:Number(r)})}o(Hs,"onTargetButton");function Ar(e,t,n){let r={};de(r,`target.applied.${t}.${n}`,!0);let a=k(e,"target.splashIndex");if(a!==void 0){let s=a===0?1:0;if(n===a)de(r,`target.applied.${t}.${s}`,!0);else{de(r,`target.applied.${t}.${a}`,!0);let i=k(e,"target.targets")??[];for(let c of i){let l=c.token?.split(".").at(-1);l!==t&&de(r,`target.applied.${l}.${s}`,!0)}}}game.user.isGM||e.isAuthor?zr({message:e,updates:r}):_({type:"target.update-applied",message:e.id,updates:r})}o(Ar,"onDamageApplied");function zr({message:e,updates:t}){typeof e=="string"&&(e=game.messages.get(e),!e)||e.update(t)}o(zr,"updateMessageApplied");var ye=null,Y=null;function Vr(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:Wr}],conflicts:["pf2e-unided"],init:()=>{Wr()}}}o(Vr,"registerUnided");function Wr(e){let t=e??S("unided");t==="disabled"?(ye&&(Hooks.off("preCreateItem",ye),ye=null),Y&&(Hooks.off("preUpdateItem",Y),Y=null)):(ye||(ye=Hooks.on("preCreateItem",Us)),t==="all"&&!Y?Y=Hooks.on("preUpdateItem",_s):t!=="all"&&Y&&(Hooks.off("preUpdateItem",Y),Y=null))}o(Wr,"setHooks");function Us(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}o(Us,"preCreateItem");function _s(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}o(_s,"preUpdateItem");var Ns=P("updateCombat",qs);function Kr(){return{settings:[{name:"force-untarget",type:Boolean,default:!1,onChange:Et},{name:"untarget",type:Boolean,default:!1,scope:"client",onChange:Et}],init:()=>{Et()}}}o(Kr,"registerUntarget");function Et(){Ns(S("force-untarget")||S("untarget"))}o(Et,"setup");function qs(e,t){if(!("turn"in t)&&!("round"in t))return;let n=game.user;n.updateTokenTargets(),n.broadcastActivity({targets:[]})}o(qs,"updateCombat");var se=A("macros.condition");async function Yr(e){let t=o((f,d)=>{let m=f.find("[name=condition]"),{name:h,slug:p,img:g}=m.find(":selected").data();return{type:d,slug:p,img:g,name:f.find("[name=name]").val().trim()||se("effect-name",{condition:h}),uuid:m.val(),badge:Number(f.find("[name=badge]").val()||1),unidentified:f.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:se("generate"),callback:f=>t(f,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:se("add"),callback:f=>t(f,"add")}},r=Array.from(game.pf2e.ConditionManager.conditions.values()),a=new Set(r.filter(f=>!!f.badge).map(f=>f.slug)),s=await renderTemplate(T("macros/condition"),{i18n:se,conditions:Array.from(new Set(r.sort((f,d)=>f.name.localeCompare(d.name))))}),i=o(f=>{let{name:d,slug:m}=f.find("[name=condition] :selected").data();f.find("[name=name]").prop("placeholder",se("effect-name",{condition:d}));let h=a.has(m),p=f.find("[name=badge]");p.prop("disabled",!h),h||p.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:s,title:se("title"),close:()=>null,render:f=>{i(f),f.find("[name=condition]").on("change",()=>i(f))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&a.has(c.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let u={name:c.name,type:"effect",img:c.img,system:{rules:[l],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(u):await e.createEmbeddedDocuments("Item",[u])}o(Yr,"permaConditionEffect");var kt=[_t(),Zn(),rn(),Hn(),Vr(),Bn(),zt(),Sr(),cr(),ln(),Yn(),er(),Ur(),Kr(),Mn(),jt()],Jr=new Set,Dt=null;Hooks.once("init",()=>{let e=Le(),t=kt.flatMap(({settings:s=[]})=>s.map(i=>{let c=i.name;return i.choices&&(i.choices=i.choices.reduce((l,u)=>(l[u]=It(c,`choices.${u}`),l),{})),i.key=c,i.scope??="world",i.config??=!0,i.name=It(c,"name"),i.hint=It(c,"hint"),i})),[n,r]=["world","client"].map(s=>t.filter(i=>i.scope===s));for(let s of[n,r].flat())game.settings.register(C,s.key,s);e&&(Dt=r[0].key,Hooks.on("renderSettingsConfig",Gs));let a=game.modules.get(C);a.api={macros:{permaConditionEffect:Yr}};for(let s of kt){let{init:i,conflicts:c=[],api:l,name:u}=s;if(e)for(let f of c){let d=game.modules.get(f);d?.active&&(s.conflicting=!0,Jr.add(d.title))}l&&u&&(a.api[u]=l),!s.conflicting&&i&&i(e)}});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of kt)!t&&n&&n(e);if(e)for(let t of Jr)O("module-conflict",{name:t},!0)});function It(e,t){return`${C}.settings.${e}.${t}`}o(It,"settingPath");function Gs(e,t){if(!Dt)return;t.find(`.tab[data-tab=${C}] [data-setting-id="${C}.${Dt}"]`).before(`<h3>${x("settings.client")}</h3>`)}o(Gs,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
