(()=>{var Gt=Object.defineProperty;var o=(e,t)=>Gt(e,"name",{value:t,configurable:!0});var h="pf2e-toolbelt";function p(e){return game.settings.get(h,e)}o(p,"getSetting");function De(e,t){return game.settings.set(h,e,t)}o(De,"setSetting");function y(...e){let[t,n]=e;return t=`${h}.${t}`,n?game.i18n.format(t,n):game.i18n.localize(t)}o(y,"localize");function zt(e){return game.i18n.has(`${h}.${e}`,!1)}o(zt,"hasLocalization");function Bt(e){return`${h}.${e}`}o(Bt,"localizePath");function b(e){let t=o((...n)=>y(`${e}.${n[0]}`,n[1]),"fn");return Object.defineProperties(t,{warn:{value:(...n)=>T(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},info:{value:(...n)=>G(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},error:{value:(...n)=>z(`${e}.${n[0]}`,n[1],n[2]),enumerable:!1,configurable:!1},has:{value:n=>zt(`${e}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>Bt(`${e}.${n}`),enumerable:!1,configurable:!1},template:{value:(n,{hash:s})=>t(n,s),enumerable:!1,configurable:!1}}),t}o(b,"subLocalize");function le(e,t,n,s){let i=typeof t=="string"?t:"info",a=typeof t=="object"?t:typeof n=="object"?n:void 0,c=typeof t=="boolean"?t:typeof n=="boolean"?n:s??!1;ui.notifications.notify(y(e,a),i,{permanent:c})}o(le,"notify");function T(...e){let[t,n,s]=e;le(t,"warning",n,s)}o(T,"warn");function G(...e){let[t,n,s]=e;le(t,"info",n,s)}o(G,"info");function z(...e){let[t,n,s]=e;le(t,"error",n,s)}o(z,"error");function _(e,t){libWrapper.register(h,e,t)}o(_,"registerWrapper");function k(e,t,n){return e.getFlag(h,t)??n}o(k,"getFlag");function ue(e,t,n){return e.setFlag(h,t,n)}o(ue,"setFlag");function v(...e){return e=e.filter(t=>typeof t=="string"),`modules/${h}/templates/${e.join("/")}.hbs`}o(v,"templatePath");function X(e,t){return e.localeCompare(t,game.i18n.lang)}o(X,"localeCompare");function Z(e){game.socket.on(`module.${h}`,e)}o(Z,"socketOn");function ee(e){game.socket.off(`module.${h}`,e)}o(ee,"socketOff");function P(e){game.socket.emit(`module.${h}`,e)}o(P,"socketEmit");function te(){return game.user===game.users.activeGM}o(te,"isActiveGM");function Oe(e,t){let n=Hooks.on(e,t),s=Hooks.events[e].findIndex(i=>i.id===n);if(s!==0){let[i]=Hooks.events[e].splice(s,1);Hooks.events[e].unshift(i)}return n}o(Oe,"registerUpstreamHook");function xe(){return game.users.some(e=>e.active&&e.isGM)}o(xe,"isGMOnline");function x(e,t,n=!1){return n?`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`:t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}o(x,"chatUUID");function Re(e){return e.getFlag("core","sourceId")}o(Re,"getSourceId");function qt(e,t){let n=Re(e);return n?t.includes(n):!1}o(qt,"includesSourceId");function Me(e){return Array.isArray(e)?t=>qt(t,e):t=>Re(t)===e}o(Me,"getItemSourceIdCondition");function $e(e,t,n){return Ue(e,n).some(Me(t))}o($e,"hasItemWithSourceId");function ne(e,t,n){return Ue(e,n).find(Me(t))}o(ne,"getItemWithSourceId");function Ue(e,t){return t=typeof t=="string"?[t]:t,t?t.flatMap(n=>e.itemTypes[n]):e.items}o(Ue,"getItems");function H(e){for(let t of Object.values(ui.windows)){let n=t.actor;!(t instanceof ActorSheet)||!n.isOfType("character")||(!e||e===n)&&t.render()}}o(H,"refreshCharacterSheets");function Le(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}o(Le,"documentUuidFromTableResult");function fe(e,t=!1){return t?game.users.find(n=>n.active&&n.character===e):game.users.find(n=>n.character===e)}o(fe,"getCharacterOwner");function de(e,t=!1){return t?game.users.find(n=>n.active&&e.testUserPermission(n,"OWNER")):game.users.find(n=>e.testUserPermission(n,"OWNER"))}o(de,"getOwner");function Wt(e){let t=game.users.filter(n=>n.active&&!n.isGM&&e.testUserPermission(n,"OWNER"));return t.sort((n,s)=>n.id>s.id?1:-1),t[0]||null}o(Wt,"getActiveOwner");function pe(e){return Wt(e)===game.user}o(pe,"isActiveOwner");function*B(e,t){let n=game.messages.contents,s=(t?n.findLastIndex(i=>i===t):n.length)-1;for(let i=s;i>=s-e;i--){let a=n[i];if(!a)return;yield a}}o(B,"latestChatMessages");var Vt="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",Kt="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",Yt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",Qt="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",Jt=["Compendium.pf2e.equipment-srd.Item.ZhxxqYpVdVx0jSMm"];function _e(){return{settings:[{name:"arp",type:Boolean,default:!1,requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{p("arp")&&(_(Vt,Xt,"WRAPPER"),_(Kt,tn,"WRAPPER"),_(Yt,nn,"WRAPPER"),_(Qt,an,"WRAPPER"))},ready:e=>{e&&p("arp")&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),G("arp.forceVariant"))}}}o(_e,"registerArp");function se(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}o(se,"isValidActor");function He(e){let t=e._source.system.traits.value;return!t.includes("alchemical")&&!t.includes("bomb")&&!Jt.includes(e.sourceId)}o(He,"isValidWeapon");function Xt(e){let t=this.actor;if(!se(t,!0)||!He(this))return e();let n=t.level,s=this._source.system.traits.value;if(s.includes("alchemical")&&s.includes("bomb"))return e();this.system.potencyRune.value=n<2?null:n<10?1:n<16?2:3,this.system.strikingRune.value=n<4?null:n<12?"striking":n<19?"greaterStriking":"majorStriking",e()}o(Xt,"onPrepareWeaponData");var Zt={1:35,2:935,3:8935,4:8935},en={striking:65,greaterStriking:1065,majorStriking:31065};function tn(e){if(e(),!se(this.actor)||this.isSpecific||!He(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=Zt[n]);let s=this.system.strikingRune.value;s&&(t-=en[s]),(n||s)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}o(tn,"onPrepareWeaponDerivedData");function Fe(e){return!e.isShield}o(Fe,"isValidArmor");function nn(e){let t=this.actor;if(!se(t,!0)||!Fe(this))return e();let n=t.level;this.system.potencyRune.value=n<5?null:n<11?1:n<18?2:3,this.system.resiliencyRune.value=n<8?null:n<14?"resilient":n<20?"greaterResilient":"majorResilient",e()}o(nn,"onPrepareArmorData");var sn={1:160,2:1060,3:20560,4:20560},on={resilient:340,greaterResilient:3440,majorResilient:49440};function an(e){if(e(),!se(this.actor)||this.isSpecific||!Fe(this))return;let t=this.price.value.goldValue,n=this.system.potencyRune.value;n&&(t-=sn[n]);let s=this.system.resiliencyRune.value;s&&(t-=on[s]),(n||s)&&!this.system.runes.property.length&&(t+=new game.pf2e.Coins(this._source.system.price.value).goldValue),this.system.price.value=new game.pf2e.Coins({gp:t})}o(an,"onPrepareArmorDerivedData");function w(e,t,n=()=>{}){let s=null;return function(i,a=[],c=!1){typeof a=="string"&&(a=[a]),i||=a.some(r=>p(r)),i&&!s?s=Hooks.on(e,t):!i&&s&&(Hooks.off(e,s),s=null),c||n(i)}}o(w,"createHook");function oe(e,t,n=()=>{}){let s=null;return function(i,a=!1){i==="disabled"&&s?(Hooks.off(e,s),s=null):i!=="disabled"&&!s&&(s=Hooks.on(e,t)),a||n(i)}}o(oe,"createChoicesHook");var me=w("renderEffectsPanel",cn,rn);function Ne(){return{settings:[{name:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:e=>me(e,"condition-sheet")},{name:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:e=>me(e,"effect-remove")}],conflicts:["pf2e-effect-description"],init:()=>{me(!1,["effect-remove","condition-sheet"])}}}o(Ne,"registerEffectsPanelHelper");function rn(){game.pf2e.effectPanel?.render()}o(rn,"refreshEffectsPanel");function cn(e,t){let n=`<div>${y("effects.remove")}</div>`,s='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',i=t.find(".effect-item[data-item-id]").toArray();for(let a of i){let c=a.dataset.itemId,r=e.actor?.items.get(c);if(r&&(p("effect-remove")&&!r.isLocked&&r.badge&&r.badge.type==="counter"&&(a.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),a.querySelector(".icon").addEventListener("contextmenu",l=>un(l,e),!0)),p("condition-sheet")&&r.isOfType("condition"))){let l=a.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",s),l.querySelector('[data-action="edit"]').addEventListener("click",u=>ln(u,e))}}}o(cn,"renderEffectsPanel");function ln(e,t){let n=je(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}o(ln,"onConditionSheet");function un(e,t){if(!e.shiftKey)return;let n=je(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}o(un,"onRemoveEffect");function je(e,t){let i=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(i)}o(je,"getEffect");var q=class extends FormApplication{constructor(t,n,s){super(t,n),this.onSubmitCallback=s}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};o(q,"MoveLootPopup");var ie=!1,W=null;function qe(){return{settings:[{name:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:Ge}],conflicts:["pf2e-giveth"],ready:e=>{p("giveth")!=="disabled"&&Ge(!0)}}}o(qe,"registerGiveth");function Ge(e){let t=game.user.isGM;e==="disabled"&&ie?(t?ee(ze):W&&(Hooks.off("dropCanvasData",W),W=null),ie=!1):e!=="disabled"&&!ie&&(t?Z(ze):W||(W=Oe("dropCanvasData",fn)),ie=!0)}o(Ge,"setup");function ze(e){te()&&(e.type==="giveth-condition"?mn(e):e.type==="giveth-effect"?gn(e):hn(e))}o(ze,"onSocket");function fn(e,t){if(!xe())return!0;let n=pn(t);if(!n)return!0;let s=e.tokens.placeables.slice().filter(i=>{if(!i.document.actorLink)return!1;let a=i.actor;if(!We(a,t.actorId)||a.isOwner)return!1;let c=i.x+(i.hitArea?.right??0),r=i.y+(i.hitArea?.bottom??0);return t.x>=i.x&&t.y>=i.y&&t.x<=c&&t.y<=r}).sort((i,a)=>a.document.sort-i.document.sort).at(0)?.actor;return s?(dn(n.actor,s,n.item,n.value),!1):!0}o(fn,"onDropCanvasData");function dn(e,t,n,s){let i=e.id,a=t.id,c=!(n instanceof Item);if(!c&&n.isOfType("physical")){let r=n.quantity;if(r<1)return T("giveth.notification.zero");if(r===1)return Be(i,a,n.id,1,!1);new q(e,{maxQuantity:r,lockStack:!1,isPurchase:!1},(l,u)=>{Be(i,a,n.id,l,u)}).render(!0)}else{let r=c?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?P({type:"giveth-condition",targetId:a,value:s??1,uuid:r}):P({type:"giveth-effect",targetId:a,uuid:r})}}o(dn,"giveth");function Be(e,t,n,s,i){P({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:s,stack:i})}o(Be,"sendPhysicalRequest");function We(e,t){return!e||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}o(We,"isValidActor");function pn(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let i=e.context?.origin.actor;n=i?fromUuidSync(i):null}if(!We(n)||!n.isOwner)return;let s=!(t instanceof Item);if(s&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!s&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}o(pn,"getDetailsFromData");async function mn({targetId:e,uuid:t,value:n}){let s=game.actors.get(e);if(!s)return;let i=await fromUuid(t);i&&s.increaseCondition(i.slug,{min:n})}o(mn,"takethCondition");async function gn({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let s=await fromUuid(t);if(!s)return;let i=s.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[i])}o(gn,"takethEffect");async function hn({itemId:e,ownerId:t,qty:n,stack:s,targetId:i}){let a=game.actors.get(t),c=game.actors.get(i);if(!a||!c)return;let r=a.items.get(e);if(!r)return;n=Math.min(n,r.quantity);let l=r.quantity-n,u=r.toObject();u.system.quantity=n,u.system.equipped.carryType="worn",r.isOfType("physical")&&"invested"in u.system.equipped&&(u.system.equipped.invested=r.traits.has("invested")?!1:null);let f=await c.addToInventory(u,void 0,s);if(!f||(l<1?r.delete():r.update({"system.quantity":l}),p("giveth")==="no-message"))return;let g=x(f.uuid,f.name,!f.isIdentified);n>1&&(g+=` x${n}`),ChatMessage.create({flavor:`<h4 class="action">${y("giveth.giveth",{target:c.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:a})})}o(hn,"takethPhysical");var Ve=b("knowledges.editLore"),V=class extends FormApplication{get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Ve("title",this.actor)}get template(){return v("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:k(n,"unspecified")??"",specific:k(n,"specific")??"",i18n:Ve})}async _updateObject(t,{unspecified:n,specific:s}){let i=this.object;ue(i,"unspecified",n.trim()),ue(i,"specific",s.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};o(V,"EditLores");var Ke=w("renderNPCSheetPF2e",yn);function Ye(){return{settings:[{name:"knowledges",type:Boolean,default:!1,onChange:e=>Ke(e)}],conflicts:["pf2e-npc-knowledges"],ready:e=>{e&&p("knowledges")&&Ke(!0)}}}o(Ye,"registerKnowledges");function yn(e,t){let n=e.actor;vn(n,t),Sn(t),Cn(n,t)}o(yn,"renderNPCSheetPF2e");function ge(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}o(ge,"knowledgeSelector");function bn(e){new V(e).render(!0)}o(bn,"editLores");function vn(e,t){let n=k(e,"unspecified"),s=k(e,"specific");if(!n&&!s)return;let i=e.identificationDCs.lore,a=ge(t,"body","");a.find(".identification-skills").last().remove();function c(l,u,f){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:u,adjustment:f})}</div>`}o(c,"tag");function r(l,{dc:u,start:f}){let g=l.split(",").filter(m=>m.trim()).map(m=>c(m,u,f)).join("");a.append(g)}o(r,"addTags"),r(n||"Unspecific",i[0]),r(s||"Specific",i[1])}o(vn,"replaceLores");function Cn(e,t){ge(t,"header","button.edit").on("click",()=>bn(e))}o(Cn,"addEvents");function Sn(e){let t=ge(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}o(Sn,"addEditButton");var he=b("merge.multi"),K=class extends Application{constructor(t,n){super(n),this._spell=t}get spell(){return this._spell}get title(){return he("title",this.spell)}get template(){return v("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:he})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#e.bind(this)),t.find("[data-action=cancel]").on("click",this.#t.bind(this))}async#e(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){he.error("zero"),this.close();return}let s=this.spell,i=deepClone(s._source.system.damage.value),a=deepClone(s._source.system.heightening)??{};for(let[r,l]of Object.entries(i))for(let u=0;u<n-1;u++){let f=randomID();if(i[f]=l,a.type==="interval"){let g=a.damage[r];g&&(a.damage[f]=g)}else if(a.type==="fixed")for(let[g,m]of Object.entries(a.levels)){let S=m.damage.value[r];S&&(a.levels[g].damage.value[f]=S)}}s.clone({"system.damage.value":i,"system.heightening":a}).rollDamage(t),this.close()}#t(t){t.preventDefault(),this.close()}};o(K,"MultiCast");var kn=/<div class="tags"><span class="tag".+?<\/div>/gm,wn=/<span class="tag tag_transparent">(.+?)<\/span>/gm,In=/(\[[\w,]+\])/,ye=w("renderChatMessage",et,Tn);function Ze(){return{settings:[{name:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:e=>ye(e,"multi-cast")},{name:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:e=>ye(e,"merge-damage")}],init:e=>{ye(!1,["multi-cast","merge-damage"],!0)}}}o(Ze,"registerMerge");function Tn(){let e=ui.chat?.element;if(e)for(let t of B(10)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find("[data-action=multi-cast]").remove(),n.find("[data-action=merge-damage]").remove(),et(t,n))}}o(Tn,"updateMessages");function et(e,t){!game.user.isGM&&!e.isAuthor||(p("merge-damage")&&nt(e)?An(e,t):p("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&En(e,t))}o(et,"renderChatMessage");function En(e,t){let n=e.getFlag("pf2e","origin.uuid");if(!n)return;let s=t.find(".message-content .chat-card .owner-buttons .spell-button");s.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${y("merge.spell.button")}</button>`),s.find("[data-action=multi-cast]").on("click",async i=>{let a=await fromUuid(n);a&&new K(a).render(!0)})}o(En,"renderSpell");function An(e,t){let n=be(e);if(!n)return;let i=`<span class="pf2e-toolbelt-merge">
    <button data-action="merge-damage" title="${y("merge.damage.tooltip")}" >
        <i class="fa-duotone fa-merge"></i>
    </button>
</span>`,a=ve(e);t.find(".dice-result .dice-total").append(i),t.find("[data-action=merge-damage]").on("click",c=>{c.stopPropagation();for(let r of B(5,e))if(!(be(r)!==n||ve(r)!==a||!nt(r))){Pn(c,e,r);return}T("merge.damage.none")})}o(An,"renderDamage");async function Pn(e,t,n){let s=Dn(t,n),i=On(t,n),a=Je(n),c=Xe(n),r=ve(t),l=be(t);for(let d of Je(t))a.includes(d)||a.push(d);for(let d of Xe(t))c.includes(d)||c.push(d);let u=Qe(t),f=Qe(n),g=[];function m(d){return g.find(({options:{flavor:A,critRule:C}})=>A===d.flavor&&C===d.critRule)}o(m,"findGroup");for(let d of[].concat(f,u)){let{options:A,total:C,terms:D}=d,O=D[0],j=d.formula.replace(In,""),M=m(A);M?(M.terms.push(O),M.total+=C,M.formulas.push(j)):g.push({options:A,formulas:[j],total:C,terms:[O]})}for(let d of g)d.formula=`(${d.formulas.join(" + ")})[${d.options.flavor}]`,d.term=d.terms.length<2?d.terms[0]:tt(d.terms);let S={class:"DamageRoll",options:{},dice:[],formula:`{${g.map(({formula:d})=>d).join(", ")}}`,total:g.reduce((d,{total:A})=>d+A,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:g.map(({formula:d})=>d),modifiers:[],rolls:g.map(({options:d,formula:A,total:C,term:D})=>({class:"DamageInstance",options:d,dice:[],formula:A,total:C,terms:[D],evaluated:!0})),results:g.map(({total:d})=>({result:d,active:!0}))}]};ui.chat.element.find(`[data-message-id=${t.id}], [data-message-id=${n.id}]`).remove(),await ChatMessage.deleteDocuments([t.id,n.id]);let I=await renderTemplate(v("merge/merged"),{header:y("merge.merged.header",{name:s}),tags:i,notes:a,modifiers:c});await CONFIG.ChatMessage.documentClass.create({flavor:I,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[h]:{name:s,tags:i,notes:a,modifiers:c,uuid:l,type:"damage-roll",target:r,merged:!0}},rolls:[S]})}o(Pn,"mergeDamages");function tt(e){let t=deepClone(e[0].options);return e.map(n=>(n.options={},n)),{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?tt(e):e[0]]}}}o(tt,"createTermGroup");function Qe(e){return k(e,"rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}o(Qe,"getMessageRolls");function be(e){return Ce(e,"origin.uuid","uuid")}o(be,"getMessageUuid");function nt(e){return Ce(e,"context.type","type")==="damage-roll"}o(nt,"isDamageRoll");function ve(e){return Ce(e,"context.target.token","target")}o(ve,"getMessageTarget");function Dn(e,t){return k(e,"name")??k(t,"name")??e.getFlag("pf2e","strike.name")??e.item.name}o(Dn,"getItemName");function On(e,t){return k(e,"tags")??k(t,"tags")??e.flavor.match(kn)?.[0]??""}o(On,"getTags");function Je(e){return k(e,"notes")??e.getFlag("pf2e","context.notes").map(({title:t,text:n})=>`<strong>${game.i18n.localize(t)}</strong> ${game.i18n.localize(n)}`)}o(Je,"getMessageNotes");function Xe(e){let t=k(e,"modifiers");if(t)return t;t=[];let n;for(;n=wn.exec(e.flavor);)t.push(n[1]);return t}o(Xe,"getMessageModifiers");function Ce(e,t,n){return e.getFlag("pf2e",t)??k(e,n)}o(Ce,"getMessageFlag");var xn="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments";function st(){return{settings:[{name:"nobulk",type:Boolean,default:!1,requiresReload:!0}],init:()=>{p("nobulk")&&_(xn,Rn,"WRAPPER")}}}o(st,"registerNobulk");function Rn(e,...t){e(...t);let n=this,s=n.inventory.bulk.constructor;Object.defineProperty(n.inventory,"bulk",{get(){let i=new s(n);return i.value=s.computeTotalBulk(n.inventory.filter(a=>!a.isInContainer&&a.system.equipped.carryType!=="dropped"),n.size),i}})}o(Rn,"actorPrepareEmbeddedDocuments");var Mn=w("renderCharacterSheetPF2e",Nn),$n=w("deleteCombat",Gn),Un=w("deleteCombatant",ut),Ln=w("createCombatant",zn),_n=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Hn=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),Fn=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}]]);function it(){return{name:"stances",settings:[{name:"stances",type:Boolean,default:!1,scope:"client",onChange:ot},{name:"custom-stances",type:String,default:""}],conflicts:["pf2e-stances"],api:{getStances:Se,toggleStance:lt,isValidStance:at},ready:e=>{p("stances")&&ot(!0)}}}o(it,"registerStances");function ot(e){Mn(e),$n(e),Un(e),Ln(e)}o(ot,"setup");function at(e){return e&&e.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}o(at,"isValidStance");function Se(e){let t=[],n=new Set;for(let{replace:s,sourceId:i,effectUUID:a,effect:c,img:r,name:l,itemName:u,action:f}of rt(e)){s&&n.add(s);let g=f?ne(e,f,"action"):ne(e,i,"feat");t.push({name:l,itemName:u,uuid:i,img:r,effectUUID:a,effectID:c?.id,actionUUID:g.sourceId,actionID:g.id})}return t.filter(({uuid:s})=>!n.has(s))}o(Se,"getStances");async function Nn(e,t){let n=e.actor,s=await Se(n);if(!s.length)return;let i=n.getActiveTokens(!0,!0).some(l=>l.inCombat),a=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),c=a.find(".actions-options"),r=await renderTemplate(v("stances/sheet"),{stances:s,canUseStances:i&&!n.isDead,i18n:b("stances")});c.length?c.after(r):a.prepend(r),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>jn(l,n))}o(Nn,"renderCharacterSheetPF2e");function jn(e,t){let n=e.currentTarget,s=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!s)return;let i=n.dataset.effectUuid;lt(t,i)}o(jn,"onToggleStance");function*rt(e){for(let t of e.itemTypes.feat){let n=t.sourceId,s=Hn.get(n),i=Fn.get(n);if(!s&&!i&&!at(t))continue;let a=s?.effect??i?.effect??t.system.selfEffect.uuid,c=fromUuidSync(a);c&&(yield{name:(s&&fromUuidSync(s.replace)?.name)??t.name,itemName:t.name,replace:s?.replace,extra:i,sourceId:n,effectUUID:a,effect:ne(e,a,"effect"),action:i?.action,img:c.img})}}o(rt,"actorStances");function ct(e){let t=[];for(let{effect:n}of rt(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}o(ct,"getStancesEffects");async function lt(e,t){let n=ct(e),s=n.findIndex(a=>a.uuid===t),i=!1;if(s===-1)i=!0;else{let a=n.filter(r=>r.uuid!==t).length,c=n.filter(r=>r.uuid===t).length>1;(a||c)&&n.splice(s,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(a=>a.id)),i&&ke(e,t)}o(lt,"toggleStance");async function ke(e,t){let n=await fromUuid(t);if(n){let s=n.toObject();return getProperty(s,"flags.core.sourceId")||setProperty(s,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[s]))[0]?.toMessage(),!0}return!1}o(ke,"addStance");function Gn(e){for(let t of e.combatants)ut(t)}o(Gn,"deleteCombat");function ut(e){let t=ft(e);if(t){if(!game.user.isGM&&pe(t)){let n=ct(t).map(s=>s.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}H(t)}}o(ut,"deleteCombatant");function zn(e){let t=ft(e);t&&(!game.user.isGM&&pe(t)&&Bn(t),H(t))}o(zn,"createCombatant");function ft(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}o(ft,"getActorFromCombatant");async function Bn(e){let t=Se(e);if(!(!t.length||t.filter(({effectID:i})=>i).length||!$e(e,_n,["feat"])))if(t.length===1){let i=t[0];await ke(e,i.effectUUID)&&G("stances.useStance",{stance:i.name})}else qn(e,t)}o(Bn,"checkForSavant");async function qn(e,t){let n=b("stances.menu");new Dialog({title:n("title"),content:await renderTemplate(v("stances/menu"),{stances:t,i18n:n}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:s=>ke(e,s.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}o(qn,"openStancesMenu");var dt=oe("renderCharacterSheetPF2e",Wn,()=>H());function pt(){return{settings:[{name:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>dt(e)}],conflicts:["pf2e-spells-summary"],init:e=>{p("summary")!=="disabled"&&dt(!0,!0)}}}o(pt,"registerSpellsSummary");async function Wn(e,t){let n=e.actor;if(!n||n.pack||!n.id||!game.actors.has(n.id))return;let s=Y(t);getProperty(e,`modules.${h}.toggled`)&&s.addClass("toggled"),as(t).on("click",i=>is(i,t,e)),await Vn(t,e,n),s.hasClass("toggled")&&s.hasClass("active")&&e._restoreScrollPositions(t)}o(Wn,"renderCharacterSheetPF2e");async function Vn(e,t,n){let s=Y(e),i=await ls(n),a=await renderTemplate(v("summary/sheet"),i);s.append(a),Kn(e,t,n)}o(Vn,"addSummaryTab");function Kn(e,t,n){let s=cs(e),i=s.find(".spell-type .uses .spell-slots-input input");i.on("change",a=>Yn(a,n)),i.on("focus",Qn),i.on("blur",Jn),s.find(".cast-spell").on("click",a=>ns(a,n)),s.find(".item-toggle-prepare").on("click",a=>Xn(a,n)),s.find(".focus-pips").on("click contextmenu",a=>Zn(a,n)),s.find(".spell-slots-increment-reset").on("click",a=>ts(a,t,n)),s.find(".item-image").on("click",a=>os(a,n)),s.find(".item-name > h4").on("click",a=>ss(a,t))}o(Kn,"addSummaryEvents");async function Yn(e,t){e.preventDefault();let{inputPath:n,entryId:s}=$(e.currentTarget).data(),i=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:s,[n]:i}])}o(Yn,"onUsesInputChange");function Qn(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}o(Qn,"onUsesInputFocus");function Jn(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}o(Jn,"onUsesInputBlur");function Xn(e,t){e.preventDefault();let{slotLevel:n,slotId:s,entryId:i,expended:a}=$(e.currentTarget).closest(".item").data();t.spellcasting.collections.get(i)?.setSlotExpendedState(n??0,s??0,a!==!0)}o(Xn,"onTogglePrepare");function Zn(e,t){e.preventDefault();let n=e.type==="click"?1:-1,s=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":s})}o(Zn,"onToggleFocusPool");function es(e,t){rs(e.element).find(`.item-container.spellcasting-entry[data-item-id=${t}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click()}o(es,"onChargeReset");function ts(e,t,n){e.preventDefault();let{itemId:s,level:i,isCharge:a}=$(e.currentTarget).data();if(!s)return;if(a){es(t,s);return}let c=n.items.get(s);if(c){if(c.isOfType("spellcastingEntry")){let r=i>=0&&i<=11?`slot${i}`:"slot0",l=c.system.slots?.[r];l&&c.update({[`system.slots.${r}.value`]:l.max})}else if(c.isOfType("spell")){let r=c.system.location.uses?.max;r&&c.update({"system.location.uses.value":r})}}}o(ts,"onSlotsReset");function ns(e,t){e.preventDefault();let n=$(e.currentTarget);if(n.prop("disabled"))return;let{itemId:s,slotLevel:i,slotId:a,entryId:c}=n.closest(".item").data(),r=t.spellcasting.collections.get(c);if(!r)return;let l=r.get(s);l&&r.entry.cast(l,{slot:a,level:i})}o(ns,"onCastSpell");async function ss(e,t){let n=e.currentTarget.closest(".item");await t.itemRenderer.toggleSummary(n)}o(ss,"onToggleSummary");async function os(e,t){let n=$(e.currentTarget).closest(".item").attr("data-item-id"),s=t.items.get(n);!s||s.isOfType("physical")&&!s.isIdentified||await s.toMessage(e)}o(os,"onItemToChat");function is(e,t,n){e.preventDefault();let s=Y(t);s.hasClass("active")&&(s.toggleClass("toggled"),s.scrollTop(0),setProperty(n,`modules.${h}.toggled`,s.hasClass("toggled")))}o(is,"onSpellcastingBtnToggle");function as(e){return e.find("nav.sheet-navigation .item[data-tab=spellcasting]")}o(as,"getSpellcastingNav");function Y(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}o(Y,"getSpellcastingTab");function rs(e){return Y(e).find(".directory-list.spellcastingEntry-list")}o(rs,"getSpellcastingOriginalSection");function cs(e){return Y(e).find(".directory-list.summary")}o(cs,"getSpellcastingSummarySection");async function ls(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,s=[],i=[],a=!1;if(await Promise.all(e.spellcasting.regular.map(async l=>{let u=l.id,f=l.statistic.dc.value,g=l.name,m=await l.getSheetData(),S=m.isFocusPool,I=l.system?.prepared?.value==="charge",d=getProperty(l,"flags.pf2e-staves.staveID")!==void 0,A={value:getProperty(l,"flags.pf2e-staves.charges")??0};for(let C of m.levels){if(!C.active.length||C.uses?.max===0)continue;let D=[],O=C.isCantrip,j=C.active.filter(U=>U&&U.uses?.max!==0),M=!O&&I&&!n;for(let U=0;U<j.length;U++){let{spell:L,expended:Ht,virtual:Ft,uses:Nt,castLevel:jt}=j[U];D.push({name:L.name,img:L.img,range:L.system.range.value||"-",castLevel:jt??L.level,slotId:U,entryId:u,entryDc:f,entryName:g,itemId:L.id,inputId:m.isInnate?L.id:m.id,inputPath:I?"flags.pf2e-staves.charges":m.isInnate?"system.location.uses.value":`system.slots.slot${C.level}.value`,isCharge:I,isActiveCharge:I&&n,isBroken:M,isVirtual:Ft,isInnate:m.isInnate,isCantrip:O,isFocus:S,isPrepared:m.isPrepared,isSpontaneous:m.isSpontaneous||m.isFlexible,slotLevel:C.level,uses:Nt??(I?A:C.uses),expended:Ht??(S&&!O?t.value<=0:!1),action:L.system.time.value,type:I?d?`${h}.summary.staff`:`${h}.summary.charges`:m.isInnate?"PF2E.PreparationTypeInnate":m.isSpontaneous?"PF2E.PreparationTypeSpontaneous":m.isFlexible?"PF2E.SpellFlexibleLabel":S?"PF2E.SpellFocusLabel":"PF2E.SpellPreparedLabel",order:I?0:m.isPrepared?1:S?2:m.isInnate?3:m.isSpontaneous?4:5,noHover:m.isPrepared||O||M||S})}if(D.length){if(S)if(O)a=!0;else{i.push(...D);continue}s[C.level]??=[],s[C.level].push(...D)}}})),s.length){let l=p("summary")==="sort"?(u,f)=>u.order===f.order?X(u.name,f.name):u.order-f.order:(u,f)=>X(u.name,f.name);s.forEach(u=>u.sort(l))}i.length&&(i.sort((l,u)=>X(l.name,u.name)),s[12]=i,a=!1);let r=(await e.spellcasting.ritual?.getSheetData())?.levels.flatMap((l,u)=>l.active.map(({spell:f})=>({name:f.name,img:f.img,slotId:u,itemId:f.id,level:f.level,time:f.system.time.value})).filter(Boolean));return{spells:s,rituals:r,focusPool:t,stavesActive:n,hasFocusCantrips:a,isOwner:e.isOwner}}o(ls,"getData");var Q=null,R=null;function gt(){return{settings:[{name:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:mt}],conflicts:["pf2e-unided"],init:()=>{mt()}}}o(gt,"registerUnided");function mt(e){e??=p("unided"),e==="disabled"?(Q&&(Hooks.off("preCreateItem",Q),Q=null),R&&(Hooks.off("preUpdateItem",R),R=null)):(Q||(Q=Hooks.on("preCreateItem",us)),e==="all"&&!R?R=Hooks.on("preUpdateItem",fs):e!=="all"&&R&&(Hooks.off("preUpdateItem",R),R=null))}o(mt,"setHooks");function us(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}o(us,"preCreateItem");function fs(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}o(fs,"preUpdateItem");var F=b("hero.templates.trade"),J=class extends Application{constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:F("title"),template:v("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){F.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:E(this.actor),targetActions:this.target?E(this.target):[],i18n:F})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){F.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){F.warn("no-select");return}console.log(fe(this.target,!0),de(this.target,!0));let s=fe(this.target,!0)??de(this.target,!0)??game.users.activeGM;if(!s){F.warn("no-user");return}ht({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:s.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};o(J,"Trade");var ae="pf2e-hero-actions",yt=null,bt=w("renderCharacterSheetPF2e",gs,ms),ds="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",re="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",ps="systems/pf2e/icons/features/feats/heroic-recovery.webp";function Ct(){return{name:"heroActions",settings:[{name:"hero",type:Boolean,default:!1,onChange:e=>bt(e)},{name:"hero-table",type:String,default:""},{name:"hero-trade",type:Boolean,default:!1,onChange:()=>H()},{name:"hero-private",type:Boolean,default:!1}],conflicts:[ae],api:{createTable:Os,removeHeroActions:Us,getHeroActions:E,useHeroAction:Tt,getHeroActionDetails:ce,drawHeroAction:It,drawHeroActions:St,sendActionToChat:Dt,discardHeroActions:Et,tradeHeroAction:wt},ready:()=>{bt(!1,"hero")}}}o(Ct,"registerHeroActions");function ms(e){e&&!yt?Z(vt):!e&&yt&&ee(vt)}o(ms,"setupSocket");function vt(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;Mt(e);break;case"trade-accept":if(!te())return;xt(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;Ps(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;Rt(e.error);break}}o(vt,"onSocket");async function gs(e,t){let n=e.actor;!n||n.pack||!n.id||!game.actors.has(n.id)||(await hs(t,n),ys(t,n))}o(gs,"renderCharacterSheetPF2e");async function hs(e,t){let n=E(t),s=t.heroPoints.value-n.length,i=t.isOwner,a=b("hero.templates.heroActions"),c=await renderTemplate(v("hero/sheet"),{owner:i,list:n,canUse:s>=0&&i,canDraw:s>0&&i,canTrade:p("hero-trade"),mustDiscard:s<0,diff:Math.abs(s),i18n:(r,{hash:l})=>a(r,l)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(c)}o(hs,"addActionsToSheet");function ys(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",s=>ks(t,s)),n.find("[data-action=expand]").on("click",ws),n.find("[data-action=use]").on("click",s=>Ss(t,s)),n.find("[data-action=display]").on("click",s=>Cs(t,s)),n.find("[data-action=discard]").on("click",vs),n.find("[data-action=discard-selected]").on("click",()=>bs(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>wt(t))}o(ys,"addSheetEvents");async function bs(e,t){let s=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(i=>i.dataset.uuid);Et(e,s)}o(bs,"onClickHeroActionsDiscard");function vs(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let s=Number(n.attr("data-discard")??"0"),i=n.find(".action.discarded");n.toggleClass("discardable",i.length===s)}o(vs,"onClickHeroActionDiscard");async function Cs(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Dt(e,n)}o(Cs,"onClickHeroActionDisplay");async function Ss(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Tt(e,n)}o(Ss,"onClickHeroActionUse");async function ks(e,t){t.preventDefault(),St(e)}o(ks,"onClickHeroActionsDraw");function E(e){return getProperty(e,`flags.${ae}.heroActions`)??[]}o(E,"getHeroActions");function N(e,t){return e.update({[`flags.${ae}.heroActions`]:t})}o(N,"setHeroActions");async function ws(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let s=t.attr("data-uuid"),i=await ce(s);if(!i)return;let a=await TextEditor.enrichHTML(i.description,{async:!0});n.find(".item-description").html(a),n.addClass("loaded")}t.toggleClass("expanded")}o(ws,"onClickHeroActionExpand");async function ce(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,s=t instanceof JournalEntry?t.pages.contents[0]:t,i=s?.text.content;if(i)return n.uuid===ds&&(i=i.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:s.name,description:i}}o(ce,"getHeroActionDetails");async function St(e){let t=E(e),n=e.heroPoints.value-t.length,s=[];for(let r=0;r<n;r++){let l=await It();if(l!==void 0){if(l===null)return;t.push(l),s.push(l)}}if(!s.length)return;N(e,t);let{content:i,size:a}=kt(s),c={flavor:`<h4 class="action">${y("hero.actions-draw.header",{nb:a})}</h4>`,content:i,speaker:ChatMessage.getSpeaker({actor:e})};p("hero-private")&&(c.type=CONST.CHAT_MESSAGE_TYPES.ROLL,c.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(c)}o(St,"drawHeroActions");function kt(e){let t=e.map(({uuid:n,name:s})=>x(n,s));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}o(kt,"chatActions");function wt(e){let t=E(e);if(!t||!t.length){T("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){T("hero.no-points",{nb:n.toString()});return}new J(e).render(!0)}o(wt,"tradeHeroAction");async function It(){let e=await As(),t=b("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(a=>!a.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let s=Le(n);if(s)return{uuid:s,name:await Is(n,s)}}o(It,"drawHeroAction");async function Tt(e,t){let n=e.heroPoints.value;if(n<1)return T("hero.use.noPoints");let s=E(e),i=s.findIndex(c=>c.uuid===t);if(i===-1)return;let a=await ce(t);a||z("hero.use.noDetails"),s.splice(i,1),a?(e.update({["system.resources.heroPoints.value"]:n-1,[`flags.${ae}.heroActions`]:s}),ChatMessage.create({flavor:`<h4 class="action">${y("hero.actions-use.header")}</h4>`,content:`<h2>${a.name}</h2>${a.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):N(e,s)}o(Tt,"useHeroAction");async function Et(e,t){t=typeof t=="string"?[t]:t;let n=E(e),s=[];for(let c of t){let r=n.findIndex(l=>l.uuid===c);r!==-1&&(s.push(n[r]),n.splice(r,1))}N(e,n);let{content:i,size:a}=kt(s);ChatMessage.create({flavor:`<h4 class="action">${y("hero.actions-discard.header",{nb:a})}</h4>`,content:i,speaker:ChatMessage.getSpeaker({actor:e})})}o(Et,"discardHeroActions");async function Is(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}o(Is,"getLabelfromTableResult");async function At(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}o(At,"getTableFromUuid");async function Ts(){return At(re)}o(Ts,"getDefaultCompendiumTable");function Pt(){return game.tables.find(e=>e.getFlag("core","sourceId")===re)}o(Pt,"getDefaultWorldTable");async function Es(){return At(p("hero-table"))}o(Es,"getCustomTable");async function As(){return await Es()??Pt()??await Ts()}o(As,"getDeckTable");async function Dt(e,t){let n=await ce(t);if(!n)return z("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}o(Dt,"sendActionToChat");function ht(e){if(e.receiver.id===game.user.id){Ot(e);return}P({...e,type:"trade-request"})}o(ht,"sendTradeRequest");function Ot(e){if(game.user.isGM){xt(e);return}P({...e,type:"trade-accept"})}o(Ot,"acceptRequest");async function xt(e){let{sender:t,receiver:n}=e,s=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!s||!i){we(e);return}let a=E(s),c=E(i),r=a.findIndex(d=>d.uuid===t.uuid),l=c.findIndex(d=>d.uuid===n.uuid);if(r===-1||l===-1){we(e);return}let u=a.splice(r,1)[0],f=c.splice(l,1)[0];a.push(f),c.push(u),N(s,a),N(i,c);let g=x(u.uuid),m=x(f.uuid),S=b("hero.trade-success"),I=`<div style="line-height: 1.6">${S("offer",{offer:g})}</div>`;I+=`<div style="line-height: 1.6">${S("receive",{receive:m})}</div>`,console.log("content"),ChatMessage.create({flavor:`<h4 class="action">${S("header",{name:i.name})}</h4>`,content:I,speaker:ChatMessage.getSpeaker({actor:s})})}o(xt,"onTradeAccepted");function we({sender:e,receiver:t},n="trade-error"){let s=new Set([e.id,t.id]);s.has(game.user.id)&&(s.delete(game.user.id),Rt(n)),s.size&&P({type:"trade-error",users:Array.from(s),error:n})}o(we,"sendTradeError");function Rt(e){z("hero.trade-error")}o(Rt,"onTradeError");async function Ps(e){let{sender:t,receiver:n}=e,s=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!s||!i){we(e);return}let a=b("hero.trade-request"),c=`<p>${a("header",{sender:s.name,receiver:i.name})}</p>`;c+=`<p>${a("give",{give:x(t.uuid)})}</p>`,c+=`<p>${a("want",{want:x(n.uuid)})}</p>`,c+=`<p style="margin-bottom: 1em;">${a("accept")}</p>`,await Dialog.confirm({title:a("title"),content:await TextEditor.enrichHTML(c,{async:!0})})?Ot(e):Ds(e)}o(Ps,"onTradeRequest");function Ds(e){if(e.sender.id===game.user.id){Mt(e);return}P({...e,type:"trade-reject"})}o(Ds,"rejectRequest");async function Mt({receiver:e}){let t=game.actors.get(e.cid);T("hero.trade-rejected",{name:t.name},!0)}o(Mt,"onTradeRejected");async function Os(){let e=b("hero.templates.createTable.choice"),t=v("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:a=>{let c=a.find('.window-content input[name="type"]:checked').val(),r=a.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:c,unique:r}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},s={content:await renderTemplate(t,{i18n:e}),title:e("title"),buttons:n,default:"yes",close:()=>null},i=await Dialog.wait(s,void 0,{id:"pf2e-hero-actions-create-table"});i&&(i.type==="default"?Ms(i.unique):xs(i.unique))}o(Os,"createTable");async function xs(e){let t=await Rs(e);await Ie(t),t.sheet?.render(!0)}o(xs,"createCustomTable");function Rs(e=!0){let t=Te(e);return RollTable.create(t,{temporary:!1})}o(Rs,"createCustomActionsTable");async function Ms(e){let t=b("templates.createTable.default.confirm"),n=await Pt();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let i=Te(e);return await n.update(i),Ie(n,!0)}n=await $s(e),await Ie(n)}o(Ms,"createDefaultTable");async function $s(e=!0){let t=await fromUuid(re),n=Te(e,t);return RollTable.create(n,{temporary:!1})}o($s,"createDefautActionsTable");async function Ie(e,t=!1){t&&await e.normalize(),await De("hero-table",e.uuid)}o(Ie,"setTable");function Te(e=!0,t){let n={name:y("hero.table.name"),replacement:!e,img:ps,description:y("hero.table.description"),flags:{core:{sourceId:re}}};return t?mergeObject(deepClone(t._source),n):n}o(Te,"getTableSource");async function Us(){let e=b("hero.templates.removeActions"),t=v("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:a=>a.find('input[name="actor"]:checked').toArray().map(c=>game.actors.get(c.value)).filter(c=>c)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},s={content:await renderTemplate(t,{actors:game.actors.filter(a=>a.type==="character"),i18n:e}),title:e("title"),buttons:n,default:"yes",render:a=>{a.on("change",'input[name="all"]',()=>Ls(a)),a.on("change",'input[name="actor"]',()=>_s(a))},close:()=>[]},i=await Dialog.wait(s,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!i.length){e.warn("noSelection");return}for(let a of i)N(a,[]);e.info("removed")}o(Us,"removeHeroActions");function Ls(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}o(Ls,"removeActionsToggleAll");function _s(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),s=e.find('input[name="all"]');t.length===n.length?(s.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?s.prop("checked",!1).prop("indeterminate",!0):(s.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}o(_s,"removeActionsToggleActor");var $t=oe("renderChatMessage",Lt,Hs);function Ut(){return{settings:[{name:"modifiers",type:String,default:"disabled",choices:["disabled","enabled","traits"],onChange:e=>$t(e)}],init:e=>{!e&&p("modifiers")!=="disabled"&&$t(!0,!0)}}}o(Ut,"registerHideModifiers");function Hs(){if(game.user.isGM)return;let e=ui.chat?.element;if(e)for(let t of B(20)){let n=e.find(`[data-message-id=${t.id}]`);n.length&&(n.find(".message-header").removeClass("pf2e-toolbelt-modifiers pf2e-toolbelt-modifiers-traits"),Lt(t,n))}}o(Hs,"updateMessages");function Lt(e,t){let n=e.speaker,s=ChatMessage.getSpeakerActor(n);if(!s||s.hasPlayerOwner)return;let i=t.find(".message-header");p("modifiers")==="traits"&&i.addClass("pf2e-toolbelt-modifiers-traits"),p("modifiers")!=="disabled"&&i.addClass("pf2e-toolbelt-modifiers")}o(Lt,"renderChatMessage");var Ae=[_e(),st(),qe(),Ye(),gt(),Ze(),Ne(),pt(),it(),Ct(),Ut()],_t=new Set,Pe=null;Hooks.once("init",()=>{let e=game.data.users.find(c=>c._id===game.data.userId),t=e&&e.role>=CONST.USER_ROLES.GAMEMASTER,n=Ae.flatMap(({settings:c=[]})=>c.map(r=>{let l=r.name;return r.choices&&(r.choices=r.choices.reduce((u,f)=>(u[f]=Ee(l,`choices.${f}`),u),{})),r.key=l,r.scope??="world",r.config??=!0,r.name=Ee(l,"name"),r.hint=Ee(l,"hint"),r})),[s,i]=["world","client"].map(c=>n.filter(r=>r.scope===c));[s,i].forEach(c=>c.forEach(r=>game.settings.register(h,r.key,r))),t&&(Pe=i[0].key,Hooks.on("renderSettingsConfig",Fs));let a=game.modules.get(h);a.api={},Ae.forEach(c=>{let{init:r,conflicts:l=[],api:u,name:f}=c;if(t)for(let g of l){let m=game.modules.get(g);m?.active&&(c.conflicting=!0,_t.add(m.title))}u&&f&&(a.api[f]=u),!c.conflicting&&r&&r(t)})});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of Ae)!t&&n&&n(e);if(e)for(let t of _t)T("module-conflict",{name:t},!0)});function Ee(e,t){return`${h}.settings.${e}.${t}`}o(Ee,"settingPath");function Fs(e,t){if(!Pe)return;t.find(`.tab[data-tab=${h}] [data-setting-id="${h}.${Pe}"]`).before(`<h3>${y("settings.client")}</h3>`)}o(Fs,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
